[{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\agents\\ai\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\agents\\new\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\agents\\page.tsx","messages":[],"suppressedMessages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":1263,"column":27,"nodeType":"JSXOpeningElement","endLine":1263,"endColumn":119,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":1421,"column":35,"nodeType":"JSXOpeningElement","endLine":1421,"endColumn":135,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\agents\\twiga-conversations\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\agents\\twiga\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\analytics\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\bookings\\[id]\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\bookings\\page.tsx","messages":[],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'load'. Either include it or remove the dependency array.","line":258,"column":6,"nodeType":"ArrayExpression","endLine":258,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [load]","fix":{"range":[7343,7345],"text":"[load]"}}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'load'. Either include it or remove the dependency array.","line":264,"column":6,"nodeType":"ArrayExpression","endLine":264,"endColumn":23,"suggestions":[{"desc":"Update the dependencies array to be: [status, date, q, load]","fix":{"range":[7478,7495],"text":"[status, date, q, load]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\cancellation-policy\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\cancellations\\[id]\\page.tsx","messages":[],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'load'. Either include it or remove the dependency array.","line":120,"column":6,"nodeType":"ArrayExpression","endLine":120,"endColumn":10,"suggestions":[{"desc":"Update the dependencies array to be: [id, load]","fix":{"range":[3513,3517],"text":"[id, load]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\cancellations\\page.tsx","messages":[],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'load'. Either include it or remove the dependency array.","line":63,"column":6,"nodeType":"ArrayExpression","endLine":63,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [load]","fix":{"range":[2210,2212],"text":"[load]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\cookies-policy\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\dashboard\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\driver-disbursement-policy\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\driver\\referral\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\drivers\\activities\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\drivers\\all\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\drivers\\audit\\[driverId]\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\drivers\\bonuses\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\drivers\\dashboard\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\drivers\\invoices\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\drivers\\levels\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\drivers\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'AdminPageHeader' is defined but never used. Allowed unused vars must match /^_/u.","line":2,"column":8,"nodeType":"Identifier","messageId":"unusedVar","endLine":2,"endColumn":23,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"AdminPageHeader"},"fix":{"range":[15,74],"text":""},"desc":"Remove unused import declaration."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\nimport AdminPageHeader from \"@/components/AdminPageHeader\";\r\nimport { Truck } from \"lucide-react\";\r\nimport DriversDashboard from \"./dashboard/page\";\r\n\r\nexport default function AdminDriversPage() {\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      <div className=\"bg-white rounded-lg border border-gray-200 p-6 shadow-sm\">\r\n        <div className=\"flex flex-col items-center text-center mb-4\">\r\n          <div className=\"h-16 w-16 rounded-full bg-gradient-to-br from-blue-50 to-blue-100 flex items-center justify-center mb-4\">\r\n            <Truck className=\"h-8 w-8 text-blue-600\" />\r\n          </div>\r\n          <h1 className=\"text-2xl font-bold text-gray-900\">Drivers</h1>\r\n          <p className=\"text-sm text-gray-500 mt-1\">Manage platform drivers and their activities</p>\r\n        </div>\r\n      </div>\r\n      <DriversDashboard />\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\drivers\\paid\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\drivers\\referrals\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\drivers\\reminders\\page.tsx","messages":[],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'loadDriverReminders' and 'selectedDriver'. Either include them or remove the dependency array.","line":124,"column":6,"nodeType":"ArrayExpression","endLine":124,"endColumn":29,"suggestions":[{"desc":"Update the dependencies array to be: [searchParams, drivers, selectedDriver, loadDriverReminders]","fix":{"range":[6145,6168],"text":"[searchParams, drivers, selectedDriver, loadDriverReminders]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\drivers\\revenues\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\drivers\\stats\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\drivers\\trips\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\drivers\\trips\\scheduled\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'claimTimingLabel' is defined but never used. Allowed unused vars must match /^_/u.","line":123,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":123,"endColumn":26}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { Fragment, useCallback, useEffect, useMemo, useRef, useState } from \"react\";\r\nimport Link from \"next/link\";\r\nimport axios from \"axios\";\r\nimport {\r\n  ArrowDown,\r\n  ArrowUp,\r\n  ArrowUpDown,\r\n  BadgeDollarSign,\r\n  Calendar,\r\n  CheckCircle2,\r\n  Clock,\r\n  Eye,\r\n  ListFilter,\r\n  Loader2,\r\n  ShieldCheck,\r\n  Timer,\r\n  Trophy,\r\n  UserCheck,\r\n  UserMinus,\r\n  X,\r\n} from \"lucide-react\";\r\nimport TableRow from \"@/components/TableRow\";\r\n\r\n// Use same-origin for HTTP calls so Next.js rewrites proxy to the API\r\nconst api = axios.create({ baseURL: \"\", withCredentials: true });\r\nfunction authify() {}\r\n\r\ntype ScheduledTripRow = {\r\n  id: number;\r\n  tripCode: string;\r\n  passenger: { id: number; name: string | null; email: string | null; phone: string | null } | null;\r\n  driver: { id: number; name: string | null; email: string | null; phone: string | null } | null;\r\n  pickup: string;\r\n  dropoff: string;\r\n  scheduledAt: string;\r\n  vehicleType: string | null;\r\n  amount: number;\r\n  currency: string;\r\n  status: string;\r\n  paymentStatus: string;\r\n  stage: string;\r\n  claimWindowHours: number;\r\n  claimOpensAt: string;\r\n  canClaimNow: boolean;\r\n  claimCount: number;\r\n  claimLimit: number;\r\n  claimsRemaining: number;\r\n  createdAt: string;\r\n};\r\n\r\ntype ScheduledTripClaim = {\r\n  id: number;\r\n  status: string;\r\n  createdAt: string;\r\n  reviewedAt: string | null;\r\n  driver: {\r\n    id: number;\r\n    name: string | null;\r\n    email: string | null;\r\n    phone: string | null;\r\n    isVipDriver: boolean | null;\r\n  };\r\n  reviewer: { id: number; name: string | null; email: string | null } | null;\r\n  recommendation?: { recommended: boolean; score: number; reasons?: string[] } | null;\r\n};\r\n\r\ntype ScheduledTripDetailsResponse = {\r\n  booking: {\r\n    id: number;\r\n    tripCode: string;\r\n    scheduledAt: string;\r\n    vehicleType: string | null;\r\n    amount: number;\r\n    currency: string;\r\n    status: string;\r\n    paymentStatus: string;\r\n    pickup: { address: string | null; ward: string | null; district: string | null; region: string | null };\r\n    dropoff: { address: string | null; ward: string | null; district: string | null; region: string | null };\r\n    passenger: { id: number; name: string | null; email: string | null; phone: string | null } | null;\r\n    driver: { id: number; name: string | null; email: string | null; phone: string | null } | null;\r\n    property: { id: number; title: string | null; regionName: string | null; district: string | null; ward: string | null } | null;\r\n    createdAt: string;\r\n  };\r\n  assignmentAudit: {\r\n    assignedAt: string;\r\n    assignedBy: { id: number; name: string | null; email: string | null } | null;\r\n    kind?: string | null;\r\n    reason: string | null;\r\n    claimId: number | null;\r\n    driverId: number | null;\r\n  } | null;\r\n  assignmentAudits: Array<{\r\n    assignedAt: string;\r\n    assignedBy: { id: number; name: string | null; email: string | null } | null;\r\n    kind?: string | null;\r\n    reason: string | null;\r\n    claimId: number | null;\r\n    driverId: number | null;\r\n  }>;\r\n  claims: ScheduledTripClaim[];\r\n};\r\n\r\nfunction formatDateTime(v: string) {\r\n  const d = new Date(v);\r\n  if (Number.isNaN(d.getTime())) return v;\r\n  return d.toLocaleString();\r\n}\r\n\r\nfunction formatDuration(ms: number) {\r\n  if (!Number.isFinite(ms)) return \"\";\r\n  const clamped = Math.max(0, Math.floor(ms));\r\n  const totalSeconds = Math.floor(clamped / 1000);\r\n  const days = Math.floor(totalSeconds / 86400);\r\n  const hours = Math.floor((totalSeconds % 86400) / 3600);\r\n  const minutes = Math.floor((totalSeconds % 3600) / 60);\r\n  if (days > 0) return `${days}d ${hours}h`;\r\n  if (hours > 0) return `${hours}h ${minutes}m`;\r\n  return `${minutes}m`;\r\n}\r\n\r\nfunction claimTimingLabel(row: ScheduledTripRow) {\r\n  const now = Date.now();\r\n  const opensAt = new Date(row.claimOpensAt).getTime();\r\n  const scheduledAt = new Date(row.scheduledAt).getTime();\r\n  if (!Number.isFinite(opensAt) || !Number.isFinite(scheduledAt)) return null;\r\n  if (row.driver != null) return \"Assigned\";\r\n  if (now < opensAt) return `Waiting (opens in ${formatDuration(opensAt - now)})`;\r\n  if (now >= opensAt && now <= scheduledAt) return \"Claim open\";\r\n  return \"Window passed\";\r\n}\r\n\r\nfunction compactPreviewText(input: string, headWords = 2) {\r\n  const text = (input ?? \"\").trim();\r\n  if (!text) return \"\";\r\n\r\n  const words = text.split(/\\s+/).filter(Boolean);\r\n  if (words.length <= headWords + 1) return text;\r\n\r\n  const head = words.slice(0, headWords).join(\" \");\r\n\r\n  // Prefer a human-readable last word (skip trailing airport/city codes like \"(DAR)\").\r\n  let tailIndex = words.length - 1;\r\n  while (tailIndex > 0 && /^\\([A-Z0-9]{2,6}\\)$/.test(words[tailIndex])) {\r\n    tailIndex -= 1;\r\n  }\r\n  const tail = words[tailIndex];\r\n\r\n  if (!tail || head === tail) return head;\r\n  return `${head}…${tail}`;\r\n}\r\n\r\nfunction compactLocation(loc: { address: string | null; ward: string | null; district: string | null; region: string | null }) {\r\n  if (loc.address) return loc.address;\r\n  const parts = [loc.ward, loc.district, loc.region].filter(Boolean);\r\n  return parts.length ? parts.join(\", \") : \"N/A\";\r\n}\r\n\r\nexport default function AdminScheduledTripsPage() {\r\n  const [stage, setStage] = useState<\"waiting\" | \"claim_open\" | \"assigned\" | \"in_progress\" | \"completed\" | \"all\">(\"waiting\");\r\n  const [vehicleType, setVehicleType] = useState<string>(\"\");\r\n  const [vehicleFilterOpen, setVehicleFilterOpen] = useState(false);\r\n  const [list, setList] = useState<ScheduledTripRow[]>([]);\r\n  const [loading, setLoading] = useState(true);\r\n  const [page, setPage] = useState(1);\r\n  const [total, setTotal] = useState(0);\r\n  const pageSize = 30;\r\n\r\n  const [expandedId, setExpandedId] = useState<number | null>(null);\r\n  const [detailsById, setDetailsById] = useState<Record<number, ScheduledTripDetailsResponse | undefined>>({});\r\n  const [detailsLoadingId, setDetailsLoadingId] = useState<number | null>(null);\r\n  const [awardBusyClaimId, setAwardBusyClaimId] = useState<number | null>(null);\r\n  const [reassignBusyClaimId, setReassignBusyClaimId] = useState<number | null>(null);\r\n  const [unassignBusyBookingId, setUnassignBusyBookingId] = useState<number | null>(null);\r\n\r\n  // Reason modal (unassign)\r\n  const [reasonMounted, setReasonMounted] = useState(false);\r\n  const [reasonOpen, setReasonOpen] = useState(false);\r\n  const [reasonBookingId, setReasonBookingId] = useState<number | null>(null);\r\n  const [reasonText, setReasonText] = useState(\"\");\r\n  const [reasonError, setReasonError] = useState<string | null>(null);\r\n  const [reasonSelectedPick, setReasonSelectedPick] = useState<string | null>(null);\r\n  const reasonTextareaRef = useRef<HTMLTextAreaElement | null>(null);\r\n\r\n  const [sort, setSort] = useState<{ key: \"trip\" | \"when\" | \"route\" | \"vehicle\" | \"claims\" | \"amount\"; dir: \"asc\" | \"desc\" }>(\r\n    { key: \"when\", dir: \"asc\" }\r\n  );\r\n\r\n  const pages = Math.max(1, Math.ceil(total / pageSize));\r\n\r\n  const toggleSort = useCallback(\r\n    (key: \"trip\" | \"when\" | \"route\" | \"vehicle\" | \"claims\" | \"amount\") => {\r\n      setSort((prev) => {\r\n        if (prev.key === key) {\r\n          return { key, dir: prev.dir === \"asc\" ? \"desc\" : \"asc\" };\r\n        }\r\n        return { key, dir: \"asc\" };\r\n      });\r\n    },\r\n    []\r\n  );\r\n\r\n  const SortIcon = useCallback(\r\n    ({ columnKey }: { columnKey: \"trip\" | \"when\" | \"route\" | \"vehicle\" | \"claims\" | \"amount\" }) => {\r\n      if (sort.key !== columnKey) return <ArrowUpDown className=\"h-3.5 w-3.5 text-gray-400\" aria-hidden />;\r\n      return sort.dir === \"asc\" ? (\r\n        <ArrowUp className=\"h-3.5 w-3.5 text-gray-600\" aria-hidden />\r\n      ) : (\r\n        <ArrowDown className=\"h-3.5 w-3.5 text-gray-600\" aria-hidden />\r\n      );\r\n    },\r\n    [sort.dir, sort.key]\r\n  );\r\n\r\n  const sortedList = useMemo(() => {\r\n    const dirMul = sort.dir === \"asc\" ? 1 : -1;\r\n    const safeStr = (v: unknown) => (v == null ? \"\" : String(v)).toLowerCase();\r\n    const safeNum = (v: unknown) => {\r\n      const n = typeof v === \"number\" ? v : Number(v);\r\n      return Number.isFinite(n) ? n : 0;\r\n    };\r\n    const safeTime = (v: unknown) => {\r\n      const t = new Date(String(v ?? \"\")).getTime();\r\n      return Number.isFinite(t) ? t : 0;\r\n    };\r\n\r\n    const cmp = (a: ScheduledTripRow, b: ScheduledTripRow) => {\r\n      switch (sort.key) {\r\n        case \"trip\": {\r\n          const av = safeStr(a.tripCode || a.id);\r\n          const bv = safeStr(b.tripCode || b.id);\r\n          return av.localeCompare(bv) * dirMul;\r\n        }\r\n        case \"when\":\r\n          return (safeTime(a.scheduledAt) - safeTime(b.scheduledAt)) * dirMul;\r\n        case \"route\": {\r\n          const av = safeStr(`${a.pickup} ${a.dropoff}`);\r\n          const bv = safeStr(`${b.pickup} ${b.dropoff}`);\r\n          return av.localeCompare(bv) * dirMul;\r\n        }\r\n        case \"vehicle\": {\r\n          const av = safeStr(a.vehicleType);\r\n          const bv = safeStr(b.vehicleType);\r\n          return av.localeCompare(bv) * dirMul;\r\n        }\r\n        case \"claims\": {\r\n          const av = safeNum(a.claimCount);\r\n          const bv = safeNum(b.claimCount);\r\n          if (av !== bv) return (av - bv) * dirMul;\r\n          return (safeNum(a.claimLimit) - safeNum(b.claimLimit)) * dirMul;\r\n        }\r\n        case \"amount\":\r\n          return (safeNum(a.amount) - safeNum(b.amount)) * dirMul;\r\n        default:\r\n          return 0;\r\n      }\r\n    };\r\n\r\n    return [...list].sort((a, b) => {\r\n      const r = cmp(a, b);\r\n      return r !== 0 ? r : a.id - b.id;\r\n    });\r\n  }, [list, sort.dir, sort.key]);\r\n\r\n  const load = useCallback(async () => {\r\n    setLoading(true);\r\n    try {\r\n      const params: any = {\r\n        page,\r\n        pageSize,\r\n        stage,\r\n        paymentStatus: \"PAID\",\r\n      };\r\n      if (vehicleType) params.vehicleType = vehicleType;\r\n\r\n      const r = await api.get<{ items: ScheduledTripRow[]; total: number }>(\"/api/admin/drivers/trips/scheduled\", { params });\r\n      setList(r.data?.items ?? []);\r\n      setTotal(r.data?.total ?? 0);\r\n\r\n      // If expanded item no longer exists (e.g., assigned), close it.\r\n      if (expandedId != null && !(r.data?.items ?? []).some((x) => x.id === expandedId)) {\r\n        setExpandedId(null);\r\n      }\r\n    } catch (err) {\r\n      console.error(\"Failed to load scheduled trips\", err);\r\n      setList([]);\r\n      setTotal(0);\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  }, [expandedId, page, pageSize, stage, vehicleType]);\r\n\r\n  // Keep dependency list accurate after switching to stage.\r\n\r\n  const loadDetails = useCallback(async (id: number) => {\r\n    setDetailsLoadingId(id);\r\n    try {\r\n      const r = await api.get<ScheduledTripDetailsResponse>(`/api/admin/drivers/trips/scheduled/${id}`);\r\n      setDetailsById((prev) => ({ ...prev, [id]: r.data }));\r\n    } catch (err) {\r\n      console.error(\"Failed to load scheduled trip details\", err);\r\n      setDetailsById((prev) => ({ ...prev, [id]: undefined }));\r\n    } finally {\r\n      setDetailsLoadingId(null);\r\n    }\r\n  }, []);\r\n\r\n  const award = useCallback(\r\n    async (bookingId: number, claimId: number) => {\r\n      const reason = window.prompt(\"Reason for assigning this driver:\")?.trim() ?? \"\";\r\n      if (!reason) {\r\n        alert(\"Reason is required to assign a driver.\");\r\n        return;\r\n      }\r\n\r\n      setAwardBusyClaimId(claimId);\r\n      try {\r\n        await api.post(`/api/admin/drivers/trips/scheduled/${bookingId}/award`, { claimId, reason });\r\n        await Promise.all([load(), loadDetails(bookingId)]);\r\n      } catch (err: any) {\r\n        console.error(\"Failed to award claim\", err);\r\n        const msg = err?.response?.data?.error || \"Failed to award claim\";\r\n        alert(msg);\r\n      } finally {\r\n        setAwardBusyClaimId(null);\r\n      }\r\n    },\r\n    [load, loadDetails]\r\n  );\r\n\r\n  const reassign = useCallback(\r\n    async (bookingId: number, claimId: number) => {\r\n      const reason = window.prompt(\"Reason for reassigning this trip:\")?.trim() ?? \"\";\r\n      if (!reason) {\r\n        alert(\"Reason is required to reassign a driver.\");\r\n        return;\r\n      }\r\n\r\n      setReassignBusyClaimId(claimId);\r\n      try {\r\n        await api.post(`/api/admin/drivers/trips/scheduled/${bookingId}/reassign`, { claimId, reason });\r\n        await Promise.all([load(), loadDetails(bookingId)]);\r\n      } catch (err: any) {\r\n        console.error(\"Failed to reassign claim\", err);\r\n        const msg = err?.response?.data?.error || \"Failed to reassign\";\r\n        alert(msg);\r\n      } finally {\r\n        setReassignBusyClaimId(null);\r\n      }\r\n    },\r\n    [load, loadDetails]\r\n  );\r\n\r\n  const unassignQuickPicks = useMemo(\r\n    () => [\r\n      \"Driver unavailable\",\r\n      \"Vehicle issue\",\r\n      \"Customer requested change\",\r\n      \"Wrong assignment\",\r\n      \"Duplicate booking\",\r\n      \"Other\",\r\n    ],\r\n    []\r\n  );\r\n\r\n  const openUnassignModal = useCallback((bookingId: number) => {\r\n    setReasonBookingId(bookingId);\r\n    setReasonText(\"\");\r\n    setReasonError(null);\r\n    setReasonSelectedPick(null);\r\n    setReasonMounted(true);\r\n    requestAnimationFrame(() => {\r\n      setReasonOpen(true);\r\n      window.setTimeout(() => reasonTextareaRef.current?.focus(), 0);\r\n    });\r\n  }, []);\r\n\r\n  const closeUnassignModal = useCallback(() => {\r\n    setReasonOpen(false);\r\n    window.setTimeout(() => {\r\n      setReasonMounted(false);\r\n      setReasonBookingId(null);\r\n      setReasonText(\"\");\r\n      setReasonError(null);\r\n      setReasonSelectedPick(null);\r\n    }, 200);\r\n  }, []);\r\n\r\n  const applyUnassignPick = useCallback((pick: string) => {\r\n    setReasonSelectedPick(pick);\r\n    if (pick === \"Other\") {\r\n      setReasonText(\"\");\r\n    } else {\r\n      setReasonText(pick);\r\n    }\r\n    if (reasonError) setReasonError(null);\r\n    window.setTimeout(() => reasonTextareaRef.current?.focus(), 0);\r\n  }, [reasonError]);\r\n\r\n  const submitUnassign = useCallback(async () => {\r\n    if (!reasonBookingId) return;\r\n    const reason = reasonText.trim();\r\n    if (!reason) {\r\n      setReasonError(\"Reason is required\");\r\n      return;\r\n    }\r\n\r\n    setUnassignBusyBookingId(reasonBookingId);\r\n    try {\r\n      await api.post(`/api/admin/drivers/trips/scheduled/${reasonBookingId}/unassign`, { reason });\r\n      closeUnassignModal();\r\n      await Promise.all([load(), loadDetails(reasonBookingId)]);\r\n    } catch (err: any) {\r\n      console.error(\"Failed to unassign driver\", err);\r\n      setReasonError(err?.response?.data?.error || \"Failed to unassign\");\r\n    } finally {\r\n      setUnassignBusyBookingId(null);\r\n    }\r\n  }, [closeUnassignModal, load, loadDetails, reasonBookingId, reasonText]);\r\n\r\n  useEffect(() => {\r\n    authify();\r\n    load();\r\n  }, [load]);\r\n\r\n  const stageBg = useMemo(() => {\r\n    switch (stage) {\r\n      case \"waiting\":\r\n        return \"bg-gradient-to-b from-amber-50 via-white to-white\";\r\n      case \"claim_open\":\r\n        return \"bg-gradient-to-b from-emerald-50 via-white to-white\";\r\n      case \"assigned\":\r\n        return \"bg-gradient-to-b from-sky-50 via-white to-white\";\r\n      case \"in_progress\":\r\n        return \"bg-gradient-to-b from-indigo-50 via-white to-white\";\r\n      case \"completed\":\r\n        return \"bg-gradient-to-b from-teal-50 via-white to-white\";\r\n      case \"all\":\r\n      default:\r\n        return \"bg-gradient-to-b from-gray-50 via-white to-white\";\r\n    }\r\n  }, [stage]);\r\n\r\n  const stagePanelBg = useMemo(() => {\r\n    switch (stage) {\r\n      case \"waiting\":\r\n        return \"bg-gradient-to-br from-amber-50/70 to-white\";\r\n      case \"claim_open\":\r\n        return \"bg-gradient-to-br from-emerald-50/70 to-white\";\r\n      case \"assigned\":\r\n        return \"bg-gradient-to-br from-sky-50/70 to-white\";\r\n      case \"in_progress\":\r\n        return \"bg-gradient-to-br from-indigo-50/70 to-white\";\r\n      case \"completed\":\r\n        return \"bg-gradient-to-br from-teal-50/70 to-white\";\r\n      case \"all\":\r\n      default:\r\n        return \"bg-gradient-to-br from-gray-50/70 to-white\";\r\n    }\r\n  }, [stage]);\r\n\r\n  const vehicles = useMemo(() => [\"\", \"BODA\", \"BAJAJI\", \"CAR\", \"XL\", \"PREMIUM\"], []);\r\n  const stages = useMemo(\r\n    () => [\r\n      { value: \"waiting\", label: \"Waiting\", Icon: Clock },\r\n      { value: \"claim_open\", label: \"Claim open\", Icon: Timer },\r\n      { value: \"assigned\", label: \"Assigned\", Icon: UserCheck },\r\n      { value: \"in_progress\", label: \"In progress\", Icon: Calendar },\r\n      { value: \"completed\", label: \"Completed\", Icon: CheckCircle2 },\r\n      { value: \"all\", label: \"All\", Icon: ListFilter },\r\n    ],\r\n    []\r\n  );\r\n\r\n  return (\r\n    <div className={`min-h-screen ${stageBg}`}>\r\n      <div className=\"space-y-6 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6\">\r\n      {/* Header */}\r\n      <div className=\"rounded-2xl bg-gradient-to-b from-white to-gray-50/40 p-6 shadow-sm ring-1 ring-gray-100\">\r\n        <div className=\"flex flex-col items-center text-center\">\r\n          <div className=\"h-16 w-16 rounded-full bg-gradient-to-br from-emerald-50 to-emerald-100 flex items-center justify-center mb-4\">\r\n            <Calendar className=\"h-8 w-8 text-emerald-700\" />\r\n          </div>\r\n          <h1 className=\"text-2xl font-bold text-gray-900\">Scheduled Trips</h1>\r\n          <p className=\"text-sm text-gray-500 mt-1\">Review claims and award a driver for paid scheduled transport bookings.</p>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Filters */}\r\n      <div className=\"bg-white rounded-2xl p-4 shadow-sm ring-1 ring-gray-100 min-w-0\">\r\n        <div className=\"w-full max-w-5xl mx-auto min-w-0 space-y-3\">\r\n          {/* Stage filter (radio buttons styled like the other buttons) */}\r\n          <fieldset className=\"w-full border-0 p-0 m-0 min-w-0\">\r\n            <legend className=\"sr-only\">Stage</legend>\r\n            <div className={`max-w-full rounded-2xl p-3 ring-1 ring-gray-200 ${stagePanelBg}`}>\r\n              <div className=\"flex flex-wrap items-center justify-center gap-3 min-w-0 max-w-full\">\r\n                {stages.map((s) => {\r\n                  const id = `stage-${s.value}`;\r\n                  const active = stage === (s.value as any);\r\n                  const Icon = (s as any).Icon as any;\r\n                  return (\r\n                    <label\r\n                      key={s.value}\r\n                      htmlFor={id}\r\n                      className={\r\n                        \"relative cursor-pointer select-none inline-flex items-center justify-center px-3 py-2 rounded-lg text-sm font-semibold transition-colors shadow-sm ring-1 focus-within:ring-2 focus-within:ring-emerald-200 focus-within:ring-offset-2 focus-within:ring-offset-gray-50 \" +\r\n                        (active\r\n                          ? \"bg-emerald-700 text-white ring-emerald-700\"\r\n                          : \"bg-gray-50 text-gray-700 ring-gray-200 hover:bg-white\")\r\n                      }\r\n                    >\r\n                      <input\r\n                        id={id}\r\n                        type=\"radio\"\r\n                        name=\"scheduled-trip-stage\"\r\n                        value={s.value}\r\n                        checked={stage === (s.value as any)}\r\n                        onChange={() => {\r\n                          setStage(s.value as any);\r\n                          setPage(1);\r\n                        }}\r\n                        className=\"sr-only\"\r\n                      />\r\n                      <span className=\"inline-flex items-center gap-2 whitespace-nowrap\">\r\n                        <Icon className=\"h-4 w-4\" aria-hidden />\r\n                        <span>{s.label}</span>\r\n                      </span>\r\n                    </label>\r\n                  );\r\n                })}\r\n\r\n                {/* Vehicle filter (chip-style, inside the stage row) */}\r\n                <div className=\"relative\">\r\n                  <button\r\n                    type=\"button\"\r\n                    onClick={() => setVehicleFilterOpen((v) => !v)}\r\n                    className=\"inline-flex items-center justify-center gap-2 px-3 py-2 rounded-lg text-sm font-semibold shadow-sm ring-1 ring-gray-200 bg-gray-50 text-gray-700 hover:bg-white\"\r\n                    aria-haspopup=\"menu\"\r\n                    aria-expanded={vehicleFilterOpen}\r\n                    title={vehicleType ? `Vehicle: ${vehicleType}` : \"All vehicles\"}\r\n                  >\r\n                    <ListFilter className=\"h-4 w-4\" aria-hidden />\r\n                    <span className=\"sm:hidden whitespace-nowrap\">{vehicleType ? vehicleType : \"All\"}</span>\r\n                    <span className=\"hidden sm:inline whitespace-nowrap\">{vehicleType ? vehicleType : \"All vehicles\"}</span>\r\n                  </button>\r\n\r\n                  {vehicleFilterOpen && (\r\n                    <>\r\n                      <div className=\"fixed inset-0 z-40\" onClick={() => setVehicleFilterOpen(false)} />\r\n                      <div\r\n                        role=\"menu\"\r\n                        className=\"absolute z-50 mt-2 w-56 right-0 rounded-xl bg-white shadow-lg ring-1 ring-gray-200 overflow-hidden\"\r\n                      >\r\n                        <div className=\"px-3 py-2 text-xs font-semibold text-gray-500 bg-gray-50 border-b border-gray-100\">\r\n                          Vehicle type\r\n                        </div>\r\n                        <div className=\"p-1\">\r\n                          {vehicles.map((v) => {\r\n                            const label = v ? v : \"All vehicles\";\r\n                            const active = vehicleType === v;\r\n                            return (\r\n                              <button\r\n                                key={v || \"ALL\"}\r\n                                type=\"button\"\r\n                                role=\"menuitem\"\r\n                                onClick={() => {\r\n                                  setVehicleType(v);\r\n                                  setPage(1);\r\n                                  setVehicleFilterOpen(false);\r\n                                }}\r\n                                className={\r\n                                  \"w-full text-left px-3 py-2 rounded-lg text-sm font-semibold transition-colors \" +\r\n                                  (active ? \"bg-emerald-50 text-emerald-800\" : \"text-gray-700 hover:bg-gray-50\")\r\n                                }\r\n                              >\r\n                                {label}\r\n                              </button>\r\n                            );\r\n                          })}\r\n                        </div>\r\n                      </div>\r\n                    </>\r\n                  )}\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </fieldset>\r\n\r\n          <div className=\"text-xs text-gray-500\">Showing paid trips only (paymentStatus=PAID). Waiting trips are those whose claim window has not opened yet.</div>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Table */}\r\n      <div className=\"bg-white rounded-2xl shadow-sm ring-1 ring-gray-100 overflow-hidden\">\r\n        <div className=\"overflow-x-auto\">\r\n          <table className=\"min-w-full divide-y divide-gray-200\">\r\n            <thead className=\"bg-gray-50\">\r\n              <tr>\r\n                <th className=\"px-4 py-3 text-left text-xs font-semibold text-gray-600\">\r\n                  <button\r\n                    type=\"button\"\r\n                    onClick={() => toggleSort(\"trip\")}\r\n                    className=\"inline-flex items-center gap-1 bg-transparent border-0 p-0 m-0 shadow-none appearance-none hover:text-gray-900 focus-visible:outline-none focus-visible:underline\"\r\n                    aria-label=\"Sort by trip\"\r\n                  >\r\n                    Trip\r\n                    <SortIcon columnKey=\"trip\" />\r\n                  </button>\r\n                </th>\r\n                <th className=\"px-4 py-3 text-left text-xs font-semibold text-gray-600\">\r\n                  <button\r\n                    type=\"button\"\r\n                    onClick={() => toggleSort(\"when\")}\r\n                    className=\"inline-flex items-center gap-1 bg-transparent border-0 p-0 m-0 shadow-none appearance-none hover:text-gray-900 focus-visible:outline-none focus-visible:underline\"\r\n                    aria-label=\"Sort by time\"\r\n                  >\r\n                    When\r\n                    <SortIcon columnKey=\"when\" />\r\n                  </button>\r\n                </th>\r\n                <th className=\"px-4 py-3 text-left text-xs font-semibold text-gray-600\">\r\n                  <button\r\n                    type=\"button\"\r\n                    onClick={() => toggleSort(\"route\")}\r\n                    className=\"inline-flex items-center gap-1 bg-transparent border-0 p-0 m-0 shadow-none appearance-none hover:text-gray-900 focus-visible:outline-none focus-visible:underline\"\r\n                    aria-label=\"Sort by route\"\r\n                  >\r\n                    Route\r\n                    <SortIcon columnKey=\"route\" />\r\n                  </button>\r\n                </th>\r\n                <th className=\"px-4 py-3 text-left text-xs font-semibold text-gray-600\">\r\n                  <button\r\n                    type=\"button\"\r\n                    onClick={() => toggleSort(\"vehicle\")}\r\n                    className=\"inline-flex items-center gap-1 bg-transparent border-0 p-0 m-0 shadow-none appearance-none hover:text-gray-900 focus-visible:outline-none focus-visible:underline\"\r\n                    aria-label=\"Sort by vehicle\"\r\n                  >\r\n                    Vehicle\r\n                    <SortIcon columnKey=\"vehicle\" />\r\n                  </button>\r\n                </th>\r\n                <th className=\"px-4 py-3 text-left text-xs font-semibold text-gray-600\">\r\n                  <button\r\n                    type=\"button\"\r\n                    onClick={() => toggleSort(\"claims\")}\r\n                    className=\"inline-flex items-center gap-1 bg-transparent border-0 p-0 m-0 shadow-none appearance-none hover:text-gray-900 focus-visible:outline-none focus-visible:underline\"\r\n                    aria-label=\"Sort by claims\"\r\n                  >\r\n                    Claims\r\n                    <SortIcon columnKey=\"claims\" />\r\n                  </button>\r\n                </th>\r\n                <th className=\"px-4 py-3 text-left text-xs font-semibold text-gray-600\">\r\n                  <button\r\n                    type=\"button\"\r\n                    onClick={() => toggleSort(\"amount\")}\r\n                    className=\"inline-flex items-center gap-1 bg-transparent border-0 p-0 m-0 shadow-none appearance-none hover:text-gray-900 focus-visible:outline-none focus-visible:underline\"\r\n                    aria-label=\"Sort by amount\"\r\n                  >\r\n                    Amount\r\n                    <SortIcon columnKey=\"amount\" />\r\n                  </button>\r\n                </th>\r\n                <th className=\"px-4 py-3 text-right text-xs font-semibold text-gray-600\">Details</th>\r\n              </tr>\r\n            </thead>\r\n            <tbody className=\"divide-y divide-gray-100\">\r\n              {loading ? (\r\n                <TableRow hover={false}>\r\n                  <td colSpan={7} className=\"px-4 py-8 text-center text-sm text-gray-500\">\r\n                    Loading...\r\n                  </td>\r\n                </TableRow>\r\n              ) : list.length === 0 ? (\r\n                <TableRow hover={false}>\r\n                  <td colSpan={7} className=\"px-4 py-10 text-center text-sm text-gray-500\">\r\n                    No scheduled trips found.\r\n                  </td>\r\n                </TableRow>\r\n              ) : (\r\n                sortedList.map((row) => {\r\n                  const expanded = expandedId === row.id;\r\n                  const details = detailsById[row.id];\r\n                  const detailsLoading = detailsLoadingId === row.id;\r\n\r\n                  return (\r\n                    <Fragment key={row.id}>\r\n                      <TableRow className={expanded ? \"bg-emerald-50/30\" : \"\"}>\r\n                        <td className=\"px-4 py-3\">\r\n                          <div className=\"text-sm font-semibold text-gray-900\">{row.tripCode}</div>\r\n                          <div className=\"text-xs text-gray-500 inline-flex flex-wrap items-center gap-x-1\">\r\n                            <span>#{row.id}</span>\r\n                            <span aria-hidden>•</span>\r\n                            {row.paymentStatus === \"PAID\" ? (\r\n                              <span\r\n                                className=\"inline-flex items-center gap-1\"\r\n                                title=\"Paid\"\r\n                                aria-label=\"Paid\"\r\n                              >\r\n                                <BadgeDollarSign className=\"h-3.5 w-3.5 text-emerald-700\" aria-hidden />\r\n                                <span className=\"sr-only\">Paid</span>\r\n                              </span>\r\n                            ) : (\r\n                              <span>{row.paymentStatus}</span>\r\n                            )}\r\n                            <span aria-hidden>•</span>\r\n                            <span>{row.status}</span>\r\n                          </div>\r\n                          <div className=\"text-xs text-gray-500\">\r\n                            Passenger: {row.passenger?.name || row.passenger?.email || \"N/A\"}\r\n                          </div>\r\n                        </td>\r\n                        <td className=\"px-4 py-3 text-sm text-gray-700\">{formatDateTime(row.scheduledAt)}</td>\r\n                        <td className=\"px-4 py-3\">\r\n                          <div className=\"text-sm text-gray-700 truncate max-w-[340px]\">\r\n                            {compactPreviewText(row.pickup, 2)}\r\n                          </div>\r\n                          <div className=\"text-xs text-gray-500 truncate max-w-[340px]\">\r\n                            → {compactPreviewText(row.dropoff, 2)}\r\n                          </div>\r\n                        </td>\r\n                        <td className=\"px-4 py-3 text-sm text-gray-700\">{row.vehicleType || \"—\"}</td>\r\n                        <td className=\"px-4 py-3\">\r\n                          <div className=\"text-sm text-gray-900 font-medium\">{row.claimCount}/{row.claimLimit}</div>\r\n                          <div className=\"text-xs text-gray-500\">{row.claimsRemaining} remaining</div>\r\n                        </td>\r\n                        <td className=\"px-4 py-3 text-sm text-gray-700\">{row.amount.toLocaleString()} {row.currency}</td>\r\n                        <td className=\"px-4 py-3 text-right\">\r\n                          <button\r\n                            type=\"button\"\r\n                            onClick={async () => {\r\n                              if (expanded) {\r\n                                setExpandedId(null);\r\n                                return;\r\n                              }\r\n                              setExpandedId(row.id);\r\n                              if (!detailsById[row.id]) {\r\n                                await loadDetails(row.id);\r\n                              }\r\n                            }}\r\n                            className=\"inline-flex items-center justify-center h-9 w-9 rounded-lg bg-white text-gray-700 shadow-sm ring-1 ring-gray-200 hover:bg-gray-50\"\r\n                            title={expanded ? \"Hide details\" : \"View details\"}\r\n                            aria-label={expanded ? \"Hide details\" : \"View details\"}\r\n                          >\r\n                            <Eye className=\"h-4 w-4\" />\r\n                          </button>\r\n                        </td>\r\n                      </TableRow>\r\n\r\n                      {expanded && (\r\n                        <TableRow hover={false} key={`${row.id}-details`}>\r\n                          <td colSpan={7} className=\"px-4 py-5 bg-gray-50/40\">\r\n                            {detailsLoading ? (\r\n                              <div className=\"text-sm text-gray-500\">Loading details...</div>\r\n                            ) : !details ? (\r\n                              <div className=\"text-sm text-gray-500\">No details.</div>\r\n                            ) : (\r\n                              <div className=\"space-y-4\">\r\n                                <div className=\"grid grid-cols-1 md:grid-cols-3 gap-3\">\r\n                                  <div className=\"rounded-xl bg-white p-4 shadow-sm ring-1 ring-gray-100\">\r\n                                    <div className=\"text-xs text-gray-500\">Pickup</div>\r\n                                    <div className=\"text-sm text-gray-900 font-medium\">{compactLocation(details.booking.pickup)}</div>\r\n                                  </div>\r\n                                  <div className=\"rounded-xl bg-white p-4 shadow-sm ring-1 ring-gray-100\">\r\n                                    <div className=\"text-xs text-gray-500\">Drop-off</div>\r\n                                    <div className=\"text-sm text-gray-900 font-medium\">{compactLocation(details.booking.dropoff)}</div>\r\n                                    {details.booking.property?.title ? (\r\n                                      <div className=\"text-xs text-gray-500 mt-1\">\r\n                                        Property: {details.booking.property.title}\r\n                                      </div>\r\n                                    ) : null}\r\n                                  </div>\r\n                                  <div className=\"rounded-xl bg-white p-4 shadow-sm ring-1 ring-gray-100\">\r\n                                    <div className=\"text-xs text-gray-500\">Assigned Driver</div>\r\n                                    <div className=\"text-sm text-gray-900 font-medium\">\r\n                                      {details.booking.driver?.name || details.booking.driver?.email || \"Not assigned\"}\r\n                                    </div>\r\n\r\n                                    {details.booking.driver?.id ? (\r\n                                      <div className=\"mt-3 grid grid-cols-2 gap-2\">\r\n                                        <button\r\n                                          type=\"button\"\r\n                                          disabled={unassignBusyBookingId === details.booking.id}\r\n                                          onClick={() => openUnassignModal(details.booking.id)}\r\n                                          className=\"inline-flex items-center justify-center h-10 w-full rounded-lg border border-red-200 bg-red-50 text-red-700 hover:bg-red-100 disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                                          aria-label=\"Unassign\"\r\n                                          title={unassignBusyBookingId === details.booking.id ? \"Unassigning...\" : \"Unassign\"}\r\n                                        >\r\n                                          <UserMinus className=\"h-5 w-5\" aria-hidden />\r\n                                        </button>\r\n\r\n                                        <Link\r\n                                          href={`/admin/drivers/audit/${details.booking.driver.id}`}\r\n                                          className=\"inline-flex items-center justify-center h-10 w-full rounded-lg bg-white text-emerald-700 shadow-sm ring-1 ring-gray-200 hover:bg-gray-50 hover:text-emerald-800\"\r\n                                          title=\"View driver assignment audit\"\r\n                                          aria-label=\"View driver assignment audit\"\r\n                                        >\r\n                                          <Eye className=\"h-5 w-5\" aria-hidden />\r\n                                        </Link>\r\n                                      </div>\r\n                                    ) : null}\r\n                                    {details.assignmentAudit && details.booking.driver ? (\r\n                                      <div className=\"mt-2 space-y-1 text-xs text-gray-500\">\r\n                                        <div>Assigned: {formatDateTime(details.assignmentAudit.assignedAt)}</div>\r\n                                        <div>\r\n                                          By: {details.assignmentAudit.assignedBy?.name || details.assignmentAudit.assignedBy?.email || \"Unknown\"}\r\n                                        </div>\r\n                                        <div className=\"line-clamp-3\">Reason: {details.assignmentAudit.reason || \"—\"}</div>\r\n                                      </div>\r\n                                    ) : null}\r\n\r\n                                    {/** action buttons now shown in two columns above **/}\r\n                                  </div>\r\n                                </div>\r\n\r\n                                <details className=\"rounded-xl bg-white shadow-sm ring-1 ring-gray-100 overflow-hidden\">\r\n                                  <summary className=\"cursor-pointer select-none px-4 py-3 bg-gray-50 border-b border-gray-100 text-sm font-semibold text-gray-900\">\r\n                                    View full assignment audit\r\n                                  </summary>\r\n                                  <div className=\"p-4\">\r\n                                    {(details.assignmentAudits?.length ?? 0) === 0 ? (\r\n                                      <div className=\"text-sm text-gray-500\">No assignment audit entries yet.</div>\r\n                                    ) : (\r\n                                      <div className=\"space-y-2\">\r\n                                        {details.assignmentAudits.map((a, idx) => (\r\n                                          <div key={`${a.assignedAt}-${idx}`} className=\"rounded-lg border border-gray-200 bg-white p-3\">\r\n                                            <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-1\">\r\n                                              <div className=\"text-sm font-semibold text-gray-900\">\r\n                                                {String(a.kind ?? \"ASSIGN\").toUpperCase() === \"UNASSIGN\"\r\n                                                  ? \"Unassigned\"\r\n                                                  : a.driverId\r\n                                                    ? `Assigned driver #${a.driverId}`\r\n                                                    : \"Assigned\"}\r\n                                              </div>\r\n                                              <div className=\"text-xs text-gray-500\">{formatDateTime(a.assignedAt)}</div>\r\n                                            </div>\r\n                                            <div className=\"text-xs text-gray-500 mt-1\">\r\n                                              By: {a.assignedBy?.name || a.assignedBy?.email || \"Unknown\"}\r\n                                              {a.claimId ? ` • Claim #${a.claimId}` : \"\"}\r\n                                            </div>\r\n                                            <div className=\"text-xs text-gray-700 mt-1\">Reason: {a.reason || \"—\"}</div>\r\n                                          </div>\r\n                                        ))}\r\n                                      </div>\r\n                                    )}\r\n                                  </div>\r\n                                </details>\r\n\r\n                                <div className=\"rounded-xl bg-white shadow-sm ring-1 ring-gray-100 overflow-hidden\">\r\n                                  <div className=\"px-4 py-3 bg-gray-50 flex items-center justify-between border-b border-gray-100\">\r\n                                    <div className=\"text-sm font-semibold text-gray-900\">Claims</div>\r\n                                    <div className=\"text-xs text-gray-500\">Select one claim to award the booking.</div>\r\n                                  </div>\r\n                                  {details.claims.length === 0 ? (\r\n                                    <div className=\"px-4 py-6 text-sm text-gray-500\">No claims yet.</div>\r\n                                  ) : (\r\n                                    <div className=\"divide-y divide-gray-100\">\r\n                                      {details.claims.map((c) => {\r\n                                        const canAward =\r\n                                          details.booking.driver == null &&\r\n                                          c.status === \"PENDING\" &&\r\n                                          (awardBusyClaimId == null || awardBusyClaimId === c.id);\r\n\r\n                                        const bookingStatus = String(details.booking.status ?? \"\").toUpperCase();\r\n                                        const canReassign =\r\n                                          details.booking.driver != null &&\r\n                                          c.driver?.id != null &&\r\n                                          c.driver.id !== details.booking.driver.id &&\r\n                                          ![\"IN_PROGRESS\", \"COMPLETED\", \"CANCELED\", \"CANCELLED\"].includes(bookingStatus) &&\r\n                                          (reassignBusyClaimId == null || reassignBusyClaimId === c.id);\r\n\r\n                                        return (\r\n                                          <div key={c.id} className=\"px-4 py-3 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2\">\r\n                                            <div>\r\n                                              <div className=\"flex items-center gap-2\">\r\n                                                <div className=\"text-sm font-medium text-gray-900\">\r\n                                                  {c.driver?.name || c.driver?.email || `Driver #${c.driver?.id}`}\r\n                                                </div>\r\n                                                {c.recommendation?.recommended ? (\r\n                                                  <span\r\n                                                    className=\"inline-flex items-center gap-1 text-xs font-semibold px-2 py-0.5 rounded-full bg-emerald-100 text-emerald-800\"\r\n                                                    title={\r\n                                                      (c.recommendation?.reasons ?? []).length\r\n                                                        ? `Recommended: ${(c.recommendation?.reasons ?? []).join(\" • \")}`\r\n                                                        : \"Recommended\"\r\n                                                    }\r\n                                                  >\r\n                                                    <span className=\"h-1.5 w-1.5 rounded-full bg-emerald-600\" aria-hidden />\r\n                                                    Recommended\r\n                                                  </span>\r\n                                                ) : null}\r\n                                                {c.driver?.isVipDriver ? (\r\n                                                  <span className=\"inline-flex items-center gap-1 text-xs font-semibold px-2 py-0.5 rounded-full bg-yellow-100 text-yellow-800\">\r\n                                                    <Trophy className=\"h-3 w-3\" /> VIP\r\n                                                  </span>\r\n                                                ) : null}\r\n                                                <span className=\"text-xs px-2 py-0.5 rounded-full bg-gray-100 text-gray-700\">{c.status}</span>\r\n                                              </div>\r\n                                              <div className=\"text-xs text-gray-500\">\r\n                                                {c.driver?.phone ? `Phone: ${c.driver.phone}` : \"\"}{c.driver?.phone && c.driver?.email ? \" • \" : \"\"}{c.driver?.email ? `Email: ${c.driver.email}` : \"\"}\r\n                                              </div>\r\n                                              <div className=\"text-xs text-gray-500\">Submitted: {formatDateTime(c.createdAt)}</div>\r\n                                              {c.reviewedAt ? (\r\n                                                <div className=\"text-xs text-gray-500 flex items-center gap-1\">\r\n                                                  <ShieldCheck className=\"h-3 w-3\" /> Reviewed: {formatDateTime(c.reviewedAt)}\r\n                                                </div>\r\n                                              ) : null}\r\n                                            </div>\r\n\r\n                                            <div className=\"flex items-center gap-2\">\r\n                                              <button\r\n                                                type=\"button\"\r\n                                                disabled={!canAward || awardBusyClaimId === c.id}\r\n                                                onClick={() => award(details.booking.id, c.id)}\r\n                                                className={`px-3 py-1.5 rounded-lg text-sm font-medium border transition-colors ${\r\n                                                  details.booking.driver != null\r\n                                                    ? \"border-gray-200 text-gray-400 bg-gray-50 cursor-not-allowed\"\r\n                                                    : c.status !== \"PENDING\"\r\n                                                    ? \"border-gray-200 text-gray-400 bg-gray-50 cursor-not-allowed\"\r\n                                                    : \"border-emerald-700 text-emerald-800 bg-emerald-50 hover:bg-emerald-100\"\r\n                                                }`}\r\n                                              >\r\n                                                {awardBusyClaimId === c.id ? \"Awarding...\" : \"Award\"}\r\n                                              </button>\r\n\r\n                                              <button\r\n                                                type=\"button\"\r\n                                                disabled={!canReassign || reassignBusyClaimId === c.id}\r\n                                                onClick={() => reassign(details.booking.id, c.id)}\r\n                                                className={`px-3 py-1.5 rounded-lg text-sm font-medium border transition-colors ${\r\n                                                  details.booking.driver == null\r\n                                                    ? \"border-gray-200 text-gray-400 bg-gray-50 cursor-not-allowed\"\r\n                                                    : !canReassign\r\n                                                    ? \"border-gray-200 text-gray-400 bg-gray-50 cursor-not-allowed\"\r\n                                                    : \"border-amber-700 text-amber-800 bg-amber-50 hover:bg-amber-100\"\r\n                                                }`}\r\n                                              >\r\n                                                {reassignBusyClaimId === c.id ? \"Reassigning...\" : \"Reassign\"}\r\n                                              </button>\r\n                                            </div>\r\n                                          </div>\r\n                                        );\r\n                                      })}\r\n                                    </div>\r\n                                  )}\r\n                                </div>\r\n                              </div>\r\n                            )}\r\n                          </td>\r\n                        </TableRow>\r\n                      )}\r\n                    </Fragment>\r\n                  );\r\n                })\r\n              )}\r\n            </tbody>\r\n          </table>\r\n        </div>\r\n\r\n        {/* Pagination */}\r\n        <div className=\"flex items-center justify-between px-4 py-3 border-t border-gray-100 bg-gray-50\">\r\n          <div className=\"text-xs text-gray-500\">\r\n            Page {page} of {pages} • {total.toLocaleString()} total\r\n          </div>\r\n          <div className=\"flex items-center gap-2\">\r\n            <button\r\n              type=\"button\"\r\n              onClick={() => setPage((p) => Math.max(1, p - 1))}\r\n              disabled={page <= 1}\r\n              className=\"px-3 py-1.5 rounded-lg bg-white text-sm font-semibold text-gray-700 shadow-sm ring-1 ring-gray-200 disabled:opacity-40\"\r\n            >\r\n              Prev\r\n            </button>\r\n            <button\r\n              type=\"button\"\r\n              onClick={() => setPage((p) => Math.min(pages, p + 1))}\r\n              disabled={page >= pages}\r\n              className=\"px-3 py-1.5 rounded-lg bg-white text-sm font-semibold text-gray-700 shadow-sm ring-1 ring-gray-200 disabled:opacity-40\"\r\n            >\r\n              Next\r\n            </button>\r\n          </div>\r\n        </div>\r\n      </div>\r\n      </div>\r\n\r\n      {/* Unassign Reason Modal (avoid browser prompt \"localhost says\") */}\r\n      {reasonMounted && (\r\n        <div className={`fixed inset-0 z-50 ${reasonOpen ? \"\" : \"pointer-events-none\"}`}>\r\n          <div\r\n            className={`absolute inset-0 bg-black/50 transition-opacity duration-200 ${reasonOpen ? \"opacity-100\" : \"opacity-0\"}`}\r\n            onClick={closeUnassignModal}\r\n          />\r\n          <div className=\"relative h-full w-full flex items-start sm:items-center justify-center p-3 sm:p-6 overflow-y-auto\">\r\n            <div\r\n              className={`relative w-full max-w-lg my-3 sm:my-0 max-h-[92vh] overflow-hidden rounded-2xl sm:rounded-3xl border border-white/30 shadow-2xl flex flex-col bg-gradient-to-b from-surface via-white to-red-50 transition-all duration-200 ease-out ${\r\n                reasonOpen ? \"opacity-100 scale-100 translate-y-0\" : \"opacity-0 scale-[0.98] translate-y-2\"\r\n              }`}\r\n              role=\"dialog\"\r\n              aria-modal=\"true\"\r\n              aria-label=\"Unassign driver\"\r\n            >\r\n              <div className=\"relative overflow-hidden border-b border-white/40\">\r\n                <div className=\"absolute inset-0 bg-gradient-to-r from-red-700 via-red-600 to-rose-500\" />\r\n                <div className=\"absolute inset-0 opacity-20 bg-[radial-gradient(circle_at_20%_20%,white,transparent_40%),radial-gradient(circle_at_80%_10%,white,transparent_35%),radial-gradient(circle_at_40%_90%,white,transparent_35%)]\" />\r\n                <div className=\"relative px-4 pt-5 pb-6 sm:px-6 sm:pt-6 sm:pb-6 flex items-start justify-between gap-3 text-white\">\r\n                  <div className=\"min-w-0 flex-1\">\r\n                    <div className=\"grid grid-cols-[minmax(0,1fr)_auto] items-center gap-3\">\r\n                      <div className=\"min-w-0 text-base sm:text-lg font-semibold leading-snug truncate\">Unassign Driver</div>\r\n                      {reasonBookingId ? (\r\n                        <div className=\"inline-flex max-w-[60vw] sm:max-w-none items-center gap-2 px-2 py-1 rounded-full bg-white/15 border border-white/25 backdrop-blur text-xs text-white\">\r\n                          <span className=\"text-white/90\">Trip</span>\r\n                          <span className=\"select-text break-all\" title={`#${reasonBookingId}`}>{`#${reasonBookingId}`}</span>\r\n                        </div>\r\n                      ) : null}\r\n                    </div>\r\n                    <div className=\"mt-2 text-xs text-white/85\">Provide a clear reason (required).</div>\r\n                  </div>\r\n                  <button\r\n                    type=\"button\"\r\n                    onClick={closeUnassignModal}\r\n                    className=\"h-9 w-9 sm:h-10 sm:w-10 shrink-0 rounded-xl bg-white/15 border border-white/25 text-white hover:bg-white/20 transition\"\r\n                    aria-label=\"Close\"\r\n                    title=\"Close\"\r\n                  >\r\n                    <X className=\"h-4 w-4 mx-auto\" />\r\n                  </button>\r\n                </div>\r\n              </div>\r\n\r\n              <div className=\"p-4 sm:p-6 flex-1 overflow-y-auto\">\r\n                <div className=\"space-y-4\">\r\n                  <div>\r\n                    <div className=\"flex items-center justify-between gap-3 mb-2\">\r\n                      <label className=\"block text-xs font-medium text-gray-600\">Reason</label>\r\n                      <button\r\n                        type=\"button\"\r\n                        onClick={() => {\r\n                          setReasonText(\"\");\r\n                          setReasonSelectedPick(null);\r\n                          if (reasonError) setReasonError(null);\r\n                          window.setTimeout(() => reasonTextareaRef.current?.focus(), 0);\r\n                        }}\r\n                        className=\"text-xs font-medium text-gray-600 hover:text-gray-900\"\r\n                        disabled={unassignBusyBookingId === reasonBookingId}\r\n                      >\r\n                        Clear\r\n                      </button>\r\n                    </div>\r\n\r\n                    <div className=\"mb-3\">\r\n                      <div className=\"text-[11px] font-medium tracking-wide uppercase text-gray-500 mb-2\">Quick pick</div>\r\n                      <div className=\"flex flex-wrap gap-2\">\r\n                        {unassignQuickPicks.map((pick) => (\r\n                          <button\r\n                            key={pick}\r\n                            type=\"button\"\r\n                            onClick={() => applyUnassignPick(pick)}\r\n                            disabled={unassignBusyBookingId === reasonBookingId}\r\n                            title={pick}\r\n                            className={`px-3 py-1.5 rounded-full text-xs font-medium border transition disabled:opacity-50 ${\r\n                              reasonSelectedPick === pick\r\n                                ? \"border-red-700 bg-red-700 text-white\"\r\n                                : \"border-gray-200 bg-white/80 text-gray-700 hover:bg-white hover:border-gray-300\"\r\n                            }`}\r\n                          >\r\n                            {pick}\r\n                          </button>\r\n                        ))}\r\n                      </div>\r\n                    </div>\r\n\r\n                    <textarea\r\n                      ref={reasonTextareaRef}\r\n                      value={reasonText}\r\n                      onChange={(e) => {\r\n                        setReasonText(e.target.value);\r\n                        if (reasonSelectedPick) setReasonSelectedPick(null);\r\n                        if (reasonError) setReasonError(null);\r\n                      }}\r\n                      placeholder=\"Why are you unassigning this driver?\"\r\n                      rows={4}\r\n                      className={`block w-full max-w-full box-border px-3 py-2 rounded-xl border bg-white/80 outline-none text-sm leading-relaxed text-gray-900 shadow-inner resize-none focus:ring-2 focus:ring-red-600 focus:border-red-600 ${\r\n                        reasonError ? \"border-red-300\" : \"border-gray-300\"\r\n                      }`}\r\n                    />\r\n                    {reasonError ? <div className=\"mt-2 text-xs text-red-600\">{reasonError}</div> : null}\r\n                  </div>\r\n                </div>\r\n              </div>\r\n\r\n              <div className=\"px-4 py-4 sm:px-6 sm:py-5 border-t border-gray-200/60 bg-white/60 backdrop-blur flex items-center justify-end\">\r\n                {(() => {\r\n                  const busy = unassignBusyBookingId === reasonBookingId;\r\n                  const ready = Boolean(reasonText.trim()) && Boolean(reasonBookingId) && !busy;\r\n                  const tooltip = !reasonBookingId\r\n                    ? \"No trip selected\"\r\n                    : !reasonText.trim()\r\n                      ? \"Enter a reason\"\r\n                      : busy\r\n                        ? \"Unassigning...\"\r\n                        : \"Unassign\";\r\n                  return (\r\n                    <button\r\n                      type=\"button\"\r\n                      onClick={submitUnassign}\r\n                      disabled={!ready}\r\n                      aria-label=\"Unassign driver\"\r\n                      title={tooltip}\r\n                      className=\"inline-flex items-center justify-center h-11 w-11 rounded-2xl text-white transition shadow-sm bg-red-700 hover:bg-red-800 border border-red-700 disabled:opacity-40 disabled:cursor-not-allowed\"\r\n                    >\r\n                      {busy ? <Loader2 className=\"h-5 w-5 animate-spin\" /> : <UserMinus className=\"h-5 w-5\" />}\r\n                    </button>\r\n                  );\r\n                })()}\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\group-stays\\arrangements\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\group-stays\\assignments\\page.tsx","messages":[],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'loadOwners' and 'loadProperties'. Either include them or remove the dependency array.","line":293,"column":6,"nodeType":"ArrayExpression","endLine":293,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [loadOwners, loadProperties]","fix":{"range":[11817,11819],"text":"[loadOwners, loadProperties]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\group-stays\\bookings\\page.tsx","messages":[],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadBookingDetails'. Either include it or remove the dependency array.","line":946,"column":6,"nodeType":"ArrayExpression","endLine":946,"endColumn":35,"suggestions":[{"desc":"Update the dependencies array to be: [loading, list, searchParams, loadBookingDetails]","fix":{"range":[36660,36689],"text":"[loading, list, searchParams, loadBookingDetails]"}}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'load'. Either include it or remove the dependency array.","line":953,"column":6,"nodeType":"ArrayExpression","endLine":953,"endColumn":43,"suggestions":[{"desc":"Update the dependencies array to be: [page, status, groupType, dateKey, q, load]","fix":{"range":[36836,36873],"text":"[page, status, groupType, dateKey, q, load]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\group-stays\\claims\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\group-stays\\dashboard\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\group-stays\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'AdminPageHeader' is defined but never used. Allowed unused vars must match /^_/u.","line":2,"column":8,"nodeType":"Identifier","messageId":"unusedVar","endLine":2,"endColumn":23,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"AdminPageHeader"},"fix":{"range":[15,74],"text":""},"desc":"Remove unused import declaration."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\nimport AdminPageHeader from \"@/components/AdminPageHeader\";\r\nimport { Users } from \"lucide-react\";\r\nimport GroupStaysDashboard from \"./dashboard/page\";\r\n\r\nexport default function AdminGroupStaysPage() {\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      <div className=\"bg-white rounded-lg border border-gray-200 p-6 shadow-sm\">\r\n        <div className=\"flex flex-col items-center text-center mb-4\">\r\n          <div className=\"h-16 w-16 rounded-full bg-gradient-to-br from-purple-50 to-purple-100 flex items-center justify-center mb-4\">\r\n            <Users className=\"h-8 w-8 text-purple-600\" />\r\n          </div>\r\n          <h1 className=\"text-2xl font-bold text-gray-900\">Group Stays</h1>\r\n          <p className=\"mt-1 text-sm text-gray-600\">Manage group accommodation bookings and requests</p>\r\n        </div>\r\n      </div>\r\n      <GroupStaysDashboard />\r\n    </div>\r\n  );\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\group-stays\\passengers\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\group-stays\\requests\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\home\\adminHomeHooks.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\home\\page.new.tsx","messages":[],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'display'. Either include it or remove the dependency array. Outer scope values like 'reduceMotion' aren't valid dependencies because mutating them doesn't re-render the component.","line":316,"column":8,"nodeType":"ArrayExpression","endLine":316,"endColumn":50,"suggestions":[{"desc":"Update the dependencies array to be: [value, enabled, durationMs, display]","fix":{"range":[9824,9866],"text":"[value, enabled, durationMs, display]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\home\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\management\\AdminManagementPageClient.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\management\\audit-log\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\management\\bookings\\[id]\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\management\\bookings\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\management\\careers\\page.tsx","messages":[],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'loadApplications' and 'loadStatistics'. Either include them or remove the dependency array.","line":229,"column":6,"nodeType":"ArrayExpression","endLine":229,"endColumn":83,"suggestions":[{"desc":"Update the dependencies array to be: [activeTab, applicationStatusFilter, applicationJobFilter, applicationSearch, loadApplications, loadStatistics]","fix":{"range":[8140,8217],"text":"[activeTab, applicationStatusFilter, applicationJobFilter, applicationSearch, loadApplications, loadStatistics]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\management\\integrations\\IntegrationsPageClient.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\management\\integrations\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\management\\invoices\\[id]\\receipt\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\management\\invoices\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Link' is defined but never used. Allowed unused vars must match /^_/u.","line":5,"column":8,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":12,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"Link"},"fix":{"range":[256,285],"text":""},"desc":"Remove unused import declaration."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\nimport React, { useEffect, useMemo, useState } from 'react';\r\nimport TableRow from \"@/components/TableRow\";\r\nimport { Receipt, ChevronLeft, ChevronRight, Download, Search, ChevronDown, X, CheckCircle2, Clock, XCircle } from \"lucide-react\";\r\nimport Link from \"next/link\";\r\n\r\ntype InvoiceRow = {\r\n  id: number;\r\n  invoiceNumber?: string | null;\r\n  receiptNumber?: string | null;\r\n  issuedAt: string;\r\n  total: number;\r\n  commissionAmount?: number | null;\r\n  netPayable: number | null;\r\n  status: string;\r\n  ownerId: number;\r\n  owner?: {\r\n    id: number;\r\n    name: string | null;\r\n    email: string | null;\r\n    phone: string | null;\r\n    role: string;\r\n  } | null;\r\n  booking?: { \r\n    id: number;\r\n    property?: { \r\n      id: number;\r\n      title: string | null;\r\n      type: string | null;\r\n    } | null;\r\n    user?: {\r\n      id: number;\r\n      name: string | null;\r\n      email: string | null;\r\n    } | null;\r\n  } | null;\r\n  verifiedByUser?: { id: number; name: string | null } | null;\r\n  approvedByUser?: { id: number; name: string | null } | null;\r\n  paidByUser?: { id: number; name: string | null } | null;\r\n  paidAt?: string | null;\r\n  paymentMethod?: string | null;\r\n  paymentRef?: string | null;\r\n};\r\n\r\nexport default function InvoicesManagementPage(){\r\n  const apiBase = typeof window === 'undefined'\r\n    ? (process.env.NEXT_PUBLIC_API_URL || \"http://127.0.0.1:4000\")\r\n    : '';\r\n  const [items, setItems] = useState<InvoiceRow[]>([]);\r\n  const [page, setPage] = useState(1);\r\n  const [pageSize] = useState(25);\r\n  const [total, setTotal] = useState(0);\r\n  const [loading, setLoading] = useState(false);\r\n  const [searchQuery, setSearchQuery] = useState(\"\");\r\n  const [statusFilter, setStatusFilter] = useState<string>(\"ALL\");\r\n\r\n  useEffect(() => {\r\n    let mounted = true;\r\n    setLoading(true);\r\n    (async () => {\r\n      try {\r\n        const url = `${apiBase.replace(/\\/$/, '')}/api/admin/invoices?page=${page}&pageSize=${pageSize}`;\r\n        const r = await fetch(url);\r\n        if (!r.ok) throw new Error('fetch failed');\r\n        const contentType = r.headers.get(\"content-type\");\r\n        if (contentType && contentType.includes(\"application/json\")) {\r\n          const j = await r.json();\r\n          if (!mounted) return;\r\n          setItems(j.items ?? []);\r\n          setTotal(j.total ?? 0);\r\n        } else {\r\n          throw new Error(\"Invalid response format\");\r\n        }\r\n      } catch (e: any) {\r\n        console.error('invoices fetch', e);\r\n        if (mounted) {\r\n          setItems([]);\r\n        }\r\n      } finally { if (mounted) setLoading(false); }\r\n    })();\r\n    return () => { mounted = false; };\r\n  }, [page, pageSize, apiBase]);\r\n\r\n  // Manual invoice actions intentionally removed (invoice lifecycle is automatic).\r\n\r\n  function downloadReceipt(inv: InvoiceRow) {\r\n    const url = `${apiBase.replace(/\\/$/, '')}/api/admin/invoices/${inv.id}/receipt.png`;\r\n    window.open(url, '_blank');\r\n  }\r\n\r\n  function getStatusIcon(status: string) {\r\n    const statusLower = status.toLowerCase();\r\n    if (statusLower.includes('paid')) {\r\n      return { Icon: CheckCircle2, className: \"h-4 w-4 text-emerald-600\" };\r\n    }\r\n    if (statusLower.includes('approved')) {\r\n      return { Icon: CheckCircle2, className: \"h-4 w-4 text-blue-600\" };\r\n    }\r\n    if (statusLower.includes('pending') || statusLower.includes('requested') || statusLower.includes('unpaid')) {\r\n      return { Icon: Clock, className: \"h-4 w-4 text-amber-600\" };\r\n    }\r\n    if (statusLower.includes('cancel') || statusLower.includes('reject')) {\r\n      return { Icon: XCircle, className: \"h-4 w-4 text-rose-600\" };\r\n    }\r\n    return { Icon: Clock, className: \"h-4 w-4 text-slate-500\" };\r\n  }\r\n\r\n  function formatCurrency(amount: number) {\r\n    return new Intl.NumberFormat('en-US', {\r\n      minimumFractionDigits: 0,\r\n      maximumFractionDigits: 2\r\n    }).format(amount);\r\n  }\r\n\r\n  const filteredItems = useMemo(() => {\r\n    const q = searchQuery.trim().toLowerCase();\r\n    return items.filter((inv) => {\r\n      if (statusFilter !== 'ALL' && inv.status !== statusFilter) return false;\r\n      if (!q) return true;\r\n      const haystack = [\r\n        inv.invoiceNumber,\r\n        inv.receiptNumber,\r\n        String(inv.id),\r\n        inv.owner?.name,\r\n        inv.owner?.email,\r\n        inv.owner?.phone,\r\n        inv.booking?.property?.title,\r\n        inv.booking?.property?.type,\r\n        inv.status,\r\n      ]\r\n        .filter(Boolean)\r\n        .join(' | ')\r\n        .toLowerCase();\r\n      return haystack.includes(q);\r\n    });\r\n  }, [items, searchQuery, statusFilter]);\r\n\r\n  const statusOptions = useMemo(() => {\r\n    const unique = new Set<string>();\r\n    items.forEach(i => unique.add(i.status));\r\n    return ['ALL', ...Array.from(unique).sort()];\r\n  }, [items]);\r\n\r\n  const paidOnPage = useMemo(() => filteredItems.filter(i => i.status?.toLowerCase().includes('paid')).length, [filteredItems]);\r\n  const pendingOnPage = useMemo(() => filteredItems.filter(i => {\r\n    const s = i.status?.toLowerCase() ?? '';\r\n    return s.includes('pending') || s.includes('unpaid');\r\n  }).length, [filteredItems]);\r\n  const approvedOnPage = useMemo(() => filteredItems.filter(i => i.status?.toLowerCase().includes('approved')).length, [filteredItems]);\r\n\r\n  function applyQuickFilter(kind: 'ALL' | 'PAID' | 'APPROVED' | 'PENDING') {\r\n    if (kind === 'ALL') {\r\n      setSearchQuery('');\r\n      setStatusFilter('ALL');\r\n      return;\r\n    }\r\n\r\n    const candidates = statusOptions.filter(s => s !== 'ALL');\r\n    const pick = (predicate: (s: string) => boolean) => candidates.find(s => predicate(s.toLowerCase()));\r\n\r\n    const selected =\r\n      kind === 'PAID'\r\n        ? pick((s) => s.includes('paid'))\r\n        : kind === 'APPROVED'\r\n          ? pick((s) => s.includes('approved'))\r\n          : pick((s) => s.includes('pending') || s.includes('unpaid'));\r\n\r\n    setSearchQuery('');\r\n    if (selected) {\r\n      setStatusFilter(selected);\r\n    } else {\r\n      setStatusFilter('ALL');\r\n      setSearchQuery(kind === 'PAID' ? 'paid' : kind === 'APPROVED' ? 'approved' : 'pending');\r\n    }\r\n  }\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      <div className=\"relative overflow-hidden rounded-2xl border border-slate-200 bg-white shadow-sm\">\r\n        <div className=\"absolute inset-0 bg-gradient-to-br from-[#02665e]/8 via-white to-sky-50\" />\r\n        <div className=\"relative p-6 sm:p-8\">\r\n          <div className=\"flex flex-col gap-5\">\r\n            <div className=\"flex flex-col items-center text-center gap-3\">\r\n              <div className=\"flex h-12 w-12 items-center justify-center rounded-2xl bg-[#02665e]/10 ring-1 ring-inset ring-[#02665e]/20\">\r\n                <Receipt className=\"h-6 w-6 text-[#02665e]\" />\r\n              </div>\r\n              <div>\r\n                <h1 className=\"text-2xl sm:text-3xl font-semibold tracking-tight text-slate-900\">\r\n                  All Invoices\r\n                </h1>\r\n                <p className=\"mt-1 text-sm text-slate-600 max-w-2xl mx-auto\">\r\n                  All invoices from owners and drivers across the platform.\r\n                </p>\r\n              </div>\r\n            </div>\r\n\r\n            <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3\">\r\n              <button\r\n                type=\"button\"\r\n                onClick={() => applyQuickFilter('ALL')}\r\n                className=\"group relative overflow-hidden text-left rounded-2xl border border-slate-200/80 bg-white/70 p-4 backdrop-blur transition-[transform,box-shadow,border-color] duration-300 ease-out hover:-translate-y-0.5 hover:shadow-lg hover:border-[#02665e]/25 focus:outline-none focus:ring-2 focus:ring-[#02665e]/30 before:pointer-events-none before:absolute before:inset-0 before:bg-gradient-to-br before:from-[#02665e]/10 before:via-white/0 before:to-sky-50 before:opacity-0 before:transition-opacity before:duration-300 group-hover:before:opacity-100\"\r\n                aria-label=\"Show all invoices\"\r\n              >\r\n                <div className=\"relative z-10 text-xs font-medium text-slate-600\">Total invoices</div>\r\n                <div className=\"relative z-10 mt-1 text-2xl font-semibold tracking-tight text-slate-900 tabular-nums\">{total.toLocaleString()}</div>\r\n                <div className=\"relative z-10 mt-3 inline-flex w-fit items-center rounded-full border border-slate-200/80 bg-white/60 px-2.5 py-1 text-[11px] font-medium text-slate-600 transition-colors duration-300 group-hover:bg-white/80 group-hover:text-slate-700\">Clear filters</div>\r\n              </button>\r\n\r\n              <button\r\n                type=\"button\"\r\n                onClick={() => applyQuickFilter('PAID')}\r\n                className=\"group relative overflow-hidden text-left rounded-2xl border border-slate-200/80 bg-white/70 p-4 backdrop-blur transition-[transform,box-shadow,border-color] duration-300 ease-out hover:-translate-y-0.5 hover:shadow-lg hover:border-emerald-300/70 focus:outline-none focus:ring-2 focus:ring-emerald-300/40 before:pointer-events-none before:absolute before:inset-0 before:bg-gradient-to-br before:from-emerald-400/10 before:via-white/0 before:to-emerald-50 before:opacity-0 before:transition-opacity before:duration-300 group-hover:before:opacity-100\"\r\n                aria-label=\"Filter paid invoices\"\r\n              >\r\n                <div className=\"relative z-10 text-xs font-medium text-slate-600\">Paid (this page)</div>\r\n                <div className=\"relative z-10 mt-1 text-2xl font-semibold tracking-tight text-slate-900 tabular-nums\">{paidOnPage.toLocaleString()}</div>\r\n                <div className=\"relative z-10 mt-3 inline-flex w-fit items-center rounded-full border border-slate-200/80 bg-white/60 px-2.5 py-1 text-[11px] font-medium text-slate-600 transition-colors duration-300 group-hover:bg-white/80 group-hover:text-slate-700\">Filter list</div>\r\n              </button>\r\n\r\n              <button\r\n                type=\"button\"\r\n                onClick={() => applyQuickFilter('APPROVED')}\r\n                className=\"group relative overflow-hidden text-left rounded-2xl border border-slate-200/80 bg-white/70 p-4 backdrop-blur transition-[transform,box-shadow,border-color] duration-300 ease-out hover:-translate-y-0.5 hover:shadow-lg hover:border-sky-300/70 focus:outline-none focus:ring-2 focus:ring-sky-300/40 before:pointer-events-none before:absolute before:inset-0 before:bg-gradient-to-br before:from-sky-400/10 before:via-white/0 before:to-sky-50 before:opacity-0 before:transition-opacity before:duration-300 group-hover:before:opacity-100\"\r\n                aria-label=\"Filter approved invoices\"\r\n              >\r\n                <div className=\"relative z-10 text-xs font-medium text-slate-600\">Approved (this page)</div>\r\n                <div className=\"relative z-10 mt-1 text-2xl font-semibold tracking-tight text-slate-900 tabular-nums\">{approvedOnPage.toLocaleString()}</div>\r\n                <div className=\"relative z-10 mt-3 inline-flex w-fit items-center rounded-full border border-slate-200/80 bg-white/60 px-2.5 py-1 text-[11px] font-medium text-slate-600 transition-colors duration-300 group-hover:bg-white/80 group-hover:text-slate-700\">Filter list</div>\r\n              </button>\r\n\r\n              <button\r\n                type=\"button\"\r\n                onClick={() => applyQuickFilter('PENDING')}\r\n                className=\"group relative overflow-hidden text-left rounded-2xl border border-slate-200/80 bg-white/70 p-4 backdrop-blur transition-[transform,box-shadow,border-color] duration-300 ease-out hover:-translate-y-0.5 hover:shadow-lg hover:border-amber-300/70 focus:outline-none focus:ring-2 focus:ring-amber-300/40 before:pointer-events-none before:absolute before:inset-0 before:bg-gradient-to-br before:from-amber-400/10 before:via-white/0 before:to-amber-50 before:opacity-0 before:transition-opacity before:duration-300 group-hover:before:opacity-100\"\r\n                aria-label=\"Filter pending or unpaid invoices\"\r\n              >\r\n                <div className=\"relative z-10 text-xs font-medium text-slate-600\">Pending/Unpaid (this page)</div>\r\n                <div className=\"relative z-10 mt-1 text-2xl font-semibold tracking-tight text-slate-900 tabular-nums\">{pendingOnPage.toLocaleString()}</div>\r\n                <div className=\"relative z-10 mt-3 inline-flex w-fit items-center rounded-full border border-slate-200/80 bg-white/60 px-2.5 py-1 text-[11px] font-medium text-slate-600 transition-colors duration-300 group-hover:bg-white/80 group-hover:text-slate-700\">Filter list</div>\r\n              </button>\r\n            </div>\r\n\r\n            <div className=\"rounded-2xl border border-slate-200/80 bg-white/70 shadow-sm backdrop-blur overflow-hidden focus-within:ring-2 focus-within:ring-[#02665e]/20 focus-within:border-[#02665e]/30\">\r\n              <div className=\"flex flex-col sm:flex-row items-stretch overflow-hidden\">\r\n                <div className=\"relative flex-1 min-w-0\">\r\n                  <label htmlFor=\"invoiceSearch\" className=\"sr-only\">Search invoices</label>\r\n                  <Search className=\"absolute left-4 top-1/2 h-5 w-5 -translate-y-1/2 text-slate-400 pointer-events-none\" />\r\n                  <input\r\n                    id=\"invoiceSearch\"\r\n                    value={searchQuery}\r\n                    onChange={(e) => setSearchQuery(e.target.value)}\r\n                    placeholder=\"Search by invoice #, receipt, owner, property, status…\"\r\n                    className=\"w-full min-w-0 border-0 bg-transparent py-3.5 pl-11 pr-4 text-sm text-slate-900 placeholder:text-slate-400 outline-none focus:ring-0\"\r\n                  />\r\n                </div>\r\n\r\n                <div className=\"flex min-w-0 items-stretch border-t border-slate-200/80 sm:border-t-0 sm:border-l\">\r\n                  <div className=\"relative w-full min-w-0 sm:w-64\">\r\n                    <label htmlFor=\"statusFilter\" className=\"sr-only\">Filter by status</label>\r\n                    <select\r\n                      id=\"statusFilter\"\r\n                      value={statusFilter}\r\n                      onChange={(e) => setStatusFilter(e.target.value)}\r\n                      className=\"h-full w-full min-w-0 !appearance-none !bg-none border-0 bg-transparent px-4 py-3.5 pr-10 text-sm font-medium text-slate-900 outline-none focus:ring-0\"\r\n                    >\r\n                      {statusOptions.map((s) => (\r\n                        <option key={s} value={s}>{s === 'ALL' ? 'All statuses' : s}</option>\r\n                      ))}\r\n                    </select>\r\n                    <ChevronDown className=\"pointer-events-none absolute right-3 top-1/2 h-4 w-4 -translate-y-1/2 text-slate-400\" />\r\n                  </div>\r\n\r\n                  {(searchQuery.trim() || statusFilter !== 'ALL') ? (\r\n                    <button\r\n                      type=\"button\"\r\n                      onClick={() => { setSearchQuery(''); setStatusFilter('ALL'); }}\r\n                      className=\"inline-flex shrink-0 items-center justify-center border-l border-slate-200/80 bg-white/40 px-3 text-slate-500 transition hover:bg-white/70 hover:text-slate-700 focus:outline-none\"\r\n                      aria-label=\"Clear filters\"\r\n                      title=\"Clear filters\"\r\n                    >\r\n                      <X className=\"h-4 w-4\" />\r\n                    </button>\r\n                  ) : null}\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      <div className=\"bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden\">\r\n        <div className=\"overflow-x-auto\">\r\n          <table className=\"min-w-full divide-y divide-slate-200\">\r\n            <thead className=\"bg-slate-50 sticky top-0 z-10\">\r\n              <tr>\r\n                <th className=\"px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider\">ID</th>\r\n                <th className=\"px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider\">Type</th>\r\n                <th className=\"px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider\">Invoice</th>\r\n                <th className=\"px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider\">Owner</th>\r\n                <th className=\"px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider\">Property</th>\r\n                <th className=\"px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider\">Issued</th>\r\n                <th className=\"px-4 py-3 text-right text-xs font-semibold text-slate-600 uppercase tracking-wider\">Total</th>\r\n                <th className=\"px-4 py-3 text-right text-xs font-semibold text-slate-600 uppercase tracking-wider\">Net</th>\r\n                <th className=\"px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider\">Status</th>\r\n                <th className=\"px-4 py-3 text-center text-xs font-semibold text-slate-600 uppercase tracking-wider\">Receipt</th>\r\n              </tr>\r\n            </thead>\r\n            <tbody className=\"bg-white divide-y divide-slate-100\">\r\n              {loading ? (\r\n                Array.from({ length: 8 }).map((_, idx) => (\r\n                  <TableRow key={`sk-${idx}`} hover={false}>\r\n                    <td colSpan={10} className=\"px-4 py-4\">\r\n                      <div className=\"h-10 w-full rounded-xl bg-slate-100 animate-pulse\" />\r\n                    </td>\r\n                  </TableRow>\r\n                ))\r\n              ) : filteredItems.length === 0 ? (\r\n                <TableRow hover={false}>\r\n                  <td colSpan={10} className=\"px-4 py-10 text-center\">\r\n                    <div className=\"mx-auto max-w-md\">\r\n                      <div className=\"text-sm font-medium text-slate-900\">No invoices match your filters</div>\r\n                      <div className=\"mt-1 text-sm text-slate-600\">Try clearing search or switching the status filter.</div>\r\n                      <div className=\"mt-4 flex justify-center gap-2\">\r\n                        <button\r\n                          className=\"px-3 py-2 text-sm font-medium text-slate-700 border border-slate-200 rounded-xl hover:bg-slate-50 transition\"\r\n                          onClick={() => { setSearchQuery(''); setStatusFilter('ALL'); }}\r\n                        >\r\n                          Clear filters\r\n                        </button>\r\n                      </div>\r\n                    </div>\r\n                  </td>\r\n                </TableRow>\r\n              ) : (\r\n                filteredItems.map(i => {\r\n                  const invoiceType = i.owner?.role === 'DRIVER' ? 'Driver' : 'Owner';\r\n                  return (\r\n                  <TableRow key={i.id}>\r\n                    <td className=\"px-4 py-3 text-sm text-slate-900 whitespace-nowrap font-semibold tabular-nums\">\r\n                      #{i.id.toLocaleString()}\r\n                    </td>\r\n                    <td className=\"px-4 py-3 text-sm\">\r\n                      <span className={`inline-flex items-center rounded-lg px-2.5 py-1 text-xs font-semibold ${\r\n                        invoiceType === 'Driver' \r\n                          ? 'bg-blue-50 text-blue-700 ring-1 ring-inset ring-blue-200' \r\n                          : 'bg-[#02665e]/10 text-[#02665e] ring-1 ring-inset ring-[#02665e]/20'\r\n                      }`}>\r\n                        {invoiceType}\r\n                      </span>\r\n                    </td>\r\n                    <td className=\"px-4 py-3 text-sm text-slate-700\">\r\n                      <div className=\"font-semibold text-slate-900\">{i.invoiceNumber ?? '—'}</div>\r\n                      {i.receiptNumber && (\r\n                        <div className=\"text-xs text-slate-500\">Receipt: <span className=\"tabular-nums\">{i.receiptNumber}</span></div>\r\n                      )}\r\n                    </td>\r\n                    <td className=\"px-4 py-3 text-sm text-slate-700\">\r\n                      <div className=\"font-semibold text-slate-900\">{i.owner?.name ?? `Owner #${i.ownerId}`}</div>\r\n                      {i.owner?.email && (\r\n                        <div className=\"text-xs text-slate-500 truncate max-w-[260px]\">{i.owner.email}</div>\r\n                      )}\r\n                      {i.owner?.phone && (\r\n                        <div className=\"text-xs text-slate-500 tabular-nums\">{i.owner.phone}</div>\r\n                      )}\r\n                    </td>\r\n                    <td className=\"px-4 py-3 text-sm text-slate-700\">\r\n                      <div className=\"font-medium text-slate-900\">{i.booking?.property?.title ?? '—'}</div>\r\n                      {i.booking?.property?.type && (\r\n                        <div className=\"text-xs text-slate-500\">{i.booking.property.type}</div>\r\n                      )}\r\n                    </td>\r\n                    <td className=\"px-4 py-3 text-sm text-slate-700 whitespace-nowrap\">\r\n                      <div className=\"tabular-nums text-slate-900 font-medium\">{new Date(i.issuedAt).toLocaleDateString()}</div>\r\n                      <div className=\"text-xs text-slate-500 tabular-nums\">{new Date(i.issuedAt).toLocaleTimeString()}</div>\r\n                    </td>\r\n                    <td className=\"px-4 py-3 text-sm text-slate-900 text-right whitespace-nowrap font-semibold tabular-nums\">\r\n                      {formatCurrency(Number(i.total))}\r\n                    </td>\r\n                    <td className=\"px-4 py-3 text-sm text-slate-900 text-right whitespace-nowrap\">\r\n                      <div className=\"font-semibold tabular-nums\">{i.netPayable ? formatCurrency(Number(i.netPayable)) : '—'}</div>\r\n                      {i.commissionAmount && (\r\n                        <div className=\"text-xs text-slate-500 tabular-nums\">Commission: {formatCurrency(Number(i.commissionAmount))}</div>\r\n                      )}\r\n                    </td>\r\n                    <td className=\"px-4 py-3 text-sm\">\r\n                      <div className=\"flex items-center\">\r\n                        {(() => {\r\n                          const { Icon, className } = getStatusIcon(i.status);\r\n                          return (\r\n                            <span title={i.status}>\r\n                              <Icon className={className} />\r\n                            </span>\r\n                          );\r\n                        })()}\r\n                      </div>\r\n                      {i.paidAt && (\r\n                        <div className=\"text-xs text-slate-500 mt-1.5 tabular-nums\">\r\n                          Paid: {new Date(i.paidAt).toLocaleDateString()}\r\n                        </div>\r\n                      )}\r\n                      {i.paymentMethod && (\r\n                        <div className=\"text-xs text-slate-500 mt-0.5\">\r\n                          {i.paymentMethod}\r\n                        </div>\r\n                      )}\r\n                    </td>\r\n                    <td className=\"px-4 py-3 text-sm\">\r\n                      <div className=\"flex justify-center\">\r\n                        {i.receiptNumber ? (\r\n                          <button\r\n                            className=\"inline-flex items-center gap-1 rounded-xl border border-slate-200 bg-white px-3 py-1.5 text-xs font-semibold text-slate-700 transition-all duration-200 hover:border-sky-300 hover:bg-sky-50/40 hover:text-sky-700 active:border-sky-400 active:text-sky-800\"\r\n                            onClick={() => downloadReceipt(i)}\r\n                          >\r\n                            <Download className=\"h-3 w-3\" />\r\n                            Receipt\r\n                          </button>\r\n                        ) : (\r\n                          <span className=\"text-xs text-slate-400\">—</span>\r\n                        )}\r\n                      </div>\r\n                    </td>\r\n                  </TableRow>\r\n                );\r\n                })\r\n              )}\r\n            </tbody>\r\n          </table>\r\n        </div>\r\n      </div>\r\n\r\n      <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 bg-white rounded-2xl border border-slate-200 p-4 shadow-sm\">\r\n        <div className=\"flex gap-2\">\r\n          <button \r\n            className=\"p-2 border border-slate-200 rounded-xl hover:border-[#02665e]/40 hover:text-[#02665e] transition-all duration-200 active:border-[#02665e] active:text-[#02665e] touch-manipulation disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center bg-white\"\r\n            onClick={() => setPage(p => Math.max(1, p - 1))}\r\n            disabled={page === 1 || loading}\r\n            aria-label=\"Previous page\"\r\n          >\r\n            <ChevronLeft className=\"h-5 w-5\" />\r\n          </button>\r\n          <button \r\n            className=\"p-2 border border-slate-200 rounded-xl hover:border-[#02665e]/40 hover:text-[#02665e] transition-all duration-200 active:border-[#02665e] active:text-[#02665e] touch-manipulation disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center bg-white\"\r\n            onClick={() => setPage(p => p + 1)}\r\n            disabled={items.length < pageSize || loading || (page * pageSize >= total)}\r\n            aria-label=\"Next page\"\r\n          >\r\n            <ChevronRight className=\"h-5 w-5\" />\r\n          </button>\r\n        </div>\r\n        <div className=\"text-sm text-slate-600\">\r\n          Page <span className=\"font-semibold text-slate-900 tabular-nums\">{page}</span>\r\n          {total > 0 && (\r\n            <span className=\"ml-2 text-slate-500 tabular-nums\">\r\n              (Total: {total.toLocaleString()})\r\n            </span>\r\n          )}\r\n        </div>\r\n      </div>\r\n\r\n      {/* Manual invoice actions intentionally removed (invoice lifecycle is automatic). */}\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\management\\ip-allowlist\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\management\\no4p-otp\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\management\\owners\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\management\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\management\\properties\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\management\\reports\\bookings\\BookingReportsClient.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\management\\reports\\bookings\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\management\\reports\\overview\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\management\\reports\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\management\\reports\\revenue\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\management\\settings\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'RefreshCw' is defined but never used. Allowed unused vars must match /^_/u.","line":3,"column":23,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":32,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"RefreshCw"},"fix":{"range":[114,125],"text":""},"desc":"Remove unused variable \"RefreshCw\"."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'previewBonus'. Either include it or remove the dependency array.","line":482,"column":6,"nodeType":"ArrayExpression","endLine":482,"endColumn":61,"suggestions":[{"desc":"Update the dependencies array to be: [bonusOwnerId, bonusPercentInput, bonusOwnerLookup.id, previewBonus]","fix":{"range":[20442,20497],"text":"[bonusOwnerId, bonusPercentInput, bonusOwnerLookup.id, previewBonus]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n// AdminPageHeader removed in favor of a centered, compact header for this page\nimport { ChevronDown, RefreshCw, Settings, Shield, Lock, AlertTriangle, Network, Clock } from \"lucide-react\";\nimport axios from \"axios\";\nimport { useCallback, useEffect, useRef, useState } from \"react\";\nimport { sanitizeTrustedHtml } from \"@/utils/html\";\nimport { AnimatePresence, motion } from \"framer-motion\";\n\n// Use same-origin calls + secure httpOnly cookie session.\nconst api = axios.create({ baseURL: \"\", withCredentials: true });\n\nexport default function SystemSettingsPage(){\n  const inputClass =\n    \"w-full rounded-lg border border-slate-200/70 bg-white/80 px-3 py-2 text-sm text-slate-900 shadow-sm outline-none transition-all duration-200 placeholder:text-slate-400 focus:border-[#02665e] focus:ring-2 focus:ring-inset focus:ring-[#02665e]/18\";\n  const cardClass =\n    \"group relative min-w-0 overflow-visible rounded-2xl border border-slate-200/60 bg-white/70 p-6 shadow-sm ring-1 ring-black/[0.03] backdrop-blur-xl transition-all duration-200 hover:z-10 focus-within:z-10 motion-safe:hover:-translate-y-0.5 hover:shadow-md\";\n  const cardTitleClass = \"text-base font-semibold tracking-tight text-slate-900\";\n  const cardHintClass = \"mt-1 text-sm text-slate-600\";\n  const labelClass = \"block text-xs font-medium text-slate-600\";\n  const helpClass = \"mt-1 text-xs text-slate-500\";\n  const rowClass =\n    \"flex min-w-0 items-start justify-between gap-4 rounded-xl border border-slate-200/70 bg-white/60 p-4 shadow-sm transition-colors duration-200 hover:bg-slate-50/70\";\n  const toggleTrackClass =\n    \"relative h-6 w-11 shrink-0 rounded-full bg-slate-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-[#02665e]/15 peer-checked:bg-[#02665e] after:absolute after:left-[2px] after:top-[2px] after:h-5 after:w-5 after:rounded-full after:border after:border-slate-200 after:bg-white after:transition-all peer-checked:after:translate-x-full\";\n  const btnPrimary =\n    \"inline-flex items-center justify-center gap-2 rounded-xl bg-gradient-to-b from-[#02776d] to-[#015b54] px-4 py-2 text-sm font-semibold text-white shadow-sm ring-1 ring-[#02665e]/20 transition-all duration-200 hover:from-[#026e65] hover:to-[#014f49] focus:outline-none focus:ring-4 focus:ring-[#02665e]/20 disabled:cursor-not-allowed disabled:opacity-60\";\n  const btnSecondary =\n    \"inline-flex items-center justify-center gap-2 rounded-xl border border-slate-200/80 bg-white/70 px-4 py-2 text-sm font-semibold text-slate-700 shadow-sm transition-all duration-200 hover:bg-white focus:outline-none focus:ring-4 focus:ring-[#02665e]/10\";\n\n  const formatMoney = (value: unknown) => {\n    const currency = (s?.currency || 'TZS').toUpperCase();\n    if (value === null || value === undefined || value === '') return '—';\n    if (typeof value === 'number' && Number.isFinite(value)) return `${value.toLocaleString()} ${currency}`;\n    if (typeof value === 'string') {\n      const parsed = Number(value);\n      if (Number.isFinite(parsed)) return `${parsed.toLocaleString()} ${currency}`;\n      return value;\n    }\n    return String(value);\n  };\n\n  const formatPercent = (value: unknown) => {\n    if (value === null || value === undefined || value === '') return '—';\n    if (typeof value === 'number' && Number.isFinite(value)) return `${value}%`;\n    if (typeof value === 'string') {\n      const parsed = Number(value);\n      if (Number.isFinite(parsed)) return `${parsed}%`;\n      return value;\n    }\n    return String(value);\n  };\n\n  interface SystemSettings {\n    commissionPercent: number;\n    taxPercent: number;\n    currency: string;\n    invoicePrefix: string;\n    receiptPrefix: string;\n    emailEnabled: boolean;\n    smsEnabled: boolean;\n    requireAdmin2FA: boolean;\n    minPasswordLength: number;\n    requirePasswordUppercase?: boolean;\n    requirePasswordLowercase?: boolean;\n    requirePasswordNumber?: boolean;\n    requirePasswordSpecial?: boolean;\n    sessionIdleMinutes: number;\n    maxSessionDurationHours?: number;\n    forceLogoutOnPasswordChange?: boolean;\n    sessionMaxMinutesAdmin?: number | null;\n    sessionMaxMinutesOwner?: number | null;\n    sessionMaxMinutesDriver?: number | null;\n    sessionMaxMinutesCustomer?: number | null;\n    ipAllowlist?: string | null;\n    enableIpAllowlist?: boolean;\n    apiRateLimitPerMinute?: number;\n    maxLoginAttempts?: number;\n    accountLockoutDurationMinutes?: number;\n    enableSecurityAuditLogging?: boolean;\n    logFailedLoginAttempts?: boolean;\n    alertOnSuspiciousActivity?: boolean;\n    supportEmail?: string | null;\n    supportPhone?: string | null;\n    featureFlags?: any;\n    notificationTemplates?: any;\n    invoiceTemplate?: string;\n    payoutCron?: string;\n  }\n\n  type SessionPolicyAuditEntry = {\n    id: string;\n    createdAt: string;\n    actorId: number | null;\n    actorRole: string | null;\n    actor: { id: number; email?: string | null; name?: string | null; role?: string | null } | null;\n    ip: string | null;\n    changes: Record<string, { from: any; to: any }> | null;\n  };\n\n  const [s,setS] = useState<SystemSettings>({\n    commissionPercent: 0,\n    taxPercent: 0,\n    currency: 'TZS',\n    invoicePrefix: 'INV-',\n    receiptPrefix: 'RCT-',\n    emailEnabled: true,\n    smsEnabled: false,\n    requireAdmin2FA: true,\n    minPasswordLength: 10,\n    requirePasswordUppercase: false,\n    requirePasswordLowercase: false,\n    requirePasswordNumber: false,\n    requirePasswordSpecial: false,\n    sessionIdleMinutes: 60,\n    maxSessionDurationHours: 24,\n    forceLogoutOnPasswordChange: true,\n    sessionMaxMinutesAdmin: null,\n    sessionMaxMinutesOwner: null,\n    sessionMaxMinutesDriver: null,\n    sessionMaxMinutesCustomer: null,\n    ipAllowlist: null,\n    enableIpAllowlist: false,\n    apiRateLimitPerMinute: 100,\n    maxLoginAttempts: 5,\n    accountLockoutDurationMinutes: 30,\n    enableSecurityAuditLogging: true,\n    logFailedLoginAttempts: true,\n    alertOnSuspiciousActivity: false,\n  });\n  const [loading, setLoading] = useState<boolean>(true);\n  // Local-only fields (feature flags / templates) kept in local state; backend integration can be added later\n  const [featureFlags, setFeatureFlags] = useState<string>('{}');\n  const [notificationTemplates, setNotificationTemplates] = useState<string>('{}');\n  const [invoiceTemplate, setInvoiceTemplate] = useState<string>('');\n  const [payoutCron, setPayoutCron] = useState<string>('');\n  const [invoicePreviewHtml, setInvoicePreviewHtml] = useState<string>('');\n  const [bonusOwnerId, setBonusOwnerId] = useState<string>('');\n  const [bonusPercentInput, setBonusPercentInput] = useState<number>(0);\n  const [bonusPreview, setBonusPreview] = useState<any>(null);\n  const [bonusOwnerLookup, setBonusOwnerLookup] = useState<{ id: number; name?: string | null; email?: string | null } | null>(null);\n  const [bonusOwnerLookupLoading, setBonusOwnerLookupLoading] = useState<boolean>(false);\n  const [bonusOwnerLookupError, setBonusOwnerLookupError] = useState<string | null>(null);\n  const lastAutoPreviewKeyRef = useRef<string>('');\n  const autoPreviewTimerRef = useRef<number | null>(null);\n  // support contact (editable by admin)\n  const [supportEmail, setSupportEmail] = useState<string>('');\n  const [supportPhone, setSupportPhone] = useState<string>('');\n\n  const [toast, setToast] = useState<string | null>(null);\n  const [sessionPolicyAudit, setSessionPolicyAudit] = useState<SessionPolicyAuditEntry[]>([]);\n  const [validationErrors, setValidationErrors] = useState<Record<string, string>>({});\n\n  useEffect(() => {\n    if (!toast) return;\n    const t = window.setTimeout(() => setToast(null), 3500);\n    return () => window.clearTimeout(t);\n  }, [toast]);\n\n  const load = useCallback(async ()=>{\n    try {\n      setLoading(true);\n      const r = await api.get('/admin/settings');\n      if (r?.data) setS(r.data);\n    } finally {\n      setLoading(false);\n    }\n  },[]);\n\n  const loadSessionPolicyAudit = useCallback(async ()=>{\n    try {\n      // Add cache-busting to ensure fresh audit data\n      const r = await api.get('/admin/settings/audit/session-policy', {\n        headers: {\n          'Cache-Control': 'no-cache',\n          'Pragma': 'no-cache',\n        },\n        params: {\n          _t: Date.now(), // timestamp cache buster\n        },\n      });\n      const items = Array.isArray(r?.data) ? r.data : [];\n      setSessionPolicyAudit(items);\n    } catch {\n      // non-fatal\n    }\n  }, []);\n\n  useEffect(()=>{ load(); },[load]);\n  useEffect(()=>{ loadSessionPolicyAudit(); },[loadSessionPolicyAudit]);\n\n  // sync some fields from s\n  useEffect(()=>{\n    if (!s) return;\n    setFeatureFlags(JSON.stringify(s.featureFlags ?? {}, null, 2));\n    setNotificationTemplates(JSON.stringify(s.notificationTemplates ?? {}, null, 2));\n    setInvoiceTemplate(s.invoiceTemplate ?? '');\n    setPayoutCron(s.payoutCron ?? '');\n    setSupportEmail(s.supportEmail ?? '');\n    setSupportPhone(s.supportPhone ?? '');\n  }, [s]);\n\n  // show a subtle loading hint while fetching but keep the form visible\n\n  // CIDR validation helper\n  function isValidCIDR(cidr: string): boolean {\n    const cidrRegex = /^([0-9]{1,3}\\.){3}[0-9]{1,3}\\/([0-9]|[12][0-9]|3[0-2])$/;\n    if (!cidrRegex.test(cidr.trim())) return false;\n    const [ip, prefix] = cidr.split('/');\n    const parts = ip.split('.').map(Number);\n    if (parts.length !== 4) return false;\n    if (parts.some(p => p < 0 || p > 255)) return false;\n    if (Number(prefix) < 0 || Number(prefix) > 32) return false;\n    return true;\n  }\n\n  function validateIPAllowlist(value: string): { valid: boolean; error?: string } {\n    if (!value || value.trim() === '') return { valid: true };\n    const entries = value.split(',').map(s => s.trim()).filter(s => s);\n    for (const entry of entries) {\n      if (!isValidCIDR(entry)) {\n        return { valid: false, error: `Invalid CIDR format: \"${entry}\". Use format like 192.168.1.0/24` };\n      }\n    }\n    return { valid: true };\n  }\n\n  const validateField = (field: string, value: any): string | null => {\n    // Skip validation for undefined/null values (they'll use defaults)\n    if (value === undefined || value === null || value === '') {\n      return null;\n    }\n\n    switch (field) {\n      case 'ipAllowlist':\n        const ipValidation = validateIPAllowlist(String(value || ''));\n        if (!ipValidation.valid) return ipValidation.error || 'Invalid IP allowlist format';\n        break;\n      case 'minPasswordLength':\n        const minLen = Number(value);\n        if (isNaN(minLen) || minLen < 6 || minLen > 128) {\n          return 'Password length must be between 6 and 128 characters';\n        }\n        break;\n      case 'sessionIdleMinutes':\n        const idle = Number(value);\n        if (isNaN(idle) || idle < 5 || idle > 1440) {\n          return 'Session idle timeout must be between 5 and 1440 minutes';\n        }\n        break;\n      case 'maxSessionDurationHours':\n        const duration = Number(value);\n        if (isNaN(duration) || duration < 1 || duration > 720) {\n          return 'Max session duration must be between 1 and 720 hours';\n        }\n        break;\n      case 'apiRateLimitPerMinute':\n        const rateLimit = Number(value);\n        if (isNaN(rateLimit) || rateLimit < 10 || rateLimit > 10000) {\n          return 'API rate limit must be between 10 and 10000 requests per minute';\n        }\n        break;\n      case 'maxLoginAttempts':\n        const attempts = Number(value);\n        if (isNaN(attempts) || attempts < 3 || attempts > 20) {\n          return 'Max login attempts must be between 3 and 20';\n        }\n        break;\n      case 'accountLockoutDurationMinutes':\n        const lockout = Number(value);\n        if (isNaN(lockout) || lockout < 5 || lockout > 1440) {\n          return 'Account lockout duration must be between 5 and 1440 minutes';\n        }\n        break;\n    }\n    return null;\n  };\n\n  const saveSystemSettings = async () => {\n    // Validate all fields before saving - use actual values or defaults\n    const errors: Record<string, string> = {};\n    \n    // Validate with actual values (using defaults if not set)\n    const valuesToValidate = {\n      ipAllowlist: s.ipAllowlist || '',\n      minPasswordLength: s.minPasswordLength ?? 10,\n      sessionIdleMinutes: s.sessionIdleMinutes ?? 60,\n      maxSessionDurationHours: s.maxSessionDurationHours ?? 24,\n      apiRateLimitPerMinute: s.apiRateLimitPerMinute ?? 100,\n      maxLoginAttempts: s.maxLoginAttempts ?? 5,\n      accountLockoutDurationMinutes: s.accountLockoutDurationMinutes ?? 30,\n    };\n    \n    // Only validate ipAllowlist if it has a value (it's optional)\n    if (valuesToValidate.ipAllowlist && valuesToValidate.ipAllowlist.trim() !== '') {\n      const error = validateField('ipAllowlist', valuesToValidate.ipAllowlist);\n      if (error) errors.ipAllowlist = error;\n    }\n    \n    // Validate numeric fields\n    const numericFields: Array<keyof typeof valuesToValidate> = [\n      'minPasswordLength', 'sessionIdleMinutes', 'maxSessionDurationHours',\n      'apiRateLimitPerMinute', 'maxLoginAttempts', 'accountLockoutDurationMinutes'\n    ];\n    \n    numericFields.forEach(field => {\n      const error = validateField(field, valuesToValidate[field]);\n      if (error) errors[field] = error;\n    });\n    \n    if (Object.keys(errors).length > 0) {\n      setValidationErrors(errors);\n      const errorMessages = Object.values(errors);\n      setToast(`Please fix validation errors: ${errorMessages[0]}${errorMessages.length > 1 ? ` (+${errorMessages.length - 1} more)` : ''}`);\n      return;\n    }\n    \n    setValidationErrors({});\n    // only send fields that exist on SystemSetting model\n  const payload: any = {\n      commissionPercent: Number(s.commissionPercent ?? 0),\n      taxPercent: Number(s.taxPercent ?? 0),\n      currency: s.currency || 'TZS',\n      invoicePrefix: s.invoicePrefix || 'INV-',\n      receiptPrefix: s.receiptPrefix || 'RCT-',\n      emailEnabled: Boolean(s.emailEnabled),\n      smsEnabled: Boolean(s.smsEnabled),\n      requireAdmin2FA: Boolean(s.requireAdmin2FA),\n      minPasswordLength: Number(s.minPasswordLength || 10),\n      requirePasswordUppercase: Boolean(s.requirePasswordUppercase ?? false),\n      requirePasswordLowercase: Boolean(s.requirePasswordLowercase ?? false),\n      requirePasswordNumber: Boolean(s.requirePasswordNumber ?? false),\n      requirePasswordSpecial: Boolean(s.requirePasswordSpecial ?? false),\n  sessionIdleMinutes: Number(s.sessionIdleMinutes || 60),\n  maxSessionDurationHours: Number(s.maxSessionDurationHours || 24),\n  forceLogoutOnPasswordChange: Boolean(s.forceLogoutOnPasswordChange ?? true),\n  sessionMaxMinutesAdmin: (s.sessionMaxMinutesAdmin == null || Number(s.sessionMaxMinutesAdmin) <= 0) ? null : Number(s.sessionMaxMinutesAdmin),\n  sessionMaxMinutesOwner: (s.sessionMaxMinutesOwner == null || Number(s.sessionMaxMinutesOwner) <= 0) ? null : Number(s.sessionMaxMinutesOwner),\n  sessionMaxMinutesDriver: (s.sessionMaxMinutesDriver == null || Number(s.sessionMaxMinutesDriver) <= 0) ? null : Number(s.sessionMaxMinutesDriver),\n  sessionMaxMinutesCustomer: (s.sessionMaxMinutesCustomer == null || Number(s.sessionMaxMinutesCustomer) <= 0) ? null : Number(s.sessionMaxMinutesCustomer),\n  ipAllowlist: s.ipAllowlist || null,\n  enableIpAllowlist: Boolean(s.enableIpAllowlist ?? false),\n  apiRateLimitPerMinute: Number(s.apiRateLimitPerMinute || 100),\n  maxLoginAttempts: Number(s.maxLoginAttempts || 5),\n  accountLockoutDurationMinutes: Number(s.accountLockoutDurationMinutes || 30),\n  enableSecurityAuditLogging: Boolean(s.enableSecurityAuditLogging ?? true),\n  logFailedLoginAttempts: Boolean(s.logFailedLoginAttempts ?? true),\n  alertOnSuspiciousActivity: Boolean(s.alertOnSuspiciousActivity ?? false),\n  supportEmail: supportEmail || s.supportEmail,\n  supportPhone: supportPhone || s.supportPhone,\n    };\n    try {\n      await api.put('/admin/settings', payload);\n      setToast('System settings saved (audit recorded)');\n      await load();\n      await loadSessionPolicyAudit();\n    } catch (err) {\n      console.error(err);\n      setToast('Failed to save system settings');\n    }\n  };\n\n  const renderAuditChanges = (changes: Record<string, { from: any; to: any }> | null) => {\n    if (!changes || !Object.keys(changes).length) return 'No field-level diff available.';\n    const parts = Object.entries(changes).map(([k, v]) => {\n      const from = v?.from;\n      const to = v?.to;\n      return `${k}: ${from ?? 'null'} → ${to ?? 'null'}`;\n    });\n    return parts.join('\\n');\n  };\n\n  const saveFlagsAndTemplates = async () => {\n    // For now we don't persist feature flags/templates in SystemSetting; backend work needed\n    setToast('Feature flags & templates saving needs backend support. This is a client-only preview.');\n  };\n\n  const saveInvoicingSettings = async () => {\n    // Save taxPercent and invoicePrefix (persisted via SystemSetting) and keep invoiceTemplate client-side\n    try {\n      await api.put('/admin/settings', { taxPercent: Number(s.taxPercent || 0), invoicePrefix: s.invoicePrefix || 'INV-' });\n      setToast('Invoicing settings saved');\n    } catch (err) {\n      console.error(err);\n      setToast('Failed to save invoicing settings');\n    }\n  };\n\n  const previewBonus = async () => {\n    const ownerId = Number(bonusOwnerId);\n    if (!Number.isFinite(ownerId) || ownerId <= 0) {\n      setToast('Valid Owner ID is required');\n      return;\n    }\n    if (!Number.isFinite(bonusPercentInput) || bonusPercentInput < 0) {\n      setToast('Valid Bonus (%) is required');\n      return;\n    }\n    try {\n      const r = await api.post('/admin/bonuses/grant', { ownerId, bonusPercent: Number(bonusPercentInput) });\n      setBonusPreview(r.data);\n    } catch (err) {\n      console.error(err);\n      setToast('Failed to preview bonus');\n    }\n  };\n\n  const grantBonus = async () => {\n    const ownerId = Number(bonusOwnerId);\n    if (!Number.isFinite(ownerId) || ownerId <= 0) {\n      setToast('Valid Owner ID is required');\n      return;\n    }\n    if (!Number.isFinite(bonusPercentInput) || bonusPercentInput < 0) {\n      setToast('Valid Bonus (%) is required');\n      return;\n    }\n    if (!confirm('Grant bonus to owner? This action will be recorded in the admin audit log.')) return;\n    try {\n      const r = await api.post('/admin/bonuses/grant', { ownerId, bonusPercent: Number(bonusPercentInput), reason: 'Manual grant from settings UI' });\n      setBonusPreview(r.data);\n      setToast('Bonus grant recorded (audit only)');\n    } catch (err) {\n      console.error(err);\n      setToast('Failed to grant bonus');\n    }\n  };\n\n  // Auto-detect owner from pasted/typed Owner ID\n  useEffect(() => {\n    const ownerId = Number(bonusOwnerId);\n    setBonusOwnerLookup(null);\n    setBonusOwnerLookupError(null);\n    if (!Number.isFinite(ownerId) || ownerId <= 0) return;\n\n    let cancelled = false;\n    setBonusOwnerLookupLoading(true);\n\n    (async () => {\n      try {\n        const r = await api.get<{ owner?: { id: number; name?: string | null; email?: string | null } }>(`/api/admin/owners/${ownerId}`);\n        if (cancelled) return;\n        const owner = (r.data as any)?.owner;\n        if (!owner?.id) {\n          setBonusOwnerLookup(null);\n          setBonusOwnerLookupError('Owner not found');\n          return;\n        }\n        setBonusOwnerLookup({ id: owner.id, name: owner.name ?? null, email: owner.email ?? null });\n      } catch (err) {\n        if (cancelled) return;\n        setBonusOwnerLookup(null);\n        setBonusOwnerLookupError('Owner not found');\n      } finally {\n        if (!cancelled) setBonusOwnerLookupLoading(false);\n      }\n    })();\n\n    return () => {\n      cancelled = true;\n    };\n  }, [bonusOwnerId]);\n\n  // Auto-preview bonus once we have a valid owner (debounced)\n  useEffect(() => {\n    const ownerId = Number(bonusOwnerId);\n    if (!Number.isFinite(ownerId) || ownerId <= 0) return;\n    if (!bonusOwnerLookup?.id || bonusOwnerLookup.id !== ownerId) return;\n    if (!Number.isFinite(bonusPercentInput) || bonusPercentInput < 0) return;\n\n    const key = `${ownerId}:${bonusPercentInput}`;\n    if (key === lastAutoPreviewKeyRef.current) return;\n\n    if (autoPreviewTimerRef.current) window.clearTimeout(autoPreviewTimerRef.current);\n    autoPreviewTimerRef.current = window.setTimeout(() => {\n      lastAutoPreviewKeyRef.current = key;\n      void previewBonus();\n    }, 450);\n\n    return () => {\n      if (autoPreviewTimerRef.current) window.clearTimeout(autoPreviewTimerRef.current);\n    };\n  }, [bonusOwnerId, bonusPercentInput, bonusOwnerLookup?.id]);\n\n  const previewInvoice = async () => {\n    try {\n      const r = await api.post('/admin/settings/numbering/preview', { type: 'invoice' });\n      const sample = r.data?.sample || '';\n      // simple preview using invoiceTemplate + sample number\n      const rawPreview = (invoiceTemplate || '<div>Invoice {{invoiceNumber}}</div>').replace(/{{\\s*invoiceNumber\\s*}}/g, sample);\n      setInvoicePreviewHtml(sanitizeTrustedHtml(rawPreview));\n      setToast('Invoice preview generated');\n    } catch (err) {\n      console.error(err);\n      setToast('Failed to generate preview');\n    }\n  };\n\n  const updatePayoutCron = async () => {\n    setToast('Saving cron expressions requires backend support; not implemented yet.');\n  };\n\n  return (\n    <motion.div\n      initial={{ opacity: 0, y: 8 }}\n      animate={{ opacity: 1, y: 0 }}\n      transition={{ duration: 0.35, ease: \"easeOut\" }}\n      className=\"min-h-screen w-full bg-[radial-gradient(1200px_circle_at_30%_-10%,rgba(2,102,94,0.12),transparent_55%),radial-gradient(900px_circle_at_90%_0%,rgba(15,23,42,0.06),transparent_55%)] bg-slate-50\"\n    >\n      <div className=\"mx-auto w-full min-w-0 max-w-3xl px-4 py-6 pb-24 sm:px-6 lg:px-8\">\n        <div className=\"flex flex-col gap-4\">\n          <div className=\"rounded-3xl border border-slate-200/60 bg-white/70 p-6 shadow-sm ring-1 ring-black/[0.03] backdrop-blur-xl\">\n            <div className=\"flex flex-col items-center gap-4\">\n              <div className=\"flex flex-col items-center gap-3 text-center\">\n                <div className=\"rounded-2xl bg-[#02665e]/10 p-3 ring-1 ring-[#02665e]/15\">\n                  <Settings className=\"h-6 w-6 text-[#02665e]\" />\n                </div>\n                <div className=\"text-center\">\n                  <h1 className=\"text-2xl font-semibold tracking-tight text-slate-900 sm:text-3xl\">System Settings</h1>\n                  <p className=\"mt-1 text-sm text-slate-600\">Premium controls for platform configuration and security.</p>\n                  {loading && <div className=\"mt-2 text-xs text-slate-500\">Syncing latest settings…</div>}\n                </div>\n              </div>\n            </div>\n          </div>\n\n          <AnimatePresence>\n            {toast && (\n              <motion.div\n                initial={{ opacity: 0, y: -10 }}\n                animate={{ opacity: 1, y: 0 }}\n                exit={{ opacity: 0, y: -10 }}\n                transition={{ duration: 0.2 }}\n                className=\"fixed top-4 z-50 left-4 right-4 sm:left-auto sm:right-4 sm:w-[28rem]\"\n              >\n                <div className=\"w-full max-w-full break-words rounded-2xl bg-slate-900 px-4 py-3 text-sm font-medium text-white shadow-xl ring-1 ring-white/10\">\n                  {toast}\n                </div>\n              </motion.div>\n            )}\n          </AnimatePresence>\n        </div>\n\n        <div className=\"mt-8 flex w-full min-w-0 flex-col gap-6\">\n          {/* Payment */}\n          <section className={cardClass}>\n            <div className=\"flex items-start justify-between gap-3\">\n              <div>\n                <h3 className={cardTitleClass}>Payments</h3>\n                <p className={cardHintClass}>Platform fee and currency formatting.</p>\n              </div>\n              <span className=\"inline-flex items-center rounded-full border border-slate-200/70 bg-white/60 px-2.5 py-1 text-xs font-medium text-slate-600\">Finance</span>\n            </div>\n\n            <div className=\"mt-5 grid grid-cols-1 items-stretch gap-4 sm:grid-cols-2\">\n              <div className=\"flex h-full min-w-0 flex-col overflow-visible rounded-xl border border-emerald-200/70 bg-emerald-50/30 p-4 shadow-sm\">\n                <label htmlFor=\"commissionPercent\" className={labelClass}>Commission Rate</label>\n                <div className=\"mt-2 flex w-full min-w-0 overflow-hidden rounded-lg border border-emerald-200/70 bg-white/70 shadow-sm transition-all duration-200 focus-within:border-emerald-600 focus-within:ring-2 focus-within:ring-inset focus-within:ring-emerald-500/20\">\n                  <input\n                    id=\"commissionPercent\"\n                    type=\"number\"\n                    min={0}\n                    step=\"0.01\"\n                    inputMode=\"decimal\"\n                    placeholder=\"10\"\n                    value={s?.commissionPercent ?? 0}\n                    className=\"min-w-0 flex-1 border-0 bg-transparent px-3 py-2 text-sm text-slate-900 outline-none placeholder:text-slate-400\"\n                    onChange={e=>setS((prev: any)=>({...(prev||{}), commissionPercent: Number(e.target.value)}))}\n                  />\n                  <div className=\"flex shrink-0 items-center border-l border-emerald-200/70 bg-emerald-50/70 px-3 text-xs font-semibold text-emerald-700\">\n                    %\n                  </div>\n                </div>\n              </div>\n\n              <div className=\"flex h-full min-w-0 flex-col overflow-visible rounded-xl border border-indigo-200/70 bg-indigo-50/30 p-4 shadow-sm\">\n                <label htmlFor=\"currency\" className={labelClass}>Currency</label>\n                <div className=\"mt-2 flex w-full min-w-0 overflow-hidden rounded-lg border border-indigo-200/70 bg-white/70 shadow-sm transition-all duration-200 focus-within:border-indigo-600 focus-within:ring-2 focus-within:ring-inset focus-within:ring-indigo-500/20\">\n                  <select\n                    id=\"currency\"\n                    className=\"min-w-0 flex-1 appearance-none bg-none border-0 bg-transparent px-3 py-2 text-sm text-slate-900 outline-none\"\n                    value={s?.currency||'TZS'}\n                    onChange={e=>setS((prev: any)=>({...(prev||{}), currency: e.target.value}))}\n                  >\n                    <option value=\"TZS\">TZS</option>\n                    <option value=\"USD\">USD</option>\n                    <option value=\"EUR\">EUR</option>\n                    <option value=\"KSH\">KSH</option>\n                    <option value=\"AED\">AED</option>\n                  </select>\n                  <div className=\"flex shrink-0 items-center border-l border-indigo-200/70 bg-indigo-50/70 px-3 text-indigo-600\">\n                    <ChevronDown className=\"h-4 w-4\" />\n                  </div>\n                </div>\n              </div>\n            </div>\n          </section>\n\n          {/* Notifications + Support */}\n          <section className={cardClass}>\n            <div className=\"flex items-start justify-between gap-4\">\n              <div>\n                <h3 className={cardTitleClass}>Notifications</h3>\n                <p className={cardHintClass}>Channels and customer support contact.</p>\n              </div>\n              <span className=\"inline-flex items-center rounded-full border border-slate-200/70 bg-white/60 px-2.5 py-1 text-xs font-medium text-slate-600\">Live</span>\n            </div>\n\n            <div className=\"mt-5 space-y-3\">\n              <div className={rowClass}>\n                <div className=\"min-w-0\">\n                  <div className=\"text-sm font-medium text-slate-900\">Email notifications</div>\n                  <div className={helpClass}>Send emails for invoices and key actions.</div>\n                </div>\n                <label className=\"group relative inline-flex cursor-pointer items-center\">\n                  <input\n                    type=\"checkbox\"\n                    aria-label=\"Email notifications\"\n                    checked={Boolean(s.emailEnabled)}\n                    className=\"peer sr-only\"\n                    onChange={e=>setS({...s, emailEnabled: e.target.checked})}\n                  />\n                  <div className={toggleTrackClass}>\n                    <Lock className=\"absolute left-[6px] top-1/2 h-3 w-3 -translate-y-1/2 text-white opacity-0 transition-opacity duration-200 group-has-[:checked]:opacity-100 pointer-events-none\" />\n                  </div>\n                </label>\n              </div>\n\n              <div className={rowClass}>\n                <div className=\"min-w-0\">\n                  <div className=\"text-sm font-medium text-slate-900\">SMS alerts</div>\n                  <div className={helpClass}>Urgent events and operational alerts.</div>\n                </div>\n                <label className=\"group relative inline-flex cursor-pointer items-center\">\n                  <input\n                    type=\"checkbox\"\n                    aria-label=\"SMS alerts\"\n                    checked={Boolean(s.smsEnabled)}\n                    className=\"peer sr-only\"\n                    onChange={e=>setS({...s, smsEnabled: e.target.checked})}\n                  />\n                  <div className={toggleTrackClass}>\n                    <Lock className=\"absolute left-[6px] top-1/2 h-3 w-3 -translate-y-1/2 text-white opacity-0 transition-opacity duration-200 group-has-[:checked]:opacity-100 pointer-events-none\" />\n                  </div>\n                </label>\n              </div>\n\n              <div className=\"grid grid-cols-1 items-stretch gap-4 sm:grid-cols-2\">\n                <div className=\"flex h-full min-w-0 flex-col overflow-visible rounded-xl border border-slate-200/70 bg-white/60 p-4 shadow-sm\">\n                  <label className={labelClass}>Support email</label>\n                  <input\n                    className={`${inputClass} mt-2`}\n                    value={supportEmail}\n                    onChange={e=>setSupportEmail(e.target.value)}\n                    placeholder=\"support@nolsaf.com\"\n                  />\n                </div>\n                <div className=\"flex h-full min-w-0 flex-col overflow-visible rounded-xl border border-slate-200/70 bg-white/60 p-4 shadow-sm\">\n                  <label className={labelClass}>Support phone</label>\n                  <input\n                    className={`${inputClass} mt-2`}\n                    value={supportPhone}\n                    onChange={e=>setSupportPhone(e.target.value)}\n                    placeholder=\"+255 736 766 726\"\n                  />\n                </div>\n              </div>\n\n              <div className=\"mt-2 rounded-2xl border border-slate-200/70 bg-slate-50/60 p-4\">\n                <div className=\"flex items-center justify-between gap-3\">\n                  <div>\n                    <div className=\"text-sm font-medium text-slate-900\">Feature flags & templates</div>\n                    <div className={helpClass}>Client preview only (backend persistence pending).</div>\n                  </div>\n                  <span className=\"inline-flex items-center rounded-full border border-amber-200/70 bg-amber-50 px-2.5 py-1 text-xs font-medium text-amber-700\">Preview</span>\n                </div>\n                <div className=\"mt-3 grid grid-cols-1 items-stretch gap-4 lg:grid-cols-2\">\n                  <div className=\"flex h-full min-w-0 flex-col overflow-visible rounded-xl border border-slate-200/70 bg-white/60 p-4 shadow-sm\">\n                    <label htmlFor=\"featureFlags\" className={labelClass}>Feature Flags (JSON)</label>\n                    <textarea\n                      id=\"featureFlags\"\n                      className={`${inputClass} mt-2 h-28 font-mono text-[12px]`}\n                      value={featureFlags}\n                      onChange={e=>setFeatureFlags(e.target.value)}\n                      placeholder='{\"new_ui\": true}'\n                    />\n                  </div>\n                  <div className=\"flex h-full min-w-0 flex-col overflow-visible rounded-xl border border-slate-200/70 bg-white/60 p-4 shadow-sm\">\n                    <label htmlFor=\"notificationTemplates\" className={labelClass}>Notification Templates (JSON)</label>\n                    <textarea\n                      id=\"notificationTemplates\"\n                      className={`${inputClass} mt-2 h-28 font-mono text-[12px]`}\n                      value={notificationTemplates}\n                      onChange={e=>setNotificationTemplates(e.target.value)}\n                      placeholder='{\"owner_payout\": \"Your payout of {{amount}} was processed\"}'\n                    />\n                  </div>\n                </div>\n                <div className=\"mt-3\">\n                  <button onClick={saveFlagsAndTemplates} className={btnSecondary} type=\"button\">Save (preview)</button>\n                </div>\n              </div>\n            </div>\n          </section>\n\n          {/* Security & Sessions */}\n          <section className={cardClass}>\n            <div>\n              <h3 className={cardTitleClass}>Security & Sessions</h3>\n              <p className={cardHintClass}>Role-based session TTL is enforced server-side and audited.</p>\n            </div>\n\n            <div className=\"mt-5 space-y-3\">\n              <div className={rowClass}>\n                <div className=\"min-w-0\">\n                  <div className=\"text-sm font-medium text-slate-900\">Require 2FA for admins</div>\n                  <div className={helpClass}>Enforce two-factor authentication for all admin accounts.</div>\n                </div>\n                <label className=\"group relative inline-flex cursor-pointer items-center\">\n                  <input\n                    id=\"admin2fa\"\n                    type=\"checkbox\"\n                    aria-label=\"Require 2FA for admins\"\n                    checked={Boolean(s?.requireAdmin2FA)}\n                    className=\"peer sr-only\"\n                    onChange={e=>setS(prev=>({...(prev||{}), requireAdmin2FA: e.target.checked}))}\n                  />\n                  <div className={toggleTrackClass}>\n                    <Lock className=\"absolute left-[6px] top-1/2 h-3 w-3 -translate-y-1/2 text-white opacity-0 transition-opacity duration-200 group-has-[:checked]:opacity-100 pointer-events-none\" />\n                  </div>\n                </label>\n              </div>\n\n              <div className=\"rounded-2xl border border-slate-200/70 bg-white/60 p-4\">\n                <div className=\"flex flex-wrap items-center justify-between gap-2\">\n                  <div>\n                    <div className=\"text-sm font-medium text-slate-900\">Session TTL by role (minutes)</div>\n                    <div className={helpClass}>Blank role values fall back to Default.</div>\n                  </div>\n                  <span className=\"inline-flex items-center rounded-full border border-slate-200/70 bg-white/60 px-2.5 py-1 text-xs font-medium text-slate-600\">Audited</span>\n                </div>\n\n                <div className=\"mt-4 grid grid-cols-1 gap-4 sm:grid-cols-2 md:grid-cols-3 xl:grid-cols-5\">\n                  <div className=\"min-w-0 rounded-xl border border-slate-200/70 bg-gradient-to-b from-slate-50/70 to-white/70 p-4 shadow-sm ring-1 ring-slate-900/[0.03]\">\n                    <div className=\"flex items-baseline justify-between gap-3\">\n                      <div className=\"flex items-center gap-2\">\n                        <span className=\"h-2 w-2 rounded-full bg-slate-400\" />\n                        <label htmlFor=\"sessionTtlDefault\" className=\"text-sm font-semibold text-slate-900\">Default</label>\n                      </div>\n                    </div>\n                    <input\n                      id=\"sessionTtlDefault\"\n                      type=\"number\"\n                      min={5}\n                      className={`${inputClass} mt-3 bg-white/70 shadow-none`}\n                      value={(s?.sessionIdleMinutes ?? 60) as any}\n                      onChange={e=>setS(prev=>({...(prev||{}), sessionIdleMinutes: Number(e.target.value)}))}\n                    />\n                  </div>\n\n                  <div className=\"min-w-0 rounded-xl border border-emerald-200/70 bg-gradient-to-b from-emerald-50/70 to-white/70 p-4 shadow-sm ring-1 ring-emerald-500/10\">\n                    <div className=\"flex items-baseline justify-between gap-3\">\n                      <div className=\"flex items-center gap-2\">\n                        <span className=\"h-2 w-2 rounded-full bg-emerald-500\" />\n                        <label htmlFor=\"sessionTtlAdmin\" className=\"text-sm font-semibold text-slate-900\">Admin</label>\n                      </div>\n                    </div>\n                    <input\n                      id=\"sessionTtlAdmin\"\n                      type=\"number\"\n                      min={5}\n                      placeholder=\"(default)\"\n                      className={`${inputClass} mt-3 bg-white/70 shadow-none`}\n                      value={(s?.sessionMaxMinutesAdmin ?? '') as any}\n                      onChange={e=>setS(prev=>({...(prev||{}), sessionMaxMinutesAdmin: e.target.value === '' ? null : Number(e.target.value)}))}\n                    />\n                  </div>\n\n                  <div className=\"min-w-0 rounded-xl border border-indigo-200/70 bg-gradient-to-b from-indigo-50/70 to-white/70 p-4 shadow-sm ring-1 ring-indigo-500/10\">\n                    <div className=\"flex items-baseline justify-between gap-3\">\n                      <div className=\"flex items-center gap-2\">\n                        <span className=\"h-2 w-2 rounded-full bg-indigo-500\" />\n                        <label htmlFor=\"sessionTtlOwner\" className=\"text-sm font-semibold text-slate-900\">Owner</label>\n                      </div>\n                    </div>\n                    <input\n                      id=\"sessionTtlOwner\"\n                      type=\"number\"\n                      min={5}\n                      placeholder=\"(default)\"\n                      className={`${inputClass} mt-3 bg-white/70 shadow-none`}\n                      value={(s?.sessionMaxMinutesOwner ?? '') as any}\n                      onChange={e=>setS(prev=>({...(prev||{}), sessionMaxMinutesOwner: e.target.value === '' ? null : Number(e.target.value)}))}\n                    />\n                  </div>\n\n                  <div className=\"min-w-0 rounded-xl border border-amber-200/70 bg-gradient-to-b from-amber-50/70 to-white/70 p-4 shadow-sm ring-1 ring-amber-500/10\">\n                    <div className=\"flex items-baseline justify-between gap-3\">\n                      <div className=\"flex items-center gap-2\">\n                        <span className=\"h-2 w-2 rounded-full bg-amber-500\" />\n                        <label htmlFor=\"sessionTtlDriver\" className=\"text-sm font-semibold text-slate-900\">Driver</label>\n                      </div>\n                    </div>\n                    <input\n                      id=\"sessionTtlDriver\"\n                      type=\"number\"\n                      min={5}\n                      placeholder=\"(default)\"\n                      className={`${inputClass} mt-3 bg-white/70 shadow-none`}\n                      value={(s?.sessionMaxMinutesDriver ?? '') as any}\n                      onChange={e=>setS(prev=>({...(prev||{}), sessionMaxMinutesDriver: e.target.value === '' ? null : Number(e.target.value)}))}\n                    />\n                  </div>\n\n                  <div className=\"min-w-0 rounded-xl border border-sky-200/70 bg-gradient-to-b from-sky-50/70 to-white/70 p-4 shadow-sm ring-1 ring-sky-500/10\">\n                    <div className=\"flex items-baseline justify-between gap-3\">\n                      <div className=\"flex items-center gap-2\">\n                        <span className=\"h-2 w-2 rounded-full bg-sky-500\" />\n                        <label htmlFor=\"sessionTtlCustomer\" className=\"text-sm font-semibold text-slate-900\">Customer</label>\n                      </div>\n                    </div>\n                    <input\n                      id=\"sessionTtlCustomer\"\n                      type=\"number\"\n                      min={5}\n                      placeholder=\"(default)\"\n                      className={`${inputClass} mt-3 bg-white/70 shadow-none`}\n                      value={(s?.sessionMaxMinutesCustomer ?? '') as any}\n                      onChange={e=>setS(prev=>({...(prev||{}), sessionMaxMinutesCustomer: e.target.value === '' ? null : Number(e.target.value)}))}\n                    />\n                  </div>\n                </div>\n\n                <div className=\"mt-4 rounded-2xl border border-slate-200/70 bg-slate-50/60 p-4 text-xs text-slate-600\">\n                  Reducing a role TTL forces re-login on the next request.\n                </div>\n              </div>\n\n              <div className=\"rounded-2xl border border-slate-200/70 bg-white/60 p-4\">\n                <div className=\"flex items-center gap-2 mb-4\">\n                  <Clock className=\"h-5 w-5 text-blue-600\" />\n                  <div>\n                    <div className=\"text-sm font-medium text-slate-900\">Max session duration (hours)</div>\n                    <div className={helpClass}>Maximum session lifetime before requiring re-authentication</div>\n                  </div>\n                </div>\n                <input\n                  id=\"maxSessionDurationHours\"\n                  type=\"number\"\n                  min={1}\n                  max={720}\n                  className={`${inputClass} ${validationErrors.maxSessionDurationHours ? 'border-red-300 focus:border-red-500' : ''}`}\n                  value={(s?.maxSessionDurationHours ?? 24) as any}\n                  onChange={e=>setS(prev=>({...(prev||{}), maxSessionDurationHours: Number(e.target.value)}))}\n                  aria-label=\"Max session duration hours\"\n                />\n                {validationErrors.maxSessionDurationHours && (\n                  <p className=\"mt-1 text-xs text-red-600\">{validationErrors.maxSessionDurationHours}</p>\n                )}\n              </div>\n\n              <div className={rowClass}>\n                <div className=\"min-w-0\">\n                  <div className=\"text-sm font-medium text-slate-900\">Force logout on password change</div>\n                  <div className={helpClass}>Automatically logout all sessions when password is changed</div>\n                </div>\n                <label className=\"group relative inline-flex cursor-pointer items-center\">\n                  <input\n                    type=\"checkbox\"\n                    aria-label=\"Force logout on password change\"\n                    checked={Boolean(s?.forceLogoutOnPasswordChange ?? true)}\n                    className=\"peer sr-only\"\n                    onChange={e=>setS(prev=>({...(prev||{}), forceLogoutOnPasswordChange: e.target.checked}))}\n                  />\n                  <div className={toggleTrackClass}>\n                    <Lock className=\"absolute left-[6px] top-1/2 h-3 w-3 -translate-y-1/2 text-white opacity-0 transition-opacity duration-200 group-has-[:checked]:opacity-100 pointer-events-none\" />\n                  </div>\n                </label>\n              </div>\n            </div>\n          </section>\n\n          {/* Password Requirements */}\n          <section className={cardClass}>\n            <div className=\"flex items-center gap-3 mb-5\">\n              <div className=\"h-10 w-10 rounded-lg bg-[#02665e]/10 flex items-center justify-center\">\n                <Lock className=\"h-5 w-5 text-[#02665e]\" />\n              </div>\n              <div>\n                <h3 className={cardTitleClass}>Password Requirements</h3>\n                <p className={cardHintClass}>Configure password complexity and security policies</p>\n              </div>\n            </div>\n\n            <div className=\"grid md:grid-cols-2 gap-4\">\n              <div className=\"rounded-xl border border-slate-200/70 bg-white/60 p-4\">\n                <label htmlFor=\"minPasswordLength\" className={labelClass}>Minimum password length</label>\n                <input\n                  id=\"minPasswordLength\"\n                  type=\"number\"\n                  min={6}\n                  max={128}\n                  className={`${inputClass} mt-2 ${validationErrors.minPasswordLength ? 'border-red-300 focus:border-red-500' : ''}`}\n                  value={(s?.minPasswordLength ?? 10) as any}\n                  onChange={e=>setS(prev=>({...(prev||{}), minPasswordLength: Number(e.target.value)}))}\n                />\n                {validationErrors.minPasswordLength && (\n                  <p className=\"mt-1 text-xs text-red-600\">{validationErrors.minPasswordLength}</p>\n                )}\n                <p className={helpClass}>Minimum number of characters required for passwords</p>\n              </div>\n            </div>\n\n            <div className=\"mt-4 grid md:grid-cols-2 gap-4\">\n              <div className={rowClass}>\n                <div className=\"min-w-0\">\n                  <div className=\"text-sm font-medium text-slate-900\">Require uppercase letters</div>\n                  <div className={helpClass}>Passwords must contain at least one uppercase letter</div>\n                </div>\n                <label className=\"group relative inline-flex cursor-pointer items-center\">\n                  <input\n                    type=\"checkbox\"\n                    aria-label=\"Require uppercase letters in password\"\n                    checked={Boolean(s?.requirePasswordUppercase ?? false)}\n                    className=\"peer sr-only\"\n                    onChange={e=>setS(prev=>({...(prev||{}), requirePasswordUppercase: e.target.checked}))}\n                  />\n                  <div className={toggleTrackClass}>\n                    <Lock className=\"absolute left-[6px] top-1/2 h-3 w-3 -translate-y-1/2 text-white opacity-0 transition-opacity duration-200 group-has-[:checked]:opacity-100 pointer-events-none\" />\n                  </div>\n                </label>\n              </div>\n\n              <div className={rowClass}>\n                <div className=\"min-w-0\">\n                  <div className=\"text-sm font-medium text-slate-900\">Require lowercase letters</div>\n                  <div className={helpClass}>Passwords must contain at least one lowercase letter</div>\n                </div>\n                <label className=\"group relative inline-flex cursor-pointer items-center\">\n                  <input\n                    type=\"checkbox\"\n                    aria-label=\"Require lowercase letters in password\"\n                    checked={Boolean(s?.requirePasswordLowercase ?? false)}\n                    className=\"peer sr-only\"\n                    onChange={e=>setS(prev=>({...(prev||{}), requirePasswordLowercase: e.target.checked}))}\n                  />\n                  <div className={toggleTrackClass}>\n                    <Lock className=\"absolute left-[6px] top-1/2 h-3 w-3 -translate-y-1/2 text-white opacity-0 transition-opacity duration-200 group-has-[:checked]:opacity-100 pointer-events-none\" />\n                  </div>\n                </label>\n              </div>\n\n              <div className={rowClass}>\n                <div className=\"min-w-0\">\n                  <div className=\"text-sm font-medium text-slate-900\">Require numbers</div>\n                  <div className={helpClass}>Passwords must contain at least one number</div>\n                </div>\n                <label className=\"group relative inline-flex cursor-pointer items-center\">\n                  <input\n                    type=\"checkbox\"\n                    aria-label=\"Require numbers in password\"\n                    checked={Boolean(s?.requirePasswordNumber ?? false)}\n                    className=\"peer sr-only\"\n                    onChange={e=>setS(prev=>({...(prev||{}), requirePasswordNumber: e.target.checked}))}\n                  />\n                  <div className={toggleTrackClass}>\n                    <Lock className=\"absolute left-[6px] top-1/2 h-3 w-3 -translate-y-1/2 text-white opacity-0 transition-opacity duration-200 group-has-[:checked]:opacity-100 pointer-events-none\" />\n                  </div>\n                </label>\n              </div>\n\n              <div className={rowClass}>\n                <div className=\"min-w-0\">\n                  <div className=\"text-sm font-medium text-slate-900\">Require special characters</div>\n                  <div className={helpClass}>Passwords must contain at least one special character (!@#$%^&*)</div>\n                </div>\n                <label className=\"group relative inline-flex cursor-pointer items-center\">\n                  <input\n                    type=\"checkbox\"\n                    aria-label=\"Require special characters in password\"\n                    checked={Boolean(s?.requirePasswordSpecial ?? false)}\n                    className=\"peer sr-only\"\n                    onChange={e=>setS(prev=>({...(prev||{}), requirePasswordSpecial: e.target.checked}))}\n                  />\n                  <div className={toggleTrackClass}>\n                    <Lock className=\"absolute left-[6px] top-1/2 h-3 w-3 -translate-y-1/2 text-white opacity-0 transition-opacity duration-200 group-has-[:checked]:opacity-100 pointer-events-none\" />\n                  </div>\n                </label>\n              </div>\n            </div>\n          </section>\n\n          {/* Network Security */}\n          <section className={cardClass}>\n            <div className=\"flex items-center gap-3 mb-5\">\n              <div className=\"h-10 w-10 rounded-lg bg-orange-50 flex items-center justify-center\">\n                <Network className=\"h-5 w-5 text-orange-600\" />\n              </div>\n              <div>\n                <h3 className={cardTitleClass}>Network Security</h3>\n                <p className={cardHintClass}>Restrict admin access by IP address and configure network policies</p>\n              </div>\n            </div>\n\n            <div className=\"space-y-4\">\n              <div>\n                <label htmlFor=\"ipAllowlist\" className={labelClass}>Admin IP Allowlist (CIDR format)</label>\n                <textarea\n                  id=\"ipAllowlist\"\n                  className={`${inputClass} mt-2 font-mono text-xs ${validationErrors.ipAllowlist ? 'border-red-300 focus:border-red-500' : ''}`}\n                  value={s?.ipAllowlist || ''}\n                  onChange={e=>setS(prev=>({...(prev||{}), ipAllowlist: e.target.value}))}\n                  onBlur={(e) => {\n                    const error = validateIPAllowlist(e.target.value);\n                    if (!error.valid && error.error) {\n                      setValidationErrors(prev => ({ ...prev, ipAllowlist: error.error || 'Invalid IP allowlist format' }));\n                    } else {\n                      setValidationErrors(prev => {\n                        const newErrors = { ...prev };\n                        delete newErrors.ipAllowlist;\n                        return newErrors;\n                      });\n                    }\n                  }}\n                  placeholder=\"192.168.1.0/24, 10.0.0.0/8, 172.16.0.0/12\"\n                  rows={4}\n                />\n                {validationErrors.ipAllowlist && (\n                  <p className=\"mt-1 text-xs text-red-600\">{validationErrors.ipAllowlist}</p>\n                )}\n                <p className={helpClass}>\n                  Enter IP addresses or CIDR ranges separated by commas. Leave empty to allow all IPs.\n                  <br />\n                  <span className=\"font-semibold\">Example:</span> 192.168.1.0/24, 10.0.0.0/8\n                </p>\n              </div>\n\n              <div className={rowClass}>\n                <div className=\"min-w-0\">\n                  <div className=\"text-sm font-medium text-slate-900\">Enable IP allowlist enforcement</div>\n                  <div className={helpClass}>Enable IP allowlist to restrict admin access (requires IP allowlist to be configured)</div>\n                </div>\n                <label className=\"group relative inline-flex cursor-pointer items-center\">\n                  <input\n                    type=\"checkbox\"\n                    aria-label=\"Enable IP allowlist enforcement\"\n                    checked={Boolean(s?.enableIpAllowlist ?? false)}\n                    className=\"peer sr-only\"\n                    onChange={e=>setS(prev=>({...(prev||{}), enableIpAllowlist: e.target.checked}))}\n                  />\n                  <div className={toggleTrackClass}>\n                    <Lock className=\"absolute left-[6px] top-1/2 h-3 w-3 -translate-y-1/2 text-white opacity-0 transition-opacity duration-200 group-has-[:checked]:opacity-100 pointer-events-none\" />\n                  </div>\n                </label>\n              </div>\n            </div>\n          </section>\n\n          {/* Rate Limiting & DDoS Protection */}\n          <section className={cardClass}>\n            <div className=\"flex items-center gap-3 mb-5\">\n              <div className=\"h-10 w-10 rounded-lg bg-red-50 flex items-center justify-center\">\n                <Shield className=\"h-5 w-5 text-red-600\" />\n              </div>\n              <div>\n                <h3 className={cardTitleClass}>Rate Limiting & DDoS Protection</h3>\n                <p className={cardHintClass}>Configure API rate limits and protection against abuse</p>\n              </div>\n            </div>\n\n            <div className=\"grid md:grid-cols-2 gap-4\">\n              <div className=\"rounded-xl border border-slate-200/70 bg-white/60 p-4\">\n                <label htmlFor=\"apiRateLimitPerMinute\" className={labelClass}>API requests per minute</label>\n                <input\n                  id=\"apiRateLimitPerMinute\"\n                  type=\"number\"\n                  min={10}\n                  max={10000}\n                  className={`${inputClass} mt-2 ${validationErrors.apiRateLimitPerMinute ? 'border-red-300 focus:border-red-500' : ''}`}\n                  value={(s?.apiRateLimitPerMinute ?? 100) as any}\n                  onChange={e=>setS(prev=>({...(prev||{}), apiRateLimitPerMinute: Number(e.target.value)}))}\n                />\n                {validationErrors.apiRateLimitPerMinute && (\n                  <p className=\"mt-1 text-xs text-red-600\">{validationErrors.apiRateLimitPerMinute}</p>\n                )}\n                <p className={helpClass}>Maximum API requests allowed per minute per IP</p>\n              </div>\n\n              <div className=\"rounded-xl border border-slate-200/70 bg-white/60 p-4\">\n                <label htmlFor=\"maxLoginAttempts\" className={labelClass}>Login attempts before lockout</label>\n                <input\n                  id=\"maxLoginAttempts\"\n                  type=\"number\"\n                  min={3}\n                  max={20}\n                  className={`${inputClass} mt-2 ${validationErrors.maxLoginAttempts ? 'border-red-300 focus:border-red-500' : ''}`}\n                  value={(s?.maxLoginAttempts ?? 5) as any}\n                  onChange={e=>setS(prev=>({...(prev||{}), maxLoginAttempts: Number(e.target.value)}))}\n                />\n                {validationErrors.maxLoginAttempts && (\n                  <p className=\"mt-1 text-xs text-red-600\">{validationErrors.maxLoginAttempts}</p>\n                )}\n                <p className={helpClass}>Number of failed login attempts before account lockout</p>\n              </div>\n\n              <div className=\"rounded-xl border border-slate-200/70 bg-white/60 p-4\">\n                <label htmlFor=\"accountLockoutDurationMinutes\" className={labelClass}>Account lockout duration (minutes)</label>\n                <input\n                  id=\"accountLockoutDurationMinutes\"\n                  type=\"number\"\n                  min={5}\n                  max={1440}\n                  className={`${inputClass} mt-2 ${validationErrors.accountLockoutDurationMinutes ? 'border-red-300 focus:border-red-500' : ''}`}\n                  value={(s?.accountLockoutDurationMinutes ?? 30) as any}\n                  onChange={e=>setS(prev=>({...(prev||{}), accountLockoutDurationMinutes: Number(e.target.value)}))}\n                />\n                {validationErrors.accountLockoutDurationMinutes && (\n                  <p className=\"mt-1 text-xs text-red-600\">{validationErrors.accountLockoutDurationMinutes}</p>\n                )}\n                <p className={helpClass}>Duration of account lockout after max login attempts</p>\n              </div>\n            </div>\n          </section>\n\n          {/* Security Audit & Monitoring */}\n          <section className={cardClass}>\n            <div className=\"flex items-center gap-3 mb-5\">\n              <div className=\"h-10 w-10 rounded-lg bg-purple-50 flex items-center justify-center\">\n                <AlertTriangle className=\"h-5 w-5 text-purple-600\" />\n              </div>\n              <div>\n                <h3 className={cardTitleClass}>Security Audit & Monitoring</h3>\n                <p className={cardHintClass}>Configure security auditing and monitoring policies</p>\n              </div>\n            </div>\n\n            <div className=\"grid md:grid-cols-2 gap-4\">\n              <div className={rowClass}>\n                <div className=\"min-w-0\">\n                  <div className=\"text-sm font-medium text-slate-900\">Enable security audit logging</div>\n                  <div className={helpClass}>Log all security-related events and admin actions</div>\n                </div>\n                <label className=\"group relative inline-flex cursor-pointer items-center\">\n                  <input\n                    type=\"checkbox\"\n                    aria-label=\"Enable security audit logging\"\n                    checked={Boolean(s?.enableSecurityAuditLogging ?? true)}\n                    className=\"peer sr-only\"\n                    onChange={e=>setS(prev=>({...(prev||{}), enableSecurityAuditLogging: e.target.checked}))}\n                  />\n                  <div className={toggleTrackClass}>\n                    <Lock className=\"absolute left-[6px] top-1/2 h-3 w-3 -translate-y-1/2 text-white opacity-0 transition-opacity duration-200 group-has-[:checked]:opacity-100 pointer-events-none\" />\n                  </div>\n                </label>\n              </div>\n\n              <div className={rowClass}>\n                <div className=\"min-w-0\">\n                  <div className=\"text-sm font-medium text-slate-900\">Log failed login attempts</div>\n                  <div className={helpClass}>Record all failed login attempts for security analysis</div>\n                </div>\n                <label className=\"group relative inline-flex cursor-pointer items-center\">\n                  <input\n                    type=\"checkbox\"\n                    aria-label=\"Log failed login attempts\"\n                    checked={Boolean(s?.logFailedLoginAttempts ?? true)}\n                    className=\"peer sr-only\"\n                    onChange={e=>setS(prev=>({...(prev||{}), logFailedLoginAttempts: e.target.checked}))}\n                  />\n                  <div className={toggleTrackClass}>\n                    <Lock className=\"absolute left-[6px] top-1/2 h-3 w-3 -translate-y-1/2 text-white opacity-0 transition-opacity duration-200 group-has-[:checked]:opacity-100 pointer-events-none\" />\n                  </div>\n                </label>\n              </div>\n\n              <div className={rowClass}>\n                <div className=\"min-w-0\">\n                  <div className=\"text-sm font-medium text-slate-900\">Alert on suspicious activity</div>\n                  <div className={helpClass}>Send alerts when suspicious security events are detected</div>\n                </div>\n                <label className=\"group relative inline-flex cursor-pointer items-center\">\n                  <input\n                    type=\"checkbox\"\n                    aria-label=\"Alert on suspicious activity\"\n                    checked={Boolean(s?.alertOnSuspiciousActivity ?? false)}\n                    className=\"peer sr-only\"\n                    onChange={e=>setS(prev=>({...(prev||{}), alertOnSuspiciousActivity: e.target.checked}))}\n                  />\n                  <div className={toggleTrackClass}>\n                    <Lock className=\"absolute left-[6px] top-1/2 h-3 w-3 -translate-y-1/2 text-white opacity-0 transition-opacity duration-200 group-has-[:checked]:opacity-100 pointer-events-none\" />\n                  </div>\n                </label>\n              </div>\n            </div>\n          </section>\n\n          {/* Security Best Practices */}\n          <section className={cardClass}>\n            <div className=\"bg-amber-50/60 border-2 border-amber-200/70 rounded-2xl p-6\">\n              <div className=\"flex items-start gap-4\">\n                <AlertTriangle className=\"h-6 w-6 text-amber-600 flex-shrink-0 mt-0.5\" />\n                <div className=\"flex-1\">\n                  <h4 className=\"font-bold text-amber-900 mb-2 text-lg\">Security Best Practices</h4>\n                  <ul className=\"text-sm text-amber-800 space-y-2 list-disc list-inside\">\n                    <li><strong>2FA:</strong> Always require 2FA for admin accounts in production environments</li>\n                    <li><strong>Password Policy:</strong> Use strong password policies (minimum 12 characters with mixed case, numbers, and special characters recommended)</li>\n                    <li><strong>IP Allowlist:</strong> Configure IP allowlist to restrict admin access to trusted networks only</li>\n                    <li><strong>Session Management:</strong> Set appropriate session timeout based on your security requirements (shorter for high-security environments)</li>\n                    <li><strong>Rate Limiting:</strong> Enable rate limiting to protect against brute force attacks and DDoS</li>\n                    <li><strong>Audit Logging:</strong> Keep security audit logging enabled to track all security events</li>\n                  </ul>\n                </div>\n              </div>\n            </div>\n          </section>\n\n          {/* Audit */}\n          <section className={cardClass}>\n            <div className=\"flex items-start justify-between gap-3\">\n              <div>\n                <h3 className={cardTitleClass}>Session Policy Audit</h3>\n                <p className={cardHintClass}>Last 10 updates (ADMIN_SESSION_POLICY_UPDATE).</p>\n              </div>\n            </div>\n\n            <div className=\"mt-4 space-y-2\">\n              {sessionPolicyAudit.length === 0 ? (\n                <div className=\"rounded-2xl border border-slate-200/70 bg-white/60 p-4 text-sm text-slate-600\">No recent entries.</div>\n              ) : (\n                sessionPolicyAudit.map((row) => (\n                  <div key={row.id} className=\"rounded-2xl border border-slate-200/70 bg-white/60 p-4 shadow-sm transition-shadow duration-200 hover:shadow-md\">\n                    <div className=\"flex flex-wrap items-center gap-x-2 gap-y-1 text-xs text-slate-600\">\n                      <span className=\"font-medium text-slate-900\">{new Date(row.createdAt).toLocaleString()}</span>\n                      <span>•</span>\n                      <span className=\"min-w-0 truncate\">\n                        {(row.actor?.name || row.actor?.email || row.actorRole || 'Admin')}\n                        {row.actorId ? ` (#${row.actorId})` : ''}\n                      </span>\n                      {row.ip ? (\n                        <>\n                          <span>•</span>\n                          <span className=\"text-slate-500\">IP {row.ip}</span>\n                        </>\n                      ) : null}\n                    </div>\n                    <pre className=\"mt-2 max-w-full overflow-x-hidden whitespace-pre-wrap break-words rounded-xl bg-slate-50/70 p-3 text-[11px] text-slate-700 ring-1 ring-slate-200/60\">{renderAuditChanges(row.changes)}</pre>\n                  </div>\n                ))\n              )}\n            </div>\n          </section>\n\n          {/* Tax & Invoicing */}\n          <section className={cardClass}>\n            <div>\n              <h3 className={cardTitleClass}>Tax & Invoicing</h3>\n              <p className={cardHintClass}>Numbering, tax rate, and invoice template preview.</p>\n            </div>\n            <div className=\"mt-5 grid grid-cols-1 items-stretch gap-4 sm:grid-cols-2\">\n              <div className=\"flex h-full min-w-0 flex-col overflow-visible rounded-xl border border-slate-200/70 bg-white/60 p-4 shadow-sm\">\n                <label htmlFor=\"taxRate\" className={labelClass}>Tax Rate (%)</label>\n                <input\n                  id=\"taxRate\"\n                  type=\"number\"\n                  min={0}\n                  step=\"0.01\"\n                  className={`${inputClass} mt-2`}\n                  value={s?.taxPercent ?? 0}\n                  onChange={e=>setS(prev=>({...(prev||{}), taxPercent: Number(e.target.value)}))}\n                />\n              </div>\n              <div className=\"flex h-full min-w-0 flex-col overflow-visible rounded-xl border border-slate-200/70 bg-white/60 p-4 shadow-sm\">\n                <label htmlFor=\"invoicePrefix\" className={labelClass}>Invoice Prefix</label>\n                <input\n                  id=\"invoicePrefix\"\n                  className={`${inputClass} mt-2`}\n                  value={s?.invoicePrefix || 'INV-'}\n                  onChange={e=>setS(prev=>({...(prev||{}), invoicePrefix: e.target.value}))}\n                />\n              </div>\n            </div>\n\n            <div className=\"mt-4 flex min-w-0 flex-col overflow-visible rounded-xl border border-slate-200/70 bg-white/60 p-4 shadow-sm\">\n              <label htmlFor=\"invoiceTemplate\" className={labelClass}>Invoice Template (HTML)</label>\n              <textarea\n                id=\"invoiceTemplate\"\n                className={`${inputClass} mt-2 h-28 font-mono text-[12px]`}\n                value={invoiceTemplate}\n                onChange={e=>setInvoiceTemplate(e.target.value)}\n                placeholder=\"<h1>Invoice {{invoiceNumber}}</h1>\"\n              />\n            </div>\n\n            <div className=\"mt-4 flex flex-wrap gap-2\">\n              <button onClick={saveInvoicingSettings} className={btnPrimary} type=\"button\">Save</button>\n              <button onClick={previewInvoice} className={btnSecondary} type=\"button\">Preview</button>\n            </div>\n            <div\n              id=\"invoicePreviewArea\"\n              className=\"mt-4 max-h-64 max-w-full overflow-x-hidden overflow-y-auto rounded-2xl border border-slate-200/70 bg-white/60 p-4 text-sm text-slate-700 shadow-sm [&_*]:max-w-full [&_img]:h-auto [&_img]:max-w-full [&_pre]:whitespace-pre-wrap [&_code]:break-words [&_p]:break-words [&_span]:break-words [&_a]:break-words [&_table]:block [&_table]:w-full [&_table]:max-w-full [&_table]:table-fixed [&_th]:break-words [&_td]:break-words\"\n              dangerouslySetInnerHTML={{__html: invoicePreviewHtml || ''}}\n            />\n          </section>\n\n          {/* Scheduling */}\n          <section className={cardClass}>\n            <div className=\"flex items-start justify-between gap-3\">\n              <div>\n                <h3 className={cardTitleClass}>Scheduling</h3>\n                <p className={cardHintClass}>Operational automation (cron policy backend pending).</p>\n              </div>\n              <span className=\"inline-flex items-center rounded-full border border-amber-200/70 bg-amber-50 px-2.5 py-1 text-xs font-medium text-amber-700\">Coming soon</span>\n            </div>\n\n            <div className=\"mt-5 flex min-w-0 flex-col overflow-visible rounded-xl border border-slate-200/70 bg-white/60 p-4 shadow-sm\">\n              <label htmlFor=\"payoutCron\" className={labelClass}>Cron Expression</label>\n              <input\n                id=\"payoutCron\"\n                className={`${inputClass} mt-2 min-w-0`}\n                placeholder=\"e.g. 0 2 1 * *\"\n                value={payoutCron}\n                onChange={e=>setPayoutCron(e.target.value)}\n              />\n              <p className={helpClass}>Default: 02:00 on the 1st of each month.</p>\n              <div className=\"mt-4 flex flex-wrap gap-2\">\n                <button onClick={updatePayoutCron} className={btnSecondary} type=\"button\">Save (pending)</button>\n                <button onClick={()=>alert('Preview not implemented')} className={btnSecondary} type=\"button\">Run Preview</button>\n                <button onClick={()=>alert('Execute not implemented')} className={btnSecondary} type=\"button\">Execute Now</button>\n              </div>\n              <pre\n                id=\"payoutCronResult\"\n                className=\"mt-4 max-h-48 max-w-full overflow-x-hidden overflow-y-auto whitespace-pre-wrap break-words rounded-xl border border-slate-200/70 bg-white/60 p-4 text-[12px] text-slate-700\"\n              />\n            </div>\n          </section>\n\n          {/* Bonuses */}\n          <section className={cardClass}>\n            <div className=\"flex items-start justify-between gap-3\">\n              <div>\n                <h3 className={cardTitleClass}>Bonuses</h3>\n                <p className={cardHintClass}>Manual owner bonus preview/grant (recorded via admin audit).</p>\n              </div>\n            </div>\n\n            <div className=\"mt-5 rounded-2xl border border-slate-200/70 bg-white/60 p-4 shadow-sm\">\n              <div className=\"flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between\">\n                <div className=\"min-w-0\">\n                  <div className=\"text-sm font-semibold text-slate-900\">Grant owner bonus</div>\n                  <p className=\"mt-1 text-xs text-slate-600\">Preview uses owner paid invoices (last 30 days). Grant writes an audit entry.</p>\n                </div>\n                <div className=\"flex shrink-0 gap-2\">\n                  <button\n                    onClick={previewBonus}\n                    className={btnSecondary}\n                    type=\"button\"\n                    disabled={!bonusOwnerId || !Number.isFinite(Number(bonusOwnerId)) || Number(bonusOwnerId) <= 0}\n                  >\n                    Preview\n                  </button>\n                  <button\n                    onClick={grantBonus}\n                    className={btnPrimary}\n                    type=\"button\"\n                    disabled={!bonusOwnerId || !Number.isFinite(Number(bonusOwnerId)) || Number(bonusOwnerId) <= 0}\n                  >\n                    Grant\n                  </button>\n                </div>\n              </div>\n\n              <div className=\"mt-4 grid grid-cols-1 items-stretch gap-4 border-t border-slate-200/70 pt-4 md:grid-cols-2\">\n                <div className=\"flex h-full min-w-0 flex-col rounded-xl border border-slate-200/70 bg-white/70 p-4 shadow-sm\">\n                  <label htmlFor=\"bonusOwnerId\" className={labelClass}>Owner ID</label>\n                  <div className=\"mt-2 flex w-full min-w-0 overflow-hidden rounded-lg border border-slate-200/70 bg-white/70 shadow-sm transition-all duration-200 focus-within:border-[#02665e] focus-within:ring-2 focus-within:ring-inset focus-within:ring-[#02665e]/18\">\n                    <input\n                      id=\"bonusOwnerId\"\n                      className=\"min-w-0 flex-1 border-0 bg-transparent px-3 py-2 text-sm text-slate-900 outline-none placeholder:text-slate-400\"\n                      value={bonusOwnerId}\n                      onChange={e=>setBonusOwnerId(String(e.target.value || '').replace(/\\D+/g, ''))}\n                      placeholder=\"e.g. 13\"\n                      inputMode=\"numeric\"\n                    />\n                    <div className=\"flex shrink-0 items-center border-l border-slate-200/70 bg-white/50 px-3 text-xs font-semibold text-slate-600\">#</div>\n                  </div>\n                  {!bonusOwnerId ? (\n                    <p className={`${helpClass} min-h-4`}>Paste an Owner ID to auto-load the owner.</p>\n                  ) : !Number.isFinite(Number(bonusOwnerId)) || Number(bonusOwnerId) <= 0 ? (\n                    <p className=\"mt-1 min-h-4 text-xs font-medium text-rose-600\">Enter a valid numeric owner ID.</p>\n                  ) : bonusOwnerLookupLoading ? (\n                    <p className={`${helpClass} min-h-4`}>Looking up owner…</p>\n                  ) : bonusOwnerLookupError ? (\n                    <p className=\"mt-1 min-h-4 text-xs font-medium text-rose-600\">{bonusOwnerLookupError}</p>\n                  ) : bonusOwnerLookup ? (\n                    <p className={`${helpClass} min-h-4`}>Owner: <span className=\"font-semibold text-slate-700\">{bonusOwnerLookup.name || `#${bonusOwnerLookup.id}`}</span>{bonusOwnerLookup.email ? <span className=\"text-slate-400\"> · {bonusOwnerLookup.email}</span> : null}</p>\n                  ) : (\n                    <p className={`${helpClass} min-h-4`}>Owner receiving the bonus.</p>\n                  )}\n                </div>\n\n                <div className=\"flex h-full min-w-0 flex-col rounded-xl border border-slate-200/70 bg-white/70 p-4 shadow-sm\">\n                  <label htmlFor=\"bonusPercentInput\" className={labelClass}>Bonus (%)</label>\n                  <div className=\"mt-2 flex w-full min-w-0 overflow-hidden rounded-lg border border-slate-200/70 bg-white/70 shadow-sm transition-all duration-200 focus-within:border-[#02665e] focus-within:ring-2 focus-within:ring-inset focus-within:ring-[#02665e]/18\">\n                    <input\n                      id=\"bonusPercentInput\"\n                      type=\"number\"\n                      min={0}\n                      step=\"0.01\"\n                      inputMode=\"decimal\"\n                      className=\"min-w-0 flex-1 border-0 bg-transparent px-3 py-2 text-sm text-slate-900 outline-none placeholder:text-slate-400\"\n                      value={bonusPercentInput}\n                      onChange={e=>setBonusPercentInput(Number(e.target.value))}\n                      placeholder=\"e.g. 5\"\n                    />\n                    <div className=\"flex shrink-0 items-center border-l border-slate-200/70 bg-white/50 px-3 text-xs font-semibold text-slate-600\">%</div>\n                  </div>\n                  <p className={`${helpClass} min-h-4`}>Percent applied to eligible revenue for the preview window.</p>\n                </div>\n              </div>\n\n              {bonusPreview && (\n                <div className=\"mt-4 rounded-2xl border border-slate-200/70 bg-white/70 p-4\">\n                  <div className=\"flex flex-col gap-2 sm:flex-row sm:items-start sm:justify-between\">\n                    <div className=\"min-w-0\">\n                      <div className=\"text-sm font-semibold text-slate-900\">Preview result</div>\n                      <p className=\"mt-1 text-xs text-slate-600\">Review computed values before granting.</p>\n                    </div>\n                    <span className=\"inline-flex w-fit items-center rounded-full border border-slate-200/70 bg-white/70 px-2.5 py-1 text-xs font-semibold text-slate-700\">\n                      {(bonusPreview as any)?.ok === true ? 'OK' : 'Result'}\n                    </span>\n                  </div>\n\n                  {(bonusPreview as any)?.data && (\n                    <div className=\"mt-4 grid grid-cols-1 gap-3 sm:grid-cols-2\">\n                      <div className=\"rounded-xl border border-slate-200/70 bg-white/60 p-3\">\n                        <div className=\"text-xs font-medium text-slate-500\">Owner</div>\n                        <div className=\"mt-1 text-sm font-semibold text-slate-900\">#{String((bonusPreview as any).data.ownerId ?? bonusOwnerId)}</div>\n                      </div>\n                      <div className=\"rounded-xl border border-slate-200/70 bg-white/60 p-3\">\n                        <div className=\"text-xs font-medium text-slate-500\">Bonus</div>\n                        <div className=\"mt-1 text-sm font-semibold text-slate-900\">{formatPercent((bonusPreview as any).data.bonusPercent ?? bonusPercentInput)}</div>\n                      </div>\n                      <div className=\"rounded-xl border border-slate-200/70 bg-white/60 p-3\">\n                        <div className=\"text-xs font-medium text-slate-500\">Eligible revenue</div>\n                        <div className=\"mt-1 text-sm font-semibold text-slate-900\">{formatMoney((bonusPreview as any).data.totalRevenue)}</div>\n                      </div>\n                      <div className=\"rounded-xl border border-slate-200/70 bg-white/60 p-3\">\n                        <div className=\"text-xs font-medium text-slate-500\">Bonus amount</div>\n                        <div className=\"mt-1 text-sm font-semibold text-slate-900\">{formatMoney((bonusPreview as any).data.bonusAmount)}</div>\n                      </div>\n\n                      <div className=\"rounded-xl border border-slate-200/70 bg-white/60 p-3\">\n                        <div className=\"text-xs font-medium text-slate-500\">Commission</div>\n                        <div className=\"mt-1 flex items-baseline justify-between gap-3\">\n                          <div className=\"text-sm font-semibold text-slate-900\">{formatPercent((bonusPreview as any).data.commissionPercent)}</div>\n                          <div className=\"text-xs font-semibold text-slate-700\">{formatMoney((bonusPreview as any).data.commissionAmount)}</div>\n                        </div>\n                      </div>\n\n                      <div className=\"rounded-xl border border-slate-200/70 bg-white/60 p-3\">\n                        <div className=\"text-xs font-medium text-slate-500\">Reference</div>\n                        <div className=\"mt-1 truncate font-mono text-xs font-semibold text-slate-800\">{String((bonusPreview as any).data.bonusPaymentRef ?? '—')}</div>\n                      </div>\n                    </div>\n                  )}\n\n                  <details className=\"mt-4 rounded-xl border border-slate-200/70 bg-white/60 p-3\">\n                    <summary className=\"cursor-pointer select-none text-xs font-semibold text-slate-700\">Raw response</summary>\n                    <pre className=\"mt-3 max-h-64 max-w-full overflow-x-hidden overflow-y-auto whitespace-pre-wrap break-words rounded-xl border border-slate-200/70 bg-white/70 p-4 text-[12px] text-slate-700\">{JSON.stringify(bonusPreview, null, 2)}</pre>\n                  </details>\n                </div>\n              )}\n            </div>\n          </section>\n        </div>\n\n          <div className=\"sticky bottom-4 mt-8 flex items-center justify-end\">\n            <div className=\"rounded-2xl border border-slate-200/70 bg-white/80 p-2 shadow-lg ring-1 ring-black/[0.03] backdrop-blur\">\n              <button\n                onClick={saveSystemSettings}\n                disabled={loading}\n                className={btnPrimary}\n                type=\"button\"\n              >\n                <Settings className=\"h-4 w-4\" />\n                Save Settings\n              </button>\n            </div>\n          </div>\n      </div>\n    </motion.div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\management\\trust-partners\\page.tsx","messages":[],"suppressedMessages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":362,"column":33,"nodeType":"JSXOpeningElement","endLine":372,"endColumn":35,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":383,"column":33,"nodeType":"JSXOpeningElement","endLine":393,"endColumn":35,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":571,"column":33,"nodeType":"JSXOpeningElement","endLine":582,"endColumn":35,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\management\\updates\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\management\\users\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\messages\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\metrics-docs\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\owners\\[id]\\page.tsx","messages":[],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'loadProperties', 'properties.length', and 'propertiesLoading'. Either include them or remove the dependency array.","line":205,"column":6,"nodeType":"ArrayExpression","endLine":205,"endColumn":11,"suggestions":[{"desc":"Update the dependencies array to be: [loadProperties, properties.length, propertiesLoading, tab]","fix":{"range":[7552,7557],"text":"[loadProperties, properties.length, propertiesLoading, tab]"}}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadBookings'. Either include it or remove the dependency array.","line":213,"column":6,"nodeType":"ArrayExpression","endLine":213,"endColumn":90,"suggestions":[{"desc":"Update the dependencies array to be: [tab, bookingsPage, bookingsStatus, bookingsSearch, bookingsSortBy, bookingsSortDir, loadBookings]","fix":{"range":[7751,7835],"text":"[tab, bookingsPage, bookingsStatus, bookingsSearch, bookingsSortBy, bookingsSortDir, loadBookings]"}}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'load', 'loadAuditHistory', and 'loadDocs'. Either include them or remove the dependency array.","line":234,"column":5,"nodeType":"ArrayExpression","endLine":234,"endColumn":14,"suggestions":[{"desc":"Update the dependencies array to be: [load, loadAuditHistory, loadDocs, ownerId]","fix":{"range":[8767,8776],"text":"[load, loadAuditHistory, loadDocs, ownerId]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\owners\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\payments\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\plan-with-us\\dashboard\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'XCircle' is defined but never used. Allowed unused vars must match /^_/u.","line":3,"column":55,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":62,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"XCircle"},"fix":{"range":[122,131],"text":""},"desc":"Remove unused variable \"XCircle\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Calendar' is defined but never used. Allowed unused vars must match /^_/u.","line":3,"column":73,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":81,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Calendar"},"fix":{"range":[140,150],"text":""},"desc":"Remove unused variable \"Calendar\"."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\nimport { useEffect, useState, useMemo } from \"react\";\r\nimport { ClipboardList, FileText, Clock, CheckCircle, XCircle, Loader2, Calendar, Users, TrendingUp, MapPin, AlertTriangle } from \"lucide-react\";\r\nimport Link from \"next/link\";\r\nimport axios from \"axios\";\r\nimport Chart from \"@/components/Chart\";\r\nimport type { ChartData } from \"chart.js\";\r\n\r\n// Use same-origin for HTTP calls so Next.js rewrites proxy to the API\r\nconst api = axios.create({ baseURL: \"\", withCredentials: true });\r\nfunction authify() {}\r\n\r\ntype SummaryData = {\r\n  totalRequests: number;\r\n  pendingRequests: number;\r\n  inProgressRequests: number;\r\n  completedRequests: number;\r\n  canceledRequests: number;\r\n  urgentRequests: number;\r\n  roleCounts: Record<string, number>;\r\n  tripTypeCounts: Record<string, number>;\r\n  recentRequests: Array<{\r\n    id: number;\r\n    role: string;\r\n    tripType: string;\r\n    status: string;\r\n    isUrgent?: boolean;\r\n    createdAt: string;\r\n    customer: { name: string; email: string };\r\n  }>;\r\n};\r\n\r\nexport default function PlanWithUsDashboardPage() {\r\n  const [summary, setSummary] = useState<SummaryData>({\r\n    totalRequests: 0,\r\n    pendingRequests: 0,\r\n    inProgressRequests: 0,\r\n    completedRequests: 0,\r\n    canceledRequests: 0,\r\n    urgentRequests: 0,\r\n    roleCounts: {},\r\n    tripTypeCounts: {},\r\n    recentRequests: [],\r\n  });\r\n  const [loading, setLoading] = useState(true);\r\n\r\n  useEffect(() => {\r\n    authify();\r\n    async function load() {\r\n      try {\r\n        const r = await api.get<SummaryData>(\"/api/admin/plan-with-us/summary\");\r\n        if (r?.data) {\r\n          setSummary(r.data);\r\n        }\r\n      } catch (err) {\r\n        console.error(\"Failed to load summary\", err);\r\n      } finally {\r\n        setLoading(false);\r\n      }\r\n    }\r\n    load();\r\n  }, []);\r\n\r\n  // Chart data for Requests by Role\r\n  const roleChartData = useMemo<ChartData<\"doughnut\">>(() => {\r\n    const labels = Object.keys(summary.roleCounts).filter(key => summary.roleCounts[key] > 0);\r\n    const data = Object.values(summary.roleCounts).filter((v, i) => Object.values(summary.roleCounts)[i] > 0);\r\n\r\n    const colors = [\r\n      \"rgba(59, 130, 246, 0.8)\", // Blue\r\n      \"rgba(16, 185, 129, 0.8)\", // Green\r\n      \"rgba(245, 158, 11, 0.8)\", // Amber\r\n      \"rgba(139, 92, 246, 0.8)\", // Purple\r\n      \"rgba(239, 68, 68, 0.8)\", // Red\r\n    ];\r\n\r\n    return {\r\n      labels,\r\n      datasets: [\r\n        {\r\n          data,\r\n          backgroundColor: colors.slice(0, labels.length),\r\n          borderColor: \"#fff\",\r\n          borderWidth: 2,\r\n          hoverOffset: 4,\r\n        },\r\n      ],\r\n    };\r\n  }, [summary.roleCounts]);\r\n\r\n  // Chart data for Requests by Trip Type\r\n  const tripTypeChartData = useMemo<ChartData<\"bar\">>(() => {\r\n    const labels = Object.keys(summary.tripTypeCounts).filter(key => summary.tripTypeCounts[key] > 0);\r\n    const data = Object.values(summary.tripTypeCounts).filter((v, i) => Object.values(summary.tripTypeCounts)[i] > 0);\r\n\r\n    return {\r\n      labels,\r\n      datasets: [\r\n        {\r\n          label: \"Requests\",\r\n          data,\r\n          backgroundColor: \"rgba(59, 130, 246, 0.8)\",\r\n          borderColor: \"rgba(59, 130, 246, 1)\",\r\n          borderWidth: 1,\r\n        },\r\n      ],\r\n    };\r\n  }, [summary.tripTypeCounts]);\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      {/* Stats Cards */}\r\n      <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4\">\r\n        <div className=\"bg-white rounded-lg border border-gray-200 p-6 shadow-sm hover:shadow-md transition-all duration-300 hover:border-blue-300 group\">\r\n          <div className=\"flex items-center gap-4\">\r\n            <ClipboardList className=\"h-6 w-6 text-blue-600 group-hover:scale-110 transition-transform duration-300\" />\r\n            <div className=\"flex-1\">\r\n              <div className=\"text-sm font-medium text-gray-500 mb-1\">Total Requests</div>\r\n              <div className=\"text-2xl font-bold text-gray-900\">\r\n                {loading ? \"...\" : (summary.totalRequests || 0).toLocaleString()}\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"bg-white rounded-lg border border-gray-200 p-6 shadow-sm hover:shadow-md transition-all duration-300 hover:border-amber-300 group\">\r\n          <div className=\"flex items-center gap-4\">\r\n            <Clock className=\"h-6 w-6 text-amber-600 group-hover:scale-110 transition-transform duration-300\" />\r\n            <div className=\"flex-1\">\r\n              <div className=\"text-sm font-medium text-gray-500 mb-1\">New Requests</div>\r\n              <div className=\"text-2xl font-bold text-gray-900\">\r\n                {loading ? \"...\" : (summary.pendingRequests || 0).toLocaleString()}\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"bg-white rounded-lg border border-gray-200 p-6 shadow-sm hover:shadow-md transition-all duration-300 hover:border-blue-300 group\">\r\n          <div className=\"flex items-center gap-4\">\r\n            <Loader2 className=\"h-6 w-6 text-blue-600 group-hover:scale-110 group-hover:animate-spin transition-transform duration-300\" />\r\n            <div className=\"flex-1\">\r\n              <div className=\"text-sm font-medium text-gray-500 mb-1\">In Progress</div>\r\n              <div className=\"text-2xl font-bold text-gray-900\">\r\n                {loading ? \"...\" : (summary.inProgressRequests || 0).toLocaleString()}\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"bg-white rounded-lg border border-gray-200 p-6 shadow-sm hover:shadow-md transition-all duration-300 hover:border-green-300 group\">\r\n          <div className=\"flex items-center gap-4\">\r\n            <CheckCircle className=\"h-6 w-6 text-green-600 group-hover:scale-110 transition-transform duration-300\" />\r\n            <div className=\"flex-1\">\r\n              <div className=\"text-sm font-medium text-gray-500 mb-1\">Completed</div>\r\n              <div className=\"text-2xl font-bold text-gray-900\">\r\n                {loading ? \"...\" : (summary.completedRequests || 0).toLocaleString()}\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"bg-white rounded-lg border-2 border-amber-300 p-6 shadow-sm hover:shadow-md transition-all duration-300 hover:border-amber-400 group bg-gradient-to-br from-amber-50 to-amber-100\">\r\n          <div className=\"flex items-center gap-4\">\r\n            <AlertTriangle className=\"h-6 w-6 text-amber-600 group-hover:scale-110 transition-transform duration-300\" />\r\n            <div className=\"flex-1\">\r\n              <div className=\"text-sm font-medium text-amber-700 mb-1\">Urgent (Pending)</div>\r\n              <div className=\"text-2xl font-bold text-amber-900\">\r\n                {loading ? \"...\" : (summary.urgentRequests || 0).toLocaleString()}\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Navigation Links */}\r\n      <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4\">\r\n        <Link\r\n          href=\"/admin/plan-with-us/requests\"\r\n          className=\"no-underline bg-white rounded-lg border border-gray-200 p-6 shadow-sm hover:shadow-md transition-all duration-300 hover:border-blue-300 group\"\r\n        >\r\n          <div className=\"flex items-center gap-4\">\r\n            <FileText className=\"h-6 w-6 text-blue-600 group-hover:scale-110 transition-transform duration-300\" />\r\n            <div className=\"flex-1\">\r\n              <div className=\"text-sm font-medium text-gray-500 mb-1\">All Requests</div>\r\n              <div className=\"text-lg font-semibold text-gray-900\">View All</div>\r\n            </div>\r\n          </div>\r\n        </Link>\r\n\r\n        <Link\r\n          href=\"/admin/plan-with-us/requests?status=NEW\"\r\n          className=\"no-underline bg-white rounded-lg border border-gray-200 p-6 shadow-sm hover:shadow-md transition-all duration-300 hover:border-amber-300 group\"\r\n        >\r\n          <div className=\"flex items-center gap-4\">\r\n            <Clock className=\"h-6 w-6 text-amber-600 group-hover:scale-110 transition-transform duration-300\" />\r\n            <div className=\"flex-1\">\r\n              <div className=\"text-sm font-medium text-gray-500 mb-1\">New Requests</div>\r\n              <div className=\"text-lg font-semibold text-gray-900\">\r\n                {loading ? \"...\" : (summary.pendingRequests || 0)}\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </Link>\r\n      </div>\r\n\r\n      {/* Charts */}\r\n      <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\r\n        {/* Requests by Role */}\r\n        <div className=\"bg-white rounded-lg border border-gray-200 p-6 shadow-sm transition-all duration-300 hover:shadow-lg hover:border-blue-300 hover:-translate-y-1 group\">\r\n          <div className=\"mb-4\">\r\n            <h3 className=\"text-lg font-semibold text-gray-900 flex items-center gap-2 group-hover:text-blue-600 transition-colors duration-300\">\r\n              <Users className=\"h-5 w-5 text-blue-600 group-hover:scale-110 transition-transform duration-300\" />\r\n              Requests by Role\r\n            </h3>\r\n            <p className=\"text-sm text-gray-500 mt-1\">Distribution of requests by customer role</p>\r\n          </div>\r\n          <div className=\"h-64 w-full max-h-64 min-h-[300px] overflow-hidden relative\">\r\n            {loading ? (\r\n              <div className=\"h-full w-full flex items-center justify-center\">\r\n                <div className=\"inline-block animate-spin rounded-full h-6 w-6 border-2 border-gray-300 border-t-blue-600\"></div>\r\n              </div>\r\n            ) : Object.keys(summary.roleCounts).some(k => summary.roleCounts[k] > 0) ? (\r\n              <Chart\r\n                type=\"doughnut\"\r\n                data={roleChartData}\r\n                options={{\r\n                  responsive: true,\r\n                  maintainAspectRatio: false,\r\n                  plugins: {\r\n                    legend: {\r\n                      position: \"right\",\r\n                      labels: {\r\n                        usePointStyle: true,\r\n                        padding: 20,\r\n                        font: {\r\n                          size: 12,\r\n                        },\r\n                      },\r\n                    },\r\n                    tooltip: {\r\n                      callbacks: {\r\n                        label: (context: any) => {\r\n                          const label = context.label || \"\";\r\n                          const value = context.parsed || 0;\r\n                          const total = context.dataset.data.reduce((sum: number, val: number) => sum + val, 0);\r\n                          const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;\r\n                          return `${label}: ${value} (${percentage}%)`;\r\n                        },\r\n                      },\r\n                    },\r\n                  },\r\n                }}\r\n              />\r\n            ) : (\r\n              <div className=\"h-full flex items-center justify-center text-center\">\r\n                <div>\r\n                  <Users className=\"h-12 w-12 text-gray-300 mx-auto mb-3\" />\r\n                  <p className=\"text-sm text-gray-500\">No role data available</p>\r\n                </div>\r\n              </div>\r\n            )}\r\n          </div>\r\n        </div>\r\n\r\n        {/* Requests by Trip Type */}\r\n        <div className=\"bg-white rounded-lg border border-gray-200 p-6 shadow-sm transition-all duration-300 hover:shadow-lg hover:border-green-300 hover:-translate-y-1 group\">\r\n          <div className=\"mb-4\">\r\n            <h3 className=\"text-lg font-semibold text-gray-900 flex items-center gap-2 group-hover:text-green-600 transition-colors duration-300\">\r\n              <MapPin className=\"h-5 w-5 text-green-600 group-hover:scale-110 transition-transform duration-300\" />\r\n              Requests by Trip Type\r\n            </h3>\r\n            <p className=\"text-sm text-gray-500 mt-1\">Distribution of requests by trip type</p>\r\n          </div>\r\n          <div className=\"h-64 w-full max-h-64 min-h-[300px] overflow-hidden relative\">\r\n            {loading ? (\r\n              <div className=\"h-full w-full flex items-center justify-center\">\r\n                <div className=\"inline-block animate-spin rounded-full h-6 w-6 border-2 border-gray-300 border-t-green-600\"></div>\r\n              </div>\r\n            ) : Object.keys(summary.tripTypeCounts).some(k => summary.tripTypeCounts[k] > 0) ? (\r\n              <Chart\r\n                type=\"bar\"\r\n                data={tripTypeChartData}\r\n                options={{\r\n                  responsive: true,\r\n                  maintainAspectRatio: false,\r\n                  plugins: {\r\n                    legend: {\r\n                      display: false,\r\n                    },\r\n                    tooltip: {\r\n                      callbacks: {\r\n                        label: (context: any) => {\r\n                          const value = context.parsed.y || 0;\r\n                          return `Requests: ${value}`;\r\n                        },\r\n                      },\r\n                    },\r\n                  },\r\n                  scales: {\r\n                    y: {\r\n                      beginAtZero: true,\r\n                      ticks: {\r\n                        stepSize: 1,\r\n                        font: {\r\n                          size: 11,\r\n                        },\r\n                      },\r\n                      grid: {\r\n                        color: \"rgba(0, 0, 0, 0.1)\",\r\n                      },\r\n                    },\r\n                    x: {\r\n                      grid: {\r\n                        display: false,\r\n                      },\r\n                      ticks: {\r\n                        font: {\r\n                          size: 11,\r\n                        },\r\n                      },\r\n                    },\r\n                  },\r\n                }}\r\n              />\r\n            ) : (\r\n              <div className=\"h-full flex items-center justify-center text-center\">\r\n                <div>\r\n                  <MapPin className=\"h-12 w-12 text-gray-300 mx-auto mb-3\" />\r\n                  <p className=\"text-sm text-gray-500\">No trip type data available</p>\r\n                </div>\r\n              </div>\r\n            )}\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Recent Requests */}\r\n      {summary.recentRequests.length > 0 && (\r\n        <div className=\"bg-white rounded-lg border border-gray-200 p-6 shadow-sm\">\r\n          <h3 className=\"text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2\">\r\n            <TrendingUp className=\"h-5 w-5 text-blue-600\" />\r\n            Recent Requests\r\n          </h3>\r\n          <div className=\"overflow-x-auto\">\r\n            <table className=\"w-full\">\r\n              <thead className=\"bg-gray-50 border-b border-gray-200\">\r\n                <tr>\r\n                  <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">ID</th>\r\n                  <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">Role</th>\r\n                  <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">Trip Type</th>\r\n                  <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">Customer</th>\r\n                  <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">Status</th>\r\n                  <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">Created</th>\r\n                </tr>\r\n              </thead>\r\n              <tbody className=\"bg-white divide-y divide-gray-200\">\r\n                {summary.recentRequests.map((request) => (\r\n                  <tr key={request.id} className={`hover:bg-gray-50 transition-colors duration-150 ${request.isUrgent ? \"bg-amber-50\" : \"\"}`}>\r\n                    <td className=\"px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900\">\r\n                      <div className=\"flex items-center gap-2\">\r\n                        #{request.id}\r\n                        {request.isUrgent && (\r\n                          <div title=\"Urgent request\">\r\n                            <AlertTriangle className=\"h-4 w-4 text-amber-600\" />\r\n                          </div>\r\n                        )}\r\n                      </div>\r\n                    </td>\r\n                    <td className=\"px-6 py-4 whitespace-nowrap text-sm text-gray-500\">{request.role}</td>\r\n                    <td className=\"px-6 py-4 whitespace-nowrap text-sm text-gray-500\">{request.tripType}</td>\r\n                    <td className=\"px-6 py-4 whitespace-nowrap text-sm text-gray-500\">\r\n                      <div>{request.customer.name}</div>\r\n                      <div className=\"text-xs text-gray-400\">{request.customer.email}</div>\r\n                    </td>\r\n                    <td className=\"px-6 py-4 whitespace-nowrap text-sm text-gray-500\">\r\n                      <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${\r\n                        request.status === \"COMPLETED\" ? \"bg-green-100 text-green-800\" :\r\n                        request.status === \"IN_PROGRESS\" ? \"bg-blue-100 text-blue-800\" :\r\n                        request.status === \"CANCELED\" ? \"bg-red-100 text-red-800\" :\r\n                        \"bg-amber-100 text-amber-800\"\r\n                      }`}>\r\n                        {request.status}\r\n                      </span>\r\n                    </td>\r\n                    <td className=\"px-6 py-4 whitespace-nowrap text-sm text-gray-500\">\r\n                      {new Date(request.createdAt).toLocaleDateString()}\r\n                    </td>\r\n                  </tr>\r\n                ))}\r\n              </tbody>\r\n            </table>\r\n          </div>\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\plan-with-us\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'AdminPageHeader' is defined but never used. Allowed unused vars must match /^_/u.","line":2,"column":8,"nodeType":"Identifier","messageId":"unusedVar","endLine":2,"endColumn":23,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"AdminPageHeader"},"fix":{"range":[15,74],"text":""},"desc":"Remove unused import declaration."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\nimport AdminPageHeader from \"@/components/AdminPageHeader\";\r\nimport { ClipboardList } from \"lucide-react\";\r\nimport PlanWithUsDashboard from \"./dashboard/page\";\r\n\r\nexport default function AdminPlanWithUsPage() {\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      <div className=\"bg-white rounded-lg border border-gray-200 p-6 shadow-sm\">\r\n        <div className=\"flex flex-col items-center text-center mb-4\">\r\n          <div className=\"h-16 w-16 rounded-full bg-gradient-to-br from-blue-50 to-blue-100 flex items-center justify-center mb-4\">\r\n            <ClipboardList className=\"h-8 w-8 text-blue-600\" />\r\n          </div>\r\n          <h1 className=\"text-2xl font-bold text-gray-900\">Plan with US</h1>\r\n          <p className=\"mt-1 text-sm text-gray-600\">Manage custom trip planning requests and proposals</p>\r\n        </div>\r\n      </div>\r\n      <PlanWithUsDashboard />\r\n    </div>\r\n  );\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\plan-with-us\\recommended\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'FileText' is defined but never used. Allowed unused vars must match /^_/u.","line":3,"column":57,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":65,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"FileText"},"fix":{"range":[123,133],"text":""},"desc":"Remove unused variable \"FileText\"."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'load'. Either include it or remove the dependency array.","line":88,"column":6,"nodeType":"ArrayExpression","endLine":88,"endColumn":37,"suggestions":[{"desc":"Update the dependencies array to be: [page, role, tripType, date, q, load]","fix":{"range":[2780,2811],"text":"[page, role, tripType, date, q, load]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\nimport { useEffect, useRef, useState } from \"react\";\r\nimport { CheckCircle, Search, X, Calendar, MapPin, Eye, FileText } from \"lucide-react\";\r\nimport DatePicker from \"@/components/ui/DatePicker\";\r\nimport axios from \"axios\";\r\n\r\n// Use same-origin for HTTP calls so Next.js rewrites proxy to the API\r\nconst api = axios.create({ baseURL: \"\", withCredentials: true });\r\nfunction authify() {}\r\n\r\ntype RecommendedRequest = {\r\n  id: number;\r\n  role: string;\r\n  tripType: string;\r\n  destinations: string;\r\n  dateFrom: string | null;\r\n  dateTo: string | null;\r\n  groupSize: number | null;\r\n  budget: string | null;\r\n  notes: string;\r\n  status: string;\r\n  customer: {\r\n    name: string;\r\n    email: string;\r\n    phone: string | null;\r\n  };\r\n  transportRequired: boolean;\r\n  adminResponse?: string | null;\r\n  suggestedItineraries?: string | null;\r\n  requiredPermits?: string | null;\r\n  estimatedTimeline?: string | null;\r\n  assignedAgent?: string | null;\r\n  respondedAt?: string | null;\r\n  createdAt: string;\r\n};\r\n\r\nexport default function AdminPlanWithUsRecommendedPage() {\r\n  const [role, setRole] = useState<string>(\"\");\r\n  const [tripType, setTripType] = useState<string>(\"\");\r\n  const [date, setDate] = useState<string | string[]>(\"\");\r\n  const [q, setQ] = useState(\"\");\r\n  const [list, setList] = useState<RecommendedRequest[]>([]);\r\n  const [loading, setLoading] = useState(true);\r\n  const [page, setPage] = useState(1);\r\n  const [total, setTotal] = useState(0);\r\n  const pageSize = 30;\r\n  const searchRef = useRef<HTMLInputElement | null>(null);\r\n  const [pickerAnim, setPickerAnim] = useState(false);\r\n  const [pickerOpen, setPickerOpen] = useState(false);\r\n  const [selectedRequest, setSelectedRequest] = useState<RecommendedRequest | null>(null);\r\n  const [showResponseModal, setShowResponseModal] = useState(false);\r\n\r\n  async function load() {\r\n    setLoading(true);\r\n    try {\r\n      const params: any = {\r\n        page,\r\n        pageSize,\r\n        status: \"COMPLETED\", // Only show completed requests\r\n      };\r\n      if (role) params.role = role;\r\n      if (tripType) params.tripType = tripType;\r\n      if (date) {\r\n        if (Array.isArray(date)) {\r\n          params.start = date[0];\r\n          params.end = date[1];\r\n        } else {\r\n          params.date = date;\r\n        }\r\n      }\r\n      if (q) params.q = q;\r\n\r\n      const r = await api.get<{ items: RecommendedRequest[]; total: number }>(\"/api/admin/plan-with-us/requests\", { params });\r\n      setList(r.data?.items ?? []);\r\n      setTotal(r.data?.total ?? 0);\r\n    } catch (err) {\r\n      console.error(\"Failed to load recommended requests\", err);\r\n      setList([]);\r\n      setTotal(0);\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  }\r\n\r\n  useEffect(() => {\r\n    authify();\r\n    load();\r\n  }, [page, role, tripType, date, q]);\r\n\r\n  const pages = Math.max(1, Math.ceil(total / pageSize));\r\n\r\n  return (\r\n    <div className=\"space-y-6 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8\">\r\n      {/* Header */}\r\n      <div className=\"bg-white rounded-lg border border-gray-200 p-6 shadow-sm\">\r\n        <div className=\"flex flex-col items-center text-center\">\r\n          <div className=\"h-16 w-16 rounded-full bg-gradient-to-br from-green-50 to-green-100 flex items-center justify-center mb-4\">\r\n            <CheckCircle className=\"h-8 w-8 text-green-600\" />\r\n          </div>\r\n          <h1 className=\"text-2xl font-bold text-gray-900\">Recommended</h1>\r\n          <p className=\"text-sm text-gray-500 mt-1\">View all completed requests with feedback sent to customers</p>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Search and Filters */}\r\n      <div className=\"bg-white rounded-lg border border-gray-200 p-4 shadow-sm\">\r\n        <div className=\"flex flex-col gap-4 w-full max-w-full\">\r\n          <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 xl:grid-cols-6 gap-3 w-full max-w-full\">\r\n            {/* Search Box */}\r\n            <div className=\"relative w-full min-w-0 sm:col-span-2 lg:col-span-2 xl:col-span-2\">\r\n              <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400\" />\r\n              <input\r\n                ref={searchRef}\r\n                type=\"text\"\r\n                className=\"w-full pl-10 pr-10 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none text-sm max-w-full box-border\"\r\n                placeholder=\"Search recommended requests...\"\r\n                value={q}\r\n                onChange={(e) => setQ(e.target.value)}\r\n                onKeyDown={(e) => {\r\n                  if (e.key === \"Enter\") {\r\n                    e.preventDefault();\r\n                    setPage(1);\r\n                    load();\r\n                  }\r\n                }}\r\n              />\r\n              {q && (\r\n                <button\r\n                  type=\"button\"\r\n                  onClick={() => {\r\n                    setQ(\"\");\r\n                    setPage(1);\r\n                    load();\r\n                  }}\r\n                  className=\"absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600 transition-colors\"\r\n                  aria-label=\"Clear search\"\r\n                >\r\n                  <X className=\"h-4 w-4\" />\r\n                </button>\r\n              )}\r\n            </div>\r\n\r\n            {/* Role Filter */}\r\n            <div className=\"w-full min-w-0\">\r\n              <select\r\n                value={role}\r\n                onChange={(e) => {\r\n                  setRole(e.target.value);\r\n                  setPage(1);\r\n                }}\r\n                className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none text-sm bg-white max-w-full box-border\"\r\n              >\r\n                <option value=\"\">All Roles</option>\r\n                <option value=\"Event planner\">Event Planner</option>\r\n                <option value=\"School / Teacher\">School / Teacher</option>\r\n                <option value=\"University\">University</option>\r\n                <option value=\"Community group\">Community Group</option>\r\n                <option value=\"Tourist\">Tourist</option>\r\n                <option value=\"Other\">Other</option>\r\n              </select>\r\n            </div>\r\n\r\n            {/* Trip Type Filter */}\r\n            <div className=\"w-full min-w-0\">\r\n              <select\r\n                value={tripType}\r\n                onChange={(e) => {\r\n                  setTripType(e.target.value);\r\n                  setPage(1);\r\n                }}\r\n                className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none text-sm bg-white max-w-full box-border\"\r\n              >\r\n                <option value=\"\">All Trip Types</option>\r\n                <option value=\"Local tourism\">Local Tourism</option>\r\n                <option value=\"Safari\">Safari</option>\r\n                <option value=\"Cultural\">Cultural</option>\r\n                <option value=\"Adventure / Hiking\">Adventure / Hiking</option>\r\n                <option value=\"Other\">Other</option>\r\n              </select>\r\n            </div>\r\n\r\n            {/* Date Picker */}\r\n            <div className=\"relative w-full min-w-0\">\r\n              <button\r\n                type=\"button\"\r\n                onClick={() => {\r\n                  setPickerAnim(true);\r\n                  setTimeout(() => setPickerAnim(false), 350);\r\n                  setPickerOpen((v) => !v);\r\n                }}\r\n                className={`w-full px-3 py-2 rounded-lg border border-gray-300 text-sm flex items-center justify-center gap-2 text-gray-700 bg-white transition-all ${\r\n                  pickerAnim ? \"ring-2 ring-blue-100\" : \"hover:bg-gray-50\"\r\n                } box-border`}\r\n              >\r\n                <Calendar className=\"h-4 w-4\" />\r\n                <span>Date</span>\r\n              </button>\r\n              {pickerOpen && (\r\n                <>\r\n                  <div className=\"fixed inset-0 z-40\" onClick={() => setPickerOpen(false)} />\r\n                  <div className=\"fixed z-50 top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2\">\r\n                    <DatePicker\r\n                      selected={date || undefined}\r\n                      onSelectAction={(s) => {\r\n                        setDate(s as string | string[]);\r\n                        setPage(1);\r\n                      }}\r\n                      onCloseAction={() => setPickerOpen(false)}\r\n                    />\r\n                  </div>\r\n                </>\r\n              )}\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Recommended Requests Table */}\r\n      <div className=\"bg-white rounded-lg border border-gray-200 shadow-sm overflow-hidden\">\r\n        {loading ? (\r\n          <>\r\n            {/* Skeleton Table */}\r\n            <div className=\"hidden md:block overflow-x-auto\">\r\n              <table className=\"w-full\">\r\n                <thead className=\"bg-gray-50 border-b border-gray-200\">\r\n                  <tr>\r\n                    <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">ID</th>\r\n                    <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">Customer</th>\r\n                    <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">Role</th>\r\n                    <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">Trip Type</th>\r\n                    <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">Destination</th>\r\n                    <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">Responded At</th>\r\n                    <th className=\"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider\">Actions</th>\r\n                  </tr>\r\n                </thead>\r\n                <tbody className=\"bg-white divide-y divide-gray-200\">\r\n                  {[...Array(5)].map((_, i) => (\r\n                    <tr key={i} className=\"animate-pulse\">\r\n                      <td className=\"px-6 py-4 whitespace-nowrap\">\r\n                        <div className=\"h-4 bg-gray-200 rounded w-12\"></div>\r\n                      </td>\r\n                      <td className=\"px-6 py-4 whitespace-nowrap\">\r\n                        <div className=\"h-4 bg-gray-200 rounded w-32 mb-2\"></div>\r\n                        <div className=\"h-3 bg-gray-200 rounded w-40\"></div>\r\n                      </td>\r\n                      <td className=\"px-6 py-4 whitespace-nowrap\">\r\n                        <div className=\"h-4 bg-gray-200 rounded w-24\"></div>\r\n                      </td>\r\n                      <td className=\"px-6 py-4 whitespace-nowrap\">\r\n                        <div className=\"h-4 bg-gray-200 rounded w-20\"></div>\r\n                      </td>\r\n                      <td className=\"px-6 py-4 whitespace-nowrap\">\r\n                        <div className=\"h-4 bg-gray-200 rounded w-28\"></div>\r\n                      </td>\r\n                      <td className=\"px-6 py-4 whitespace-nowrap\">\r\n                        <div className=\"h-4 bg-gray-200 rounded w-24\"></div>\r\n                      </td>\r\n                      <td className=\"px-6 py-4 whitespace-nowrap text-right\">\r\n                        <div className=\"h-8 bg-gray-200 rounded w-24 ml-auto\"></div>\r\n                      </td>\r\n                    </tr>\r\n                  ))}\r\n                </tbody>\r\n              </table>\r\n            </div>\r\n          </>\r\n        ) : list.length === 0 ? (\r\n          <div className=\"px-6 py-12 text-center\">\r\n            <CheckCircle className=\"h-12 w-12 text-gray-300 mx-auto mb-3\" />\r\n            <p className=\"text-sm text-gray-500\">No recommended requests found.</p>\r\n            <p className=\"text-xs text-gray-400 mt-1\">Try adjusting your filters or search query.</p>\r\n          </div>\r\n        ) : (\r\n          <>\r\n            {/* Desktop Table */}\r\n            <div className=\"hidden md:block overflow-x-auto\">\r\n              <table className=\"w-full\">\r\n                <thead className=\"bg-gray-50 border-b border-gray-200\">\r\n                  <tr>\r\n                    <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">ID</th>\r\n                    <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">Customer</th>\r\n                    <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">Role</th>\r\n                    <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">Trip Type</th>\r\n                    <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">Destination</th>\r\n                    <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">Responded At</th>\r\n                    <th className=\"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider\">Actions</th>\r\n                  </tr>\r\n                </thead>\r\n                <tbody className=\"bg-white divide-y divide-gray-200\">\r\n                  {list.map((request) => (\r\n                    <tr key={request.id} className=\"hover:bg-gray-50 transition-colors duration-150\">\r\n                      <td className=\"px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900\">#{request.id}</td>\r\n                      <td className=\"px-6 py-4 whitespace-nowrap text-sm text-gray-500\">\r\n                        <div>\r\n                          <div className=\"font-medium\">{request.customer.name}</div>\r\n                          <div className=\"text-xs text-gray-400\">{request.customer.email}</div>\r\n                        </div>\r\n                      </td>\r\n                      <td className=\"px-6 py-4 whitespace-nowrap text-sm text-gray-500\">{request.role}</td>\r\n                      <td className=\"px-6 py-4 whitespace-nowrap text-sm text-gray-500\">{request.tripType}</td>\r\n                      <td className=\"px-6 py-4 text-sm text-gray-500\">\r\n                        <div className=\"flex items-center gap-2\">\r\n                          <MapPin className=\"h-4 w-4 text-gray-400 flex-shrink-0\" />\r\n                          <span className=\"max-w-xs truncate\">{request.destinations || \"N/A\"}</span>\r\n                        </div>\r\n                      </td>\r\n                      <td className=\"px-6 py-4 whitespace-nowrap text-sm text-gray-500\">\r\n                        {request.respondedAt ? (\r\n                          <div className=\"flex items-center gap-2\">\r\n                            <Calendar className=\"h-4 w-4 text-gray-400\" />\r\n                            <span>{new Date(request.respondedAt).toLocaleDateString()}</span>\r\n                          </div>\r\n                        ) : (\r\n                          \"N/A\"\r\n                        )}\r\n                      </td>\r\n                      <td className=\"px-6 py-4 whitespace-nowrap text-right text-sm font-medium\">\r\n                        <button\r\n                          onClick={() => {\r\n                            setSelectedRequest(request);\r\n                            setShowResponseModal(true);\r\n                          }}\r\n                          className=\"text-blue-600 hover:text-blue-900 flex items-center gap-1 ml-auto\"\r\n                        >\r\n                          <Eye className=\"h-4 w-4\" />\r\n                          View Feedback\r\n                        </button>\r\n                      </td>\r\n                    </tr>\r\n                  ))}\r\n                </tbody>\r\n              </table>\r\n            </div>\r\n\r\n            {/* Mobile Cards */}\r\n            <div className=\"md:hidden divide-y divide-gray-200\">\r\n              {list.map((request) => (\r\n                <div key={request.id} className=\"p-4 bg-white hover:bg-gray-50 transition-colors duration-150\">\r\n                  <div className=\"flex items-center justify-between mb-2\">\r\n                    <span className=\"text-sm font-semibold text-gray-900\">Request #{request.id}</span>\r\n                    <span className=\"px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800\">\r\n                      Completed\r\n                    </span>\r\n                  </div>\r\n                  <div className=\"text-sm text-gray-600 mb-1\">\r\n                    <span>Role: {request.role} • Type: {request.tripType}</span>\r\n                  </div>\r\n                  <div className=\"text-sm text-gray-600 mb-1 flex items-center gap-2\">\r\n                    <span>Customer: {request.customer.name}</span>\r\n                  </div>\r\n                  <div className=\"text-sm text-gray-600 mb-1 flex items-center gap-2\">\r\n                    <MapPin className=\"h-4 w-4 text-gray-400\" />\r\n                    <span>Destination: {request.destinations || \"N/A\"}</span>\r\n                  </div>\r\n                  <div className=\"text-sm text-gray-600 mb-1 flex items-center gap-2\">\r\n                    <Calendar className=\"h-4 w-4 text-gray-400\" />\r\n                    <span>\r\n                      Responded: {request.respondedAt ? new Date(request.respondedAt).toLocaleDateString() : \"N/A\"}\r\n                    </span>\r\n                  </div>\r\n                  <div className=\"mt-3 text-right\">\r\n                    <button\r\n                      onClick={() => {\r\n                        setSelectedRequest(request);\r\n                        setShowResponseModal(true);\r\n                      }}\r\n                      className=\"text-blue-600 hover:text-blue-900 text-sm flex items-center gap-1 ml-auto\"\r\n                    >\r\n                      <Eye className=\"h-4 w-4\" />\r\n                      View Feedback\r\n                    </button>\r\n                  </div>\r\n                </div>\r\n              ))}\r\n            </div>\r\n          </>\r\n        )}\r\n      </div>\r\n\r\n      {/* Pagination */}\r\n      {list.length > 0 && (\r\n        <div className=\"flex justify-center py-4\">\r\n          <nav className=\"relative z-0 inline-flex rounded-md shadow-sm -space-x-px\" aria-label=\"Pagination\">\r\n            <button\r\n              onClick={() => setPage((p) => Math.max(1, p - 1))}\r\n              disabled={page === 1}\r\n              className=\"relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed\"\r\n            >\r\n              Previous\r\n            </button>\r\n            <span className=\"relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700\">\r\n              Page {page} of {pages}\r\n            </span>\r\n            <button\r\n              onClick={() => setPage((p) => Math.min(pages, p + 1))}\r\n              disabled={page === pages}\r\n              className=\"relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed\"\r\n            >\r\n              Next\r\n            </button>\r\n          </nav>\r\n        </div>\r\n      )}\r\n\r\n      {/* View Feedback Modal */}\r\n      {showResponseModal && selectedRequest && (\r\n        <>\r\n          <div className=\"fixed inset-0 bg-black bg-opacity-50 z-50\" onClick={() => setShowResponseModal(false)} />\r\n          <div className=\"fixed inset-0 z-50 flex items-center justify-center p-4\">\r\n            <div className=\"bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto\">\r\n              <div className=\"sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between\">\r\n                <h2 className=\"text-xl font-semibold text-gray-900\">Feedback Sent to Customer</h2>\r\n                <button\r\n                  onClick={() => setShowResponseModal(false)}\r\n                  className=\"text-gray-400 hover:text-gray-600\"\r\n                >\r\n                  <X className=\"h-6 w-6\" />\r\n                </button>\r\n              </div>\r\n\r\n              <div className=\"p-6 space-y-6\">\r\n                {/* Request Details */}\r\n                <div className=\"bg-gray-50 rounded-lg p-4 space-y-2\">\r\n                  <h3 className=\"font-semibold text-gray-900 mb-3\">Original Request</h3>\r\n                  <div className=\"grid grid-cols-2 gap-4 text-sm\">\r\n                    <div>\r\n                      <span className=\"text-gray-500\">Customer:</span>\r\n                      <span className=\"ml-2 font-medium\">{selectedRequest.customer.name}</span>\r\n                    </div>\r\n                    <div>\r\n                      <span className=\"text-gray-500\">Email:</span>\r\n                      <span className=\"ml-2\">{selectedRequest.customer.email}</span>\r\n                    </div>\r\n                    <div>\r\n                      <span className=\"text-gray-500\">Role:</span>\r\n                      <span className=\"ml-2\">{selectedRequest.role}</span>\r\n                    </div>\r\n                    <div>\r\n                      <span className=\"text-gray-500\">Trip Type:</span>\r\n                      <span className=\"ml-2\">{selectedRequest.tripType}</span>\r\n                    </div>\r\n                    <div>\r\n                      <span className=\"text-gray-500\">Destination:</span>\r\n                      <span className=\"ml-2\">{selectedRequest.destinations || \"N/A\"}</span>\r\n                    </div>\r\n                    <div>\r\n                      <span className=\"text-gray-500\">Group Size:</span>\r\n                      <span className=\"ml-2\">{selectedRequest.groupSize || \"N/A\"}</span>\r\n                    </div>\r\n                  </div>\r\n                  {selectedRequest.notes && (\r\n                    <div className=\"mt-3\">\r\n                      <span className=\"text-gray-500 text-sm\">Notes:</span>\r\n                      <p className=\"mt-1 text-sm text-gray-700\">{selectedRequest.notes}</p>\r\n                    </div>\r\n                  )}\r\n                </div>\r\n\r\n                {/* Admin Response */}\r\n                <div className=\"space-y-4\">\r\n                  <h3 className=\"font-semibold text-gray-900\">Feedback Provided</h3>\r\n\r\n                  {selectedRequest.suggestedItineraries && (\r\n                    <div>\r\n                      <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                        Suggested Itineraries with Prices\r\n                      </label>\r\n                      <div className=\"w-full px-3 py-2 border border-gray-200 rounded-lg bg-gray-50 text-sm whitespace-pre-wrap\">\r\n                        {selectedRequest.suggestedItineraries}\r\n                      </div>\r\n                    </div>\r\n                  )}\r\n\r\n                  {selectedRequest.requiredPermits && (\r\n                    <div>\r\n                      <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                        Checklist of Required Permits and Documents\r\n                      </label>\r\n                      <div className=\"w-full px-3 py-2 border border-gray-200 rounded-lg bg-gray-50 text-sm whitespace-pre-wrap\">\r\n                        {selectedRequest.requiredPermits}\r\n                      </div>\r\n                    </div>\r\n                  )}\r\n\r\n                  {selectedRequest.estimatedTimeline && (\r\n                    <div>\r\n                      <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                        Estimated Timelines and Booking Windows\r\n                      </label>\r\n                      <div className=\"w-full px-3 py-2 border border-gray-200 rounded-lg bg-gray-50 text-sm whitespace-pre-wrap\">\r\n                        {selectedRequest.estimatedTimeline}\r\n                      </div>\r\n                    </div>\r\n                  )}\r\n\r\n                  {selectedRequest.assignedAgent && (\r\n                    <div>\r\n                      <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                        Assigned Agent / Contact\r\n                      </label>\r\n                      <div className=\"w-full px-3 py-2 border border-gray-200 rounded-lg bg-gray-50 text-sm\">\r\n                        {selectedRequest.assignedAgent}\r\n                      </div>\r\n                    </div>\r\n                  )}\r\n\r\n                  {selectedRequest.adminResponse && (\r\n                    <div>\r\n                      <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                        Additional Notes / Recommendations\r\n                      </label>\r\n                      <div className=\"w-full px-3 py-2 border border-gray-200 rounded-lg bg-gray-50 text-sm whitespace-pre-wrap\">\r\n                        {selectedRequest.adminResponse}\r\n                      </div>\r\n                    </div>\r\n                  )}\r\n\r\n                  {selectedRequest.respondedAt && (\r\n                    <div className=\"pt-4 border-t border-gray-200\">\r\n                      <p className=\"text-sm text-gray-500\">\r\n                        Feedback sent on: <span className=\"font-medium\">{new Date(selectedRequest.respondedAt).toLocaleString()}</span>\r\n                      </p>\r\n                    </div>\r\n                  )}\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\plan-with-us\\requests\\page.tsx","messages":[],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'load'. Either include it or remove the dependency array.","line":313,"column":6,"nodeType":"ArrayExpression","endLine":313,"endColumn":45,"suggestions":[{"desc":"Update the dependencies array to be: [page, role, tripType, status, date, q, load]","fix":{"range":[10849,10888],"text":"[page, role, tripType, status, date, q, load]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\privacy\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\profile\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\properties\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\properties\\previews\\page.tsx","messages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":478,"column":23,"nodeType":"JSXOpeningElement","endLine":483,"endColumn":25}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useEffect, useCallback } from \"react\";\r\nimport PropertyPreview from \"@/components/PropertyPreview\";\r\nimport { Loader2, ScanEye, MapPin, Star, Search, X, Filter } from \"lucide-react\";\r\nimport axios from \"axios\";\r\nimport Image from \"next/image\";\r\nimport { \r\n  getPropertyCommission, \r\n  calculatePriceWithCommission \r\n} from \"@/lib/priceUtils\";\r\nimport { REGIONS } from \"@/lib/tzRegions\";\r\n\r\n// Use same-origin calls + secure httpOnly cookie session.\r\nconst api = axios.create({ baseURL: \"\", withCredentials: true });\r\n\r\ntype Property = {\r\n  id: number;\r\n  title: string;\r\n  status: string;\r\n  type: string | null;\r\n  photos?: unknown;\r\n  regionName?: string | null;\r\n  district?: string | null;\r\n  owner?: { id: number; name?: string | null; email?: string | null } | null;\r\n  basePrice?: number | null;\r\n  currency?: string;\r\n  hotelStar?: string | null;\r\n  services?: any; // Can contain commissionPercent and discountRules\r\n  location?: {\r\n    regionName?: string | null;\r\n    district?: string | null;\r\n    city?: string | null;\r\n  } | null;\r\n};\r\n\r\nfunction isSafeNextImageSrc(value: unknown): value is string {\r\n  if (typeof value !== \"string\") return false;\r\n  const v = value.trim();\r\n  if (!v) return false;\r\n  if (v.startsWith(\"/\")) return true;\r\n  if (v.startsWith(\"http://\") || v.startsWith(\"https://\")) return true;\r\n  return false;\r\n}\r\n\r\nfunction canUseNextImageForSrc(src: string): boolean {\r\n  if (src.startsWith(\"/\")) return true;\r\n\r\n  if (!src.startsWith(\"http://\") && !src.startsWith(\"https://\")) return false;\r\n  try {\r\n    const url = new URL(src);\r\n    const host = url.hostname;\r\n    if (host === \"localhost\" || host === \"127.0.0.1\") return true;\r\n    if (host === \"res.cloudinary.com\") return true;\r\n    if (host === \"img.youtube.com\") return true;\r\n    if (host === \"api.mapbox.com\") return true;\r\n    if (host.endsWith(\".mapbox.com\")) return true;\r\n    return false;\r\n  } catch {\r\n    return false;\r\n  }\r\n}\r\n\r\nexport default function PropertyPreviewsPage() {\r\n  const [properties, setProperties] = useState<Property[]>([]);\r\n  const [loading, setLoading] = useState(true);\r\n  const [selectedPropertyId, setSelectedPropertyId] = useState<number | null>(null);\r\n  const [statusFilter, setStatusFilter] = useState<string>(\"PENDING\");\r\n  const [systemCommission, setSystemCommission] = useState<number>(0);\r\n  const [counts, setCounts] = useState<Record<string, number>>({\r\n    DRAFT: 0,\r\n    PENDING: 0,\r\n    APPROVED: 0,\r\n    NEEDS_FIXES: 0,\r\n    REJECTED: 0,\r\n    SUSPENDED: 0,\r\n    ALL: 0,\r\n  });\r\n\r\n  // Advanced filters\r\n  const [showAdvancedFilters, setShowAdvancedFilters] = useState(false);\r\n  const [searchQuery, setSearchQuery] = useState<string>(\"\");\r\n  const [regionFilter, setRegionFilter] = useState<string>(\"\");\r\n  const [typeFilter, setTypeFilter] = useState<string>(\"\");\r\n  const [ownerFilter, setOwnerFilter] = useState<string>(\"\");\r\n  const [owners, setOwners] = useState<Array<{ id: number; name: string | null; email: string }>>([]);\r\n  const [loadingOwners, setLoadingOwners] = useState(false);\r\n\r\n  // Load system commission settings\r\n  useEffect(() => {\r\n    let mounted = true;\r\n    const load = async () => {\r\n      try {\r\n        const response = await api.get(\"/admin/settings\");\r\n        if (mounted && response.data?.commissionPercent !== undefined) {\r\n          const commission = Number(response.data.commissionPercent);\r\n          setSystemCommission(isNaN(commission) ? 0 : commission);\r\n        }\r\n      } catch (e) {\r\n        // Silently fail - will use 0 as default\r\n      }\r\n    };\r\n    load();\r\n    return () => {\r\n      mounted = false;\r\n    };\r\n  }, []);\r\n\r\n  const loadOwners = useCallback(async () => {\r\n    try {\r\n      setLoadingOwners(true);\r\n      const response = await api.get(\"/admin/owners\", {\r\n        params: { page: 1, pageSize: 100, status: \"ACTIVE\" },\r\n      });\r\n      setOwners(response.data.items || []);\r\n    } catch (err) {\r\n      console.error(\"Failed to load owners:\", err);\r\n      setOwners([]);\r\n    } finally {\r\n      setLoadingOwners(false);\r\n    }\r\n  }, []);\r\n\r\n  const loadProperties = useCallback(async () => {\r\n    try {\r\n      setLoading(true);\r\n      const params: any = { page: 1, pageSize: 50 };\r\n      if (statusFilter !== \"ALL\") {\r\n        params.status = statusFilter;\r\n      }\r\n      if (searchQuery.trim()) {\r\n        params.q = searchQuery.trim();\r\n      }\r\n      if (regionFilter && regionFilter !== \"\") {\r\n        // Find the region by ID (slug) and send the name for filtering\r\n        const selectedRegion = REGIONS.find(r => r.id === regionFilter);\r\n        if (selectedRegion) {\r\n          params.regionName = selectedRegion.name;\r\n        }\r\n      }\r\n      if (typeFilter && typeFilter !== \"\") {\r\n        params.type = typeFilter;\r\n      }\r\n      if (ownerFilter && ownerFilter !== \"\") {\r\n        params.ownerId = Number(ownerFilter);\r\n      }\r\n      const response = await api.get(\"/api/admin/properties\", { params });\r\n      console.log('[PropertyPreviews] API Response:', {\r\n        statusFilter,\r\n        params,\r\n        itemsCount: response.data?.items?.length || 0,\r\n        total: response.data?.total || 0,\r\n        firstItem: response.data?.items?.[0] || null,\r\n      });\r\n      setProperties(response.data.items || []);\r\n    } catch (err: any) {\r\n      console.error(\"Failed to load properties:\", err);\r\n      setProperties([]);\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  }, [statusFilter, searchQuery, regionFilter, typeFilter, ownerFilter]);\r\n\r\n  useEffect(() => {\r\n    loadProperties();\r\n  }, [loadProperties]);\r\n\r\n  // Load owners for filter dropdown\r\n  useEffect(() => {\r\n    if (showAdvancedFilters && owners.length === 0) {\r\n      loadOwners();\r\n    }\r\n  }, [showAdvancedFilters, owners.length, loadOwners]);\r\n\r\n  // Fetch counts for each status\r\n  useEffect(() => {\r\n    (async () => {\r\n      try {\r\n        const r = await api.get<Record<string, number>>('/api/admin/properties/counts');\r\n        console.log('[PropertyPreviews] Counts response:', r.data);\r\n        if (r?.data) {\r\n          setCounts((prev) => {\r\n            const newCounts = { ...prev, ...r.data };\r\n            // Calculate ALL count\r\n            newCounts.ALL = Object.values(newCounts).reduce((sum, count) => {\r\n              if (typeof count === 'number' && count > 0) {\r\n                return sum + count;\r\n              }\r\n              return sum;\r\n            }, 0);\r\n            return newCounts;\r\n          });\r\n        }\r\n      } catch (e: any) {\r\n        console.error('[PropertyPreviews] Failed to load counts:', e);\r\n        console.error('[PropertyPreviews] Error response:', e.response?.data);\r\n        // ignore if backend doesn't expose counts\r\n      }\r\n    })();\r\n  }, []);\r\n\r\n  const clearFilters = () => {\r\n    setSearchQuery(\"\");\r\n    setRegionFilter(\"\");\r\n    setTypeFilter(\"\");\r\n    setOwnerFilter(\"\");\r\n  };\r\n\r\n  const hasActiveFilters = searchQuery.trim() || regionFilter || typeFilter || ownerFilter;\r\n\r\n  const badgeClasses = (v: string) => {\r\n    switch (v) {\r\n      case \"APPROVED\":\r\n        return \"bg-emerald-100 text-emerald-700\";\r\n      case \"PENDING\":\r\n        return \"bg-amber-100 text-amber-700\";\r\n      case \"NEEDS_FIXES\":\r\n        return \"bg-orange-100 text-orange-700\";\r\n      case \"REJECTED\":\r\n        return \"bg-rose-100 text-rose-700\";\r\n      case \"SUSPENDED\":\r\n        return \"bg-violet-100 text-violet-700\";\r\n      case \"DRAFT\":\r\n      default:\r\n        return \"bg-slate-100 text-slate-700\";\r\n    }\r\n  };\r\n\r\n  if (selectedPropertyId) {\r\n    return (\r\n        <PropertyPreview\r\n          propertyId={selectedPropertyId}\r\n          mode=\"admin\"\r\n          onApproved={() => {\r\n            setSelectedPropertyId(null);\r\n            loadProperties();\r\n          }}\r\n          onRejected={() => {\r\n            setSelectedPropertyId(null);\r\n            loadProperties();\r\n          }}\r\n        onUpdated={async () => {\r\n          // Reload properties to show updated prices\r\n          await loadProperties();\r\n          // Also reload system commission in case it changed\r\n          try {\r\n            const response = await api.get(\"/admin/settings\");\r\n            if (response.data?.commissionPercent !== undefined) {\r\n              const commission = Number(response.data.commissionPercent);\r\n              setSystemCommission(isNaN(commission) ? 0 : commission);\r\n            }\r\n          } catch (e) {\r\n            // Silently fail\r\n          }\r\n          }}\r\n        />\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-gray-50\">\r\n      <div className=\"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8\">\r\n        <div className=\"mb-8 text-center\">\r\n          <div className=\"flex flex-col items-center justify-center mb-3\">\r\n            <ScanEye className=\"h-10 w-10 text-[#02665e] mb-3\" />\r\n            <h1 className=\"text-3xl font-bold text-gray-900\">Property Previews</h1>\r\n          </div>\r\n          <p className=\"text-gray-600 mb-4\">Review and manage property listings with full preview</p>\r\n        </div>\r\n\r\n        {/* Search and Filters Card */}\r\n        <div className=\"bg-white rounded-lg border border-gray-200 p-4 shadow-sm mb-6\">\r\n          {/* Search Bar with Advanced Filters Button */}\r\n          <div className=\"flex items-center justify-center gap-3\">\r\n            <button\r\n              type=\"button\"\r\n              onClick={() => setShowAdvancedFilters(!showAdvancedFilters)}\r\n              className=\"flex items-center justify-center p-2 border-2 border-gray-200 rounded-lg bg-white hover:bg-gray-50 hover:border-[#02665e] hover:text-[#02665e] transition-all duration-200 flex-shrink-0\"\r\n              title=\"Advanced Filters\"\r\n            >\r\n              <Filter className=\"h-5 w-5 text-gray-700\" />\r\n            </button>\r\n            <div className=\"relative flex-1 max-w-[280px] sm:max-w-sm md:max-w-md lg:max-w-lg\">\r\n              <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-500\" />\r\n              <input\r\n                type=\"text\"\r\n                className=\"w-full pl-10 pr-10 py-2.5 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-[#02665e] focus:border-[#02665e] outline-none text-sm bg-white text-gray-900 placeholder:text-gray-400\"\r\n                placeholder=\"Search by title, region, or district...\"\r\n                value={searchQuery}\r\n                onChange={(e) => setSearchQuery(e.target.value)}\r\n              />\r\n              {searchQuery && (\r\n                <button\r\n                  type=\"button\"\r\n                  onClick={() => setSearchQuery(\"\")}\r\n                  className=\"absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700 transition-colors\"\r\n                  aria-label=\"Clear search\"\r\n                >\r\n                  <X className=\"h-4 w-4\" />\r\n                </button>\r\n              )}\r\n            </div>\r\n            {hasActiveFilters && (\r\n              <button\r\n                type=\"button\"\r\n                onClick={clearFilters}\r\n                className=\"px-3 py-2 text-sm text-[#02665e] hover:text-white hover:bg-[#02665e] font-medium border border-[#02665e] rounded-lg transition-all duration-200 flex-shrink-0\"\r\n              >\r\n                Clear\r\n              </button>\r\n            )}\r\n          </div>\r\n\r\n          {/* Advanced Filters Panel */}\r\n          {showAdvancedFilters && (\r\n            <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4 pt-4 border-t border-gray-200 mt-4\">\r\n              {/* Region Filter */}\r\n              <div>\r\n                <label className=\"block text-sm font-medium text-gray-700 mb-1\">\r\n                  Region\r\n                </label>\r\n                <select\r\n                  value={regionFilter}\r\n                  onChange={(e) => setRegionFilter(e.target.value)}\r\n                  className=\"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-[#02665e] focus:border-[#02665e] outline-none\"\r\n                >\r\n                  <option value=\"\">All Regions</option>\r\n                  {REGIONS.map((region) => (\r\n                    <option key={region.id} value={region.id}>\r\n                      {region.name}\r\n                    </option>\r\n                  ))}\r\n                </select>\r\n              </div>\r\n\r\n              {/* Property Type Filter */}\r\n              <div>\r\n                <label className=\"block text-sm font-medium text-gray-700 mb-1\">\r\n                  Property Type\r\n                </label>\r\n                <select\r\n                  value={typeFilter}\r\n                  onChange={(e) => setTypeFilter(e.target.value)}\r\n                  className=\"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-[#02665e] focus:border-[#02665e] outline-none\"\r\n                >\r\n                  <option value=\"\">All Types</option>\r\n                  <option value=\"HOTEL\">Hotel</option>\r\n                  <option value=\"APARTMENT\">Apartment</option>\r\n                  <option value=\"HOUSE\">House</option>\r\n                  <option value=\"VILLA\">Villa</option>\r\n                  <option value=\"RESORT\">Resort</option>\r\n                  <option value=\"LODGE\">Lodge</option>\r\n                  <option value=\"GUESTHOUSE\">Guesthouse</option>\r\n                  <option value=\"HOSTEL\">Hostel</option>\r\n                  <option value=\"CABIN\">Cabin</option>\r\n                  <option value=\"OTHER\">Other</option>\r\n                </select>\r\n              </div>\r\n\r\n              {/* Owner Filter */}\r\n              <div>\r\n                <label className=\"block text-sm font-medium text-gray-700 mb-1\">\r\n                  Owner\r\n                </label>\r\n                <select\r\n                  value={ownerFilter}\r\n                  onChange={(e) => setOwnerFilter(e.target.value)}\r\n                  disabled={loadingOwners}\r\n                  className=\"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-[#02665e] focus:border-[#02665e] outline-none disabled:bg-gray-100 disabled:cursor-not-allowed\"\r\n                >\r\n                  <option value=\"\">\r\n                    {loadingOwners ? \"Loading...\" : \"All Owners\"}\r\n                  </option>\r\n                  {owners.map((owner) => (\r\n                    <option key={owner.id} value={owner.id}>\r\n                      {owner.name || owner.email || `Owner #${owner.id}`}\r\n                    </option>\r\n                  ))}\r\n                </select>\r\n              </div>\r\n            </div>\r\n          )}\r\n        </div>\r\n\r\n        {/* Status Filter Buttons */}\r\n        <div className=\"mb-6 flex flex-wrap items-center justify-center gap-2\">\r\n          {[\r\n            { label: \"All\", value: \"ALL\" },\r\n            { label: \"Pending\", value: \"PENDING\" },\r\n            { label: \"Approved\", value: \"APPROVED\" },\r\n            { label: \"Draft\", value: \"DRAFT\" },\r\n            { label: \"Need Fixes\", value: \"NEEDS_FIXES\" },\r\n            { label: \"Rejected\", value: \"REJECTED\" },\r\n            { label: \"Suspended\", value: \"SUSPENDED\" },\r\n          ].map((s) => (\r\n            <button\r\n              key={s.value}\r\n              type=\"button\"\r\n              onClick={() => setStatusFilter(s.value)}\r\n              className={`group relative px-3.5 py-1.5 rounded-lg border text-xs font-medium flex items-center gap-2 transition-all duration-200 ease-in-out ${\r\n                statusFilter === s.value\r\n                  ? 'bg-[#02665e] text-white border-[#02665e] shadow-md font-semibold'\r\n                  : 'bg-white hover:bg-gray-50 hover:border-gray-400 border-gray-300 text-gray-600 hover:shadow-sm'\r\n              }`}\r\n            >\r\n              <span>{s.label}</span>\r\n              <span className={`text-[10px] px-2 py-0.5 rounded-md font-semibold transition-all duration-200 ${\r\n                statusFilter === s.value\r\n                  ? 'bg-white/20 text-white'\r\n                  : badgeClasses(s.value)\r\n              }`}>\r\n                {counts[s.value] ?? 0}\r\n              </span>\r\n            </button>\r\n          ))}\r\n        </div>\r\n\r\n        {loading ? (\r\n          <div className=\"flex items-center justify-center py-12\">\r\n            <Loader2 className=\"h-8 w-8 animate-spin text-emerald-600\" />\r\n            <span className=\"ml-3 text-gray-600\">Loading properties...</span>\r\n          </div>\r\n        ) : properties.length === 0 ? (\r\n          <div className=\"bg-white rounded-lg border border-gray-200 p-12 text-center\">\r\n            <p className=\"text-gray-500\">No properties available for preview</p>\r\n          </div>\r\n        ) : (\r\n          <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 2xl:grid-cols-6 gap-5\">\r\n            {properties.map((property) => {\r\n              const locationParts = [\r\n                property.location?.city,\r\n                property.location?.district || property.district,\r\n                property.location?.regionName || property.regionName,\r\n              ].filter(Boolean);\r\n              const location = locationParts.join(\", \") || \"—\";\r\n\r\n              const primaryPhoto = (() => {\r\n                if (Array.isArray(property.photos)) {\r\n                  return property.photos.find(isSafeNextImageSrc) ?? null;\r\n                }\r\n                if (isSafeNextImageSrc(property.photos)) return property.photos;\r\n                return null;\r\n              })();\r\n              \r\n              const hotelStarLabels: Record<string, string> = {\r\n                \"basic\": \"1★\",\r\n                \"simple\": \"2★\",\r\n                \"moderate\": \"3★\",\r\n                \"high\": \"4★\",\r\n                \"luxury\": \"5★\",\r\n              };\r\n              const starLabel = property.hotelStar ? hotelStarLabels[property.hotelStar] || null : null;\r\n\r\n              return (\r\n              <button\r\n                key={property.id}\r\n                onClick={() => setSelectedPropertyId(property.id)}\r\n                  className=\"group bg-white rounded-2xl border border-slate-200 shadow-sm hover:shadow-md transition-shadow text-left\"\r\n                >\r\n                  {/* Title (above image) */}\r\n                  <div className=\"px-4 pt-4\">\r\n                    <div className=\"text-base font-bold text-slate-900 truncate\">{property.title}</div>\r\n                  </div>\r\n\r\n                  {/* Image */}\r\n                  <div className=\"px-4 mt-3\">\r\n                    <div className=\"relative aspect-square bg-slate-100 rounded-2xl overflow-hidden\" style={{ border: 'none' }}>\r\n                {primaryPhoto ? (\r\n                    canUseNextImageForSrc(primaryPhoto) ? (\r\n                      <Image\r\n                        src={primaryPhoto}\r\n                        alt=\"\"\r\n                        fill\r\n                        sizes=\"(min-width: 1536px) 16vw, (min-width: 1024px) 25vw, (min-width: 640px) 50vw, 100vw\"\r\n                        className=\"object-cover group-hover:scale-105 transition-transform duration-200 rounded-2xl\"\r\n                      />\r\n                    ) : (\r\n                      <img\r\n                        src={primaryPhoto}\r\n                        alt=\"\"\r\n                        className=\"object-cover group-hover:scale-105 transition-transform duration-200 rounded-2xl\"\r\n                        style={{ position: \"absolute\", inset: 0, width: \"100%\", height: \"100%\" }}\r\n                      />\r\n                    )\r\n                      ) : (\r\n                        <div className=\"absolute inset-0 flex items-center justify-center bg-gradient-to-br from-slate-100 to-slate-200 rounded-2xl\">\r\n                          <span className=\"text-slate-400 text-sm\">No image</span>\r\n                        </div>\r\n                      )}\r\n                      <div className=\"absolute inset-0 bg-gradient-to-t from-black/10 via-black/0 to-transparent rounded-2xl pointer-events-none\" />\r\n                      </div>\r\n                    </div>\r\n\r\n                  {/* Below image: location, type/status, price, and action */}\r\n                  <div className=\"p-4\">\r\n                    <div className=\"flex flex-col gap-3\">\r\n                      {/* Location */}\r\n                      <div className=\"flex items-center gap-1.5 text-xs text-slate-600\">\r\n                        <MapPin className=\"w-3.5 h-3.5 flex-shrink-0\" />\r\n                        <span className=\"truncate\">{location}</span>\r\n                      </div>\r\n\r\n                      {/* Type and Status */}\r\n                      <div className=\"flex items-center justify-between gap-2\">\r\n                        {starLabel && property.type === \"HOTEL\" ? (\r\n                          <div className=\"flex items-center gap-0.5\">\r\n                            {starLabel.split(\"\").map((char, i) => (\r\n                              <Star\r\n                                key={i}\r\n                                className={`w-3.5 h-3.5 ${\r\n                                  char === \"★\" ? \"fill-amber-400 text-amber-400\" : \"text-slate-400\"\r\n                                }`}\r\n                              />\r\n                            ))}\r\n                  </div>\r\n                ) : (\r\n                          <span className=\"text-xs font-medium text-slate-500 uppercase\">\r\n                            {property.type || \"Property\"}\r\n                          </span>\r\n                        )}\r\n                        <span className={`text-xs px-2 py-1 rounded-full flex-shrink-0 ${\r\n                      property.status === \"PENDING\" ? \"bg-amber-100 text-amber-800\" :\r\n                      property.status === \"APPROVED\" ? \"bg-emerald-100 text-emerald-800\" :\r\n                      property.status === \"REJECTED\" ? \"bg-red-100 text-red-800\" :\r\n                      property.status === \"DRAFT\" ? \"bg-gray-100 text-gray-800\" :\r\n                      property.status === \"NEEDS_FIXES\" ? \"bg-orange-100 text-orange-800\" :\r\n                      property.status === \"SUSPENDED\" ? \"bg-indigo-100 text-indigo-800\" :\r\n                      \"bg-gray-100 text-gray-800\"\r\n                    }`}>\r\n                      {property.status}\r\n                    </span>\r\n                  </div>\r\n\r\n                      {/* Price */}\r\n                      {property.basePrice && (() => {\r\n                        const commission = getPropertyCommission(property, systemCommission);\r\n                        const finalPrice = calculatePriceWithCommission(property.basePrice, commission);\r\n                        return (\r\n                          <div className=\"flex items-baseline gap-1\">\r\n                            <div className=\"text-sm font-bold text-slate-900\">\r\n                      {new Intl.NumberFormat(undefined, {\r\n                        style: \"currency\",\r\n                        currency: property.currency || \"TZS\",\r\n                                maximumFractionDigits: 0,\r\n                              }).format(finalPrice)}\r\n                            </div>\r\n                            <div className=\"text-[11px] text-slate-500\">per night</div>\r\n                    </div>\r\n                        );\r\n                      })()}\r\n\r\n                      {/* Full Preview */}\r\n                      <div className=\"mt-2\">\r\n                        <div className=\"inline-flex items-center gap-2 w-full justify-center rounded-xl bg-[#02665e] text-white py-2.5 text-sm font-semibold transition-colors group-hover:bg-[#014e47]\">\r\n                    <ScanEye className=\"h-4 w-4\" />\r\n                    <span>Full Preview</span>\r\n                        </div>\r\n                      </div>\r\n                  </div>\r\n                </div>\r\n              </button>\r\n              );\r\n            })}\r\n          </div>\r\n        )}\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\property-owner-disbursement-policy\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\referrals\\page.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadEarnings'. Either include it or remove the dependency array.","line":59,"column":6,"nodeType":"ArrayExpression","endLine":59,"endColumn":20,"suggestions":[{"desc":"Update the dependencies array to be: [loadEarnings, statusFilter]","fix":{"range":[2029,2043],"text":"[loadEarnings, statusFilter]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useEffect, useMemo, useState } from \"react\";\r\nimport { CheckCircle2, AlertCircle, Loader2, Gift, DollarSign, ShieldCheck, Ban, RefreshCw, Link as LinkIcon } from \"lucide-react\";\r\n\r\ntype Earning = {\r\n  id: number;\r\n  driverId: number;\r\n  referredUser?: { id: number; name?: string | null; email?: string | null } | null;\r\n  amount: number;\r\n  currency: string;\r\n  status: string;\r\n  bonusPaymentRef?: string | null;\r\n  withdrawalId?: number | null;\r\n  createdAt?: string;\r\n};\r\n\r\ntype Withdrawal = {\r\n  id: number;\r\n  driver?: { id: number; name?: string | null; email?: string | null; phone?: string | null } | null;\r\n  totalAmount: number;\r\n  currency: string;\r\n  status: string;\r\n  paymentMethod?: string | null;\r\n  paymentRef?: string | null;\r\n  rejectionReason?: string | null;\r\n  createdAt?: string;\r\n};\r\n\r\nconst apiBase = (process.env.NEXT_PUBLIC_API_URL || \"http://127.0.0.1:4000\").replace(/\\/$/, \"\");\r\n\r\nexport default function AdminReferralsPage() {\r\n  const [earnings, setEarnings] = useState<Earning[]>([]);\r\n  const [withdrawals, setWithdrawals] = useState<Withdrawal[]>([]);\r\n  const [statusFilter, setStatusFilter] = useState<string>(\"\");\r\n  const [loading, setLoading] = useState<boolean>(false);\r\n  const [err, setErr] = useState<string | null>(null);\r\n\r\n  const [wLoading, setWLoading] = useState<boolean>(false);\r\n  const [wErr, setWErr] = useState<string | null>(null);\r\n\r\n  const summary = useMemo(() => {\r\n    const base = { total: 0, pending: 0, bonus: 0, available: 0, withdrawn: 0 };\r\n    earnings.forEach((e) => {\r\n      const amt = Number(e.amount || 0);\r\n      base.total += amt;\r\n      const st = (e.status || \"\").toUpperCase();\r\n      if (st === \"PENDING\") base.pending += amt;\r\n      if (st === \"PAID_AS_BONUS\") base.bonus += amt;\r\n      if (st === \"AVAILABLE_FOR_WITHDRAWAL\") base.available += amt;\r\n      if (st === \"WITHDRAWN\") base.withdrawn += amt;\r\n    });\r\n    return base;\r\n  }, [earnings]);\r\n\r\n  useEffect(() => {\r\n    loadEarnings();\r\n    loadWithdrawals();\r\n  }, [statusFilter]);\r\n\r\n  async function loadEarnings(targetStatus?: string) {\r\n    setLoading(true);\r\n    setErr(null);\r\n    try {\r\n      const status = typeof targetStatus === \"string\" ? targetStatus : statusFilter;\r\n      const url = `${apiBase}/admin/referral-earnings${status ? `?status=${encodeURIComponent(status)}` : \"\"}`;\r\n      const r = await fetch(url);\r\n      if (!r.ok) throw new Error(`Failed to load (${r.status})`);\r\n      const j = await r.json();\r\n      setEarnings(j.earnings || []);\r\n    } catch (e: any) {\r\n      setErr(e?.message || \"Failed to load referral earnings\");\r\n      setEarnings([]);\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  }\r\n\r\n  async function loadWithdrawals() {\r\n    setWLoading(true);\r\n    setWErr(null);\r\n    try {\r\n      const url = `${apiBase}/admin/referral-earnings/withdrawals`;\r\n      const r = await fetch(url);\r\n      if (!r.ok) throw new Error(`Failed to load (${r.status})`);\r\n      const j = await r.json();\r\n      setWithdrawals(j.withdrawals || []);\r\n    } catch (e: any) {\r\n      setWErr(e?.message || \"Failed to load withdrawals\");\r\n      setWithdrawals([]);\r\n    } finally {\r\n      setWLoading(false);\r\n    }\r\n  }\r\n\r\n  async function markAsBonus(earningId: number) {\r\n    const ref = prompt(\"Bonus payment reference\", `BONUS-${earningId}-${Date.now()}`);\r\n    if (!ref) return;\r\n    try {\r\n      await fetch(`${apiBase}/admin/referral-earnings/mark-as-bonus`, {\r\n        method: \"POST\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify({ earningIds: [earningId], bonusPaymentRef: ref }),\r\n      });\r\n      await loadEarnings();\r\n    } catch (e) {\r\n      alert(\"Failed to mark as bonus\");\r\n    }\r\n  }\r\n\r\n  async function approveWithdrawal(id: number) {\r\n    try {\r\n      await fetch(`${apiBase}/admin/referral-earnings/withdrawals/${id}/approve`, { method: \"POST\" });\r\n      await loadWithdrawals();\r\n      await loadEarnings();\r\n    } catch {\r\n      alert(\"Failed to approve\");\r\n    }\r\n  }\r\n\r\n  async function rejectWithdrawal(id: number) {\r\n    const reason = prompt(\"Reason for rejection\", \"Not eligible\");\r\n    if (!reason) return;\r\n    try {\r\n      await fetch(`${apiBase}/admin/referral-earnings/withdrawals/${id}/reject`, {\r\n        method: \"POST\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify({ rejectionReason: reason }),\r\n      });\r\n      await loadWithdrawals();\r\n      await loadEarnings();\r\n    } catch {\r\n      alert(\"Failed to reject\");\r\n    }\r\n  }\r\n\r\n  async function markPaid(id: number) {\r\n    const ref = prompt(\"Payment reference\", \"\");\r\n    try {\r\n      await fetch(`${apiBase}/admin/referral-earnings/withdrawals/${id}/mark-paid`, {\r\n        method: \"POST\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify({ paymentRef: ref }),\r\n      });\r\n      await loadWithdrawals();\r\n      await loadEarnings();\r\n    } catch {\r\n      alert(\"Failed to mark paid\");\r\n    }\r\n  }\r\n\r\n  const statusBadge = (s: string) => {\r\n    const v = (s || \"\").toUpperCase();\r\n    if (v === \"PAID_AS_BONUS\") return \"bg-emerald-50 text-emerald-700 border-emerald-200\";\r\n    if (v === \"AVAILABLE_FOR_WITHDRAWAL\") return \"bg-blue-50 text-blue-700 border-blue-200\";\r\n    if (v === \"WITHDRAWN\") return \"bg-gray-100 text-gray-700 border-gray-200\";\r\n    if (v === \"PENDING\") return \"bg-amber-50 text-amber-700 border-amber-200\";\r\n    return \"bg-slate-50 text-slate-700 border-slate-200\";\r\n  };\r\n\r\n  const showError = err && !err.toLowerCase().includes(\"networkerror\");\r\n  const showWithdrawalsError = wErr && !wErr.toLowerCase().includes(\"networkerror\");\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      <div className=\"bg-white border border-slate-200 rounded-lg p-6 shadow-sm\">\r\n        <div className=\"flex flex-col gap-2 mb-4 text-center items-center\">\r\n          <div className=\"inline-flex items-center gap-2\">\r\n            <Gift className=\"w-5 h-5 text-slate-500\" />\r\n            <h1 className=\"text-xl font-semibold text-slate-900\">Referral Credits</h1>\r\n          </div>\r\n          <p className=\"text-sm text-slate-600\">Decide whether collected credits become bonuses or withdrawals.</p>\r\n          <div className=\"flex flex-wrap justify-center gap-3 text-sm\">\r\n            <button\r\n              type=\"button\"\r\n              onClick={() => {\r\n                setStatusFilter(\"\");\r\n                loadEarnings(\"\");\r\n              }}\r\n              className=\"px-3 py-1 rounded-full bg-slate-100 text-slate-700 hover:bg-slate-200 transition border border-slate-200\"\r\n            >\r\n              Total: {summary.total.toLocaleString()} TZS\r\n            </button>\r\n            <span className=\"px-3 py-1 rounded-full bg-amber-100 text-amber-800\">Pending: {summary.pending.toLocaleString()} TZS</span>\r\n            <span className=\"px-3 py-1 rounded-full bg-blue-100 text-blue-800\">Available: {summary.available.toLocaleString()} TZS</span>\r\n            <span className=\"px-3 py-1 rounded-full bg-emerald-100 text-emerald-800\">Bonus: {summary.bonus.toLocaleString()} TZS</span>\r\n            <span className=\"px-3 py-1 rounded-full bg-gray-100 text-gray-700\">Withdrawn: {summary.withdrawn.toLocaleString()} TZS</span>\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"flex items-center gap-2 mb-3\">\r\n          <label className=\"text-sm text-slate-700\">Filter by status:</label>\r\n          <select\r\n            value={statusFilter}\r\n            onChange={(e) => setStatusFilter(e.target.value)}\r\n            className=\"border border-slate-300 rounded-md px-2 py-1 text-sm\"\r\n          >\r\n            <option value=\"\">All</option>\r\n            <option value=\"PENDING\">Pending</option>\r\n            <option value=\"AVAILABLE_FOR_WITHDRAWAL\">Available for withdrawal</option>\r\n            <option value=\"PAID_AS_BONUS\">Paid as bonus</option>\r\n            <option value=\"WITHDRAWN\">Withdrawn</option>\r\n          </select>\r\n          <button\r\n            className=\"inline-flex items-center gap-2 text-sm text-slate-700 hover:text-slate-900\"\r\n            onClick={() => loadEarnings()}\r\n          >\r\n            <RefreshCw className=\"w-4 h-4\" /> Refresh\r\n          </button>\r\n        </div>\r\n\r\n        {showError && (\r\n          <div className=\"flex items-center gap-2 text-sm text-red-700 bg-red-50 border border-red-200 rounded-md px-3 py-2 mb-3\">\r\n            <AlertCircle className=\"w-4 h-4\" /> {err}\r\n          </div>\r\n        )}\r\n\r\n        <div className=\"overflow-auto border border-slate-200 rounded-lg\">\r\n          <table className=\"min-w-full text-sm\">\r\n            <thead className=\"bg-slate-50\">\r\n              <tr>\r\n                <th className=\"text-left px-3 py-2 font-semibold text-slate-700\">ID</th>\r\n                <th className=\"text-left px-3 py-2 font-semibold text-slate-700\">Driver</th>\r\n                <th className=\"text-left px-3 py-2 font-semibold text-slate-700\">Referred User</th>\r\n                <th className=\"text-left px-3 py-2 font-semibold text-slate-700\">Amount</th>\r\n                <th className=\"text-left px-3 py-2 font-semibold text-slate-700\">Status</th>\r\n                <th className=\"text-left px-3 py-2 font-semibold text-slate-700\">Refs</th>\r\n                <th className=\"text-left px-3 py-2 font-semibold text-slate-700\">Actions</th>\r\n              </tr>\r\n            </thead>\r\n            <tbody>\r\n              {loading ? (\r\n                <tr>\r\n                  <td colSpan={7} className=\"px-3 py-4 text-center text-slate-500\">\r\n                    <span className=\"inline-flex items-center gap-2\">\r\n                      <Loader2 className=\"w-4 h-4 animate-spin\" /> Loading...\r\n                    </span>\r\n                  </td>\r\n                </tr>\r\n              ) : earnings.length === 0 ? (\r\n                <tr>\r\n                  <td colSpan={7} className=\"px-3 py-4 text-center text-slate-500\">\r\n                    No referral credits found.\r\n                  </td>\r\n                </tr>\r\n              ) : (\r\n                earnings.map((e) => (\r\n                  <tr key={e.id} className=\"border-t border-slate-100\">\r\n                    <td className=\"px-3 py-2\">{e.id}</td>\r\n                    <td className=\"px-3 py-2 text-slate-800\">{e.driverId}</td>\r\n                    <td className=\"px-3 py-2 text-slate-700\">\r\n                      {e.referredUser?.name || e.referredUser?.email || e.referredUser?.id || \"-\"}\r\n                    </td>\r\n                    <td className=\"px-3 py-2 font-semibold text-slate-900\">\r\n                      {Number(e.amount || 0).toLocaleString()} {e.currency || \"TZS\"}\r\n                    </td>\r\n                    <td className=\"px-3 py-2\">\r\n                      <span className={`inline-flex items-center px-2 py-1 rounded-md border text-xs font-medium ${statusBadge(e.status)}`}>\r\n                        {e.status}\r\n                      </span>\r\n                    </td>\r\n                    <td className=\"px-3 py-2 text-xs text-slate-600 space-y-1\">\r\n                      {e.bonusPaymentRef && (\r\n                        <div className=\"flex items-center gap-1\">\r\n                          <Gift className=\"w-3 h-3 text-emerald-600\" /> {e.bonusPaymentRef}\r\n                        </div>\r\n                      )}\r\n                      {e.withdrawalId && (\r\n                        <div className=\"flex items-center gap-1\">\r\n                          <DollarSign className=\"w-3 h-3 text-blue-600\" /> WD #{e.withdrawalId}\r\n                        </div>\r\n                      )}\r\n                    </td>\r\n                    <td className=\"px-3 py-2\">\r\n                      {(e.status === \"PENDING\" || e.status === \"AVAILABLE_FOR_WITHDRAWAL\") && (\r\n                        <button\r\n                          onClick={() => markAsBonus(e.id)}\r\n                          className=\"inline-flex items-center gap-1 px-2 py-1 text-xs font-semibold rounded-md bg-emerald-50 text-emerald-700 border border-emerald-200 hover:bg-emerald-100\"\r\n                        >\r\n                          <CheckCircle2 className=\"w-3 h-3\" /> Mark bonus\r\n                        </button>\r\n                      )}\r\n                      {e.status === \"PAID_AS_BONUS\" && (\r\n                        <span className=\"text-xs text-emerald-700 inline-flex items-center gap-1\">\r\n                          <ShieldCheck className=\"w-3 h-3\" /> Bonus\r\n                        </span>\r\n                      )}\r\n                    </td>\r\n                  </tr>\r\n                ))\r\n              )}\r\n            </tbody>\r\n          </table>\r\n        </div>\r\n      </div>\r\n\r\n      <div className=\"bg-white border border-slate-200 rounded-lg p-6 shadow-sm\">\r\n        <div className=\"flex items-center gap-2 mb-3\">\r\n          <DollarSign className=\"w-5 h-5 text-slate-500\" />\r\n          <h2 className=\"text-lg font-semibold text-slate-900\">Withdrawal requests</h2>\r\n          <button\r\n            className=\"inline-flex items-center gap-2 text-sm text-slate-700 hover:text-slate-900 ml-auto\"\r\n            onClick={() => loadWithdrawals()}\r\n          >\r\n            <RefreshCw className=\"w-4 h-4\" /> Refresh\r\n          </button>\r\n        </div>\r\n\r\n        {showWithdrawalsError && (\r\n          <div className=\"flex items-center gap-2 text-sm text-red-700 bg-red-50 border border-red-200 rounded-md px-3 py-2 mb-3\">\r\n            <AlertCircle className=\"w-4 h-4\" /> {wErr}\r\n          </div>\r\n        )}\r\n\r\n        <div className=\"overflow-auto border border-slate-200 rounded-lg\">\r\n          <table className=\"min-w-full text-sm\">\r\n            <thead className=\"bg-slate-50\">\r\n              <tr>\r\n                <th className=\"text-left px-3 py-2 font-semibold text-slate-700\">ID</th>\r\n                <th className=\"text-left px-3 py-2 font-semibold text-slate-700\">Driver</th>\r\n                <th className=\"text-left px-3 py-2 font-semibold text-slate-700\">Amount</th>\r\n                <th className=\"text-left px-3 py-2 font-semibold text-slate-700\">Status</th>\r\n                <th className=\"text-left px-3 py-2 font-semibold text-slate-700\">Payment</th>\r\n                <th className=\"text-left px-3 py-2 font-semibold text-slate-700\">Actions</th>\r\n              </tr>\r\n            </thead>\r\n            <tbody>\r\n              {wLoading ? (\r\n                <tr>\r\n                  <td colSpan={6} className=\"px-3 py-4 text-center text-slate-500\">\r\n                    <span className=\"inline-flex items-center gap-2\">\r\n                      <Loader2 className=\"w-4 h-4 animate-spin\" /> Loading...\r\n                    </span>\r\n                  </td>\r\n                </tr>\r\n              ) : withdrawals.length === 0 ? (\r\n                <tr>\r\n                  <td colSpan={6} className=\"px-3 py-4 text-center text-slate-500\">\r\n                    No withdrawal requests found.\r\n                  </td>\r\n                </tr>\r\n              ) : (\r\n                withdrawals.map((w) => (\r\n                  <tr key={w.id} className=\"border-t border-slate-100\">\r\n                    <td className=\"px-3 py-2\">{w.id}</td>\r\n                    <td className=\"px-3 py-2 text-slate-800\">\r\n                      {w.driver?.name || w.driver?.email || `Driver #${w.driver?.id ?? \"\"}`}\r\n                    </td>\r\n                    <td className=\"px-3 py-2 font-semibold text-slate-900\">\r\n                      {Number(w.totalAmount || 0).toLocaleString()} {w.currency || \"TZS\"}\r\n                    </td>\r\n                    <td className=\"px-3 py-2\">\r\n                      <span className={`inline-flex items-center px-2 py-1 rounded-md border text-xs font-medium ${statusBadge(w.status)}`}>\r\n                        {w.status}\r\n                      </span>\r\n                    </td>\r\n                    <td className=\"px-3 py-2 text-xs text-slate-600 space-y-1\">\r\n                      {w.paymentMethod && (\r\n                        <div className=\"flex items-center gap-1\">\r\n                          <LinkIcon className=\"w-3 h-3 text-slate-500\" /> {w.paymentMethod}\r\n                        </div>\r\n                      )}\r\n                      {w.paymentRef && (\r\n                        <div className=\"flex items-center gap-1\">\r\n                          <LinkIcon className=\"w-3 h-3 text-slate-500\" /> {w.paymentRef}\r\n                        </div>\r\n                      )}\r\n                    </td>\r\n                    <td className=\"px-3 py-2 space-x-2\">\r\n                      {w.status === \"PENDING\" && (\r\n                        <>\r\n                          <button\r\n                            onClick={() => approveWithdrawal(w.id)}\r\n                            className=\"inline-flex items-center gap-1 px-2 py-1 text-xs font-semibold rounded-md bg-emerald-50 text-emerald-700 border border-emerald-200 hover:bg-emerald-100\"\r\n                          >\r\n                            <CheckCircle2 className=\"w-3 h-3\" /> Approve\r\n                          </button>\r\n                          <button\r\n                            onClick={() => rejectWithdrawal(w.id)}\r\n                            className=\"inline-flex items-center gap-1 px-2 py-1 text-xs font-semibold rounded-md bg-red-50 text-red-700 border border-red-200 hover:bg-red-100\"\r\n                          >\r\n                            <Ban className=\"w-3 h-3\" /> Reject\r\n                          </button>\r\n                        </>\r\n                      )}\r\n                      {w.status === \"APPROVED\" && (\r\n                        <button\r\n                          onClick={() => markPaid(w.id)}\r\n                          className=\"inline-flex items-center gap-1 px-2 py-1 text-xs font-semibold rounded-md bg-blue-50 text-blue-700 border border-blue-200 hover:bg-blue-100\"\r\n                        >\r\n                          <DollarSign className=\"w-3 h-3\" /> Mark paid\r\n                        </button>\r\n                      )}\r\n                      {w.status === \"PAID\" && (\r\n                        <span className=\"text-xs text-emerald-700 inline-flex items-center gap-1\">\r\n                          <ShieldCheck className=\"w-3 h-3\" /> Paid\r\n                        </span>\r\n                      )}\r\n                      {w.status === \"REJECTED\" && (\r\n                        <span className=\"text-xs text-red-700 inline-flex items-center gap-1\">\r\n                          <AlertCircle className=\"w-3 h-3\" /> Rejected\r\n                        </span>\r\n                      )}\r\n                    </td>\r\n                  </tr>\r\n                ))\r\n              )}\r\n            </tbody>\r\n          </table>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\reports\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\revenue\\[id]\\page.tsx","messages":[],"suppressedMessages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":322,"column":27,"nodeType":"JSXOpeningElement","endLine":326,"endColumn":29,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\revenue\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'wsUrl' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":290,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":290,"endColumn":16}],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'load'. Either include it or remove the dependency array.","line":265,"column":6,"nodeType":"ArrayExpression","endLine":265,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [load]","fix":{"range":[10098,10100],"text":"[load]"}}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'load'. Either include it or remove the dependency array.","line":276,"column":6,"nodeType":"ArrayExpression","endLine":276,"endColumn":101,"suggestions":[{"desc":"Update the dependencies array to be: [status, from, to, q, page, sortBy, sortDir, ownerFilter, propertyFilter, amountMin, amountMax, load]","fix":{"range":[10471,10566],"text":"[status, from, to, q, page, sortBy, sortDir, ownerFilter, propertyFilter, amountMin, amountMax, load]"}}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'fetchCounts' and 'load'. Either include them or remove the dependency array.","line":341,"column":6,"nodeType":"ArrayExpression","endLine":341,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [fetchCounts, load]","fix":{"range":[12582,12584],"text":"[fetchCounts, load]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useEffect, useMemo, useRef, useState } from \"react\";\nimport { Wallet, Calendar, Eye, DollarSign, Building2, Receipt, FileText, Download, ChevronLeft, ChevronRight, ArrowUpDown, CheckSquare, Square, Printer, Filter, X, CheckCircle2, ArrowUp, ArrowDown } from \"lucide-react\";\nimport DatePicker from \"@/components/ui/DatePicker\";\nimport TableRow from \"@/components/TableRow\";\nimport axios from \"axios\";\nimport { io, Socket } from \"socket.io-client\";\nimport Link from \"next/link\";\n\n// Use same-origin calls + secure httpOnly cookie session.\nconst api = axios.create({ \n  baseURL: \"\", \n  withCredentials: true,\n  headers: {\n    'Content-Type': 'application/json',\n    'Accept': 'application/json',\n  },\n  responseType: 'json',\n});\n\ntype InvoiceRow = {\n  id: number;\n  invoiceNumber: string | null;\n  receiptNumber: string | null;\n  status: string;\n  issuedAt: string; // ISO\n  total: number;\n  commissionPercent: number;\n  commissionAmount: number;\n  taxPercent: number;\n  netPayable: number;\n  booking: { id: number; property: { id: number; title: string } };\n};\n\nexport default function AdminRevenue() {\n  const [status, setStatus] = useState<string>(\"\");\n  const [from, setFrom] = useState<string>(\"\");\n  const [to, setTo] = useState<string>(\"\");\n  const [date, setDate] = useState<string | string[]>(\"\");\n  const [pickerAnim, setPickerAnim] = useState(false);\n  const [pickerOpen, setPickerOpen] = useState(false);\n  const searchRef = useRef<HTMLInputElement | null>(null);\n\n  // keep legacy from/to in sync with the DatePicker selection\n  useEffect(() => {\n    if (!date) return;\n    if (Array.isArray(date)) {\n      setFrom(date[0] || \"\");\n      setTo(date[1] || \"\");\n    } else {\n      setFrom(date as string);\n      setTo(date as string);\n    }\n  }, [date]);\n\n  // autofocus search input on load\n  useEffect(() => {\n    try {\n      searchRef.current?.focus();\n    } catch (e) {\n      // ignore if not available\n    }\n  }, []);\n  const [q, setQ] = useState(\"\");\n  const [items, setItems] = useState<InvoiceRow[]>([]);\n  const [loading, setLoading] = useState(true);\n  const [counts, setCounts] = useState<Record<string, number>>({});\n  const [page, setPage] = useState(1);\n  const [total, setTotal] = useState(0);\n  const pageSize = 25;\n  \n  // Sorting\n  const [sortBy, setSortBy] = useState<string | null>(null);\n  const [sortDir, setSortDir] = useState<\"asc\" | \"desc\">(\"desc\");\n  \n  // Bulk selection\n  const [selectedIds, setSelectedIds] = useState<Set<number>>(new Set());\n  const [bulkActionLoading, setBulkActionLoading] = useState(false);\n  \n  // Advanced filters\n  const [showAdvancedFilters, setShowAdvancedFilters] = useState(false);\n  const [ownerFilter, setOwnerFilter] = useState<string>(\"\");\n  const [propertyFilter, setPropertyFilter] = useState<string>(\"\");\n  const [amountMin, setAmountMin] = useState<string>(\"\");\n  const [amountMax, setAmountMax] = useState<string>(\"\");\n  const [owners, setOwners] = useState<Array<{ id: number; name: string | null; email: string }>>([]);\n  const [properties, setProperties] = useState<Array<{ id: number; title: string }>>([]);\n\n  // Load owners and properties for filters (optional - filters will work without this)\n  useEffect(() => {\n    (async () => {\n      try {\n        // Try to load owners and properties, but don't fail if endpoints don't exist\n        const [ownersRes, propertiesRes] = await Promise.all([\n          api.get(\"/api/admin/users\", { \n            params: { role: \"OWNER\", page: 1, pageSize: 100 },\n            headers: { 'Accept': 'application/json' },\n          }).catch((err: any) => {\n            console.warn(\"Failed to load owners for filter:\", err?.response?.status || err?.message);\n            return { data: { data: [] } };\n          }),\n          api.get(\"/api/admin/properties\", { \n            params: { status: \"APPROVED\", page: 1, pageSize: 100 },\n            headers: { 'Accept': 'application/json' },\n          }).catch((err: any) => {\n            console.warn(\"Failed to load properties for filter:\", err?.response?.status || err?.message);\n            return { data: { items: [] } };\n          }),\n        ]);\n        const ownersData = (ownersRes.data as any)?.data || [];\n        const propertiesData = (propertiesRes.data as any)?.items || [];\n        setOwners(ownersData.map((u: any) => ({ id: u.id, name: u.name, email: u.email || \"\" })));\n        setProperties(propertiesData.map((p: any) => ({ id: p.id, title: p.title || \"\" })));\n      } catch (e) {\n        // ignore - filters will still work with manual entry\n        console.warn(\"Error loading filter data:\", e);\n      }\n    })();\n  }, []);\n\n  async function load() {\n    setLoading(true);\n    try {\n      const params: any = {\n        from: from || undefined,\n        to: to || undefined,\n        q: q || undefined,\n        page,\n        pageSize,\n      };\n      \n      // Advanced filters\n      if (ownerFilter) params.ownerId = Number(ownerFilter);\n      if (propertyFilter) params.propertyId = Number(propertyFilter);\n      if (amountMin) params.amountMin = Number(amountMin);\n      if (amountMax) params.amountMax = Number(amountMax);\n      \n      // Sorting\n      if (sortBy) {\n        params.sortBy = sortBy;\n        params.sortDir = sortDir;\n      }\n\n      // If \"New\" is selected we treat it as REQUESTED + VERIFIED (combine both)\n      if (status === \"REQUESTED\") {\n        const [r1, r2] = await Promise.all([\n          api.get<{ items: InvoiceRow[]; total: number }>(\"/api/admin/revenue/invoices\", {\n            params: { ...params, status: \"REQUESTED\" },\n          }),\n          api.get<{ items: InvoiceRow[]; total: number }>(\"/api/admin/revenue/invoices\", {\n            params: { ...params, status: \"VERIFIED\" },\n          }),\n        ]);\n\n        // merge and dedupe by id\n        const map = new Map<number, InvoiceRow>();\n        (r1.data.items || []).forEach((it) => map.set(it.id, it));\n        (r2.data.items || []).forEach((it) => map.set(it.id, it));\n        let merged = Array.from(map.values());\n        \n        // Client-side sorting for merged results\n        if (sortBy) {\n          merged = [...merged].sort((a, b) => {\n            let aVal: any, bVal: any;\n            switch (sortBy) {\n              case \"invoiceNumber\":\n                aVal = a.invoiceNumber ?? a.id;\n                bVal = b.invoiceNumber ?? b.id;\n                break;\n              case \"issuedAt\":\n                aVal = new Date(a.issuedAt).getTime();\n                bVal = new Date(b.issuedAt).getTime();\n                break;\n              case \"total\":\n                aVal = Number(a.total);\n                bVal = Number(b.total);\n                break;\n              case \"netPayable\":\n                aVal = Number(a.netPayable);\n                bVal = Number(b.netPayable);\n                break;\n              default:\n                return 0;\n            }\n            if (aVal < bVal) return sortDir === \"asc\" ? -1 : 1;\n            if (aVal > bVal) return sortDir === \"asc\" ? 1 : -1;\n            return 0;\n          });\n        }\n        \n        setItems(merged);\n        // Use the larger total from the two requests\n        setTotal(Math.max(r1.data.total || 0, r2.data.total || 0));\n      } else {\n        const r = await api.get<{ items: InvoiceRow[]; total: number }>(\"/api/admin/revenue/invoices\", {\n          params: { ...params, status: status || undefined },\n        });\n        setItems(r.data.items || []);\n        setTotal(r.data.total || 0);\n      }\n    } catch (e: any) {\n      // Handle errors gracefully - log but don't crash\n      console.error(\"Error loading invoices:\", e?.response?.data || e?.message || e);\n      setItems([]);\n      setTotal(0);\n      \n      // If it's a network error or non-JSON response, show a user-friendly message\n      if (e?.response?.status === 0 || !e?.response?.data) {\n        console.warn(\"Network error or non-JSON response received\");\n      }\n    } finally {\n      setLoading(false);\n    }\n  }\n\n  // reusable counts fetch (used on mount, when date range changes, and when invoices update via socket)\n  const fetchCounts = useMemo(() => {\n    return async function () {\n      try {\n        const statuses = [\"\", \"REQUESTED\", \"VERIFIED\", \"APPROVED\", \"PAID\", \"REJECTED\"];\n        const map: Record<string, number> = {};\n\n        // helper to fetch total for a given status\n        const getTotal = async (s: string) => {\n          if (s === \"\") {\n            const r = await api.get(\"/api/admin/revenue/invoices\", { params: { from: from || undefined, to: to || undefined, page: 1, pageSize: 1 } });\n            return (r?.data?.total ?? (Array.isArray(r?.data?.items) ? r.data.items.length : 0)) as number;\n          }\n\n          if (s === \"REQUESTED\") {\n            // New = REQUESTED + VERIFIED\n            const [a, b] = await Promise.all([\n              api.get(\"/api/admin/revenue/invoices\", { params: { status: \"REQUESTED\", from: from || undefined, to: to || undefined, page: 1, pageSize: 1 } }),\n              api.get(\"/api/admin/revenue/invoices\", { params: { status: \"VERIFIED\", from: from || undefined, to: to || undefined, page: 1, pageSize: 1 } }),\n            ]);\n            const ta = (a?.data?.total ?? (Array.isArray(a?.data?.items) ? a.data.items.length : 0)) as number;\n            const tb = (b?.data?.total ?? (Array.isArray(b?.data?.items) ? b.data.items.length : 0)) as number;\n            return ta + tb;\n          }\n\n          const r = await api.get(\"/api/admin/revenue/invoices\", { params: { status: s || undefined, from: from || undefined, to: to || undefined, page: 1, pageSize: 1 } });\n          return (r?.data?.total ?? (Array.isArray(r?.data?.items) ? r.data.items.length : 0)) as number;\n        };\n\n        for (const s of statuses) {\n          try {\n            map[s || ''] = await getTotal(s);\n          } catch (e) {\n            map[s || ''] = 0;\n          }\n        }\n\n        setCounts(map);\n      } catch (e) {\n        // ignore failures\n      }\n    };\n  }, [from, to]);\n\n  // initial auth + first load\n  useEffect(() => {\n    load();\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, []);\n\n  // reload on filter change or page change\n  useEffect(() => {\n    setPage(1); // Reset to page 1 when filters change\n    setSelectedIds(new Set()); // Clear selection when filters change\n  }, [status, from, to, q, ownerFilter, propertyFilter, amountMin, amountMax]);\n\n  useEffect(() => {\n    load();\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [status, from, to, q, page, sortBy, sortDir, ownerFilter, propertyFilter, amountMin, amountMax]);\n\n  // Fetch counts for each status so we can show badges on the filter pills (best-effort)\n  useEffect(() => {\n    fetchCounts();\n  }, [fetchCounts]);\n\n  // 🔌 Socket.io: refresh when an invoice is marked PAID by webhook/admin action\n  useEffect(() => {\n    if (typeof window === 'undefined') return;\n    \n    // Use direct API URL for Socket.IO in browser to ensure WebSocket works in dev\n    // Convert http:// to ws:// for WebSocket connections\n    const apiUrl = process.env.NEXT_PUBLIC_SOCKET_URL || process.env.NEXT_PUBLIC_API_URL || \"http://localhost:4000\";\n    const wsUrl = apiUrl.replace(/^http/, 'ws');\n    \n    let s: Socket | null = null;\n    try {\n      s = io(apiUrl, { \n        transports: ['websocket', 'polling'],\n        reconnection: true,\n        reconnectionAttempts: 5,\n        reconnectionDelay: 2000,\n        reconnectionDelayMax: 10000,\n        timeout: 20000,\n        autoConnect: true,\n        forceNew: false,\n      });\n\n      const refresh = () => {\n        load();\n        fetchCounts();\n      };\n\n      s.on(\"admin:invoice:paid\", refresh);\n      s.on(\"admin:invoice:status\", refresh);\n      s.on(\"connect\", () => {\n        console.debug(\"Socket.IO connected successfully\");\n      });\n      s.on(\"connect_error\", (err) => {\n        // Only log as warning, don't throw - Socket.IO will retry\n        console.warn(\"Socket.IO connection error:\", err.message);\n      });\n      s.on(\"disconnect\", (reason) => {\n        console.log(\"Socket.IO disconnected:\", reason);\n      });\n    } catch (err) {\n      console.error(\"Failed to initialize Socket.IO:\", err);\n    }\n\n    return () => {\n      if (s) {\n        try {\n          s.off(\"admin:invoice:paid\");\n          s.off(\"admin:invoice:status\");\n          s.off(\"connect\");\n          s.off(\"connect_error\");\n          s.off(\"disconnect\");\n          s.disconnect();\n        } catch (err) {\n          console.warn(\"Error cleaning up Socket.IO:\", err);\n        }\n      }\n    };\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, []);\n\n  const sumNet = useMemo(\n    () => items.reduce((s, i) => s + Number(i.netPayable || 0), 0),\n    [items]\n  );\n\n  const emptyMessage = useMemo(() => {\n    if (status === \"\") return \"No invoices.\";\n    if (status === \"REQUESTED\") return \"No new invoices.\";\n    const map: Record<string, string> = {\n      VERIFIED: \"No verified invoices.\",\n      APPROVED: \"No approved invoices.\",\n      PAID: \"No paid invoices.\",\n      REJECTED: \"No rejected invoices.\",\n    };\n    return map[status] ?? \"No invoices.\";\n  }, [status]);\n\n  // Bulk selection functions\n  const toggleSelect = (id: number) => {\n    setSelectedIds(prev => {\n      const next = new Set(prev);\n      if (next.has(id)) {\n        next.delete(id);\n      } else {\n        next.add(id);\n      }\n      return next;\n    });\n  };\n\n  const toggleSelectAll = () => {\n    if (selectedIds.size === items.length) {\n      setSelectedIds(new Set());\n    } else {\n      setSelectedIds(new Set(items.map(i => i.id)));\n    }\n  };\n\n  const clearSelection = () => {\n    setSelectedIds(new Set());\n  };\n\n  // Bulk actions\n  async function bulkApprove() {\n    if (selectedIds.size === 0) return;\n    if (!window.confirm(`Approve ${selectedIds.size} invoice(s)?`)) return;\n    \n    setBulkActionLoading(true);\n    try {\n      const promises = Array.from(selectedIds).map(id =>\n        api.post(`/api/admin/revenue/invoices/${id}/approve`).catch(err => ({ error: err }))\n      );\n      await Promise.all(promises);\n      await load();\n      clearSelection();\n      alert(`Successfully approved ${selectedIds.size} invoice(s)`);\n    } catch (err) {\n      console.error(\"Bulk approve failed\", err);\n      alert(\"Some invoices failed to approve. Please check individually.\");\n    } finally {\n      setBulkActionLoading(false);\n    }\n  }\n\n  async function bulkMarkPaid() {\n    if (selectedIds.size === 0) return;\n    const paymentRef = prompt(`Enter payment reference for ${selectedIds.size} invoice(s):`);\n    if (!paymentRef) return;\n    \n    setBulkActionLoading(true);\n    try {\n      const promises = Array.from(selectedIds).map(id =>\n        api.post(`/api/admin/revenue/invoices/${id}/mark-paid`, { method: \"BANK\", ref: paymentRef }).catch(err => ({ error: err }))\n      );\n      await Promise.all(promises);\n      await load();\n      clearSelection();\n      alert(`Successfully marked ${selectedIds.size} invoice(s) as paid`);\n    } catch (err) {\n      console.error(\"Bulk mark paid failed\", err);\n      alert(\"Some invoices failed to mark as paid. Please check individually.\");\n    } finally {\n      setBulkActionLoading(false);\n    }\n  }\n\n  // Print function\n  const handlePrint = () => {\n    window.print();\n  };\n\n  // Sort handler\n  const handleSort = (column: string) => {\n    if (sortBy === column) {\n      setSortDir(prev => prev === \"asc\" ? \"desc\" : \"asc\");\n    } else {\n      setSortBy(column);\n      setSortDir(\"asc\");\n    }\n    setPage(1);\n  };\n\n  function getStatusBadge(status: string) {\n    const statusLower = status.toLowerCase();\n    if (statusLower === 'paid') {\n      return (\n        <span className=\"inline-flex items-center px-2.5 py-1 rounded-full bg-green-100 text-green-800 text-xs font-medium\">\n          {status}\n        </span>\n      );\n    }\n    if (statusLower === 'approved') {\n      return (\n        <span className=\"inline-flex items-center px-2.5 py-1 rounded-full bg-emerald-100 text-emerald-800 text-xs font-medium\">\n          {status}\n        </span>\n      );\n    }\n    if (statusLower === 'verified') {\n      return (\n        <span className=\"inline-flex items-center px-2.5 py-1 rounded-full bg-blue-100 text-blue-800 text-xs font-medium\">\n          {status}\n        </span>\n      );\n    }\n    if (statusLower === 'requested') {\n      return (\n        <span className=\"inline-flex items-center px-2.5 py-1 rounded-full bg-yellow-100 text-yellow-800 text-xs font-medium\">\n          {status}\n        </span>\n      );\n    }\n    if (statusLower === 'rejected') {\n      return (\n        <span className=\"inline-flex items-center px-2.5 py-1 rounded-full bg-red-100 text-red-800 text-xs font-medium\">\n          {status}\n        </span>\n      );\n    }\n    return (\n      <span className=\"inline-flex items-center px-2.5 py-1 rounded-full bg-gray-100 text-gray-800 text-xs font-medium\">\n        {status}\n      </span>\n    );\n  }\n\n  return (\n    <div className=\"max-w-7xl mx-auto px-3 sm:px-4 lg:px-6 xl:px-8 py-4 sm:py-6 space-y-4 sm:space-y-6 min-w-0\">\n      {/* Header */}\n      <div className=\"bg-white rounded-xl border border-gray-200 p-4 sm:p-6 shadow-sm\">\n      <div className=\"flex flex-col items-center text-center\">\n          <div className=\"rounded-full bg-[#02665e]/10 p-3 inline-flex items-center justify-center mb-3\">\n            <Wallet className=\"h-6 w-6 text-[#02665e]\" aria-hidden />\n          </div>\n          <h1 className=\"text-xl sm:text-2xl font-semibold text-gray-900\">Revenue (Invoices &amp; Payouts)</h1>\n          <p className=\"mt-2 text-xs sm:text-sm text-gray-500\">Invoices, payouts and exports</p>\n        </div>\n      </div>\n\n      {/* Filters */}\n      <div className=\"bg-white rounded-xl border border-gray-200 p-3 sm:p-4 lg:p-6 shadow-sm overflow-hidden\">\n        <div className=\"flex flex-col gap-3 sm:gap-4\">\n          {/* Search */}\n          <div className=\"w-full min-w-0 max-w-full\">\n            <div className=\"relative w-full min-w-0 max-w-full\">\n                <input\n                  ref={searchRef}\n                className=\"w-full min-w-0 max-w-full pl-9 sm:pl-10 pr-3 sm:pr-4 py-2 sm:py-2.5 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-[#02665e] focus:border-[#02665e] outline-none text-xs sm:text-sm transition-all box-border\"\n                  placeholder=\"Search # / receipt / property\"\n                  value={q}\n                  onChange={(e) => setQ(e.target.value)}\n                onKeyDown={(e) => { if (e.key === 'Enter') { e.preventDefault(); load(); } }}\n                  aria-label=\"Search invoices\"\n                style={{ boxSizing: 'border-box', maxWidth: '100%' }}\n                />\n              <FileText className=\"absolute left-2.5 sm:left-3 top-1/2 -translate-y-1/2 h-4 w-4 sm:h-5 sm:w-5 text-gray-400 flex-shrink-0 pointer-events-none\" />\n        </div>\n      </div>\n\n          {/* Status Filters */}\n          <div className=\"flex items-center gap-1.5 sm:gap-2 flex-wrap min-w-0\">\n          {[\n            [\"\", \"All\"],\n            [\"REQUESTED\", \"New\"],\n            [\"VERIFIED\", \"Verified\"],\n            [\"APPROVED\", \"Approved\"],\n            [\"PAID\", \"Paid\"],\n            [\"REJECTED\", \"Rejected\"],\n          ].map(([val, label]) => {\n            const v = val as string;\n            const isActive = status === v || (v === \"\" && status === \"\");\n            const colorMap: Record<string, { active: string; inactive: string; badge: string }> = {\n              '': { active: 'bg-gray-100 border-gray-300 text-gray-800', inactive: 'bg-white hover:bg-gray-50', badge: 'bg-gray-100 text-gray-800' },\n              REQUESTED: { active: 'bg-blue-50 border-blue-300 text-blue-700', inactive: 'bg-white hover:bg-blue-50', badge: 'bg-blue-100 text-blue-800' },\n              VERIFIED: { active: 'bg-amber-50 border-amber-300 text-amber-700', inactive: 'bg-white hover:bg-amber-50', badge: 'bg-amber-100 text-amber-800' },\n              APPROVED: { active: 'bg-emerald-50 border-emerald-300 text-emerald-700', inactive: 'bg-white hover:bg-emerald-50', badge: 'bg-emerald-100 text-emerald-800' },\n              PAID: { active: 'bg-teal-50 border-teal-300 text-teal-700', inactive: 'bg-white hover:bg-teal-50', badge: 'bg-teal-100 text-teal-800' },\n              REJECTED: { active: 'bg-red-50 border-red-300 text-red-700', inactive: 'bg-white hover:bg-red-50', badge: 'bg-red-100 text-red-800' },\n            } as const;\n\n            const colors = colorMap[v as keyof typeof colorMap] ?? colorMap[''];\n              const btnClass = `px-2 sm:px-2.5 py-1 sm:py-1.5 rounded-full border text-xs flex items-center gap-1 sm:gap-1.5 transition-all duration-200 flex-shrink-0 whitespace-nowrap ${isActive ? colors.active : colors.inactive}`;\n              const badgeClass = `text-[10px] sm:text-xs px-1.5 sm:px-2 py-0.5 rounded-full ${colors.badge} flex-shrink-0`;\n\n            return (\n              <button\n                key={String(val) || \"all\"}\n                type=\"button\"\n                onClick={() => { setStatus(v); setTimeout(() => load(), 0); }}\n                className={btnClass}\n              >\n                  <span className=\"whitespace-nowrap\">{String(label)}</span>\n                <span className={badgeClass}>{counts[v || ''] ?? 0}</span>\n              </button>\n            );\n          })}\n\n            {/* Date Picker */}\n            <div className=\"relative flex-shrink-0\">\n          <button\n            type=\"button\"\n            aria-label=\"Open date picker\"\n            title=\"Pick date range\"\n            onClick={() => {\n              setPickerAnim(true);\n              window.setTimeout(() => setPickerAnim(false), 350);\n              setPickerOpen((v) => !v);\n            }}\n                className={`px-2 sm:px-2.5 py-1 sm:py-1.5 rounded-full border text-xs flex items-center justify-center text-gray-700 bg-white transition-all flex-shrink-0 ${\n                  pickerAnim ? 'ring-2 ring-blue-100' : 'hover:bg-gray-50'\n                }`}\n          >\n                <Calendar className=\"h-3.5 w-3.5 sm:h-4 sm:w-4\" />\n          </button>\n          {pickerOpen && (\n            <>\n              <div className=\"fixed inset-0 z-40\" onClick={() => setPickerOpen(false)} />\n              <div className=\"fixed z-50 top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2\">\n                <DatePicker\n                  selected={date || undefined}\n                  onSelectAction={(s) => {\n                    setDate(s as string | string[]);\n                  }}\n                  onCloseAction={() => setPickerOpen(false)}\n                />\n              </div>\n            </>\n          )}\n        </div>\n\n            {/* Advanced Filters Toggle */}\n            <button\n              type=\"button\"\n              onClick={() => setShowAdvancedFilters(!showAdvancedFilters)}\n              className={`px-2 sm:px-2.5 py-1 sm:py-1.5 rounded-full border text-xs flex items-center gap-1.5 justify-center text-gray-700 bg-white transition-all flex-shrink-0 whitespace-nowrap ${\n                showAdvancedFilters ? 'bg-[#02665e]/10 border-[#02665e] text-[#02665e]' : 'hover:bg-gray-50'\n              }`}\n            >\n              <Filter className=\"h-3.5 w-3.5 sm:h-4 sm:w-4\" />\n              <span className=\"hidden sm:inline\">Filters</span>\n            </button>\n\n            {/* Print Button */}\n            <button\n              type=\"button\"\n              onClick={handlePrint}\n              className=\"px-2 sm:px-2.5 py-1 sm:py-1.5 rounded-full border text-xs flex items-center gap-1.5 justify-center text-gray-700 bg-white hover:bg-gray-50 transition-all flex-shrink-0 whitespace-nowrap\"\n              title=\"Print invoices\"\n            >\n              <Printer className=\"h-3.5 w-3.5 sm:h-4 sm:w-4\" />\n              <span className=\"hidden sm:inline\">Print</span>\n            </button>\n      </div>\n\n          {/* Advanced Filters Panel */}\n          {showAdvancedFilters && (\n            <div className=\"border-t border-gray-200 pt-3 sm:pt-4 space-y-3 sm:space-y-4\">\n              <div className=\"flex items-center justify-between\">\n                <h3 className=\"text-sm font-semibold text-gray-900\">Advanced Filters</h3>\n                <button\n                  type=\"button\"\n                  onClick={() => {\n                    setOwnerFilter(\"\");\n                    setPropertyFilter(\"\");\n                    setAmountMin(\"\");\n                    setAmountMax(\"\");\n                    setShowAdvancedFilters(false);\n                  }}\n                  className=\"text-xs text-gray-500 hover:text-gray-700 flex items-center gap-1 px-2 py-1 rounded-md hover:bg-gray-100 transition-colors duration-200\"\n                >\n                  <X className=\"h-3 w-3\" />\n                  Clear\n                </button>\n              </div>\n              <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4\">\n                {/* Owner Filter */}\n                <div className=\"min-w-0\">\n                  <label className=\"block text-xs font-medium text-gray-700 mb-1.5\">Owner</label>\n                  <select\n                    value={ownerFilter}\n                    onChange={(e) => setOwnerFilter(e.target.value)}\n                    className=\"w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-[#02665e] focus:border-[#02665e] outline-none text-xs sm:text-sm transition-all box-border\"\n                  >\n                    <option value=\"\">All Owners</option>\n                    {owners.map(owner => (\n                      <option key={owner.id} value={owner.id}>\n                        {owner.name || owner.email} ({owner.id})\n                      </option>\n                    ))}\n                  </select>\n                </div>\n\n                {/* Property Filter */}\n                <div className=\"min-w-0\">\n                  <label className=\"block text-xs font-medium text-gray-700 mb-1.5\">Property</label>\n                  <select\n                    value={propertyFilter}\n                    onChange={(e) => setPropertyFilter(e.target.value)}\n                    className=\"w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-[#02665e] focus:border-[#02665e] outline-none text-xs sm:text-sm transition-all box-border\"\n                  >\n                    <option value=\"\">All Properties</option>\n                    {properties.map(prop => (\n                      <option key={prop.id} value={prop.id}>\n                        {prop.title} ({prop.id})\n                      </option>\n                    ))}\n                  </select>\n                </div>\n\n                {/* Amount Min */}\n                <div className=\"min-w-0\">\n                  <label className=\"block text-xs font-medium text-gray-700 mb-1.5\">Min Amount (TZS)</label>\n                  <input\n                    type=\"number\"\n                    value={amountMin}\n                    onChange={(e) => setAmountMin(e.target.value)}\n                    placeholder=\"0\"\n                    className=\"w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-[#02665e] focus:border-[#02665e] outline-none text-xs sm:text-sm transition-all box-border\"\n                  />\n                </div>\n\n                {/* Amount Max */}\n                <div className=\"min-w-0\">\n                  <label className=\"block text-xs font-medium text-gray-700 mb-1.5\">Max Amount (TZS)</label>\n                  <input\n                    type=\"number\"\n                    value={amountMax}\n                    onChange={(e) => setAmountMax(e.target.value)}\n                    placeholder=\"No limit\"\n                    className=\"w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-[#02665e] focus:border-[#02665e] outline-none text-xs sm:text-sm transition-all box-border\"\n                  />\n                </div>\n              </div>\n            </div>\n          )}\n\n          {/* Bulk Actions Bar */}\n          {selectedIds.size > 0 && (\n            <div className=\"border-t border-gray-200 pt-3 sm:pt-4 flex flex-wrap items-center gap-2 sm:gap-3\">\n              <div className=\"text-xs sm:text-sm font-medium text-gray-700\">\n                {selectedIds.size} invoice{selectedIds.size !== 1 ? 's' : ''} selected\n              </div>\n              <button\n                onClick={clearSelection}\n                className=\"text-xs text-gray-500 hover:text-gray-700 flex items-center gap-1\"\n              >\n                <X className=\"h-3 w-3\" />\n                Clear\n              </button>\n              <div className=\"flex-1\"></div>\n              <button\n                onClick={bulkApprove}\n                disabled={bulkActionLoading || !Array.from(selectedIds).some(id => {\n                  const inv = items.find(i => i.id === id);\n                  return inv && (inv.status === \"VERIFIED\" || inv.status === \"REQUESTED\");\n                })}\n                className=\"px-3 py-1.5 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition-all text-xs sm:text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-1.5\"\n              >\n                {bulkActionLoading ? (\n                  <>\n                    <div className=\"animate-spin rounded-full h-3 w-3 border-2 border-white border-t-transparent\"></div>\n                    Processing...\n                  </>\n                ) : (\n                  <>\n                    <CheckCircle2 className=\"h-3.5 w-3.5\" />\n                    Approve Selected\n                  </>\n                )}\n              </button>\n              <button\n                onClick={bulkMarkPaid}\n                disabled={bulkActionLoading || !Array.from(selectedIds).some(id => {\n                  const inv = items.find(i => i.id === id);\n                  return inv && inv.status === \"APPROVED\";\n                })}\n                className=\"px-3 py-1.5 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-all text-xs sm:text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-1.5\"\n              >\n                {bulkActionLoading ? (\n                  <>\n                    <div className=\"animate-spin rounded-full h-3 w-3 border-2 border-white border-t-transparent\"></div>\n                    Processing...\n                  </>\n                ) : (\n                  <>\n                    <Receipt className=\"h-3.5 w-3.5\" />\n                    Mark Paid\n                  </>\n                )}\n              </button>\n            </div>\n          )}\n        </div>\n      </div>\n\n      {/* Total Summary & Export */}\n      <div className=\"bg-gradient-to-r from-[#02665e]/10 to-emerald-50 rounded-xl border border-[#02665e]/20 p-4 sm:p-6 shadow-sm\">\n        <div className=\"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4\">\n          <div className=\"flex items-center gap-3\">\n            <div className=\"w-10 h-10 rounded-lg bg-[#02665e]/20 flex items-center justify-center\">\n              <DollarSign className=\"h-5 w-5 text-[#02665e]\" />\n            </div>\n            <div>\n              <div className=\"text-xs sm:text-sm font-medium text-gray-600\">Total Net (shown)</div>\n              <div className=\"text-xl sm:text-2xl font-bold text-[#02665e]\">\n                {new Intl.NumberFormat('en-US').format(sumNet)} TZS\n              </div>\n            </div>\n          </div>\n          {/* Export Button - Only show for APPROVED invoices */}\n          {status === \"APPROVED\" && items.length > 0 && (\n            <button\n              onClick={async () => {\n                try {\n                  const params = new URLSearchParams();\n                  params.set(\"status\", \"APPROVED\");\n                  if (from) params.set(\"from\", from);\n                  if (to) params.set(\"to\", to);\n                  if (q) params.set(\"q\", q);\n\n                  const response = await fetch(`/api/admin/revenue/invoices/export.csv?${params.toString()}`, {\n                    credentials: \"include\",\n                  });\n\n                  if (!response.ok) {\n                    const errorText = await response.text().catch(() => \"Unknown error\");\n                    console.error(\"CSV export failed:\", response.status, errorText);\n                    throw new Error(`Export failed: ${response.status} ${errorText}`);\n                  }\n\n                  const blob = await response.blob();\n                  \n                  // Check if blob is actually CSV (not an error response)\n                  if (blob.type && !blob.type.includes('csv') && !blob.type.includes('text')) {\n                    const text = await blob.text();\n                    console.error(\"CSV export returned non-CSV:\", text);\n                    throw new Error(\"Server returned an error instead of CSV\");\n                  }\n                  \n                  const url = URL.createObjectURL(blob);\n                  const a = document.createElement(\"a\");\n                  a.href = url;\n                  a.download = `approved_invoices_payout_${new Date().toISOString().split('T')[0]}.csv`;\n                  document.body.appendChild(a);\n                  a.click();\n                  document.body.removeChild(a);\n                  URL.revokeObjectURL(url);\n                } catch (err: any) {\n                  console.error(\"Failed to export CSV:\", err);\n                  alert(`Failed to export CSV: ${err.message || \"Please try again.\"}`);\n                }\n              }}\n              className=\"flex items-center gap-2 px-4 py-2.5 bg-[#02665e] text-white rounded-lg hover:bg-[#02665e]/90 transition-all duration-200 shadow-sm hover:shadow-md font-medium text-sm sm:text-base whitespace-nowrap\"\n            >\n              <Download className=\"h-4 w-4 sm:h-5 sm:w-5 flex-shrink-0\" />\n              <span>Export Approved for Payout</span>\n            </button>\n          )}\n        </div>\n      </div>\n\n      {/* Mobile Card Layout */}\n      {loading ? (\n        <div className=\"bg-white rounded-xl border border-gray-200 p-12 shadow-sm\">\n          <div className=\"flex items-center justify-center\">\n            <div className=\"animate-spin rounded-full h-8 w-8 border-2 border-gray-300 border-t-emerald-600\"></div>\n          </div>\n        </div>\n      ) : items.length === 0 ? (\n        <div className=\"bg-white rounded-xl border border-gray-200 p-12 shadow-sm text-center\">\n          <p className=\"text-sm text-gray-500\">{emptyMessage}</p>\n        </div>\n      ) : (\n        <>\n          {/* Mobile Cards - Hidden on md and up */}\n          <div className=\"md:hidden space-y-3\">\n            {items.map((inv) => (\n              <div\n                key={inv.id}\n                className=\"bg-white rounded-xl border border-gray-200 p-4 shadow-sm hover:shadow-md transition-shadow\"\n              >\n                <div className=\"flex items-start justify-between mb-3\">\n                  <div className=\"flex items-start gap-2 flex-1 min-w-0\">\n                    <button\n                      onClick={() => toggleSelect(inv.id)}\n                      className=\"p-1.5 hover:bg-gray-100 rounded-md transition-all duration-200 flex-shrink-0 mt-0.5 focus:outline-none focus:ring-2 focus:ring-[#02665e]/20\"\n                      title={selectedIds.has(inv.id) ? \"Deselect\" : \"Select\"}\n                    >\n                      {selectedIds.has(inv.id) ? (\n                        <CheckSquare className=\"h-4 w-4 text-[#02665e] stroke-2\" />\n                      ) : (\n                        <Square className=\"h-4 w-4 text-gray-400 stroke-1.5\" />\n                      )}\n                    </button>\n                    <div className=\"flex-1 min-w-0\">\n                      <div className=\"flex items-center gap-2 mb-1\">\n                        <FileText className=\"h-4 w-4 text-gray-400 flex-shrink-0\" />\n                        <div className=\"text-sm font-semibold text-gray-900 truncate\">\n                          {inv.invoiceNumber ?? `#${inv.id}`}\n                        </div>\n                      </div>\n                      {inv.receiptNumber && (\n                        <div className=\"text-xs text-gray-500 ml-6\">Receipt: {inv.receiptNumber}</div>\n                      )}\n                    </div>\n                  </div>\n                  <Link\n                href={`/admin/revenue/${inv.id}`}\n                    className=\"p-2 rounded-lg text-[#02665e] hover:bg-[#02665e]/10 transition-all flex-shrink-0\"\n                    title=\"View invoice details\"\n                  >\n                    <Eye className=\"h-5 w-5\" />\n                  </Link>\n                </div>\n\n                <div className=\"space-y-2 text-sm\">\n                  <div className=\"flex items-center gap-2\">\n                    <Building2 className=\"h-4 w-4 text-gray-400 flex-shrink-0\" />\n                    <span className=\"text-gray-900 truncate\">{inv.booking.property.title}</span>\n                  </div>\n\n                  <div className=\"flex items-center gap-2\">\n                    <Calendar className=\"h-4 w-4 text-gray-400 flex-shrink-0\" />\n                    <span className=\"text-gray-700\">\n                      {new Date(inv.issuedAt).toLocaleDateString()} {new Date(inv.issuedAt).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}\n                    </span>\n                  </div>\n\n                  <div className=\"grid grid-cols-2 gap-3 pt-2 border-t border-gray-100\">\n                    <div>\n                      <div className=\"text-xs text-gray-500\">Gross</div>\n                      <div className=\"text-sm font-medium text-gray-900\">{fmt(inv.total)}</div>\n                    </div>\n                    <div>\n                      <div className=\"text-xs text-gray-500\">Net Payable</div>\n                      <div className=\"text-sm font-bold text-[#02665e]\">{fmt(inv.netPayable)}</div>\n                    </div>\n                    <div>\n                      <div className=\"text-xs text-gray-500\">Commission</div>\n                      <div className=\"text-sm text-gray-900\">{Number(inv.commissionPercent)}% ({fmt(inv.commissionAmount)})</div>\n                    </div>\n                    <div>\n                      <div className=\"text-xs text-gray-500\">Tax</div>\n                      <div className=\"text-sm text-gray-900\">{Number(inv.taxPercent) || 0}%</div>\n                    </div>\n                  </div>\n\n                  <div className=\"pt-2\">\n                    {getStatusBadge(inv.status)}\n                  </div>\n            </div>\n          </div>\n        ))}\n      </div>\n\n          {/* Desktop Table - Hidden on mobile */}\n          <div className=\"hidden md:block bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden\">\n            <div className=\"overflow-x-auto\">\n              <table className=\"min-w-full divide-y divide-gray-200\">\n                <thead className=\"bg-gray-50\">\n                  <tr>\n                    <th className=\"px-2 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider w-10 border-r border-gray-200\">\n                      <button\n                        onClick={toggleSelectAll}\n                        className=\"p-1.5 hover:bg-gray-100 rounded-md transition-all duration-200 mx-auto focus:outline-none focus:ring-2 focus:ring-[#02665e]/20\"\n                        title={selectedIds.size === items.length ? \"Deselect all\" : \"Select all\"}\n                        aria-label=\"Select all invoices\"\n                      >\n                        {selectedIds.size === items.length && items.length > 0 ? (\n                          <CheckSquare className=\"h-4 w-4 text-[#02665e] stroke-2\" />\n                        ) : (\n                          <Square className=\"h-4 w-4 text-gray-400 stroke-1.5\" />\n                        )}\n                      </button>\n                    </th>\n                    <th \n                      className=\"px-3 sm:px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition-colors\"\n                      onClick={() => handleSort(\"invoiceNumber\")}\n                    >\n                      <div className=\"flex items-center gap-1.5\">\n                        <span>Invoice</span>\n                        {sortBy === \"invoiceNumber\" ? (\n                          sortDir === \"asc\" ? <ArrowUp className=\"h-3 w-3\" /> : <ArrowDown className=\"h-3 w-3\" />\n                        ) : (\n                          <ArrowUpDown className=\"h-3 w-3 text-gray-400\" />\n                        )}\n                      </div>\n                    </th>\n                    <th className=\"px-3 sm:px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider\">\n                      Property\n                    </th>\n                    <th \n                      className=\"px-3 sm:px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition-colors\"\n                      onClick={() => handleSort(\"issuedAt\")}\n                    >\n                      <div className=\"flex items-center gap-1.5\">\n                        <span>Date</span>\n                        {sortBy === \"issuedAt\" ? (\n                          sortDir === \"asc\" ? <ArrowUp className=\"h-3 w-3\" /> : <ArrowDown className=\"h-3 w-3\" />\n                        ) : (\n                          <ArrowUpDown className=\"h-3 w-3 text-gray-400\" />\n                        )}\n                      </div>\n                    </th>\n                    <th \n                      className=\"px-3 sm:px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition-colors\"\n                      onClick={() => handleSort(\"total\")}\n                    >\n                      <div className=\"flex items-center gap-1.5\">\n                        <span>Gross</span>\n                        {sortBy === \"total\" ? (\n                          sortDir === \"asc\" ? <ArrowUp className=\"h-3 w-3\" /> : <ArrowDown className=\"h-3 w-3\" />\n                        ) : (\n                          <ArrowUpDown className=\"h-3 w-3 text-gray-400\" />\n                        )}\n                      </div>\n                    </th>\n                    <th className=\"px-3 sm:px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider\">\n                      Commission\n                    </th>\n                    <th className=\"px-3 sm:px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider\">\n                      Tax\n                    </th>\n                    <th className=\"px-3 sm:px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider\">\n                      Status\n                    </th>\n                    <th \n                      className=\"px-3 sm:px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition-colors\"\n                      onClick={() => handleSort(\"netPayable\")}\n                    >\n                      <div className=\"flex items-center gap-1.5\">\n                        <span>Net Payable</span>\n                        {sortBy === \"netPayable\" ? (\n                          sortDir === \"asc\" ? <ArrowUp className=\"h-3 w-3\" /> : <ArrowDown className=\"h-3 w-3\" />\n                        ) : (\n                          <ArrowUpDown className=\"h-3 w-3 text-gray-400\" />\n                        )}\n                      </div>\n                    </th>\n                    <th className=\"px-3 sm:px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider\">\n                      Actions\n                    </th>\n                  </tr>\n                </thead>\n                <tbody className=\"bg-white divide-y divide-gray-200\">\n                  {items.map((inv) => (\n                    <TableRow key={inv.id}>\n                      <td className=\"px-2 py-3 whitespace-nowrap text-center border-r border-gray-100\">\n                        <button\n                          onClick={() => toggleSelect(inv.id)}\n                          className=\"p-1.5 hover:bg-gray-100 rounded-md transition-all duration-200 mx-auto focus:outline-none focus:ring-2 focus:ring-[#02665e]/20\"\n                          title={selectedIds.has(inv.id) ? \"Deselect\" : \"Select\"}\n                          aria-label={selectedIds.has(inv.id) ? \"Deselect invoice\" : \"Select invoice\"}\n                        >\n                          {selectedIds.has(inv.id) ? (\n                            <CheckSquare className=\"h-4 w-4 text-[#02665e] stroke-2\" />\n                          ) : (\n                            <Square className=\"h-4 w-4 text-gray-400 stroke-1.5\" />\n                          )}\n                        </button>\n                      </td>\n                      <td className=\"px-3 sm:px-4 py-3 whitespace-nowrap\">\n                        <div className=\"flex items-center gap-2\">\n                          <FileText className=\"h-4 w-4 text-gray-400 flex-shrink-0\" />\n                          <div className=\"min-w-0\">\n                            <div className=\"text-sm font-semibold text-gray-900 truncate\">\n                              {inv.invoiceNumber ?? `#${inv.id}`}\n                            </div>\n                            {inv.receiptNumber && (\n                              <div className=\"text-xs text-gray-500 truncate\">\n                                Receipt: {inv.receiptNumber}\n                              </div>\n                            )}\n                          </div>\n                        </div>\n                      </td>\n                      <td className=\"px-3 sm:px-4 py-3\">\n                        <div className=\"flex items-center gap-2 min-w-0\">\n                          <Building2 className=\"h-4 w-4 text-gray-400 flex-shrink-0\" />\n                          <span className=\"text-sm text-gray-900 truncate\">{inv.booking.property.title}</span>\n                        </div>\n                      </td>\n                      <td className=\"px-3 sm:px-4 py-3 whitespace-nowrap\">\n                        <div className=\"text-sm text-gray-900\">\n                          {new Date(inv.issuedAt).toLocaleDateString()}\n                        </div>\n                        <div className=\"text-xs text-gray-500\">\n                          {new Date(inv.issuedAt).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' })}\n                        </div>\n                      </td>\n                      <td className=\"px-3 sm:px-4 py-3 whitespace-nowrap\">\n                        <div className=\"text-sm font-medium text-gray-900\">{fmt(inv.total)}</div>\n                      </td>\n                      <td className=\"px-3 sm:px-4 py-3 whitespace-nowrap\">\n                        <div className=\"text-xs text-gray-600\">\n                          {Number(inv.commissionPercent)}%\n                        </div>\n                        <div className=\"text-sm font-medium text-gray-900\">{fmt(inv.commissionAmount)}</div>\n                      </td>\n                      <td className=\"px-3 sm:px-4 py-3 whitespace-nowrap\">\n                        <div className=\"text-sm text-gray-600\">{Number(inv.taxPercent) || 0}%</div>\n                      </td>\n                      <td className=\"px-3 sm:px-4 py-3 whitespace-nowrap\">\n                        {getStatusBadge(inv.status)}\n                      </td>\n                      <td className=\"px-3 sm:px-4 py-3 whitespace-nowrap\">\n                        <div className=\"text-sm font-bold text-[#02665e]\">{fmt(inv.netPayable)}</div>\n                      </td>\n                      <td className=\"px-3 sm:px-4 py-3 whitespace-nowrap text-center\">\n                        <Link\n                          href={`/admin/revenue/${inv.id}`}\n                          className=\"inline-flex items-center justify-center p-2 rounded-lg text-[#02665e] hover:bg-[#02665e]/10 transition-all duration-200\"\n                          title=\"View invoice details\"\n                        >\n                          <Eye className=\"h-5 w-5\" />\n                        </Link>\n                      </td>\n                    </TableRow>\n                  ))}\n                </tbody>\n              </table>\n            </div>\n          </div>\n\n          {/* Pagination */}\n          {total > pageSize && (\n            <div className=\"bg-white rounded-xl border border-gray-200 p-4 shadow-sm\">\n              <div className=\"flex flex-col sm:flex-row items-center justify-between gap-4\">\n                <div className=\"text-sm text-gray-600\">\n                  Showing <span className=\"font-semibold text-gray-900\">{(page - 1) * pageSize + 1}</span> to{\" \"}\n                  <span className=\"font-semibold text-gray-900\">{Math.min(page * pageSize, total)}</span> of{\" \"}\n                  <span className=\"font-semibold text-gray-900\">{total}</span> invoices\n                </div>\n                <div className=\"flex items-center gap-2\">\n                  <button\n                    onClick={() => setPage(p => Math.max(1, p - 1))}\n                    disabled={page === 1 || loading}\n                    className=\"p-2 border border-gray-300 rounded-lg hover:border-[#02665e] hover:text-[#02665e] transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center\"\n                    aria-label=\"Previous page\"\n                  >\n                    <ChevronLeft className=\"h-5 w-5\" />\n                  </button>\n                  <div className=\"flex items-center gap-1\">\n                    {(() => {\n                      const totalPages = Math.ceil(total / pageSize);\n                      const pages: (number | string)[] = [];\n                      \n                      if (totalPages <= 7) {\n                        // Show all pages if 7 or fewer\n                        for (let i = 1; i <= totalPages; i++) {\n                          pages.push(i);\n                        }\n                      } else {\n                        // Always show first page\n                        pages.push(1);\n                        \n                        if (page <= 4) {\n                          // Near the start: show 1, 2, 3, 4, 5, ..., last\n                          for (let i = 2; i <= 5; i++) {\n                            pages.push(i);\n                          }\n                          pages.push('...');\n                          pages.push(totalPages);\n                        } else if (page >= totalPages - 3) {\n                          // Near the end: show 1, ..., last-4, last-3, last-2, last-1, last\n                          pages.push('...');\n                          for (let i = totalPages - 4; i <= totalPages; i++) {\n                            pages.push(i);\n                          }\n                        } else {\n                          // In the middle: show 1, ..., page-1, page, page+1, ..., last\n                          pages.push('...');\n                          pages.push(page - 1);\n                          pages.push(page);\n                          pages.push(page + 1);\n                          pages.push('...');\n                          pages.push(totalPages);\n                        }\n                      }\n                      \n                      return pages.map((p, idx) => {\n                        if (p === '...') {\n                          return <span key={`ellipsis-${idx}`} className=\"px-2 text-gray-400\">...</span>;\n                        }\n                        return (\n                          <button\n                            key={p}\n                            onClick={() => setPage(p as number)}\n                            disabled={loading}\n                            className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${\n                              page === p\n                                ? \"bg-[#02665e] text-white\"\n                                : \"bg-white text-gray-700 hover:bg-gray-50 border border-gray-300\"\n                            } disabled:opacity-50 disabled:cursor-not-allowed`}\n                          >\n                            {p}\n                          </button>\n                        );\n                      });\n                    })()}\n                  </div>\n                  <button\n                    onClick={() => setPage(p => Math.min(Math.ceil(total / pageSize), p + 1))}\n                    disabled={page >= Math.ceil(total / pageSize) || loading}\n                    className=\"p-2 border border-gray-300 rounded-lg hover:border-[#02665e] hover:text-[#02665e] transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center\"\n                    aria-label=\"Next page\"\n                  >\n                    <ChevronRight className=\"h-5 w-5\" />\n                  </button>\n                </div>\n              </div>\n            </div>\n          )}\n        </>\n      )}\n    </div>\n  );\n}\n\nfunction fmt(n: any) {\n  return new Intl.NumberFormat(undefined, { style: \"currency\", currency: \"TZS\" }).format(\n    Number(n || 0)\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\security\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\settings\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\support\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\terms\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\users\\[id]\\page.tsx","messages":[],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has missing dependencies: 'isValidUserId' and 'router'. Either include them or remove the dependency array.","line":126,"column":6,"nodeType":"ArrayExpression","endLine":126,"endColumn":14,"suggestions":[{"desc":"Update the dependencies array to be: [isValidUserId, router, userId]","fix":{"range":[4057,4065],"text":"[isValidUserId, router, userId]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\users\\bookings\\page.tsx","messages":[],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'load'. Either include it or remove the dependency array.","line":477,"column":6,"nodeType":"ArrayExpression","endLine":477,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [load]","fix":{"range":[16835,16837],"text":"[load]"}}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'load'. Either include it or remove the dependency array.","line":483,"column":6,"nodeType":"ArrayExpression","endLine":483,"endColumn":23,"suggestions":[{"desc":"Update the dependencies array to be: [status, date, q, load]","fix":{"range":[16976,16993],"text":"[status, date, q, load]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\users\\dashboard\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\users\\list\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\users\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\users\\transport-bookings\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'User' is defined but never used. Allowed unused vars must match /^_/u.","line":8,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":8,"endColumn":7,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"User"},"fix":{"range":[114,123],"text":""},"desc":"Remove unused variable \"User\"."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'load'. Either include it or remove the dependency array.","line":261,"column":6,"nodeType":"ArrayExpression","endLine":261,"endColumn":41,"suggestions":[{"desc":"Update the dependencies array to be: [page, status, q, sortKey, sortDir, load]","fix":{"range":[8435,8470],"text":"[page, status, q, sortKey, sortDir, load]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useEffect, useState, useMemo, useRef } from \"react\";\r\nimport {\r\n  Truck,\r\n  Search,\r\n  X,\r\n  User,\r\n  MapPin,\r\n  Calendar,\r\n  Clock,\r\n  AlertTriangle,\r\n  CheckCircle,\r\n  Filter,\r\n  Eye,\r\n  Hourglass,\r\n  XCircle,\r\n  BadgeCheck,\r\n  CircleDashed,\r\n  CircleCheck,\r\n  FileSearch,\r\n  Mail,\r\n  Phone,\r\n  Bookmark,\r\n  ArrowUpDown,\r\n  ArrowUp,\r\n  ArrowDown,\r\n} from \"lucide-react\";\r\nimport axios from \"axios\";\r\nimport Link from \"next/link\";\r\nimport { useRouter } from \"next/navigation\";\r\n\r\nconst api = axios.create({ baseURL: \"\", withCredentials: true });\r\nfunction authify() {\r\n  if (typeof window === \"undefined\") return;\r\n\r\n  // Most of the app uses a Bearer token (often stored in localStorage).\r\n  // The admin endpoints are protected by requireAuth/requireRole, so we must attach it.\r\n  const lsToken =\r\n    window.localStorage.getItem(\"token\") ||\r\n    window.localStorage.getItem(\"nolsaf_token\") ||\r\n    window.localStorage.getItem(\"__Host-nolsaf_token\");\r\n\r\n  if (lsToken) {\r\n    api.defaults.headers.common[\"Authorization\"] = `Bearer ${lsToken}`;\r\n    return;\r\n  }\r\n\r\n  // Fallback: non-httpOnly cookie (if present)\r\n  const m = String(document.cookie || \"\").match(/(?:^|;\\s*)(?:nolsaf_token|__Host-nolsaf_token)=([^;]+)/);\r\n  const cookieToken = m?.[1] ? decodeURIComponent(m[1]) : \"\";\r\n  if (cookieToken) {\r\n    api.defaults.headers.common[\"Authorization\"] = `Bearer ${cookieToken}`;\r\n  }\r\n}\r\n\r\ntype TransportBooking = {\r\n  id: number;\r\n  groupType: string;\r\n  toRegion: string;\r\n  toLocation: string | null;\r\n  fromRegion: string | null;\r\n  fromLocation: string | null;\r\n  checkIn: string | null;\r\n  checkOut: string | null;\r\n  useDates: boolean;\r\n  kind: \"group\" | \"individual\";\r\n  headcount: number | null;\r\n  roomsQty: number | null;\r\n  status: string;\r\n  totalAmount: number | null;\r\n  currency: string | null;\r\n  pickupLocation: string | null;\r\n  pickupTime: string | null;\r\n  arrangementNotes: string | null;\r\n  createdAt: string;\r\n  urgency: \"urgent\" | \"later\" | \"specified\" | \"flexible\";\r\n  urgencyReason: string;\r\n  user: {\r\n    id: number | null;\r\n    name: string | null;\r\n    email: string | null;\r\n    phone: string | null;\r\n  };\r\n};\r\n\r\nfunction formatPickupTime(pickupTime: string | null) {\r\n  if (!pickupTime) return null;\r\n\r\n  const trimmed = String(pickupTime).trim();\r\n\r\n  // Many transport times come back as ISO strings.\r\n  // Some also come back as parseable date strings; format them compactly.\r\n  const maybeDate = new Date(trimmed);\r\n  if (!Number.isNaN(maybeDate.getTime())) {\r\n    const date = maybeDate.toLocaleDateString(undefined, { year: \"numeric\", month: \"short\", day: \"2-digit\" });\r\n    const time = maybeDate.toLocaleTimeString(undefined, { hour: \"2-digit\", minute: \"2-digit\" });\r\n    return `${date} • ${time}`;\r\n  }\r\n\r\n  // Otherwise, keep it as-is (e.g. \"10:00 AM\").\r\n  return trimmed;\r\n}\r\n\r\nfunction shortenText(text: string, max = 42) {\r\n  const t = String(text || \"\").trim();\r\n  if (t.length <= max) return t;\r\n  return `${t.slice(0, Math.max(0, max - 1)).trimEnd()}…`;\r\n}\r\n\r\nfunction formatDateShort(value: string | null) {\r\n  if (!value) return \"\";\r\n  const d = new Date(value);\r\n  if (Number.isNaN(d.getTime())) return String(value);\r\n  return d.toLocaleDateString(undefined, { year: \"numeric\", month: \"2-digit\", day: \"2-digit\" });\r\n}\r\n\r\nfunction formatDateTimeShort(value: string | null) {\r\n  if (!value) return null;\r\n  const d = new Date(value);\r\n  if (Number.isNaN(d.getTime())) return null;\r\n  return {\r\n    date: d.toLocaleDateString(undefined, { year: \"numeric\", month: \"2-digit\", day: \"2-digit\" }),\r\n    time: d.toLocaleTimeString(undefined, { hour: \"2-digit\", minute: \"2-digit\" }),\r\n  };\r\n}\r\n\r\nconst MARKS_STORAGE_KEY = \"admin_transport_bookings_marks_v1\";\r\n\r\ntype SortKey = \"date\" | \"pickup\" | \"created\" | \"destination\" | \"customer\" | \"status\" | \"urgency\";\r\ntype SortDir = \"asc\" | \"desc\";\r\n\r\nexport default function TransportBookingsPage() {\r\n  const router = useRouter();\r\n  const [q, setQ] = useState(\"\");\r\n  const [status, setStatus] = useState(\"\");\r\n  const [sortKey, setSortKey] = useState<SortKey>(\"date\");\r\n  const [sortDir, setSortDir] = useState<SortDir>(\"asc\");\r\n  const [page, setPage] = useState(1);\r\n  const [items, setItems] = useState<TransportBooking[]>([]);\r\n  const [total, setTotal] = useState(0);\r\n  const [loading, setLoading] = useState(true);\r\n  const [error, setError] = useState<string>(\"\");\r\n  const [markedKeys, setMarkedKeys] = useState<string[]>([]);\r\n  const [markedOnly, setMarkedOnly] = useState(false);\r\n  const pageSize = 30;\r\n  const searchRef = useRef<HTMLInputElement | null>(null);\r\n\r\n  const markedSet = useMemo(() => new Set(markedKeys), [markedKeys]);\r\n\r\n  const bookingKey = (booking: TransportBooking) => `${booking.kind}:${booking.id}`;\r\n\r\n  const toggleMark = (key: string) => {\r\n    setMarkedKeys((prev) => {\r\n      if (prev.includes(key)) return prev.filter((k) => k !== key);\r\n      return [key, ...prev].slice(0, 500);\r\n    });\r\n  };\r\n\r\n  const toggleSort = (key: SortKey) => {\r\n    setSortKey((prev) => {\r\n      if (prev !== key) {\r\n        setSortDir(\"asc\");\r\n        return key;\r\n      }\r\n      setSortDir((d) => (d === \"asc\" ? \"desc\" : \"asc\"));\r\n      return prev;\r\n    });\r\n    setPage(1);\r\n  };\r\n\r\n  const SortIcon = ({ active }: { active: boolean }) => {\r\n    if (!active) return <ArrowUpDown className=\"h-3.5 w-3.5 text-gray-400\" />;\r\n    return sortDir === \"asc\" ? <ArrowUp className=\"h-3.5 w-3.5 text-gray-700\" /> : <ArrowDown className=\"h-3.5 w-3.5 text-gray-700\" />;\r\n  };\r\n\r\n  const SortableHeader = ({ label, keyName, align = \"left\" }: { label: string; keyName: SortKey; align?: \"left\" | \"right\" }) => {\r\n    const isActive = sortKey === keyName;\r\n    return (\r\n      <th className={`px-6 py-3 text-${align} text-xs font-semibold text-gray-700`}>\r\n        <button\r\n          type=\"button\"\r\n          onClick={() => toggleSort(keyName)}\r\n          className=\"inline-flex items-center gap-1.5 border-0 bg-transparent p-0 text-xs font-semibold text-gray-700 hover:text-gray-900 transition-colors focus:outline-none\"\r\n          aria-label={`Sort by ${label}`}\r\n          title={`Sort by ${label}`}\r\n        >\r\n          <span>{label}</span>\r\n          <SortIcon active={isActive} />\r\n        </button>\r\n      </th>\r\n    );\r\n  };\r\n\r\n  const getViewHref = (booking: TransportBooking) =>\r\n    booking.kind === \"group\"\r\n      ? `/admin/group-stays/bookings?bookingId=${booking.id}`\r\n      : `/admin/bookings/${booking.id}`;\r\n\r\n  useEffect(() => {\r\n    if (typeof window === \"undefined\") return;\r\n    try {\r\n      const raw = window.localStorage.getItem(MARKS_STORAGE_KEY);\r\n      const parsed = raw ? JSON.parse(raw) : [];\r\n      if (Array.isArray(parsed)) {\r\n        setMarkedKeys(parsed.filter((x) => typeof x === \"string\").slice(0, 500));\r\n      }\r\n    } catch {\r\n      // ignore\r\n    }\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    if (typeof window === \"undefined\") return;\r\n    try {\r\n      window.localStorage.setItem(MARKS_STORAGE_KEY, JSON.stringify(markedKeys));\r\n    } catch {\r\n      // ignore\r\n    }\r\n  }, [markedKeys]);\r\n\r\n  async function load() {\r\n    setLoading(true);\r\n    setError(\"\");\r\n    try {\r\n      authify();\r\n      const params: any = { page, pageSize };\r\n      if (status) params.status = status;\r\n      if (q) params.q = q;\r\n      if (sortKey) params.sort = sortKey;\r\n      if (sortDir) params.dir = sortDir;\r\n\r\n      // NOTE: do NOT call `/admin/users/transport-bookings` here.\r\n      // That path is a Next.js page route (this page), so XHR would receive HTML.\r\n      // Use a non-page path that rewrites/proxies to the API server.\r\n      const r = await api.get<{ items: TransportBooking[]; total: number }>(\"/api/admin/users/transport-bookings\", { params });\r\n\r\n      const data: any = r.data;\r\n      const nextItems = Array.isArray(data?.items) ? (data.items as TransportBooking[]) : [];\r\n      const nextTotal = typeof data?.total === \"number\" ? data.total : 0;\r\n\r\n      setItems(nextItems);\r\n      setTotal(nextTotal);\r\n\r\n      if (!Array.isArray(data?.items)) {\r\n        setError(\"Unexpected response while loading transport bookings.\");\r\n      }\r\n    } catch (err) {\r\n      console.error(\"Failed to load transport bookings\", err);\r\n      setError(\"Failed to load transport bookings. Please refresh and try again.\");\r\n      setItems([]);\r\n      setTotal(0);\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  }\r\n\r\n  useEffect(() => {\r\n    authify();\r\n    load();\r\n  }, [page, status, q, sortKey, sortDir]);\r\n\r\n  const pages = Math.max(1, Math.ceil(total / pageSize));\r\n\r\n  const getUrgencyBadge = (urgency: string, reason: string) => {\r\n    switch (urgency) {\r\n      case \"urgent\":\r\n        return (\r\n          <span className=\"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-semibold bg-red-100 text-red-800\">\r\n            <AlertTriangle className=\"h-3 w-3 mr-1\" />\r\n            Urgent: {reason}\r\n          </span>\r\n        );\r\n      case \"later\":\r\n        return (\r\n          <span className=\"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-semibold bg-amber-100 text-amber-800\">\r\n            <Clock className=\"h-3 w-3 mr-1\" />\r\n            Later: {reason}\r\n          </span>\r\n        );\r\n      case \"specified\":\r\n        return (\r\n          <span className=\"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-semibold bg-blue-100 text-blue-800\">\r\n            <Calendar className=\"h-3 w-3 mr-1\" />\r\n            {reason}\r\n          </span>\r\n        );\r\n      default:\r\n        return (\r\n          <span className=\"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-semibold bg-gray-100 text-gray-800\">\r\n            <Clock className=\"h-3 w-3 mr-1\" />\r\n            Flexible\r\n          </span>\r\n        );\r\n    }\r\n  };\r\n\r\n  const normalizeStatusForFilter = (rawStatus: string) => {\r\n    const s = String(rawStatus || \"\").toUpperCase();\r\n    if (s === \"CANCELLED\") return \"CANCELED\";\r\n    return s;\r\n  };\r\n\r\n  const getStatusIndicator = (rawStatus: string) => {\r\n    const map: Record<\r\n      string,\r\n      {\r\n        label: string;\r\n        Icon: React.ComponentType<{ className?: string }>;\r\n        color: string;\r\n      }\r\n    > = {\r\n      NEW: { label: \"New\", Icon: CircleDashed, color: \"text-gray-600\" },\r\n      PENDING: { label: \"Pending\", Icon: Hourglass, color: \"text-gray-600\" },\r\n      REVIEWING: { label: \"Reviewing\", Icon: FileSearch, color: \"text-blue-600\" },\r\n      CONFIRMED: { label: \"Confirmed\", Icon: BadgeCheck, color: \"text-blue-600\" },\r\n      PROCESSING: { label: \"Processing\", Icon: Clock, color: \"text-amber-600\" },\r\n      CHECKED_IN: { label: \"Checked in\", Icon: CircleCheck, color: \"text-emerald-600\" },\r\n      CHECKED_OUT: { label: \"Checked out\", Icon: CheckCircle, color: \"text-gray-600\" },\r\n      COMPLETED: { label: \"Completed\", Icon: CheckCircle, color: \"text-emerald-600\" },\r\n      CANCELED: { label: \"Canceled\", Icon: XCircle, color: \"text-red-600\" },\r\n      CANCELLED: { label: \"Cancelled\", Icon: XCircle, color: \"text-red-600\" },\r\n    };\r\n\r\n    const bookingStatus = String(rawStatus || \"\").toUpperCase();\r\n    const entry = map[bookingStatus] || { label: bookingStatus || \"Unknown\", Icon: CircleDashed, color: \"text-gray-600\" };\r\n    const Icon = entry.Icon;\r\n    const filterValue = normalizeStatusForFilter(bookingStatus);\r\n    const isActive = normalizeStatusForFilter(status) === filterValue;\r\n\r\n    return (\r\n      <button\r\n        type=\"button\"\r\n        title={`Filter: ${entry.label}`}\r\n        aria-label={`Filter by status: ${entry.label}`}\r\n        onClick={() => {\r\n          setStatus((prev) => (normalizeStatusForFilter(prev) === filterValue ? \"\" : filterValue));\r\n          setPage(1);\r\n        }}\r\n        className={`inline-flex items-center justify-center border-0 bg-transparent p-1 transition duration-150 hover:scale-110 hover:opacity-90 focus:outline-none ${\r\n          isActive ? \"scale-110\" : \"\"\r\n        }`}\r\n      >\r\n        <Icon className={`h-4 w-4 ${entry.color}`} />\r\n        <span className=\"sr-only\">Filter by status: {entry.label}</span>\r\n      </button>\r\n    );\r\n  };\r\n\r\n  const visibleItems = useMemo(() => {\r\n    if (!markedOnly) return items;\r\n    return items.filter((b) => markedSet.has(bookingKey(b)));\r\n  }, [items, markedOnly, markedSet]);\r\n\r\n  return (\r\n    <div className=\"space-y-6 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8\">\r\n      {/* Header */}\r\n      <div className=\"bg-white rounded-lg border border-gray-200 p-6 shadow-sm\">\r\n        <div className=\"flex flex-col items-center text-center\">\r\n          <div className=\"h-16 w-16 rounded-full bg-gradient-to-br from-blue-50 to-blue-100 flex items-center justify-center mb-4\">\r\n            <Truck className=\"h-8 w-8 text-blue-600\" />\r\n          </div>\r\n          <h1 className=\"text-2xl font-bold text-gray-900\">Transport Bookings</h1>\r\n          <p className=\"text-sm text-gray-500 mt-1\">Customers who booked accommodation with transport requested (group stays + individual bookings)</p>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Search and Filters */}\r\n      <div className=\"bg-white rounded-lg border border-gray-200 p-4 shadow-sm\">\r\n        <div className=\"flex flex-col sm:flex-row gap-4 w-full max-w-full\">\r\n          {/* Search */}\r\n          <div className=\"relative flex-1 min-w-0 w-full sm:w-auto\">\r\n            <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400\" />\r\n            <input\r\n              ref={searchRef}\r\n              type=\"text\"\r\n              className=\"w-full pl-10 pr-10 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none text-sm box-border max-w-full\"\r\n              placeholder=\"Search by customer name, email, phone, or location...\"\r\n              value={q}\r\n              onChange={(e) => setQ(e.target.value)}\r\n              onKeyDown={(e) => {\r\n                if (e.key === \"Enter\") {\r\n                  e.preventDefault();\r\n                  setPage(1);\r\n                  load();\r\n                }\r\n              }}\r\n            />\r\n            {q && (\r\n              <button\r\n                type=\"button\"\r\n                onClick={() => {\r\n                  setQ(\"\");\r\n                  setPage(1);\r\n                  load();\r\n                }}\r\n                className=\"absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600\"\r\n              >\r\n                <X className=\"h-4 w-4\" />\r\n              </button>\r\n            )}\r\n          </div>\r\n\r\n          {/* Status Filter */}\r\n          <div className=\"flex items-center gap-2 w-full sm:w-auto sm:flex-shrink-0\">\r\n            <Filter className=\"h-4 w-4 text-gray-400 flex-shrink-0\" />\r\n            <select\r\n              value={status}\r\n              onChange={(e) => {\r\n                setStatus(e.target.value);\r\n                setPage(1);\r\n              }}\r\n              className=\"w-full sm:w-auto px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none text-sm bg-white box-border min-w-[140px]\"\r\n            >\r\n              <option value=\"\">All Status</option>\r\n              <option value=\"NEW\">New</option>\r\n              <option value=\"PENDING\">Pending</option>\r\n              <option value=\"REVIEWING\">Reviewing</option>\r\n              <option value=\"CONFIRMED\">Confirmed</option>\r\n              <option value=\"PROCESSING\">Processing</option>\r\n              <option value=\"CHECKED_IN\">Checked in</option>\r\n              <option value=\"CHECKED_OUT\">Checked out</option>\r\n              <option value=\"COMPLETED\">Completed</option>\r\n              <option value=\"CANCELED\">Canceled</option>\r\n            </select>\r\n          </div>\r\n\r\n          {/* Marked */}\r\n          <div className=\"flex items-center gap-2 w-full sm:w-auto sm:flex-shrink-0\">\r\n            <button\r\n              type=\"button\"\r\n              onClick={() => setMarkedOnly((v) => !v)}\r\n              className={`inline-flex items-center gap-2 px-3 py-2 border rounded-lg text-sm transition-colors ${\r\n                markedOnly\r\n                  ? \"border-emerald-300 bg-emerald-50 text-emerald-800\"\r\n                  : \"border-gray-300 bg-white text-gray-700 hover:bg-gray-50\"\r\n              }`}\r\n              title={markedOnly ? \"Showing marked only (current page)\" : \"Show marked only (current page)\"}\r\n              aria-pressed={markedOnly}\r\n            >\r\n              <Bookmark className=\"h-4 w-4\" />\r\n              <span className=\"whitespace-nowrap\">Marked</span>\r\n              <span className=\"text-xs text-gray-500\">({markedKeys.length})</span>\r\n            </button>\r\n            {markedKeys.length > 0 && (\r\n              <button\r\n                type=\"button\"\r\n                onClick={() => setMarkedKeys([])}\r\n                className=\"px-3 py-2 border border-gray-300 bg-white rounded-lg text-sm text-gray-700 hover:bg-gray-50 transition-colors\"\r\n                title=\"Clear all marks\"\r\n              >\r\n                Clear\r\n              </button>\r\n            )}\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Bookings Table */}\r\n      <div className=\"bg-white rounded-lg border border-gray-200 shadow-sm overflow-hidden\">\r\n        {error && (\r\n          <div className=\"px-6 py-4 border-b border-gray-200 bg-amber-50 text-amber-900 text-sm flex items-start gap-2\">\r\n            <AlertTriangle className=\"h-4 w-4 mt-0.5 flex-shrink-0\" />\r\n            <div>{error}</div>\r\n          </div>\r\n        )}\r\n        {loading ? (\r\n          <>\r\n            {/* Skeleton Table */}\r\n            <div className=\"overflow-x-auto\">\r\n              <table className=\"w-full\">\r\n                <thead className=\"bg-gradient-to-r from-gray-50 to-gray-100 border-b border-gray-200\">\r\n                  <tr>\r\n                    <th className=\"px-3 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider\">&nbsp;</th>\r\n                    <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider\">Customer</th>\r\n                    <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider\">Destination</th>\r\n                    <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider\">Dates</th>\r\n                    <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider\">Urgency</th>\r\n                    <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider\">Group Details</th>\r\n                    <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider\">Pickup Info</th>\r\n                    <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider\">Created</th>\r\n                    <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider\">Status</th>\r\n                    <th className=\"px-6 py-3 text-right text-xs font-medium text-gray-600 uppercase tracking-wider\">Actions</th>\r\n                  </tr>\r\n                </thead>\r\n                <tbody className=\"bg-white divide-y divide-gray-200\">\r\n                  {[...Array(5)].map((_, i) => (\r\n                    <tr key={i} className=\"animate-pulse\">\r\n                      <td className=\"px-6 py-4 whitespace-nowrap\">\r\n                        <div className=\"h-4 bg-gray-200 rounded w-32 mb-2\"></div>\r\n                        <div className=\"h-3 bg-gray-200 rounded w-40\"></div>\r\n                      </td>\r\n                      <td className=\"px-6 py-4\">\r\n                        <div className=\"h-4 bg-gray-200 rounded w-24 mb-2\"></div>\r\n                        <div className=\"h-3 bg-gray-200 rounded w-32\"></div>\r\n                      </td>\r\n                      <td className=\"px-6 py-4 whitespace-nowrap\">\r\n                        <div className=\"h-4 bg-gray-200 rounded w-24\"></div>\r\n                      </td>\r\n                      <td className=\"px-6 py-4 whitespace-nowrap\">\r\n                        <div className=\"h-6 bg-gray-200 rounded w-20\"></div>\r\n                      </td>\r\n                      <td className=\"px-6 py-4\">\r\n                        <div className=\"h-4 bg-gray-200 rounded w-20 mb-2\"></div>\r\n                        <div className=\"h-3 bg-gray-200 rounded w-16\"></div>\r\n                      </td>\r\n                      <td className=\"px-6 py-4\">\r\n                        <div className=\"h-4 bg-gray-200 rounded w-28\"></div>\r\n                      </td>\r\n                      <td className=\"px-6 py-4 whitespace-nowrap\">\r\n                        <div className=\"h-6 bg-gray-200 rounded w-16\"></div>\r\n                      </td>\r\n                      <td className=\"px-6 py-4 whitespace-nowrap text-right\">\r\n                        <div className=\"h-8 bg-gray-200 rounded w-16 ml-auto\"></div>\r\n                      </td>\r\n                    </tr>\r\n                  ))}\r\n                </tbody>\r\n              </table>\r\n            </div>\r\n          </>\r\n        ) : visibleItems.length === 0 ? (\r\n          <div className=\"px-6 py-12 text-center\">\r\n            <Truck className=\"h-12 w-12 text-gray-300 mx-auto mb-3\" />\r\n            <p className=\"text-sm text-gray-500\">{markedOnly ? \"No marked transport bookings on this page.\" : \"No transport bookings found.\"}</p>\r\n          </div>\r\n        ) : (\r\n          <div className=\"overflow-x-auto\">\r\n            <table className=\"w-full\">\r\n              <thead className=\"bg-gradient-to-r from-gray-50 to-gray-100 border-b border-gray-200 sticky top-0 z-10\">\r\n                <tr>\r\n                  <th className=\"px-3 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider\">&nbsp;</th>\r\n                  <SortableHeader label=\"Customer\" keyName=\"customer\" />\r\n                  <SortableHeader label=\"Destination\" keyName=\"destination\" />\r\n                  <SortableHeader label=\"Dates\" keyName=\"date\" />\r\n                  <SortableHeader label=\"Urgency\" keyName=\"urgency\" />\r\n                  <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider\">Group Details</th>\r\n                  <SortableHeader label=\"Pickup Info\" keyName=\"pickup\" />\r\n                  <SortableHeader label=\"Created\" keyName=\"created\" />\r\n                  <SortableHeader label=\"Status\" keyName=\"status\" />\r\n                  <th className=\"px-6 py-3 text-right text-xs font-medium text-gray-600 uppercase tracking-wider\">Actions</th>\r\n                </tr>\r\n              </thead>\r\n              <tbody className=\"bg-white divide-y divide-gray-200\">\r\n                {visibleItems.map((booking) => (\r\n                  <tr\r\n                    key={`${booking.kind}:${booking.id}`}\r\n                    className=\"group hover:bg-gray-50 transition-colors duration-150 cursor-pointer\"\r\n                    onClick={(e) => {\r\n                      const el = e.target as HTMLElement | null;\r\n                      if (el?.closest(\"a,button,input,select,textarea\")) return;\r\n                      router.push(getViewHref(booking));\r\n                    }}\r\n                  >\r\n                    <td className=\"px-3 py-4 whitespace-nowrap\">\r\n                      <button\r\n                        type=\"button\"\r\n                        onClick={(e) => {\r\n                          e.preventDefault();\r\n                          e.stopPropagation();\r\n                          toggleMark(bookingKey(booking));\r\n                        }}\r\n                        aria-label={markedSet.has(bookingKey(booking)) ? \"Unmark\" : \"Mark\"}\r\n                        title={markedSet.has(bookingKey(booking)) ? \"Unmark\" : \"Mark\"}\r\n                        className=\"inline-flex items-center justify-center p-1 text-gray-400 hover:text-emerald-700 transition-colors\"\r\n                      >\r\n                        <Bookmark\r\n                          className={`h-4 w-4 ${markedSet.has(bookingKey(booking)) ? \"text-emerald-700\" : \"text-gray-400\"}`}\r\n                          fill={markedSet.has(bookingKey(booking)) ? \"currentColor\" : \"none\"}\r\n                        />\r\n                      </button>\r\n                    </td>\r\n                    <td className=\"px-6 py-4 whitespace-nowrap\">\r\n                      <div className=\"font-medium text-gray-900\">{booking.user.name || \"N/A\"}</div>\r\n                      <div className=\"text-sm text-gray-500 flex items-center gap-2\">\r\n                        <Mail className=\"h-3.5 w-3.5 text-gray-400\" />\r\n                        <span className=\"max-w-[240px] truncate\" title={booking.user.email || \"\"}>\r\n                          {booking.user.email || \"N/A\"}\r\n                        </span>\r\n                      </div>\r\n\r\n                      <div className=\"text-xs text-gray-400 flex items-center gap-2\">\r\n                        <Phone className=\"h-3.5 w-3.5 text-gray-300\" />\r\n                        <span className=\"max-w-[240px] truncate\" title={booking.user.phone || \"\"}>\r\n                          {booking.user.phone || \"—\"}\r\n                        </span>\r\n                      </div>\r\n                    </td>\r\n                    <td className=\"px-6 py-4\">\r\n                      <div className=\"flex items-center gap-2\">\r\n                        <MapPin className=\"h-4 w-4 text-gray-400 flex-shrink-0\" />\r\n                        <div>\r\n                          <div className=\"text-sm font-medium text-gray-900\">{booking.toRegion}</div>\r\n                          {booking.toLocation && (\r\n                            <div\r\n                              className=\"text-xs text-gray-500 max-w-[220px] sm:max-w-[320px] overflow-hidden\"\r\n                              title={booking.toLocation}\r\n                              style={{ display: \"-webkit-box\", WebkitLineClamp: 2, WebkitBoxOrient: \"vertical\" }}\r\n                            >\r\n                              {shortenText(booking.toLocation, 48)}\r\n                            </div>\r\n                          )}\r\n                        </div>\r\n                      </div>\r\n                    </td>\r\n                    <td className=\"px-6 py-4 whitespace-nowrap\">\r\n                      {booking.checkIn && booking.checkOut ? (\r\n                        <div className=\"flex items-start gap-2\">\r\n                          <Calendar className=\"h-4 w-4 text-gray-400 mt-0.5\" />\r\n                          <div className=\"space-y-1\">\r\n                            <div className=\"flex items-center gap-2\">\r\n                              <span className=\"h-2 w-2 rounded-full bg-emerald-500\" aria-hidden=\"true\" />\r\n                              <span className=\"text-sm font-medium text-gray-900\">{formatDateShort(booking.checkIn)}</span>\r\n                            </div>\r\n                            <div className=\"flex items-center gap-2\">\r\n                              <span className=\"h-2 w-2 rounded-full bg-rose-500\" aria-hidden=\"true\" />\r\n                              <span className=\"text-sm text-gray-700\">{formatDateShort(booking.checkOut)}</span>\r\n                            </div>\r\n                          </div>\r\n                        </div>\r\n                      ) : (\r\n                        <span className=\"text-sm text-gray-400\">Flexible</span>\r\n                      )}\r\n                    </td>\r\n                    <td className=\"px-6 py-4 whitespace-nowrap\">\r\n                      {getUrgencyBadge(booking.urgency, booking.urgencyReason)}\r\n                    </td>\r\n                    <td className=\"px-6 py-4\">\r\n                      <div className=\"text-sm\">\r\n                        <div className=\"font-medium text-gray-900\">{booking.kind === \"individual\" ? \"Individual\" : booking.groupType}</div>\r\n                        <div className=\"text-xs text-gray-500\">\r\n                          {booking.kind === \"individual\"\r\n                            ? `${booking.roomsQty ?? 1} room(s)`\r\n                            : `${booking.headcount ?? 0} people`}\r\n                        </div>\r\n                      </div>\r\n                    </td>\r\n                    <td className=\"px-6 py-4\">\r\n                      {booking.pickupLocation ? (\r\n                        <div className=\"text-sm space-y-1\">\r\n                          <div className=\"flex items-start gap-2\">\r\n                            <MapPin className=\"h-4 w-4 text-gray-400 flex-shrink-0 mt-0.5\" />\r\n                            <div\r\n                              className=\"font-medium text-gray-900 leading-snug max-w-[240px] sm:max-w-[340px] overflow-hidden\"\r\n                              title={booking.pickupLocation}\r\n                              style={{ display: \"-webkit-box\", WebkitLineClamp: 2, WebkitBoxOrient: \"vertical\" }}\r\n                            >\r\n                              {shortenText(booking.pickupLocation, 50)}\r\n                            </div>\r\n                          </div>\r\n\r\n                          {booking.pickupTime && (\r\n                            <div className=\"flex items-center gap-2 text-xs text-gray-500\">\r\n                              <Clock className=\"h-3.5 w-3.5 text-gray-400 flex-shrink-0\" />\r\n                              <span className=\"leading-snug\">{formatPickupTime(booking.pickupTime)}</span>\r\n                            </div>\r\n                          )}\r\n\r\n                          {booking.arrangementNotes && booking.kind === \"individual\" && (\r\n                            <div className=\"text-xs text-gray-500\">\r\n                              <span className=\"font-medium text-gray-600\">Vehicle:</span> {booking.arrangementNotes}\r\n                            </div>\r\n                          )}\r\n                        </div>\r\n                      ) : (\r\n                        <span className=\"text-sm text-gray-400\">—</span>\r\n                      )}\r\n                    </td>\r\n                    <td className=\"px-6 py-4 whitespace-nowrap\">\r\n                      {(() => {\r\n                        const v = formatDateTimeShort(booking.createdAt);\r\n                        if (!v) return <span className=\"text-sm text-gray-400\">—</span>;\r\n                        return (\r\n                          <div className=\"text-sm leading-snug\">\r\n                            <div className=\"font-medium text-gray-900\">{v.date}</div>\r\n                            <div className=\"text-xs text-gray-500\">{v.time}</div>\r\n                          </div>\r\n                        );\r\n                      })()}\r\n                    </td>\r\n                    <td className=\"px-6 py-4 whitespace-nowrap\">\r\n                      {getStatusIndicator(booking.status)}\r\n                    </td>\r\n                    <td className=\"px-6 py-4 whitespace-nowrap text-right\">\r\n                      <button\r\n                        type=\"button\"\r\n                        onClick={() => toggleMark(bookingKey(booking))}\r\n                        aria-label={markedSet.has(bookingKey(booking)) ? \"Unmark\" : \"Mark\"}\r\n                        title={markedSet.has(bookingKey(booking)) ? \"Unmark\" : \"Mark\"}\r\n                        className=\"inline-flex items-center justify-center text-gray-400 hover:text-amber-600 transition-colors mr-3\"\r\n                      >\r\n                        <Bookmark\r\n                          className={`h-4 w-4 ${markedSet.has(bookingKey(booking)) ? \"text-amber-600\" : \"\"}`}\r\n                          fill={markedSet.has(bookingKey(booking)) ? \"currentColor\" : \"none\"}\r\n                        />\r\n                      </button>\r\n                      <Link\r\n                        href={getViewHref(booking)}\r\n                        aria-label=\"View\"\r\n                        title=\"View\"\r\n                        className=\"inline-flex items-center text-emerald-600 hover:text-emerald-900 text-sm font-medium\"\r\n                      >\r\n                        <Eye className=\"h-4 w-4\" />\r\n                        <span className=\"sr-only\">View</span>\r\n                      </Link>\r\n                    </td>\r\n                  </tr>\r\n                ))}\r\n              </tbody>\r\n            </table>\r\n          </div>\r\n        )}\r\n      </div>\r\n\r\n      {/* Pagination */}\r\n      {items.length > 0 && (\r\n        <div className=\"flex items-center justify-between bg-white rounded-lg border border-gray-200 p-4 shadow-sm\">\r\n          <div className=\"text-sm text-gray-500\">\r\n            Showing {((page - 1) * pageSize) + 1} to {Math.min(page * pageSize, total)} of {total} bookings\r\n          </div>\r\n          <div className=\"flex gap-2\">\r\n            <button\r\n              disabled={page <= 1}\r\n              onClick={() => setPage(p => p - 1)}\r\n              className=\"px-4 py-2 rounded-lg border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors\"\r\n            >\r\n              Previous\r\n            </button>\r\n            <div className=\"px-4 py-2 text-sm font-medium text-gray-700\">\r\n              Page {page} of {pages}\r\n            </div>\r\n            <button\r\n              disabled={page >= pages}\r\n              onClick={() => setPage(p => p + 1)}\r\n              className=\"px-4 py-2 rounded-lg border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors\"\r\n            >\r\n              Next\r\n            </button>\r\n          </div>\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\admin\\verification-policy\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(admin)\\layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(auth)\\admin\\login\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(auth)\\driver\\login\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(auth)\\layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(auth)\\owner\\login\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(driver)\\driver\\bonus\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(driver)\\driver\\earnings\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(driver)\\driver\\history\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(driver)\\driver\\invoices\\[id]\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(driver)\\driver\\invoices\\[id]\\print\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(driver)\\driver\\invoices\\[id]\\send\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(driver)\\driver\\invoices\\[id]\\viewer\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(driver)\\driver\\invoices\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(driver)\\driver\\layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(driver)\\driver\\level\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'TrendingUp' is defined but never used. Allowed unused vars must match /^_/u.","line":4,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":28,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"TrendingUp"},"fix":{"range":[93,105],"text":""},"desc":"Remove unused variable \"TrendingUp\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'MapPin' is defined but never used. Allowed unused vars must match /^_/u.","line":4,"column":84,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":90,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"MapPin"},"fix":{"range":[159,167],"text":""},"desc":"Remove unused variable \"MapPin\"."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport React, { useEffect, useState, useRef } from \"react\";\r\nimport { Trophy, TrendingUp, Star, Target, Award, CheckCircle, Clock, AlertCircle, MapPin, Users, DollarSign, MessageSquare, Send } from \"lucide-react\";\r\nimport axios from \"axios\";\r\nimport { io, Socket } from \"socket.io-client\";\r\n\r\nconst api = axios.create({ baseURL: \"\", withCredentials: true });\r\n\r\ninterface LevelData {\r\n  currentLevel: number;\r\n  levelName: string;\r\n  nextLevel: number;\r\n  nextLevelName: string;\r\n  totalEarnings: number;\r\n  earningsForNextLevel: number;\r\n  totalTrips: number;\r\n  tripsForNextLevel: number;\r\n  averageRating: number;\r\n  ratingForNextLevel: number;\r\n  totalReviews: number;\r\n  reviewsForNextLevel: number;\r\n  goalsCompleted: number;\r\n  goalsForNextLevel: number;\r\n  progress: {\r\n    earnings: number; // percentage\r\n    trips: number;\r\n    rating: number;\r\n    reviews: number;\r\n    goals: number;\r\n  };\r\n  levelBenefits: string[];\r\n  nextLevelBenefits: string[];\r\n}\r\n\r\n// Skeleton loader components\r\nconst LevelCardSkeleton = () => (\r\n  <div className=\"bg-white rounded-xl p-6 border-2 border-slate-200 shadow-sm animate-pulse\">\r\n    <div className=\"h-6 bg-slate-200 rounded w-1/3 mb-4\"></div>\r\n    <div className=\"h-4 bg-slate-200 rounded w-2/3 mb-2\"></div>\r\n    <div className=\"h-4 bg-slate-200 rounded w-1/2\"></div>\r\n  </div>\r\n);\r\n\r\nconst ProgressCardSkeleton = () => (\r\n  <div className=\"bg-white rounded-xl p-6 border-2 border-slate-200 shadow-sm animate-pulse\">\r\n    <div className=\"h-5 bg-slate-200 rounded w-1/4 mb-4\"></div>\r\n    <div className=\"h-3 bg-slate-200 rounded w-full mb-2\"></div>\r\n    <div className=\"h-4 bg-slate-200 rounded w-1/3\"></div>\r\n  </div>\r\n);\r\n\r\nexport default function DriverLevel() {\r\n  const [levelData, setLevelData] = useState<LevelData | null>(null);\r\n  const [loading, setLoading] = useState(true);\r\n  const [error, setError] = useState<string | null>(null);\r\n  const [messages, setMessages] = useState<Array<{ id: number; message: string; from: 'driver' | 'admin'; timestamp: string; adminName?: string }>>([]);\r\n  const [messageInput, setMessageInput] = useState(\"\");\r\n  const socketRef = useRef<Socket | null>(null);\r\n  const [notification, setNotification] = useState<{ message: string; type: 'success' | 'info' } | null>(null);\r\n\r\n  // Add custom animations\r\n  useEffect(() => {\r\n    const style = document.createElement('style');\r\n    style.textContent = `\r\n      @keyframes fade-in {\r\n        from { opacity: 0; }\r\n        to { opacity: 1; }\r\n      }\r\n      @keyframes fade-in-up {\r\n        from {\r\n          opacity: 0;\r\n          transform: translateY(20px);\r\n        }\r\n        to {\r\n          opacity: 1;\r\n          transform: translateY(0);\r\n        }\r\n      }\r\n      @keyframes slide-in-left {\r\n        from {\r\n          opacity: 0;\r\n          transform: translateX(-20px);\r\n        }\r\n        to {\r\n          opacity: 1;\r\n          transform: translateX(0);\r\n        }\r\n      }\r\n      @keyframes scale-in {\r\n        from {\r\n          opacity: 0;\r\n          transform: scale(0.9);\r\n        }\r\n        to {\r\n          opacity: 1;\r\n          transform: scale(1);\r\n        }\r\n      }\r\n      .animate-fade-in {\r\n        animation: fade-in 0.6s ease-out forwards;\r\n      }\r\n      .animate-fade-in-up {\r\n        animation: fade-in-up 0.6s ease-out forwards;\r\n        opacity: 0;\r\n      }\r\n      .animate-slide-in-left {\r\n        animation: slide-in-left 0.6s ease-out forwards;\r\n        opacity: 0;\r\n      }\r\n      .animate-scale-in {\r\n        animation: scale-in 0.6s ease-out forwards;\r\n        opacity: 0;\r\n      }\r\n      .delay-100 { animation-delay: 0.1s; }\r\n      .delay-200 { animation-delay: 0.2s; }\r\n      .delay-300 { animation-delay: 0.3s; }\r\n      .delay-400 { animation-delay: 0.4s; }\r\n      .delay-500 { animation-delay: 0.5s; }\r\n      .delay-600 { animation-delay: 0.6s; }\r\n      .delay-700 { animation-delay: 0.7s; }\r\n      .delay-800 { animation-delay: 0.8s; }\r\n      .delay-900 { animation-delay: 0.9s; }\r\n    `;\r\n    style.setAttribute('data-level-animations', 'true');\r\n    if (!document.head.querySelector('style[data-level-animations]')) {\r\n      document.head.appendChild(style);\r\n    }\r\n    return () => {\r\n      const existingStyle = document.head.querySelector('style[data-level-animations]');\r\n      if (existingStyle) {\r\n        document.head.removeChild(existingStyle);\r\n      }\r\n    };\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    const fetchLevelData = async () => {\r\n      try {\r\n        setLoading(true);\r\n        // Fetch level data from API\r\n        const response = await api.get(\"/api/driver/level\");\r\n\r\n        if (response.status === 200 && response.data) {\r\n          setLevelData(response.data);\r\n          setError(null);\r\n        } else {\r\n          setError(\"Failed to load level data\");\r\n        }\r\n      } catch (err: any) {\r\n        console.error(\"Error fetching level data:\", err);\r\n        if (err.response?.status === 401) {\r\n          setError(\"Please log in to view your driver level\");\r\n        } else if (err.response?.status === 404) {\r\n          setError(\"Level data not found\");\r\n        } else {\r\n          setError(\"Failed to load level data. Please try again later.\");\r\n        }\r\n      } finally {\r\n        setLoading(false);\r\n      }\r\n    };\r\n\r\n    fetchLevelData();\r\n\r\n    // Setup Socket.IO for real-time responses\r\n    const socket = io(process.env.NEXT_PUBLIC_API_URL || \"http://localhost:4000\", {\r\n      transports: [\"websocket\"],\r\n    });\r\n\r\n    socket.on(\"connect\", async () => {\r\n      console.log(\"Socket connected for level messages\");\r\n      try {\r\n        const me = await fetch(\"/api/account/me\", { credentials: \"include\" }).then((r) => (r.ok ? r.json() : null));\r\n        if (me?.id) socket.emit(\"join-driver-room\", { driverId: me.id });\r\n      } catch {}\r\n    });\r\n\r\n      // Listen for admin responses\r\n      socket.on(\"admin-level-message-response\", (data: { messageId: number; response: string; adminName: string; timestamp: string }) => {\r\n        setMessages((prev) => [\r\n          ...prev,\r\n          {\r\n            id: Date.now(),\r\n            message: data.response,\r\n            from: 'admin',\r\n            timestamp: data.timestamp,\r\n            adminName: data.adminName,\r\n          },\r\n        ]);\r\n        setNotification({ message: `New response from ${data.adminName}`, type: 'success' });\r\n        setTimeout(() => setNotification(null), 5000);\r\n      });\r\n\r\n    socketRef.current = socket;\r\n\r\n    return () => {\r\n      socket.disconnect();\r\n    };\r\n  }, []);\r\n\r\n  // Helper function to send message to admin\r\n  const sendMessageToAdmin = async (message: string) => {\r\n    try {\r\n      const response = await api.post(\"/api/driver/level/message\", { message });\r\n\r\n      if (response.status === 200) {\r\n        // Add message to local state\r\n        setMessages((prev) => [\r\n          ...prev,\r\n          {\r\n            id: Date.now(),\r\n            message,\r\n            from: 'driver' as const,\r\n            timestamp: new Date().toISOString(),\r\n          },\r\n        ]);\r\n      }\r\n    } catch (err: any) {\r\n      console.error(\"Error sending message:\", err);\r\n      alert(\"Failed to send message. Please try again.\");\r\n    }\r\n  };\r\n\r\n  const getLevelBenefits = (level: number): string[] => {\r\n    const benefits: { [key: number]: string[] } = {\r\n      1: [\"Standard support\", \"Standard commission rate\", \"Access to basic features\", \"Basic trip assignments\"],\r\n      2: [\"Priority support\", \"10% bonus on earnings\", \"Access to premium features\", \"Priority trip assignments\", \"Early access to new features\"],\r\n      3: [\"Elite support\", \"20% bonus on earnings\", \"Access to all features\", \"Highest priority assignments\", \"Exclusive partnerships\", \"Lifetime benefits\", \"Brand Ambassador\", \"Invited to events\"],\r\n    };\r\n    return benefits[level] || benefits[1];\r\n  };\r\n\r\n  const getLevelColor = (level: number): string => {\r\n    const colors: { [key: number]: string } = {\r\n      1: \"bg-slate-400\",  // Silver\r\n      2: \"bg-yellow-400\", // Gold\r\n      3: \"bg-purple-500\", // Diamond\r\n    };\r\n    return colors[level] || colors[1];\r\n  };\r\n\r\n  const getLevelTextColor = (level: number): string => {\r\n    const colors: { [key: number]: string } = {\r\n      1: \"text-slate-600\",  // Silver\r\n      2: \"text-yellow-600\", // Gold\r\n      3: \"text-purple-600\", // Diamond\r\n    };\r\n    return colors[level] || colors[1];\r\n  };\r\n\r\n  if (loading) {\r\n    return (\r\n      <div className=\"w-full max-w-full space-y-6 overflow-x-hidden\">\r\n        <div className=\"w-full text-center\">\r\n          <div className=\"flex flex-col items-center mb-6\">\r\n            <Trophy className=\"w-8 h-8 text-emerald-600 mb-2\" />\r\n            <h1 className=\"text-2xl font-bold text-slate-900\">Driver Level</h1>\r\n          </div>\r\n        </div>\r\n        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\r\n          <LevelCardSkeleton />\r\n          <LevelCardSkeleton />\r\n          <ProgressCardSkeleton />\r\n          <ProgressCardSkeleton />\r\n          <ProgressCardSkeleton />\r\n          <ProgressCardSkeleton />\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  if (error && !loading) {\r\n    return (\r\n      <div className=\"w-full max-w-full space-y-6 overflow-x-hidden\">\r\n        <div className=\"w-full text-center\">\r\n          <div className=\"flex flex-col items-center mb-6\">\r\n            <Trophy className=\"w-8 h-8 text-emerald-600 mb-2\" />\r\n            <h1 className=\"text-2xl font-bold text-slate-900\">Driver Level</h1>\r\n          </div>\r\n        </div>\r\n        <div className=\"bg-red-50 border-2 border-red-200 rounded-xl p-6 text-center\">\r\n          <AlertCircle className=\"w-8 h-8 text-red-600 mx-auto mb-2\" />\r\n          <p className=\"text-red-800 font-medium\">{error}</p>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  if (!levelData && !loading) {\r\n    return (\r\n      <div className=\"w-full max-w-full space-y-6 overflow-x-hidden\">\r\n        <div className=\"w-full text-center\">\r\n          <div className=\"flex flex-col items-center mb-6\">\r\n            <Trophy className=\"w-8 h-8 text-emerald-600 mb-2\" />\r\n            <h1 className=\"text-2xl font-bold text-slate-900\">Driver Level</h1>\r\n          </div>\r\n        </div>\r\n        <div className=\"bg-slate-50 border-2 border-slate-200 rounded-xl p-6 text-center\">\r\n          <AlertCircle className=\"w-8 h-8 text-slate-400 mx-auto mb-2\" />\r\n          <p className=\"text-slate-600 font-medium\">No level data available</p>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  if (!levelData) {\r\n    return null;\r\n  }\r\n\r\n  const overallProgress = levelData.currentLevel === 3 \r\n    ? 100 \r\n    : Math.round(\r\n        (levelData.progress.earnings + \r\n         levelData.progress.trips + \r\n         levelData.progress.rating + \r\n         levelData.progress.reviews + \r\n         levelData.progress.goals) / 5\r\n      );\r\n\r\n  return (\r\n    <div className=\"w-full max-w-full space-y-6 overflow-x-hidden\">\r\n      {/* Notification Banner */}\r\n      {notification && (\r\n        <div className={`fixed top-4 right-4 z-50 px-4 py-3 rounded-lg shadow-lg flex items-center gap-2 ${\r\n          notification.type === 'success' ? 'bg-emerald-500 text-white' : 'bg-blue-500 text-white'\r\n        } animate-fade-in`}>\r\n          <CheckCircle className=\"h-5 w-5\" />\r\n          <span>{notification.message}</span>\r\n          <button onClick={() => setNotification(null)} className=\"ml-2 hover:opacity-75\">\r\n            ×\r\n          </button>\r\n        </div>\r\n      )}\r\n\r\n      {/* Header */}\r\n      <div className=\"w-full text-center\">\r\n        <div className=\"flex flex-col items-center mb-6\">\r\n          <Trophy className={`w-8 h-8 ${getLevelTextColor(levelData.currentLevel)} mb-2 animate-pulse transition-transform duration-300 hover:scale-110`} />\r\n          <h1 className=\"text-2xl font-bold text-slate-900 animate-fade-in\">Driver Level</h1>\r\n          <p className=\"text-slate-600 mt-1 animate-fade-in-up delay-100 transition-all duration-500 hover:text-emerald-600\">Track your progress and unlock new benefits</p>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Current Level Card */}\r\n      <div className=\"bg-white rounded-xl p-6 border-2 border-slate-200 shadow-sm transition-all duration-300 hover:shadow-lg animate-fade-in-up delay-200\">\r\n        <div className=\"flex items-center justify-between mb-4\">\r\n          <div>\r\n            <h2 className=\"text-lg font-semibold text-slate-900 transition-colors duration-300\">Current Level</h2>\r\n            <p className=\"text-sm text-slate-600 transition-colors duration-300\">Your current driver status</p>\r\n          </div>\r\n          <div className={`${getLevelColor(levelData.currentLevel)} text-white px-4 py-2 rounded-lg font-bold text-xl transition-all duration-300 hover:scale-105 animate-scale-in delay-300`}>\r\n            {levelData.levelName}\r\n          </div>\r\n        </div>\r\n\r\n        {levelData.currentLevel < 3 && (\r\n          <div className=\"mt-4\">\r\n            <div className=\"flex items-center justify-between mb-2\">\r\n              <span className=\"text-sm font-medium text-slate-700\">Progress to {levelData.nextLevelName}</span>\r\n              <span className=\"text-sm font-semibold text-emerald-600\">{overallProgress}%</span>\r\n            </div>\r\n            <div className=\"w-full bg-slate-200 rounded-full h-3\">\r\n              <div\r\n                className={`${getLevelColor(levelData.nextLevel)} h-3 rounded-full transition-all duration-500`}\r\n                style={{ width: `${overallProgress}%` }}\r\n              />\r\n            </div>\r\n          </div>\r\n        )}\r\n      </div>\r\n\r\n      {/* Progress Metrics */}\r\n      <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\r\n        {/* Earnings Progress */}\r\n        <div className=\"bg-white rounded-xl p-6 border-2 border-slate-200 shadow-sm transition-all duration-300 hover:shadow-lg hover:scale-105 hover:border-emerald-300 animate-fade-in-up delay-400\">\r\n          <div className=\"flex items-center gap-3 mb-4\">\r\n            <DollarSign className=\"w-5 h-5 text-emerald-600 flex-shrink-0 transition-transform duration-300 hover:scale-110\" />\r\n            <div>\r\n              <h3 className=\"font-semibold text-slate-900 transition-colors duration-300\">Total Earnings</h3>\r\n              <p className=\"text-sm text-slate-600 transition-colors duration-300\">\r\n                {levelData.totalEarnings.toLocaleString()} TZS / {levelData.earningsForNextLevel > 0 ? levelData.earningsForNextLevel.toLocaleString() : \"Max\"} TZS\r\n              </p>\r\n            </div>\r\n          </div>\r\n          <div className=\"w-full bg-slate-200 rounded-full h-2 mb-2\">\r\n            <div\r\n              className=\"bg-emerald-500 h-2 rounded-full transition-all duration-500\"\r\n              style={{ width: `${Math.min(levelData.progress.earnings, 100)}%` }}\r\n            />\r\n          </div>\r\n          <p className=\"text-xs text-slate-500\">\r\n            {levelData.currentLevel === 3 \r\n              ? \"Maximum level reached!\" \r\n              : `${((levelData.earningsForNextLevel - levelData.totalEarnings) / 1000).toFixed(0)}K TZS to next level`}\r\n          </p>\r\n        </div>\r\n\r\n        {/* Trips Progress */}\r\n        <div className=\"bg-white rounded-xl p-6 border-2 border-slate-200 shadow-sm transition-all duration-300 hover:shadow-lg hover:scale-105 hover:border-blue-300 animate-fade-in-up delay-500\">\r\n          <div className=\"flex items-center gap-3 mb-4\">\r\n            <Users className=\"w-5 h-5 text-blue-600 flex-shrink-0 transition-transform duration-300 hover:scale-110\" />\r\n            <div>\r\n              <h3 className=\"font-semibold text-slate-900 transition-colors duration-300\">Total Trips</h3>\r\n              <p className=\"text-sm text-slate-600 transition-colors duration-300\">\r\n                {levelData.totalTrips.toLocaleString()} / {levelData.tripsForNextLevel > 0 ? levelData.tripsForNextLevel.toLocaleString() : \"Max\"}\r\n              </p>\r\n            </div>\r\n          </div>\r\n          <div className=\"w-full bg-slate-200 rounded-full h-2 mb-2\">\r\n            <div\r\n              className=\"bg-blue-500 h-2 rounded-full transition-all duration-500\"\r\n              style={{ width: `${Math.min(levelData.progress.trips, 100)}%` }}\r\n            />\r\n          </div>\r\n          <p className=\"text-xs text-slate-500\">\r\n            {levelData.currentLevel === 3 \r\n              ? \"Maximum level reached!\" \r\n              : `${Math.round(levelData.tripsForNextLevel - levelData.totalTrips)} trips to next level`}\r\n          </p>\r\n        </div>\r\n\r\n        {/* Rating Progress */}\r\n        <div className=\"bg-white rounded-xl p-6 border-2 border-slate-200 shadow-sm transition-all duration-300 hover:shadow-lg hover:scale-105 hover:border-yellow-300 animate-fade-in-up delay-600\">\r\n          <div className=\"flex items-center gap-3 mb-4\">\r\n            <Star className=\"w-5 h-5 text-yellow-600 flex-shrink-0 transition-transform duration-300 hover:scale-110\" />\r\n            <div>\r\n              <h3 className=\"font-semibold text-slate-900 transition-colors duration-300\">Average Rating</h3>\r\n              <p className=\"text-sm text-slate-600 transition-colors duration-300\">\r\n                {levelData.averageRating.toFixed(1)} / {levelData.ratingForNextLevel > 0 ? levelData.ratingForNextLevel.toFixed(1) : \"Max\"}\r\n              </p>\r\n            </div>\r\n          </div>\r\n          <div className=\"w-full bg-slate-200 rounded-full h-2 mb-2\">\r\n            <div\r\n              className=\"bg-yellow-500 h-2 rounded-full transition-all duration-500\"\r\n              style={{ width: `${Math.min(levelData.progress.rating, 100)}%` }}\r\n            />\r\n          </div>\r\n          <p className=\"text-xs text-slate-500\">\r\n            {levelData.currentLevel === 3 \r\n              ? \"Maximum level reached!\" \r\n              : `Maintain ${levelData.ratingForNextLevel.toFixed(1)}+ rating`}\r\n          </p>\r\n        </div>\r\n\r\n        {/* Reviews Progress */}\r\n        <div className=\"bg-white rounded-xl p-6 border-2 border-slate-200 shadow-sm transition-all duration-300 hover:shadow-lg hover:scale-105 hover:border-purple-300 animate-fade-in-up delay-700\">\r\n          <div className=\"flex items-center gap-3 mb-4\">\r\n            <Users className=\"w-5 h-5 text-purple-600 flex-shrink-0 transition-transform duration-300 hover:scale-110\" />\r\n            <div>\r\n              <h3 className=\"font-semibold text-slate-900 transition-colors duration-300\">Total Reviews</h3>\r\n              <p className=\"text-sm text-slate-600 transition-colors duration-300\">\r\n                {levelData.totalReviews.toLocaleString()} / {levelData.reviewsForNextLevel > 0 ? levelData.reviewsForNextLevel.toLocaleString() : \"Max\"}\r\n              </p>\r\n            </div>\r\n          </div>\r\n          <div className=\"w-full bg-slate-200 rounded-full h-2 mb-2\">\r\n            <div\r\n              className=\"bg-purple-500 h-2 rounded-full transition-all duration-500\"\r\n              style={{ width: `${Math.min(levelData.progress.reviews, 100)}%` }}\r\n            />\r\n          </div>\r\n          <p className=\"text-xs text-slate-500\">\r\n            {levelData.currentLevel === 3 \r\n              ? \"Maximum level reached!\" \r\n              : `${Math.round(levelData.reviewsForNextLevel - levelData.totalReviews)} reviews to next level`}\r\n          </p>\r\n        </div>\r\n\r\n        {/* Goals Progress */}\r\n        <div className=\"bg-white rounded-xl p-6 border-2 border-slate-200 shadow-sm md:col-span-2 transition-all duration-300 hover:shadow-lg hover:scale-[1.02] hover:border-emerald-300 animate-fade-in-up delay-800\">\r\n          <div className=\"flex items-center gap-3 mb-4\">\r\n            <Target className=\"w-5 h-5 text-emerald-600 flex-shrink-0 transition-transform duration-300 hover:scale-110\" />\r\n            <div>\r\n              <h3 className=\"font-semibold text-slate-900 transition-colors duration-300\">Goals Accomplished</h3>\r\n              <p className=\"text-sm text-slate-600 transition-colors duration-300\">\r\n                {levelData.goalsCompleted} / {levelData.goalsForNextLevel > 0 ? levelData.goalsForNextLevel : \"Max\"}\r\n              </p>\r\n            </div>\r\n          </div>\r\n          <div className=\"w-full bg-slate-200 rounded-full h-2 mb-2\">\r\n            <div\r\n              className=\"bg-emerald-500 h-2 rounded-full transition-all duration-500\"\r\n              style={{ width: `${Math.min(levelData.progress.goals, 100)}%` }}\r\n            />\r\n          </div>\r\n          <p className=\"text-xs text-slate-500\">\r\n            {levelData.currentLevel === 3 \r\n              ? \"Maximum level reached!\" \r\n              : `${Math.round(levelData.goalsForNextLevel - levelData.goalsCompleted)} goals to next level`}\r\n          </p>\r\n        </div>\r\n      </div>\r\n\r\n      {/* All Levels Benefits Section */}\r\n      <div className=\"bg-white rounded-xl p-6 border-2 border-slate-200 shadow-sm transition-all duration-300 hover:shadow-lg animate-fade-in-up delay-900\">\r\n        <div className=\"flex items-center gap-2 mb-6\">\r\n          <Award className=\"w-6 h-6 text-emerald-600 transition-transform duration-300 hover:scale-110\" />\r\n          <h2 className=\"text-xl font-semibold text-slate-900 transition-colors duration-300\">Level Benefits</h2>\r\n        </div>\r\n\r\n        <div className=\"grid grid-cols-1 md:grid-cols-3 gap-6\">\r\n          {/* Silver Level */}\r\n          <div className={`relative rounded-lg p-5 border-2 transition-all duration-300 hover:shadow-md hover:scale-105 ${\r\n            levelData.currentLevel >= 1 \r\n              ? 'border-emerald-500 bg-emerald-50' \r\n              : 'border-slate-200 bg-slate-50'\r\n          } animate-slide-in-left delay-300`}>\r\n            <div className=\"flex items-center justify-between mb-4\">\r\n              <div className={`${getLevelColor(1)} text-white px-3 py-1 rounded-lg font-bold text-sm`}>\r\n                Silver\r\n              </div>\r\n              {levelData.currentLevel >= 1 && (\r\n                <CheckCircle className=\"w-5 h-5 text-emerald-600\" />\r\n              )}\r\n            </div>\r\n            <ul className=\"space-y-2\">\r\n              {getLevelBenefits(1).map((benefit, index) => (\r\n                <li key={index} className=\"flex items-start gap-2 text-sm text-slate-700\">\r\n                  <CheckCircle className={`w-4 h-4 mt-0.5 flex-shrink-0 ${\r\n                    levelData.currentLevel >= 1 ? 'text-emerald-600' : 'text-slate-300'\r\n                  }`} />\r\n                  <span className={levelData.currentLevel >= 1 ? 'text-slate-900' : 'text-slate-500'}>{benefit}</span>\r\n                </li>\r\n              ))}\r\n            </ul>\r\n            {levelData.currentLevel >= 1 && (\r\n              <div className=\"mt-4 pt-3 border-t border-emerald-200\">\r\n                <span className=\"text-xs font-medium text-emerald-700\">✓ Achieved</span>\r\n              </div>\r\n            )}\r\n          </div>\r\n\r\n          {/* Gold Level */}\r\n          <div className={`relative rounded-lg p-5 border-2 transition-all duration-300 hover:shadow-md hover:scale-105 ${\r\n            levelData.currentLevel >= 2 \r\n              ? 'border-yellow-500 bg-yellow-50' \r\n              : levelData.currentLevel === 1\r\n              ? 'border-yellow-300 bg-yellow-50/50'\r\n              : 'border-slate-200 bg-slate-50'\r\n          } animate-slide-in-left delay-400`}>\r\n            <div className=\"flex items-center justify-between mb-4\">\r\n              <div className={`${getLevelColor(2)} text-white px-3 py-1 rounded-lg font-bold text-sm`}>\r\n                Gold\r\n              </div>\r\n              {levelData.currentLevel >= 2 ? (\r\n                <CheckCircle className=\"w-5 h-5 text-yellow-600\" />\r\n              ) : levelData.currentLevel === 1 ? (\r\n                <Clock className=\"w-5 h-5 text-yellow-500\" />\r\n              ) : null}\r\n            </div>\r\n            <ul className=\"space-y-2\">\r\n              {getLevelBenefits(2).map((benefit, index) => (\r\n                <li key={index} className=\"flex items-start gap-2 text-sm text-slate-700\">\r\n                  {levelData.currentLevel >= 2 ? (\r\n                    <CheckCircle className=\"w-4 h-4 text-yellow-600 mt-0.5 flex-shrink-0\" />\r\n                  ) : (\r\n                    <Clock className=\"w-4 h-4 text-slate-400 mt-0.5 flex-shrink-0\" />\r\n                  )}\r\n                  <span className={levelData.currentLevel >= 2 ? 'text-slate-900' : 'text-slate-500'}>{benefit}</span>\r\n                </li>\r\n              ))}\r\n            </ul>\r\n            {levelData.currentLevel >= 2 ? (\r\n              <div className=\"mt-4 pt-3 border-t border-yellow-200\">\r\n                <span className=\"text-xs font-medium text-yellow-700\">✓ Achieved</span>\r\n              </div>\r\n            ) : levelData.currentLevel === 1 ? (\r\n              <div className=\"mt-4 pt-3 border-t border-yellow-200\">\r\n                <span className=\"text-xs font-medium text-yellow-600\">→ Next Level</span>\r\n              </div>\r\n            ) : null}\r\n          </div>\r\n\r\n          {/* Diamond Level */}\r\n          <div className={`relative rounded-lg p-5 border-2 transition-all duration-300 hover:shadow-md hover:scale-105 ${\r\n            levelData.currentLevel >= 3 \r\n              ? 'border-purple-500 bg-purple-50' \r\n              : levelData.currentLevel === 2\r\n              ? 'border-purple-300 bg-purple-50/50'\r\n              : 'border-slate-200 bg-slate-50'\r\n          } animate-slide-in-left delay-500`}>\r\n            <div className=\"flex items-center justify-between mb-4\">\r\n              <div className={`${getLevelColor(3)} text-white px-3 py-1 rounded-lg font-bold text-sm`}>\r\n                Diamond\r\n              </div>\r\n              {levelData.currentLevel >= 3 ? (\r\n                <CheckCircle className=\"w-5 h-5 text-purple-600\" />\r\n              ) : levelData.currentLevel === 2 ? (\r\n                <Clock className=\"w-5 h-5 text-purple-500\" />\r\n              ) : null}\r\n            </div>\r\n            <ul className=\"space-y-2\">\r\n              {getLevelBenefits(3).map((benefit, index) => (\r\n                <li key={index} className=\"flex items-start gap-2 text-sm text-slate-700\">\r\n                  {levelData.currentLevel >= 3 ? (\r\n                    <CheckCircle className=\"w-4 h-4 text-purple-600 mt-0.5 flex-shrink-0\" />\r\n                  ) : (\r\n                    <Clock className=\"w-4 h-4 text-slate-400 mt-0.5 flex-shrink-0\" />\r\n                  )}\r\n                  <span className={levelData.currentLevel >= 3 ? 'text-slate-900' : 'text-slate-500'}>{benefit}</span>\r\n                </li>\r\n              ))}\r\n            </ul>\r\n            {levelData.currentLevel >= 3 ? (\r\n              <div className=\"mt-4 pt-3 border-t border-purple-200\">\r\n                <span className=\"text-xs font-medium text-purple-700\">✓ Achieved</span>\r\n              </div>\r\n            ) : levelData.currentLevel === 2 ? (\r\n              <div className=\"mt-4 pt-3 border-t border-purple-200\">\r\n                <span className=\"text-xs font-medium text-purple-600\">→ Next Level</span>\r\n              </div>\r\n            ) : null}\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Communication Section */}\r\n      <div className=\"bg-white rounded-xl p-6 border-2 border-slate-200 shadow-sm transition-all duration-300 hover:shadow-lg animate-fade-in-up delay-900\">\r\n        <div className=\"flex items-center gap-2 mb-6\">\r\n          <MessageSquare className=\"w-6 h-6 text-emerald-600 transition-transform duration-300 hover:scale-110\" />\r\n          <h2 className=\"text-xl font-semibold text-slate-900 transition-colors duration-300\">Level Communication</h2>\r\n        </div>\r\n        <p className=\"text-sm text-slate-600 mb-4\">\r\n          Have questions about your level or benefits? Send a message to the admin team.\r\n        </p>\r\n        \r\n        {/* Messages Display */}\r\n        {messages.length > 0 && (\r\n          <div className=\"mb-4 space-y-3 max-h-64 overflow-y-auto border-2 border-slate-200 rounded-lg p-4\">\r\n            {messages.map((msg) => (\r\n              <div\r\n                key={msg.id}\r\n                className={`p-3 rounded-lg ${\r\n                  msg.from === 'driver'\r\n                    ? 'bg-emerald-50 border border-emerald-200 ml-auto max-w-[80%]'\r\n                    : 'bg-blue-50 border border-blue-200 mr-auto max-w-[80%]'\r\n                }`}\r\n              >\r\n                <div className=\"flex items-center gap-2 mb-1\">\r\n                  <span className=\"text-xs font-semibold text-slate-700\">\r\n                    {msg.from === 'admin' ? (msg.adminName || 'Admin') : 'You'}\r\n                  </span>\r\n                  <span className=\"text-xs text-slate-500\">\r\n                    {new Date(msg.timestamp).toLocaleString()}\r\n                  </span>\r\n                </div>\r\n                <p className=\"text-sm text-slate-900\">{msg.message}</p>\r\n              </div>\r\n            ))}\r\n          </div>\r\n        )}\r\n        \r\n        <div className=\"space-y-4\">\r\n          <div className=\"flex gap-3\">\r\n            <input\r\n              type=\"text\"\r\n              value={messageInput}\r\n              onChange={(e) => setMessageInput(e.target.value)}\r\n              placeholder=\"Type your message here...\"\r\n              className=\"flex-1 px-4 py-2 border-2 border-slate-300 rounded-lg focus:outline-none focus:border-emerald-500 transition-colors\"\r\n              onKeyDown={async (e) => {\r\n                if (e.key === 'Enter' && messageInput.trim()) {\r\n                  await sendMessageToAdmin(messageInput.trim());\r\n                  setMessageInput('');\r\n                }\r\n              }}\r\n            />\r\n            <button\r\n              onClick={async () => {\r\n                if (messageInput.trim()) {\r\n                  await sendMessageToAdmin(messageInput.trim());\r\n                  setMessageInput('');\r\n                }\r\n              }}\r\n              className=\"px-6 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition-all duration-300 hover:scale-105 flex items-center gap-2\"\r\n            >\r\n              <Send className=\"w-4 h-4\" />\r\n              Send\r\n            </button>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(driver)\\driver\\management\\DriverManagementPageClient.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(driver)\\driver\\management\\contract\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(driver)\\driver\\management\\license\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(driver)\\driver\\management\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(driver)\\driver\\map\\DriverLiveMapPageClient.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(driver)\\driver\\map\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(driver)\\driver\\notifications\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(driver)\\driver\\notifications\\read\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(driver)\\driver\\notifications\\unread\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(driver)\\driver\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(driver)\\driver\\payouts\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(driver)\\driver\\profile\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(driver)\\driver\\rating\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'setStats' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":18,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":18,"endColumn":25}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\nimport React, { useState, useEffect } from \"react\";\r\nimport DriverPageHeader from \"@/components/DriverPageHeader\";\r\nimport { Star } from \"lucide-react\";\r\n\r\n// Star rating descriptions\r\nconst STAR_DESCRIPTIONS = {\r\n  5: { label: \"Excellent\", description: \"Outstanding service\" },\r\n  4: { label: \"Very Good\", description: \"Great service\" },\r\n  3: { label: \"Good\", description: \"Satisfactory service\" },\r\n  2: { label: \"Fair\", description: \"Below average\" },\r\n  1: { label: \"Poor\", description: \"Unsatisfactory\" },\r\n};\r\n\r\nexport default function DriverRatingPage() {\r\n  const [rating, setRating] = useState(0);\r\n  const [hoveredRating, setHoveredRating] = useState(0);\r\n  const [stats, setStats] = useState({\r\n    averageRating: 4.7,\r\n    totalReviews: 127,\r\n    ratingBreakdown: {\r\n      5: 85,\r\n      4: 28,\r\n      3: 10,\r\n      2: 3,\r\n      1: 1,\r\n    },\r\n  });\r\n\r\n  useEffect(() => {\r\n    // Fetch rating stats from API\r\n    // const fetchStats = async () => {\r\n    //   const response = await fetch('/api/driver/rating');\r\n    //   const data = await response.json();\r\n    //   setStats(data);\r\n    // };\r\n    // fetchStats();\r\n  }, []);\r\n\r\n  const getRatingPercentage = (starLevel: number) => {\r\n    const count = stats.ratingBreakdown[starLevel as keyof typeof stats.ratingBreakdown] || 0;\r\n    return stats.totalReviews > 0 ? (count / stats.totalReviews) * 100 : 0;\r\n  };\r\n\r\n  const activeRating = hoveredRating || rating;\r\n  const activeDesc = activeRating > 0 ? STAR_DESCRIPTIONS[activeRating as keyof typeof STAR_DESCRIPTIONS] : null;\r\n\r\n  return (\r\n    <div className=\"w-full pb-4\">\r\n      <div className=\"mx-auto max-w-xl px-4\">\r\n        <div className=\"pt-2\">\r\n          <DriverPageHeader />\r\n        </div>\r\n\r\n        {/* Compact Rating Card */}\r\n        <div className=\"mt-3 bg-white rounded-lg border border-slate-200 shadow-sm p-3\">\r\n          {/* Header - Rating Summary */}\r\n          <div className=\"flex items-center justify-between mb-3 pb-2 border-b border-slate-200\">\r\n            <div>\r\n              <h1 className=\"text-base font-bold text-slate-900\">Your Rating</h1>\r\n              <p className=\"text-xs text-slate-600\">{stats.totalReviews} reviews</p>\r\n            </div>\r\n            <div className=\"flex items-center gap-1.5\">\r\n              <span className=\"text-xl font-bold text-slate-900\">{stats.averageRating.toFixed(1)}</span>\r\n              <Star className=\"h-4 w-4 fill-amber-400 text-amber-400\" />\r\n            </div>\r\n          </div>\r\n\r\n          {/* Rating Breakdown - Compact */}\r\n          <div className=\"space-y-1.5 mb-3\">\r\n            {[5, 4, 3, 2, 1].map((starLevel) => {\r\n              const percentage = getRatingPercentage(starLevel);\r\n              const count = stats.ratingBreakdown[starLevel as keyof typeof stats.ratingBreakdown] || 0;\r\n              \r\n              return (\r\n                <div key={starLevel} className=\"flex items-center gap-1.5 text-xs\">\r\n                  <div className=\"flex items-center gap-0.5 w-14 flex-shrink-0\">\r\n                    {[1, 2, 3, 4, 5].map((star) => (\r\n                      <Star\r\n                        key={star}\r\n                        className={`h-2 w-2 ${\r\n                          star <= starLevel\r\n                            ? \"fill-amber-400 text-amber-400\"\r\n                            : \"fill-slate-200 text-slate-300\"\r\n                        }`}\r\n                      />\r\n                    ))}\r\n                  </div>\r\n                  <div className=\"flex-1 h-1 bg-slate-200 rounded-full overflow-hidden\">\r\n                    <div\r\n                      className=\"h-full bg-amber-400 transition-all duration-300\"\r\n                      style={{ width: `${percentage}%` }}\r\n                    />\r\n                  </div>\r\n                  <div className=\"w-10 text-right text-slate-600 flex-shrink-0 text-xs\">{count}</div>\r\n                  <div className=\"w-8 text-right text-slate-500 flex-shrink-0 text-xs\">{percentage.toFixed(0)}%</div>\r\n                </div>\r\n              );\r\n            })}\r\n          </div>\r\n\r\n          {/* Interactive Star Guide - Compact */}\r\n          <div className=\"pt-2 border-t border-slate-200\">\r\n            <p className=\"text-xs font-medium text-slate-700 mb-1.5\">Rating Guide:</p>\r\n            <div className=\"flex items-center justify-center gap-1 mb-1.5\">\r\n              {[1, 2, 3, 4, 5].map((star) => (\r\n                <button\r\n                  key={star}\r\n                  type=\"button\"\r\n                  onClick={() => setRating(star)}\r\n                  onMouseEnter={() => setHoveredRating(star)}\r\n                  onMouseLeave={() => setHoveredRating(0)}\r\n                  className=\"transition-all duration-200 hover:scale-110 active:scale-95\"\r\n                  aria-label={`${star} star`}\r\n                >\r\n                  <Star\r\n                    className={`h-5 w-5 ${\r\n                      star <= activeRating\r\n                        ? \"fill-amber-400 text-amber-400\"\r\n                        : \"fill-slate-200 text-slate-300\"\r\n                    } transition-colors duration-200`}\r\n                  />\r\n                </button>\r\n              ))}\r\n            </div>\r\n            {activeDesc && (\r\n              <div className=\"text-center\">\r\n                <p className=\"text-xs font-medium text-slate-900\">{activeRating}★ {activeDesc.label}</p>\r\n                <p className=\"text-xs text-slate-600\">{activeDesc.description}</p>\r\n              </div>\r\n            )}\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(driver)\\driver\\referral\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(driver)\\driver\\reminders\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(driver)\\driver\\security\\2fa\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(driver)\\driver\\security\\login-history\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(driver)\\driver\\security\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(driver)\\driver\\security\\passkeys\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(driver)\\driver\\security\\password\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(driver)\\driver\\security\\sessions\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(driver)\\driver\\support\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(driver)\\driver\\terms\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(driver)\\driver\\today\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(driver)\\driver\\trips\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(driver)\\driver\\trips\\scheduled\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'total' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":562,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":562,"endColumn":15},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadTrips'. Either include it or remove the dependency array.","line":618,"column":6,"nodeType":"ArrayExpression","endLine":618,"endColumn":20,"suggestions":[{"desc":"Update the dependencies array to be: [filter, loadTrips, view]","fix":{"range":[25183,25197],"text":"[filter, loadTrips, view]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport React, { useEffect, useState } from \"react\";\nimport axios from \"axios\";\nimport {\n  Car,\n  Bike,\n  Truck,\n  MapPin,\n  Clock,\n  Users,\n  CheckCircle,\n  Loader2,\n  Hourglass,\n  BadgeCheck,\n  Trophy,\n  Star,\n} from \"lucide-react\";\nimport { useToast } from \"@/hooks/useToast\";\n\nconst api = axios.create({ baseURL: \"\", withCredentials: true });\n\ntype ScheduledTrip = {\n  id: number;\n  vehicleType?: string;\n  claimCount?: number;\n  claimsRemaining?: number;\n  claimLimit?: number;\n  claimOpensAt?: string;\n  canClaim?: boolean;\n  claimIneligibilityReason?: string | null;\n  scheduledDate: string;\n  pickupTime?: string;\n  fromAddress?: string;\n  fromLatitude?: number;\n  fromLongitude?: number;\n  toAddress?: string;\n  toLatitude?: number;\n  toLongitude?: number;\n  amount?: number;\n  currency?: string;\n  numberOfPassengers?: number;\n  arrivalType?: string;\n  arrivalNumber?: string;\n  transportCompany?: string;\n  arrivalTime?: string;\n  pickupLocation?: string;\n  notes?: string;\n  status?: string;\n  userRating?: number;\n  userReview?: string;\n  driverRating?: number;\n  driverReview?: string;\n  passenger?: {\n    id: number;\n    name: string;\n    phone?: string;\n    email?: string;\n  };\n  property?: {\n    id: number;\n    title: string;\n    regionName?: string;\n    district?: string;\n    ward?: string;\n  };\n  createdAt: string;\n};\n\nconst getVehicleLabel = (type?: string) => {\n  if (!type) return \"Vehicle\";\n  if (type === \"PREMIUM\") return \"VIP\";\n  return type;\n};\n\nfunction formatDurationMs(ms: number) {\n  const totalSeconds = Math.max(0, Math.floor(ms / 1000));\n  const days = Math.floor(totalSeconds / 86400);\n  const hours = Math.floor((totalSeconds % 86400) / 3600);\n  const minutes = Math.floor((totalSeconds % 3600) / 60);\n\n  if (days > 0) return `${days}d ${hours}h`;\n  if (hours > 0) return `${hours}h ${minutes}m`;\n  return `${minutes}m`;\n}\n\nfunction buildGoogleMapsLink({\n  lat,\n  lng,\n  address,\n}: {\n  lat?: number;\n  lng?: number;\n  address?: string;\n}) {\n  if (typeof lat === \"number\" && typeof lng === \"number\") {\n    return `https://www.google.com/maps?q=${lat},${lng}`;\n  }\n  if (address) {\n    return `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(address)}`;\n  }\n  return null;\n}\n\nfunction ClaimConfirmModal({\n  open,\n  confirming,\n  termsAccepted,\n  auctionAccepted,\n  onToggleTerms,\n  onToggleAuction,\n  onConfirm,\n  onCancel,\n}: {\n  open: boolean;\n  confirming: boolean;\n  termsAccepted: boolean;\n  auctionAccepted: boolean;\n  onToggleTerms: (v: boolean) => void;\n  onToggleAuction: (v: boolean) => void;\n  onConfirm: () => void;\n  onCancel: () => void;\n}) {\n  if (!open) return null;\n  const canConfirm = termsAccepted && auctionAccepted && !confirming;\n\n  return (\n    <div className=\"fixed inset-0 z-50 flex items-center justify-center p-4\" role=\"presentation\">\n      <div className=\"absolute inset-0 bg-black/40\" onClick={onCancel} />\n      <div\n        role=\"dialog\"\n        aria-modal=\"true\"\n        aria-label=\"Confirm claim\"\n        className=\"bg-white rounded-2xl p-5 z-10 w-full max-w-md shadow-xl border border-slate-200\"\n      >\n        <div className=\"font-semibold text-lg text-slate-900 mb-4\">\n          Are you sure you want to claim this trip?\n        </div>\n\n        <div className=\"space-y-3 mb-5\">\n          <label className=\"flex items-start gap-3 text-sm text-slate-700 cursor-pointer select-none\">\n            <input\n              type=\"checkbox\"\n              checked={termsAccepted}\n              onChange={(e) => onToggleTerms(e.target.checked)}\n              className=\"mt-1 h-4 w-4\"\n            />\n            <span>\n              I agree to the{' '}\n              <a href=\"/terms\" target=\"_blank\" rel=\"noreferrer\" className=\"font-semibold text-[#02665e] underline\">\n                Terms of Service\n              </a>\n            </span>\n          </label>\n\n          <label className=\"flex items-start gap-3 text-sm text-slate-700 cursor-pointer select-none\">\n            <input\n              type=\"checkbox\"\n              checked={auctionAccepted}\n              onChange={(e) => onToggleAuction(e.target.checked)}\n              className=\"mt-1 h-4 w-4\"\n            />\n            <span>I agree to NoLSAF Auction Policy</span>\n          </label>\n        </div>\n\n        <div className=\"flex justify-end gap-3\">\n          <button\n            onClick={onCancel}\n            aria-label=\"Cancel\"\n            className=\"px-4 py-2 rounded-xl bg-slate-100 hover:bg-slate-200 text-slate-700 font-semibold transition-colors\"\n          >\n            Cancel\n          </button>\n          <button\n            onClick={onConfirm}\n            disabled={!canConfirm}\n            aria-label=\"Confirm claim\"\n            className=\"px-4 py-2 rounded-xl bg-gradient-to-r from-[#02665e] to-[#014e47] text-white font-semibold transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed\"\n          >\n            {confirming ? \"Claiming...\" : \"Agree & Claim\"}\n          </button>\n        </div>\n      </div>\n    </div>\n  );\n}\n\nfunction TripPreviewModal({\n  trip,\n  view,\n  pickupCountdown,\n  closePreview,\n  openClaimConfirm,\n  claiming,\n  formatDate,\n  formatTime,\n  getVehicleIcon,\n}: {\n  trip: ScheduledTrip;\n  view: \"available\" | \"pending\" | \"awarded\" | \"finished\";\n  pickupCountdown: { text: string; classes: string } | null;\n  closePreview: () => void;\n  openClaimConfirm: (tripId: number) => void;\n  claiming: number | null;\n  formatDate: (dateString: string) => string;\n  formatTime: (timeString?: string) => string | null;\n  getVehicleIcon: (type?: string) => React.ReactNode;\n}) {\n  const pickupMaps = buildGoogleMapsLink({\n    lat: trip.fromLatitude,\n    lng: trip.fromLongitude,\n    address: trip.fromAddress || trip.pickupLocation,\n  });\n  const dropoffMaps = buildGoogleMapsLink({\n    lat: trip.toLatitude,\n    lng: trip.toLongitude,\n    address: trip.toAddress || trip.property?.title,\n  });\n\n  const scheduledDateLabel = `${formatDate(trip.scheduledDate)}${\n    formatTime(trip.scheduledDate) ? ` • ${formatTime(trip.scheduledDate)}` : \"\"\n  }`;\n\n  const statusPill =\n    view === \"available\"\n      ? {\n          label: \"NEW\",\n          classes: \"bg-sky-50 text-sky-900 border-sky-200\",\n          icon: (\n            <span className=\"inline-flex h-4 w-4 items-center justify-center rounded-full bg-gradient-to-br from-sky-400 to-indigo-500 text-white text-[9px] font-black\">\n              N\n            </span>\n          ),\n        }\n      : view === \"pending\"\n      ? {\n          label: \"PENDING REVIEW\",\n          classes: \"bg-amber-50 text-amber-900 border-amber-200\",\n            icon: (\n              <span className=\"inline-flex h-4 w-4 items-center justify-center rounded-full bg-amber-500 text-white text-[10px] font-black\">\n                !\n              </span>\n            ),\n        }\n      : view === \"awarded\"\n        ? {\n            label: \"AWARDED\",\n            classes: \"bg-emerald-50 text-emerald-900 border-emerald-200\",\n              icon: (\n              <span className=\"inline-flex h-4 w-4 items-center justify-center rounded-full bg-gradient-to-br from-amber-400 to-yellow-500 text-white shadow-sm\">\n                <Trophy className=\"h-3 w-3\" />\n                </span>\n              ),\n          }\n        : view === \"finished\"\n          ? {\n              label: \"FINISHED\",\n              classes: \"bg-violet-50 text-violet-900 border-violet-200\",\n                icon: (\n                  <span className=\"inline-flex h-4 w-4 items-center justify-center rounded-full bg-violet-600 text-white text-[10px] font-black\">\n                    ★\n                  </span>\n                ),\n            }\n          : null;\n\n  const hasArrivalInfo = Boolean(\n    trip.pickupLocation || trip.arrivalType || trip.transportCompany || trip.arrivalNumber || trip.arrivalTime\n  );\n  const hasRatings = Boolean(trip.userRating || trip.userReview || trip.driverRating || trip.driverReview);\n\n  return (\n    <div className=\"fixed inset-0 z-50 overflow-hidden\" role=\"presentation\">\n      <div className=\"absolute inset-0 bg-black/40 backdrop-blur-[2px]\" onClick={closePreview} />\n\n      <div className=\"relative z-10 flex min-h-full items-end justify-center px-3 pb-[calc(env(safe-area-inset-bottom)+0.6rem)] sm:items-center sm:px-3 sm:py-6\">\n        <div\n          role=\"dialog\"\n          aria-modal=\"true\"\n          aria-label=\"Trip details\"\n          className=\"bg-white w-full sm:max-w-md shadow-2xl border border-slate-200 max-h-[calc(100svh-(env(safe-area-inset-top)+1.25rem))] sm:max-h-[calc(100svh-3rem)] overflow-hidden flex flex-col rounded-t-3xl rounded-b-none sm:rounded-3xl\"\n        >\n          {/* Mobile grab handle */}\n          <div className=\"sm:hidden px-3 pt-3\">\n            <div className=\"mx-auto h-1 w-10 rounded-full bg-slate-200\" />\n          </div>\n\n          {/* Header */}\n          <div className=\"p-3 sm:p-4 border-b border-slate-200 bg-white\">\n            <div className=\"flex items-start justify-between gap-4\">\n              <div className=\"min-w-0\">\n                <div className=\"inline-flex items-center gap-2\">\n                  <div className=\"text-2xl leading-none\">{getVehicleIcon(trip.vehicleType)}</div>\n                  <div className=\"min-w-0\">\n                    <div className=\"flex flex-wrap items-center gap-2\">\n                      <div className=\"font-extrabold text-slate-900 text-sm sm:text-base truncate\">\n                        {getVehicleLabel(trip.vehicleType)}\n                      </div>\n                      <div className=\"text-[11px] font-bold px-2 py-0.5 rounded-full bg-slate-100 text-slate-700 border border-slate-200\">\n                        Booking #{trip.id}\n                      </div>\n                    </div>\n                    <div className=\"mt-0.5 flex items-center gap-2 text-xs text-slate-600 overflow-x-auto\">\n                      <span className=\"shrink-0\">{scheduledDateLabel}</span>\n                      {statusPill ? (\n                        <span\n                          className={\n                            \"inline-flex items-center gap-1 text-[11px] font-extrabold px-2 py-0.5 rounded-full border shrink-0 \" +\n                            statusPill.classes\n                          }\n                        >\n                          {statusPill.icon}\n                          {statusPill.label}\n                        </span>\n                      ) : null}\n                      {pickupCountdown ? (\n                        <span\n                          className={\n                            \"inline-flex items-center gap-1 text-[11px] font-bold px-2 py-0.5 rounded-full border shrink-0 \" +\n                            pickupCountdown.classes\n                          }\n                        >\n                          <Hourglass className=\"w-3.5 h-3.5\" />\n                          {pickupCountdown.text}\n                        </span>\n                      ) : null}\n                    </div>\n                  </div>\n                </div>\n              </div>\n\n              <div className=\"text-right shrink-0\">\n                <div className=\"text-[10px] font-semibold text-slate-500\">Fare</div>\n                <div className=\"text-sm font-extrabold text-[#02665e]\">\n                  {trip.amount ? `${Number(trip.amount).toLocaleString()} ${trip.currency || \"TZS\"}` : \"n/a\"}\n                </div>\n              </div>\n            </div>\n          </div>\n\n          {/* Body (scrolls) */}\n          <div className=\"flex-1 min-h-0 overflow-y-auto p-3 sm:p-4\">\n            <div className=\"space-y-3\">\n              {/* Route (compact) */}\n              <div className=\"rounded-2xl border border-slate-200 bg-slate-50 p-3\">\n                <div className=\"text-[11px] font-bold tracking-wide text-slate-500 uppercase\">Route</div>\n                <div className=\"mt-3 space-y-2\">\n                  <div className=\"rounded-xl border border-slate-200 bg-white px-3 py-2\">\n                    <div className=\"flex items-start justify-between gap-3\">\n                      <div className=\"min-w-0\">\n                        <div className=\"text-[11px] font-semibold text-slate-500\">Pickup</div>\n                        <div className=\"mt-0.5 text-sm font-semibold text-slate-900 line-clamp-1\">\n                          {trip.fromAddress || trip.pickupLocation || \"Not specified\"}\n                        </div>\n                      </div>\n                      {pickupMaps ? (\n                        <a\n                          href={pickupMaps}\n                          target=\"_blank\"\n                          rel=\"noreferrer\"\n                          className=\"shrink-0 inline-flex items-center gap-1 text-xs font-semibold text-[#02665e] hover:text-[#014e47]\"\n                        >\n                          <MapPin className=\"w-3.5 h-3.5\" />\n                          Maps\n                        </a>\n                      ) : null}\n                    </div>\n                  </div>\n\n                  <div className=\"rounded-xl border border-slate-200 bg-white px-3 py-2\">\n                    <div className=\"flex items-start justify-between gap-3\">\n                      <div className=\"min-w-0\">\n                        <div className=\"text-[11px] font-semibold text-slate-500\">Drop-off</div>\n                        <div className=\"mt-0.5 text-sm font-semibold text-slate-900 line-clamp-1\">\n                          {trip.property?.title || trip.toAddress || \"Not specified\"}\n                        </div>\n                        {trip.property?.regionName || trip.property?.district || trip.property?.ward ? (\n                          <div className=\"mt-0.5 text-xs text-slate-600 line-clamp-1\">\n                            {[trip.property?.ward, trip.property?.district, trip.property?.regionName]\n                              .filter(Boolean)\n                              .join(\", \")}\n                          </div>\n                        ) : null}\n                      </div>\n                      {dropoffMaps ? (\n                        <a\n                          href={dropoffMaps}\n                          target=\"_blank\"\n                          rel=\"noreferrer\"\n                          className=\"shrink-0 inline-flex items-center gap-1 text-xs font-semibold text-[#02665e] hover:text-[#014e47]\"\n                        >\n                          <MapPin className=\"w-3.5 h-3.5\" />\n                          Maps\n                        </a>\n                      ) : null}\n                    </div>\n                  </div>\n                </div>\n              </div>\n\n              {/* Key facts */}\n              <div className=\"rounded-2xl border border-slate-200 bg-white p-3\">\n                <div className=\"text-[11px] font-bold tracking-wide text-slate-500 uppercase\">Trip info</div>\n                <div className=\"mt-3 grid grid-cols-2 gap-2\">\n                  <div className=\"rounded-xl border border-slate-200 bg-slate-50 p-3\">\n                    <div className=\"inline-flex items-center gap-2\">\n                      <Users className=\"w-4 h-4 text-slate-400\" />\n                      <div>\n                        <div className=\"text-[11px] font-semibold text-slate-500\">Passengers</div>\n                        <div className=\"text-sm font-semibold text-slate-900\">\n                          {trip.numberOfPassengers\n                            ? `${trip.numberOfPassengers} passenger${trip.numberOfPassengers !== 1 ? \"s\" : \"\"}`\n                            : \"Not specified\"}\n                        </div>\n                      </div>\n                    </div>\n                  </div>\n                  <div className=\"rounded-xl border border-slate-200 bg-slate-50 p-3\">\n                    <div className=\"inline-flex items-center gap-2\">\n                      <Clock className=\"w-4 h-4 text-slate-400\" />\n                      <div>\n                        <div className=\"text-[11px] font-semibold text-slate-500\">Pickup time</div>\n                        <div className=\"text-sm font-semibold text-slate-900\">\n                          {formatTime(trip.pickupTime || trip.scheduledDate) || \"Not specified\"}\n                        </div>\n                      </div>\n                    </div>\n                  </div>\n                </div>\n\n                {hasArrivalInfo ? (\n                  <details className=\"mt-3 rounded-2xl border border-slate-200 bg-white\">\n                    <summary className=\"cursor-pointer select-none px-3 py-2 text-sm font-semibold text-slate-900 list-none\">\n                      Arrival & pickup info\n                      <span className=\"ml-2 text-xs font-semibold text-slate-500\">(tap)</span>\n                    </summary>\n                    <div className=\"px-3 pb-3\">\n                      <dl className=\"grid grid-cols-2 gap-x-4 gap-y-3 text-sm\">\n                        {trip.pickupLocation ? (\n                          <div className=\"col-span-2\">\n                            <dt className=\"text-[11px] font-semibold text-slate-500\">Specific pickup area</dt>\n                            <dd className=\"font-semibold text-slate-900\">{trip.pickupLocation}</dd>\n                          </div>\n                        ) : null}\n                        {trip.arrivalType ? (\n                          <div>\n                            <dt className=\"text-[11px] font-semibold text-slate-500\">Type</dt>\n                            <dd className=\"font-semibold text-slate-900\">{trip.arrivalType}</dd>\n                          </div>\n                        ) : null}\n                        {trip.transportCompany ? (\n                          <div>\n                            <dt className=\"text-[11px] font-semibold text-slate-500\">Company</dt>\n                            <dd className=\"font-semibold text-slate-900\">{trip.transportCompany}</dd>\n                          </div>\n                        ) : null}\n                        {trip.arrivalNumber ? (\n                          <div>\n                            <dt className=\"text-[11px] font-semibold text-slate-500\">Number</dt>\n                            <dd className=\"font-semibold text-slate-900\">{trip.arrivalNumber}</dd>\n                          </div>\n                        ) : null}\n                        {trip.arrivalTime ? (\n                          <div>\n                            <dt className=\"text-[11px] font-semibold text-slate-500\">Arrival time</dt>\n                            <dd className=\"font-semibold text-slate-900\">{formatTime(trip.arrivalTime) || \"\"}</dd>\n                          </div>\n                        ) : null}\n                      </dl>\n                    </div>\n                  </details>\n                ) : null}\n              </div>\n\n              {hasRatings ? (\n                <details className=\"rounded-2xl border border-slate-200 bg-white\">\n                  <summary className=\"cursor-pointer select-none px-3 py-2 text-sm font-semibold text-slate-900 list-none\">\n                    Ratings & reviews\n                    <span className=\"ml-2 text-xs font-semibold text-slate-500\">(tap)</span>\n                  </summary>\n                  <div className=\"px-3 pb-3 text-sm text-slate-700 space-y-2\">\n                    {typeof trip.userRating === \"number\" ? (\n                      <div className=\"inline-flex items-center gap-2\">\n                        <Star className=\"w-4 h-4 text-amber-500\" />\n                        <span>\n                          <span className=\"text-slate-500\">Passenger rated driver:</span>{\" \"}\n                          <span className=\"font-semibold text-slate-900\">{trip.userRating}/5</span>\n                        </span>\n                      </div>\n                    ) : null}\n                    {trip.userReview ? <div className=\"whitespace-pre-wrap\">{trip.userReview}</div> : null}\n                    {typeof trip.driverRating === \"number\" ? (\n                      <div>\n                        <span className=\"text-slate-500\">Driver rated passenger:</span>{\" \"}\n                        <span className=\"font-semibold text-slate-900\">{trip.driverRating}/5</span>\n                      </div>\n                    ) : null}\n                    {trip.driverReview ? <div className=\"whitespace-pre-wrap\">{trip.driverReview}</div> : null}\n                  </div>\n                </details>\n              ) : null}\n\n              {trip.notes ? (\n                <details className=\"rounded-2xl border border-amber-200 bg-amber-50\">\n                  <summary className=\"cursor-pointer select-none px-3 py-2 text-sm font-semibold text-amber-900 list-none\">\n                    Special instructions\n                    <span className=\"ml-2 text-xs font-semibold text-amber-900/70\">(tap)</span>\n                  </summary>\n                  <div className=\"px-3 pb-3 text-sm text-amber-900 whitespace-pre-wrap\">{trip.notes}</div>\n                </details>\n              ) : null}\n            </div>\n          </div>\n\n          {/* Footer */}\n          <div className=\"border-t border-slate-200 bg-white p-2.5 sm:p-3\">\n            <div className=\"flex flex-row flex-wrap items-center justify-end gap-2\">\n              <button\n                onClick={closePreview}\n                className=\"px-3 py-2 rounded-xl bg-slate-100 hover:bg-slate-200 text-slate-700 font-semibold transition-colors\"\n              >\n                Close\n              </button>\n              {view === \"available\" ? (\n                <button\n                  onClick={() => {\n                    closePreview();\n                    openClaimConfirm(trip.id);\n                  }}\n                  disabled={claiming !== null || trip.canClaim === false}\n                  title={trip.canClaim === false ? trip.claimIneligibilityReason || \"You can't claim this trip\" : undefined}\n                  className=\"px-3 py-2 rounded-xl bg-gradient-to-r from-[#02665e] to-[#014e47] text-white font-semibold transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed\"\n                >\n                  Claim this trip\n                </button>\n              ) : null}\n            </div>\n\n            {view === \"available\" && trip.canClaim === false && trip.claimIneligibilityReason ? (\n              <div className=\"mt-2 text-xs font-semibold text-rose-700\">{trip.claimIneligibilityReason}</div>\n            ) : null}\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n\nexport default function DriverScheduledTripsPage() {\n  const [trips, setTrips] = useState<ScheduledTrip[]>([]);\n  const [loading, setLoading] = useState(true);\n  const [nowMs, setNowMs] = useState(() => Date.now());\n  const [claiming, setClaiming] = useState<number | null>(null);\n  const [previewTrip, setPreviewTrip] = useState<ScheduledTrip | null>(null);\n  const [selectedTripId, setSelectedTripId] = useState<number | null>(null);\n  const [confirmTripId, setConfirmTripId] = useState<number | null>(null);\n  const [termsAccepted, setTermsAccepted] = useState(false);\n  const [auctionAccepted, setAuctionAccepted] = useState(false);\n  const [view, setView] = useState<\"available\" | \"pending\" | \"awarded\" | \"finished\">(\"available\");\n  const [filter, setFilter] = useState<\"all\" | \"BODA\" | \"BAJAJI\" | \"CAR\" | \"XL\" | \"VIP\">(\"all\");\n  const [total, setTotal] = useState<number>(0);\n  const [overview, setOverview] = useState<{ available: number; pending: number; awarded: number; finished: number }>(\n    { available: 0, pending: 0, awarded: 0, finished: 0 }\n  );\n  const { success, error: showError } = useToast();\n\n  useEffect(() => {\n    const id = window.setInterval(() => setNowMs(Date.now()), 1000);\n    return () => window.clearInterval(id);\n  }, []);\n\n  const getPickupCountdown = (scheduledDate: string) => {\n    const targetMs = new Date(scheduledDate).getTime();\n    if (!Number.isFinite(targetMs)) return null;\n\n    const diffMs = targetMs - nowMs;\n    const absMs = Math.abs(diffMs);\n    const totalSeconds = Math.max(0, Math.floor(absMs / 1000));\n    const days = Math.floor(totalSeconds / 86400);\n    const hours = Math.floor((totalSeconds % 86400) / 3600);\n    const minutes = Math.floor((totalSeconds % 3600) / 60);\n    const seconds = totalSeconds % 60;\n\n    const durationLabel =\n      days > 0\n        ? `${days}d ${hours}h ${minutes}m`\n        : hours > 0\n          ? `${hours}h ${minutes}m`\n          : `${minutes}m ${seconds}s`;\n\n    const text = diffMs >= 0 ? `Pickup in ${durationLabel}` : `Pickup overdue ${durationLabel}`;\n\n    const urgency =\n      diffMs < 0\n        ? \"overdue\"\n        : diffMs <= 30 * 60 * 1000\n          ? \"urgent\"\n          : diffMs <= 2 * 60 * 60 * 1000\n            ? \"soon\"\n            : \"normal\";\n\n    const pulse = urgency === \"urgent\" || urgency === \"overdue\" ? \"animate-pulse\" : \"\";\n    const classes =\n      urgency === \"overdue\"\n        ? `bg-rose-50 text-rose-900 border-rose-200 ${pulse}`\n        : urgency === \"urgent\"\n          ? `bg-rose-50 text-rose-900 border-rose-200 ${pulse}`\n          : urgency === \"soon\"\n            ? \"bg-amber-50 text-amber-900 border-amber-200\"\n            : \"bg-emerald-50 text-emerald-900 border-emerald-200\";\n\n    return { text, classes };\n  };\n\n  useEffect(() => {\n    loadTrips();\n  }, [filter, view]);\n\n  useEffect(() => {\n    setSelectedTripId((prev) => {\n      if (!trips.length) return null;\n      if (prev != null && trips.some((t) => t.id === prev)) return prev;\n      return trips[0].id;\n    });\n  }, [trips]);\n\n  useEffect(() => {\n    // Best-effort fetch counts for sidebar badges.\n    // Keep it lightweight by requesting pageSize=1 and using `total` from the response.\n    const loadOverview = async () => {\n      try {\n        const [availableRes, pendingRes, awardedRes, finishedRes] = await Promise.all([\n          api.get(`/api/driver/trips/scheduled?page=1&pageSize=1`),\n          api.get(`/api/driver/trips/claims/pending?page=1&pageSize=1`),\n          api.get(`/api/driver/trips/scheduled/assigned?page=1&pageSize=1`),\n          api.get(`/api/driver/trips/claims/finished?page=1&pageSize=1`),\n        ]);\n        setOverview({\n          available: Number(availableRes?.data?.total || 0),\n          pending: Number(pendingRes?.data?.total || 0),\n          awarded: Number(awardedRes?.data?.total || 0),\n          finished: Number(finishedRes?.data?.total || 0),\n        });\n      } catch {\n        // ignore\n      }\n    };\n    loadOverview();\n  }, []);\n\n  const loadTrips = async () => {\n    try {\n      setLoading(true);\n      let url = \"/api/driver/trips/scheduled\";\n      const params = new URLSearchParams();\n      if (view === \"available\") {\n        if (filter !== \"all\") params.set(\"vehicleType\", filter === \"VIP\" ? \"PREMIUM\" : filter);\n        url = `/api/driver/trips/scheduled?${params.toString()}`;\n      } else if (view === \"pending\") {\n        url = `/api/driver/trips/claims/pending`;\n      } else if (view === \"awarded\") {\n        url = `/api/driver/trips/scheduled/assigned`;\n      } else {\n        url = `/api/driver/trips/claims/finished`;\n      }\n\n      const response = await api.get(url);\n      setTrips(response.data.items || []);\n      setTotal(Number(response.data.total || 0));\n    } catch (err: any) {\n      const msg = err?.response?.data?.error || \"Failed to load scheduled trips\";\n      showError(msg);\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const handleClaim = async (tripId: number) => {\n    try {\n      setClaiming(tripId);\n      const response = await api.post(`/api/driver/trips/${tripId}/claim`);\n      if (response.data.ok) {\n        success(\"Claim submitted! Awaiting NoLSAF review.\");\n        // Remove from list\n        setTrips((prev) => prev.filter((t) => t.id !== tripId));\n        setSelectedTripId((prev) => (prev === tripId ? null : prev));\n        return true;\n      }\n      return false;\n    } catch (err: any) {\n      const msg = err?.response?.data?.error || \"Failed to claim trip\";\n      showError(msg);\n      return false;\n    } finally {\n      setClaiming(null);\n    }\n  };\n\n  const openClaimConfirm = (tripId: number) => {\n    if (claiming !== null) return;\n\n    const trip = trips.find((t) => t.id === tripId);\n    if (trip?.canClaim === false) {\n      showError(trip.claimIneligibilityReason || \"You can't claim this trip\");\n      return;\n    }\n\n    setConfirmTripId(tripId);\n    setTermsAccepted(false);\n    setAuctionAccepted(false);\n  };\n\n  const closeClaimConfirm = () => {\n    setConfirmTripId(null);\n    setTermsAccepted(false);\n    setAuctionAccepted(false);\n  };\n\n  const openPreview = (trip: ScheduledTrip) => {\n    setPreviewTrip(trip);\n  };\n\n  const closePreview = () => {\n    setPreviewTrip(null);\n  };\n\n  const formatDate = (dateString: string) => {\n    return new Date(dateString).toLocaleDateString(\"en-GB\", {\n      day: \"2-digit\",\n      month: \"short\",\n      year: \"numeric\",\n    });\n  };\n\n  const formatTime = (timeString?: string) => {\n    if (!timeString) return null;\n    return new Date(timeString).toLocaleTimeString(\"en-GB\", {\n      hour: \"2-digit\",\n      minute: \"2-digit\",\n    });\n  };\n\n  const getVehicleIcon = (type?: string): React.ReactNode => {\n    const chip = (Icon: React.ComponentType<{ className?: string }>, chipClassName: string) => (\n      <span\n        className={\n          \"inline-flex h-10 w-10 items-center justify-center rounded-2xl border shadow-sm \" +\n          chipClassName\n        }\n      >\n        <Icon className=\"h-5 w-5\" />\n      </span>\n    );\n\n    switch (type) {\n      case \"BODA\":\n        return chip(Bike, \"bg-indigo-50 text-indigo-700 border-indigo-200\");\n      case \"BAJAJI\":\n        return chip(Car, \"bg-amber-50 text-amber-700 border-amber-200\");\n      case \"CAR\":\n        return chip(Car, \"bg-slate-50 text-slate-700 border-slate-200\");\n      case \"XL\":\n        return chip(Truck, \"bg-sky-50 text-sky-700 border-sky-200\");\n      case \"PREMIUM\":\n      case \"VIP\":\n        return chip(Car, \"bg-gradient-to-br from-amber-200 via-yellow-100 to-amber-100 text-amber-950 border-amber-400\");\n      default:\n        return chip(Car, \"bg-slate-50 text-slate-700 border-slate-200\");\n    }\n  };\n\n  // selectedTripId is used to highlight the active list item.\n\n  if (loading) {\n    return (\n      <div className=\"min-h-screen bg-gradient-to-b from-slate-50 via-white to-slate-50\">\n        <div className=\"w-full max-w-6xl mx-auto p-4 sm:p-6\">\n          <div className=\"rounded-3xl border border-slate-200 bg-white shadow-sm p-6\">\n            <div className=\"flex items-center gap-3\">\n              <Loader2 className=\"w-5 h-5 animate-spin text-[#02665e]\" />\n              <div className=\"font-semibold text-slate-900\">Loading your dashboard…</div>\n            </div>\n            <div className=\"mt-6 grid grid-cols-1 md:grid-cols-2 gap-4\">\n              {[0, 1, 2, 3].map((i) => (\n                <div key={i} className=\"rounded-2xl border border-slate-200 bg-slate-50 p-5 animate-pulse\">\n                  <div className=\"h-4 w-32 bg-slate-200 rounded mb-3\" />\n                  <div className=\"h-3 w-48 bg-slate-200 rounded mb-2\" />\n                  <div className=\"h-3 w-40 bg-slate-200 rounded\" />\n                  <div className=\"mt-4 h-10 w-full bg-slate-200 rounded-xl\" />\n                </div>\n              ))}\n            </div>\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  const viewSubtitle =\n    view === \"available\"\n      ? \"Preview trips and submit claims.\"\n      : view === \"pending\"\n        ? \"Claims awaiting NoLSAF review.\"\n        : view === \"awarded\"\n          ? \"Trips awarded to you (upcoming).\"\n          : \"Completed trips and ratings.\";\n\n  const statusLabel =\n    view === \"pending\" ? \"Pending review\" : view === \"awarded\" ? \"Awarded\" : view === \"finished\" ? \"Finished\" : null;\n\n  const statusPill =\n    view === \"available\"\n      ? {\n          label: \"NEW\",\n          classes: \"bg-sky-50 text-sky-900 border-sky-200\",\n          rowActive: \"bg-sky-50/60\",\n          rowHover: \"hover:bg-sky-50/40\",\n          rowBorder: \"border-l-sky-400\",\n          icon: (\n            <span className=\"inline-flex h-4 w-4 items-center justify-center rounded-full bg-gradient-to-br from-sky-400 to-indigo-500 text-white text-[9px] font-black\">\n              N\n            </span>\n          ),\n        }\n      : view === \"pending\"\n      ? {\n          label: \"PENDING REVIEW\",\n          classes: \"bg-amber-50 text-amber-900 border-amber-200\",\n          rowActive: \"bg-amber-50/60\",\n          rowHover: \"hover:bg-amber-50/40\",\n          rowBorder: \"border-l-amber-400\",\n            icon: (\n              <span className=\"inline-flex h-4 w-4 items-center justify-center rounded-full bg-amber-500 text-white text-[10px] font-black\">\n                !\n              </span>\n            ),\n        }\n      : view === \"awarded\"\n        ? {\n            label: \"AWARDED\",\n            classes: \"bg-emerald-50 text-emerald-900 border-emerald-200\",\n            rowActive: \"bg-emerald-50/60\",\n            rowHover: \"hover:bg-emerald-50/40\",\n            rowBorder: \"border-l-emerald-500\",\n              icon: (\n              <span className=\"inline-flex h-4 w-4 items-center justify-center rounded-full bg-gradient-to-br from-amber-400 to-yellow-500 text-white shadow-sm\">\n                <Trophy className=\"h-3 w-3\" />\n                </span>\n              ),\n          }\n        : view === \"finished\"\n          ? {\n              label: \"FINISHED\",\n              classes: \"bg-violet-50 text-violet-900 border-violet-200\",\n              rowActive: \"bg-violet-50/60\",\n              rowHover: \"hover:bg-violet-50/40\",\n              rowBorder: \"border-l-violet-400\",\n                icon: (\n                  <span className=\"inline-flex h-4 w-4 items-center justify-center rounded-full bg-violet-600 text-white text-[10px] font-black\">\n                    ★\n                  </span>\n                ),\n            }\n          : null;\n\n  return (\n    <div\n      className={\n        \"min-h-screen relative overflow-hidden \" +\n        (view === \"awarded\"\n          ? \"bg-gradient-to-b from-amber-50 via-white to-emerald-50\"\n          : view === \"pending\"\n            ? \"bg-gradient-to-b from-amber-50 via-white to-slate-50\"\n            : view === \"finished\"\n              ? \"bg-gradient-to-b from-violet-50 via-white to-slate-50\"\n              : \"bg-gradient-to-b from-slate-50 via-white to-slate-50\")\n      }\n    >\n      {view === \"awarded\" || view === \"pending\" || view === \"finished\" ? (\n        <div aria-hidden className=\"pointer-events-none absolute inset-0 overflow-hidden\">\n          {view === \"awarded\" ? (\n            <>\n              <div className=\"absolute -top-40 -right-40 h-[28rem] w-[28rem] rounded-full bg-gradient-to-br from-amber-300/35 to-yellow-200/10 blur-3xl\" />\n              <div className=\"absolute -bottom-44 -left-44 h-[30rem] w-[30rem] rounded-full bg-gradient-to-br from-emerald-300/25 to-sky-200/10 blur-3xl\" />\n              <div className=\"absolute top-8 right-8 h-24 w-24 rounded-3xl bg-gradient-to-br from-amber-400/15 to-yellow-300/5 border border-amber-200/40 rotate-12\" />\n              <Trophy className=\"absolute top-10 right-10 h-20 w-20 text-amber-400/15 rotate-12\" />\n            </>\n          ) : view === \"pending\" ? (\n            <>\n              <div className=\"absolute -top-44 -right-44 h-[30rem] w-[30rem] rounded-full bg-gradient-to-br from-amber-300/30 to-orange-200/10 blur-3xl\" />\n              <div className=\"absolute -bottom-48 -left-48 h-[32rem] w-[32rem] rounded-full bg-gradient-to-br from-slate-300/20 to-amber-200/10 blur-3xl\" />\n              <div className=\"absolute top-8 right-8 h-24 w-24 rounded-3xl bg-gradient-to-br from-amber-400/12 to-orange-300/5 border border-amber-200/35 rotate-12\" />\n              <Hourglass className=\"absolute top-10 right-10 h-20 w-20 text-amber-500/12 rotate-12\" />\n            </>\n          ) : (\n            <>\n              <div className=\"absolute -top-44 -right-44 h-[30rem] w-[30rem] rounded-full bg-gradient-to-br from-violet-300/25 to-fuchsia-200/10 blur-3xl\" />\n              <div className=\"absolute -bottom-48 -left-48 h-[32rem] w-[32rem] rounded-full bg-gradient-to-br from-slate-300/15 to-violet-200/10 blur-3xl\" />\n              <div className=\"absolute top-8 right-8 h-24 w-24 rounded-3xl bg-gradient-to-br from-violet-400/10 to-fuchsia-300/5 border border-violet-200/35 rotate-12\" />\n              <Star className=\"absolute top-10 right-10 h-20 w-20 text-violet-500/10 rotate-12\" />\n            </>\n          )}\n        </div>\n      ) : null}\n\n      <div className=\"relative z-10 w-full max-w-6xl mx-auto p-4 sm:p-6\">\n        {previewTrip ? (\n          <TripPreviewModal\n            trip={previewTrip}\n            view={view}\n            pickupCountdown={view === \"awarded\" ? getPickupCountdown(previewTrip.scheduledDate) : null}\n            closePreview={closePreview}\n            openClaimConfirm={openClaimConfirm}\n            claiming={claiming}\n            formatDate={formatDate}\n            formatTime={formatTime}\n            getVehicleIcon={getVehicleIcon}\n          />\n        ) : null}\n        <ClaimConfirmModal\n          open={confirmTripId !== null}\n          confirming={confirmTripId !== null && claiming === confirmTripId}\n          termsAccepted={termsAccepted}\n          auctionAccepted={auctionAccepted}\n          onToggleTerms={setTermsAccepted}\n          onToggleAuction={setAuctionAccepted}\n          onCancel={closeClaimConfirm}\n          onConfirm={async () => {\n            if (confirmTripId == null) return;\n            if (!termsAccepted || !auctionAccepted) return;\n            const ok = await handleClaim(confirmTripId);\n            if (ok) closeClaimConfirm();\n          }}\n        />\n\n        {/* Header */}\n        <div className=\"mb-8\">\n          <div className=\"rounded-3xl border border-slate-200 bg-white/90 shadow-sm\">\n            <div className=\"p-5 sm:p-7\">\n              <div className=\"flex flex-col items-center text-center gap-5\">\n                <div>\n                  <div className=\"mx-auto inline-flex h-14 w-14 items-center justify-center rounded-2xl bg-[#02665e]/10 border border-[#02665e]/20\">\n                    <BadgeCheck className=\"h-7 w-7 text-[#02665e]\" />\n                  </div>\n                  <h1 className=\"text-2xl sm:text-3xl font-extrabold text-slate-900 mt-3\">Scheduled Trips</h1>\n                  <p className=\"text-slate-600 mt-1 max-w-2xl mx-auto\">{viewSubtitle}</p>\n                </div>\n\n                <div className=\"w-full max-w-3xl mx-auto grid grid-cols-2 sm:grid-cols-4 gap-3\">\n              {(\n                [\n                  {\n                    key: \"available\" as const,\n                    label: \"Available\",\n                    count: overview.available,\n                    activeRing: \"ring-[#02665e]/30\",\n                    dot: \"bg-[#02665e]\",\n                    soft: \"bg-[#02665e]/10 text-[#02665e] border-[#02665e]/20\",\n                  },\n                  {\n                    key: \"pending\" as const,\n                    label: \"Pending\",\n                    count: overview.pending,\n                    activeRing: \"ring-amber-400/30\",\n                    dot: \"bg-amber-500\",\n                    soft: \"bg-amber-50 text-amber-900 border-amber-200\",\n                  },\n                  {\n                    key: \"awarded\" as const,\n                    label: \"Awarded\",\n                    count: overview.awarded,\n                    activeRing: \"ring-emerald-400/30\",\n                    dot: \"bg-emerald-500\",\n                    soft: \"bg-emerald-50 text-emerald-900 border-emerald-200\",\n                  },\n                  {\n                    key: \"finished\" as const,\n                    label: \"Finished\",\n                    count: overview.finished,\n                    activeRing: \"ring-violet-400/30\",\n                    dot: \"bg-violet-500\",\n                    soft: \"bg-violet-50 text-violet-900 border-violet-200\",\n                  },\n                ]\n              ).map((s) => {\n                const active = view === s.key;\n                return (\n                  <button\n                    key={s.key}\n                    type=\"button\"\n                    onClick={() => setView(s.key)}\n                    aria-current={active ? \"page\" : undefined}\n                    className={\n                      \"h-full text-left rounded-2xl bg-white border shadow-sm px-4 py-3 transition-all focus:outline-none focus:ring-4 \" +\n                      (active\n                        ? `border-slate-300 ring-4 ${s.activeRing}`\n                        : \"border-slate-200 hover:border-slate-300 hover:shadow-md\")\n                    }\n                  >\n                    <div className=\"flex items-center justify-between gap-3\">\n                      <div>\n                        <div className=\"text-xs text-slate-500\">{s.label}</div>\n                        <div className=\"text-lg font-extrabold text-slate-900\">{Number(s.count || 0).toLocaleString()}</div>\n                      </div>\n                      <div className={\"inline-flex items-center gap-2 text-xs font-bold px-2 py-1 rounded-full border \" + (active ? s.soft : \"bg-slate-50 text-slate-700 border-slate-200\")}\n                      >\n                        <span className={\"h-2 w-2 rounded-full \" + (active ? s.dot : \"bg-slate-400\")} />\n                        View\n                      </div>\n                    </div>\n                  </button>\n                );\n              })}\n            </div>\n\n            {view === \"available\" ? (\n              <div className=\"w-full max-w-3xl mx-auto\">\n                <div className=\"mt-2 inline-flex flex-wrap items-center justify-center gap-1 rounded-2xl border border-slate-200 bg-slate-50 px-1 py-1\">\n                  {[\n                    { key: \"all\" as const, label: \"All\" },\n                    { key: \"BODA\" as const, label: \"Boda\" },\n                    { key: \"BAJAJI\" as const, label: \"Bajaji\" },\n                    { key: \"CAR\" as const, label: \"Car\" },\n                    { key: \"XL\" as const, label: \"XL\" },\n                    { key: \"VIP\" as const, label: \"VIP\" },\n                  ].map((tab) => (\n                    <button\n                      key={tab.key}\n                      onClick={() => setFilter(tab.key)}\n                      className={\n                        \"px-3 py-1.5 rounded-xl text-xs font-bold transition-all duration-200 \" +\n                        (filter === tab.key\n                          ? \"bg-white text-slate-900 shadow-sm border border-slate-200\"\n                          : \"text-slate-700 hover:text-slate-900\")\n                      }\n                    >\n                      {tab.label}\n                    </button>\n                  ))}\n                </div>\n              </div>\n            ) : null}\n              </div>\n            </div>\n          </div>\n        </div>\n\n        <div className=\"grid grid-cols-1 gap-6 items-start\">\n          <main className=\"space-y-4\">\n            {/* Trips */}\n            {trips.length === 0 ? (\n              <div className=\"bg-white rounded-2xl border border-slate-200 p-10 text-center shadow-sm\">\n                <div className=\"inline-flex items-center justify-center h-14 w-14 rounded-2xl bg-slate-100 mb-4\">\n                  <Car className=\"h-7 w-7 text-slate-400\" />\n                </div>\n                <h3 className=\"text-xl font-bold text-slate-900 mb-2\">\n                  {view === \"available\"\n                    ? \"No trips available\"\n                    : view === \"pending\"\n                      ? \"No pending claims\"\n                      : view === \"awarded\"\n                        ? \"No awarded claims\"\n                        : \"No finished trips\"}\n                </h3>\n                <p className=\"text-slate-600 max-w-xl mx-auto\">\n                  {view === \"available\"\n                    ? filter === \"all\"\n                      ? \"There are no paid scheduled trips at the moment. Trips become claimable 72 hours before pickup time.\"\n                      : `No ${filter} trips available. Try selecting a different vehicle type.`\n                    : view === \"pending\"\n                      ? \"When you claim a trip, it will appear here while NoLSAF reviews it.\"\n                      : view === \"awarded\"\n                        ? \"Trips awarded to you will show here.\"\n                        : \"Your completed trips will show here with ratings.\"}\n                </p>\n              </div>\n            ) : (\n              <div className=\"grid grid-cols-1 gap-4 items-start\">\n                {/* List */}\n                <section className=\"rounded-2xl border border-slate-200 bg-white shadow-sm overflow-hidden\">\n                  <div className=\"divide-y divide-slate-100\">\n                    {trips.map((trip) => {\n                      const active = selectedTripId === trip.id;\n                      const dateLabel = `${formatDate(trip.scheduledDate)}${\n                        formatTime(trip.scheduledDate) ? ` • ${formatTime(trip.scheduledDate)}` : \"\"\n                      }`;\n                      const pickupCountdown = view === \"awarded\" ? getPickupCountdown(trip.scheduledDate) : null;\n\n                      return (\n                        <div\n                          key={trip.id}\n                          role=\"button\"\n                          tabIndex={0}\n                          onClick={() => setSelectedTripId(trip.id)}\n                          className={\n                            \"px-4 sm:px-5 py-4 transition-colors cursor-pointer [-webkit-tap-highlight-color:transparent] border-l-4 \" +\n                            (statusPill ? statusPill.rowBorder + \" \" : \"border-l-transparent \") +\n                            (active\n                              ? statusPill\n                                ? statusPill.rowActive\n                                : \"bg-slate-50\"\n                              : statusPill\n                                ? statusPill.rowHover\n                                : \"hover:bg-slate-50\")\n                          }\n                        >\n                          <div className=\"flex items-start gap-4\">\n                            <div className=\"text-2xl mt-0.5\">{getVehicleIcon(trip.vehicleType)}</div>\n\n                            <div className=\"min-w-0 flex-1\">\n                              <div className=\"flex items-start justify-between gap-3\">\n                                <div className=\"min-w-0\">\n                                  <div className=\"flex items-center gap-2\">\n                                    <div className=\"font-extrabold text-slate-900 text-sm truncate\">\n                                      {getVehicleLabel(trip.vehicleType)}\n                                    </div>\n                                    {statusPill ? (\n                                      <div\n                                        className={\n                                          \"inline-flex items-center gap-1 text-[11px] font-extrabold px-2 py-0.5 rounded-full border \" +\n                                          statusPill.classes\n                                        }\n                                      >\n                                        {statusPill.icon}\n                                        {statusPill.label}\n                                      </div>\n                                    ) : null}\n                                    {view === \"finished\" && typeof trip.userRating === \"number\" ? (\n                                      <div className=\"inline-flex items-center gap-1 text-[11px] font-bold px-2 py-0.5 rounded-full bg-amber-50 text-amber-900 border border-amber-200\">\n                                        <Star className=\"w-3.5 h-3.5\" />\n                                        {trip.userRating}/5\n                                      </div>\n                                    ) : null}\n                                  </div>\n                                  <div className=\"text-xs text-slate-600 mt-0.5\">{dateLabel}</div>\n                                </div>\n\n                                <div className=\"shrink-0 min-w-[10.5rem] text-right\">\n                                  {trip.amount ? (\n                                    <div className=\"font-extrabold text-[#02665e] text-sm leading-tight\">\n                                      {Number(trip.amount).toLocaleString()} {trip.currency || \"TZS\"}\n                                    </div>\n                                  ) : (\n                                    <div className=\"text-xs text-slate-500\">Fare: n/a</div>\n                                  )}\n\n                                  <div className=\"mt-1 flex flex-wrap justify-end gap-1\">\n                                    {trip.claimOpensAt ? (() => {\n                                      const opensAtMs = new Date(trip.claimOpensAt).getTime();\n                                      if (!Number.isFinite(opensAtMs)) return null;\n                                      const isOpen = nowMs >= opensAtMs;\n                                      const remaining = isOpen ? null : formatDurationMs(opensAtMs - nowMs);\n\n                                      return (\n                                        <div\n                                          className={\n                                            \"inline-flex items-center gap-1 text-[11px] font-extrabold px-2 py-0.5 rounded-full border shadow-sm transition-all duration-300 \" +\n                                            (isOpen\n                                              ? \"bg-emerald-50 text-emerald-900 border-emerald-200\"\n                                              : \"bg-slate-50 text-slate-700 border-slate-200\")\n                                          }\n                                        >\n                                          <Hourglass className={\"w-3.5 h-3.5 \" + (isOpen ? \"text-emerald-600\" : \"text-slate-500\")} />\n                                          {isOpen ? \"Claim open\" : `Opens ${remaining}`}\n                                        </div>\n                                      );\n                                    })() : null}\n\n                                    {typeof trip.claimsRemaining === \"number\" ? (\n                                      <div\n                                        className={\n                                          \"inline-flex items-center gap-1 text-[11px] font-extrabold px-2 py-0.5 rounded-full border shadow-sm transition-all duration-300 \" +\n                                          (trip.claimsRemaining > 0\n                                            ? \"bg-amber-50 text-amber-900 border-amber-200\"\n                                            : \"bg-rose-50 text-rose-900 border-rose-200\")\n                                        }\n                                      >\n                                        <Users className={\"w-3.5 h-3.5 \" + (trip.claimsRemaining > 0 ? \"text-amber-700\" : \"text-rose-700\")} />\n                                        {trip.claimsRemaining}/{trip.claimLimit ?? 5}\n                                      </div>\n                                    ) : null}\n                                  </div>\n                                </div>\n                              </div>\n\n                              <div className=\"mt-3 grid grid-cols-1 sm:grid-cols-2 gap-2 text-xs\">\n                                <div className=\"flex items-start gap-2 text-slate-700 min-w-0\">\n                                  <MapPin className=\"w-4 h-4 text-slate-400 mt-0.5\" />\n                                  <div className=\"min-w-0\">\n                                    <div className=\"text-[11px] font-semibold text-slate-500\">Pickup</div>\n                                    <div className=\"font-semibold text-slate-900 line-clamp-2\">\n                                      {trip.fromAddress || trip.pickupLocation || \"Not specified\"}\n                                    </div>\n                                  </div>\n                                </div>\n                                <div className=\"flex items-start gap-2 text-slate-700 min-w-0\">\n                                  <MapPin className=\"w-4 h-4 text-slate-400 mt-0.5\" />\n                                  <div className=\"min-w-0\">\n                                    <div className=\"text-[11px] font-semibold text-slate-500\">Drop-off</div>\n                                    <div className=\"font-semibold text-slate-900 line-clamp-2\">\n                                      {trip.property?.title || trip.toAddress || \"Not specified\"}\n                                    </div>\n                                  </div>\n                                </div>\n                              </div>\n\n                              <div className=\"mt-3 flex items-center gap-3 text-xs text-slate-600 overflow-x-auto\">\n                                <div className=\"inline-flex items-center gap-1 shrink-0\">\n                                  <Users className=\"w-4 h-4 text-slate-400\" />\n                                  <span>{trip.numberOfPassengers ? `${trip.numberOfPassengers} pax` : \"Passengers: n/a\"}</span>\n                                </div>\n                                <div className=\"inline-flex items-center gap-1 shrink-0\">\n                                  <Clock className=\"w-4 h-4 text-slate-400\" />\n                                  <span>{formatTime(trip.pickupTime || trip.scheduledDate) || \"Time: n/a\"}</span>\n                                </div>\n                                {pickupCountdown ? (\n                                  <div\n                                    className={\n                                      \"inline-flex items-center gap-1 shrink-0 text-[11px] font-bold px-2 py-0.5 rounded-full border \" +\n                                      pickupCountdown.classes\n                                    }\n                                  >\n                                    <Hourglass className=\"w-3.5 h-3.5\" />\n                                    <span>{pickupCountdown.text}</span>\n                                  </div>\n                                ) : null}\n                              </div>\n\n                              <div className=\"mt-4 flex flex-col sm:flex-row gap-2 sm:items-center sm:justify-between\">\n                                <button\n                                  type=\"button\"\n                                  onClick={(e) => {\n                                    e.stopPropagation();\n                                    openPreview(trip);\n                                  }}\n                                  className=\"px-3 py-2 rounded-xl bg-white border border-slate-200 text-slate-800 font-semibold text-xs hover:bg-slate-50 transition-colors [-webkit-tap-highlight-color:transparent]\"\n                                >\n                                  Full details\n                                </button>\n\n                                {view === \"available\" ? (\n                                  <button\n                                    type=\"button\"\n                                    onClick={(e) => {\n                                      e.stopPropagation();\n                                      openClaimConfirm(trip.id);\n                                    }}\n                                    disabled={claiming !== null || trip.canClaim === false}\n                                    title={trip.canClaim === false ? trip.claimIneligibilityReason || \"You can't claim this trip\" : undefined}\n                                    className=\"px-3 py-2 rounded-xl bg-gradient-to-r from-[#02665e] to-[#014e47] text-white font-semibold text-xs transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2\"\n                                  >\n                                    {claiming === trip.id ? (\n                                      <>\n                                        <Loader2 className=\"w-4 h-4 animate-spin\" />\n                                        <span>Submitting…</span>\n                                      </>\n                                    ) : (\n                                      <>\n                                        <CheckCircle className=\"w-4 h-4\" />\n                                        <span>Submit claim</span>\n                                      </>\n                                    )}\n                                  </button>\n                                ) : (\n                                  <div\n                                    className={\n                                      \"px-3 py-2 rounded-xl border font-extrabold text-xs text-center \" +\n                                      (statusPill ? statusPill.classes : \"bg-slate-50 text-slate-700 border-slate-200\")\n                                    }\n                                  >\n                                    {view === \"awarded\" ? \"Awarded to you\" : statusLabel}\n                                  </div>\n                                )}\n                              </div>\n                            </div>\n                          </div>\n                        </div>\n                      );\n                    })}\n                  </div>\n                </section>\n              </div>\n            )}\n          </main>\n        </div>\n      </div>\n    </div>\n  );\n}\n\n","usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(driver)\\layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(owner)\\layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(owner)\\owner\\bookings\\check-out\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'r' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":147,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":147,"endColumn":14}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useEffect, useMemo, useState } from \"react\";\nimport axios from \"axios\";\nimport Link from \"next/link\";\nimport { Calendar, Loader2, PhoneCall, Mail, CheckCircle2, Clock, X, History, Star, Search, RotateCw } from \"lucide-react\";\nimport TableRow from \"@/components/TableRow\";\n\n// Use same-origin calls + secure httpOnly cookie session.\nconst api = axios.create({ baseURL: \"\", withCredentials: true });\n\ntype CheckoutItem = {\n  id: number;\n  property?: { id: number; title: string };\n  codeVisible?: string | null;\n  validatedAt?: string | null;\n  guestName?: string | null;\n  guestPhone?: string | null;\n  guestEmail?: string | null;\n  checkIn?: string | null;\n  checkOut?: string | null;\n  status?: string | null;\n};\n\ntype AuditItem = {\n  confirmedAt: string;\n  note: string | null;\n  rating: number | null;\n  feedback: string | null;\n  actorName?: string | null;\n  actorRole?: string | null;\n};\n\nfunction formatDateTime(v: any) {\n  try {\n    const d = new Date(String(v ?? \"\"));\n    const t = d.getTime();\n    if (!Number.isFinite(t)) return \"—\";\n    return d.toLocaleString(\"en-US\", {\n      year: \"numeric\",\n      month: \"short\",\n      day: \"numeric\",\n      hour: \"2-digit\",\n      minute: \"2-digit\",\n    });\n  } catch {\n    return \"—\";\n  }\n}\n\nfunction hoursLeft(checkOut: any) {\n  const t = new Date(String(checkOut ?? \"\")).getTime();\n  if (!Number.isFinite(t)) return null;\n  const diffH = (t - Date.now()) / 3600000;\n  return diffH;\n}\n\nexport default function OwnerCheckoutPage() {\n  const [list, setList] = useState<CheckoutItem[]>([]);\n  const [loading, setLoading] = useState(true);\n  const [refreshing, setRefreshing] = useState(false);\n  const [error, setError] = useState<string | null>(null);\n  const [search, setSearch] = useState(\"\");\n  const [confirmingId, setConfirmingId] = useState<number | null>(null);\n  const [confirmOpen, setConfirmOpen] = useState(false);\n  const [confirmTarget, setConfirmTarget] = useState<CheckoutItem | null>(null);\n  const [rating, setRating] = useState<number>(0);\n  const [feedback, setFeedback] = useState<string>(\"\");\n  const [agreeToTerms, setAgreeToTerms] = useState(false);\n\n  const [auditOpen, setAuditOpen] = useState(false);\n  const [auditTarget, setAuditTarget] = useState<CheckoutItem | null>(null);\n  const [auditItems, setAuditItems] = useState<AuditItem[]>([]);\n  const [auditLoading, setAuditLoading] = useState(false);\n\n  const url = \"/api/owner/bookings/for-checkout\";\n\n  const load = async (opts?: { silent?: boolean }) => {\n    const silent = Boolean(opts?.silent);\n    if (silent) setRefreshing(true);\n    else setLoading(true);\n    setError(null);\n    try {\n      const r = await api.get<unknown>(url);\n      const raw: any = (r as any).data;\n      const normalized: any[] = Array.isArray(raw)\n        ? raw\n        : (Array.isArray(raw?.data)\n          ? raw.data\n          : (Array.isArray(raw?.items)\n            ? raw.items\n            : []));\n      setList(normalized as CheckoutItem[]);\n    } catch (e: any) {\n      if (!silent) setList([]);\n      setError(e?.response?.data?.error ?? e?.message ?? \"Failed to load check-out queue\");\n    } finally {\n      if (silent) setRefreshing(false);\n      else setLoading(false);\n    }\n  };\n\n  useEffect(() => {\n    load();\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, []);\n\n  const filtered = useMemo(() => {\n    const q = search.trim().toLowerCase();\n    if (!q) return list;\n    return list.filter((b) => {\n      const name = String(b.guestName ?? \"\").toLowerCase();\n      const phone = String(b.guestPhone ?? \"\").toLowerCase();\n      const email = String(b.guestEmail ?? \"\").toLowerCase();\n      const code = String(b.codeVisible ?? \"\").toLowerCase();\n      const prop = String(b.property?.title ?? \"\").toLowerCase();\n      return name.includes(q) || phone.includes(q) || email.includes(q) || code.includes(q) || prop.includes(q);\n    });\n  }, [list, search]);\n\n  const stats = useMemo(() => {\n    let overdueCount = 0;\n    let urgentCount = 0;\n    for (const b of filtered) {\n      const h = hoursLeft(b.checkOut);\n      if (typeof h !== \"number\") continue;\n      if (h < 0) overdueCount += 1;\n      else if (h <= 1) urgentCount += 1;\n    }\n    return {\n      total: filtered.length,\n      overdue: overdueCount,\n      urgent: urgentCount,\n    };\n  }, [filtered]);\n\n  async function confirmCheckout(id: number) {\n    if (!rating || rating < 1 || rating > 5) {\n      return setError(\"Please rate the guest (1–5) before confirming check-out.\");\n    }\n    if (!agreeToTerms) {\n      return setError(\"Please agree to the Terms of Service before confirming check-out.\");\n    }\n    setConfirmingId(id);\n    setError(null);\n    try {\n      const r = await api.post(`/api/owner/bookings/${id}/confirm-checkout`, { rating, feedback: feedback.trim() || null });\n      // Refresh list + let sidebar update counts\n      window.dispatchEvent(new Event(\"nols:checkout-changed\"));\n      setConfirmOpen(false);\n      setConfirmTarget(null);\n      setRating(0);\n      setFeedback(\"\");\n      setAgreeToTerms(false);\n      await load();\n    } catch (e: any) {\n      setError(e?.response?.data?.error ?? e?.message ?? \"Failed to confirm check-out\");\n    } finally {\n      setConfirmingId(null);\n    }\n  }\n\n  async function openAudit(b: CheckoutItem) {\n    setAuditOpen(true);\n    setAuditTarget(b);\n    setAuditLoading(true);\n    setAuditItems([]);\n    const url = `/api/owner/bookings/${b.id}/audit`;\n    try {\n      const r = await api.get(url);\n      const items = Array.isArray((r as any).data?.items) ? (r as any).data.items : [];\n      setAuditItems(items);\n    } catch (e: any) {\n      setAuditItems([]);\n      setError(e?.response?.data?.error ?? e?.message ?? \"Failed to load audit history\");\n    } finally {\n      setAuditLoading(false);\n    }\n  }\n\n  if (loading) {\n    return (\n      <div className=\"min-h-[60vh] flex flex-col items-center justify-center text-center px-4\">\n        <div className=\"inline-flex items-center justify-center h-16 w-16 rounded-full bg-emerald-100 mb-4\">\n          <Loader2 className=\"h-8 w-8 animate-spin text-emerald-600\" />\n        </div>\n        <h1 className=\"text-3xl font-bold text-slate-900\">Check-out</h1>\n        <p className=\"text-sm text-slate-600 mt-2 max-w-2xl\">Loading upcoming check-outs…</p>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-6 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-10\">\n      {/* Confirm modal (rating required) */}\n      {confirmOpen && confirmTarget ? (\n        <div className=\"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/40 backdrop-blur-[2px]\">\n          <div className=\"w-full max-w-lg rounded-2xl bg-white border border-slate-200 shadow-2xl ring-1 ring-black/10 overflow-hidden\">\n            <div className=\"p-4 sm:p-5 border-b border-slate-200 flex items-start justify-between gap-3\">\n              <div className=\"min-w-0\">\n                <div className=\"text-xs font-bold uppercase tracking-wide text-slate-500\">Confirm Check-out</div>\n                <div className=\"text-base sm:text-lg font-bold text-slate-900 truncate\">{confirmTarget.property?.title ?? \"—\"}</div>\n                <div className=\"text-xs text-slate-600 mt-1\">\n                  Guest: <span className=\"font-semibold text-slate-900\">{confirmTarget.guestName ?? \"—\"}</span>\n                </div>\n              </div>\n              <button\n                type=\"button\"\n                onClick={() => { setConfirmOpen(false); setConfirmTarget(null); setRating(0); setFeedback(\"\"); setAgreeToTerms(false); }}\n                className=\"h-9 w-9 rounded-xl border border-slate-200 bg-white text-slate-700 hover:bg-slate-50 active:scale-[0.99] transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-emerald-500/20 inline-flex items-center justify-center\"\n                aria-label=\"Close confirm dialog\"\n                title=\"Close\"\n              >\n                <X className=\"h-5 w-5\" aria-hidden />\n              </button>\n            </div>\n\n            <div className=\"p-4 sm:p-5 space-y-3\">\n              <div className=\"rounded-2xl border border-slate-200 bg-slate-50 px-4 py-3\">\n                <div className=\"text-[11px] font-bold uppercase tracking-wide text-slate-500\">Rate this guest (required)</div>\n                <div className=\"mt-2 flex items-center gap-1.5\">\n                  {[1,2,3,4,5].map((v) => (\n                    <button\n                      key={v}\n                      type=\"button\"\n                      onClick={() => setRating(v)}\n                      className={`h-9 w-9 rounded-xl border transition-all duration-200 inline-flex items-center justify-center ${\n                        rating >= v ? \"bg-amber-50 border-amber-200\" : \"bg-white border-slate-200 hover:bg-slate-50\"\n                      }`}\n                      aria-label={`Rate ${v} star`}\n                      title={`${v} star`}\n                    >\n                      <Star className={`h-4 w-4 ${rating >= v ? \"text-amber-500\" : \"text-slate-300\"}`} aria-hidden />\n                    </button>\n                  ))}\n                  <span className=\"ml-2 text-sm font-semibold text-slate-700\">{rating ? `${rating}/5` : \"Select\"}</span>\n                </div>\n                <div className=\"mt-3\">\n                  <div className=\"text-[11px] font-bold uppercase tracking-wide text-slate-500\">Optional feedback</div>\n                  <textarea\n                    value={feedback}\n                    onChange={(e) => setFeedback(e.target.value)}\n                    rows={2}\n                    className=\"mt-1 w-full rounded-2xl border border-slate-200 bg-white px-4 py-2.5 text-sm text-slate-900 placeholder:text-slate-400 shadow-sm focus:outline-none focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-300 transition-all duration-200\"\n                    placeholder=\"Short note about the guest (optional)…\"\n                    aria-label=\"Guest rating feedback\"\n                  />\n                </div>\n\n                <label className=\"mt-3 flex items-start gap-3 rounded-2xl border border-slate-200 bg-white px-3 py-3 text-sm text-slate-700\">\n                  <input\n                    type=\"checkbox\"\n                    checked={agreeToTerms}\n                    onChange={(e) => setAgreeToTerms(e.target.checked)}\n                    className=\"mt-0.5 h-4 w-4 rounded border-slate-300 text-emerald-700 focus:ring-emerald-500/30\"\n                  />\n                  <span className=\"leading-relaxed\">\n                    I agree to the{\" \"}\n                    <Link href=\"/terms\" target=\"_blank\" className=\"font-semibold text-slate-900 underline hover:text-slate-700\">\n                      Terms of Service\n                    </Link>\n                    .\n                  </span>\n                </label>\n              </div>\n\n              <div className=\"flex flex-col-reverse sm:flex-row gap-2 sm:items-center sm:justify-end\">\n                <button\n                  type=\"button\"\n                  onClick={() => openAudit(confirmTarget)}\n                  className=\"h-10 rounded-xl border border-slate-200 bg-white px-4 text-sm font-semibold text-slate-700 shadow-sm hover:bg-slate-50 hover:border-slate-300 active:scale-[0.99] transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-emerald-500/20 inline-flex items-center gap-2 justify-center\"\n                >\n                  <History className=\"h-4 w-4\" aria-hidden />\n                  View Audit History\n                </button>\n                <button\n                  type=\"button\"\n                  onClick={() => confirmCheckout(confirmTarget.id)}\n                  disabled={confirmingId === confirmTarget.id || !agreeToTerms}\n                  className=\"h-10 rounded-xl bg-indigo-700 text-white px-5 text-sm font-bold shadow-sm hover:bg-indigo-800 active:scale-[0.99] transition-all duration-200 disabled:opacity-60 disabled:cursor-not-allowed focus:outline-none focus:ring-2 focus:ring-indigo-500/30 inline-flex items-center gap-2 justify-center\"\n                >\n                  {confirmingId === confirmTarget.id ? <Loader2 className=\"h-4 w-4 animate-spin\" aria-hidden /> : <CheckCircle2 className=\"h-4 w-4\" aria-hidden />}\n                  Confirm Check-out\n                </button>\n              </div>\n            </div>\n          </div>\n        </div>\n      ) : null}\n\n      {/* Audit modal */}\n      {auditOpen && auditTarget ? (\n        <div className=\"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/40\">\n          <div className=\"w-full max-w-2xl rounded-3xl bg-white border border-slate-200 shadow-xl ring-1 ring-black/10 overflow-hidden\">\n            <div className=\"p-5 sm:p-6 border-b border-slate-200 flex items-start justify-between gap-3\">\n              <div className=\"min-w-0\">\n                <div className=\"text-xs font-bold uppercase tracking-wide text-slate-500\">Audit History</div>\n                <div className=\"text-lg font-bold text-slate-900 truncate\">{auditTarget.property?.title ?? \"—\"}</div>\n                <div className=\"text-xs text-slate-600 mt-1\">\n                  Booking #{auditTarget.id} • Code <span className=\"font-mono font-semibold text-slate-900\">{auditTarget.codeVisible ?? \"—\"}</span>\n                </div>\n              </div>\n              <button\n                type=\"button\"\n                onClick={() => { setAuditOpen(false); setAuditTarget(null); setAuditItems([]); }}\n                className=\"h-10 w-10 rounded-2xl border border-slate-200 bg-white text-slate-700 hover:bg-slate-50 active:scale-[0.99] transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-emerald-500/20 inline-flex items-center justify-center\"\n                aria-label=\"Close audit dialog\"\n                title=\"Close\"\n              >\n                <X className=\"h-5 w-5\" aria-hidden />\n              </button>\n            </div>\n            <div className=\"p-5 sm:p-6\">\n              {auditLoading ? (\n                <div className=\"flex items-center gap-3 text-slate-700\">\n                  <Loader2 className=\"h-5 w-5 animate-spin\" aria-hidden />\n                  Loading audit history…\n                </div>\n              ) : auditItems.length === 0 ? (\n                <div className=\"rounded-2xl border border-slate-200 bg-slate-50 px-4 py-4 text-sm text-slate-700\">\n                  No audit history found yet for this booking.\n                </div>\n              ) : (\n                <div className=\"w-full overflow-x-auto\">\n                  <table className=\"min-w-[700px] w-full text-sm\">\n                    <thead className=\"bg-slate-50 border border-slate-200\">\n                      <tr>\n                        <th className=\"px-4 py-3 text-xs font-bold uppercase tracking-wide text-slate-600 text-left\">Action</th>\n                        <th className=\"px-4 py-3 text-xs font-bold uppercase tracking-wide text-slate-600 text-left\">By</th>\n                        <th className=\"px-4 py-3 text-xs font-bold uppercase tracking-wide text-slate-600 text-left\">Confirmed At</th>\n                        <th className=\"px-4 py-3 text-xs font-bold uppercase tracking-wide text-slate-600 text-left\">Rating</th>\n                        <th className=\"px-4 py-3 text-xs font-bold uppercase tracking-wide text-slate-600 text-left\">Feedback</th>\n                      </tr>\n                    </thead>\n                    <tbody className=\"divide-y divide-slate-200 border border-slate-200 border-t-0\">\n                      {auditItems.map((it, idx) => (\n                        <tr key={idx} className=\"hover:bg-slate-50/60 transition-colors\">\n                          <td className=\"px-4 py-3 font-semibold text-slate-900\">\n                            {String(it.note ?? \"\").toLowerCase() === \"checkout\" ? \"CHECK-OUT\" : String(it.note ?? \"\").toLowerCase() === \"checkin\" ? \"CHECK-IN\" : (it.note ?? \"—\")}\n                          </td>\n                          <td className=\"px-4 py-3 text-slate-700 whitespace-nowrap\">\n                            {it.actorName ? it.actorName : \"—\"}\n                          </td>\n                          <td className=\"px-4 py-3 text-slate-700 whitespace-nowrap\">{formatDateTime(it.confirmedAt)}</td>\n                          <td className=\"px-4 py-3 text-slate-700 whitespace-nowrap\">{typeof it.rating === \"number\" ? `${it.rating}/5` : \"—\"}</td>\n                          <td className=\"px-4 py-3 text-slate-700\">{it.feedback ?? \"—\"}</td>\n                        </tr>\n                      ))}\n                    </tbody>\n                  </table>\n                </div>\n              )}\n            </div>\n          </div>\n        </div>\n      ) : null}\n\n      {/* Header (clean, consistent) */}\n      <div className=\"bg-white rounded-lg border border-gray-200 p-6 shadow-sm\">\n        <div className=\"flex flex-col items-center text-center\">\n          <div className=\"h-16 w-16 rounded-full bg-gradient-to-br from-emerald-50 to-emerald-100 flex items-center justify-center mb-4\">\n            <Calendar className=\"h-8 w-8 text-emerald-700\" aria-hidden />\n          </div>\n          <h1 className=\"text-2xl font-bold text-gray-900\">Check-out</h1>\n          <p className=\"text-sm text-gray-500 mt-1 max-w-2xl\">\n            Bookings appear here automatically when they are within <span className=\"font-semibold text-gray-900\">7 hours</span> of check-out (or overdue).\n            Use this page to remind guests and confirm check-out once they leave.\n          </p>\n        </div>\n      </div>\n\n      {/* Summary */}\n      <div className=\"grid grid-cols-1 sm:grid-cols-3 gap-4\">\n        <div className=\"bg-white rounded-lg border border-gray-200 p-4 shadow-sm\">\n          <div className=\"text-xs font-medium text-gray-500\">Total in queue</div>\n          <div className=\"mt-1 text-2xl font-bold text-gray-900\">{stats.total.toLocaleString()}</div>\n        </div>\n        <div className=\"bg-white rounded-lg border border-gray-200 p-4 shadow-sm\">\n          <div className=\"text-xs font-medium text-gray-500\">Urgent (≤ 1h)</div>\n          <div className=\"mt-1 text-2xl font-bold text-amber-700\">{stats.urgent.toLocaleString()}</div>\n        </div>\n        <div className=\"bg-white rounded-lg border border-gray-200 p-4 shadow-sm\">\n          <div className=\"text-xs font-medium text-gray-500\">Overdue</div>\n          <div className=\"mt-1 text-2xl font-bold text-red-700\">{stats.overdue.toLocaleString()}</div>\n        </div>\n      </div>\n\n      {error ? (\n        <div className=\"rounded-lg border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-800\">\n          {error}\n        </div>\n      ) : null}\n\n      {/* List */}\n      {filtered.length === 0 ? (\n        <div className=\"bg-white rounded-lg border border-gray-200 p-10 sm:p-12 text-center shadow-sm\">\n          <Clock className=\"h-12 w-12 text-gray-300 mx-auto mb-4\" aria-hidden />\n          <p className=\"text-sm text-gray-700 font-semibold\">No bookings are ready for check-out.</p>\n          <p className=\"text-xs text-gray-500 mt-2\">This list updates automatically as check-outs get close.</p>\n          <div className=\"mt-4 flex items-center justify-center gap-2\">\n            <button\n              type=\"button\"\n              onClick={() => load({ silent: true })}\n              disabled={refreshing}\n              className=\"inline-flex items-center justify-center h-10 w-10 rounded-md border border-gray-200 bg-white text-gray-700 shadow-sm hover:bg-gray-50 active:scale-[0.99] transition disabled:opacity-60\"\n              aria-label=\"Refresh\"\n              title=\"Refresh\"\n            >\n              <RotateCw className={`h-4 w-4 ${refreshing ? \"animate-spin\" : \"\"}`} aria-hidden />\n            </button>\n            <Link\n              href=\"/owner/bookings/checked-in\"\n              className=\"no-underline inline-flex items-center justify-center h-10 w-10 rounded-md bg-emerald-700 text-white shadow-sm hover:bg-emerald-800 active:scale-[0.99] transition\"\n              aria-label=\"Checked-In\"\n              title=\"Checked-In\"\n            >\n              <Calendar className=\"h-4 w-4\" aria-hidden />\n            </Link>\n\n            <Link\n              href=\"/owner/bookings/checked-out\"\n              className=\"no-underline inline-flex items-center justify-center h-10 w-10 rounded-md bg-slate-900 text-white shadow-sm hover:bg-slate-800 active:scale-[0.99] transition\"\n              aria-label=\"Checked-Out\"\n              title=\"Checked-Out\"\n            >\n              <CheckCircle2 className=\"h-4 w-4\" aria-hidden />\n            </Link>\n          </div>\n        </div>\n      ) : (\n        <div className=\"bg-white rounded-lg border border-gray-200 shadow-sm overflow-hidden\">\n          <div className=\"sticky top-0 z-10 bg-gradient-to-r from-gray-50 to-gray-100 border-b border-gray-200 px-4 sm:px-6 py-4 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3\">\n            <div className=\"min-w-0\">\n              <div className=\"text-sm font-semibold text-gray-900\">Upcoming check-outs</div>\n              <div className=\"text-xs text-gray-500 mt-0.5\">Confirm check-out after the guest leaves.</div>\n            </div>\n\n            <div className=\"flex flex-col sm:flex-row gap-2 sm:items-center\">\n              <div className=\"relative\">\n                <div className=\"absolute left-3 top-1/2 -translate-y-1/2 pointer-events-none\">\n                  <Search className=\"h-4 w-4 text-gray-400\" aria-hidden />\n                </div>\n                {search ? (\n                  <button\n                    type=\"button\"\n                    onClick={() => setSearch(\"\")}\n                    className=\"absolute right-2 top-1/2 -translate-y-1/2 inline-flex items-center justify-center h-7 w-7 rounded-full text-gray-400 hover:text-gray-700 hover:bg-gray-200/50 active:scale-95 transition\"\n                    aria-label=\"Clear search\"\n                    title=\"Clear\"\n                  >\n                    <X className=\"h-4 w-4\" aria-hidden />\n                  </button>\n                ) : null}\n                <input\n                  value={search}\n                  onChange={(e) => setSearch(e.target.value)}\n                  placeholder=\"Search guest, code, property…\"\n                  className=\"h-10 w-full sm:w-72 pl-10 pr-10 rounded-md border border-gray-200 bg-white text-sm text-gray-900 placeholder:text-gray-400 shadow-sm focus:outline-none focus:ring-2 focus:ring-emerald-500/30\"\n                  aria-label=\"Search check-out queue\"\n                />\n              </div>\n\n              <button\n                type=\"button\"\n                onClick={() => load({ silent: true })}\n                disabled={refreshing}\n                className=\"inline-flex items-center justify-center h-10 w-10 rounded-md border border-gray-200 bg-white text-gray-700 shadow-sm hover:bg-gray-50 active:scale-[0.99] transition disabled:opacity-60\"\n                aria-label=\"Refresh check-out list\"\n                title=\"Refresh\"\n              >\n                <RotateCw className={`h-4 w-4 ${refreshing ? \"animate-spin\" : \"\"}`} aria-hidden />\n              </button>\n\n              <Link\n                href=\"/owner/bookings/checked-in\"\n                className=\"no-underline inline-flex items-center justify-center h-10 w-10 rounded-md bg-emerald-700 text-white shadow-sm hover:bg-emerald-800 active:scale-[0.99] transition\"\n                aria-label=\"Checked-In\"\n                title=\"Checked-In\"\n              >\n                <Calendar className=\"h-4 w-4\" aria-hidden />\n              </Link>\n\n              <Link\n                href=\"/owner/bookings/checked-out\"\n                className=\"no-underline inline-flex items-center justify-center h-10 w-10 rounded-md bg-slate-900 text-white shadow-sm hover:bg-slate-800 active:scale-[0.99] transition\"\n                aria-label=\"Checked-Out\"\n                title=\"Checked-Out\"\n              >\n                <CheckCircle2 className=\"h-4 w-4\" aria-hidden />\n              </Link>\n            </div>\n          </div>\n\n          <div className={`overflow-x-auto ${refreshing ? \"opacity-60\" : \"\"} transition-opacity duration-200`}>\n            <table className=\"min-w-[1100px] w-full text-sm\">\n              <thead className=\"sticky top-0 z-10 bg-gradient-to-r from-gray-50 to-gray-100 border-b border-gray-200\">\n                <tr>\n                  <th className=\"px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider\">Property</th>\n                  <th className=\"px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider\">Code</th>\n                  <th className=\"px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider\">Guest</th>\n                  <th className=\"px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider\">Phone</th>\n                  <th className=\"px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider\">Validated</th>\n                  <th className=\"px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider\">Check-out</th>\n                  <th className=\"px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider\">State</th>\n                  <th className=\"px-6 py-3 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider\">Actions</th>\n                </tr>\n              </thead>\n              <tbody className=\"divide-y divide-gray-200\">\n                {filtered.map((b) => {\n                  const h = hoursLeft(b.checkOut);\n                  const urgent = typeof h === \"number\" ? h <= 1 : false;\n                  const overdue = typeof h === \"number\" ? h < 0 : false;\n                  const phone = String(b.guestPhone ?? \"\").trim();\n                  const email = String(b.guestEmail ?? \"\").trim();\n\n                  return (\n                    <TableRow key={b.id} className=\"align-middle\">\n                      <td className=\"px-6 py-4\">\n                        <div className=\"min-w-0\">\n                          <div className=\"font-semibold text-gray-900 truncate\">{b.property?.title ?? \"—\"}</div>\n                          <div className=\"text-xs text-gray-500 mt-0.5\">Booking #{b.id}</div>\n                        </div>\n                      </td>\n                      <td className=\"px-6 py-4 whitespace-nowrap\">\n                        <span className=\"font-mono font-semibold text-gray-900\">{b.codeVisible ?? \"—\"}</span>\n                      </td>\n                      <td className=\"px-6 py-4\">\n                        <span className=\"font-semibold text-gray-900\">{b.guestName ?? \"—\"}</span>\n                      </td>\n                      <td className=\"px-6 py-4 whitespace-nowrap\">\n                        <span className=\"text-gray-700\">{phone || \"—\"}</span>\n                      </td>\n                      <td className=\"px-6 py-4 whitespace-nowrap text-gray-700\">\n                        {b.validatedAt ? formatDateTime(b.validatedAt) : \"—\"}\n                      </td>\n                      <td className=\"px-6 py-4 whitespace-nowrap\">\n                        <div className=\"text-gray-900 font-semibold\">{formatDateTime(b.checkOut)}</div>\n                        <div className=\"text-xs text-gray-500 mt-0.5\">\n                          {typeof h === \"number\" ? (h < 0 ? `${Math.abs(h).toFixed(1)}h overdue` : `${h.toFixed(1)}h left`) : \"—\"}\n                        </div>\n                      </td>\n                      <td className=\"px-6 py-4\">\n                        <span className={`inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-semibold border ${\n                          overdue\n                            ? \"bg-red-50 text-red-700 border-red-200\"\n                            : urgent\n                              ? \"bg-amber-50 text-amber-700 border-amber-200\"\n                              : \"bg-emerald-50 text-emerald-700 border-emerald-200\"\n                        }`}>\n                          <Clock className=\"h-3 w-3\" aria-hidden />\n                          {overdue ? \"OVERDUE\" : urgent ? \"URGENT\" : \"DUE SOON\"}\n                        </span>\n                      </td>\n                      <td className=\"px-6 py-4\">\n                        <div className=\"flex items-center gap-2 justify-end\">\n                          <button\n                            type=\"button\"\n                            onClick={() => openAudit(b)}\n                            className=\"inline-flex items-center justify-center h-9 rounded-md border border-gray-200 bg-white px-3 text-sm font-semibold text-gray-700 shadow-sm hover:bg-gray-50 active:scale-[0.99] transition\"\n                            aria-label=\"View audit history\"\n                            title=\"Audit history\"\n                          >\n                            <History className=\"h-4 w-4\" aria-hidden />\n                          </button>\n                          <a\n                            href={phone ? `tel:${phone}` : undefined}\n                            className={`no-underline inline-flex items-center justify-center h-9 rounded-md px-3 text-sm font-semibold border shadow-sm transition ${\n                              phone\n                                ? \"bg-white border-gray-200 text-gray-700 hover:bg-gray-50\"\n                                : \"bg-gray-50 border-gray-200 text-gray-400 cursor-not-allowed pointer-events-none\"\n                            }`}\n                            aria-label=\"Call guest\"\n                            title={phone ? \"Call guest\" : \"No phone number\"}\n                          >\n                            <PhoneCall className=\"h-4 w-4\" aria-hidden />\n                          </a>\n                          <a\n                            href={email ? `mailto:${email}` : undefined}\n                            className={`no-underline inline-flex items-center justify-center h-9 rounded-md px-3 text-sm font-semibold border shadow-sm transition ${\n                              email\n                                ? \"bg-white border-gray-200 text-gray-700 hover:bg-gray-50\"\n                                : \"bg-gray-50 border-gray-200 text-gray-400 cursor-not-allowed pointer-events-none\"\n                            }`}\n                            aria-label=\"Email guest\"\n                            title={email ? \"Email guest\" : \"No email\"}\n                          >\n                            <Mail className=\"h-4 w-4\" aria-hidden />\n                          </a>\n                          <button\n                            type=\"button\"\n                            onClick={() => { setConfirmTarget(b); setConfirmOpen(true); setError(null); setRating(0); setFeedback(\"\"); setAgreeToTerms(false); }}\n                            className=\"inline-flex items-center justify-center h-9 rounded-md bg-indigo-700 text-white px-4 text-sm font-semibold shadow-sm hover:bg-indigo-800 active:scale-[0.99] transition\"\n                          >\n                            <CheckCircle2 className=\"h-4 w-4\" aria-hidden />\n                          </button>\n                        </div>\n                      </td>\n                    </TableRow>\n                  );\n                })}\n              </tbody>\n            </table>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n\n\n","usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(owner)\\owner\\bookings\\checked-in\\[id]\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(owner)\\owner\\bookings\\checked-in\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(owner)\\owner\\bookings\\checked-out\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(owner)\\owner\\bookings\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(owner)\\owner\\bookings\\recent\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'ExternalLink' is defined but never used. Allowed unused vars must match /^_/u.","line":6,"column":32,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":44,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"ExternalLink"},"fix":{"range":[193,207],"text":""},"desc":"Remove unused variable \"ExternalLink\"."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\nimport { useEffect, useState, useRef } from \"react\";\r\nimport axios from \"axios\";\r\nimport io from 'socket.io-client';\r\nimport Link from \"next/link\";\r\nimport { Calendar, Eye, Check, ExternalLink } from \"lucide-react\";\r\nimport TableRow from \"@/components/TableRow\";\r\n\r\n// Use same-origin requests + secure httpOnly cookie session\r\nconst api = axios.create({ baseURL: \"\", withCredentials: true });\r\n\r\nexport default function RecentBookings() {\r\n  const [list, setList] = useState<any[] | null>(null);\r\n  const [minWaitElapsed, setMinWaitElapsed] = useState(false);\r\n  const retryDelayRef = useRef<number>(2000);\r\n  const pollTimerRef = useRef<number | null>(null);\r\n  const [openMenuId, setOpenMenuId] = useState<number | string | null>(null);\r\n  const menuRef = useRef<HTMLDivElement | null>(null);\r\n\r\n  useEffect(() => {\r\n    let mounted = true;\r\n\r\n    const controller = new AbortController();\r\n\r\n    const clearPoll = () => {\r\n      if (pollTimerRef.current) {\r\n        window.clearTimeout(pollTimerRef.current);\r\n        pollTimerRef.current = null;\r\n      }\r\n    };\r\n\r\n    const fetchData = async () => {\r\n      if (!mounted) return;\r\n      try {\r\n        const r = await api.get('/api/owner/bookings/recent', { signal: controller.signal });\r\n        if (!mounted) return;\r\n        setList(r.data ?? []);\r\n        retryDelayRef.current = 2000; // reset backoff on success\r\n        clearPoll();\r\n        pollTimerRef.current = window.setTimeout(() => fetchData(), 12_000);\r\n      } catch (err: any) {\r\n        // handle network errors silently and backoff\r\n        console.warn('could not load recent bookings (will retry in background)', err?.message ?? err);\r\n        // exponential backoff up to 60s\r\n        retryDelayRef.current = Math.min(retryDelayRef.current * 2, 60_000);\r\n        clearPoll();\r\n        pollTimerRef.current = window.setTimeout(() => fetchData(), retryDelayRef.current);\r\n      }\r\n    };\r\n\r\n    // initial fetch\r\n    fetchData();\r\n\r\n  // minimum wait before showing empty state (5s)\r\n  const minTimer = window.setTimeout(() => setMinWaitElapsed(true), 5000);\r\n\r\n    // visibility: when tab becomes visible, fetch immediately\r\n    const onVis = () => {\r\n      if (document.visibilityState === 'visible') fetchData();\r\n    };\r\n    document.addEventListener('visibilitychange', onVis);\r\n\r\n    // when browser regains network connectivity, try immediately\r\n    const onOnline = () => fetchData();\r\n    window.addEventListener('online', onOnline);\r\n\r\n    // socket updates from server — connect directly to API server\r\n    // WebSocket upgrades don't work through Next.js rewrites\r\n    const socketUrl = process.env.NEXT_PUBLIC_SOCKET_URL || \r\n                      process.env.NEXT_PUBLIC_API_URL || \r\n                      \"http://localhost:4000\";\r\n    const socket = io(socketUrl, { \r\n      transports: ['websocket', 'polling'],\r\n      reconnection: true,\r\n      reconnectionAttempts: 5,\r\n    });\r\n    // Join owner room for targeted realtime updates (security).\r\n    // Best-effort; if it fails we still have polling.\r\n    (async () => {\r\n      try {\r\n        const meRes = await fetch(\"/api/account/me\", { credentials: \"include\" });\r\n        const meJson: any = meRes.ok ? await meRes.json() : null;\r\n        const me = meJson?.data ?? meJson;\r\n        const ownerId = Number(me?.id || 0);\r\n        if (ownerId) {\r\n          socket.emit(\"join-owner-room\", { ownerId });\r\n        }\r\n      } catch {}\r\n    })();\r\n    socket.on('owner:bookings:updated', () => fetchData());\r\n\r\n    return () => {\r\n      mounted = false;\r\n      controller.abort();\r\n      clearPoll();\r\n      document.removeEventListener('visibilitychange', onVis);\r\n      window.removeEventListener('online', onOnline);\r\n      socket.disconnect();\r\n      window.clearTimeout(minTimer);\r\n    };\r\n  }, []);\r\n\r\n  // close menu on outside click\r\n  useEffect(() => {\r\n    const onDoc = (e: MouseEvent) => {\r\n      if (!menuRef.current) return;\r\n      if (!(e.target instanceof Node)) return;\r\n      if (!menuRef.current.contains(e.target)) setOpenMenuId(null);\r\n    };\r\n    document.addEventListener('click', onDoc);\r\n    return () => document.removeEventListener('click', onDoc);\r\n  }, []);\r\n\r\n  if (list === null && !minWaitElapsed) {\r\n    return (\r\n      <div className=\"min-h-[60vh] flex items-center justify-center\">\r\n        <div className=\"text-center\">\r\n          <span aria-hidden className=\"dot-spinner mb-2\" aria-live=\"polite\">\r\n            <span className=\"dot dot-blue\" />\r\n            <span className=\"dot dot-black\" />\r\n            <span className=\"dot dot-yellow\" />\r\n            <span className=\"dot dot-green\" />\r\n          </span>\r\n          <div className=\"mt-3 text-sm text-gray-600\">Loading recent bookings…</div>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"min-h-[60vh] px-4 py-6 flex items-start justify-center\">\r\n      <div className=\"w-full max-w-2xl\">\r\n        <div className=\"flex justify-center\">\r\n          <Calendar className=\"h-8 w-8 text-blue-600\" aria-hidden />\r\n        </div>\r\n        <h1 className=\"text-2xl font-semibold text-center mt-3\">Recent Bookings</h1>\r\n  {/* errors are handled silently in background retry; no persistent error UI */}\r\n\r\n        <div className=\"mt-4 overflow-x-auto\">\r\n          <table className=\"w-full text-sm border-collapse table-auto\">\r\n            <thead>\r\n              <tr className=\"text-left\">\r\n                <th className=\"px-3 py-2 border-b\">Booking Code</th>\r\n                <th className=\"px-3 py-2 border-b\">Full Name</th>\r\n                <th className=\"px-3 py-2 border-b\">Phone</th>\r\n                <th className=\"px-3 py-2 border-b\">Room Type</th>\r\n                <th className=\"px-3 py-2 border-b\">Check-In</th>\r\n                <th className=\"px-3 py-2 border-b\">Action</th>\r\n              </tr>\r\n            </thead>\r\n            <tbody>\r\n              { (list ?? []).length === 0 ? (\r\n                <tr>\r\n                  <td className=\"px-3 py-6 border-b text-center\" colSpan={6}>\r\n                    <div className=\"flex flex-col items-center justify-center gap-3\">\r\n                      <Calendar className=\"h-12 w-12 text-slate-400\" aria-hidden />\r\n                        <div className=\"text-sm opacity-70\">No recent bookings awaiting validation.</div>\r\n                    </div>\r\n                  </td>\r\n                </tr>\r\n              ) : (\r\n                  (list ?? []).map((b) => {\r\n                  const bookingCode = b?.code?.codeVisible ?? b.codeVisible ?? b.roomCode ?? b.id;\r\n                  const fullName = b?.guestName ?? b?.customerName ?? '-';\r\n                  const phone = b?.guestPhone ?? b?.phone ?? '-';\r\n                  const roomType = b?.roomType ?? '-';\r\n                  const checkIn = b?.checkIn ? new Date(b.checkIn).toLocaleDateString() : '-';\r\n                  return (\r\n                    <TableRow key={b.id} className=\"align-top\">\r\n                      <td className=\"px-3 py-2 border-b\">{bookingCode}</td>\r\n                      <td className=\"px-3 py-2 border-b\">{fullName}</td>\r\n                      <td className=\"px-3 py-2 border-b\">{phone}</td>\r\n                      <td className=\"px-3 py-2 border-b\">{roomType}</td>\r\n                      <td className=\"px-3 py-2 border-b\">{checkIn}</td>\r\n                      <td className=\"px-3 py-2 border-b\">\r\n                        <div className=\"relative inline-block\" ref={(el) => { if (openMenuId === b.id) menuRef.current = el; }}>\r\n                          <button aria-haspopup=\"true\" aria-label=\"Open actions\" onClick={() => setOpenMenuId(openMenuId === b.id ? null : b.id)} className=\"p-2 rounded-md hover:bg-slate-100\">\r\n                            <Eye className=\"h-5 w-5\" aria-hidden />\r\n                          </button>\r\n                          {openMenuId === b.id && (\r\n                            <div className=\"absolute right-0 mt-2 w-44 bg-white border rounded-md shadow-md z-20\">\r\n                              <Link href={`/owner/bookings/validate?bookingId=${b.id}`} className=\"flex items-center gap-2 px-3 py-2 hover:bg-slate-50 hover:text-slate-900\">\r\n                                <Check className=\"h-4 w-4 text-green-600\" />\r\n                                <span className=\"text-sm\">Validate</span>\r\n                              </Link>\r\n                              <Link href={`/owner/bookings/checked-in/${b.id}`} className=\"flex items-center gap-2 px-3 py-2 hover:bg-slate-50 hover:text-slate-900 no-underline\">\r\n                                <Eye className=\"h-4 w-4 text-slate-600\" />\r\n                                <span className=\"text-sm\">View</span>\r\n                              </Link>\r\n                            </div>\r\n                          )}\r\n                        </div>\r\n                      </td>\r\n                    </TableRow>\r\n                  );\r\n                })\r\n              )}\r\n            </tbody>\r\n          </table>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(owner)\\owner\\bookings\\recents\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(owner)\\owner\\bookings\\validate\\page.tsx","messages":[],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'startScanner' and 'stopScanner'. Either include them or remove the dependency array.","line":288,"column":6,"nodeType":"ArrayExpression","endLine":288,"endColumn":16,"suggestions":[{"desc":"Update the dependencies array to be: [scanOpen, startScanner, stopScanner]","fix":{"range":[10463,10473],"text":"[scanOpen, startScanner, stopScanner]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(owner)\\owner\\cancellation-policy\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(owner)\\owner\\cookies-policy\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(owner)\\owner\\docs\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(owner)\\owner\\driver-disbursement-policy\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(owner)\\owner\\group-stays\\[id]\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(owner)\\owner\\group-stays\\claims\\my-claims\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(owner)\\owner\\group-stays\\claims\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(owner)\\owner\\group-stays\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(owner)\\owner\\invoices\\[id]\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(owner)\\owner\\invoices\\new\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(owner)\\owner\\layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(owner)\\owner\\messages\\MessagesPageClient.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(owner)\\owner\\messages\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(owner)\\owner\\messages\\unread\\page.tsx","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/ban-ts-comment","severity":1,"message":"Use \"@ts-expect-error\" instead of \"@ts-ignore\", as \"@ts-ignore\" will do nothing if the following line is error-free.","line":120,"column":12,"nodeType":"Block","messageId":"tsIgnoreInsteadOfExpectError","endLine":120,"endColumn":28,"suggestions":[{"messageId":"replaceTsIgnoreWithTsExpectError","fix":{"range":[5038,5054],"text":"/* @ts-expect-error */"},"desc":"Replace \"@ts-ignore\" with \"@ts-expect-error\"."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(owner)\\owner\\messages\\viewed\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(owner)\\owner\\notifications\\NotificationsPageClient.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(owner)\\owner\\notifications\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(owner)\\owner\\notifications\\read\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(owner)\\owner\\notifications\\unread\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(owner)\\owner\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(owner)\\owner\\privacy\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(owner)\\owner\\profile\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'XCircle' is defined but never used. Allowed unused vars must match /^_/u.","line":6,"column":232,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":239,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"XCircle"},"fix":{"range":[411,420],"text":""},"desc":"Remove unused variable \"XCircle\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'index' is defined but never used. Allowed unused args must match /^_|^(e|err)$/u.","line":859,"column":97,"nodeType":"Identifier","messageId":"unusedVar","endLine":859,"endColumn":102}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\nimport { useEffect, useState, useRef } from \"react\";\r\nimport axios from \"axios\";\r\nimport Image from \"next/image\";\r\nimport { useSearchParams } from \"next/navigation\";\r\nimport { User, Upload, CreditCard, Wallet, X, CheckCircle, Save, Lock, LogOut, Trash2, Mail, Phone, MapPin, Building2, FileText, Pencil, AlertTriangle, History, Clock, ChevronDown, ChevronUp, KeyRound, Shield, LogIn, CheckCircle2, XCircle, ShieldCheck, Info } from 'lucide-react';\r\n// Use same-origin calls + secure httpOnly cookie session.\r\nconst api = axios.create({ baseURL: \"\", withCredentials: true });\r\n\r\nexport default function OwnerProfile() {\r\n  const [form, setForm] = useState<any>({});\r\n  const [me, setMe] = useState<any>(null);\r\n  const [loading, setLoading] = useState(true);\r\n  const [saving, setSaving] = useState(false);\r\n  const [error, setError] = useState<string | null>(null);\r\n  const [success, setSuccess] = useState<string | null>(null);\r\n  const [editingField, setEditingField] = useState<string | null>(null);\r\n  const [showConfirmDialog, setShowConfirmDialog] = useState(false);\r\n  const [confirmMessage, setConfirmMessage] = useState(\"\");\r\n  const [pendingSave, setPendingSave] = useState<(() => Promise<void>) | null>(null);\r\n  const [auditHistory, setAuditHistory] = useState<any[]>([]);\r\n  const [loadingAudit, setLoadingAudit] = useState(false);\r\n  const [showAllAuditHistory, setShowAllAuditHistory] = useState(false);\r\n  const [verifyingEmail, setVerifyingEmail] = useState(false);\r\n  const avatarFileInputRef = useRef<HTMLInputElement>(null);\r\n  const searchParams = useSearchParams();\r\n\r\n  // Check for email verification success\r\n  useEffect(() => {\r\n    if (searchParams?.get('email_verified') === '1') {\r\n      setSuccess('Email verified successfully!');\r\n      // Refresh user data\r\n      api.get(\"/api/account/me\").then((r) => {\r\n        const meData = (r as any)?.data?.data ?? (r as any)?.data;\r\n        setMe(meData);\r\n        setForm((prev: any) => ({ ...prev, emailVerifiedAt: meData?.emailVerifiedAt }));\r\n      }).catch(() => {});\r\n      // Remove query parameter from URL\r\n      if (typeof window !== 'undefined') {\r\n        const url = new URL(window.location.href);\r\n        url.searchParams.delete('email_verified');\r\n        window.history.replaceState({}, '', url.toString());\r\n      }\r\n    }\r\n  }, [searchParams]);\r\n\r\n  useEffect(() => {\r\n    let mounted = true;\r\n    (async () => {\r\n      setLoading(true);\r\n      setError(null);\r\n      try {\r\n        const r = await api.get(\"/api/account/me\");\r\n        if (!mounted) return;\r\n        // `/api/account/me` returns `{ ok: true, data: user }`\r\n        // but some callers historically expected the user object directly.\r\n        const meData = (r as any)?.data?.data ?? (r as any)?.data;\r\n        const meRole = String(meData?.role || '').toUpperCase();\r\n        // Check if user is an owner\r\n        if (meRole !== 'OWNER' && meRole !== 'ADMIN') {\r\n          window.location.href = '/owner/login';\r\n          return;\r\n        }\r\n        \r\n        // Extract payout data from JSON field and merge into form data\r\n        const payoutData = (meData?.payout && typeof meData.payout === 'object') ? meData.payout : {};\r\n        \r\n        // Helper to normalize empty strings to null\r\n        const normalizeValue = (val: any) => {\r\n          if (val === undefined || val === null || val === '') return null;\r\n          return String(val).trim() || null;\r\n        };\r\n        \r\n        const formData = {\r\n          ...meData,\r\n          // Extract payout fields to top level for form - API now attaches these directly to user object\r\n          // Use || instead of ?? to handle empty strings\r\n          bankAccountName: normalizeValue(meData.bankAccountName || payoutData.bankAccountName),\r\n          bankName: normalizeValue(meData.bankName || payoutData.bankName),\r\n          bankAccountNumber: normalizeValue(meData.bankAccountNumber || payoutData.bankAccountNumber),\r\n          bankBranch: normalizeValue(meData.bankBranch || payoutData.bankBranch),\r\n          mobileMoneyProvider: normalizeValue(meData.mobileMoneyProvider || payoutData.mobileMoneyProvider),\r\n          mobileMoneyNumber: normalizeValue(meData.mobileMoneyNumber || payoutData.mobileMoneyNumber),\r\n          payoutPreferred: normalizeValue(meData.payoutPreferred || payoutData.payoutPreferred),\r\n        };\r\n        \r\n        setForm(formData);\r\n        setMe(formData);\r\n        try { (window as any).ME = formData; } catch (e) { /* ignore */ }\r\n      } catch (err: any) {\r\n        console.error('Failed to load profile', err);\r\n        if (mounted) setError(String(err?.message ?? err));\r\n        if (typeof window !== 'undefined') window.location.href = '/owner/login';\r\n      } finally {\r\n        if (mounted) setLoading(false);\r\n      }\r\n    })();\r\n    return () => { mounted = false; };\r\n  }, []);\r\n\r\n  // Load audit history\r\n  useEffect(() => {\r\n    let mounted = true;\r\n    (async () => {\r\n      setLoadingAudit(true);\r\n      try {\r\n        const r = await api.get(\"/api/account/audit-history\", { params: { page: 1, pageSize: 20 } });\r\n        if (!mounted) return;\r\n        const data = (r as any)?.data?.data;\r\n        if (data?.items) {\r\n          setAuditHistory(data.items);\r\n        }\r\n      } catch (err) {\r\n        console.warn('Failed to load audit history', err);\r\n      } finally {\r\n        if (mounted) setLoadingAudit(false);\r\n      }\r\n    })();\r\n    return () => { mounted = false; };\r\n  }, []);\r\n\r\n  const normalizeE164Phone = (raw: unknown): string | undefined => {\r\n    if (raw === null || raw === undefined) return undefined;\r\n    const s = String(raw).trim().replace(/\\s+/g, '');\r\n    if (!s) return undefined;\r\n    if (s.startsWith('+')) return s;\r\n    // Best-effort TZ normalization (common in this app). If unsure, keep original.\r\n    if (/^0\\d{9}$/.test(s)) return `+255${s.slice(1)}`;\r\n    if (/^\\d{9}$/.test(s)) return `+255${s}`;\r\n    return s;\r\n  };\r\n\r\n  const isValidE164Phone = (phone: string) => /^\\+?[1-9]\\d{1,14}$/.test(phone);\r\n  const isValidUrl = (value: string) => {\r\n    try {\r\n      // eslint-disable-next-line no-new\r\n      new URL(value);\r\n      return true;\r\n    } catch {\r\n      return false;\r\n    }\r\n  };\r\n\r\n  const performSave = async () => {\r\n    setSaving(true);\r\n    setEditingField(null); // Close any open edit fields\r\n    try {\r\n      const payload: any = {};\r\n      const fullName = String(form.fullName || form.name || '').trim();\r\n      if (fullName) payload.fullName = fullName;\r\n\r\n      const phone = normalizeE164Phone(form.phone);\r\n      if (phone) {\r\n        if (!isValidE164Phone(phone)) {\r\n          setError('Phone number must be in international format (E.164), e.g. +2557XXXXXXXX');\r\n          setSaving(false);\r\n          return;\r\n        }\r\n        payload.phone = phone;\r\n      }\r\n\r\n      const email = String(form.email || '').trim();\r\n      if (email) payload.email = email;\r\n\r\n      const avatarUrl = String(form.avatarUrl || '').trim();\r\n      if (avatarUrl) {\r\n        // API requires a real URL (data: URLs will be rejected).\r\n        if (!isValidUrl(avatarUrl) || avatarUrl.startsWith('data:')) {\r\n          // Ignore invalid avatarUrl instead of failing the entire save.\r\n          console.warn('Ignoring invalid avatarUrl for profile update');\r\n        } else {\r\n          payload.avatarUrl = avatarUrl;\r\n        }\r\n      }\r\n\r\n      const tin = String(form.tin || '').trim();\r\n      if (tin) payload.tin = tin;\r\n\r\n      const address = String(form.address || '').trim();\r\n      if (address) payload.address = address;\r\n\r\n      await api.put(\"/api/account/profile\", payload);\r\n      \r\n      // also save payout details (owner fields) if present\r\n      try {\r\n        const payoutPayload: any = {\r\n          bankAccountName: form.bankAccountName,\r\n          bankName: form.bankName,\r\n          bankAccountNumber: form.bankAccountNumber,\r\n          bankBranch: form.bankBranch,\r\n          mobileMoneyProvider: form.mobileMoneyProvider,\r\n          mobileMoneyNumber: form.mobileMoneyNumber,\r\n          payoutPreferred: form.payoutPreferred,\r\n        };\r\n        // Only call payouts endpoint if any payout field exists\r\n        if (Object.values(payoutPayload).some(v => typeof v !== 'undefined' && v !== null && v !== '')) {\r\n          await api.put('/api/account/payouts', payoutPayload);\r\n        }\r\n      } catch (e: any) {\r\n        // Check if it's a rate limit error\r\n        const serverData = e?.response?.data;\r\n        if (serverData?.error?.includes('Too many payout updates')) {\r\n          setError(serverData.error || 'Too many payout updates. Please wait before making changes.');\r\n        } else {\r\n          console.warn('Failed to save payout details', e);\r\n        }\r\n      }\r\n      setSuccess(\"Profile saved successfully!\");\r\n      setError(null);\r\n      // Auto-hide success message after 3 seconds\r\n      setTimeout(() => setSuccess(null), 3000);\r\n      // update local `me` shortcut and global window.ME\r\n      try {\r\n        const updatedMe = { ...(me ?? {}), ...payload, bankAccountName: form.bankAccountName, bankName: form.bankName, bankAccountNumber: form.bankAccountNumber, bankBranch: form.bankBranch, mobileMoneyProvider: form.mobileMoneyProvider, mobileMoneyNumber: form.mobileMoneyNumber, payoutPreferred: form.payoutPreferred };\r\n        setMe(updatedMe);\r\n        try { (window as any).ME = updatedMe; } catch (e) { /* ignore */ }\r\n      } catch (e) { /* ignore */ }\r\n      \r\n      // Reload audit history after save\r\n      try {\r\n        const r = await api.get(\"/api/account/audit-history\", { params: { page: 1, pageSize: 20 } });\r\n        const data = (r as any)?.data?.data;\r\n        if (data?.items) {\r\n          setAuditHistory(data.items);\r\n        }\r\n      } catch (err) {\r\n        console.warn('Failed to reload audit history', err);\r\n      }\r\n    } catch (err: any) {\r\n      console.error('Failed to save profile', err);\r\n      const serverData = err?.response?.data;\r\n      const serverMessage = serverData?.error || serverData?.message;\r\n      const details = Array.isArray(serverData?.details) ? serverData.details : null;\r\n      const detailsText = details\r\n        ? details.map((d: any) => d?.message).filter(Boolean).join('; ')\r\n        : '';\r\n      setError(\r\n        'Could not save profile: ' +\r\n          String(serverMessage || err?.message || err) +\r\n          (detailsText ? ` (${detailsText})` : '')\r\n      );\r\n      setSuccess(null);\r\n    } finally {\r\n      setSaving(false);\r\n    }\r\n  };\r\n\r\n  const save = async () => {\r\n    // Check for sensitive field changes that require confirmation\r\n    const sensitiveFields = ['bankAccountNumber', 'mobileMoneyNumber', 'bankName', 'bankAccountName'];\r\n    const hasSensitiveChange = sensitiveFields.some(field => {\r\n      const oldVal = String(me?.[field] || '').trim().toLowerCase();\r\n      const newVal = String(form[field] || '').trim().toLowerCase();\r\n      return oldVal !== newVal && newVal !== '';\r\n    });\r\n\r\n    if (hasSensitiveChange) {\r\n      const changedFields = sensitiveFields.filter(field => {\r\n        const oldVal = String(me?.[field] || '').trim().toLowerCase();\r\n        const newVal = String(form[field] || '').trim().toLowerCase();\r\n        return oldVal !== newVal && newVal !== '';\r\n      });\r\n      \r\n      const fieldLabels: Record<string, string> = {\r\n        bankAccountNumber: 'Bank Account Number',\r\n        mobileMoneyNumber: 'Mobile Money Number',\r\n        bankName: 'Bank Name',\r\n        bankAccountName: 'Bank Account Name',\r\n      };\r\n      \r\n      setConfirmMessage(\r\n        `You are about to change sensitive payout information: ${changedFields.map(f => fieldLabels[f] || f).join(', ')}. ` +\r\n        `This change will be logged in your audit history. Are you sure you want to continue?`\r\n      );\r\n      setPendingSave(() => performSave);\r\n      setShowConfirmDialog(true);\r\n    } else {\r\n      await performSave();\r\n    }\r\n  };\r\n\r\n  if (loading) {\r\n    return (\r\n      <div className=\"w-full max-w-full flex items-center justify-center py-12\">\r\n        <div className=\"text-center\">\r\n          <div className=\"dot-spinner dot-md mx-auto\" aria-hidden>\r\n            <span className=\"dot dot-blue\" />\r\n            <span className=\"dot dot-black\" />\r\n            <span className=\"dot dot-yellow\" />\r\n            <span className=\"dot dot-green\" />\r\n          </div>\r\n          <p className=\"text-sm text-slate-500 mt-4\">Loading profile…</p>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n  \r\n  if (error) {\r\n    return (\r\n      <div className=\"w-full max-w-full\">\r\n        <div className=\"rounded-md bg-red-50 border-2 border-red-200 p-4\">\r\n          <div className=\"text-sm font-medium text-red-800\">Error loading profile: {error}</div>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  const maskAccount = (str: string | null | undefined) => {\r\n    if (!str) return '—';\r\n    const s = String(str);\r\n    if (s.length <= 4) return s;\r\n    return s.slice(0, 4) + '•'.repeat(Math.min(4, s.length - 4)) + s.slice(-4);\r\n  };\r\n\r\n  const maskPhone = (str: string | null | undefined) => {\r\n    if (!str) return '—';\r\n    const s = String(str).replace(/\\D/g, '');\r\n    if (s.length <= 4) return s;\r\n    return s.slice(0, 3) + '•'.repeat(Math.min(4, s.length - 4)) + s.slice(-3);\r\n  };\r\n\r\n  const renderField = (label: string, value: any, icon: any, required: boolean = false, fieldKey?: string, fieldType: 'text' | 'textarea' = 'text') => {\r\n    const Icon = icon;\r\n    // Check for empty string, null, undefined, or whitespace-only strings\r\n    const isEmpty = !value || (typeof value === 'string' && value.trim() === '');\r\n    // Mask account number, mobile money number, and phone when displaying (not when editing)\r\n    const displayValue = isEmpty \r\n      ? (required ? 'Not provided' : '—') \r\n      : (fieldKey === 'bankAccountNumber' && editingField !== 'bankAccountNumber' \r\n          ? maskAccount(value) \r\n          : (fieldKey === 'mobileMoneyNumber' || fieldKey === 'phone') && editingField !== fieldKey\r\n          ? maskPhone(value)\r\n          : String(value));\r\n    // Generate unique ID for each field instance using timestamp and random\r\n    const fieldId = fieldKey ? `owner-profile-${fieldKey}-${Date.now()}-${Math.random().toString(36).substring(2, 9)}` : undefined;\r\n    \r\n    return (\r\n      <div className=\"w-full max-w-full min-w-0 p-3 sm:p-4 bg-white border-2 border-slate-200 rounded-xl hover:border-emerald-300 transition-all duration-300 hover:shadow-md group overflow-hidden box-border\">\r\n        <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 mb-2 w-full max-w-full min-w-0 overflow-hidden\">\r\n          {fieldId ? (\r\n            <label htmlFor={fieldId} className=\"text-xs sm:text-sm font-semibold text-slate-700 flex items-center gap-1.5 min-w-0 flex-1 overflow-hidden\">\r\n              <Icon className=\"w-3.5 h-3.5 sm:w-4 sm:h-4 text-slate-500 transition-colors duration-300 group-hover:text-emerald-600 flex-shrink-0\" />\r\n              <span className=\"truncate min-w-0\">{label}</span>\r\n              {required && <span className=\"text-red-500 flex-shrink-0\">*</span>}\r\n              {fieldKey === 'mobileMoneyProvider' && editingField === 'mobileMoneyProvider' && (\r\n                <div className=\"relative group/tooltip flex-shrink-0\">\r\n                  <Info className=\"w-3.5 h-3.5 sm:w-4 sm:h-4 text-blue-600 transition-colors cursor-help\" />\r\n                  <div className=\"absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-slate-900 text-white text-xs rounded-lg shadow-lg z-50 min-w-[200px]\">\r\n                    <div className=\"font-semibold mb-1\">Available providers:</div>\r\n                    <div className=\"space-y-0.5\">\r\n                      <div>• M-Pesa</div>\r\n                      <div>• Mix by yas</div>\r\n                      <div>• Airtel</div>\r\n                      <div>• Tigo Pesa</div>\r\n                      <div>• Halopesa</div>\r\n                    </div>\r\n                    <div className=\"absolute top-full left-1/2 transform -translate-x-1/2 -mt-1\">\r\n                      <div className=\"border-4 border-transparent border-t-slate-900\"></div>\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n              )}\r\n              {fieldKey === 'bankName' && editingField === 'bankName' && (\r\n                <div className=\"relative group/tooltip flex-shrink-0\">\r\n                  <Info className=\"w-3.5 h-3.5 sm:w-4 sm:h-4 text-blue-600 transition-colors cursor-help\" />\r\n                  <div className=\"absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-slate-900 text-white text-xs rounded-lg shadow-lg z-50 min-w-[200px]\">\r\n                    <div className=\"font-semibold mb-1\">Sample bank names:</div>\r\n                    <div className=\"space-y-0.5\">\r\n                      <div>• CRDB BANK</div>\r\n                      <div>• NMB BANK</div>\r\n                      <div>• NBC BANK</div>\r\n                      <div>• EXIM BANK</div>\r\n                      <div>• DTB BANK</div>\r\n                    </div>\r\n                    <div className=\"absolute top-full left-1/2 transform -translate-x-1/2 -mt-1\">\r\n                      <div className=\"border-4 border-transparent border-t-slate-900\"></div>\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n              )}\r\n            </label>\r\n          ) : (\r\n            <div className=\"text-xs sm:text-sm font-semibold text-slate-700 flex items-center gap-1.5 min-w-0 flex-1 overflow-hidden\">\r\n              <Icon className=\"w-3.5 h-3.5 sm:w-4 sm:h-4 text-slate-500 transition-colors duration-300 group-hover:text-emerald-600 flex-shrink-0\" />\r\n              <span className=\"truncate min-w-0\">{label}</span>\r\n              {required && <span className=\"text-red-500 flex-shrink-0\">*</span>}\r\n              {fieldKey === 'mobileMoneyProvider' && editingField === 'mobileMoneyProvider' && (\r\n                <div className=\"relative group/tooltip flex-shrink-0\">\r\n                  <Info className=\"w-3.5 h-3.5 sm:w-4 sm:h-4 text-blue-600 transition-colors cursor-help\" />\r\n                  <div className=\"absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-slate-900 text-white text-xs rounded-lg shadow-lg z-50 min-w-[200px]\">\r\n                    <div className=\"font-semibold mb-1\">Available providers:</div>\r\n                    <div className=\"space-y-0.5\">\r\n                      <div>• M-Pesa</div>\r\n                      <div>• Mix by yas</div>\r\n                      <div>• Airtel</div>\r\n                      <div>• Tigo Pesa</div>\r\n                      <div>• Halopesa</div>\r\n                    </div>\r\n                    <div className=\"absolute top-full left-1/2 transform -translate-x-1/2 -mt-1\">\r\n                      <div className=\"border-4 border-transparent border-t-slate-900\"></div>\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n              )}\r\n              {fieldKey === 'bankName' && editingField === 'bankName' && (\r\n                <div className=\"relative group/tooltip flex-shrink-0\">\r\n                  <Info className=\"w-3.5 h-3.5 sm:w-4 sm:h-4 text-blue-600 transition-colors cursor-help\" />\r\n                  <div className=\"absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-slate-900 text-white text-xs rounded-lg shadow-lg z-50 min-w-[200px]\">\r\n                    <div className=\"font-semibold mb-1\">Sample bank names:</div>\r\n                    <div className=\"space-y-0.5\">\r\n                      <div>• CRDB BANK</div>\r\n                      <div>• NMB BANK</div>\r\n                      <div>• NBC BANK</div>\r\n                      <div>• EXIM BANK</div>\r\n                      <div>• DTB BANK</div>\r\n                    </div>\r\n                    <div className=\"absolute top-full left-1/2 transform -translate-x-1/2 -mt-1\">\r\n                      <div className=\"border-4 border-transparent border-t-slate-900\"></div>\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n              )}\r\n            </div>\r\n          )}\r\n          {fieldKey && (\r\n            <button \r\n              type=\"button\" \r\n              onClick={() => setEditingField(editingField === fieldKey ? null : fieldKey)}\r\n              className=\"text-xs sm:text-sm text-emerald-600 hover:text-emerald-700 hover:underline font-medium flex items-center gap-1 transition-all duration-200 hover:scale-105 self-start sm:self-auto flex-shrink-0 whitespace-nowrap\"\r\n            >\r\n              <Pencil className=\"w-3 h-3 flex-shrink-0\" />\r\n              <span>{editingField === fieldKey ? 'Cancel' : 'Edit'}</span>\r\n            </button>\r\n          )}\r\n        </div>\r\n        <div className=\"w-full max-w-full min-w-0 overflow-hidden\">\r\n          {editingField === fieldKey && fieldKey ? (\r\n            fieldType === 'textarea' ? (\r\n              <textarea\r\n                id={fieldId}\r\n                aria-label={label}\r\n                value={value || ''}\r\n                onChange={(e) => setForm({...form, [fieldKey]: e.target.value})}\r\n                className=\"block w-full max-w-full rounded-lg border-2 border-emerald-200 px-3 py-2.5 text-sm focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-200 transition-all duration-200 resize-none min-w-0 box-border\"\r\n                rows={3}\r\n                autoFocus\r\n                onBlur={() => setEditingField(null)}\r\n              />\r\n            ) : (\r\n              <input\r\n                id={fieldId}\r\n                type={fieldKey === 'email' ? 'email' : fieldKey === 'phone' ? 'tel' : 'text'}\r\n                aria-label={label}\r\n                value={value || ''}\r\n                placeholder={fieldKey === 'mobileMoneyProvider' ? 'e.g., M-Pesa, Mix by yas, Airtel' : fieldKey === 'bankName' ? 'e.g., CRDB BANK, NMB BANK, NBC BANK' : undefined}\r\n                onChange={(e) => setForm({...form, [fieldKey]: e.target.value})}\r\n                className=\"block w-full max-w-full rounded-lg border-2 border-emerald-200 px-3 py-2.5 text-sm focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-200 transition-all duration-200 min-w-0 box-border\"\r\n                autoFocus\r\n                onBlur={() => setEditingField(null)}\r\n                onKeyDown={(e) => {\r\n                  if (e.key === 'Enter') setEditingField(null);\r\n                }}\r\n              />\r\n            )\r\n          ) : (\r\n            <div className=\"space-y-2\">\r\n              <div className={`text-xs sm:text-sm font-medium transition-colors duration-200 break-words overflow-wrap-anywhere w-full max-w-full ${isEmpty ? 'text-slate-400 italic' : 'text-slate-900'}`}>\r\n                {displayValue}\r\n              </div>\r\n              {/* Verification Status for Email and Phone */}\r\n              {fieldKey === 'email' && !isEmpty && (\r\n                <div className=\"flex items-center gap-2\">\r\n                  {me?.emailVerifiedAt ? (\r\n                    <div className=\"flex items-center gap-1.5 text-xs text-green-600 font-medium\">\r\n                      <CheckCircle2 className=\"h-3.5 w-3.5 flex-shrink-0\" />\r\n                      <span>Verified</span>\r\n                    </div>\r\n                  ) : (\r\n                    <button\r\n                      type=\"button\"\r\n                      onClick={async () => {\r\n                        setVerifyingEmail(true);\r\n                        try {\r\n                          await api.post('/api/owner/email/verify/send');\r\n                          setSuccess('Verification email sent! Please check your inbox.');\r\n                          // Refresh user data to get updated verification status\r\n                          const r = await api.get(\"/api/account/me\");\r\n                          const meData = (r as any)?.data?.data ?? (r as any)?.data;\r\n                          setMe(meData);\r\n                          setForm((prev: any) => ({ ...prev, emailVerifiedAt: meData?.emailVerifiedAt }));\r\n                        } catch (err: any) {\r\n                          setError(err?.response?.data?.error || 'Failed to send verification email');\r\n                        } finally {\r\n                          setVerifyingEmail(false);\r\n                        }\r\n                      }}\r\n                      disabled={verifyingEmail}\r\n                      className=\"flex items-center gap-1.5 text-xs text-blue-600 hover:text-blue-700 font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                    >\r\n                      <ShieldCheck className=\"h-3.5 w-3.5 flex-shrink-0\" />\r\n                      <span>{verifyingEmail ? 'Sending...' : 'Verify Email'}</span>\r\n                    </button>\r\n                  )}\r\n                </div>\r\n              )}\r\n              {/* Phone numbers are verified during registration, so always show verified badge */}\r\n              {fieldKey === 'phone' && !isEmpty && (\r\n                <div className=\"flex items-center gap-2\">\r\n                  <div className=\"flex items-center gap-1.5 text-xs text-green-600 font-medium\">\r\n                    <CheckCircle2 className=\"h-3.5 w-3.5 flex-shrink-0\" />\r\n                    <span>Verified</span>\r\n                  </div>\r\n                </div>\r\n              )}\r\n            </div>\r\n          )}\r\n        </div>\r\n      </div>\r\n    );\r\n  };\r\n\r\n  return (\r\n    <div className=\"w-full min-h-screen bg-gradient-to-br from-slate-50 via-emerald-50/30 to-slate-50 py-4 sm:py-6 lg:py-8 px-4 sm:px-6 lg:px-8\">\r\n      <div className=\"max-w-6xl mx-auto space-y-4 sm:space-y-6\">\r\n        {/* Header Card */}\r\n        <div className=\"bg-white rounded-2xl shadow-lg border-2 border-slate-200/50 p-4 sm:p-6 lg:p-8 transition-all duration-300 hover:shadow-xl hover:border-emerald-200/50\">\r\n          <div className=\"flex flex-col items-center text-center\">\r\n            {form.avatarUrl ? (\r\n              <div className=\"relative mb-4 sm:mb-6 group\">\r\n                <div className=\"absolute inset-0 rounded-full bg-emerald-400/20 blur-xl group-hover:bg-emerald-400/30 transition-all duration-300\"></div>\r\n                <Image \r\n                  src={form.avatarUrl} \r\n                  alt=\"avatar\" \r\n                  width={96} \r\n                  height={96} \r\n                  className=\"relative rounded-full object-cover border-4 border-emerald-200 shadow-xl transition-all duration-300 hover:scale-105 hover:border-emerald-300\" \r\n                />\r\n                <button\r\n                  type=\"button\"\r\n                  onClick={() => avatarFileInputRef.current?.click()}\r\n                  className=\"absolute bottom-0 right-0 h-9 w-9 sm:h-10 sm:w-10 rounded-full bg-emerald-600 text-white flex items-center justify-center hover:bg-emerald-700 transition-all duration-300 shadow-lg hover:shadow-xl hover:scale-110 active:scale-95\"\r\n                  aria-label=\"Change avatar\"\r\n                >\r\n                  <Upload className=\"h-4 w-4 sm:h-5 sm:w-5\" />\r\n                </button>\r\n              </div>\r\n            ) : (\r\n              <div className=\"relative mb-4 sm:mb-6 group\">\r\n                <div className=\"absolute inset-0 rounded-full bg-emerald-400/20 blur-xl group-hover:bg-emerald-400/30 transition-all duration-300\"></div>\r\n                <div className=\"relative h-20 w-20 sm:h-24 sm:w-24 rounded-full bg-gradient-to-br from-emerald-100 to-blue-100 flex items-center justify-center border-4 border-emerald-200 shadow-xl transition-all duration-300 hover:scale-105 hover:border-emerald-300\">\r\n                  <User className=\"h-10 w-10 sm:h-12 sm:w-12 text-emerald-600 transition-transform duration-300 group-hover:scale-110\" />\r\n                </div>\r\n                <button\r\n                  type=\"button\"\r\n                  onClick={() => avatarFileInputRef.current?.click()}\r\n                  className=\"absolute bottom-0 right-0 h-9 w-9 sm:h-10 sm:w-10 rounded-full bg-emerald-600 text-white flex items-center justify-center hover:bg-emerald-700 transition-all duration-300 shadow-lg hover:shadow-xl hover:scale-110 active:scale-95\"\r\n                  aria-label=\"Upload avatar\"\r\n                >\r\n                  <Upload className=\"h-4 w-4 sm:h-5 sm:w-5\" />\r\n                </button>\r\n              </div>\r\n            )}\r\n            <input\r\n              ref={avatarFileInputRef}\r\n              type=\"file\"\r\n              accept=\"image/*\"\r\n              aria-label=\"Upload avatar image\"\r\n              onChange={async (e) => {\r\n                const f = e.target.files?.[0];\r\n                if (!f) return;\r\n                const reader = new FileReader();\r\n                reader.onload = () => {\r\n                  setForm((prev: any) => ({ ...prev, avatarUrl: String(reader.result) }));\r\n                };\r\n                reader.readAsDataURL(f);\r\n              }}\r\n              className=\"hidden\"\r\n            />\r\n            <h1 className=\"text-xl sm:text-2xl lg:text-3xl font-bold text-gray-900 mb-2 transition-all duration-300\">Your Profile</h1>\r\n            <p className=\"text-xs sm:text-sm text-slate-600 max-w-md\">Review and update your information</p>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Success/Error Messages */}\r\n        {success && (\r\n          <div className=\"bg-white rounded-xl shadow-md border-2 border-green-200 p-4 animate-in fade-in slide-in-from-top-2 duration-300 transition-all\">\r\n            <div className=\"flex items-center gap-2 text-sm sm:text-base font-medium text-green-800\">\r\n              <CheckCircle className=\"h-5 w-5 flex-shrink-0\" />\r\n              <span>{success}</span>\r\n            </div>\r\n          </div>\r\n        )}\r\n        {error && (\r\n          <div className=\"bg-white rounded-xl shadow-md border-2 border-red-200 p-4 animate-in fade-in slide-in-from-top-2 duration-300 transition-all\">\r\n            <div className=\"flex items-center gap-2 text-sm sm:text-base font-medium text-red-800\">\r\n              <X className=\"h-5 w-5 flex-shrink-0\" />\r\n              <span>{error}</span>\r\n            </div>\r\n          </div>\r\n        )}\r\n\r\n        {/* Registration Details Section */}\r\n        <section className=\"bg-white rounded-2xl shadow-lg border-2 border-slate-200/50 p-4 sm:p-6 lg:p-8 w-full max-w-full overflow-hidden transition-all duration-300 hover:shadow-xl hover:border-emerald-200/50 animate-in fade-in slide-in-from-bottom-4 box-border\">\r\n          <div className=\"flex items-center gap-2 mb-4 sm:mb-6 pb-3 border-b border-slate-200\">\r\n            <div className=\"h-10 w-10 rounded-lg bg-emerald-50 flex items-center justify-center transition-all duration-300 group-hover:bg-emerald-100\">\r\n              <User className=\"w-5 h-5 text-emerald-600\" />\r\n            </div>\r\n            <h2 className=\"text-base sm:text-lg lg:text-xl font-bold text-slate-900\">Registration Details</h2>\r\n          </div>\r\n          \r\n          <div className=\"grid grid-cols-2 sm:grid-cols-2 gap-3 sm:gap-4 w-full max-w-full overflow-hidden\">\r\n            <div className=\"min-w-0 max-w-full overflow-hidden\">\r\n              {renderField(\"Full name\", form.fullName || form.name, User, true, 'fullName')}\r\n            </div>\r\n            <div className=\"min-w-0 max-w-full overflow-hidden\">\r\n              {renderField(\"Email\", form.email, Mail, true, 'email')}\r\n            </div>\r\n            <div className=\"min-w-0 max-w-full overflow-hidden\">\r\n              {renderField(\"Phone\", form.phone, Phone, false, 'phone')}\r\n            </div>\r\n            <div className=\"min-w-0 max-w-full overflow-hidden\">\r\n              {renderField(\"Business TIN\", form.tin, FileText, false, 'tin')}\r\n            </div>\r\n            <div className=\"col-span-2 min-w-0 max-w-full overflow-hidden\">\r\n              {renderField(\"Address\", form.address, MapPin, false, 'address', 'textarea')}\r\n            </div>\r\n          </div>\r\n        </section>\r\n\r\n        {/* Payout Details Section */}\r\n        <section className=\"bg-white rounded-2xl shadow-lg border-2 border-slate-200/50 p-4 sm:p-6 lg:p-8 w-full max-w-full overflow-hidden transition-all duration-300 hover:shadow-xl hover:border-emerald-200/50 animate-in fade-in slide-in-from-bottom-4 box-border\">\r\n          <div className=\"flex items-center gap-2 mb-4 sm:mb-6 pb-3 border-b border-slate-200\">\r\n            <div className=\"h-10 w-10 rounded-lg bg-blue-50 flex items-center justify-center transition-all duration-300 group-hover:bg-blue-100\">\r\n              <CreditCard className=\"w-5 h-5 text-blue-600\" />\r\n            </div>\r\n            <h2 className=\"text-base sm:text-lg lg:text-xl font-bold text-slate-900\">Payout Details</h2>\r\n          </div>\r\n          \r\n          <div className=\"space-y-4 sm:space-y-6\">\r\n            {/* Bank Account Details */}\r\n            <div className=\"p-4 sm:p-5 bg-gradient-to-br from-slate-50 to-slate-100/50 rounded-xl border-2 border-slate-200 transition-all duration-300 hover:border-emerald-200 hover:shadow-md w-full max-w-full overflow-hidden min-w-0 box-border\">\r\n              <div className=\"flex items-center gap-2 mb-4\">\r\n                <div className=\"h-8 w-8 rounded-lg bg-emerald-50 flex items-center justify-center\">\r\n                  <Building2 className=\"w-4 h-4 text-emerald-600\" />\r\n                </div>\r\n                <h3 className=\"text-sm sm:text-base font-bold text-slate-900\">Bank Account</h3>\r\n              </div>\r\n              <div className=\"grid grid-cols-2 sm:grid-cols-2 gap-3 sm:gap-4 w-full max-w-full overflow-hidden\">\r\n                <div className=\"min-w-0 max-w-full overflow-hidden\">\r\n                  {renderField(\"Bank name\", form.bankName, Building2, false, 'bankName')}\r\n                </div>\r\n                <div className=\"min-w-0 max-w-full overflow-hidden\">\r\n                  {renderField(\"Account name\", form.bankAccountName, User, false, 'bankAccountName')}\r\n                </div>\r\n                <div className=\"min-w-0 max-w-full overflow-hidden\">\r\n                  {renderField(\"Account number\", form.bankAccountNumber, CreditCard, false, 'bankAccountNumber')}\r\n                </div>\r\n                <div className=\"min-w-0 max-w-full overflow-hidden\">\r\n                  {renderField(\"Branch\", form.bankBranch, MapPin, false, 'bankBranch')}\r\n                </div>\r\n              </div>\r\n            </div>\r\n\r\n            {/* Mobile Money Details */}\r\n            <div className=\"p-4 sm:p-5 bg-gradient-to-br from-slate-50 to-slate-100/50 rounded-xl border-2 border-slate-200 transition-all duration-300 hover:border-emerald-200 hover:shadow-md w-full max-w-full overflow-hidden min-w-0 box-border\">\r\n              <div className=\"flex items-center gap-2 mb-4\">\r\n                <div className=\"h-8 w-8 rounded-lg bg-blue-50 flex items-center justify-center\">\r\n                  <Phone className=\"w-4 h-4 text-blue-600\" />\r\n                </div>\r\n                <h3 className=\"text-sm sm:text-base font-bold text-slate-900\">Mobile Money</h3>\r\n              </div>\r\n              <div className=\"grid grid-cols-2 sm:grid-cols-2 gap-3 sm:gap-4 w-full max-w-full overflow-hidden\">\r\n                <div className=\"min-w-0 max-w-full overflow-hidden\">\r\n                  {renderField(\r\n                    \"Provider\", \r\n                    form.mobileMoneyProvider, \r\n                    Phone, \r\n                    false, \r\n                    'mobileMoneyProvider',\r\n                    'text'\r\n                  )}\r\n                </div>\r\n                <div className=\"min-w-0 max-w-full overflow-hidden\">\r\n                  {renderField(\"Mobile Money Number\", form.mobileMoneyNumber, Phone, false, 'mobileMoneyNumber')}\r\n                </div>\r\n              </div>\r\n            </div>\r\n\r\n            {/* Payout Preference */}\r\n            <div className=\"p-4 sm:p-5 bg-white border-2 border-slate-200 rounded-xl transition-all duration-300 hover:border-emerald-200 hover:shadow-md\">\r\n              <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 mb-2\">\r\n                <label className=\"text-xs sm:text-sm font-semibold text-slate-700 flex items-center gap-1.5\">\r\n                  <Wallet className=\"w-3.5 h-3.5 sm:w-4 sm:h-4 text-slate-500\" />\r\n                  Preferred payout method\r\n                </label>\r\n                <button \r\n                  type=\"button\" \r\n                  onClick={() => setEditingField(editingField === 'payoutPreferred' ? null : 'payoutPreferred')}\r\n                  className=\"text-xs sm:text-sm text-emerald-600 hover:text-emerald-700 hover:underline font-medium flex items-center gap-1 transition-all duration-200 hover:scale-105\"\r\n                >\r\n                  <Pencil className=\"w-3 h-3\" />\r\n                  {editingField === 'payoutPreferred' ? 'Cancel' : 'Edit'}\r\n                </button>\r\n              </div>\r\n              {editingField === 'payoutPreferred' ? (\r\n                <select\r\n                  id=\"field-payoutPreferred\"\r\n                  aria-label=\"Preferred payout method\"\r\n                  value={form.payoutPreferred || ''}\r\n                  onChange={(e) => setForm({...form, payoutPreferred: e.target.value})}\r\n                  className=\"block w-full rounded-lg border-2 border-emerald-200 px-3 py-2.5 text-sm focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-200 transition-all duration-200\"\r\n                  autoFocus\r\n                  onBlur={() => setEditingField(null)}\r\n                >\r\n                  <option value=\"\">Select preference</option>\r\n                  <option value=\"BANK\">Bank Account</option>\r\n                  <option value=\"MOBILE_MONEY\">Mobile Money</option>\r\n                </select>\r\n              ) : (\r\n                <div className={`text-sm sm:text-base font-medium transition-colors duration-200 ${!form.payoutPreferred ? 'text-slate-400 italic' : 'text-slate-900'}`}>\r\n                  {form.payoutPreferred === 'BANK' ? 'Bank Account' : form.payoutPreferred === 'MOBILE_MONEY' ? 'Mobile Money' : 'Not set'}\r\n                </div>\r\n              )}\r\n            </div>\r\n\r\n            {/* Display saved payout details */}\r\n            {(form.bankAccountNumber || form.mobileMoneyNumber || form.bankName) ? (\r\n              <div className=\"p-4 sm:p-5 border-2 border-emerald-200 rounded-xl bg-gradient-to-br from-emerald-50/50 to-emerald-100/30 transition-all duration-300 hover:shadow-md hover:border-emerald-300\">\r\n                <div className=\"flex items-center gap-2 mb-3\">\r\n                  <CheckCircle className=\"h-5 w-5 text-emerald-600 flex-shrink-0\" />\r\n                  <div className=\"font-bold text-gray-900 text-sm sm:text-base\">Saved payout details</div>\r\n                </div>\r\n                <div className=\"space-y-2 text-xs sm:text-sm text-slate-700\">\r\n                  {form.bankName && form.bankAccountNumber && (\r\n                    <div className=\"flex items-center gap-2 flex-wrap\">\r\n                      <Building2 className=\"h-4 w-4 text-slate-500 flex-shrink-0\" />\r\n                      <span className=\"break-words\">Bank: <strong>{form.bankName}</strong> — Account: <strong className=\"font-mono\">{maskAccount(form.bankAccountNumber)}</strong></span>\r\n                    </div>\r\n                  )}\r\n                  {form.mobileMoneyProvider && form.mobileMoneyNumber && (\r\n                    <div className=\"flex items-center gap-2 flex-wrap\">\r\n                      <Phone className=\"h-4 w-4 text-slate-500 flex-shrink-0\" />\r\n                      <span className=\"break-words\">Mobile money (<strong>{form.mobileMoneyProvider}</strong>): <strong className=\"font-mono\">{maskPhone(form.mobileMoneyNumber)}</strong></span>\r\n                    </div>\r\n                  )}\r\n                  {form.payoutPreferred && (\r\n                    <div className=\"text-xs text-slate-500 mt-2\">Preferred: {form.payoutPreferred === 'BANK' ? 'Bank Account' : form.payoutPreferred === 'MOBILE_MONEY' ? 'Mobile Money' : form.payoutPreferred}</div>\r\n                  )}\r\n                </div>\r\n              </div>\r\n            ) : (\r\n              <div className=\"p-6 sm:p-8 text-center border-2 border-slate-200 rounded-xl bg-gradient-to-br from-slate-50 to-slate-100/50 transition-all duration-300 hover:border-slate-300\">\r\n                <Wallet className=\"h-10 w-10 sm:h-12 sm:w-12 text-slate-300 mx-auto mb-3 transition-transform duration-300\" />\r\n                <div className=\"text-sm sm:text-base font-medium text-slate-600 mb-1\">No saved payout details</div>\r\n                <div className=\"text-xs sm:text-sm text-slate-500\">Add payout details to receive payments</div>\r\n              </div>\r\n            )}\r\n          </div>\r\n        </section>\r\n\r\n        {/* Actions Section */}\r\n        <section className=\"bg-white rounded-2xl shadow-lg border-2 border-slate-200/50 p-4 sm:p-6 lg:p-8 w-full max-w-full overflow-hidden transition-all duration-300 hover:shadow-xl hover:border-emerald-200/50 animate-in fade-in slide-in-from-bottom-4 box-border\">\r\n          <div className=\"flex items-center gap-2 mb-4 sm:mb-6 pb-3 sm:pb-4 border-b border-slate-200\">\r\n            <div className=\"h-10 w-10 rounded-lg bg-slate-50 flex items-center justify-center transition-all duration-300 group-hover:bg-slate-100\">\r\n              <Lock className=\"h-5 w-5 text-slate-600\" />\r\n            </div>\r\n            <h2 className=\"text-base sm:text-lg lg:text-xl font-bold text-gray-900\">Account Actions</h2>\r\n          </div>\r\n          \r\n          <div className=\"grid grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4 w-full max-w-full min-w-0 overflow-hidden\">\r\n            <button\r\n              className={`w-full max-w-full min-w-0 inline-flex items-center justify-center gap-1.5 sm:gap-2 px-2 sm:px-3 md:px-4 py-2.5 sm:py-3 text-xs sm:text-sm font-semibold rounded-xl transition-all duration-300 border-2 shadow-md hover:shadow-lg box-border overflow-hidden ${\r\n                saving \r\n                  ? 'text-slate-400 bg-slate-50 border-slate-200 opacity-60 cursor-wait' \r\n                  : 'text-white bg-emerald-600 hover:bg-emerald-700 border-emerald-600 hover:border-emerald-700 hover:scale-105 active:scale-95'\r\n              }`}\r\n              onClick={save}\r\n              disabled={saving}\r\n              aria-live=\"polite\"\r\n            >\r\n              <Save className=\"h-3.5 w-3.5 sm:h-4 sm:w-4 flex-shrink-0\" />\r\n              <span className=\"truncate min-w-0\">{saving ? 'Saving…' : 'Save Changes'}</span>\r\n            </button>\r\n            \r\n            <button \r\n              className=\"w-full max-w-full min-w-0 inline-flex items-center justify-center gap-1.5 sm:gap-2 px-2 sm:px-3 md:px-4 py-2.5 sm:py-3 text-xs sm:text-sm font-semibold text-slate-700 hover:text-slate-900 hover:bg-slate-50 rounded-xl transition-all duration-300 border-2 border-slate-200 hover:border-slate-300 shadow-md hover:shadow-lg hover:scale-105 active:scale-95 box-border overflow-hidden\" \r\n              onClick={() => { window.location.href = '/owner/settings/password'; }}\r\n            >\r\n              <Lock className=\"h-3.5 w-3.5 sm:h-4 sm:w-4 flex-shrink-0\" />\r\n              <span className=\"truncate min-w-0\">Change Password</span>\r\n            </button>\r\n            \r\n            <button \r\n              className=\"w-full max-w-full min-w-0 inline-flex items-center justify-center gap-1.5 sm:gap-2 px-2 sm:px-3 md:px-4 py-2.5 sm:py-3 text-xs sm:text-sm font-semibold text-slate-700 hover:text-slate-900 hover:bg-slate-50 rounded-xl transition-all duration-300 border-2 border-slate-200 hover:border-slate-300 shadow-md hover:shadow-lg hover:scale-105 active:scale-95 box-border overflow-hidden\" \r\n              onClick={async () => {\r\n                try {\r\n                  await fetch(\"/api/auth/logout\", { method: \"POST\", credentials: \"include\" });\r\n                } catch {}\r\n                window.location.href = \"/owner/login\";\r\n              }}\r\n            >\r\n              <LogOut className=\"h-3.5 w-3.5 sm:h-4 sm:w-4 flex-shrink-0\" />\r\n              <span className=\"truncate min-w-0\">Logout</span>\r\n            </button>\r\n            \r\n            <button\r\n              className=\"w-full max-w-full min-w-0 inline-flex items-center justify-center gap-1.5 sm:gap-2 px-2 sm:px-3 md:px-4 py-2.5 sm:py-3 text-xs sm:text-sm font-semibold text-white bg-red-600 hover:bg-red-700 rounded-xl transition-all duration-300 border-2 border-red-600 hover:border-red-700 shadow-md hover:shadow-lg hover:scale-105 active:scale-95 box-border overflow-hidden\"\r\n              onClick={async () => {\r\n                const ok = confirm('Are you sure you want to delete your account? This is irreversible.');\r\n                if (!ok) return;\r\n                try {\r\n                  await api.delete('/api/account');\r\n                  // clear session and redirect\r\n                  try { await fetch(\"/api/auth/logout\", { method: \"POST\", credentials: \"include\" }); } catch {}\r\n                  alert('Account deleted');\r\n                  window.location.href = '/';\r\n                } catch (err: any) {\r\n                  console.error('Failed to delete account', err);\r\n                  alert('Could not delete account: ' + String(err?.message ?? err));\r\n                }\r\n              }}\r\n            >\r\n              <Trash2 className=\"h-3.5 w-3.5 sm:h-4 sm:w-4 flex-shrink-0\" />\r\n              <span className=\"truncate min-w-0\">Delete Account</span>\r\n            </button>\r\n          </div>\r\n        </section>\r\n\r\n        {/* Audit History Section */}\r\n        <section className=\"bg-white rounded-2xl shadow-lg border border-slate-200/60 p-4 sm:p-6 lg:p-8 w-full max-w-full overflow-hidden transition-all duration-300 hover:shadow-xl hover:border-slate-300/60 animate-in fade-in slide-in-from-bottom-4 box-border\">\r\n          <div className=\"flex items-center gap-3 mb-6 pb-4 border-b border-slate-100\">\r\n            <div className=\"h-11 w-11 rounded-xl bg-gradient-to-br from-purple-50 to-indigo-50 flex items-center justify-center transition-all duration-300 shadow-sm\">\r\n              <History className=\"w-5 h-5 text-purple-600\" />\r\n            </div>\r\n            <div>\r\n              <h2 className=\"text-lg sm:text-xl lg:text-2xl font-bold text-slate-900 tracking-tight\">Change History</h2>\r\n              <p className=\"text-xs sm:text-sm text-slate-500 mt-0.5\">Track all modifications to your profile and payout details</p>\r\n            </div>\r\n          </div>\r\n          \r\n          {loadingAudit ? (\r\n            <div className=\"text-center py-12\">\r\n              <div className=\"inline-flex items-center gap-2 text-sm text-slate-500\">\r\n                <div className=\"h-4 w-4 border-2 border-slate-300 border-t-transparent rounded-full animate-spin\"></div>\r\n                <span>Loading audit history...</span>\r\n              </div>\r\n            </div>\r\n          ) : auditHistory.length === 0 ? (\r\n            <div className=\"text-center py-12\">\r\n              <div className=\"h-16 w-16 rounded-full bg-gradient-to-br from-slate-50 to-slate-100 flex items-center justify-center mx-auto mb-4\">\r\n                <History className=\"h-8 w-8 text-slate-300\" />\r\n              </div>\r\n              <div className=\"text-sm font-medium text-slate-600 mb-1\">No changes recorded yet</div>\r\n              <div className=\"text-xs text-slate-400\">Your change history will appear here</div>\r\n            </div>\r\n          ) : (\r\n            <div>\r\n              <div className=\"space-y-3\">\r\n                {(showAllAuditHistory ? auditHistory : auditHistory.slice(0, 2)).map((log: any, index: number) => {\r\n                const impactStyles: Record<string, { badge: string; bg: string; text: string; border: string }> = {\r\n                  high: {\r\n                    badge: 'bg-gradient-to-r from-red-500 to-rose-600 text-white shadow-md shadow-red-500/20',\r\n                    bg: 'bg-gradient-to-br from-red-50/50 via-rose-50/30 to-red-50/50',\r\n                    text: 'text-red-700',\r\n                    border: 'border-red-200/60',\r\n                  },\r\n                  medium: {\r\n                    badge: 'bg-gradient-to-r from-amber-500 to-orange-500 text-white shadow-md shadow-amber-500/20',\r\n                    bg: 'bg-gradient-to-br from-amber-50/50 via-yellow-50/30 to-amber-50/50',\r\n                    text: 'text-amber-700',\r\n                    border: 'border-amber-200/60',\r\n                  },\r\n                  low: {\r\n                    badge: 'bg-gradient-to-r from-blue-500 to-indigo-500 text-white shadow-md shadow-blue-500/20',\r\n                    bg: 'bg-gradient-to-br from-blue-50/50 via-indigo-50/30 to-blue-50/50',\r\n                    text: 'text-blue-700',\r\n                    border: 'border-blue-200/60',\r\n                  },\r\n                };\r\n                const impactStyle = impactStyles[log.impactLevel] || impactStyles.low;\r\n                const date = new Date(log.createdAt);\r\n                const formattedDate = date.toLocaleString('en-US', {\r\n                  year: 'numeric',\r\n                  month: 'short',\r\n                  day: 'numeric',\r\n                  hour: '2-digit',\r\n                  minute: '2-digit',\r\n                  second: '2-digit',\r\n                });\r\n                \r\n                const fieldLabels: Record<string, string> = {\r\n                  bankAccountNumber: 'Account Number',\r\n                  mobileMoneyNumber: 'Mobile Money Number',\r\n                  bankName: 'Bank Name',\r\n                  bankAccountName: 'Account Name',\r\n                  bankBranch: 'Branch',\r\n                  mobileMoneyProvider: 'Provider',\r\n                  payoutPreferred: 'Preferred Method',\r\n                  fullName: 'Full Name',\r\n                  email: 'Email',\r\n                  phone: 'Phone',\r\n                  tin: 'TIN',\r\n                  address: 'Address',\r\n                };\r\n                \r\n                return (\r\n                  <div \r\n                    key={log.id} \r\n                    className={`group relative p-5 rounded-xl border ${impactStyle.border} ${impactStyle.bg} backdrop-blur-sm transition-all duration-300 hover:shadow-lg hover:scale-[1.01] hover:border-opacity-100 animate-in fade-in slide-in-from-bottom-2`}\r\n                  >\r\n                    {/* Decorative gradient overlay */}\r\n                    <div className=\"absolute inset-0 rounded-xl bg-gradient-to-br from-white/40 to-transparent pointer-events-none\"></div>\r\n                    \r\n                    <div className=\"relative\">\r\n                      {/* Header Row */}\r\n                      <div className=\"flex items-start justify-between gap-4 mb-4\">\r\n                        <div className=\"flex-1 min-w-0\">\r\n                          <div className=\"flex items-center gap-2.5 mb-2.5 flex-wrap\">\r\n                            <span className={`px-3 py-1.5 rounded-lg text-xs font-bold tracking-wide uppercase ${impactStyle.badge} shadow-sm`}>\r\n                              {log.impactLevel} Impact\r\n                            </span>\r\n                            <span className=\"text-xs font-medium text-slate-500 bg-white/60 px-2 py-1 rounded-md\">\r\n                              {log.impactScore} points\r\n                            </span>\r\n                          </div>\r\n                          <div className=\"flex items-center gap-2 mb-1.5\">\r\n                            {log.action === 'USER_PASSWORD_CHANGE' && <KeyRound className=\"h-4 w-4 text-amber-600 flex-shrink-0\" />}\r\n                            {log.action === 'USER_LOGIN' && <LogIn className=\"h-4 w-4 text-blue-600 flex-shrink-0\" />}\r\n                            {log.action === 'USER_LOGOUT' && <LogOut className=\"h-4 w-4 text-slate-600 flex-shrink-0\" />}\r\n                            {(log.action === 'USER_SESSION_REVOKE' || log.action === 'USER_SESSION_REVOKE_OTHERS') && <Shield className=\"h-4 w-4 text-purple-600 flex-shrink-0\" />}\r\n                            <h3 className=\"text-base font-bold text-slate-900 leading-tight\">\r\n                              {log.action === 'USER_PAYOUT_UPDATE' ? 'Payout Details Updated' : \r\n                               log.action === 'USER_PROFILE_UPDATE' ? 'Profile Updated' :\r\n                               log.action === 'USER_PASSWORD_CHANGE' ? 'Password Changed' :\r\n                               log.action === 'USER_LOGIN' ? 'Login' :\r\n                               log.action === 'USER_LOGOUT' ? 'Logout' :\r\n                               log.action === 'USER_SESSION_REVOKE' ? 'Session Revoked' :\r\n                               log.action === 'USER_SESSION_REVOKE_OTHERS' ? 'Other Sessions Revoked' :\r\n                               'Account Action'}\r\n                            </h3>\r\n                          </div>\r\n                        </div>\r\n                        <div className=\"flex items-center gap-1.5 text-xs font-medium text-slate-500 bg-white/70 px-2.5 py-1.5 rounded-lg flex-shrink-0 shadow-sm\">\r\n                          <Clock className=\"h-3.5 w-3.5\" />\r\n                          <span className=\"whitespace-nowrap\">{formattedDate}</span>\r\n                        </div>\r\n                      </div>\r\n                      \r\n                      {/* Changed Fields */}\r\n                      {log.changedFields && log.changedFields.length > 0 && (\r\n                        <div className=\"mb-3\">\r\n                          <div className=\"text-xs font-semibold text-slate-600 mb-2 uppercase tracking-wide\">Changed Fields</div>\r\n                          <div className=\"flex flex-wrap gap-2\">\r\n                            {log.changedFields.map((f: string, idx: number) => (\r\n                              <span \r\n                                key={idx}\r\n                                className=\"inline-flex items-center px-2.5 py-1 rounded-md text-xs font-medium bg-white/80 text-slate-700 border border-slate-200/60 shadow-sm hover:shadow-md transition-all duration-200 hover:scale-105\"\r\n                              >\r\n                                {fieldLabels[f] || f}\r\n                              </span>\r\n                            ))}\r\n                          </div>\r\n                        </div>\r\n                      )}\r\n                      \r\n                      {/* IP Address */}\r\n                      {log.ip && (\r\n                        <div className=\"flex items-center gap-1.5 text-xs text-slate-400 mt-3 pt-3 border-t border-slate-200/40\">\r\n                          <div className=\"h-1.5 w-1.5 rounded-full bg-slate-300\"></div>\r\n                          <span className=\"font-mono\">IP: {log.ip}</span>\r\n                        </div>\r\n                      )}\r\n                    </div>\r\n                  </div>\r\n                );\r\n                })}\r\n              </div>\r\n              \r\n              {/* View More/Less Button */}\r\n              {auditHistory.length > 2 && (\r\n                <div className=\"mt-4 pt-4 border-t border-slate-100\">\r\n                  <button\r\n                    onClick={() => setShowAllAuditHistory(!showAllAuditHistory)}\r\n                    className=\"w-full flex items-center justify-center gap-2 px-4 py-2.5 text-sm font-semibold text-slate-700 bg-slate-50 hover:bg-slate-100 rounded-xl transition-all duration-200 hover:scale-[1.02] active:scale-[0.98] border border-slate-200/60 shadow-sm hover:shadow\"\r\n                  >\r\n                    {showAllAuditHistory ? (\r\n                      <>\r\n                        <ChevronUp className=\"h-4 w-4\" />\r\n                        <span>Show Less</span>\r\n                      </>\r\n                    ) : (\r\n                      <>\r\n                        <ChevronDown className=\"h-4 w-4\" />\r\n                        <span>View More ({auditHistory.length - 2} more)</span>\r\n                      </>\r\n                    )}\r\n                  </button>\r\n                </div>\r\n              )}\r\n            </div>\r\n          )}\r\n        </section>\r\n      </div>\r\n\r\n      {/* Confirmation Dialog */}\r\n      {showConfirmDialog && (\r\n        <div \r\n          className=\"fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-in fade-in duration-200\" \r\n          onClick={() => setShowConfirmDialog(false)}\r\n        >\r\n          <div \r\n            className=\"bg-white rounded-2xl shadow-2xl border border-slate-200/60 max-w-md w-full p-6 animate-in zoom-in-95 slide-in-from-bottom-4 duration-300\" \r\n            onClick={(e) => e.stopPropagation()}\r\n          >\r\n            <div className=\"flex items-start gap-4 mb-5\">\r\n              <div className=\"h-12 w-12 rounded-xl bg-gradient-to-br from-amber-100 to-orange-100 flex items-center justify-center flex-shrink-0 shadow-lg shadow-amber-500/10\">\r\n                <AlertTriangle className=\"h-6 w-6 text-amber-600\" />\r\n              </div>\r\n              <div className=\"flex-1 min-w-0\">\r\n                <h3 className=\"text-lg font-bold text-slate-900 mb-1.5\">Confirm Sensitive Change</h3>\r\n                <p className=\"text-sm text-slate-600 leading-relaxed\">{confirmMessage}</p>\r\n              </div>\r\n            </div>\r\n            <div className=\"flex gap-3 pt-2\">\r\n              <button\r\n                onClick={() => {\r\n                  setShowConfirmDialog(false);\r\n                  setPendingSave(null);\r\n                  setConfirmMessage(\"\");\r\n                }}\r\n                className=\"flex-1 px-4 py-2.5 text-sm font-semibold text-slate-700 bg-slate-100 hover:bg-slate-200 rounded-xl transition-all duration-200 hover:scale-[1.02] active:scale-[0.98] shadow-sm hover:shadow\"\r\n              >\r\n                Cancel\r\n              </button>\r\n              <button\r\n                onClick={async () => {\r\n                  setShowConfirmDialog(false);\r\n                  if (pendingSave) {\r\n                    await pendingSave();\r\n                  }\r\n                  setPendingSave(null);\r\n                  setConfirmMessage(\"\");\r\n                }}\r\n                className=\"flex-1 px-4 py-2.5 text-sm font-semibold text-white bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-700 hover:to-teal-700 rounded-xl transition-all duration-200 hover:scale-[1.02] active:scale-[0.98] shadow-md hover:shadow-lg shadow-emerald-500/20\"\r\n              >\r\n                Confirm & Save\r\n              </button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(owner)\\owner\\properties\\[id]\\availability\\manage\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(owner)\\owner\\properties\\[id]\\availability\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(owner)\\owner\\properties\\[id]\\layout\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(owner)\\owner\\properties\\add\\_components\\AddPropertySection.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(owner)\\owner\\properties\\add\\_components\\BasicsStep.tsx","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'PROPERTY_TYPE_STYLES' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":129,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":129,"endColumn":23,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(owner)\\owner\\properties\\add\\_components\\PhotosStep.tsx","messages":[],"suppressedMessages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":287,"column":25,"nodeType":"JSXOpeningElement","endLine":287,"endColumn":119,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(owner)\\owner\\properties\\add\\_components\\PropertyReviewDisplay.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(owner)\\owner\\properties\\add\\_components\\PropertyVisualizationPreview.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(owner)\\owner\\properties\\add\\_components\\ResumeDraftScreen.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(owner)\\owner\\properties\\add\\_components\\ReviewStep.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(owner)\\owner\\properties\\add\\_components\\RoomsStep.tsx","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'setDefinedRooms' is defined but never used. Allowed unused args must match /^_|^(e|err)$/u.","line":57,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":57,"endColumn":18,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":1125,"column":41,"nodeType":"JSXOpeningElement","endLine":1129,"endColumn":43,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(owner)\\owner\\properties\\add\\_components\\ServicesStep.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(owner)\\owner\\properties\\add\\_components\\StepFooter.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(owner)\\owner\\properties\\add\\_components\\StepHeader.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(owner)\\owner\\properties\\add\\_components\\TotalsStep.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(owner)\\owner\\properties\\add\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(owner)\\owner\\properties\\approved\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(owner)\\owner\\properties\\availability\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'totalFloors' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":119,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":119,"endColumn":20}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useEffect, useMemo, useState } from \"react\";\r\nimport axios from \"axios\";\r\nimport Link from \"next/link\";\r\nimport { \r\n  CalendarDays, \r\n  Loader2, \r\n  AlertCircle,\r\n  ChevronRight,\r\n  MapPin,\r\n  Building2,\r\n  BedDouble,\r\n  Layers,\r\n  Sparkles,\r\n} from \"lucide-react\";\r\n\r\nconst api = axios.create({ baseURL: \"\", withCredentials: true });\r\n\r\ntype Property = {\r\n  id: number;\r\n  title: string;\r\n  photos?: string[];\r\n  regionName?: string | null;\r\n  district?: string | null;\r\n  city?: string | null;\r\n  type?: string | null;\r\n  status: string;\r\n  roomsSpec?: any;\r\n  layout?: any;\r\n  totalFloors?: number | null;\r\n  buildingType?: string | null;\r\n};\r\n\r\ntype FloorInfo = {\r\n  floorNumber: number;\r\n  floorLabel: string;\r\n  roomTypes: Array<{\r\n    roomType: string;\r\n    roomsCount: number;\r\n    beds?: any;\r\n  }>;\r\n  totalRooms: number;\r\n};\r\n\r\ntype SummaryPeriod = \"today\" | \"week\" | \"month\";\r\n\r\ntype AvailabilitySummary = {\r\n  totalRooms: number;\r\n  totalBookedRooms: number;\r\n  totalBlockedRooms: number;\r\n  totalAvailableRooms: number;\r\n  overallAvailabilityPercentage: number;\r\n};\r\n\r\ntype PeriodRange = { startDate: string; endDate: string };\r\n\r\nfunction toIsoDateTime(d: Date): string {\r\n  return d.toISOString();\r\n}\r\n\r\nfunction startOfDay(d: Date): Date {\r\n  const x = new Date(d);\r\n  x.setHours(0, 0, 0, 0);\r\n  return x;\r\n}\r\n\r\nfunction startOfWeekMonday(d: Date): Date {\r\n  const x = startOfDay(d);\r\n  const day = x.getDay(); // 0=Sun\r\n  const diff = (day + 6) % 7; // days since Monday\r\n  x.setDate(x.getDate() - diff);\r\n  return x;\r\n}\r\n\r\nfunction startOfMonth(d: Date): Date {\r\n  const x = startOfDay(d);\r\n  x.setDate(1);\r\n  return x;\r\n}\r\n\r\nfunction addDays(d: Date, days: number): Date {\r\n  const x = new Date(d);\r\n  x.setDate(x.getDate() + days);\r\n  return x;\r\n}\r\n\r\nfunction addMonths(d: Date, months: number): Date {\r\n  const x = new Date(d);\r\n  x.setMonth(x.getMonth() + months);\r\n  return x;\r\n}\r\n\r\n// Helper to get floor label\r\nfunction getFloorLabel(floorNum: number): string {\r\n  if (floorNum === 0) return \"Ground Floor\";\r\n  const mod100 = floorNum % 100;\r\n  const mod10 = floorNum % 10;\r\n  const suffix = mod100 >= 11 && mod100 <= 13 ? \"th\" : mod10 === 1 ? \"st\" : mod10 === 2 ? \"nd\" : mod10 === 3 ? \"rd\" : \"th\";\r\n  return `${floorNum}${suffix} Floor`;\r\n}\r\n\r\n// Extract building structure from roomsSpec\r\nfunction extractBuildingStructure(property: Property): FloorInfo[] {\r\n  const floors: FloorInfo[] = [];\r\n  \r\n  if (!property.roomsSpec) {\r\n    // Fallback: create a single floor with all rooms\r\n    return [{\r\n      floorNumber: 0,\r\n      floorLabel: \"Ground Floor\",\r\n      roomTypes: [],\r\n      totalRooms: 0,\r\n    }];\r\n  }\r\n\r\n  const roomsSpec = Array.isArray(property.roomsSpec) ? property.roomsSpec : [];\r\n  const isMultiStorey = property.buildingType === \"multi_storey\";\r\n  const totalFloors = property.totalFloors || 1;\r\n\r\n  // Group rooms by floor\r\n  const floorMap = new Map<number, Map<string, { roomType: string; roomsCount: number; beds?: any }>>();\r\n\r\n  roomsSpec.forEach((room: any) => {\r\n    const roomType = String(room?.roomType || room?.name || \"Room\").trim();\r\n    const roomsCount = Number(room?.roomsCount || room?.count || 0);\r\n    \r\n    if (roomsCount === 0) return;\r\n\r\n    // Parse floor distribution\r\n    let floorDistribution: Record<number, number> = {};\r\n    if (isMultiStorey && room.floorDistribution) {\r\n      if (typeof room.floorDistribution === \"string\") {\r\n        try {\r\n          floorDistribution = JSON.parse(room.floorDistribution);\r\n        } catch {\r\n          floorDistribution = {};\r\n        }\r\n      } else if (typeof room.floorDistribution === \"object\" && room.floorDistribution !== null) {\r\n        floorDistribution = room.floorDistribution;\r\n      }\r\n    }\r\n\r\n    // If no floor distribution, default to ground floor (0)\r\n    const floorsToUse = Object.keys(floorDistribution).length > 0 \r\n      ? Object.keys(floorDistribution).map(Number)\r\n      : [0];\r\n\r\n    floorsToUse.forEach((floorNum) => {\r\n      const countOnFloor = floorDistribution[floorNum] || roomsCount;\r\n      \r\n      if (!floorMap.has(floorNum)) {\r\n        floorMap.set(floorNum, new Map());\r\n      }\r\n      \r\n      const roomTypeMap = floorMap.get(floorNum)!;\r\n      const existing = roomTypeMap.get(roomType);\r\n      \r\n      if (existing) {\r\n        existing.roomsCount += countOnFloor;\r\n      } else {\r\n        roomTypeMap.set(roomType, {\r\n          roomType,\r\n          roomsCount: countOnFloor,\r\n          beds: room.beds,\r\n        });\r\n      }\r\n    });\r\n  });\r\n\r\n  // Convert to FloorInfo array\r\n  const floorNumbers = Array.from(floorMap.keys()).sort((a, b) => a - b);\r\n  \r\n  if (floorNumbers.length === 0) {\r\n    // No floor data, create default\r\n    return [{\r\n      floorNumber: 0,\r\n      floorLabel: \"Ground Floor\",\r\n      roomTypes: roomsSpec.map((r: any) => ({\r\n        roomType: String(r?.roomType || r?.name || \"Room\"),\r\n        roomsCount: Number(r?.roomsCount || r?.count || 0),\r\n        beds: r?.beds,\r\n      })).filter((rt: any) => rt.roomsCount > 0),\r\n      totalRooms: roomsSpec.reduce((sum: number, r: any) => sum + Number(r?.roomsCount || r?.count || 0), 0),\r\n    }];\r\n  }\r\n\r\n  floorNumbers.forEach((floorNum) => {\r\n    const roomTypeMap = floorMap.get(floorNum)!;\r\n    const roomTypes = Array.from(roomTypeMap.values());\r\n    const totalRooms = roomTypes.reduce((sum, rt) => sum + rt.roomsCount, 0);\r\n\r\n    floors.push({\r\n      floorNumber: floorNum,\r\n      floorLabel: getFloorLabel(floorNum),\r\n      roomTypes,\r\n      totalRooms,\r\n    });\r\n  });\r\n\r\n  return floors;\r\n}\r\n\r\nexport default function PropertyAvailabilitySelectionPage() {\r\n  const [properties, setProperties] = useState<Property[]>([]);\r\n  const [loading, setLoading] = useState(true);\r\n  const [error, setError] = useState<string | null>(null);\r\n\r\n  const ranges = useMemo<Record<SummaryPeriod, PeriodRange>>(() => {\r\n    const now = new Date();\r\n    const todayStart = startOfDay(now);\r\n    const weekStart = startOfWeekMonday(now);\r\n    const monthStart = startOfMonth(now);\r\n\r\n    return {\r\n      today: { startDate: toIsoDateTime(todayStart), endDate: toIsoDateTime(addDays(todayStart, 1)) },\r\n      week: { startDate: toIsoDateTime(weekStart), endDate: toIsoDateTime(addDays(weekStart, 7)) },\r\n      month: { startDate: toIsoDateTime(monthStart), endDate: toIsoDateTime(addMonths(monthStart, 1)) },\r\n    };\r\n  }, []);\r\n\r\n  const [availabilityByPropertyId, setAvailabilityByPropertyId] = useState<\r\n    Record<number, Partial<Record<SummaryPeriod, AvailabilitySummary>>>\r\n  >({});\r\n  const [availabilityLoadingByPropertyId, setAvailabilityLoadingByPropertyId] = useState<\r\n    Record<number, Partial<Record<SummaryPeriod, boolean>>>\r\n  >({});\r\n\r\n  useEffect(() => {\r\n    let mounted = true;\r\n\r\n      api.get<any>(\"/api/owner/properties/mine\", { params: { status: \"APPROVED\" } })\r\n      .then((r) => {\r\n        if (!mounted) return;\r\n        const data = r.data;\r\n        const propertiesList = Array.isArray(data) ? data : (data?.items || []);\r\n        setProperties(propertiesList);\r\n      })\r\n      .catch((err) => {\r\n        if (!mounted) return;\r\n        setError(err?.response?.data?.error || \"Failed to load properties\");\r\n      })\r\n      .finally(() => {\r\n        if (mounted) setLoading(false);\r\n      });\r\n\r\n    return () => {\r\n      mounted = false;\r\n    };\r\n  }, []);\r\n\r\n  // Fetch lightweight availability summaries for Today / This Week / This Month.\r\n  useEffect(() => {\r\n    if (!properties.length) return;\r\n\r\n    let cancelled = false;\r\n\r\n    const periods: SummaryPeriod[] = [\"today\", \"week\", \"month\"];\r\n\r\n    const fetchOne = async (propertyId: number, period: SummaryPeriod) => {\r\n      setAvailabilityLoadingByPropertyId((prev) => ({\r\n        ...prev,\r\n        [propertyId]: { ...prev[propertyId], [period]: true },\r\n      }));\r\n      try {\r\n        const r = await api.get<any>(\"/api/owner/availability/summary\", {\r\n          params: { propertyId, ...ranges[period] },\r\n        });\r\n        const s = r?.data?.summary;\r\n        if (!s || cancelled) return;\r\n        setAvailabilityByPropertyId((prev) => ({\r\n          ...prev,\r\n          [propertyId]: { ...prev[propertyId], [period]: s },\r\n        }));\r\n      } catch {\r\n        // ignore - card will show placeholder values\r\n      } finally {\r\n        if (!cancelled) {\r\n          setAvailabilityLoadingByPropertyId((prev) => ({\r\n            ...prev,\r\n            [propertyId]: { ...prev[propertyId], [period]: false },\r\n          }));\r\n        }\r\n      }\r\n    };\r\n\r\n    for (const p of properties) {\r\n      for (const period of periods) fetchOne(p.id, period);\r\n    }\r\n\r\n    return () => {\r\n      cancelled = true;\r\n    };\r\n  }, [properties, ranges]);\r\n\r\n  if (loading) {\r\n    return (\r\n      <div className=\"min-h-screen bg-gradient-to-b from-white via-slate-50 to-white\">\r\n        <div className=\"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10\">\r\n          <div className=\"flex items-center justify-between mb-10\">\r\n            <div>\r\n              <div className=\"h-4 w-44 rounded-full bg-slate-200/70 animate-pulse\" />\r\n              <div className=\"mt-3 h-9 w-72 rounded-xl bg-slate-200/70 animate-pulse\" />\r\n              <div className=\"mt-3 h-4 w-64 rounded-full bg-slate-200/60 animate-pulse\" />\r\n            </div>\r\n            <div className=\"h-10 w-28 rounded-xl bg-slate-200/70 animate-pulse\" />\r\n          </div>\r\n\r\n          <div className=\"grid grid-cols-1 xl:grid-cols-2 gap-6\">\r\n            {Array.from({ length: 4 }).map((_, i) => (\r\n              <div key={i} className=\"rounded-3xl border border-slate-200 bg-white/70 shadow-sm overflow-hidden\">\r\n                <div className=\"h-28 bg-gradient-to-r from-slate-100 to-slate-50\" />\r\n                <div className=\"p-6\">\r\n                  <div className=\"h-5 w-56 rounded bg-slate-200/70 animate-pulse\" />\r\n                  <div className=\"mt-3 h-4 w-72 rounded bg-slate-200/60 animate-pulse\" />\r\n                  <div className=\"mt-6 space-y-3\">\r\n                    <div className=\"h-20 rounded-2xl bg-slate-100 border border-slate-200\" />\r\n                    <div className=\"h-20 rounded-2xl bg-slate-100 border border-slate-200\" />\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            ))}\r\n          </div>\r\n\r\n          <div className=\"mt-10 flex items-center justify-center gap-3 text-sm text-slate-500\">\r\n            <Loader2 className=\"w-4 h-4 animate-spin\" />\r\n            <span>Loading your approved properties…</span>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  if (error) {\r\n    return (\r\n      <div className=\"min-h-screen bg-gradient-to-b from-white via-slate-50 to-white\">\r\n        <div className=\"max-w-xl mx-auto px-4 py-16\">\r\n          <div className=\"rounded-3xl border border-slate-200 bg-white shadow-sm p-8\">\r\n            <div className=\"w-12 h-12 rounded-2xl bg-rose-50 flex items-center justify-center mb-5\">\r\n              <AlertCircle className=\"w-6 h-6 text-rose-600\" />\r\n            </div>\r\n            <h1 className=\"text-xl font-semibold text-slate-900\">Couldn’t load properties</h1>\r\n            <p className=\"mt-2 text-sm text-slate-600\">{error}</p>\r\n            <div className=\"mt-6 flex items-center gap-3\">\r\n              <Link\r\n                href=\"/owner/properties/approved\"\r\n                className=\"no-underline inline-flex items-center justify-center gap-2 px-4 py-2.5 rounded-xl bg-slate-900 text-white text-sm font-semibold hover:bg-slate-800 transition-colors\"\r\n              >\r\n                <ChevronRight className=\"w-4 h-4 rotate-180\" />\r\n                <span>Back to Properties</span>\r\n              </Link>\r\n              <button\r\n                type=\"button\"\r\n                onClick={() => window.location.reload()}\r\n                className=\"inline-flex items-center justify-center px-4 py-2.5 rounded-xl border border-slate-200 bg-white text-sm font-semibold text-slate-700 hover:bg-slate-50 transition-colors\"\r\n              >\r\n                Retry\r\n              </button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  if (properties.length === 0) {\r\n    return (\r\n      <div className=\"min-h-screen bg-gradient-to-b from-white via-slate-50 to-white\">\r\n        <div className=\"max-w-xl mx-auto px-4 py-16\">\r\n          <div className=\"rounded-3xl border border-slate-200 bg-white shadow-sm p-8\">\r\n            <div className=\"w-12 h-12 rounded-2xl bg-emerald-50 flex items-center justify-center mb-5\">\r\n              <CalendarDays className=\"w-6 h-6 text-emerald-600\" />\r\n            </div>\r\n            <h1 className=\"text-xl font-semibold text-slate-900\">No approved properties yet</h1>\r\n            <p className=\"mt-2 text-sm text-slate-600\">\r\n              You need at least one approved property before you can manage room availability.\r\n            </p>\r\n            <div className=\"mt-6\">\r\n              <Link\r\n                href=\"/owner/properties/add\"\r\n                className=\"no-underline inline-flex items-center justify-center gap-2 px-4 py-2.5 rounded-xl bg-emerald-600 text-white text-sm font-semibold hover:bg-emerald-700 transition-colors\"\r\n              >\r\n                <Sparkles className=\"w-4 h-4\" />\r\n                <span>Add New Property</span>\r\n              </Link>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-gradient-to-b from-white via-slate-50/60 to-white\">\r\n      <div className=\"pointer-events-none fixed inset-0 -z-10\">\r\n        <div className=\"absolute -top-24 left-1/2 h-72 w-[900px] -translate-x-1/2 rounded-full bg-gradient-to-r from-emerald-200/25 via-sky-200/20 to-purple-200/20 blur-3xl\" />\r\n      </div>\r\n      <div className=\"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10\">\r\n        {/* Header */}\r\n        <div className=\"mb-10\">\r\n          <nav className=\"mb-6 flex items-center justify-between\">\r\n            <Link\r\n              href=\"/owner/properties/approved\"\r\n              className=\"no-underline inline-flex items-center gap-2 text-sm font-medium text-slate-500 hover:text-emerald-600 transition-colors\"\r\n            >\r\n              <ChevronRight className=\"w-4 h-4 rotate-180\" />\r\n              <span>Properties</span>\r\n            </Link>\r\n            <span className=\"inline-flex items-center rounded-full border border-slate-200 bg-white/70 px-3 py-1 text-xs font-semibold text-slate-600 shadow-sm\">\r\n              {properties.length} {properties.length === 1 ? \"property\" : \"properties\"}\r\n            </span>\r\n          </nav>\r\n          <div className=\"flex flex-col items-center text-center gap-4\">\r\n            <div className=\"w-11 h-11 rounded-2xl bg-gradient-to-br from-emerald-600 to-emerald-500 flex items-center justify-center shadow-sm ring-1 ring-black/5\">\r\n              <CalendarDays className=\"w-5 h-5 text-white\" />\r\n            </div>\r\n            <div className=\"min-w-0\">\r\n              <h1 className=\"text-3xl font-semibold tracking-tight text-slate-900\">Room Availability</h1>\r\n              <p className=\"mt-1 text-sm text-slate-600\">Manage room availability for your properties</p>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Properties Grid - Premium Clean Design */}\r\n        <div className=\"grid grid-cols-1 xl:grid-cols-2 gap-6\">\r\n          {properties.map((property) => {\r\n            const buildingStructure = extractBuildingStructure(property);\r\n            const location = [property.city, property.district, property.regionName]\r\n              .filter(Boolean)\r\n              .join(\", \") || \"Location not specified\";\r\n            \r\n            const totalRooms = buildingStructure.reduce((sum, floor) => sum + floor.totalRooms, 0);\r\n            const cover = Array.isArray(property.photos) && property.photos.length > 0 ? property.photos[0] : null;\r\n\r\n            const availability = availabilityByPropertyId[property.id];\r\n            const loading = availabilityLoadingByPropertyId[property.id];\r\n\r\n            const fmt = (value: number | undefined, isLoading?: boolean) => {\r\n              if (typeof value === \"number\") return value;\r\n              if (isLoading) return \"…\";\r\n              return \"—\";\r\n            };\r\n\r\n            const bookedToday = availability?.today?.totalBookedRooms;\r\n            const bookedWeek = availability?.week?.totalBookedRooms;\r\n            const bookedMonth = availability?.month?.totalBookedRooms;\r\n            const blockedToday = availability?.today?.totalBlockedRooms;\r\n            const blockedWeek = availability?.week?.totalBlockedRooms;\r\n            const blockedMonth = availability?.month?.totalBlockedRooms;\r\n\r\n            const Stat = ({ label, value }: { label: string; value: string }) => (\r\n              <div className=\"rounded-2xl border border-slate-200 bg-white/70 px-4 py-3 shadow-[0_1px_0_rgba(15,23,42,0.04)] ring-1 ring-black/5\">\r\n                <div className=\"text-[10px] font-bold uppercase tracking-wider text-slate-500\">{label}</div>\r\n                <div className=\"mt-1 text-base font-semibold text-slate-900\">{value}</div>\r\n              </div>\r\n            );\r\n\r\n            return (\r\n              <Link\r\n                key={property.id}\r\n                href={`/owner/properties/${property.id}/availability/manage`}\r\n                className=\"no-underline group block\"\r\n              >\r\n                <div className=\"relative bg-white/80 backdrop-blur-sm rounded-3xl border border-slate-200 shadow-sm hover:shadow-xl hover:-translate-y-0.5 hover:border-emerald-200 transition-all duration-300 overflow-hidden\">\r\n                  <div className=\"absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity duration-300\">\r\n                    <div className=\"absolute -top-24 -right-24 h-56 w-56 rounded-full bg-emerald-200/20 blur-3xl\" />\r\n                  </div>\r\n\r\n                  {/* Cover */}\r\n                  <div className=\"relative h-28\">\r\n                    {cover ? (\r\n                      <div\r\n                        className=\"absolute inset-0 bg-cover bg-center\"\r\n                        style={{ backgroundImage: `url(${cover})` }}\r\n                      />\r\n                    ) : (\r\n                      <div className=\"absolute inset-0 bg-gradient-to-r from-slate-100 via-white to-slate-50\" />\r\n                    )}\r\n                    <div className=\"absolute inset-0 bg-gradient-to-t from-white via-white/40 to-transparent\" />\r\n                    <div className=\"absolute left-6 bottom-4 right-6 flex items-center justify-between\">\r\n                      <div className=\"flex items-center gap-2 min-w-0\">\r\n                        <div className=\"w-9 h-9 rounded-2xl bg-white/80 backdrop-blur border border-white/60 shadow-sm flex items-center justify-center\">\r\n                          <Building2 className=\"w-4 h-4 text-slate-700\" />\r\n                        </div>\r\n                        <div className=\"min-w-0\">\r\n                          <h3 className=\"text-base font-semibold text-slate-900 truncate group-hover:text-emerald-700 transition-colors\">\r\n                            {property.title}\r\n                          </h3>\r\n                          <div className=\"flex items-center gap-1.5 mt-0.5 min-w-0\">\r\n                            <MapPin className=\"w-3.5 h-3.5 text-slate-400 flex-shrink-0\" />\r\n                            <span className=\"text-xs text-slate-600 truncate\">{location}</span>\r\n                          </div>\r\n                        </div>\r\n                      </div>\r\n                      <div className=\"flex items-center gap-2 flex-shrink-0\">\r\n                        <span className=\"px-2.5 py-1 text-[10px] font-bold uppercase tracking-wider bg-emerald-100/80 text-emerald-800 rounded-full border border-emerald-200/70 shadow-sm\">\r\n                          {property.status}\r\n                        </span>\r\n                        <span className=\"inline-flex items-center gap-1.5 rounded-full border border-white/60 bg-white/80 backdrop-blur px-2.5 py-1 text-[10px] font-bold tracking-wider text-slate-800 shadow-sm\">\r\n                          <BedDouble className=\"w-3.5 h-3.5 text-slate-600\" aria-hidden />\r\n                          <span>{totalRooms}</span>\r\n                        </span>\r\n                      </div>\r\n                    </div>\r\n                  </div>\r\n\r\n                  {/* Content (compact premium summary) */}\r\n                  <div className=\"px-6 pb-6 pt-4\">\r\n                    <div className=\"flex items-center gap-2\">\r\n                      <div className=\"w-8 h-8 rounded-xl bg-emerald-50 flex items-center justify-center border border-emerald-100\">\r\n                        <Layers className=\"w-4 h-4 text-emerald-600\" />\r\n                      </div>\r\n                      <h4 className=\"text-xs font-semibold text-slate-700 uppercase tracking-wider\">At a glance</h4>\r\n                      <span className=\"ml-auto text-[11px] font-semibold text-slate-500\">Today · Week · Month</span>\r\n                    </div>\r\n\r\n                    <div className=\"mt-4 grid grid-cols-2 gap-3\">\r\n                      <Stat label=\"Floors\" value={String(buildingStructure.length)} />\r\n                      <Stat label=\"Rooms\" value={String(totalRooms)} />\r\n                    </div>\r\n\r\n                    <div className=\"mt-4 rounded-2xl border border-slate-200/70 bg-white/70 overflow-hidden\">\r\n                      <div className=\"grid grid-cols-4 gap-2 px-3 py-2 border-b border-slate-200/60 bg-gradient-to-r from-slate-50 to-white text-[10px] font-bold uppercase tracking-wider text-slate-500\">\r\n                        <span className=\"text-left\"> </span>\r\n                        <span className=\"text-right\">Today</span>\r\n                        <span className=\"text-right\">Week</span>\r\n                        <span className=\"text-right\">Month</span>\r\n                      </div>\r\n\r\n                      <div className=\"grid grid-cols-4 gap-2 px-3 py-2 text-sm\">\r\n                        <span className=\"text-xs font-semibold text-slate-700\">NoLSAF booked</span>\r\n                        <span className=\"text-right font-semibold text-emerald-700 tabular-nums\">{fmt(bookedToday, loading?.today)}</span>\r\n                        <span className=\"text-right font-semibold text-emerald-700 tabular-nums\">{fmt(bookedWeek, loading?.week)}</span>\r\n                        <span className=\"text-right font-semibold text-emerald-700 tabular-nums\">{fmt(bookedMonth, loading?.month)}</span>\r\n                      </div>\r\n\r\n                      <div className=\"grid grid-cols-4 gap-2 px-3 py-2 border-t border-slate-200/50 text-sm\">\r\n                        <span className=\"text-xs font-semibold text-slate-700\">Outside blocked</span>\r\n                        <span className=\"text-right font-semibold text-slate-800 tabular-nums\">{fmt(blockedToday, loading?.today)}</span>\r\n                        <span className=\"text-right font-semibold text-slate-800 tabular-nums\">{fmt(blockedWeek, loading?.week)}</span>\r\n                        <span className=\"text-right font-semibold text-slate-800 tabular-nums\">{fmt(blockedMonth, loading?.month)}</span>\r\n                      </div>\r\n                    </div>\r\n\r\n                    <div className=\"mt-5 flex items-center justify-between\">\r\n                      <div className=\"text-xs text-slate-500\">\r\n                        <span className=\"font-semibold text-slate-700\">Tip:</span> Keep calendars accurate.\r\n                      </div>\r\n                      <div className=\"inline-flex items-center gap-1.5 text-sm font-semibold text-emerald-700 group-hover:text-emerald-800 transition-colors\">\r\n                        <span>Manage</span>\r\n                        <ChevronRight className=\"w-4 h-4 group-hover:translate-x-0.5 transition-transform\" />\r\n                      </div>\r\n                    </div>\r\n                  </div>\r\n\r\n                  {/* old layout retained below removed */}\r\n\r\n                  {/* Property Title Bar */}\r\n                  <div className=\"hidden px-6 py-4 border-b border-slate-100 bg-gradient-to-r from-slate-50 to-white\">\r\n                    <div className=\"flex items-center justify-between\">\r\n                      <div className=\"flex-1 min-w-0 pr-4\">\r\n                        <h3 className=\"text-lg font-bold text-slate-900 truncate group-hover:text-emerald-600 transition-colors\">\r\n                          {property.title}\r\n                        </h3>\r\n                        <div className=\"flex items-center gap-1.5 mt-1\">\r\n                          <MapPin className=\"w-3.5 h-3.5 text-slate-400 flex-shrink-0\" />\r\n                          <span className=\"text-xs text-slate-500 truncate\">{location}</span>\r\n                        </div>\r\n                      </div>\r\n                      <span className=\"px-2.5 py-1 text-[10px] font-bold uppercase tracking-wider bg-emerald-100 text-emerald-700 rounded-md flex-shrink-0\">\r\n                        {property.status}\r\n                      </span>\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n              </Link>\r\n            );\r\n          })}\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(owner)\\owner\\properties\\pending\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(owner)\\owner\\property-owner-disbursement-policy\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(owner)\\owner\\reports\\bookings\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(owner)\\owner\\reports\\customers\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(owner)\\owner\\reports\\layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(owner)\\owner\\reports\\occupancy\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(owner)\\owner\\reports\\overview\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(owner)\\owner\\reports\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(owner)\\owner\\reports\\revenue\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(owner)\\owner\\reports\\stays\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(owner)\\owner\\revenue\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(owner)\\owner\\revenue\\paid\\page.tsx","messages":[],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'load'. Either include it or remove the dependency array.","line":66,"column":6,"nodeType":"ArrayExpression","endLine":66,"endColumn":15,"suggestions":[{"desc":"Update the dependencies array to be: [filters, load]","fix":{"range":[2068,2077],"text":"[filters, load]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(owner)\\owner\\revenue\\receipts\\[id]\\page.tsx","messages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":55,"column":11,"nodeType":"JSXOpeningElement","endLine":59,"endColumn":5}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\nimport { useEffect, useState } from \"react\";\r\nimport axios from \"axios\";\r\nimport { useParams } from \"next/navigation\";\r\n// Use same-origin calls + secure httpOnly cookie session.\r\nconst api = axios.create({ baseURL: \"\", withCredentials: true });\r\n\r\nexport default function Receipt() {\r\n  const routeParams = useParams<{ id?: string | string[] }>();\r\n  const idParam = Array.isArray(routeParams?.id) ? routeParams?.id?.[0] : routeParams?.id;\r\n  const [data, setData] = useState<any>(null);\r\n  useEffect(() => {\r\n    api.get(`/api/owner/revenue/invoices/${idParam}/receipt`).then(r => setData(r.data));\r\n  }, [idParam]);\r\n\r\n  if (!data) return <div>Loading...</div>;\r\n  const { invoice: inv, qrPayload } = data;\r\n  const codeVisible = inv?.booking?.code?.codeVisible ?? inv?.booking?.code?.code ?? \"-\";\r\n\r\n  return (\r\n    <div className=\"space-y-4\">\r\n      <div className=\"flex items-center justify-between\">\r\n        <h1 className=\"text-2xl font-semibold\">Receipt {inv.receiptNumber}</h1>\r\n        <span className=\"text-xs px-2 py-1 rounded border bg-green-100 text-green-700 border-green-300\">PAID</span>\r\n      </div>\r\n\r\n      <div className=\"rounded-xl overflow-hidden border border-brand-primary/30\">\r\n        <div className=\"bg-brand-primary text-white px-3 py-2 text-sm font-medium\">{inv.title}</div>\r\n        <div className=\"grid md:grid-cols-2 border-b\">\r\n          <Party title=\"Sender (Owner)\">\r\n            <p className=\"text-sm\">{inv.senderName}</p>\r\n            <p className=\"text-sm\">{inv.senderPhone ?? \"\"}</p>\r\n            <p className=\"text-sm\">{inv.senderAddress ?? \"\"}</p>\r\n          </Party>\r\n          <Party title=\"Receiver (NoLSAF)\">\r\n            <p className=\"text-sm\">{inv.receiverName}</p>\r\n            <p className=\"text-sm\">{inv.receiverPhone ?? \"\"}</p>\r\n            <p className=\"text-sm\">{inv.receiverAddress ?? \"\"}</p>\r\n          </Party>\r\n        </div>\r\n\r\n        <div className=\"divide-y\">\r\n          <Row cols={[\"Owner payout\", `TZS ${inv.total}`]} />\r\n          <Row cols={[\"Payment Ref\", inv.paymentRef ?? \"-\"]} />\r\n          <Row cols={[\"Paid On\", new Date(inv.paidAt).toLocaleString()]} />\r\n          <Row cols={[\"NoLSAF Code\", codeVisible]} />\r\n        </div>\r\n\r\n        <div className=\"p-3\">\r\n          <div className=\"text-sm font-semibold mb-1\">Receipt QR Payload</div>\r\n          <pre className=\"p-3 bg-neutral-100 rounded-xl text-xs overflow-auto\">{JSON.stringify(qrPayload, null, 2)}</pre>\r\n        </div>\r\n        <div className=\"p-3\">\r\n          <div className=\"text-sm font-semibold mb-2\">Receipt QR</div>\r\n          <img\r\n            src={`/api/owner/revenue/invoices/${inv.id}/receipt/qr.png`}\r\n            alt=\"Receipt QR\"\r\n    className=\"w-40 h-40 border rounded-xl\"\r\n  />\r\n  <div className=\"text-xs opacity-70 mt-2\">Scan to verify receipt.</div>\r\n</div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\nfunction Party({ title, children }: any) {\r\n  return (\r\n    <div className=\"p-3\">\r\n      <div className=\"text-sm font-semibold mb-2\">{title}</div>\r\n      <div className=\"space-y-1\">{children}</div>\r\n    </div>\r\n  );\r\n}\r\nfunction Row({ cols }:{ cols:[string,string]}) {\r\n  return (\r\n    <div className=\"grid grid-cols-2\">\r\n      <div className=\"px-3 py-2 text-sm bg-neutral-50 border-r\">{cols[0]}</div>\r\n      <div className=\"px-3 py-2 text-sm\">{cols[1]}</div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(owner)\\owner\\revenue\\rejected\\page.tsx","messages":[],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'load'. Either include it or remove the dependency array.","line":70,"column":6,"nodeType":"ArrayExpression","endLine":70,"endColumn":15,"suggestions":[{"desc":"Update the dependencies array to be: [filters, load]","fix":{"range":[2157,2166],"text":"[filters, load]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(owner)\\owner\\revenue\\requested\\page.tsx","messages":[],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'load'. Either include it or remove the dependency array.","line":71,"column":6,"nodeType":"ArrayExpression","endLine":71,"endColumn":15,"suggestions":[{"desc":"Update the dependencies array to be: [filters, load]","fix":{"range":[2237,2246],"text":"[filters, load]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(owner)\\owner\\settings\\2fa\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'router' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":32,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":32,"endColumn":15}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport React, { useState, useEffect, useRef } from \"react\"\r\nimport Link from \"next/link\"\r\nimport Image from \"next/image\"\r\nimport { ChevronLeft, Smartphone, CheckCircle, XCircle, MessageSquare } from 'lucide-react'\r\nimport { useRouter } from 'next/navigation'\r\nimport axios from \"axios\"\r\n\r\nconst api = axios.create({ baseURL: \"\", withCredentials: true })\r\n\r\ntype Status = { totpEnabled: boolean; smsEnabled: boolean; phone?: string | null }\r\n\r\nexport default function Owner2FAPage() {\r\n  const [me, setMe] = useState<any>(null)\r\n  const [status, setStatus] = useState<Status | null>(null)\r\n  const [twofa, setTwofa] = useState<any>(null)\r\n  const [code, setCode] = useState(\"\")\r\n  const [smsCode, setSmsCode] = useState(\"\")\r\n  const [disableCode, setDisableCode] = useState(\"\")\r\n  const [showDisableInput, setShowDisableInput] = useState(false)\r\n  const [showSmsDisableInput, setShowSmsDisableInput] = useState(false)\r\n  const [loading, setLoading] = useState(false)\r\n  const [initialLoading, setInitialLoading] = useState(true)\r\n  const [sending, setSending] = useState(false)\r\n  const [error, setError] = useState<string | null>(null)\r\n  const [success, setSuccess] = useState<string | null>(null)\r\n  const [totpFlow, setTotpFlow] = useState<'idle'|'provision'|'verifying'|'enabled'|'disabled'>('idle')\r\n  const [smsFlow, setSmsFlow] = useState<'idle'|'sent'|'verifying'|'enabled'|'disabled'>('idle')\r\n  const totpVerifyingRef = useRef(false)\r\n  const smsVerifyingRef = useRef(false)\r\n  const router = useRouter()\r\n\r\n  useEffect(() => {\r\n    let mounted = true\r\n    setInitialLoading(true)\r\n    ;(async () => {\r\n      try {\r\n        const r = await api.get(\"/api/account/me\")\r\n        if (!mounted) return\r\n        // API returns { ok: true, data: user } via sendSuccess, so r.data = { ok: true, data: user }\r\n        // Extract user data: if r.data.data exists, use it; otherwise r.data might be the user object directly\r\n        const userData = (r.data?.ok && r.data?.data) ? r.data.data : (r.data?.data || r.data)\r\n        setMe(userData)\r\n        // Read 2FA status directly from database - use twoFactorEnabled from userData\r\n        const isTotpEnabled = !!userData?.twoFactorEnabled && userData?.twoFactorMethod === 'TOTP'\r\n        const isSmsEnabled = !!userData?.twoFactorEnabled && userData?.twoFactorMethod === 'SMS'\r\n        const newStatus = { \r\n          totpEnabled: isTotpEnabled, \r\n          smsEnabled: isSmsEnabled,\r\n          phone: userData?.phone || null \r\n        }\r\n        setStatus(newStatus)\r\n        setTotpFlow(isTotpEnabled ? 'enabled' : 'idle')\r\n        setSmsFlow(isSmsEnabled ? 'enabled' : 'idle')\r\n        if (mounted) setInitialLoading(false)\r\n      } catch (e: any) {\r\n        if (mounted) {\r\n          setError('Failed to load account information')\r\n          setInitialLoading(false)\r\n        }\r\n      }\r\n    })()\r\n    return () => { mounted = false }\r\n  }, [])\r\n\r\n  const dispatchToast = (t: any) => { try { window.dispatchEvent(new CustomEvent('nols:toast', { detail: t })) } catch (e) {} }\r\n\r\n  const start2FA = async () => {\r\n    setError(null)\r\n    setCode('')\r\n    setTwofa(null)\r\n    setTotpFlow('provision')\r\n    setLoading(true)\r\n    try {\r\n      const r = await api.post(\"/api/account/2fa/totp/setup\")\r\n      // API returns { ok: true, data: { qrDataUrl, otpauthUrl, secretMasked } }\r\n      const qrData = r.data?.data || r.data\r\n      setTwofa(qrData)\r\n      dispatchToast({ type: 'info', title: '2FA Setup', message: 'Scan the QR code with your authenticator app', duration: 5000 })\r\n    } catch (err: any) {\r\n      const msg = err?.response?.data?.error || err?.message || 'Failed to start TOTP setup.'\r\n      setError(msg)\r\n      setTotpFlow('idle')\r\n      dispatchToast({ type: 'error', title: 'Failed to start TOTP', message: msg, duration: 5000 })\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }\r\n\r\n  const verify2FA = async () => {\r\n    if (totpVerifyingRef.current) return\r\n    if (!code || code.length !== 6 || !/^\\d{6}$/.test(code)) {\r\n      setError('Please enter a valid 6-digit code')\r\n      return\r\n    }\r\n    totpVerifyingRef.current = true\r\n    setError(null)\r\n    setLoading(true)\r\n    setTotpFlow('verifying')\r\n    try {\r\n      // Ensure code is a 6-digit string\r\n      const codeToSend = String(code).replace(/\\D/g, '').slice(0, 6)\r\n      if (codeToSend.length !== 6) {\r\n        setError('Please enter a valid 6-digit code')\r\n        return\r\n      }\r\n      const r = await api.post(\"/api/account/2fa/totp/verify\", { code: codeToSend })\r\n      // API returns { ok: true, data: { backupCodes: [...] } }\r\n      const responseData = r.data?.data || r.data\r\n      const backupCodes = responseData?.backupCodes || []\r\n      \r\n      setSuccess('2FA enabled successfully!')\r\n      dispatchToast({ type: 'success', title: '2FA enabled', message: 'Authenticator enabled. Save your backup codes.', duration: 8000 })\r\n      console.info('Backup codes:', backupCodes)\r\n      \r\n      // Immediately update state to reflect enabled status (verification succeeded)\r\n      // We know 2FA is enabled because the verify endpoint returned success\r\n      setTotpFlow('enabled')\r\n      setStatus(prev => ({ \r\n        ...prev, \r\n        totpEnabled: true, \r\n        smsEnabled: prev?.smsEnabled || false,\r\n        phone: prev?.phone || me?.phone || null \r\n      }))\r\n      setTwofa(null)\r\n      setCode(\"\")\r\n      \r\n      // Then refresh user data from database to get the latest state\r\n      const me2 = await api.get(\"/api/account/me\")\r\n      // API returns { ok: true, data: user } via sendSuccess\r\n      const userData = (me2.data?.ok && me2.data?.data) ? me2.data.data : (me2.data?.data || me2.data)\r\n      \r\n      // Update me state with fresh data from database\r\n      setMe(userData)\r\n      // Ensure status reflects database state\r\n      if (userData?.twoFactorEnabled) {\r\n        setStatus(prev => ({ \r\n          totpEnabled: true,\r\n          smsEnabled: prev ? prev.smsEnabled : false,\r\n          phone: userData?.phone || (prev ? prev.phone : null) || null \r\n        }))\r\n      }\r\n      \r\n      // Don't redirect immediately - let user see the enabled state\r\n      // setTimeout(() => router.push('/owner/settings'), 1500)\r\n    } catch (err: any) {\r\n      const msg = err?.response?.data?.error || err?.message || 'Failed to enable authenticator.'\r\n      setError(msg)\r\n      setTotpFlow('provision')\r\n      dispatchToast({ type: 'error', title: 'Failed to enable authenticator', message: msg, duration: 6000 })\r\n    } finally {\r\n      setLoading(false)\r\n      totpVerifyingRef.current = false\r\n    }\r\n  }\r\n\r\n  const handleDisableClick = () => {\r\n    setShowDisableInput(true)\r\n    setDisableCode(\"\")\r\n    setError(null)\r\n  }\r\n\r\n  const cancelDisable = () => {\r\n    setShowDisableInput(false)\r\n    setDisableCode(\"\")\r\n    setError(null)\r\n  }\r\n\r\n  const disable2FA = async () => {\r\n    if (!disableCode || disableCode.trim().length === 0) {\r\n      setError('Please enter a TOTP code or backup code')\r\n      return\r\n    }\r\n    setError(null)\r\n    setLoading(true)\r\n    try {\r\n      await api.post(\"/api/account/2fa/disable\", { code: disableCode.trim() })\r\n      setSuccess('2FA disabled successfully')\r\n      dispatchToast({ type: 'success', title: '2FA disabled', message: 'Two-factor authentication disabled.', duration: 4500 })\r\n      \r\n      // Refresh user data from database to get updated 2FA status\r\n      const me2 = await api.get(\"/api/account/me\")\r\n      const userData = me2.data?.data || me2.data\r\n      setMe(userData)\r\n      \r\n      // Update status from database\r\n      const isTotpEnabled = !!userData.twoFactorEnabled && userData.twoFactorMethod === 'TOTP'\r\n      const isSmsEnabled = !!userData.twoFactorEnabled && userData.twoFactorMethod === 'SMS'\r\n      setStatus({ \r\n        totpEnabled: isTotpEnabled, \r\n        smsEnabled: isSmsEnabled,\r\n        phone: userData.phone || null \r\n      })\r\n      setTotpFlow(isTotpEnabled ? 'enabled' : 'idle')\r\n      setSmsFlow(isSmsEnabled ? 'enabled' : 'idle')\r\n      setShowDisableInput(false)\r\n      setDisableCode(\"\")\r\n    } catch (err: any) {\r\n      const msg = err?.response?.data?.error || err?.message || 'Failed to disable 2FA.'\r\n      setError(msg)\r\n      dispatchToast({ type: 'error', title: 'Failed to disable 2FA', message: msg, duration: 4500 })\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }\r\n\r\n  const handleSmsSend = async () => {\r\n    if (!me?.phone) {\r\n      setError('Phone number is required for SMS 2FA. Please update your profile with a phone number.')\r\n      return\r\n    }\r\n    setError(null)\r\n    setSending(true)\r\n    try {\r\n      await api.post(\"/api/account/2fa/sms/send\", {})\r\n      setSmsFlow('sent')\r\n      dispatchToast({ type: 'info', title: 'SMS sent', message: 'A verification code was sent to your phone.', duration: 5000 })\r\n    } catch (err: any) {\r\n      const msg = err?.response?.data?.error || err?.message || 'Failed to send SMS code.'\r\n      setError(msg)\r\n      dispatchToast({ type: 'error', title: 'Failed to send SMS', message: msg, duration: 5000 })\r\n    } finally {\r\n      setSending(false)\r\n    }\r\n  }\r\n\r\n  const handleSmsVerify = async () => {\r\n    if (smsVerifyingRef.current) return\r\n    if (!smsCode || smsCode.length !== 6 || !/^\\d{6}$/.test(smsCode)) {\r\n      setError('Please enter a valid 6-digit verification code')\r\n      return\r\n    }\r\n    smsVerifyingRef.current = true\r\n    setError(null)\r\n    setLoading(true)\r\n    setSmsFlow('verifying')\r\n    try {\r\n      const codeToSend = String(smsCode).replace(/\\D/g, '').slice(0, 6)\r\n      await api.post(\"/api/account/2fa/sms/verify\", { code: codeToSend })\r\n      \r\n      // Refresh user data to get updated 2FA status\r\n      const me2 = await api.get(\"/api/account/me\")\r\n      const userData = me2.data?.data || me2.data\r\n      setMe(userData)\r\n      \r\n      const isSmsEnabled = !!userData.twoFactorEnabled && userData.twoFactorMethod === 'SMS'\r\n      setStatus(s => s ? { ...s, smsEnabled: isSmsEnabled } : { totpEnabled: false, smsEnabled: isSmsEnabled })\r\n      setSmsFlow(isSmsEnabled ? 'enabled' : 'idle')\r\n      setSmsCode('')\r\n      dispatchToast({ type: 'success', title: 'Two-factor enabled', message: 'SMS-based 2FA enabled.', duration: 4500 })\r\n    } catch (err: any) {\r\n      const msg = err?.response?.data?.error || err?.message || 'Failed to verify SMS code.'\r\n      setError(msg)\r\n      setSmsFlow('sent')\r\n      dispatchToast({ type: 'error', title: '2FA', message: msg, duration: 4000 })\r\n    } finally {\r\n      setLoading(false)\r\n      smsVerifyingRef.current = false\r\n    }\r\n  }\r\n\r\n  const handleSmsDisableClick = async () => {\r\n    setError(null)\r\n    setSending(true)\r\n    try {\r\n      // Send a verification code to the registered phone, same as enabling\r\n      await api.post(\"/api/account/2fa/sms/send\", {})\r\n      setShowSmsDisableInput(true)\r\n      setSmsCode(\"\")\r\n      dispatchToast({ type: 'info', title: 'SMS sent', message: 'A verification code was sent to your phone. Enter it to disable SMS 2FA.', duration: 5000 })\r\n    } catch (err: any) {\r\n      const msg = err?.response?.data?.error || err?.message || 'Failed to send SMS code.'\r\n      setError(msg)\r\n      dispatchToast({ type: 'error', title: 'Failed to send SMS', message: msg, duration: 5000 })\r\n    } finally {\r\n      setSending(false)\r\n    }\r\n  }\r\n\r\n  const cancelSmsDisable = () => {\r\n    setShowSmsDisableInput(false)\r\n    setSmsCode(\"\")\r\n    setError(null)\r\n  }\r\n\r\n  const handleSmsDisable = async () => {\r\n    if (!smsCode || smsCode.length !== 6 || !/^\\d{6}$/.test(smsCode)) {\r\n      setError('Please enter a valid 6-digit verification code')\r\n      dispatchToast({ type: 'error', title: 'Error', message: 'Please enter a valid 6-digit verification code', duration: 4000 })\r\n      return\r\n    }\r\n    setError(null)\r\n    setLoading(true)\r\n    try {\r\n      const codeToSend = String(smsCode).replace(/\\D/g, '').slice(0, 6)\r\n      await api.post(\"/api/account/2fa/sms/disable\", { code: codeToSend })\r\n      \r\n      // Refresh user data to get updated 2FA status\r\n      const me2 = await api.get(\"/api/account/me\")\r\n      const userData = me2.data?.data || me2.data\r\n      setMe(userData)\r\n      \r\n      const isSmsEnabled = !!userData.twoFactorEnabled && userData.twoFactorMethod === 'SMS'\r\n      setStatus(s => s ? { ...s, smsEnabled: isSmsEnabled } : { totpEnabled: false, smsEnabled: isSmsEnabled })\r\n      setSmsFlow(isSmsEnabled ? 'enabled' : 'disabled')\r\n      setSmsCode('')\r\n      setShowSmsDisableInput(false)\r\n      dispatchToast({ type: 'success', title: 'Two-factor disabled', message: 'SMS-based 2FA disabled.', duration: 4500 })\r\n    } catch (err: any) {\r\n      const msg = err?.response?.data?.error || err?.message || 'Failed to disable SMS-based 2FA.'\r\n      setError(msg)\r\n      dispatchToast({ type: 'error', title: '2FA', message: msg, duration: 4000 })\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }\r\n\r\n  if (initialLoading) {\r\n    return (\r\n      <div className=\"w-full min-h-screen bg-gradient-to-br from-slate-50 via-emerald-50/30 to-slate-50 py-4 sm:py-6 lg:py-8 px-4 sm:px-6 lg:px-8\">\r\n        <div className=\"max-w-2xl mx-auto flex items-center justify-center min-h-[400px]\">\r\n          <div className=\"text-center\">\r\n            <div className=\"inline-block h-8 w-8 border-4 border-emerald-600 border-t-transparent rounded-full animate-spin\"></div>\r\n            <p className=\"mt-4 text-sm text-slate-600\">Loading 2FA settings...</p>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  return (\r\n    <div className=\"w-full min-h-screen bg-gradient-to-br from-slate-50 via-emerald-50/30 to-slate-50 py-4 sm:py-6 lg:py-8 px-4 sm:px-6 lg:px-8\">\r\n      <div className=\"max-w-2xl mx-auto space-y-4 sm:space-y-6\">\r\n        <div className=\"w-full text-center\">\r\n          <div className=\"flex flex-col items-center mb-6\">\r\n            <div className=\"inline-flex items-center justify-center h-12 w-12 sm:h-14 sm:w-14 rounded-full bg-blue-50 text-blue-600 transition-all duration-300\">\r\n              <Smartphone className=\"h-6 w-6 sm:h-7 sm:w-7\" aria-hidden />\r\n            </div>\r\n            <h1 className=\"mt-3 text-xl sm:text-2xl lg:text-3xl font-bold text-gray-900\">Two-Factor Authentication</h1>\r\n            <p className=\"mt-2 text-xs sm:text-sm text-slate-600\">Add an extra layer of security to your account.</p>\r\n          </div>\r\n        </div>\r\n\r\n        {/* TOTP Section */}\r\n        <section className=\"w-full max-w-full bg-white rounded-2xl shadow-lg border-2 border-slate-200/50 p-4 sm:p-6 lg:p-8 overflow-hidden transition-all duration-300 hover:shadow-xl hover:border-emerald-200/50 box-border\">\r\n          <div className=\"flex flex-col sm:flex-row items-start justify-between gap-4 mb-6 w-full max-w-full min-w-0\">\r\n            <div className=\"flex items-center gap-3 flex-1 min-w-0\">\r\n              <div className=\"h-10 w-10 rounded-lg bg-blue-50 flex items-center justify-center flex-shrink-0\">\r\n                <Smartphone className=\"h-5 w-5 text-blue-600\" />\r\n              </div>\r\n              <div className=\"min-w-0 flex-1\">\r\n                <h2 className=\"text-base sm:text-lg font-bold text-gray-900\">TOTP Authenticator</h2>\r\n                <p className=\"text-xs sm:text-sm text-slate-600 mt-0.5\">Use an authenticator app (Google Authenticator, Authy, etc.) to generate codes.</p>\r\n              </div>\r\n            </div>\r\n            <div className=\"shrink-0\">\r\n              <span className={`inline-block text-xs px-3 py-1.5 rounded-full font-semibold ring-1 ${(me?.twoFactorEnabled && me?.twoFactorMethod === 'TOTP') || status?.totpEnabled || totpFlow === 'enabled' ? \"text-green-700 ring-green-200 bg-green-50\":\"text-amber-700 ring-amber-200 bg-amber-50\"}`}>\r\n                {((me?.twoFactorEnabled && me?.twoFactorMethod === 'TOTP') || status?.totpEnabled || totpFlow === 'enabled') ? \"ENABLED\" : \"DISABLED\"}\r\n              </span>\r\n            </div>\r\n          </div>\r\n\r\n          {error && (\r\n            <div className=\"rounded-xl bg-red-50 border-2 border-red-200 p-3 sm:p-4 mb-4 animate-in fade-in slide-in-from-top-2 duration-300 w-full max-w-full\">\r\n              <div className=\"text-xs sm:text-sm font-semibold text-red-800\">{error}</div>\r\n            </div>\r\n          )}\r\n          {success && (\r\n            <div className=\"rounded-xl bg-green-50 border-2 border-green-200 p-3 sm:p-4 mb-4 animate-in fade-in slide-in-from-top-2 duration-300 w-full max-w-full\">\r\n              <div className=\"text-xs sm:text-sm font-semibold text-green-800\">{success}</div>\r\n            </div>\r\n          )}\r\n\r\n          {!((me?.twoFactorEnabled && me?.twoFactorMethod === 'TOTP') || status?.totpEnabled || totpFlow === 'enabled') ? (\r\n            !twofa ? (\r\n              <div className=\"w-full max-w-full\">\r\n                <button \r\n                  onClick={start2FA}\r\n                  disabled={loading}\r\n                  className=\"inline-flex items-center justify-center gap-2 px-4 py-2.5 text-xs sm:text-sm font-semibold text-white bg-emerald-600 hover:bg-emerald-700 rounded-lg transition-all duration-300 border-2 border-emerald-600 hover:border-emerald-700 disabled:opacity-50 disabled:cursor-not-allowed hover:scale-105 active:scale-95\"\r\n                >\r\n                  <Smartphone className=\"h-4 w-4\" />\r\n                  <span>{loading ? 'Setting up...' : 'Enable TOTP'}</span>\r\n                </button>\r\n              </div>\r\n            ) : (\r\n              <div className=\"grid grid-cols-2 gap-3 sm:gap-4 md:gap-6 items-start w-full max-w-full min-w-0\">\r\n                <div className=\"flex justify-center sm:justify-start w-full max-w-full min-w-0\">\r\n                  <div className=\"w-full max-w-full h-auto aspect-square rounded-xl overflow-hidden ring-2 ring-slate-200 bg-white flex items-center justify-center shadow-md box-border\">\r\n                    {twofa?.qrDataUrl ? (\r\n                      <Image src={twofa.qrDataUrl} alt=\"TOTP QR\" width={192} height={192} className=\"object-contain w-full h-full max-w-full\" />\r\n                    ) : (\r\n                      <div className=\"text-xs text-slate-400 text-center p-4\">Loading QR code...</div>\r\n                    )}\r\n                  </div>\r\n                </div>\r\n                <div className=\"space-y-3 sm:space-y-4 w-full max-w-full min-w-0\">\r\n                  <div className=\"w-full max-w-full min-w-0\">\r\n                    <label className=\"block text-xs font-semibold text-slate-700 mb-1.5 sm:mb-2\">\r\n                      Enter 6-digit code\r\n                    </label>\r\n                    <input \r\n                      type=\"text\"\r\n                      maxLength={6}\r\n                      value={code} \r\n                      onChange={(e) => setCode(e.target.value.replace(/\\D/g, ''))}\r\n                      placeholder=\"000000\"\r\n                      className=\"block w-full max-w-full min-w-0 rounded-lg border-2 border-slate-200 px-2 sm:px-3 md:px-4 py-2 sm:py-2.5 text-xs sm:text-sm font-mono text-center focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-200 transition-all duration-200 box-border\"\r\n                    />\r\n                  </div>\r\n                  <div className=\"flex flex-col gap-2 sm:gap-3 w-full max-w-full\">\r\n                    <button \r\n                      onClick={verify2FA}\r\n                      disabled={loading || code.length !== 6}\r\n                      className=\"w-full inline-flex items-center justify-center gap-1.5 sm:gap-2 px-2 sm:px-3 md:px-4 py-2 sm:py-2.5 text-xs font-semibold text-white bg-emerald-600 hover:bg-emerald-700 rounded-lg transition-all duration-300 border-2 border-emerald-600 hover:border-emerald-700 disabled:opacity-50 disabled:cursor-not-allowed hover:scale-105 active:scale-95 min-w-0\"\r\n                    >\r\n                      <span className=\"truncate\">Verify & Enable</span>\r\n                    </button>\r\n                    <button \r\n                      onClick={() => { setTwofa(null); setCode('') }}\r\n                      className=\"w-full inline-flex items-center justify-center gap-1.5 sm:gap-2 px-2 sm:px-3 md:px-4 py-2 sm:py-2.5 text-xs font-semibold text-slate-700 hover:text-slate-900 hover:bg-slate-50 rounded-lg transition-all duration-300 border-2 border-slate-200 hover:border-slate-300 min-w-0\"\r\n                    >\r\n                      <span className=\"truncate\">Cancel</span>\r\n                    </button>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            )\r\n          ) : (\r\n            <div className=\"space-y-4 w-full max-w-full\">\r\n              <p className=\"text-xs sm:text-sm text-slate-600\">TOTP authentication is currently enabled on your account.</p>\r\n              {!showDisableInput ? (\r\n                <button \r\n                  onClick={handleDisableClick}\r\n                  disabled={loading}\r\n                  className=\"inline-flex items-center justify-center gap-2 px-4 py-2.5 text-xs sm:text-sm font-semibold text-red-600 hover:text-red-700 hover:bg-red-50 rounded-lg transition-all duration-300 border-2 border-red-200 hover:border-red-300 disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                >\r\n                  Disable TOTP\r\n                </button>\r\n              ) : (\r\n                <div className=\"space-y-3 sm:space-y-4 w-full max-w-full\">\r\n                  <div className=\"w-full max-w-full min-w-0\">\r\n                    <label className=\"block text-xs font-semibold text-slate-700 mb-1.5 sm:mb-2\">\r\n                      Enter TOTP code or backup code to disable\r\n                    </label>\r\n                    <input \r\n                      type=\"text\"\r\n                      value={disableCode}\r\n                      onChange={(e) => setDisableCode(e.target.value)}\r\n                      placeholder=\"Enter code\"\r\n                      className=\"block w-full max-w-full min-w-0 rounded-lg border-2 border-slate-200 px-2 sm:px-3 md:px-4 py-2 sm:py-2.5 text-xs sm:text-sm font-mono focus:border-red-500 focus:outline-none focus:ring-2 focus:ring-red-200 transition-all duration-200 box-border\"\r\n                      autoFocus\r\n                    />\r\n                    <p className=\"mt-1.5 text-xs text-slate-500\">Enter a 6-digit TOTP code from your authenticator app or a backup code.</p>\r\n                  </div>\r\n                  <div className=\"flex flex-col sm:flex-row gap-2 sm:gap-3 w-full max-w-full\">\r\n                    <button \r\n                      onClick={disable2FA}\r\n                      disabled={loading || !disableCode.trim()}\r\n                      className=\"flex-1 inline-flex items-center justify-center gap-2 px-4 py-2.5 text-xs sm:text-sm font-semibold text-white bg-red-600 hover:bg-red-700 rounded-lg transition-all duration-300 border-2 border-red-600 hover:border-red-700 disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                    >\r\n                      {loading ? 'Disabling...' : 'Disable TOTP'}\r\n                    </button>\r\n                    <button \r\n                      onClick={cancelDisable}\r\n                      disabled={loading}\r\n                      className=\"sm:w-auto inline-flex items-center justify-center gap-1.5 sm:gap-2 px-2 sm:px-3 md:px-4 py-2 sm:py-2.5 text-xs font-semibold text-slate-700 hover:text-slate-900 hover:bg-slate-50 rounded-lg transition-all duration-300 border-2 border-slate-200 hover:border-slate-300 disabled:opacity-50 disabled:cursor-not-allowed min-w-0\"\r\n                    >\r\n                      <span className=\"truncate\">Cancel</span>\r\n                    </button>\r\n                  </div>\r\n                </div>\r\n              )}\r\n            </div>\r\n          )}\r\n        </section>\r\n\r\n        {/* SMS Section */}\r\n        <section className=\"w-full max-w-full bg-white rounded-2xl shadow-lg border-2 border-slate-200/50 p-4 sm:p-6 lg:p-8 overflow-hidden transition-all duration-300 hover:shadow-xl hover:border-emerald-200/50 box-border\">\r\n          <div className=\"flex flex-col sm:flex-row items-start justify-between gap-4 mb-6 w-full max-w-full min-w-0\">\r\n            <div className=\"flex items-center gap-3 flex-1 min-w-0\">\r\n              <div className=\"h-10 w-10 rounded-lg bg-purple-50 flex items-center justify-center flex-shrink-0\">\r\n                <MessageSquare className=\"h-5 w-5 text-purple-600\" />\r\n              </div>\r\n              <div className=\"min-w-0 flex-1\">\r\n                <h2 className=\"text-base sm:text-lg font-bold text-gray-900\">SMS-based 2FA</h2>\r\n                <p className=\"text-xs sm:text-sm text-slate-600 mt-0.5\">Receive codes via SMS to your registered phone.</p>\r\n              </div>\r\n            </div>\r\n            <div className=\"shrink-0\">\r\n              {status && status.smsEnabled ? (\r\n                <span className=\"inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-semibold bg-green-50 text-green-700 ring-1 ring-green-200\">\r\n                  <CheckCircle className=\"h-3 w-3\" />\r\n                  Enabled\r\n                </span>\r\n              ) : (\r\n                <span className=\"inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-semibold bg-slate-100 text-slate-600 ring-1 ring-slate-200\">\r\n                  <XCircle className=\"h-3 w-3\" />\r\n                  Disabled\r\n                </span>\r\n              )}\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"grid grid-cols-2 gap-3 w-full max-w-full\">\r\n            {(status && status.smsEnabled) || smsFlow === 'enabled' ? (\r\n              !showSmsDisableInput ? (\r\n                <button \r\n                  onClick={handleSmsDisableClick} \r\n                  disabled={loading || sending} \r\n                  className=\"col-span-2 w-full inline-flex items-center justify-center gap-2 px-3 sm:px-4 py-2.5 text-xs sm:text-sm font-semibold text-red-600 hover:text-red-700 hover:bg-red-50 rounded-lg transition-all duration-300 border border-red-200 hover:border-red-300 disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                >\r\n                  {sending ? 'Sending code...' : 'Disable'}\r\n                </button>\r\n              ) : (\r\n                <div className=\"col-span-2 space-y-3 sm:space-y-4 w-full max-w-full\">\r\n                  <div className=\"w-full max-w-full min-w-0\">\r\n                    <label className=\"block text-xs font-semibold text-slate-700 mb-1.5 sm:mb-2\">\r\n                      Enter SMS code to disable\r\n                    </label>\r\n                    <input \r\n                      type=\"text\"\r\n                      maxLength={6}\r\n                      value={smsCode}\r\n                      onChange={(e) => setSmsCode(e.target.value.replace(/\\D/g, ''))}\r\n                      placeholder=\"000000\"\r\n                      className=\"block w-full max-w-full min-w-0 rounded-lg border-2 border-slate-200 px-2 sm:px-3 md:px-4 py-2 sm:py-2.5 text-xs sm:text-sm font-mono text-center focus:border-red-500 focus:outline-none focus:ring-2 focus:ring-red-200 transition-all duration-200 box-border\"\r\n                      autoFocus\r\n                    />\r\n                    <p className=\"mt-1.5 text-xs text-slate-500\">Enter the 6-digit code sent to your phone.</p>\r\n                  </div>\r\n                  <div className=\"flex flex-col sm:flex-row gap-2 sm:gap-3 w-full max-w-full\">\r\n                    <button \r\n                      onClick={handleSmsDisable}\r\n                      disabled={loading || smsCode.length !== 6}\r\n                      className=\"flex-1 inline-flex items-center justify-center gap-2 px-4 py-2.5 text-xs sm:text-sm font-semibold text-white bg-red-600 hover:bg-red-700 rounded-lg transition-all duration-300 border-2 border-red-600 hover:border-red-700 disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                    >\r\n                      {loading ? 'Disabling...' : 'Disable SMS 2FA'}\r\n                    </button>\r\n                    <button \r\n                      onClick={cancelSmsDisable}\r\n                      disabled={loading}\r\n                      className=\"sm:w-auto inline-flex items-center justify-center gap-1.5 sm:gap-2 px-2 sm:px-3 md:px-4 py-2 sm:py-2.5 text-xs font-semibold text-slate-700 hover:text-slate-900 hover:bg-slate-50 rounded-lg transition-all duration-300 border-2 border-slate-200 hover:border-slate-300 disabled:opacity-50 disabled:cursor-not-allowed min-w-0\"\r\n                    >\r\n                      <span className=\"truncate\">Cancel</span>\r\n                    </button>\r\n                  </div>\r\n                </div>\r\n              )\r\n            ) : (\r\n              <>\r\n                <button \r\n                  onClick={handleSmsSend} \r\n                  disabled={sending || !me?.phone} \r\n                  className={`w-full inline-flex items-center justify-center gap-1.5 sm:gap-2 px-2 sm:px-3 md:px-4 py-2 sm:py-2.5 text-xs font-semibold rounded-lg transition-all duration-300 border min-w-0 ${\r\n                    sending || !me?.phone\r\n                      ? 'text-slate-400 bg-slate-50 border-slate-200 opacity-60 cursor-not-allowed' \r\n                      : 'text-emerald-600 hover:text-emerald-700 hover:bg-emerald-50 border-emerald-200 hover:border-emerald-300'\r\n                  }`}\r\n                >\r\n                  <MessageSquare className=\"h-3.5 w-3.5 sm:h-4 sm:w-4 flex-shrink-0\" />\r\n                  <span className=\"truncate\">{sending ? 'Sending…' : 'Send code'}</span>\r\n                </button>\r\n                <button \r\n                  onClick={() => setSmsFlow('sent')} \r\n                  className=\"w-full inline-flex items-center justify-center gap-1.5 sm:gap-2 px-2 sm:px-3 md:px-4 py-2 sm:py-2.5 text-xs font-semibold text-slate-600 hover:text-slate-700 hover:bg-slate-50 rounded-lg transition-all duration-300 border border-slate-200 hover:border-slate-300 min-w-0\"\r\n                >\r\n                  <span className=\"truncate\">I have a code</span>\r\n                </button>\r\n              </>\r\n            )}\r\n          </div>\r\n\r\n          {(smsFlow === 'sent' || smsFlow === 'verifying') && (\r\n            <div className=\"mt-4 border-2 border-slate-200 rounded-xl p-3 sm:p-4 bg-slate-50 w-full max-w-full box-border\">\r\n              <p className=\"text-xs sm:text-sm text-slate-600 mb-3 break-words\">A code was sent to <strong>{status?.phone || me?.phone || 'your phone'}</strong>. Enter it below to verify.</p>\r\n              <div className=\"grid grid-cols-2 gap-2 sm:gap-3 w-full max-w-full\">\r\n                <input \r\n                  value={smsCode} \r\n                  onChange={e => setSmsCode(e.target.value.replace(/\\D/g, ''))} \r\n                  placeholder=\"Enter SMS code\" \r\n                  maxLength={6}\r\n                  className=\"col-span-2 w-full max-w-full min-w-0 px-2 sm:px-3 md:px-4 py-2 sm:py-2.5 border-2 border-slate-200 rounded-lg text-xs sm:text-sm font-mono text-center focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-200 transition-all duration-200 box-border\" \r\n                />\r\n                <button\r\n                  onClick={handleSmsVerify}\r\n                  disabled={smsFlow === 'verifying' || smsCode.length < 4}\r\n                  className={`w-full inline-flex items-center justify-center gap-1.5 sm:gap-2 px-2 sm:px-3 md:px-4 py-2 sm:py-2.5 text-xs font-semibold rounded-lg transition-all duration-300 border min-w-0 ${\r\n                    smsFlow === 'verifying' || smsCode.length < 4\r\n                      ? 'text-slate-400 bg-slate-50 border-slate-200 opacity-60 cursor-not-allowed' \r\n                      : 'text-emerald-600 hover:text-emerald-700 hover:bg-emerald-50 border-emerald-200 hover:border-emerald-300'\r\n                  }`}\r\n                >\r\n                  {smsFlow === 'verifying' ? (\r\n                    <>\r\n                      <div className=\"h-3.5 w-3.5 sm:h-4 sm:w-4 border-2 border-emerald-600 border-t-transparent rounded-full animate-spin flex-shrink-0\" />\r\n                      <span className=\"truncate\">Verifying</span>\r\n                    </>\r\n                  ) : (\r\n                    <span className=\"truncate\">Verify</span>\r\n                  )}\r\n                </button>\r\n                <button \r\n                  onClick={() => { setSmsFlow('idle'); setSmsCode('') }} \r\n                  className=\"w-full inline-flex items-center justify-center gap-1.5 sm:gap-2 px-2 sm:px-3 md:px-4 py-2 sm:py-2.5 text-xs font-semibold text-slate-600 hover:text-slate-700 hover:bg-slate-50 rounded-lg transition-all duration-300 border border-slate-200 hover:border-slate-300 min-w-0\"\r\n                >\r\n                  <span className=\"truncate\">Cancel</span>\r\n                </button>\r\n              </div>\r\n            </div>\r\n          )}\r\n\r\n          {!me?.phone && (\r\n            <div className=\"mt-4 rounded-xl bg-amber-50 border-2 border-amber-200 p-3 sm:p-4\">\r\n              <p className=\"text-xs sm:text-sm text-amber-800\">\r\n                <strong>Note:</strong> A phone number is required for SMS 2FA. Please update your profile with a phone number first.\r\n              </p>\r\n            </div>\r\n          )}\r\n\r\n          <div className=\"mt-6 flex justify-start pt-4 border-t border-slate-200\">\r\n            <Link \r\n              href=\"/owner/settings\" \r\n              className=\"inline-flex items-center gap-2 px-3 sm:px-4 py-2 text-xs sm:text-sm font-semibold text-slate-600 hover:text-slate-700 hover:bg-slate-50 rounded-lg transition-all duration-300 border border-slate-200 hover:border-slate-300 no-underline\"\r\n              aria-label=\"Back to Settings\"\r\n            >\r\n              <ChevronLeft className=\"h-4 w-4\" />\r\n              <span>Back to Settings</span>\r\n            </Link>\r\n          </div>\r\n        </section>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(owner)\\owner\\settings\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'SettingsIcon' is defined but never used. Allowed unused vars must match /^_/u.","line":5,"column":68,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":80,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"SettingsIcon"},"fix":{"range":[126,152],"text":""},"desc":"Remove unused variable \"SettingsIcon\"."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport React from \"react\"\r\nimport Link from \"next/link\"\r\nimport { ChevronLeft, LogIn, Smartphone, Lock, Shield, Settings as SettingsIcon } from 'lucide-react'\r\n\r\nexport default function OwnerSettingsPage() {\r\n  return (\r\n    <div className=\"w-full min-h-screen bg-gradient-to-br from-slate-50 via-emerald-50/30 to-slate-50 py-4 sm:py-6 lg:py-8 px-4 sm:px-6 lg:px-8\">\r\n      <div className=\"max-w-4xl mx-auto space-y-4 sm:space-y-6\">\r\n        <div className=\"w-full text-center\">\r\n          <div className=\"flex flex-col items-center mb-6\">\r\n            <div className=\"inline-flex items-center justify-center h-12 w-12 sm:h-14 sm:w-14 rounded-full bg-emerald-50 text-emerald-600 transition-all duration-300\">\r\n              <Shield className=\"h-6 w-6 sm:h-7 sm:w-7\" aria-hidden />\r\n            </div>\r\n            <h1 className=\"mt-3 text-xl sm:text-2xl lg:text-3xl font-bold text-gray-900\">Settings</h1>\r\n            <p className=\"mt-2 text-xs sm:text-sm text-slate-600 max-w-2xl\">Manage your security settings — password, two-factor auth, active sessions and other security-related tools.</p>\r\n          </div>\r\n        </div>\r\n\r\n        <section className=\"w-full max-w-full bg-white rounded-2xl shadow-lg border-2 border-slate-200/50 p-4 sm:p-6 lg:p-8 overflow-hidden transition-all duration-300 hover:shadow-xl hover:border-emerald-200/50\">\r\n          <div className=\"space-y-4\">\r\n            {/* Password Card */}\r\n            <div className=\"p-4 sm:p-5 border-2 border-slate-200 rounded-xl bg-white hover:border-emerald-300 hover:shadow-md transition-all duration-300\">\r\n              <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4\">\r\n                <div className=\"flex items-center gap-3\">\r\n                  <div className=\"h-10 w-10 rounded-lg bg-emerald-50 flex items-center justify-center flex-shrink-0\">\r\n                    <Lock className=\"h-5 w-5 text-emerald-600\" />\r\n                  </div>\r\n                  <div className=\"min-w-0\">\r\n                    <h3 className=\"text-base sm:text-lg font-bold text-gray-900\">Password</h3>\r\n                    <p className=\"text-xs sm:text-sm text-slate-500 mt-0.5\">Change your account password.</p>\r\n                  </div>\r\n                </div>\r\n                <Link \r\n                  href=\"/owner/settings/password\" \r\n                  title=\"Manage password\" \r\n                  className=\"inline-flex items-center justify-center gap-2 px-3 sm:px-4 py-2 text-xs sm:text-sm font-semibold text-emerald-600 hover:text-emerald-700 hover:bg-emerald-50 rounded-lg transition-all duration-300 border border-emerald-200 hover:border-emerald-300 no-underline whitespace-nowrap flex-shrink-0\"\r\n                  aria-label=\"Manage password\"\r\n                >\r\n                  <Lock className=\"h-4 w-4\" />\r\n                  <span>Manage password</span>\r\n                </Link>\r\n              </div>\r\n            </div>\r\n\r\n            {/* Two-factor authentication Card */}\r\n            <div className=\"p-4 sm:p-5 border-2 border-slate-200 rounded-xl bg-white hover:border-emerald-300 hover:shadow-md transition-all duration-300\">\r\n              <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4\">\r\n                <div className=\"flex items-center gap-3\">\r\n                  <div className=\"h-10 w-10 rounded-lg bg-blue-50 flex items-center justify-center flex-shrink-0\">\r\n                    <Smartphone className=\"h-5 w-5 text-blue-600\" />\r\n                  </div>\r\n                  <div className=\"min-w-0\">\r\n                    <h3 className=\"text-base sm:text-lg font-bold text-gray-900\">Two-factor authentication</h3>\r\n                    <p className=\"text-xs sm:text-sm text-slate-500 mt-0.5\">Enable or manage 2FA (TOTP, SMS, or authenticator app).</p>\r\n                  </div>\r\n                </div>\r\n                <Link \r\n                  href=\"/owner/settings/2fa\" \r\n                  title=\"Manage two-factor authentication\" \r\n                  className=\"inline-flex items-center justify-center gap-2 px-3 sm:px-4 py-2 text-xs sm:text-sm font-semibold text-emerald-600 hover:text-emerald-700 hover:bg-emerald-50 rounded-lg transition-all duration-300 border border-emerald-200 hover:border-emerald-300 no-underline whitespace-nowrap flex-shrink-0\"\r\n                  aria-label=\"Manage two-factor authentication\"\r\n                >\r\n                  <Smartphone className=\"h-4 w-4\" />\r\n                  <span>Manage 2FA</span>\r\n                </Link>\r\n              </div>\r\n            </div>\r\n\r\n            {/* Active Sessions Card */}\r\n            <div className=\"p-4 sm:p-5 border-2 border-slate-200 rounded-xl bg-white hover:border-emerald-300 hover:shadow-md transition-all duration-300\">\r\n              <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4\">\r\n                <div className=\"flex items-center gap-3\">\r\n                  <div className=\"h-10 w-10 rounded-lg bg-amber-50 flex items-center justify-center flex-shrink-0\">\r\n                    <LogIn className=\"h-5 w-5 text-amber-600\" />\r\n                  </div>\r\n                  <div className=\"min-w-0\">\r\n                    <h3 className=\"text-base sm:text-lg font-bold text-gray-900\">Active Sessions</h3>\r\n                    <p className=\"text-xs sm:text-sm text-slate-500 mt-0.5\">View and manage your active login sessions.</p>\r\n                  </div>\r\n                </div>\r\n                <Link \r\n                  href=\"/owner/settings/sessions\" \r\n                  title=\"View active sessions\" \r\n                  className=\"inline-flex items-center justify-center gap-2 px-3 sm:px-4 py-2 text-xs sm:text-sm font-semibold text-emerald-600 hover:text-emerald-700 hover:bg-emerald-50 rounded-lg transition-all duration-300 border border-emerald-200 hover:border-emerald-300 no-underline whitespace-nowrap flex-shrink-0\"\r\n                  aria-label=\"View active sessions\"\r\n                >\r\n                  <LogIn className=\"h-4 w-4\" />\r\n                  <span>View sessions</span>\r\n                </Link>\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"mt-6 flex justify-start pt-4 border-t border-slate-200\">\r\n            <Link \r\n              href=\"/owner\" \r\n              className=\"inline-flex items-center gap-2 px-3 sm:px-4 py-2 text-xs sm:text-sm font-semibold text-slate-600 hover:text-slate-700 hover:bg-slate-50 rounded-lg transition-all duration-300 border border-slate-200 hover:border-slate-300 no-underline\"\r\n              aria-label=\"Back to Dashboard\"\r\n            >\r\n              <ChevronLeft className=\"h-4 w-4\" />\r\n              <span>Back to Dashboard</span>\r\n            </Link>\r\n          </div>\r\n        </section>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(owner)\\owner\\settings\\password\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'role' is defined but never used. Allowed unused args must match /^_|^(e|err)$/u.","line":9,"column":53,"nodeType":"Identifier","messageId":"unusedVar","endLine":9,"endColumn":57}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport React, { useState, useEffect, useRef } from \"react\"\r\nimport Link from \"next/link\"\r\nimport { ChevronLeft, Eye, EyeOff, Lock, CheckCircle2, XCircle, AlertCircle } from 'lucide-react'\r\nimport { useRouter } from 'next/navigation'\r\n\r\n// Password validation function with DoS protection (12 characters for OWNER)\r\nfunction validatePasswordStrength(password: string, role?: string | null) {\r\n  // Backend enforces 12 characters minimum for OWNER/ADMIN roles\r\n  const minLength = 12; // DoS protection: minimum 12 characters for OWNER\r\n  const maxLength = 12; // DoS protection: maximum 12 characters\r\n  const requireUpper = true;\r\n  const requireLower = true;\r\n  const requireNumber = true;\r\n  const requireSpecial = true;\r\n  const noSpaces = true;\r\n\r\n  const reasons: string[] = [];\r\n  let strength: 'weak' | 'medium' | 'strong' = 'weak';\r\n  let score = 0;\r\n\r\n  if (typeof password !== 'string' || password.length === 0) {\r\n    return { valid: false, reasons: [], strength: 'weak' as const, score: 0 };\r\n  }\r\n\r\n  // DoS protection: enforce length limits (12 characters for OWNER)\r\n  // If password is exactly 12 characters, it passes length check (no reason added)\r\n  if (password.length < minLength) {\r\n    reasons.push(`Password must be at least ${minLength} characters long`);\r\n  } else if (password.length > maxLength) {\r\n    reasons.push(`Password must not exceed ${maxLength} characters`);\r\n  } else {\r\n    // Password length is valid (8-12 characters)\r\n    score += 2;\r\n  }\r\n\r\n  // Check requirements\r\n  if (noSpaces && /\\s/.test(password)) reasons.push('Password must not contain spaces');\r\n  \r\n  if (requireUpper && !/[A-Z]/.test(password)) {\r\n    reasons.push('Password must include at least one uppercase letter');\r\n  } else {\r\n    score += 1;\r\n  }\r\n  \r\n  if (requireLower && !/[a-z]/.test(password)) {\r\n    reasons.push('Password must include at least one lowercase letter');\r\n  } else {\r\n    score += 1;\r\n  }\r\n  \r\n  if (requireNumber && !/[0-9]/.test(password)) {\r\n    reasons.push('Password must include at least one digit');\r\n  } else {\r\n    score += 1;\r\n  }\r\n  \r\n  if (requireSpecial && !/[!@#\\$%\\^&\\*\\(\\)\\-_=+\\[\\]{};:'\"\\\\|,<.>/?`~]/.test(password)) {\r\n    reasons.push('Password must include at least one special character (e.g. !@#$%)');\r\n  } else {\r\n    score += 1;\r\n  }\r\n\r\n  // Determine strength\r\n  if (reasons.length === 0) {\r\n    strength = score >= 5 ? 'strong' : 'medium';\r\n  } else if (reasons.length <= 2) {\r\n    strength = 'medium';\r\n  } else {\r\n    strength = 'weak';\r\n  }\r\n\r\n  return { valid: reasons.length === 0, reasons, strength, score };\r\n}\r\n\r\nexport default function OwnerPasswordPage() {\r\n  const [currentPassword, setCurrentPassword] = useState(\"\")\r\n  const [newPassword, setNewPassword] = useState(\"\")\r\n  const [confirmPassword, setConfirmPassword] = useState(\"\")\r\n  const [loading, setLoading] = useState(false)\r\n  const [success, setSuccess] = useState<string | null>(null)\r\n  const [error, setError] = useState<string | null>(null)\r\n  const [showCurrentPassword, setShowCurrentPassword] = useState(false)\r\n  const [showNewPassword, setShowNewPassword] = useState(false)\r\n  const [showConfirmPassword, setShowConfirmPassword] = useState(false)\r\n  const [passwordValidation, setPasswordValidation] = useState<{\r\n    valid: boolean;\r\n    reasons: string[];\r\n    strength: 'weak' | 'medium' | 'strong';\r\n    score: number;\r\n  }>({ valid: false, reasons: [], strength: 'weak', score: 0 })\r\n  const [passwordMatch, setPasswordMatch] = useState<boolean | null>(null) // null = not checked yet, true = match, false = mismatch\r\n  const [inputLocked, setInputLocked] = useState(false) // Lock input after 12 characters\r\n  const [confirmInputLocked, setConfirmInputLocked] = useState(false) // Lock confirm input after 12 characters\r\n  const [consecutiveFailures, setConsecutiveFailures] = useState(0) // Track consecutive failures\r\n  const [timeoutUntil, setTimeoutUntil] = useState<number | null>(null) // Timeout timestamp\r\n  const [cooldownUntil, setCooldownUntil] = useState<number | null>(null) // Cooldown after successful change\r\n  const [remainingSeconds, setRemainingSeconds] = useState<number>(0) // Remaining seconds countdown\r\n  const router = useRouter()\r\n\r\n  const progressBarRef = useRef<HTMLDivElement>(null)\r\n\r\n  // Real-time password validation\r\n  useEffect(() => {\r\n    if (newPassword) {\r\n      const validation = validatePasswordStrength(newPassword, 'OWNER');\r\n      setPasswordValidation(validation);\r\n    } else {\r\n      setPasswordValidation({ valid: false, reasons: [], strength: 'weak', score: 0 });\r\n    }\r\n  }, [newPassword])\r\n\r\n  // Update progress bar width without inline styles\r\n  useEffect(() => {\r\n    if (progressBarRef.current) {\r\n      const width = Math.min(100, (passwordValidation.score / 6) * 100);\r\n      progressBarRef.current.style.width = `${width}%`;\r\n    }\r\n  }, [passwordValidation.score])\r\n\r\n  // Real-time password match validation\r\n  useEffect(() => {\r\n    if (confirmPassword && newPassword) {\r\n      setPasswordMatch(newPassword === confirmPassword);\r\n    } else if (confirmPassword && !newPassword) {\r\n      setPasswordMatch(false); // Can't match if new password is empty\r\n    } else {\r\n      setPasswordMatch(null); // Reset when confirm password is cleared\r\n    }\r\n  }, [newPassword, confirmPassword])\r\n\r\n  // Real-time validation: Check if new password matches current password\r\n  const isSameAsCurrent = currentPassword && newPassword && currentPassword === newPassword\r\n\r\n  // DoS protection: Lock inputs only when both passwords are 12 characters AND they match\r\n  useEffect(() => {\r\n    const shouldLock = newPassword.length === 12 && \r\n                       confirmPassword.length === 12 && \r\n                       newPassword === confirmPassword;\r\n    setInputLocked(shouldLock);\r\n    setConfirmInputLocked(shouldLock);\r\n  }, [newPassword, confirmPassword])\r\n\r\n  // Check timeout and cooldown status, update countdown\r\n  useEffect(() => {\r\n    const checkTimers = () => {\r\n      const now = Date.now();\r\n      if (timeoutUntil && now < timeoutUntil) {\r\n        setRemainingSeconds(Math.ceil((timeoutUntil - now) / 1000));\r\n      } else if (timeoutUntil && now >= timeoutUntil) {\r\n        setTimeoutUntil(null);\r\n        setConsecutiveFailures(0);\r\n        setRemainingSeconds(0);\r\n      } else {\r\n        setRemainingSeconds(0);\r\n      }\r\n      if (cooldownUntil && now >= cooldownUntil) {\r\n        setCooldownUntil(null);\r\n      }\r\n    };\r\n    checkTimers(); // Run immediately\r\n    const interval = setInterval(checkTimers, 1000);\r\n    return () => clearInterval(interval);\r\n  }, [timeoutUntil, cooldownUntil])\r\n\r\n  const submit = async (e: React.FormEvent) => {\r\n    e.preventDefault()\r\n    setError(null)\r\n    setSuccess(null)\r\n\r\n    // Check timeout\r\n    if (timeoutUntil && Date.now() < timeoutUntil) {\r\n      return // Message is shown in UI, no need for error message\r\n    }\r\n\r\n    // Check cooldown\r\n    if (cooldownUntil && Date.now() < cooldownUntil) {\r\n      const remaining = Math.ceil((cooldownUntil - Date.now()) / 60000)\r\n      setError(`Password was recently changed. Please wait ${remaining} minute(s) before changing it again.`)\r\n      return\r\n    }\r\n\r\n    if (!newPassword) { setError('Please enter a new password'); return }\r\n    if (newPassword !== confirmPassword) { setError('Passwords do not match'); return }\r\n    if (newPassword.length !== 12) {\r\n      setError('Password must be exactly 12 characters')\r\n      return\r\n    }\r\n    // Enforce policy: Prevent reusing current password\r\n    if (currentPassword && newPassword === currentPassword) {\r\n      setError('The new password must be different from your current password. Please choose a different password.')\r\n      return\r\n    }\r\n\r\n    setLoading(true)\r\n    try {\r\n      const res = await fetch('/api/account/password/change', {\r\n        method: 'POST',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ currentPassword, newPassword })\r\n      })\r\n      if (!res.ok) {\r\n        const b = await res.json().catch(() => null)\r\n        const reasons = b?.reasons || []\r\n        \r\n        // Track consecutive failures\r\n        const newFailureCount = consecutiveFailures + 1\r\n        setConsecutiveFailures(newFailureCount)\r\n        if (newFailureCount >= 3) {\r\n          // Lock for 5 minutes after 3 consecutive failures\r\n          const lockoutDuration = 5 * 60 * 1000 // 5 minutes\r\n          setTimeoutUntil(Date.now() + lockoutDuration)\r\n          setRemainingSeconds(300) // 5 minutes = 300 seconds\r\n        } else {\r\n          if (Array.isArray(reasons) && reasons.length) {\r\n            setError('Password change failed:\\n' + reasons.join('\\n'))\r\n          } else {\r\n            setError((b && b.error) || `Failed (status ${res.status})`)\r\n          }\r\n        }\r\n      } else {\r\n        // Success: reset failures and set cooldown\r\n        setConsecutiveFailures(0)\r\n        setTimeoutUntil(null)\r\n        const cooldownDuration = 30 * 60 * 1000 // 30 minutes\r\n        setCooldownUntil(Date.now() + cooldownDuration)\r\n        \r\n        setSuccess('Password updated successfully')\r\n        // show global toast\r\n        try { window.dispatchEvent(new CustomEvent('nols:toast', { detail: { type: 'success', title: 'Password updated', message: 'Your password was changed. You cannot change it again for 30 minutes.', duration: 5000 } })); } catch (e) {}\r\n        // redirect back to settings page after a short delay\r\n        setTimeout(() => router.push('/owner/settings'), 800)\r\n        setCurrentPassword('')\r\n        setNewPassword('')\r\n        setConfirmPassword('')\r\n      }\r\n    } catch (err: any) {\r\n      const newFailureCount = consecutiveFailures + 1\r\n      setConsecutiveFailures(newFailureCount)\r\n      if (newFailureCount >= 3) {\r\n        const lockoutDuration = 5 * 60 * 1000\r\n        setTimeoutUntil(Date.now() + lockoutDuration)\r\n        setRemainingSeconds(300) // 5 minutes = 300 seconds\r\n      } else {\r\n        setError(err?.message ?? String(err))\r\n      }\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }\r\n\r\n  return (\r\n    <div className=\"w-full min-h-screen bg-gradient-to-br from-slate-50 via-emerald-50/30 to-slate-50 py-4 sm:py-6 lg:py-8 px-4 sm:px-6 lg:px-8\">\r\n      <div className=\"max-w-2xl mx-auto space-y-4 sm:space-y-6\">\r\n        <div className=\"w-full text-center\">\r\n          <div className=\"flex flex-col items-center mb-6\">\r\n            <div className=\"inline-flex items-center justify-center h-12 w-12 sm:h-14 sm:w-14 rounded-full bg-emerald-50 text-emerald-600 transition-all duration-300\">\r\n              <Lock className=\"h-6 w-6 sm:h-7 sm:w-7\" aria-hidden />\r\n            </div>\r\n            <h1 className=\"mt-3 text-xl sm:text-2xl lg:text-3xl font-bold text-gray-900\">Change Password</h1>\r\n            <p className=\"mt-2 text-xs sm:text-sm text-slate-600\">Update your account password to keep it secure.</p>\r\n          </div>\r\n        </div>\r\n\r\n        <section className=\"w-full max-w-full bg-white rounded-2xl shadow-lg border-2 border-slate-200/50 p-4 sm:p-6 lg:p-8 overflow-hidden transition-all duration-300 hover:shadow-xl hover:border-emerald-200/50 box-border\">\r\n          <form onSubmit={submit} className=\"w-full max-w-full space-y-4 sm:space-y-5\">\r\n            {/* Current Password */}\r\n            <div className=\"w-full max-w-full min-w-0\">\r\n              <label className=\"block text-xs sm:text-sm font-bold text-slate-700 mb-2\">Current password</label>\r\n              <div className=\"relative w-full max-w-full\">\r\n                <input \r\n                  type={showCurrentPassword ? \"text\" : \"password\"} \r\n                  value={currentPassword} \r\n                  onChange={(e) => setCurrentPassword(e.target.value)} \r\n                  placeholder=\"Enter your current password\" \r\n                  className=\"block w-full max-w-full min-w-0 rounded-lg border-2 border-slate-200 px-3 sm:px-4 py-2.5 pr-10 text-xs sm:text-sm focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-200 transition-all duration-200 box-border\" \r\n                />\r\n                <button\r\n                  type=\"button\"\r\n                  onClick={() => setShowCurrentPassword(!showCurrentPassword)}\r\n                  className=\"absolute right-3 top-1/2 -translate-y-1/2 text-slate-500 hover:text-emerald-600 transition-all duration-200 border-0 bg-transparent outline-none focus:outline-none p-1.5 rounded-md hover:bg-slate-100/50 focus:bg-slate-100/50 cursor-pointer\"\r\n                  aria-label={showCurrentPassword ? \"Hide password\" : \"Show password\"}\r\n                  tabIndex={0}\r\n                >\r\n                  {showCurrentPassword ? <EyeOff className=\"h-4 w-4 sm:h-5 sm:w-5\" /> : <Eye className=\"h-4 w-4 sm:h-5 sm:w-5\" />}\r\n                </button>\r\n              </div>\r\n            </div>\r\n\r\n            {/* New Password */}\r\n            <div className=\"w-full max-w-full min-w-0\">\r\n              <label className=\"block text-xs sm:text-sm font-bold text-slate-700 mb-2\">New password</label>\r\n              <div className=\"relative w-full max-w-full\">\r\n                <input \r\n                  type={showNewPassword ? \"text\" : \"password\"} \r\n                  value={newPassword} \r\n                  onChange={(e) => {\r\n                    if (timeoutUntil && Date.now() < timeoutUntil) return // Block during timeout\r\n                    const value = e.target.value\r\n                    // Strictly enforce 12 character limit - always truncate immediately\r\n                    const truncated = value.slice(0, 12)\r\n                    setNewPassword(truncated)\r\n                  }}\r\n                  onPaste={(e) => {\r\n                    e.preventDefault()\r\n                    if (timeoutUntil && Date.now() < timeoutUntil) return // Block during timeout\r\n                    const pastedText = e.clipboardData.getData('text')\r\n                    // Strictly enforce 12 character limit - always truncate immediately\r\n                    const truncated = pastedText.slice(0, 12)\r\n                    setNewPassword(truncated)\r\n                  }}\r\n                  maxLength={12}\r\n                  disabled={inputLocked || (timeoutUntil !== null && Date.now() < timeoutUntil)}\r\n                  placeholder=\"Enter your new password (8-12 characters)\" \r\n                  className={`block w-full max-w-full min-w-0 rounded-lg border-2 px-3 sm:px-4 py-2.5 pr-10 text-xs sm:text-sm focus:outline-none focus:ring-2 transition-all duration-200 box-border ${\r\n                    inputLocked || (timeoutUntil !== null && Date.now() < timeoutUntil) ? 'bg-slate-100 cursor-not-allowed border-red-400' :\r\n                    !newPassword ? 'border-slate-200 focus:border-emerald-500 focus:ring-emerald-200' :\r\n                    passwordValidation.strength === 'strong' ? 'border-green-500 focus:border-green-600 focus:ring-green-200' :\r\n                    passwordValidation.strength === 'medium' ? 'border-yellow-500 focus:border-yellow-600 focus:ring-yellow-200' :\r\n                    'border-red-300 focus:border-red-400 focus:ring-red-200'\r\n                  }`}\r\n                />\r\n                <button\r\n                  type=\"button\"\r\n                  onClick={() => setShowNewPassword(!showNewPassword)}\r\n                  className=\"absolute right-3 top-1/2 -translate-y-1/2 text-slate-500 hover:text-emerald-600 transition-all duration-200 border-0 bg-transparent outline-none focus:outline-none p-1.5 rounded-md hover:bg-slate-100/50 focus:bg-slate-100/50 cursor-pointer\"\r\n                  aria-label={showNewPassword ? \"Hide password\" : \"Show password\"}\r\n                  tabIndex={0}\r\n                >\r\n                  {showNewPassword ? <EyeOff className=\"h-4 w-4 sm:h-5 sm:w-5\" /> : <Eye className=\"h-4 w-4 sm:h-5 sm:w-5\" />}\r\n                </button>\r\n              </div>\r\n              \r\n              {/* Password Strength Indicator */}\r\n              {newPassword && (\r\n                <div className=\"mt-3 space-y-2\">\r\n                  {/* Strength Meter */}\r\n                  <div className=\"space-y-1.5\">\r\n                    <div className=\"flex items-center justify-between mb-1\">\r\n                      <span className={`text-xs font-semibold transition-colors duration-200 ${\r\n                        passwordValidation.strength === 'strong' ? 'text-green-600' :\r\n                        passwordValidation.strength === 'medium' ? 'text-yellow-600' :\r\n                        'text-red-600'\r\n                      }`}>\r\n                        {passwordValidation.strength === 'strong' && '✓ Strong password'}\r\n                        {passwordValidation.strength === 'medium' && '⚠ Password needs improvement'}\r\n                        {passwordValidation.strength === 'weak' && '✗ Password is too weak'}\r\n                      </span>\r\n                      <span className=\"text-xs text-slate-500\">\r\n                        {passwordValidation.score}/6\r\n                      </span>\r\n                    </div>\r\n                    {/* Progress Bar */}\r\n                    <div className=\"w-full h-2 bg-slate-200 rounded-full overflow-hidden\">\r\n                      <div \r\n                        ref={progressBarRef}\r\n                        className={`h-full rounded-full transition-all duration-300 ease-out ${\r\n                          passwordValidation.strength === 'strong' ? 'bg-gradient-to-r from-green-500 to-emerald-600' :\r\n                          passwordValidation.strength === 'medium' ? 'bg-gradient-to-r from-yellow-400 to-orange-500' :\r\n                          'bg-gradient-to-r from-red-400 to-red-600'\r\n                        }`}\r\n                      />\r\n                    </div>\r\n                  </div>\r\n                  \r\n                  {/* Requirements Checklist */}\r\n                  <div className=\"space-y-1.5 pt-1\">\r\n                    <div className=\"text-xs font-semibold text-slate-600 mb-1.5\">Password requirements:</div>\r\n                    <div className=\"space-y-1.5\">\r\n                      {[\r\n                        { check: newPassword.length === 12, label: 'Exactly 12 characters' },\r\n                        { check: /[A-Z]/.test(newPassword), label: 'One uppercase letter (A-Z)' },\r\n                        { check: /[a-z]/.test(newPassword), label: 'One lowercase letter (a-z)' },\r\n                        { check: /[0-9]/.test(newPassword), label: 'One number (0-9)' },\r\n                        { check: /[!@#\\$%\\^&\\*\\(\\)\\-_=+\\[\\]{};:'\"\\\\|,<.>/?`~]/.test(newPassword), label: 'One special character (!@#$%&*)' },\r\n                        { check: !/\\s/.test(newPassword), label: 'No spaces' },\r\n                      ].map((req, idx) => (\r\n                        <div key={idx} className=\"flex items-center gap-2 text-xs\">\r\n                          {req.check ? (\r\n                            <CheckCircle2 className=\"h-3.5 w-3.5 text-green-600 flex-shrink-0\" />\r\n                          ) : (\r\n                            <XCircle className=\"h-3.5 w-3.5 text-slate-300 flex-shrink-0\" />\r\n                          )}\r\n                          <span className={req.check ? 'text-green-700 font-medium' : 'text-slate-500'}>\r\n                            {req.label}\r\n                          </span>\r\n                        </div>\r\n                      ))}\r\n                    </div>\r\n                  </div>\r\n                  \r\n                  {/* Warning: Same as current password */}\r\n                  {isSameAsCurrent && (\r\n                    <div className=\"mt-2 flex items-center gap-1.5 text-xs text-red-600 font-medium animate-in fade-in slide-in-from-top-1 duration-200 bg-red-50 border border-red-200 rounded-lg p-2\">\r\n                      <XCircle className=\"h-3.5 w-3.5 flex-shrink-0\" />\r\n                      <span>The new password must be different from your current password.</span>\r\n                    </div>\r\n                  )}\r\n                </div>\r\n              )}\r\n            </div>\r\n\r\n            {/* Confirm New Password */}\r\n            <div className=\"w-full max-w-full min-w-0\">\r\n              <label className=\"block text-xs sm:text-sm font-bold text-slate-700 mb-2\">Confirm new password</label>\r\n              <div className=\"relative w-full max-w-full\">\r\n                <input \r\n                  type={showConfirmPassword ? \"text\" : \"password\"} \r\n                  value={confirmPassword} \r\n                  onChange={(e) => {\r\n                    if (timeoutUntil && Date.now() < timeoutUntil) return // Block during timeout\r\n                    const value = e.target.value\r\n                    // Strictly enforce 12 character limit - always truncate immediately\r\n                    const truncated = value.slice(0, 12)\r\n                    setConfirmPassword(truncated)\r\n                  }}\r\n                  onPaste={(e) => {\r\n                    e.preventDefault()\r\n                    if (timeoutUntil && Date.now() < timeoutUntil) return // Block during timeout\r\n                    const pastedText = e.clipboardData.getData('text')\r\n                    // Strictly enforce 12 character limit - always truncate immediately\r\n                    const truncated = pastedText.slice(0, 12)\r\n                    setConfirmPassword(truncated)\r\n                  }}\r\n                  maxLength={12}\r\n                  disabled={confirmInputLocked || (timeoutUntil !== null && Date.now() < timeoutUntil)}\r\n                  placeholder=\"Confirm your new password (12 characters)\" \r\n                  className={`block w-full max-w-full min-w-0 rounded-lg border-2 px-3 sm:px-4 py-2.5 pr-10 text-xs sm:text-sm focus:outline-none focus:ring-2 transition-all duration-200 box-border ${\r\n                    confirmInputLocked || (timeoutUntil !== null && Date.now() < timeoutUntil) ? 'bg-slate-100 cursor-not-allowed border-red-400' :\r\n                    passwordMatch === null ? 'border-slate-200 focus:border-emerald-500 focus:ring-emerald-200' :\r\n                    passwordMatch === true ? 'border-green-500 focus:border-green-600 focus:ring-green-200' :\r\n                    'border-red-300 focus:border-red-400 focus:ring-red-200'\r\n                  }`}\r\n                />\r\n                <button\r\n                  type=\"button\"\r\n                  onClick={() => setShowConfirmPassword(!showConfirmPassword)}\r\n                  className=\"absolute right-3 top-1/2 -translate-y-1/2 text-slate-500 hover:text-emerald-600 transition-all duration-200 border-0 bg-transparent outline-none focus:outline-none p-1.5 rounded-md hover:bg-slate-100/50 focus:bg-slate-100/50 cursor-pointer\"\r\n                  aria-label={showConfirmPassword ? \"Hide password\" : \"Show password\"}\r\n                  tabIndex={0}\r\n                >\r\n                  {showConfirmPassword ? <EyeOff className=\"h-4 w-4 sm:h-5 sm:w-5\" /> : <Eye className=\"h-4 w-4 sm:h-5 sm:w-5\" />}\r\n                </button>\r\n              </div>\r\n              \r\n              {/* Password Match Indicator */}\r\n              {confirmPassword && (\r\n                <div className=\"mt-2\">\r\n                  {passwordMatch === true ? (\r\n                    <div className=\"flex items-center gap-1.5 text-xs text-green-600 font-medium animate-in fade-in slide-in-from-top-1 duration-200\">\r\n                      <CheckCircle2 className=\"h-3.5 w-3.5 flex-shrink-0\" />\r\n                      <span>Passwords match</span>\r\n                    </div>\r\n                  ) : passwordMatch === false ? (\r\n                    <div className=\"flex items-center gap-1.5 text-xs text-red-600 font-medium animate-in fade-in slide-in-from-top-1 duration-200\">\r\n                      <XCircle className=\"h-3.5 w-3.5 flex-shrink-0\" />\r\n                      <span>Passwords do not match</span>\r\n                    </div>\r\n                  ) : null}\r\n                </div>\r\n              )}\r\n            </div>\r\n\r\n            {/* Timeout Warning - Consolidated message with countdown and attempt count */}\r\n            {timeoutUntil && Date.now() < timeoutUntil && (\r\n              <div className=\"rounded-xl bg-red-50 border-2 border-red-200 p-3 sm:p-4 animate-in fade-in slide-in-from-top-2 duration-300\">\r\n                <div className=\"flex items-start gap-3\">\r\n                  <AlertCircle className=\"h-5 w-5 text-red-600 flex-shrink-0 mt-0.5\" />\r\n                  <div className=\"flex-1\">\r\n                    <div className=\"text-xs sm:text-sm font-bold text-red-800 mb-1\">\r\n                      Account temporarily locked due to {consecutiveFailures >= 3 ? 3 : consecutiveFailures} failed attempt{consecutiveFailures >= 3 ? 's' : consecutiveFailures > 1 ? 's' : ''}\r\n                    </div>\r\n                    <div className=\"text-xs sm:text-sm text-red-700\">\r\n                      Please wait <span className=\"font-bold text-red-800\">{remainingSeconds}</span> second{remainingSeconds !== 1 ? 's' : ''} before trying again.\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            )}\r\n\r\n            {/* Cooldown Warning */}\r\n            {cooldownUntil && Date.now() < cooldownUntil && (\r\n              <div className=\"rounded-xl bg-blue-50 border-2 border-blue-200 p-3 sm:p-4 animate-in fade-in slide-in-from-top-2 duration-300\">\r\n                <div className=\"flex items-center gap-2\">\r\n                  <AlertCircle className=\"h-4 w-4 text-blue-600 flex-shrink-0\" />\r\n                  <div className=\"text-xs sm:text-sm font-semibold text-blue-800\">\r\n                    Password was recently changed. You can change it again in {Math.ceil((cooldownUntil - Date.now()) / 60000)} minute(s).\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            )}\r\n\r\n            {/* Error/Success Messages */}\r\n            {error && (\r\n              <div className=\"rounded-xl bg-red-50 border-2 border-red-200 p-3 sm:p-4 animate-in fade-in slide-in-from-top-2 duration-300\">\r\n                <div className=\"text-xs sm:text-sm font-semibold text-red-800 whitespace-pre-line\">{error}</div>\r\n              </div>\r\n            )}\r\n            {success && (\r\n              <div className=\"rounded-xl bg-green-50 border-2 border-green-200 p-3 sm:p-4 animate-in fade-in slide-in-from-top-2 duration-300\">\r\n                <div className=\"text-xs sm:text-sm font-semibold text-green-800\">{success}</div>\r\n              </div>\r\n            )}\r\n\r\n            {/* Action Buttons */}\r\n            <div className=\"flex flex-col sm:flex-row items-stretch sm:items-center justify-end gap-3 pt-4\">\r\n              <Link \r\n                href=\"/owner/settings\" \r\n                className=\"inline-flex items-center justify-center px-4 py-2.5 text-xs sm:text-sm font-semibold text-slate-700 hover:text-slate-900 hover:bg-slate-50 rounded-lg transition-all duration-300 border-2 border-slate-200 hover:border-slate-300 no-underline\"\r\n              >\r\n                Cancel\r\n              </Link>\r\n              <button \r\n                type=\"submit\" \r\n                disabled={loading || !passwordValidation.valid || newPassword !== confirmPassword || !currentPassword || isSameAsCurrent || (timeoutUntil !== null && Date.now() < timeoutUntil) || (cooldownUntil !== null && Date.now() < cooldownUntil)} \r\n                className=\"inline-flex items-center justify-center px-4 py-2.5 text-xs sm:text-sm font-semibold text-white bg-emerald-600 hover:bg-emerald-700 rounded-lg transition-all duration-300 border-2 border-emerald-600 hover:border-emerald-700 disabled:opacity-50 disabled:cursor-not-allowed hover:scale-105 active:scale-95\"\r\n              >\r\n                {loading ? 'Saving…' : 'Save Changes'}\r\n              </button>\r\n            </div>\r\n          </form>\r\n\r\n          <div className=\"mt-6 flex justify-start pt-4 border-t border-slate-200\">\r\n            <Link \r\n              href=\"/owner/settings\" \r\n              className=\"inline-flex items-center gap-2 px-3 sm:px-4 py-2 text-xs sm:text-sm font-semibold text-slate-600 hover:text-slate-700 hover:bg-slate-50 rounded-lg transition-all duration-300 border border-slate-200 hover:border-slate-300 no-underline\"\r\n              aria-label=\"Back to Settings\"\r\n            >\r\n              <ChevronLeft className=\"h-4 w-4\" />\r\n              <span>Back to Settings</span>\r\n            </Link>\r\n          </div>\r\n        </section>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(owner)\\owner\\settings\\sessions\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(owner)\\owner\\support\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(owner)\\owner\\terms\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(owner)\\owner\\verification-policy\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\(public)\\public\\profile\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\account\\agent\\assignments\\[id]\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\account\\agent\\assignments\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'ArrowLeft' is defined but never used. Allowed unused vars must match /^_/u.","line":6,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":19,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"ArrowLeft"},"fix":{"range":[140,150],"text":""},"desc":"Remove unused variable \"ArrowLeft\"."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useEffect, useMemo, useState } from \"react\";\r\nimport Link from \"next/link\";\r\nimport axios from \"axios\";\r\nimport { ArrowLeft, ClipboardList, Calendar, User, ArrowRight, AlertCircle } from \"lucide-react\";\r\nimport LogoSpinner from \"@/components/LogoSpinner\";\r\n\r\nconst api = axios.create({ baseURL: \"\", withCredentials: true });\r\n\r\ntype Assignment = {\r\n  id: string | number;\r\n  title?: string;\r\n  description?: string | null;\r\n  status?: string;\r\n  createdAt?: string;\r\n  completedAt?: string | null;\r\n  assignedBy?: { name?: string | null } | string | null;\r\n};\r\n\r\nfunction StatusPill({ status }: { status: string }) {\r\n  const s = status.toLowerCase();\r\n  const style =\r\n    s.includes(\"complete\") || s === \"done\"\r\n      ? \"bg-success/5 text-success border-success/20\"\r\n      : s.includes(\"progress\")\r\n      ? \"bg-info/5 text-info border-info/20\"\r\n      : s.includes(\"cancel\")\r\n      ? \"bg-danger/5 text-danger border-danger/20\"\r\n      : \"bg-slate-50 text-slate-700 border-slate-200\";\r\n\r\n  return <span className={`inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold border ${style}`}>{status}</span>;\r\n}\r\n\r\nexport default function AgentAssignmentsPage() {\r\n  const [loading, setLoading] = useState(true);\r\n  const [items, setItems] = useState<Assignment[]>([]);\r\n  const [error, setError] = useState<string | null>(null);\r\n  const [authRequired, setAuthRequired] = useState(false);\r\n\r\n  const pageTitle = useMemo(() => \"My Assignments\", []);\r\n\r\n  useEffect(() => {\r\n    let alive = true;\r\n\r\n    (async () => {\r\n      try {\r\n        setLoading(true);\r\n        setError(null);\r\n        setAuthRequired(false);\r\n\r\n        // Ensure user is authenticated.\r\n        await api.get(\"/api/account/me\");\r\n\r\n        const res = await api.get(\"/api/agent/assignments\").catch(() => ({ data: { items: [] } }));\r\n        if (!alive) return;\r\n\r\n        const list: any[] = res.data?.items ?? res.data?.data?.items ?? res.data ?? [];\r\n        setItems(Array.isArray(list) ? list : []);\r\n      } catch (e: any) {\r\n        if (!alive) return;\r\n        if (e?.response?.status === 401) {\r\n          setAuthRequired(true);\r\n          setItems([]);\r\n          setError(null);\r\n        } else {\r\n          const msg = e?.response?.data?.error || \"Failed to load assignments\";\r\n          setError(String(msg));\r\n        }\r\n      } finally {\r\n        if (alive) setLoading(false);\r\n      }\r\n    })();\r\n\r\n    return () => {\r\n      alive = false;\r\n    };\r\n  }, []);\r\n\r\n  return (\r\n    <div className=\"w-full py-2 sm:py-4\">\r\n      <div className=\"mb-6 relative rounded-3xl border border-slate-200/70 bg-white/70 text-slate-900 backdrop-blur shadow-card overflow-hidden ring-1 ring-slate-900/5\">\r\n        <div className=\"absolute inset-0 bg-gradient-to-br from-brand/10 via-white/80 to-slate-50\" aria-hidden />\r\n        <div className=\"absolute -top-28 -right-24 h-72 w-72 rounded-full bg-brand/15 blur-3xl\" aria-hidden />\r\n        <div className=\"absolute -bottom-32 -left-28 h-80 w-80 rounded-full bg-slate-200/40 blur-3xl\" aria-hidden />\r\n        <div className=\"pointer-events-none absolute inset-x-0 top-0 h-px bg-white/80\" aria-hidden />\r\n\r\n        <div className=\"relative p-5 sm:p-7\">\r\n          <div className=\"relative overflow-hidden rounded-[28px] border border-slate-200/70 bg-white/60 backdrop-blur px-5 py-4 sm:px-6 sm:py-5 shadow-card ring-1 ring-slate-900/5\">\r\n            <div className=\"pointer-events-none absolute inset-0 bg-gradient-to-br from-white/70 via-transparent to-brand/10\" aria-hidden />\r\n            <div className=\"pointer-events-none absolute inset-x-0 top-0 h-px bg-white/90\" aria-hidden />\r\n\r\n            <div className=\"relative\">\r\n              <div className=\"min-w-0\">\r\n                <h1 className=\"text-2xl sm:text-3xl font-extrabold text-slate-900 tracking-tight\">{pageTitle}</h1>\r\n                <p className=\"text-sm sm:text-base text-slate-600 mt-1 leading-relaxed\">\r\n                  All assignments assigned to you, with status and details.\r\n                </p>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      {loading ? (\r\n        <div className=\"flex flex-col items-center justify-center py-20\">\r\n          <LogoSpinner size=\"lg\" className=\"mb-4\" ariaLabel=\"Loading assignments\" />\r\n          <p className=\"text-sm text-slate-600\">Loading assignments...</p>\r\n        </div>\r\n      ) : authRequired ? (\r\n        <div className=\"rounded-2xl border border-slate-200 bg-white/70 backdrop-blur p-6 shadow-card\">\r\n          <div className=\"text-sm font-bold text-slate-900\">Sign in required</div>\r\n          <div className=\"text-sm text-slate-600 mt-1\">Log in to see your assignments.</div>\r\n          <div className=\"mt-4\">\r\n            <Link\r\n              href=\"/account/login\"\r\n              className=\"inline-flex items-center gap-2 px-5 py-2.5 rounded-xl bg-brand text-white font-semibold no-underline hover:bg-brand-700 shadow-card transition-colors\"\r\n            >\r\n              Sign in\r\n              <ArrowRight className=\"w-4 h-4\" aria-hidden />\r\n            </Link>\r\n          </div>\r\n        </div>\r\n      ) : error ? (\r\n        <div className=\"rounded-2xl border border-rose-200 bg-rose-50 p-6 text-rose-900\">\r\n          <div className=\"flex items-start gap-3\">\r\n            <div className=\"h-10 w-10 rounded-2xl bg-white/70 border border-rose-200 flex items-center justify-center\">\r\n              <AlertCircle className=\"w-5 h-5 text-rose-600\" aria-hidden />\r\n            </div>\r\n            <div>\r\n              <div className=\"font-bold\">Couldn’t load assignments</div>\r\n              <div className=\"text-sm mt-1 text-rose-800\">{error}</div>\r\n              <div className=\"text-sm mt-3 text-rose-800\">\r\n                If this is your first time here, the assignment API may not be connected yet.\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      ) : items.length === 0 ? (\r\n        <div className=\"relative w-full overflow-hidden rounded-3xl border border-white/10 bg-slate-950/70 text-slate-100 backdrop-blur shadow-card ring-1 ring-white/10\">\r\n          <div className=\"absolute inset-0 bg-gradient-to-br from-white/10 via-transparent to-brand/15\" aria-hidden />\r\n          <div className=\"absolute -top-28 -right-24 h-72 w-72 rounded-full bg-brand/20 blur-3xl\" aria-hidden />\r\n          <div className=\"absolute -bottom-32 -left-28 h-80 w-80 rounded-full bg-white/10 blur-3xl\" aria-hidden />\r\n          <div className=\"pointer-events-none absolute inset-x-0 top-0 h-px bg-white/10\" aria-hidden />\r\n\r\n          <div className=\"relative px-6 py-10 sm:px-10 sm:py-12 min-h-[220px] sm:min-h-[260px] flex items-center\">\r\n            <div className=\"w-full grid grid-cols-1 lg:grid-cols-[1fr_auto] items-start lg:items-center gap-8\">\r\n              <div className=\"flex items-start gap-4 min-w-0\">\r\n                <div className=\"relative inline-flex h-14 w-14 items-center justify-center rounded-2xl border border-white/10 bg-white/5 shadow-card ring-1 ring-white/10\">\r\n                  <div className=\"absolute inset-0 rounded-2xl bg-gradient-to-br from-brand/25 via-transparent to-transparent\" aria-hidden />\r\n                  <ClipboardList className=\"relative h-7 w-7 text-white/80\" aria-hidden />\r\n                </div>\r\n\r\n                <div className=\"min-w-0\">\r\n                  <h3 className=\"text-xl sm:text-2xl font-extrabold text-white tracking-tight\">No assignments yet</h3>\r\n                  <p className=\"mt-2 text-sm sm:text-base text-white/70 leading-relaxed max-w-2xl\">\r\n                    When you receive assignments, they’ll show here with status and details.\r\n                  </p>\r\n                </div>\r\n              </div>\r\n\r\n              <div className=\"lg:pl-8 lg:border-l lg:border-white/10\">\r\n                <div className=\"inline-flex rounded-2xl border border-white/10 bg-white/5 backdrop-blur px-4 py-4 shadow-card ring-1 ring-white/10\">\r\n                  <Link\r\n                    href=\"/account/agent\"\r\n                    className=\"inline-flex items-center justify-center h-11 px-7 rounded-full bg-brand text-white font-semibold no-underline hover:bg-brand-700 shadow-card transition-colors\"\r\n                  >\r\n                    Go to dashboard\r\n                  </Link>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      ) : (\r\n        <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5\">\r\n          {items.map((a) => {\r\n            const id = a.id;\r\n            const title = a.title || `Assignment #${id}`;\r\n            const status = a.status || \"Pending\";\r\n            const createdAt = a.createdAt ? new Date(a.createdAt).toLocaleDateString(\"en-GB\", { day: \"2-digit\", month: \"short\", year: \"numeric\" }) : null;\r\n            const assignedByName =\r\n              typeof a.assignedBy === \"string\"\r\n                ? a.assignedBy\r\n                : (a.assignedBy as any)?.name || null;\r\n\r\n            return (\r\n              <Link\r\n                key={String(id)}\r\n                href={`/account/agent/assignments/${encodeURIComponent(String(id))}`}\r\n                className=\"no-underline\"\r\n              >\r\n                <div className=\"group rounded-2xl border border-slate-200 bg-white shadow-sm hover:shadow-md transition-shadow overflow-hidden\">\r\n                  <div className=\"p-5 border-b border-slate-200 bg-gradient-to-br from-slate-50 to-white\">\r\n                    <div className=\"flex items-start justify-between gap-3\">\r\n                      <div className=\"min-w-0\">\r\n                        <div className=\"text-sm font-bold text-slate-900 truncate\">{title}</div>\r\n                        <div className=\"text-xs text-slate-600 mt-1 truncate\">#{String(id)}</div>\r\n                      </div>\r\n                      <StatusPill status={status} />\r\n                    </div>\r\n                  </div>\r\n\r\n                  <div className=\"p-5 space-y-3\">\r\n                    {a.description ? (\r\n                      <div className=\"text-sm text-slate-600 line-clamp-2\">{a.description}</div>\r\n                    ) : (\r\n                      <div className=\"text-sm text-slate-500\">No description provided.</div>\r\n                    )}\r\n\r\n                    <div className=\"flex items-center justify-between gap-3 text-xs text-slate-600\">\r\n                      <div className=\"inline-flex items-center gap-2\">\r\n                        <Calendar className=\"w-4 h-4 text-slate-400\" aria-hidden />\r\n                        <span>{createdAt || \"—\"}</span>\r\n                      </div>\r\n                      <div className=\"inline-flex items-center gap-2\">\r\n                        <User className=\"w-4 h-4 text-slate-400\" aria-hidden />\r\n                        <span className=\"truncate max-w-[10rem]\">{assignedByName || \"—\"}</span>\r\n                      </div>\r\n                    </div>\r\n\r\n                    <div className=\"pt-1\">\r\n                      <div className=\"inline-flex items-center gap-2 text-sm font-semibold text-brand\">\r\n                        View details\r\n                        <ArrowRight className=\"w-4 h-4 transition-transform duration-200 group-hover:translate-x-0.5\" aria-hidden />\r\n                      </div>\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n              </Link>\r\n            );\r\n          })}\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\account\\agent\\contract\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\account\\agent\\notifications\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\account\\agent\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\account\\agent\\profile\\page.tsx","messages":[],"suppressedMessages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":557,"column":21,"nodeType":"JSXOpeningElement","endLine":557,"endColumn":122,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\account\\agent\\security\\2fa\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\account\\agent\\security\\login-history\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\account\\agent\\security\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\account\\agent\\security\\passkeys\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\account\\agent\\security\\password\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\account\\agent\\settings\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\account\\bookings\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\account\\cancellations\\[id]\\page.tsx","messages":[],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'load'. Either include it or remove the dependency array.","line":93,"column":6,"nodeType":"ArrayExpression","endLine":93,"endColumn":10,"suggestions":[{"desc":"Update the dependencies array to be: [id, load]","fix":{"range":[3098,3102],"text":"[id, load]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\account\\cancellations\\page.tsx","messages":[],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'doLookup'. Either include it or remove the dependency array.","line":100,"column":6,"nodeType":"ArrayExpression","endLine":100,"endColumn":19,"suggestions":[{"desc":"Update the dependencies array to be: [doLookup, initialCode]","fix":{"range":[2962,2975],"text":"[doLookup, initialCode]"}}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'doLookup'. Either include it or remove the dependency array.","line":121,"column":6,"nodeType":"ArrayExpression","endLine":121,"endColumn":12,"suggestions":[{"desc":"Update the dependencies array to be: [code, doLookup]","fix":{"range":[3584,3590],"text":"[code, doLookup]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\account\\event-plans\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\account\\forgot-password\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\account\\group-stays\\page.tsx","messages":[],"suppressedMessages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":846,"column":41,"nodeType":"JSXOpeningElement","endLine":850,"endColumn":43,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\account\\layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\account\\login\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\account\\onboard\\[role]\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\account\\page.tsx","messages":[],"suppressedMessages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":314,"column":17,"nodeType":"JSXOpeningElement","endLine":318,"endColumn":19,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\account\\profile\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\account\\register\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\account\\reset-password\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'method' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":11,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":11,"endColumn":15}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\nimport React, { useEffect, useState } from \"react\";\r\nimport { Eye, EyeOff, Lock, AlertCircle, CheckCircle2, ArrowLeft, Check } from 'lucide-react';\r\nimport { useRouter, useSearchParams } from \"next/navigation\";\r\n\r\nexport default function ResetPasswordPage() {\r\n  const search = useSearchParams();\r\n  const router = useRouter();\r\n  const token = search?.get(\"token\") ?? \"\";\r\n  const id = search?.get(\"id\") ?? \"\";\r\n  const method = search?.get(\"method\") ?? \"email\";\r\n  const nextRaw = search?.get(\"next\") ?? \"\";\r\n\r\n  const next = (() => {\r\n    const v = String(nextRaw || \"\").trim();\r\n    if (!v) return \"\";\r\n    if (!v.startsWith(\"/\")) return \"\";\r\n    if (v.startsWith(\"//\")) return \"\";\r\n    return v;\r\n  })();\r\n\r\n  const [password, setPassword] = useState(\"\");\r\n  const [confirm, setConfirm] = useState(\"\");\r\n  const [loading, setLoading] = useState(false);\r\n  const [error, setError] = useState<string | null>(null);\r\n  const [reasons, setReasons] = useState<string[]>([]);\r\n  const [clientReasons, setClientReasons] = useState<string[]>([]);\r\n  const [strengthScore, setStrengthScore] = useState<number>(0);\r\n  const [strengthLabel, setStrengthLabel] = useState<string>(\"\");\r\n  const [success, setSuccess] = useState(false);\r\n  const [showPassword, setShowPassword] = useState(false);\r\n  const [showConfirmPassword, setShowConfirmPassword] = useState(false);\r\n\r\n  useEffect(() => {\r\n    if (!token || !id) {\r\n      setError(\"Reset link missing token or id. Please request a new password reset link.\");\r\n    }\r\n  }, [token, id]);\r\n\r\n  const computeStrength = (pw: string) => {\r\n    const checks = [\r\n      { ok: pw.length >= 8, label: 'At least 8 characters' },\r\n      { ok: /[a-z]/.test(pw), label: 'Include a lowercase letter' },\r\n      { ok: /[A-Z]/.test(pw), label: 'Include an uppercase letter' },\r\n      { ok: /\\d/.test(pw), label: 'Include a number' },\r\n      { ok: /[^A-Za-z0-9]/.test(pw), label: 'Include a special character' },\r\n    ];\r\n    const score = checks.reduce((s, c) => s + (c.ok ? 1 : 0), 0);\r\n    const missing = checks.filter((c) => !c.ok).map((c) => c.label);\r\n    let label = '';\r\n    if (score <= 2) label = 'Weak';\r\n    else if (score === 3) label = 'Fair';\r\n    else if (score === 4) label = 'Strong';\r\n    else label = 'Very strong';\r\n    return { score, missing, label };\r\n  };\r\n\r\n  useEffect(() => {\r\n    const { score, missing, label } = computeStrength(password);\r\n    setStrengthScore(score);\r\n    setClientReasons(missing);\r\n    setStrengthLabel(label);\r\n  }, [password]);\r\n\r\n  const onSubmit = async (e: React.FormEvent) => {\r\n    e.preventDefault();\r\n    setError(null);\r\n    setReasons([]);\r\n    if (!token || !id) return setError(\"Missing token or id.\");\r\n    if (password.length < 8) return setError(\"Password must be at least 8 characters.\");\r\n    if (password !== confirm) return setError(\"Passwords do not match.\");\r\n\r\n    setLoading(true);\r\n    try {\r\n      const res = await fetch(\"/api/auth/reset-password\", {\r\n        method: \"POST\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify({ token, userId: id, password }),\r\n      });\r\n      const data = await res.json();\r\n      if (res.ok && data && data.ok) {\r\n        setSuccess(true);\r\n        setTimeout(() => router.push(next || \"/account/login\"), 2200);\r\n      } else {\r\n        if (data && data.message === \"weak_password\" && Array.isArray(data.reasons)) {\r\n          setReasons(data.reasons);\r\n        } else if (data && data.message) {\r\n          setError(String(data.message));\r\n        } else {\r\n          setError(\"Failed to reset password. Try again.\");\r\n        }\r\n      }\r\n    } catch (err) {\r\n      setError(\"Network error. Please try again.\");\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  return (\r\n    <main className=\"min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-50 to-slate-100 py-8 px-4\">\r\n      <div className=\"w-full max-w-md bg-white rounded-xl shadow-lg overflow-hidden border border-slate-100 box-border\">\r\n        {/* Header */}\r\n        <div className=\"h-1 bg-[#02665e]\" />\r\n        \r\n        <div className=\"px-6 py-5 border-b border-slate-100\">\r\n          <div className=\"flex items-center gap-4\">\r\n            <button\r\n              onClick={() => router.push(next || \"/account/login\")}\r\n              className=\"w-10 h-10 rounded-lg border border-slate-300 flex items-center justify-center hover:bg-slate-50 transition-colors flex-shrink-0\"\r\n            >\r\n              <ArrowLeft className=\"w-5 h-5 text-slate-600\" />\r\n            </button>\r\n            <div className=\"flex-1 min-w-0\">\r\n              <div className=\"flex items-center gap-3\">\r\n                <div className=\"w-10 h-10 rounded-lg bg-[#02665e]/10 flex items-center justify-center\">\r\n                  <Lock className=\"w-5 h-5 text-[#02665e]\" />\r\n                </div>\r\n                <div>\r\n                  <h1 className=\"text-xl font-bold text-slate-900\">Reset Password</h1>\r\n                  <p className=\"text-xs text-slate-600 mt-0.5\">\r\n                    Enter a new password for your account\r\n                  </p>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"px-6 py-5 min-w-0 overflow-hidden\">\r\n          {error && (\r\n            <div className=\"mb-4 p-3 bg-red-50 border border-red-200 rounded-lg flex items-start gap-2.5 text-sm text-red-800\">\r\n              <AlertCircle className=\"w-4 h-4 mt-0.5 flex-shrink-0\" />\r\n              <span className=\"flex-1 min-w-0 break-words\">{error}</span>\r\n            </div>\r\n          )}\r\n\r\n          {reasons.length > 0 && (\r\n            <div className=\"mb-4 p-3 bg-amber-50 border border-amber-200 rounded-lg text-sm text-amber-800 min-w-0\">\r\n              <div className=\"font-semibold mb-1.5\">Password requirements:</div>\r\n              <ul className=\"pl-5 list-disc space-y-0.5\">\r\n                {reasons.map((r, i) => (\r\n                  <li key={i}>{r}</li>\r\n                ))}\r\n              </ul>\r\n            </div>\r\n          )}\r\n\r\n          {success ? (\r\n            <div className=\"p-4 bg-emerald-50 border border-emerald-200 rounded-lg flex items-start gap-2.5 min-w-0\">\r\n              <CheckCircle2 className=\"w-5 h-5 text-emerald-600 flex-shrink-0 mt-0.5\" />\r\n              <div className=\"flex-1 min-w-0\">\r\n                <h3 className=\"text-sm font-semibold text-emerald-900 mb-1\">Password Reset Successful</h3>\r\n                <p className=\"text-xs text-emerald-700\">Redirecting to sign-in...</p>\r\n              </div>\r\n            </div>\r\n          ) : (\r\n            <form onSubmit={onSubmit} className=\"space-y-4 min-w-0\">\r\n              <div className=\"space-y-2 min-w-0\">\r\n                <label className=\"block text-sm font-semibold text-slate-900\">New password</label>\r\n                <div className=\"relative min-w-0\">\r\n                  <input\r\n                    type={showPassword ? 'text' : 'password'}\r\n                    value={password}\r\n                    onChange={(e) => setPassword(e.target.value)}\r\n                    className=\"w-full max-w-full px-3 pr-10 py-2.5 text-sm border-2 border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#02665e]/20 focus:border-[#02665e] transition-all box-border\"\r\n                    placeholder=\"New password\"\r\n                    autoComplete=\"new-password\"\r\n                  />\r\n                  <button\r\n                    type=\"button\"\r\n                    onClick={() => setShowPassword((v) => !v)}\r\n                    aria-label={showPassword ? 'Hide password' : 'Show password'}\r\n                    className=\"absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600 transition-colors focus:outline-none border-none bg-transparent p-0\"\r\n                  >\r\n                    {showPassword ? <EyeOff className=\"w-4 h-4\" /> : <Eye className=\"w-4 h-4\" />}\r\n                  </button>\r\n                </div>\r\n\r\n                {/* Strength meter */}\r\n                {password && (\r\n                  <div className=\"mt-3 p-3 bg-slate-50 rounded-lg border border-slate-200 min-w-0\">\r\n                    <div className=\"flex gap-1 mb-2 min-w-0\">\r\n                      {[0,1,2,3,4].map((i) => (\r\n                        <div \r\n                          key={i} \r\n                          className={`h-2 flex-1 min-w-0 rounded transition-all ${\r\n                            i < strengthScore \r\n                              ? strengthScore <= 2 \r\n                                ? 'bg-red-400' \r\n                                : strengthScore === 3 \r\n                                ? 'bg-amber-400' \r\n                                : strengthScore === 4\r\n                                ? 'bg-emerald-500'\r\n                                : 'bg-emerald-600'\r\n                              : 'bg-slate-200'\r\n                          }`} \r\n                        />\r\n                      ))}\r\n                    </div>\r\n                    <div className=\"flex items-center justify-between text-xs min-w-0\">\r\n                      <span className={`font-medium flex-shrink-0 ${\r\n                        strengthScore <= 2 ? 'text-red-600' : \r\n                        strengthScore === 3 ? 'text-amber-600' : \r\n                        'text-emerald-600'\r\n                      }`}>\r\n                        {strengthLabel} {password ? `(${strengthScore}/5)` : ''}\r\n                      </span>\r\n                      {clientReasons.length > 0 && (\r\n                        <span className=\"text-slate-500 flex-shrink-0 ml-2\">\r\n                          {clientReasons.length} requirement{clientReasons.length > 1 ? 's' : ''} remaining\r\n                        </span>\r\n                      )}\r\n                    </div>\r\n                    {clientReasons.length > 0 && (\r\n                      <ul className=\"mt-2 pl-4 text-xs text-slate-600 list-disc space-y-0.5 min-w-0\">\r\n                        {clientReasons.slice(0, 3).map((r, i) => (\r\n                          <li key={i} className=\"break-words\">{r}</li>\r\n                        ))}\r\n                      </ul>\r\n                    )}\r\n                  </div>\r\n                )}\r\n              </div>\r\n\r\n              <div className=\"space-y-2 min-w-0\">\r\n                <label className=\"block text-sm font-semibold text-slate-900\">Confirm password</label>\r\n                <div className=\"relative min-w-0\">\r\n                  <input\r\n                    type={showConfirmPassword ? 'text' : 'password'}\r\n                    value={confirm}\r\n                    onChange={(e) => setConfirm(e.target.value)}\r\n                    className=\"w-full max-w-full px-3 pr-10 py-2.5 text-sm border-2 border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#02665e]/20 focus:border-[#02665e] transition-all box-border\"\r\n                    placeholder=\"Confirm password\"\r\n                    autoComplete=\"new-password\"\r\n                  />\r\n                  <button\r\n                    type=\"button\"\r\n                    onClick={() => setShowConfirmPassword((v) => !v)}\r\n                    aria-label={showConfirmPassword ? 'Hide confirm password' : 'Show confirm password'}\r\n                    className=\"absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600 transition-colors focus:outline-none border-none bg-transparent p-0\"\r\n                  >\r\n                    {showConfirmPassword ? <EyeOff className=\"w-4 h-4\" /> : <Eye className=\"w-4 h-4\" />}\r\n                  </button>\r\n                </div>\r\n                {confirm && password !== confirm && (\r\n                  <p className=\"text-xs text-red-600 flex items-center gap-1\">\r\n                    <AlertCircle className=\"w-3 h-3\" />\r\n                    Passwords do not match\r\n                  </p>\r\n                )}\r\n                {confirm && password === confirm && password.length >= 8 && (\r\n                  <p className=\"text-xs text-emerald-600 flex items-center gap-1\">\r\n                    <Check className=\"w-3 h-3\" />\r\n                    Passwords match\r\n                  </p>\r\n                )}\r\n              </div>\r\n\r\n              <div className=\"flex items-center justify-between pt-2 min-w-0 gap-3\">\r\n                <button\r\n                  type=\"submit\"\r\n                  disabled={loading || !token || !id || password.length < 8 || password !== confirm}\r\n                  className=\"flex-1 min-w-0 px-6 py-2.5 bg-[#02665e] hover:bg-[#014e47] text-white text-sm font-medium rounded-lg transition-all duration-200 shadow-md hover:shadow-lg transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none disabled:hover:shadow-md box-border\"\r\n                >\r\n                  {loading ? (\r\n                    <span className=\"flex items-center gap-1.5 justify-center\">\r\n                      <div className=\"w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin flex-shrink-0\" />\r\n                      <span className=\"truncate\">Resetting...</span>\r\n                    </span>\r\n                  ) : (\r\n                    <span className=\"truncate\">Reset password</span>\r\n                  )}\r\n                </button>\r\n                <button\r\n                  type=\"button\"\r\n                  onClick={() => router.push('/account/register')}\r\n                  className=\"flex-shrink-0 text-sm text-slate-600 hover:text-[#02665e] transition-colors flex items-center gap-1.5 whitespace-nowrap\"\r\n                >\r\n                  <ArrowLeft className=\"w-4 h-4 flex-shrink-0\" />\r\n                  <span>Back to sign in</span>\r\n                </button>\r\n              </div>\r\n            </form>\r\n          )}\r\n        </div>\r\n      </div>\r\n    </main>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\account\\rides\\[id]\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\account\\rides\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Clock' is defined but never used. Allowed unused vars must match /^_/u.","line":4,"column":23,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":28,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Clock"},"fix":{"range":[106,113],"text":""},"desc":"Remove unused variable \"Clock\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'MessageCircle' is defined but never used. Allowed unused vars must match /^_/u.","line":4,"column":96,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":109,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"MessageCircle"},"fix":{"range":[179,194],"text":""},"desc":"Remove unused variable \"MessageCircle\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":87,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":87,"endColumn":15}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\nimport { useEffect, useState } from \"react\";\nimport axios from \"axios\";\nimport { Car, MapPin, Clock, Star, User, CheckCircle, Calendar, ArrowRight, Phone, Navigation, MessageCircle, Eye } from \"lucide-react\";\nimport Link from \"next/link\";\n\nconst api = axios.create({ baseURL: \"\", withCredentials: true });\n\ntype Ride = {\n  id: number;\n  scheduledDate: string;\n  pickupTime?: string;\n  dropoffTime?: string;\n  fromRegion?: string;\n  fromDistrict?: string;\n  fromWard?: string;\n  fromAddress?: string;\n  toRegion?: string;\n  toDistrict?: string;\n  toWard?: string;\n  toAddress?: string;\n  driver?: {\n    id: number;\n    name: string;\n    phone?: string;\n  };\n  property?: {\n    id: number;\n    title: string;\n  };\n  status: string;\n  amount?: number;\n  rating?: number;\n  isValid: boolean;\n  createdAt: string;\n};\n\nfunction SkeletonLine({ w = \"w-full\" }: { w?: string }) {\n  return <div className={`h-3 ${w} rounded-full bg-slate-200/80 animate-pulse`} />;\n}\n\nfunction RideCardSkeleton({ variant }: { variant: \"active\" | \"expired\" }) {\n  const isActive = variant === \"active\";\n  return (\n    <div className=\"bg-white rounded-2xl border border-slate-200 p-5 sm:p-6 shadow-sm\">\n      <div className=\"flex flex-col gap-4 lg:flex-row lg:items-start lg:justify-between\">\n        <div className=\"min-w-0 flex-1\">\n          <div className=\"flex flex-wrap items-center gap-2\">\n            <div className=\"min-w-[220px] flex-1\">\n              <SkeletonLine w=\"w-64\" />\n              <div className=\"mt-2\">\n                <SkeletonLine w=\"w-40\" />\n              </div>\n            </div>\n            <span\n              className={[\n                \"inline-flex items-center gap-1 rounded-full px-3 py-1 text-xs font-semibold\",\n                isActive ? \"bg-[#02665e]/10 text-[#02665e]\" : \"bg-slate-100 text-slate-700\",\n              ].join(\" \")}\n            >\n              {isActive ? <CheckCircle className=\"h-4 w-4\" /> : <Calendar className=\"h-4 w-4 text-red-600\" />}\n              {isActive ? \"Scheduled\" : \"Completed\"}\n            </span>\n          </div>\n\n          <div className=\"mt-4 grid grid-cols-1 gap-3 text-sm sm:grid-cols-2\">\n            {Array.from({ length: 4 }).map((_, i) => (\n              <div key={i} className=\"rounded-xl bg-slate-50/70 border border-slate-200 p-3\">\n                <SkeletonLine w=\"w-20\" />\n                <div className=\"mt-2\">\n                  <SkeletonLine w=\"w-28\" />\n                </div>\n              </div>\n            ))}\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n\nexport default function MyRidesPage() {\n  const [rides, setRides] = useState<Ride[]>([]);\n  const [loading, setLoading] = useState(true);\n  const [filter, setFilter] = useState<\"all\" | \"scheduled\" | \"completed\" | \"expired\">(\"all\");\n  const [entered, setEntered] = useState(false);\n  const [error, setError] = useState<string | null>(null);\n\n  useEffect(() => {\n    loadRides();\n  }, []);\n\n  // Gentle mount animation\n  useEffect(() => {\n    const t = window.requestAnimationFrame(() => setEntered(true));\n    return () => window.cancelAnimationFrame(t);\n  }, []);\n\n  const loadRides = async () => {\n    try {\n      setLoading(true);\n      setError(null);\n      const response = await api.get(\"/api/customer/rides\");\n      setRides(response.data.items || []);\n    } catch (err: any) {\n      const msg = err?.response?.data?.error || \"Failed to load rides\";\n      setError(msg);\n      try {\n        window.dispatchEvent(\n          new CustomEvent(\"nols:toast\", {\n            detail: { type: \"error\", title: \"Rides\", message: msg, duration: 4500 },\n          })\n        );\n      } catch {}\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const filteredRides = rides.filter((ride) => {\n    if (filter === \"scheduled\") return ride.isValid;\n    if (filter === \"completed\") return !ride.isValid && ride.status === \"COMPLETED\";\n    if (filter === \"expired\") return !ride.isValid && ride.status !== \"COMPLETED\";\n    return true;\n  });\n\n  const scheduledCount = rides.filter((r) => r.isValid).length;\n  const completedCount = rides.filter((r) => !r.isValid && r.status === \"COMPLETED\").length;\n  const expiredCount = rides.filter((r) => !r.isValid && r.status !== \"COMPLETED\").length;\n\n  const formatDate = (dateString: string) => {\n    return new Date(dateString).toLocaleDateString(\"en-US\", {\n      year: \"numeric\",\n      month: \"short\",\n      day: \"numeric\",\n    });\n  };\n\n  const formatTime = (timeString?: string) => {\n    if (!timeString) return \"N/A\";\n    return new Date(timeString).toLocaleTimeString(\"en-US\", {\n      hour: \"2-digit\",\n      minute: \"2-digit\",\n    });\n  };\n\n  const formatLocation = (ride: Ride, type: \"from\" | \"to\") => {\n    const parts = [];\n    if (type === \"from\") {\n      if (ride.fromAddress) parts.push(ride.fromAddress);\n      if (ride.fromWard) parts.push(ride.fromWard);\n      if (ride.fromDistrict) parts.push(ride.fromDistrict);\n      if (ride.fromRegion) parts.push(ride.fromRegion);\n    } else {\n      if (ride.property?.title) parts.push(ride.property.title);\n      if (ride.toAddress) parts.push(ride.toAddress);\n      if (ride.toWard) parts.push(ride.toWard);\n      if (ride.toDistrict) parts.push(ride.toDistrict);\n      if (ride.toRegion) parts.push(ride.toRegion);\n    }\n    return parts.length > 0 ? parts.join(\", \") : \"Not specified\";\n  };\n\n  const getStatusLabel = (ride: Ride) => {\n    if (!ride.isValid) {\n      return ride.status === \"COMPLETED\" ? \"Completed\" : \"Expired\";\n    }\n    return ride.status === \"CONFIRMED\" ? \"Confirmed\" : \"Scheduled\";\n  };\n\n  if (loading) {\n    return (\n      <div className=\"mx-auto w-full max-w-5xl space-y-6\">\n        <div className=\"text-center\">\n          <div className=\"mx-auto max-w-md\">\n            <div className=\"h-8 w-56 mx-auto rounded-full bg-slate-200/80 animate-pulse\" />\n            <div className=\"mt-3 h-4 w-72 mx-auto rounded-full bg-slate-200/70 animate-pulse\" />\n          </div>\n        </div>\n\n        <div className=\"flex justify-center\">\n          <div className=\"inline-flex items-center gap-2 rounded-2xl border border-slate-200 bg-slate-50 p-1 shadow-sm\">\n            {Array.from({ length: 3 }).map((_, i) => (\n              <div key={i} className=\"h-9 w-24 rounded-xl bg-white/80 animate-pulse\" />\n            ))}\n          </div>\n        </div>\n\n        <div className=\"space-y-4\">\n          <RideCardSkeleton variant=\"active\" />\n          <RideCardSkeleton variant=\"expired\" />\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div\n      className={[\n        \"mx-auto w-full max-w-5xl space-y-6 transition-all duration-300 ease-out\",\n        entered ? \"opacity-100 translate-y-0\" : \"opacity-0 translate-y-1\",\n      ].join(\" \")}\n    >\n      {/* Header Card */}\n      <div className=\"bg-white rounded-lg border border-gray-200 p-6 shadow-sm\">\n        <div className=\"flex flex-col items-center text-center\">\n          <div className=\"h-16 w-16 rounded-full bg-gradient-to-br from-[#02665e]/10 to-[#014d47]/10 flex items-center justify-center mb-4\">\n            <Car className=\"h-8 w-8 text-[#02665e]\" />\n          </div>\n          <h1 className=\"text-2xl font-bold text-gray-900\">My Rides</h1>\n          <p className=\"text-sm text-gray-500 mt-1\">View all your transportation bookings</p>\n        </div>\n      </div>\n\n      {/* Filter tabs */}\n      <div className=\"flex justify-center\">\n        <div className=\"inline-flex items-center justify-center gap-2 rounded-2xl border border-slate-200 bg-slate-50 p-1 shadow-sm flex-wrap\">\n          {[\n            { key: \"all\" as const, label: \"All\", count: rides.length },\n            { key: \"scheduled\" as const, label: \"Scheduled\", count: scheduledCount },\n            { key: \"completed\" as const, label: \"Completed\", count: completedCount },\n            { key: \"expired\" as const, label: \"Expired\", count: expiredCount },\n          ].map((t) => {\n            const active = filter === t.key;\n            return (\n              <button\n                key={t.key}\n                type=\"button\"\n                aria-pressed={active}\n                onClick={() => setFilter(t.key)}\n                className={[\n                  \"inline-flex items-center gap-2 rounded-lg border px-4 py-2 text-sm font-semibold whitespace-nowrap transition-all duration-200\",\n                  active\n                    ? \"border-[#02665e] bg-[#02665e] text-white\"\n                    : \"border-gray-300 bg-white text-gray-700 hover:bg-gray-50 hover:border-gray-400\",\n                  \"active:scale-[0.98]\",\n                  \"focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[#02665e]/25 focus-visible:ring-offset-2\",\n                ].join(\" \")}\n              >\n                <span>{t.label}</span>\n                <span\n                  className={[\n                    \"inline-flex min-w-6 items-center justify-center rounded-full px-1.5 py-0.5 text-xs font-bold\",\n                    active ? \"bg-white/20 text-white\" : \"bg-gray-100 text-gray-600\",\n                  ].join(\" \")}\n                >\n                  {t.count}\n                </span>\n              </button>\n            );\n          })}\n        </div>\n      </div>\n\n      {filteredRides.length === 0 ? (\n        <div className=\"rounded-2xl border border-slate-200 bg-white p-10 text-center shadow-sm\">\n          <div className=\"mx-auto flex h-14 w-14 items-center justify-center rounded-2xl bg-[#02665e]/10 transition-transform duration-200 hover:scale-[1.03]\">\n            <Car className=\"h-7 w-7 text-[#02665e]\" />\n          </div>\n          <div className=\"mt-4 text-lg font-bold text-slate-900\">No rides found</div>\n          <div className=\"mt-1 text-sm text-slate-600\">\n            {filter === \"scheduled\"\n              ? \"You don't have any scheduled rides at the moment.\"\n              : filter === \"completed\"\n              ? \"You haven't completed any rides yet.\"\n              : filter === \"expired\"\n              ? \"You don't have any expired rides.\"\n              : \"When you book a ride, it will appear here for easy access.\"}\n          </div>\n          {filter === \"all\" && (\n            <div className=\"mt-6 flex justify-center\">\n              <Link\n                href=\"/public/properties\"\n                className=\"group no-underline inline-flex items-center justify-center gap-2 rounded-xl bg-[#02665e] px-5 py-3 text-sm font-semibold text-white shadow-sm hover:bg-[#014d47] hover:shadow-md active:scale-[0.99] transition\"\n              >\n                Book a ride\n                <ArrowRight className=\"h-4 w-4 transition-transform duration-200 group-hover:translate-x-0.5\" />\n              </Link>\n            </div>\n          )}\n        </div>\n      ) : (\n        <div className=\"space-y-4\">\n          {filteredRides.map((ride) => (\n            <div\n              key={ride.id}\n              className=\"bg-white rounded-2xl border border-slate-200 p-5 sm:p-6 shadow-sm transition-all duration-200 hover:shadow-md hover:-translate-y-[2px]\"\n            >\n              <div className=\"flex flex-col gap-4 lg:flex-row lg:items-start lg:justify-between\">\n                <div className=\"min-w-0 flex-1\">\n                  {/* Header with date and status */}\n                  <div className=\"flex flex-wrap items-center gap-2\">\n                    <div className=\"flex items-center gap-3\">\n                      <div className=\"p-2 bg-[#02665e]/10 rounded-xl\">\n                        <Car className=\"h-5 w-5 text-[#02665e]\" />\n                      </div>\n                      <div>\n                        <h3 className=\"text-lg font-bold text-slate-900\">\n                          {formatDate(ride.scheduledDate)}\n                        </h3>\n                        {ride.pickupTime && (\n                          <p className=\"text-sm text-slate-600\">\n                            Pickup: {formatTime(ride.pickupTime)}\n                          </p>\n                        )}\n                      </div>\n                    </div>\n                    <span\n                      className={`inline-flex items-center gap-1 rounded-full px-3 py-1 text-xs font-semibold ${\n                        ride.isValid\n                          ? \"bg-[#02665e]/10 text-[#02665e]\"\n                          : \"bg-slate-100 text-slate-700\"\n                      }`}\n                    >\n                      {ride.isValid ? (\n                        <CheckCircle className=\"h-4 w-4\" />\n                      ) : (\n                        <Calendar className=\"h-4 w-4 text-red-600\" />\n                      )}\n                      {getStatusLabel(ride)}\n                    </span>\n                  </div>\n\n                  {/* Route Information */}\n                  <div className=\"mt-4 grid grid-cols-1 gap-3 text-sm sm:grid-cols-2\">\n                    {/* From Location */}\n                    <div className=\"rounded-xl bg-slate-50/70 border border-slate-200 p-3\">\n                      <div className=\"flex items-center gap-2 text-xs font-medium text-slate-500 mb-1\">\n                        <MapPin className=\"h-3.5 w-3.5 text-[#02665e]\" />\n                        From\n                      </div>\n                      <div className=\"mt-0.5 font-semibold text-slate-900 line-clamp-2\">\n                        {formatLocation(ride, \"from\")}\n                      </div>\n                    </div>\n\n                    {/* To Location */}\n                    <div className=\"rounded-xl bg-slate-50/70 border border-slate-200 p-3\">\n                      <div className=\"flex items-center gap-2 text-xs font-medium text-slate-500 mb-1\">\n                        <Navigation className=\"h-3.5 w-3.5 text-[#02665e]\" />\n                        To\n                      </div>\n                      <div className=\"mt-0.5 font-semibold text-slate-900 line-clamp-2\">\n                        {formatLocation(ride, \"to\")}\n                      </div>\n                    </div>\n\n                    {/* Scheduled Date/Time */}\n                    <div className=\"rounded-xl bg-slate-50/70 border border-slate-200 p-3\">\n                      <div className=\"flex items-center gap-2 text-xs font-medium text-slate-500 mb-1\">\n                        <Calendar className=\"h-3.5 w-3.5 text-[#02665e]\" />\n                        Scheduled\n                      </div>\n                      <div className=\"mt-0.5 font-semibold text-slate-900\">\n                        {formatDate(ride.scheduledDate)}\n                      </div>\n                      {ride.pickupTime && (\n                        <div className=\"mt-1 text-xs text-slate-600\">\n                          {formatTime(ride.pickupTime)}\n                        </div>\n                      )}\n                    </div>\n\n                    {/* Amount */}\n                    {ride.amount && (\n                      <div className=\"rounded-xl bg-slate-50/70 border border-slate-200 p-3\">\n                        <div className=\"flex items-center gap-2 text-xs font-medium text-slate-500 mb-1\">\n                          <Star className=\"h-3.5 w-3.5 text-[#02665e]\" />\n                          Amount\n                        </div>\n                        <div className=\"mt-0.5 font-semibold text-slate-900\">\n                          {Number(ride.amount).toLocaleString(\"en-US\")} TZS\n                        </div>\n                      </div>\n                    )}\n                  </div>\n\n                  {/* Driver Information */}\n                  {ride.driver && (\n                    <div className=\"mt-4 rounded-xl bg-gradient-to-r from-[#02665e]/5 to-transparent border border-[#02665e]/10 p-3\">\n                      <div className=\"flex items-center gap-3\">\n                        <div className=\"h-10 w-10 rounded-full bg-[#02665e]/10 flex items-center justify-center flex-shrink-0\">\n                          <User className=\"h-5 w-5 text-[#02665e]\" />\n                        </div>\n                        <div className=\"min-w-0 flex-1\">\n                          <div className=\"text-sm font-semibold text-slate-900\">\n                            {ride.driver.name}\n                          </div>\n                          {ride.driver.phone && (\n                            <div className=\"flex items-center gap-1 mt-0.5 text-xs text-slate-600\">\n                              <Phone className=\"h-3 w-3\" />\n                              {ride.driver.phone}\n                            </div>\n                          )}\n                        </div>\n                        {ride.rating && (\n                          <div className=\"flex items-center gap-1 bg-white rounded-full px-2.5 py-1 border border-slate-200\">\n                            <Star className=\"h-3.5 w-3.5 text-yellow-500 fill-yellow-500\" />\n                            <span className=\"text-xs font-semibold text-slate-900\">\n                              {ride.rating.toFixed(1)}\n                            </span>\n                          </div>\n                        )}\n                      </div>\n                    </div>\n                  )}\n\n                  {/* Action Buttons */}\n                  <div className=\"mt-4 flex flex-wrap items-center gap-2\">\n                    <Link\n                      href={`/account/rides/${ride.id}`}\n                      className=\"inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-[#02665e] text-white text-sm font-semibold hover:bg-[#014e47] transition-colors shadow-sm hover:shadow-md\"\n                    >\n                      <Eye className=\"w-4 h-4\" />\n                      View Details\n                    </Link>\n                  </div>\n                </div>\n              </div>\n            </div>\n          ))}\n        </div>\n      )}\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\account\\saved\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Calendar' is defined but never used. Allowed unused vars must match /^_/u.","line":7,"column":55,"nodeType":"Identifier","messageId":"unusedVar","endLine":7,"endColumn":63,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Calendar"},"fix":{"range":[207,217],"text":""},"desc":"Remove unused variable \"Calendar\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'formatDate' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":73,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":73,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useEffect, useState } from \"react\";\r\nimport axios from \"axios\";\r\nimport Link from \"next/link\";\r\nimport Image from \"next/image\";\r\nimport { Heart, Share2, MapPin, ArrowLeft, ImageIcon, Calendar } from \"lucide-react\";\r\nimport VerifiedIcon from \"../../../components/VerifiedIcon\";\r\nimport LogoSpinner from \"@/components/LogoSpinner\";\r\n\r\nconst api = axios.create({ baseURL: \"\", withCredentials: true });\r\n\r\ntype SavedProperty = {\r\n  id: number;\r\n  slug: string;\r\n  title: string;\r\n  location: string;\r\n  primaryImage: string | null;\r\n  basePrice: number | null;\r\n  currency: string | null;\r\n  savedAt: string;\r\n  sharedAt?: string | null;\r\n};\r\n\r\nexport default function SavedPropertiesPage() {\r\n  const [savedProperties, setSavedProperties] = useState<SavedProperty[]>([]);\r\n  const [sharedProperties, setSharedProperties] = useState<SavedProperty[]>([]);\r\n  const [loading, setLoading] = useState(true);\r\n  const [activeTab, setActiveTab] = useState<\"saved\" | \"shared\">(\"saved\");\r\n\r\n  useEffect(() => {\r\n    loadSavedProperties();\r\n  }, []);\r\n\r\n  const loadSavedProperties = async () => {\r\n    try {\r\n      setLoading(true);\r\n      const [savedRes, sharedRes] = await Promise.all([\r\n        api.get(\"/api/customer/saved-properties\").catch(() => ({ data: { ok: true, items: [], total: 0 } })),\r\n        api.get(\"/api/customer/saved-properties/shared\").catch(() => ({ data: { ok: true, items: [], total: 0 } })),\r\n      ]);\r\n      \r\n      setSavedProperties(savedRes.data?.items || savedRes.data?.data?.items || []);\r\n      setSharedProperties(sharedRes.data?.items || sharedRes.data?.data?.items || []);\r\n    } catch (err) {\r\n      console.error(\"Failed to load saved properties\", err);\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  const handleUnsave = async (propertyId: number) => {\r\n    try {\r\n      await api.delete(`/api/customer/saved-properties/${propertyId}`);\r\n      setSavedProperties((prev) => prev.filter((p) => p.id !== propertyId));\r\n    } catch (err) {\r\n      console.error(\"Failed to unsave property\", err);\r\n      alert(\"Failed to remove property from saved list\");\r\n    }\r\n  };\r\n\r\n  const formatPrice = (price: number | null, currency: string | null) => {\r\n    if (!price) return \"Price on request\";\r\n    const formatted = new Intl.NumberFormat(\"en-TZ\", {\r\n      style: \"currency\",\r\n      currency: currency || \"TZS\",\r\n      minimumFractionDigits: 0,\r\n    }).format(price);\r\n    // Remove currency symbol if it's duplicated (some locales add it)\r\n    return formatted.replace(/TZS\\s*TZS/, \"TZS\").replace(/TSh\\s*TSh/, \"TSh\");\r\n  };\r\n\r\n  const formatDate = (dateString: string) => {\r\n    const date = new Date(dateString);\r\n    const now = new Date();\r\n    const diffTime = Math.abs(now.getTime() - date.getTime());\r\n    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));\r\n    \r\n    if (diffDays === 0) return \"Today\";\r\n    if (diffDays === 1) return \"Yesterday\";\r\n    if (diffDays < 7) return `${diffDays} days ago`;\r\n    if (diffDays < 30) return `${Math.floor(diffDays / 7)} weeks ago`;\r\n    if (diffDays < 365) return `${Math.floor(diffDays / 30)} months ago`;\r\n    return date.toLocaleDateString(\"en-US\", { month: \"short\", day: \"numeric\", year: \"numeric\" });\r\n  };\r\n\r\n  return (\r\n    <div className=\"w-full max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 sm:py-8\">\r\n      {/* Header */}\r\n      <div className=\"mb-8\">\r\n        <Link\r\n          href=\"/account\"\r\n          className=\"inline-flex items-center gap-2 text-sm font-medium text-slate-600 hover:text-[#02665e] transition-all duration-200 mb-6 group\"\r\n        >\r\n          <ArrowLeft className=\"w-4 h-4 transition-transform duration-200 group-hover:-translate-x-1\" />\r\n          Back to Account\r\n        </Link>\r\n        <div className=\"space-y-2 text-center\">\r\n          <h1 className=\"text-3xl sm:text-4xl font-bold text-slate-900 tracking-tight\">Saved & Shared Properties</h1>\r\n          <p className=\"text-sm sm:text-base text-slate-600\">Manage your favorite properties and shared listings</p>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Modern Tabs */}\r\n      <div className=\"flex gap-3 mb-8 p-1 bg-slate-50 rounded-xl border border-slate-200 w-fit mx-auto\">\r\n        <button\r\n          onClick={() => setActiveTab(\"saved\")}\r\n          className={`relative px-5 py-2.5 text-sm font-semibold rounded-lg transition-all duration-300 ease-in-out ${\r\n            activeTab === \"saved\"\r\n              ? \"bg-white text-[#02665e] shadow-sm\"\r\n              : \"text-slate-600 hover:text-slate-900\"\r\n          }`}\r\n        >\r\n          <div className=\"flex items-center gap-2\">\r\n            <Heart className={`w-4 h-4 transition-all duration-200 ${activeTab === \"saved\" ? \"fill-current\" : \"\"}`} />\r\n            <span>Saved</span>\r\n            <span className={`px-2 py-0.5 rounded-full text-xs font-medium ${\r\n              activeTab === \"saved\" \r\n                ? \"bg-[#02665e]/10 text-[#02665e]\" \r\n                : \"bg-slate-200 text-slate-600\"\r\n            }`}>\r\n              {savedProperties.length}\r\n            </span>\r\n          </div>\r\n        </button>\r\n        <button\r\n          onClick={() => setActiveTab(\"shared\")}\r\n          className={`relative px-5 py-2.5 text-sm font-semibold rounded-lg transition-all duration-300 ease-in-out ${\r\n            activeTab === \"shared\"\r\n              ? \"bg-white text-[#02665e] shadow-sm\"\r\n              : \"text-slate-600 hover:text-slate-900\"\r\n          }`}\r\n        >\r\n          <div className=\"flex items-center gap-2\">\r\n            <Share2 className=\"w-4 h-4 transition-all duration-200\" />\r\n            <span>Shared</span>\r\n            <span className={`px-2 py-0.5 rounded-full text-xs font-medium ${\r\n              activeTab === \"shared\" \r\n                ? \"bg-[#02665e]/10 text-[#02665e]\" \r\n                : \"bg-slate-200 text-slate-600\"\r\n            }`}>\r\n              {sharedProperties.length}\r\n            </span>\r\n          </div>\r\n        </button>\r\n      </div>\r\n\r\n      {/* Content */}\r\n      {loading ? (\r\n        <div className=\"flex flex-col items-center justify-center py-20\">\r\n          <LogoSpinner size=\"lg\" className=\"mb-4\" ariaLabel=\"Loading your properties\" />\r\n          <p className=\"text-sm text-slate-600\">Loading your properties...</p>\r\n        </div>\r\n      ) : activeTab === \"saved\" ? (\r\n        savedProperties.length === 0 ? (\r\n          <div className=\"text-center py-16 sm:py-20 px-6 rounded-2xl border-2 border-dashed border-slate-200 bg-gradient-to-br from-slate-50 to-white\">\r\n            <div className=\"inline-flex items-center justify-center w-20 h-20 rounded-full bg-slate-100 mb-6\">\r\n              <Heart className=\"w-10 h-10 text-slate-400\" />\r\n            </div>\r\n            <h3 className=\"text-xl font-bold text-slate-900 mb-2\">No saved properties yet</h3>\r\n            <p className=\"text-sm sm:text-base text-slate-600 mb-8 max-w-md mx-auto\">\r\n              Start exploring and save properties you like! They'll appear here for easy access.\r\n            </p>\r\n            <Link\r\n              href=\"/public/properties\"\r\n              className=\"inline-flex items-center gap-2 px-6 py-3 bg-[#02665e] text-white font-semibold rounded-xl hover:bg-[#014e47] shadow-md hover:shadow-lg transition-all duration-200 transform hover:-translate-y-0.5\"\r\n            >\r\n              Browse Properties\r\n              <ArrowLeft className=\"w-4 h-4 rotate-180\" />\r\n            </Link>\r\n          </div>\r\n        ) : (\r\n          <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5 sm:gap-6\">\r\n            {savedProperties.map((property) => {\r\n              const PhotoPlaceholder = () => (\r\n                <div className=\"absolute inset-0\">\r\n                  <div className=\"absolute inset-0 bg-[radial-gradient(circle_at_30%_20%,rgba(2,102,94,0.18),transparent_55%),radial-gradient(circle_at_75%_85%,rgba(2,132,199,0.12),transparent_55%),linear-gradient(135deg,#f8fafc,#e2e8f0)]\" />\r\n                  <div className=\"absolute inset-0 bg-gradient-to-t from-black/0 via-black/0 to-white/35\" />\r\n                  <div className=\"absolute inset-0 shadow-[inset_0_0_0_1px_rgba(15,23,42,0.06)]\" />\r\n                  <div className=\"absolute inset-0 flex flex-col items-center justify-center text-slate-700\">\r\n                    <div className=\"h-12 w-12 rounded-2xl bg-white/85 border border-slate-200 shadow-sm flex items-center justify-center\">\r\n                      <ImageIcon className=\"w-6 h-6 text-slate-500\" aria-hidden />\r\n                    </div>\r\n                    <div className=\"mt-2 text-sm font-semibold\">Photo preview</div>\r\n                    <div className=\"text-xs text-slate-500\">Approved photos will appear here</div>\r\n                  </div>\r\n                </div>\r\n              );\r\n\r\n              return (\r\n                <div\r\n                  key={property.id}\r\n                  className=\"group relative\"\r\n                >\r\n                  <Link\r\n                    href={`/public/properties/${property.slug}`}\r\n                    className=\"no-underline text-slate-900\"\r\n                    aria-label={`View ${property.title}`}\r\n                  >\r\n                    <div className=\"rounded-2xl border border-slate-200 bg-white shadow-sm hover:shadow-md transition-shadow\">\r\n                      {/* Title (above image) */}\r\n                      <div className=\"px-4 pt-4\">\r\n                        <div className=\"flex items-start justify-between gap-3\">\r\n                          <div className=\"text-base font-bold text-slate-900 truncate flex-1 min-w-0\">\r\n                            {property.title}\r\n                          </div>\r\n                          <button\r\n                            onClick={(e) => {\r\n                              e.preventDefault();\r\n                              e.stopPropagation();\r\n                              handleUnsave(property.id);\r\n                            }}\r\n                            className=\"flex-shrink-0 p-1.5 rounded-lg hover:bg-rose-50 text-rose-500 hover:text-rose-600 transition-all duration-200\"\r\n                            title=\"Remove from saved\"\r\n                            aria-label=\"Remove from saved\"\r\n                          >\r\n                            <Heart className=\"w-4 h-4 fill-current\" />\r\n                          </button>\r\n                        </div>\r\n                      </div>\r\n\r\n                      {/* Image */}\r\n                      <div className=\"px-4 mt-3\">\r\n                        <div className=\"relative aspect-square bg-slate-100 rounded-2xl overflow-hidden\">\r\n                          {property.primaryImage ? (\r\n                            <Image\r\n                              src={property.primaryImage}\r\n                              alt=\"\"\r\n                              fill\r\n                              sizes=\"(min-width: 1280px) 25vw, (min-width: 1024px) 33vw, (min-width: 640px) 50vw, 100vw\"\r\n                              className=\"object-cover\"\r\n                            />\r\n                          ) : (\r\n                            <PhotoPlaceholder />\r\n                          )}\r\n\r\n                          {/* Verification badge (top-right) */}\r\n                          <VerifiedIcon />\r\n                        </div>\r\n                      </div>\r\n\r\n                      {/* Below image: location then price */}\r\n                      <div className=\"p-4\">\r\n                        <div className=\"flex flex-col sm:flex-row sm:items-start sm:justify-between gap-2 sm:gap-3\">\r\n                          <div className=\"min-w-0\">\r\n                            <div className=\"flex items-center gap-1.5 text-xs text-slate-600\">\r\n                              <MapPin className=\"w-3.5 h-3.5\" />\r\n                              <span className=\"truncate\">{property.location || \"—\"}</span>\r\n                            </div>\r\n                          </div>\r\n                          <div className=\"sm:text-right flex-shrink-0\">\r\n                            {property.basePrice ? (\r\n                              <>\r\n                                <div className=\"text-sm font-bold text-slate-900\">\r\n                                  {formatPrice(property.basePrice, property.currency)}\r\n                                </div>\r\n                                <div className=\"text-[11px] text-slate-500\">per night</div>\r\n                              </>\r\n                            ) : (\r\n                              <div className=\"text-sm font-bold text-slate-500\">Price on request</div>\r\n                            )}\r\n                          </div>\r\n                        </div>\r\n\r\n                        <div className=\"mt-4\">\r\n                          <span className=\"inline-flex items-center justify-center w-full rounded-xl bg-[#02665e] text-white py-2.5 text-sm font-semibold transition-colors group-hover:bg-[#014e47]\">\r\n                            View details\r\n                          </span>\r\n                        </div>\r\n                      </div>\r\n                    </div>\r\n                  </Link>\r\n                </div>\r\n              );\r\n            })}\r\n          </div>\r\n        )\r\n      ) : (\r\n        sharedProperties.length === 0 ? (\r\n          <div className=\"text-center py-16 sm:py-20 px-6 rounded-2xl border-2 border-dashed border-slate-200 bg-gradient-to-br from-slate-50 to-white\">\r\n            <div className=\"inline-flex items-center justify-center w-20 h-20 rounded-full bg-slate-100 mb-6\">\r\n              <Share2 className=\"w-10 h-10 text-slate-400\" />\r\n            </div>\r\n            <h3 className=\"text-xl font-bold text-slate-900 mb-2\">No shared properties yet</h3>\r\n            <p className=\"text-sm sm:text-base text-slate-600 max-w-md mx-auto\">\r\n              Properties you share with others will appear here for easy reference.\r\n            </p>\r\n          </div>\r\n        ) : (\r\n          <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5 sm:gap-6\">\r\n            {sharedProperties.map((property) => {\r\n              const PhotoPlaceholder = () => (\r\n                <div className=\"absolute inset-0\">\r\n                  <div className=\"absolute inset-0 bg-[radial-gradient(circle_at_30%_20%,rgba(2,102,94,0.18),transparent_55%),radial-gradient(circle_at_75%_85%,rgba(2,132,199,0.12),transparent_55%),linear-gradient(135deg,#f8fafc,#e2e8f0)]\" />\r\n                  <div className=\"absolute inset-0 bg-gradient-to-t from-black/0 via-black/0 to-white/35\" />\r\n                  <div className=\"absolute inset-0 shadow-[inset_0_0_0_1px_rgba(15,23,42,0.06)]\" />\r\n                  <div className=\"absolute inset-0 flex flex-col items-center justify-center text-slate-700\">\r\n                    <div className=\"h-12 w-12 rounded-2xl bg-white/85 border border-slate-200 shadow-sm flex items-center justify-center\">\r\n                      <ImageIcon className=\"w-6 h-6 text-slate-500\" aria-hidden />\r\n                    </div>\r\n                    <div className=\"mt-2 text-sm font-semibold\">Photo preview</div>\r\n                    <div className=\"text-xs text-slate-500\">Approved photos will appear here</div>\r\n                  </div>\r\n                </div>\r\n              );\r\n\r\n              return (\r\n                <div\r\n                  key={property.id}\r\n                  className=\"group relative\"\r\n                >\r\n                  <Link\r\n                    href={`/public/properties/${property.slug}`}\r\n                    className=\"no-underline text-slate-900\"\r\n                    aria-label={`View ${property.title}`}\r\n                  >\r\n                    <div className=\"rounded-2xl border border-slate-200 bg-white shadow-sm hover:shadow-md transition-shadow\">\r\n                      {/* Title (above image) */}\r\n                      <div className=\"px-4 pt-4\">\r\n                        <div className=\"text-base font-bold text-slate-900 truncate\">\r\n                          {property.title}\r\n                        </div>\r\n                      </div>\r\n\r\n                      {/* Image */}\r\n                      <div className=\"px-4 mt-3\">\r\n                        <div className=\"relative aspect-square bg-slate-100 rounded-2xl overflow-hidden\">\r\n                          {property.primaryImage ? (\r\n                            <Image\r\n                              src={property.primaryImage}\r\n                              alt=\"\"\r\n                              fill\r\n                              sizes=\"(min-width: 1280px) 25vw, (min-width: 1024px) 33vw, (min-width: 640px) 50vw, 100vw\"\r\n                              className=\"object-cover\"\r\n                            />\r\n                          ) : (\r\n                            <PhotoPlaceholder />\r\n                          )}\r\n\r\n                          {/* Verification badge (top-right) */}\r\n                          <VerifiedIcon />\r\n                        </div>\r\n                      </div>\r\n\r\n                      {/* Below image: location then price */}\r\n                      <div className=\"p-4\">\r\n                        <div className=\"flex flex-col sm:flex-row sm:items-start sm:justify-between gap-2 sm:gap-3\">\r\n                          <div className=\"min-w-0\">\r\n                            <div className=\"flex items-center gap-1.5 text-xs text-slate-600\">\r\n                              <MapPin className=\"w-3.5 h-3.5\" />\r\n                              <span className=\"truncate\">{property.location || \"—\"}</span>\r\n                            </div>\r\n                          </div>\r\n                          <div className=\"sm:text-right flex-shrink-0\">\r\n                            {property.basePrice ? (\r\n                              <>\r\n                                <div className=\"text-sm font-bold text-slate-900\">\r\n                                  {formatPrice(property.basePrice, property.currency)}\r\n                                </div>\r\n                                <div className=\"text-[11px] text-slate-500\">per night</div>\r\n                              </>\r\n                            ) : (\r\n                              <div className=\"text-sm font-bold text-slate-500\">Price on request</div>\r\n                            )}\r\n                          </div>\r\n                        </div>\r\n\r\n                        <div className=\"mt-4\">\r\n                          <span className=\"inline-flex items-center justify-center w-full rounded-xl bg-[#02665e] text-white py-2.5 text-sm font-semibold transition-colors group-hover:bg-[#014e47]\">\r\n                            View details\r\n                          </span>\r\n                        </div>\r\n                      </div>\r\n                    </div>\r\n                  </Link>\r\n                </div>\r\n              );\r\n            })}\r\n          </div>\r\n        )\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\account\\security\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\api\\careers\\apply\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'applicationData' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":55,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":55,"endColumn":26}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\r\n\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    const formData = await request.formData();\r\n    \r\n    const jobId = formData.get('jobId') as string;\r\n    const fullName = formData.get('fullName') as string;\r\n    const email = formData.get('email') as string;\r\n    const phone = formData.get('phone') as string;\r\n    const coverLetter = formData.get('coverLetter') as string;\r\n    const resume = formData.get('resume') as File | null;\r\n    const portfolio = formData.get('portfolio') as string | null;\r\n    const linkedIn = formData.get('linkedIn') as string | null;\r\n    const referredBy = formData.get('referredBy') as string | null;\r\n    const agentApplicationData = formData.get('agentApplicationData') as string | null;\r\n\r\n    // Validate required fields\r\n    if (!jobId || !fullName || !email || !phone || !coverLetter) {\r\n      return NextResponse.json(\r\n        { error: 'Missing required fields: jobId, fullName, email, phone, and coverLetter are required' },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Validate email format\r\n    const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\r\n    if (!emailRegex.test(email)) {\r\n      return NextResponse.json(\r\n        { error: 'Invalid email format' },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Validate resume if provided\r\n    if (resume) {\r\n      const maxSize = 5 * 1024 * 1024; // 5MB\r\n      if (resume.size > maxSize) {\r\n        return NextResponse.json(\r\n          { error: 'Resume file size must be less than 5MB' },\r\n          { status: 400 }\r\n        );\r\n      }\r\n\r\n      const allowedTypes = ['application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];\r\n      if (!allowedTypes.includes(resume.type)) {\r\n        return NextResponse.json(\r\n          { error: 'Resume must be a PDF or Word document' },\r\n          { status: 400 }\r\n        );\r\n      }\r\n    }\r\n\r\n    // Prepare application data\r\n    const applicationData = {\r\n      jobId,\r\n      fullName,\r\n      email,\r\n      phone,\r\n      coverLetter,\r\n      portfolio: portfolio || null,\r\n      linkedIn: linkedIn || null,\r\n      referredBy: referredBy || null,\r\n      submittedAt: new Date().toISOString(),\r\n      resumeFileName: resume?.name || null,\r\n      resumeSize: resume?.size || null,\r\n      resumeType: resume?.type || null,\r\n    };\r\n\r\n    // Forward to backend API\r\n    const base = process.env.NEXT_PUBLIC_API_URL || 'http://127.0.0.1:4000';\r\n    const backendUrl = base.replace(/\\/$/, '') + '/api/careers/apply';\r\n\r\n    try {\r\n      // Create FormData for backend\r\n      const backendFormData = new FormData();\r\n      backendFormData.append('jobId', jobId);\r\n      backendFormData.append('fullName', fullName);\r\n      backendFormData.append('email', email);\r\n      backendFormData.append('phone', phone);\r\n      backendFormData.append('coverLetter', coverLetter);\r\n      if (resume) {\r\n        backendFormData.append('resume', resume);\r\n      }\r\n      if (portfolio) backendFormData.append('portfolio', portfolio);\r\n      if (linkedIn) backendFormData.append('linkedIn', linkedIn);\r\n      if (referredBy) backendFormData.append('referredBy', referredBy);\r\n      if (agentApplicationData) backendFormData.append('agentApplicationData', agentApplicationData);\r\n\r\n      const backendResponse = await fetch(backendUrl, {\r\n        method: 'POST',\r\n        body: backendFormData,\r\n      });\r\n\r\n      if (backendResponse.ok) {\r\n        const backendData = await backendResponse.json();\r\n        return NextResponse.json({\r\n          success: true,\r\n          message: backendData.message || 'Application submitted successfully',\r\n          applicationId: backendData.applicationId || null,\r\n        });\r\n      } else {\r\n        const errorData = await backendResponse.json().catch(() => ({}));\r\n        return NextResponse.json(\r\n          { error: errorData.error || `Backend API error: ${backendResponse.status}` },\r\n          { status: backendResponse.status }\r\n        );\r\n      }\r\n    } catch (backendError: any) {\r\n      console.error('Backend API error:', backendError);\r\n      return NextResponse.json(\r\n        { error: backendError.message || 'Failed to connect to backend API. Please try again or email careers@nolsaf.com directly.' },\r\n        { status: 500 }\r\n      );\r\n    }\r\n\r\n  } catch (error: any) {\r\n    console.error('Career application error:', error);\r\n    return NextResponse.json(\r\n      { error: error.message || 'Failed to process application. Please try again or email careers@nolsaf.com directly.' },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\api\\voice-filter\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\cancellation-policy\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'isAdmin' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":110,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":110,"endColumn":16}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport Terms from \"@/components/Terms\";\r\nimport { CANCELLATION_POLICY_LAST_UPDATED, CANCELLATION_POLICY_SECTIONS } from \"@/components/cancellationPolicyContent\";\r\nimport PublicHeader from \"@/components/PublicHeader\";\r\nimport PublicFooter from \"@/components/PublicFooter\";\r\nimport SiteHeader from \"@/components/SiteHeader\";\r\nimport OwnerSiteHeader from \"@/components/OwnerSiteHeader\";\r\nimport DriverSiteHeader from \"@/components/DriverSiteHeader\";\r\nimport SiteFooter from \"@/components/SiteFooter\";\r\nimport LayoutFrame from \"@/components/LayoutFrame\";\r\nimport { XCircle } from \"lucide-react\";\r\nimport { useEffect, useState } from \"react\";\r\nimport { usePathname } from \"next/navigation\";\r\n\r\nfunction getCookie(name: string): string | null {\r\n  if (typeof document === 'undefined') return null;\r\n  const value = `; ${document.cookie}`;\r\n  const parts = value.split(`; ${name}=`);\r\n  if (parts.length === 2) return parts.pop()?.split(';').shift() || null;\r\n  return null;\r\n}\r\n\r\nexport default function CancellationPolicyPage() {\r\n  const pathname = usePathname();\r\n  const [userRole, setUserRole] = useState<\"ADMIN\" | \"OWNER\" | \"DRIVER\" | null>(null);\r\n  const [isLoading, setIsLoading] = useState(true);\r\n  const [isPublicContext, setIsPublicContext] = useState<boolean | null>(null);\r\n\r\n  useEffect(() => {\r\n    // PRIORITY 1: Check sessionStorage for navigation context (set by headers/footers)\r\n    // This is the most reliable indicator of where the user came from\r\n    let navigationContext: 'public' | 'owner' | 'driver' | 'admin' | null = null;\r\n    if (typeof window !== 'undefined') {\r\n      navigationContext = sessionStorage.getItem('navigationContext') as 'public' | 'owner' | 'driver' | 'admin' | null;\r\n    }\r\n\r\n    // If we have navigation context from sessionStorage, use it (this takes priority)\r\n    if (navigationContext) {\r\n      if (navigationContext === 'public') {\r\n        setIsPublicContext(true);\r\n        setUserRole(null);\r\n        setIsLoading(false);\r\n        return;\r\n      } else {\r\n        setIsPublicContext(false);\r\n        setUserRole(navigationContext.toUpperCase() as \"ADMIN\" | \"OWNER\" | \"DRIVER\");\r\n        setIsLoading(false);\r\n        return;\r\n      }\r\n    }\r\n\r\n    // PRIORITY 2: Check referrer to determine context\r\n    // If coming from a public route, use public layout regardless of cookie\r\n    let isFromPublicRoute = false;\r\n    if (typeof document !== 'undefined') {\r\n      const referrer = document.referrer;\r\n      const origin = window.location.origin;\r\n      isFromPublicRoute = !!referrer && (\r\n        referrer.includes('/public') || \r\n        referrer === origin || \r\n        referrer === origin + '/' ||\r\n        (!referrer.includes('/owner') && !referrer.includes('/driver') && !referrer.includes('/admin') && referrer.startsWith(origin))\r\n      );\r\n    }\r\n\r\n    // If coming from a public route, treat as public (even if they have a role cookie)\r\n    if (isFromPublicRoute) {\r\n      setIsPublicContext(true);\r\n      setUserRole(null);\r\n      setIsLoading(false);\r\n      return;\r\n    }\r\n\r\n    // PRIORITY 3: Check if user is authenticated via cookie\r\n    // Only use this if we don't have public context from above\r\n    const role = getCookie('role') as \"ADMIN\" | \"OWNER\" | \"DRIVER\" | null;\r\n    if (role) {\r\n      setIsPublicContext(false);\r\n      setUserRole(role);\r\n      setIsLoading(false);\r\n      return;\r\n    }\r\n    \r\n    // PRIORITY 4: Check pathname as final fallback to determine context\r\n    if (pathname?.includes('/driver')) {\r\n      setIsPublicContext(false);\r\n      setUserRole('DRIVER');\r\n    } else if (pathname?.includes('/owner')) {\r\n      setIsPublicContext(false);\r\n      setUserRole('OWNER');\r\n    } else if (pathname?.includes('/admin')) {\r\n      setIsPublicContext(false);\r\n      setUserRole('ADMIN');\r\n    } else {\r\n      // Default to public context if no indicators\r\n      setIsPublicContext(true);\r\n      setUserRole(null);\r\n    }\r\n    \r\n    setIsLoading(false);\r\n  }, [pathname]);\r\n\r\n  // Determine which header and footer to use\r\n  // Prioritize public context if detected, otherwise use authentication status\r\n  const shouldUsePublicLayout = isPublicContext === true || (isPublicContext === null && userRole === null);\r\n  const isAuthenticated = !shouldUsePublicLayout && userRole !== null;\r\n  const isDriver = userRole === \"DRIVER\";\r\n  const isOwner = userRole === \"OWNER\";\r\n  const isAdmin = userRole === \"ADMIN\";\r\n\r\n  // Show loading state briefly to avoid flash\r\n  if (isLoading || isPublicContext === null) {\r\n    return (\r\n      <>\r\n        <PublicHeader />\r\n        <main className=\"min-h-screen bg-white text-slate-900\">\r\n          <div className=\"public-container py-10\">\r\n            <div className=\"text-center\">Loading...</div>\r\n          </div>\r\n        </main>\r\n        <PublicFooter withRail={false} />\r\n      </>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <>\r\n      {shouldUsePublicLayout ? (\r\n        <PublicHeader />\r\n      ) : isAuthenticated ? (\r\n        isDriver ? (\r\n          <DriverSiteHeader />\r\n        ) : isOwner ? (\r\n          <OwnerSiteHeader />\r\n        ) : (\r\n          <SiteHeader role=\"ADMIN\" />\r\n        )\r\n      ) : (\r\n        <PublicHeader />\r\n      )}\r\n      \r\n      <main className=\"min-h-screen bg-white text-slate-900\">\r\n        {/* Layout edge markers (left/right) to indicate content boundaries */}\r\n        <LayoutFrame heightVariant=\"sm\" topVariant=\"sm\" colorVariant=\"muted\" variant=\"solid\" />\r\n        \r\n        {/* Hero Image Section */}\r\n        <section className=\"relative h-48 md:h-64 lg:h-80 overflow-hidden\">\r\n          <div className=\"public-container h-full relative\">\r\n            <div className=\"absolute inset-0 bg-[url('/assets/nolsaf%20picture%201.jpg')] bg-cover bg-center rounded-lg\" />\r\n            <div className=\"absolute inset-0 bg-gradient-to-b from-black/40 via-black/20 to-transparent rounded-lg\" />\r\n            <div className=\"relative h-full flex flex-col items-center justify-center\">\r\n              <XCircle size={64} className=\"text-white mb-4 drop-shadow-lg\" strokeWidth={1.5} />\r\n              <h1 className=\"text-3xl md:text-4xl lg:text-5xl font-bold text-white text-center px-4 drop-shadow-lg\">\r\n                Cancellation Policy\r\n              </h1>\r\n            </div>\r\n          </div>\r\n        </section>\r\n        \r\n        <section className=\"relative bg-[#f7f9fb] pt-6 sm:pt-8 md:pt-10 pb-4 sm:pb-6 md:pb-10 overflow-x-hidden\">\r\n          <div className=\"public-container\">\r\n            <div className=\"w-full bg-white rounded-lg shadow-sm border border-gray-100 p-4 sm:p-6 md:p-10 lg:p-12 box-border overflow-x-hidden\">\r\n              <Terms headline=\"\" lastUpdated={CANCELLATION_POLICY_LAST_UPDATED} sections={CANCELLATION_POLICY_SECTIONS} />\r\n            </div>\r\n          </div>\r\n        </section>\r\n      </main>\r\n      \r\n      {shouldUsePublicLayout ? (\r\n        <PublicFooter withRail={false} />\r\n      ) : isAuthenticated ? (\r\n        <SiteFooter withRail={false} topSeparator={true} />\r\n      ) : (\r\n        <PublicFooter withRail={false} />\r\n      )}\r\n    </>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\careers\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\cookies-policy\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'isAdmin' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":110,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":110,"endColumn":16}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport Terms from \"@/components/Terms\";\r\nimport { COOKIES_LAST_UPDATED, COOKIES_SECTIONS } from \"@/components/cookiesContent\";\r\nimport PublicHeader from \"@/components/PublicHeader\";\r\nimport PublicFooter from \"@/components/PublicFooter\";\r\nimport SiteHeader from \"@/components/SiteHeader\";\r\nimport OwnerSiteHeader from \"@/components/OwnerSiteHeader\";\r\nimport DriverSiteHeader from \"@/components/DriverSiteHeader\";\r\nimport SiteFooter from \"@/components/SiteFooter\";\r\nimport LayoutFrame from \"@/components/LayoutFrame\";\r\nimport { Cookie } from \"lucide-react\";\r\nimport { useEffect, useState } from \"react\";\r\nimport { usePathname } from \"next/navigation\";\r\n\r\nfunction getCookie(name: string): string | null {\r\n  if (typeof document === 'undefined') return null;\r\n  const value = `; ${document.cookie}`;\r\n  const parts = value.split(`; ${name}=`);\r\n  if (parts.length === 2) return parts.pop()?.split(';').shift() || null;\r\n  return null;\r\n}\r\n\r\nexport default function CookiesPolicyPage() {\r\n  const pathname = usePathname();\r\n  const [userRole, setUserRole] = useState<\"ADMIN\" | \"OWNER\" | \"DRIVER\" | null>(null);\r\n  const [isLoading, setIsLoading] = useState(true);\r\n  const [isPublicContext, setIsPublicContext] = useState<boolean | null>(null);\r\n\r\n  useEffect(() => {\r\n    // PRIORITY 1: Check sessionStorage for navigation context (set by headers/footers)\r\n    // This is the most reliable indicator of where the user came from\r\n    let navigationContext: 'public' | 'owner' | 'driver' | 'admin' | null = null;\r\n    if (typeof window !== 'undefined') {\r\n      navigationContext = sessionStorage.getItem('navigationContext') as 'public' | 'owner' | 'driver' | 'admin' | null;\r\n    }\r\n\r\n    // If we have navigation context from sessionStorage, use it (this takes priority)\r\n    if (navigationContext) {\r\n      if (navigationContext === 'public') {\r\n        setIsPublicContext(true);\r\n        setUserRole(null);\r\n        setIsLoading(false);\r\n        return;\r\n      } else {\r\n        setIsPublicContext(false);\r\n        setUserRole(navigationContext.toUpperCase() as \"ADMIN\" | \"OWNER\" | \"DRIVER\");\r\n        setIsLoading(false);\r\n        return;\r\n      }\r\n    }\r\n\r\n    // PRIORITY 2: Check referrer to determine context\r\n    // If coming from a public route, use public layout regardless of cookie\r\n    let isFromPublicRoute = false;\r\n    if (typeof document !== 'undefined') {\r\n      const referrer = document.referrer;\r\n      const origin = window.location.origin;\r\n      isFromPublicRoute = !!referrer && (\r\n        referrer.includes('/public') || \r\n        referrer === origin || \r\n        referrer === origin + '/' ||\r\n        (!referrer.includes('/owner') && !referrer.includes('/driver') && !referrer.includes('/admin') && referrer.startsWith(origin))\r\n      );\r\n    }\r\n\r\n    // If coming from a public route, treat as public (even if they have a role cookie)\r\n    if (isFromPublicRoute) {\r\n      setIsPublicContext(true);\r\n      setUserRole(null);\r\n      setIsLoading(false);\r\n      return;\r\n    }\r\n\r\n    // PRIORITY 3: Check if user is authenticated via cookie\r\n    // Only use this if we don't have public context from above\r\n    const role = getCookie('role') as \"ADMIN\" | \"OWNER\" | \"DRIVER\" | null;\r\n    if (role) {\r\n      setIsPublicContext(false);\r\n      setUserRole(role);\r\n      setIsLoading(false);\r\n      return;\r\n    }\r\n    \r\n    // PRIORITY 4: Check pathname as final fallback to determine context\r\n    if (pathname?.includes('/driver')) {\r\n      setIsPublicContext(false);\r\n      setUserRole('DRIVER');\r\n    } else if (pathname?.includes('/owner')) {\r\n      setIsPublicContext(false);\r\n      setUserRole('OWNER');\r\n    } else if (pathname?.includes('/admin')) {\r\n      setIsPublicContext(false);\r\n      setUserRole('ADMIN');\r\n    } else {\r\n      // Default to public context if no indicators\r\n      setIsPublicContext(true);\r\n      setUserRole(null);\r\n    }\r\n    \r\n    setIsLoading(false);\r\n  }, [pathname]);\r\n\r\n  // Determine which header and footer to use\r\n  // Prioritize public context if detected, otherwise use authentication status\r\n  const shouldUsePublicLayout = isPublicContext === true || (isPublicContext === null && userRole === null);\r\n  const isAuthenticated = !shouldUsePublicLayout && userRole !== null;\r\n  const isDriver = userRole === \"DRIVER\";\r\n  const isOwner = userRole === \"OWNER\";\r\n  const isAdmin = userRole === \"ADMIN\";\r\n\r\n  // Show loading state briefly to avoid flash\r\n  if (isLoading || isPublicContext === null) {\r\n    return (\r\n      <>\r\n        <PublicHeader />\r\n        <main className=\"min-h-screen bg-white text-slate-900\">\r\n          <div className=\"public-container py-10\">\r\n            <div className=\"text-center\">Loading...</div>\r\n          </div>\r\n        </main>\r\n        <PublicFooter withRail={false} />\r\n      </>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <>\r\n      {shouldUsePublicLayout ? (\r\n        <PublicHeader />\r\n      ) : isAuthenticated ? (\r\n        isDriver ? (\r\n          <DriverSiteHeader />\r\n        ) : isOwner ? (\r\n          <OwnerSiteHeader />\r\n        ) : (\r\n          <SiteHeader role=\"ADMIN\" />\r\n        )\r\n      ) : (\r\n        <PublicHeader />\r\n      )}\r\n      \r\n      <main className=\"min-h-screen bg-white text-slate-900\">\r\n        {/* Layout edge markers (left/right) to indicate content boundaries */}\r\n        <LayoutFrame heightVariant=\"sm\" topVariant=\"sm\" colorVariant=\"muted\" variant=\"solid\" />\r\n        \r\n        {/* Hero Image Section */}\r\n        <section className=\"relative h-48 md:h-64 lg:h-80 overflow-hidden\">\r\n          <div className=\"public-container h-full relative\">\r\n            <div className=\"absolute inset-0 bg-[url('/assets/nolsaf%20picture%201.jpg')] bg-cover bg-center rounded-lg\" />\r\n            <div className=\"absolute inset-0 bg-gradient-to-b from-black/40 via-black/20 to-transparent rounded-lg\" />\r\n            <div className=\"relative h-full flex flex-col items-center justify-center\">\r\n              <Cookie size={64} className=\"text-white mb-4 drop-shadow-lg\" strokeWidth={1.5} />\r\n              <h1 className=\"text-3xl md:text-4xl lg:text-5xl font-bold text-white text-center px-4 drop-shadow-lg\">\r\n                Cookies Policy\r\n              </h1>\r\n            </div>\r\n          </div>\r\n        </section>\r\n        \r\n        <section className=\"relative bg-[#f7f9fb] pt-6 sm:pt-8 md:pt-10 pb-4 sm:pb-6 md:pb-10 overflow-x-hidden\">\r\n          <div className=\"public-container\">\r\n            <div className=\"w-full bg-white rounded-lg shadow-sm border border-gray-100 p-4 sm:p-6 md:p-10 lg:p-12 box-border overflow-x-hidden\">\r\n              <Terms headline=\"\" lastUpdated={COOKIES_LAST_UPDATED} sections={COOKIES_SECTIONS} />\r\n            </div>\r\n          </div>\r\n        </section>\r\n      </main>\r\n      \r\n      {shouldUsePublicLayout ? (\r\n        <PublicFooter withRail={false} />\r\n      ) : isAuthenticated ? (\r\n        <SiteFooter withRail={false} topSeparator={true} />\r\n      ) : (\r\n        <PublicFooter withRail={false} />\r\n      )}\r\n    </>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\disbursement-policy\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'isAdmin' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":110,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":110,"endColumn":16}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport Terms from \"@/components/Terms\";\r\nimport { DISBURSEMENT_POLICY_LAST_UPDATED, DISBURSEMENT_POLICY_SECTIONS } from \"@/components/disbursementPolicyContent\";\r\nimport PublicHeader from \"@/components/PublicHeader\";\r\nimport PublicFooter from \"@/components/PublicFooter\";\r\nimport SiteHeader from \"@/components/SiteHeader\";\r\nimport OwnerSiteHeader from \"@/components/OwnerSiteHeader\";\r\nimport DriverSiteHeader from \"@/components/DriverSiteHeader\";\r\nimport SiteFooter from \"@/components/SiteFooter\";\r\nimport LayoutFrame from \"@/components/LayoutFrame\";\r\nimport { DollarSign } from \"lucide-react\";\r\nimport { useEffect, useState } from \"react\";\r\nimport { usePathname } from \"next/navigation\";\r\n\r\nfunction getCookie(name: string): string | null {\r\n  if (typeof document === 'undefined') return null;\r\n  const value = `; ${document.cookie}`;\r\n  const parts = value.split(`; ${name}=`);\r\n  if (parts.length === 2) return parts.pop()?.split(';').shift() || null;\r\n  return null;\r\n}\r\n\r\nexport default function DisbursementPolicyPage() {\r\n  const pathname = usePathname();\r\n  const [userRole, setUserRole] = useState<\"ADMIN\" | \"OWNER\" | \"DRIVER\" | null>(null);\r\n  const [isLoading, setIsLoading] = useState(true);\r\n  const [isPublicContext, setIsPublicContext] = useState<boolean | null>(null);\r\n\r\n  useEffect(() => {\r\n    // PRIORITY 1: Check sessionStorage for navigation context (set by headers/footers)\r\n    // This is the most reliable indicator of where the user came from\r\n    let navigationContext: 'public' | 'owner' | 'driver' | 'admin' | null = null;\r\n    if (typeof window !== 'undefined') {\r\n      navigationContext = sessionStorage.getItem('navigationContext') as 'public' | 'owner' | 'driver' | 'admin' | null;\r\n    }\r\n\r\n    // If we have navigation context from sessionStorage, use it (this takes priority)\r\n    if (navigationContext) {\r\n      if (navigationContext === 'public') {\r\n        setIsPublicContext(true);\r\n        setUserRole(null);\r\n        setIsLoading(false);\r\n        return;\r\n      } else {\r\n        setIsPublicContext(false);\r\n        setUserRole(navigationContext.toUpperCase() as \"ADMIN\" | \"OWNER\" | \"DRIVER\");\r\n        setIsLoading(false);\r\n        return;\r\n      }\r\n    }\r\n\r\n    // PRIORITY 2: Check referrer to determine context\r\n    // If coming from a public route, use public layout regardless of cookie\r\n    let isFromPublicRoute = false;\r\n    if (typeof document !== 'undefined') {\r\n      const referrer = document.referrer;\r\n      const origin = window.location.origin;\r\n      isFromPublicRoute = !!referrer && (\r\n        referrer.includes('/public') || \r\n        referrer === origin || \r\n        referrer === origin + '/' ||\r\n        (!referrer.includes('/owner') && !referrer.includes('/driver') && !referrer.includes('/admin') && referrer.startsWith(origin))\r\n      );\r\n    }\r\n\r\n    // If coming from a public route, treat as public (even if they have a role cookie)\r\n    if (isFromPublicRoute) {\r\n      setIsPublicContext(true);\r\n      setUserRole(null);\r\n      setIsLoading(false);\r\n      return;\r\n    }\r\n\r\n    // PRIORITY 3: Check if user is authenticated via cookie\r\n    // Only use this if we don't have public context from above\r\n    const role = getCookie('role') as \"ADMIN\" | \"OWNER\" | \"DRIVER\" | null;\r\n    if (role) {\r\n      setIsPublicContext(false);\r\n      setUserRole(role);\r\n      setIsLoading(false);\r\n      return;\r\n    }\r\n    \r\n    // PRIORITY 4: Check pathname as final fallback to determine context\r\n    if (pathname?.includes('/driver')) {\r\n      setIsPublicContext(false);\r\n      setUserRole('DRIVER');\r\n    } else if (pathname?.includes('/owner')) {\r\n      setIsPublicContext(false);\r\n      setUserRole('OWNER');\r\n    } else if (pathname?.includes('/admin')) {\r\n      setIsPublicContext(false);\r\n      setUserRole('ADMIN');\r\n    } else {\r\n      // Default to public context if no indicators\r\n      setIsPublicContext(true);\r\n      setUserRole(null);\r\n    }\r\n    \r\n    setIsLoading(false);\r\n  }, [pathname]);\r\n\r\n  // Determine which header and footer to use\r\n  // Prioritize public context if detected, otherwise use authentication status\r\n  const shouldUsePublicLayout = isPublicContext === true || (isPublicContext === null && userRole === null);\r\n  const isAuthenticated = !shouldUsePublicLayout && userRole !== null;\r\n  const isDriver = userRole === \"DRIVER\";\r\n  const isOwner = userRole === \"OWNER\";\r\n  const isAdmin = userRole === \"ADMIN\";\r\n\r\n  // Show loading state briefly to avoid flash\r\n  if (isLoading || isPublicContext === null) {\r\n    return (\r\n      <>\r\n        <PublicHeader />\r\n        <main className=\"min-h-screen bg-white text-slate-900\">\r\n          <div className=\"public-container py-10\">\r\n            <div className=\"text-center\">Loading...</div>\r\n          </div>\r\n        </main>\r\n        <PublicFooter withRail={false} />\r\n      </>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <>\r\n      {shouldUsePublicLayout ? (\r\n        <PublicHeader />\r\n      ) : isAuthenticated ? (\r\n        isDriver ? (\r\n          <DriverSiteHeader />\r\n        ) : isOwner ? (\r\n          <OwnerSiteHeader />\r\n        ) : (\r\n          <SiteHeader role=\"ADMIN\" />\r\n        )\r\n      ) : (\r\n        <PublicHeader />\r\n      )}\r\n      \r\n      <main className=\"min-h-screen bg-white text-slate-900\">\r\n        {/* Layout edge markers (left/right) to indicate content boundaries */}\r\n        <LayoutFrame heightVariant=\"sm\" topVariant=\"sm\" colorVariant=\"muted\" variant=\"solid\" />\r\n        \r\n        {/* Hero Image Section */}\r\n        <section className=\"relative h-48 md:h-64 lg:h-80 overflow-hidden\">\r\n          <div className=\"public-container h-full relative\">\r\n            <div className=\"absolute inset-0 bg-[url('/assets/nolsaf%20picture%201.jpg')] bg-cover bg-center rounded-lg\" />\r\n            <div className=\"absolute inset-0 bg-gradient-to-b from-black/40 via-black/20 to-transparent rounded-lg\" />\r\n            <div className=\"relative h-full flex flex-col items-center justify-center\">\r\n              <DollarSign size={64} className=\"text-white mb-4 drop-shadow-lg\" strokeWidth={1.5} />\r\n              <h1 className=\"text-3xl md:text-4xl lg:text-5xl font-bold text-white text-center px-4 drop-shadow-lg\">\r\n                Disbursement Policy\r\n              </h1>\r\n              <p className=\"text-white text-center px-4 mt-2 text-lg drop-shadow-lg\">\r\n                For Drivers and Property Owners\r\n              </p>\r\n            </div>\r\n          </div>\r\n        </section>\r\n        \r\n        <section className=\"relative bg-[#f7f9fb] pt-6 sm:pt-8 md:pt-10 pb-4 sm:pb-6 md:pb-10 overflow-x-hidden\">\r\n          <div className=\"public-container\">\r\n            <div className=\"w-full bg-white rounded-lg shadow-sm border border-gray-100 p-4 sm:p-6 md:p-10 lg:p-12 box-border overflow-x-hidden\">\r\n              <Terms headline=\"\" lastUpdated={DISBURSEMENT_POLICY_LAST_UPDATED} sections={DISBURSEMENT_POLICY_SECTIONS} />\r\n            </div>\r\n          </div>\r\n        </section>\r\n      </main>\r\n      \r\n      {shouldUsePublicLayout ? (\r\n        <PublicFooter withRail={false} />\r\n      ) : isAuthenticated ? (\r\n        <SiteFooter withRail={false} topSeparator={true} />\r\n      ) : (\r\n        <PublicFooter withRail={false} />\r\n      )}\r\n    </>\r\n  );\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\docs\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\driver-disbursement-policy\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'isAdmin' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":103,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":103,"endColumn":16}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport Terms from \"@/components/Terms\";\r\nimport { DRIVER_DISBURSEMENT_POLICY_LAST_UPDATED, DRIVER_DISBURSEMENT_POLICY_SECTIONS } from \"@/components/driverDisbursementPolicyContent\";\r\nimport PublicHeader from \"@/components/PublicHeader\";\r\nimport PublicFooter from \"@/components/PublicFooter\";\r\nimport SiteHeader from \"@/components/SiteHeader\";\r\nimport OwnerSiteHeader from \"@/components/OwnerSiteHeader\";\r\nimport DriverSiteHeader from \"@/components/DriverSiteHeader\";\r\nimport SiteFooter from \"@/components/SiteFooter\";\r\nimport DriverFooter from \"@/components/DriverFooter\";\r\nimport LayoutFrame from \"@/components/LayoutFrame\";\r\nimport { DollarSign } from \"lucide-react\";\r\nimport { useEffect, useState } from \"react\";\r\nimport { usePathname } from \"next/navigation\";\r\n\r\nfunction getCookie(name: string): string | null {\r\n  if (typeof document === 'undefined') return null;\r\n  const value = `; ${document.cookie}`;\r\n  const parts = value.split(`; ${name}=`);\r\n  if (parts.length === 2) return parts.pop()?.split(';').shift() || null;\r\n  return null;\r\n}\r\n\r\nexport default function DriverDisbursementPolicyPage() {\r\n  const pathname = usePathname();\r\n  const [userRole, setUserRole] = useState<\"ADMIN\" | \"OWNER\" | \"DRIVER\" | null>(null);\r\n  const [isLoading, setIsLoading] = useState(true);\r\n  const [isPublicContext, setIsPublicContext] = useState<boolean | null>(null);\r\n\r\n  useEffect(() => {\r\n    // PRIORITY 1: Check sessionStorage for navigation context (set by headers/footers)\r\n    let navigationContext: 'public' | 'owner' | 'driver' | 'admin' | null = null;\r\n    if (typeof window !== 'undefined') {\r\n      navigationContext = sessionStorage.getItem('navigationContext') as 'public' | 'owner' | 'driver' | 'admin' | null;\r\n    }\r\n\r\n    if (navigationContext) {\r\n      if (navigationContext === 'public') {\r\n        setIsPublicContext(true);\r\n        setUserRole(null);\r\n        setIsLoading(false);\r\n        return;\r\n      } else {\r\n        setIsPublicContext(false);\r\n        setUserRole(navigationContext.toUpperCase() as \"ADMIN\" | \"OWNER\" | \"DRIVER\");\r\n        setIsLoading(false);\r\n        return;\r\n      }\r\n    }\r\n\r\n    // PRIORITY 2: Check referrer\r\n    let isFromPublicRoute = false;\r\n    if (typeof document !== 'undefined') {\r\n      const referrer = document.referrer;\r\n      const origin = window.location.origin;\r\n      isFromPublicRoute = !!referrer && (\r\n        referrer.includes('/public') || \r\n        referrer === origin || \r\n        referrer === origin + '/' ||\r\n        (!referrer.includes('/owner') && !referrer.includes('/driver') && !referrer.includes('/admin') && referrer.startsWith(origin))\r\n      );\r\n    }\r\n\r\n    if (isFromPublicRoute) {\r\n      setIsPublicContext(true);\r\n      setUserRole(null);\r\n      setIsLoading(false);\r\n      return;\r\n    }\r\n\r\n    // PRIORITY 3: Check if user is authenticated via cookie\r\n    const role = getCookie('role') as \"ADMIN\" | \"OWNER\" | \"DRIVER\" | null;\r\n    if (role) {\r\n      setIsPublicContext(false);\r\n      setUserRole(role);\r\n      setIsLoading(false);\r\n      return;\r\n    }\r\n    \r\n    // PRIORITY 4: Check pathname as final fallback\r\n    if (pathname?.includes('/driver')) {\r\n      setIsPublicContext(false);\r\n      setUserRole('DRIVER');\r\n    } else if (pathname?.includes('/owner')) {\r\n      setIsPublicContext(false);\r\n      setUserRole('OWNER');\r\n    } else if (pathname?.includes('/admin')) {\r\n      setIsPublicContext(false);\r\n      setUserRole('ADMIN');\r\n    } else {\r\n      setIsPublicContext(true);\r\n      setUserRole(null);\r\n    }\r\n    \r\n    setIsLoading(false);\r\n  }, [pathname]);\r\n\r\n  const shouldUsePublicLayout = isPublicContext === true || (isPublicContext === null && userRole === null);\r\n  const isAuthenticated = !shouldUsePublicLayout && userRole !== null;\r\n  const isDriver = userRole === \"DRIVER\";\r\n  const isOwner = userRole === \"OWNER\";\r\n  const isAdmin = userRole === \"ADMIN\";\r\n\r\n  if (isLoading || isPublicContext === null) {\r\n    return (\r\n      <>\r\n        <PublicHeader />\r\n        <main className=\"min-h-screen bg-white text-slate-900\">\r\n          <div className=\"public-container py-10\">\r\n            <div className=\"text-center\">Loading...</div>\r\n          </div>\r\n        </main>\r\n        <PublicFooter withRail={false} />\r\n      </>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <>\r\n      {shouldUsePublicLayout ? (\r\n        <PublicHeader />\r\n      ) : isAuthenticated ? (\r\n        isDriver ? (\r\n          <DriverSiteHeader />\r\n        ) : isOwner ? (\r\n          <OwnerSiteHeader />\r\n        ) : (\r\n          <SiteHeader role=\"ADMIN\" />\r\n        )\r\n      ) : (\r\n        <PublicHeader />\r\n      )}\r\n      \r\n      <main className=\"min-h-screen bg-white text-slate-900\">\r\n        <LayoutFrame heightVariant=\"sm\" topVariant=\"sm\" colorVariant=\"muted\" variant=\"solid\" />\r\n        \r\n        <section className=\"relative h-48 md:h-64 lg:h-80 overflow-hidden\">\r\n          <div className=\"public-container h-full relative\">\r\n            <div className=\"absolute inset-0 bg-[url('/assets/nolsaf%20picture%201.jpg')] bg-cover bg-center rounded-lg\" />\r\n            <div className=\"absolute inset-0 bg-gradient-to-b from-black/40 via-black/20 to-transparent rounded-lg\" />\r\n            <div className=\"relative h-full flex flex-col items-center justify-center\">\r\n              <DollarSign size={64} className=\"text-white mb-4 drop-shadow-lg\" strokeWidth={1.5} />\r\n              <h1 className=\"text-3xl md:text-4xl lg:text-5xl font-bold text-white text-center px-4 drop-shadow-lg\">\r\n                Driver Disbursement Policy\r\n              </h1>\r\n              <p className=\"text-white text-center px-4 mt-2 text-lg drop-shadow-lg\">\r\n                For Drivers\r\n              </p>\r\n            </div>\r\n          </div>\r\n        </section>\r\n        \r\n        <section className=\"relative bg-[#f7f9fb] pt-6 sm:pt-8 md:pt-10 pb-4 sm:pb-6 md:pb-10 overflow-x-hidden\">\r\n          <div className=\"public-container\">\r\n            <div className=\"w-full bg-white rounded-lg shadow-sm border border-gray-100 p-4 sm:p-6 md:p-10 lg:p-12 box-border overflow-x-hidden\">\r\n              <Terms headline=\"\" lastUpdated={DRIVER_DISBURSEMENT_POLICY_LAST_UPDATED} sections={DRIVER_DISBURSEMENT_POLICY_SECTIONS} />\r\n            </div>\r\n          </div>\r\n        </section>\r\n      </main>\r\n      \r\n      {shouldUsePublicLayout ? (\r\n        <PublicFooter withRail={false} />\r\n      ) : isDriver ? (\r\n        <DriverFooter />\r\n      ) : isAuthenticated ? (\r\n        <SiteFooter withRail={false} topSeparator={true} />\r\n      ) : (\r\n        <PublicFooter withRail={false} />\r\n      )}\r\n    </>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\global-error.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\help\\layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\help\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'HelpCircle' is defined but never used. Allowed unused vars must match /^_/u.","line":5,"column":78,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":88,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"HelpCircle"},"fix":{"range":[158,170],"text":""},"desc":"Remove unused variable \"HelpCircle\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Users' is defined but never used. Allowed unused vars must match /^_/u.","line":5,"column":102,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":107,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Users"},"fix":{"range":[182,189],"text":""},"desc":"Remove unused variable \"Users\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'setSending' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":283,"column":19,"nodeType":"Identifier","messageId":"unusedVar","endLine":283,"endColumn":29}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState } from \"react\";\r\nimport Link from \"next/link\";\r\nimport { LifeBuoy, ChevronDown, ChevronRight, Mail, MessageCircle, BookOpen, HelpCircle, CreditCard, Users, Car, Home } from \"lucide-react\";\r\nimport LayoutFrame from \"@/components/LayoutFrame\";\r\nimport PublicHeader from \"@/components/PublicHeader\";\r\nimport PublicFooter from \"@/components/PublicFooter\";\r\n\r\nconst DEFAULT_FAQS = [\r\n  // Booking Category\r\n  {\r\n    question: \"How do I book a property?\",\r\n    answer: \"Browse available properties on our platform, select your dates, and complete the booking process. You'll receive a confirmation email with all the details.\",\r\n    category: \"Booking\"\r\n  },\r\n  {\r\n    question: \"Can I cancel my booking?\",\r\n    answer: \"Cancellation policies vary by property. Check the property's cancellation policy before booking. You can view your bookings and cancellation options in your account.\",\r\n    category: \"Booking\"\r\n  },\r\n  {\r\n    question: \"How far in advance can I book?\",\r\n    answer: \"You can book properties up to 12 months in advance. Some properties may have different availability windows, which will be shown during the booking process.\",\r\n    category: \"Booking\"\r\n  },\r\n  {\r\n    question: \"Can I modify my booking dates?\",\r\n    answer: \"Yes, you can modify your booking dates through your account dashboard, subject to availability and the property's modification policy. Changes may incur additional fees or refunds based on the property's terms.\",\r\n    category: \"Booking\"\r\n  },\r\n  {\r\n    question: \"What happens if the property is not as described?\",\r\n    answer: \"If you encounter any issues with the property not matching its description, contact our support team immediately. We'll investigate and work with the property owner to resolve the issue, which may include a refund or alternative accommodation.\",\r\n    category: \"Booking\"\r\n  },\r\n  {\r\n    question: \"Do I need to pay a security deposit?\",\r\n    answer: \"Some properties require a security deposit, which will be clearly stated during the booking process. Deposits are typically refunded within 7-14 business days after check-out, provided there's no damage or policy violations.\",\r\n    category: \"Booking\"\r\n  },\r\n  {\r\n    question: \"Can I book for multiple guests?\",\r\n    answer: \"Yes, you can specify the number of guests during booking. Make sure to select the correct number as some properties charge per guest or have maximum occupancy limits.\",\r\n    category: \"Booking\"\r\n  },\r\n  {\r\n    question: \"What is the check-in and check-out process?\",\r\n    answer: \"Check-in and check-out times vary by property and are displayed on the property listing. You'll receive detailed instructions via email after booking. Most properties offer flexible check-in options, and early check-in or late check-out may be available upon request.\",\r\n    category: \"Booking\"\r\n  },\r\n  // Payment Category\r\n  {\r\n    question: \"What payment methods are accepted?\",\r\n    answer: \"We accept various payment methods including M-Pesa, Airtel Money, Tigo Pesa, and VISA cards. Payment options may vary by property.\",\r\n    category: \"Payment\"\r\n  },\r\n  {\r\n    question: \"When is payment charged?\",\r\n    answer: \"Payment is typically charged at the time of booking confirmation. Some properties may require a partial payment upfront with the remainder due closer to your check-in date. You'll see the payment schedule before confirming your booking.\",\r\n    category: \"Payment\"\r\n  },\r\n  {\r\n    question: \"Are there any booking fees?\",\r\n    answer: \"Our platform charges a small service fee that is clearly displayed before you complete your booking. This fee helps us maintain the platform, provide customer support, and ensure secure transactions.\",\r\n    category: \"Payment\"\r\n  },\r\n  {\r\n    question: \"How do I get a refund?\",\r\n    answer: \"Refunds are processed according to the property's cancellation policy. If you're eligible for a refund, it will be processed to your original payment method within 5-10 business days. Contact support if you have questions about your refund status.\",\r\n    category: \"Payment\"\r\n  },\r\n  {\r\n    question: \"Can I pay in installments?\",\r\n    answer: \"Some properties offer installment payment options. Look for properties with 'Pay in Installments' badge or contact the property owner directly to discuss payment arrangements.\",\r\n    category: \"Payment\"\r\n  },\r\n  {\r\n    question: \"What currency are prices displayed in?\",\r\n    answer: \"Prices are displayed in Tanzanian Shillings (TZS) by default. You can view prices in other currencies using the currency selector, though the final charge will be in TZS based on current exchange rates.\",\r\n    category: \"Payment\"\r\n  },\r\n  {\r\n    question: \"Is my payment information secure?\",\r\n    answer: \"Yes, we use industry-standard encryption and secure payment processing. Your payment information is never stored on our servers. All transactions are processed through secure, PCI-compliant payment gateways.\",\r\n    category: \"Payment\"\r\n  },\r\n  // Property Owner Category\r\n  {\r\n    question: \"How do I list my property?\",\r\n    answer: \"Sign up as a property owner, complete your profile, and add your property details. Our team will review and approve your listing. You can start by clicking 'List Your Property' in the navigation menu.\",\r\n    category: \"Property Owner\"\r\n  },\r\n  {\r\n    question: \"What information do I need to list my property?\",\r\n    answer: \"You'll need property photos, a detailed description, amenities list, pricing, availability calendar, house rules, and contact information. Our onboarding process will guide you through all required information.\",\r\n    category: \"Property Owner\"\r\n  },\r\n  {\r\n    question: \"How much does it cost to list my property?\",\r\n    answer: \"Listing your property is free. We only charge a commission on successful bookings. The commission rate varies based on your property type and is clearly outlined in our owner agreement.\",\r\n    category: \"Property Owner\"\r\n  },\r\n  {\r\n    question: \"How do I set my property pricing?\",\r\n    answer: \"You can set base pricing, seasonal rates, weekend rates, and special offers through your owner dashboard. We provide pricing recommendations based on market data to help you optimize your rates.\",\r\n    category: \"Property Owner\"\r\n  },\r\n  {\r\n    question: \"How do I manage bookings and reservations?\",\r\n    answer: \"All bookings appear in your owner dashboard where you can view guest details, manage check-ins, communicate with guests, and update availability. You'll receive email notifications for new bookings.\",\r\n    category: \"Property Owner\"\r\n  },\r\n  {\r\n    question: \"When do I receive payment for bookings?\",\r\n    answer: \"Payments are typically released to your account 24-48 hours after guest check-in. You can view your earnings, pending payments, and payout schedule in your owner dashboard under 'Earnings'.\",\r\n    category: \"Property Owner\"\r\n  },\r\n  {\r\n    question: \"Can I block dates when my property is unavailable?\",\r\n    answer: \"Yes, you can block dates, set minimum stay requirements, and manage your availability calendar directly from your owner dashboard. Changes sync immediately across the platform.\",\r\n    category: \"Property Owner\"\r\n  },\r\n  {\r\n    question: \"What if a guest damages my property?\",\r\n    answer: \"We recommend requiring a security deposit for your property. If damage occurs, document it with photos and contact our support team. We'll help mediate the situation and process any claims through the security deposit.\",\r\n    category: \"Property Owner\"\r\n  },\r\n  {\r\n    question: \"How can I improve my property's visibility?\",\r\n    answer: \"High-quality photos, detailed descriptions, competitive pricing, quick response times, and positive reviews all help improve your property's visibility. We also offer featured listing options for increased exposure.\",\r\n    category: \"Property Owner\"\r\n  },\r\n  // Driver Category\r\n  {\r\n    question: \"How do I become a driver?\",\r\n    answer: \"Register as a driver on our platform, complete your profile with required documents (license, vehicle registration, insurance), and wait for approval. Our team will verify your credentials before activation.\",\r\n    category: \"Driver\"\r\n  },\r\n  {\r\n    question: \"What documents do I need to become a driver?\",\r\n    answer: \"You'll need a valid driver's license, vehicle registration documents, insurance certificate, and a recent photo. All documents must be current and valid. We may request additional verification documents.\",\r\n    category: \"Driver\"\r\n  },\r\n  {\r\n    question: \"How do I get ride requests?\",\r\n    answer: \"Once approved, you'll receive ride requests through the driver app. You can accept or decline requests based on your availability. Being online and in high-demand areas increases your chances of receiving requests.\",\r\n    category: \"Driver\"\r\n  },\r\n  {\r\n    question: \"How are driver earnings calculated?\",\r\n    answer: \"Earnings are based on distance, time, and base fare rates. You keep a percentage of each ride, with the exact breakdown shown in your driver dashboard. Weekly payouts are processed automatically.\",\r\n    category: \"Driver\"\r\n  },\r\n  {\r\n    question: \"Can I set my own rates?\",\r\n    answer: \"Base rates are set by the platform, but you can earn bonuses during peak hours and special promotions. Premium drivers with excellent ratings may qualify for higher earning tiers.\",\r\n    category: \"Driver\"\r\n  },\r\n  {\r\n    question: \"What if I have an issue with a passenger?\",\r\n    answer: \"Contact our support team immediately if you encounter any issues. We have a 24/7 support line for drivers. Document any incidents and report them through the driver app for quick resolution.\",\r\n    category: \"Driver\"\r\n  },\r\n  {\r\n    question: \"How do I update my vehicle information?\",\r\n    answer: \"You can update your vehicle information, documents, and profile details through your driver dashboard. Changes to critical information like vehicle registration may require re-verification.\",\r\n    category: \"Driver\"\r\n  },\r\n  // Support Category\r\n  {\r\n    question: \"How do I contact support?\",\r\n    answer: \"You can reach our support team via email at info@nolsaf.com, use the contact form on this page, or access live chat through your account dashboard. We typically respond within 24 hours, with urgent matters addressed sooner.\",\r\n    category: \"Support\"\r\n  },\r\n  {\r\n    question: \"What happens if I have an issue during my stay?\",\r\n    answer: \"Contact the property owner directly through the platform messaging system first. If the issue isn't resolved, reach out to our support team for assistance. We're available 24/7 to help resolve any problems.\",\r\n    category: \"Support\"\r\n  },\r\n  {\r\n    question: \"How do I report a problem with a property?\",\r\n    answer: \"Use the 'Report Issue' button in your booking details or contact support directly. Provide photos and details of the problem. Our team will investigate and work with the property owner to resolve it.\",\r\n    category: \"Support\"\r\n  },\r\n  {\r\n    question: \"Can I leave a review after my stay?\",\r\n    answer: \"Yes, you'll receive an email invitation to leave a review after your check-out date. Reviews help other guests make informed decisions and help property owners improve their services.\",\r\n    category: \"Support\"\r\n  },\r\n  {\r\n    question: \"What is your response time for support inquiries?\",\r\n    answer: \"We aim to respond to all inquiries within 24 hours. Urgent matters related to active bookings are prioritized and typically receive a response within 2-4 hours during business hours.\",\r\n    category: \"Support\"\r\n  },\r\n  {\r\n    question: \"How do I update my account information?\",\r\n    answer: \"You can update your profile, contact information, payment methods, and preferences through your account settings. Changes to email or phone number may require verification.\",\r\n    category: \"Support\"\r\n  },\r\n  {\r\n    question: \"What if I forgot my password?\",\r\n    answer: \"Click 'Forgot Password' on the login page and enter your email address. You'll receive a password reset link via email. If you don't receive it, check your spam folder or contact support.\",\r\n    category: \"Support\"\r\n  },\r\n  // Security Category\r\n  {\r\n    question: \"Is my personal information secure?\",\r\n    answer: \"Yes, we take data security seriously. We use industry-standard encryption, secure servers, and follow best practices for data protection. Your personal information is never shared with third parties without your consent.\",\r\n    category: \"Security\"\r\n  },\r\n  {\r\n    question: \"How do you verify property owners and drivers?\",\r\n    answer: \"We verify all property owners and drivers through document verification, identity checks, and background screening where applicable. Only verified users can list properties or provide services on our platform.\",\r\n    category: \"Security\"\r\n  },\r\n  {\r\n    question: \"What should I do if I suspect fraud?\",\r\n    answer: \"Report any suspicious activity immediately to our support team at info@nolsaf.com. Include as much detail as possible. We take fraud seriously and will investigate all reports promptly.\",\r\n    category: \"Security\"\r\n  },\r\n  {\r\n    question: \"Are my credit card details stored?\",\r\n    answer: \"No, we never store your full credit card details. Payment information is securely processed through PCI-compliant payment gateways. Only the last four digits are stored for transaction reference.\",\r\n    category: \"Security\"\r\n  },\r\n  {\r\n    question: \"How do I know if a property listing is legitimate?\",\r\n    answer: \"All properties go through our verification process. Look for verified badges, read reviews from previous guests, and check the property owner's profile. If something seems suspicious, report it to our support team.\",\r\n    category: \"Security\"\r\n  },\r\n  {\r\n    question: \"What privacy protections do you have?\",\r\n    answer: \"We comply with data protection regulations and have strict privacy policies. Your data is only used to provide our services and improve your experience. You can review our full privacy policy in your account settings.\",\r\n    category: \"Security\"\r\n  }\r\n];\r\n\r\nconst HELP_CATEGORIES = [\r\n  {\r\n    title: \"Getting Started\",\r\n    icon: BookOpen,\r\n    links: [\r\n      { href: \"/help/getting-started\", label: \"How to Book\" },\r\n      { href: \"/help/account-setup\", label: \"Account Setup\" },\r\n      { href: \"/public/properties\", label: \"Browse Properties\" }\r\n    ]\r\n  },\r\n  {\r\n    title: \"Payments & Billing\",\r\n    icon: CreditCard,\r\n    links: [\r\n      { href: \"/help/payments\", label: \"Payment Methods\" },\r\n      { href: \"/help/refunds\", label: \"Refunds & Cancellations\" },\r\n      { href: \"/help/pricing\", label: \"Pricing Information\" }\r\n    ]\r\n  },\r\n  {\r\n    title: \"For Property Owners\",\r\n    icon: Home,\r\n    links: [\r\n      { href: \"/account/onboard/owner\", label: \"List Your Property\" },\r\n      { href: \"/help/owner-guide\", label: \"Owner Guide\" },\r\n      { href: \"/help/payouts\", label: \"Payouts & Earnings\" }\r\n    ]\r\n  },\r\n  {\r\n    title: \"For Drivers\",\r\n    icon: Car,\r\n    links: [\r\n      { href: \"/account/onboard/driver\", label: \"Become a Driver\" },\r\n      { href: \"/help/driver-tools\", label: \"Driver Tools\" },\r\n      { href: \"/help/driver-earnings\", label: \"Earnings & Payments\" }\r\n    ]\r\n  }\r\n];\r\n\r\nexport default function HelpCenterPage() {\r\n  const [openFaq, setOpenFaq] = useState<number | null>(0);\r\n  const [contactName, setContactName] = useState(\"\");\r\n  const [contactEmail, setContactEmail] = useState(\"\");\r\n  const [contactMessage, setContactMessage] = useState(\"\");\r\n  const [sending, setSending] = useState(false);\r\n  const [sent, setSent] = useState<string | null>(null);\r\n  const [error, setError] = useState<string | null>(null);\r\n  const [selectedCategory, setSelectedCategory] = useState<string>(\"All\");\r\n  const [showAllFAQs, setShowAllFAQs] = useState(false);\r\n\r\n  const categories = [\"All\", ...Array.from(new Set(DEFAULT_FAQS.map(f => f.category)))];\r\n  const filteredFAQs = selectedCategory === \"All\" \r\n    ? DEFAULT_FAQS \r\n    : DEFAULT_FAQS.filter(f => f.category === selectedCategory);\r\n  \r\n  const displayedFAQs = showAllFAQs ? filteredFAQs : filteredFAQs.slice(0, 10);\r\n  const hasMoreFAQs = filteredFAQs.length > 10;\r\n\r\n  async function submitContact(e?: React.FormEvent) {\r\n    e?.preventDefault();\r\n    setError(null);\r\n    setSent(null);\r\n    if (!contactEmail || !contactMessage) {\r\n      setError('Please provide your email and a message.');\r\n      return;\r\n    }\r\n    \r\n    // Use mailto as the primary method since there's no public contact API\r\n    const subject = encodeURIComponent(`Help Center Inquiry${contactName ? ` from ${contactName}` : ''}`);\r\n    const body = encodeURIComponent(`${contactMessage}\\n\\n---\\nFrom: ${contactEmail}${contactName ? ` (${contactName})` : ''}`);\r\n    window.location.href = `mailto:info@nolsaf.com?subject=${subject}&body=${body}`;\r\n    \r\n    setSent('Opening your email client. Please send the message to contact our support team.');\r\n    setContactName('');\r\n    setContactEmail('');\r\n    setContactMessage('');\r\n  }\r\n\r\n  return (\r\n    <>\r\n      <PublicHeader />\r\n      <div className=\"min-h-screen bg-gradient-to-b from-slate-50 to-white\">\r\n        <LayoutFrame heightVariant=\"sm\" topVariant=\"sm\" colorVariant=\"muted\" variant=\"solid\" />\r\n        <div className=\"public-container py-8 sm:py-12\">\r\n          {/* Header Section */}\r\n          <div className=\"max-w-3xl mx-auto text-center mb-12 animate-[fadeIn_0.5s_ease-out]\">\r\n            <div className=\"inline-flex items-center justify-center rounded-full bg-gradient-to-br from-[#02665e] to-[#024d47] p-4 shadow-lg transform transition-all duration-300 hover:scale-110 hover:shadow-xl\">\r\n              <LifeBuoy className=\"h-8 w-8 text-white\" />\r\n            </div>\r\n            <h1 className=\"mt-6 text-3xl sm:text-4xl lg:text-5xl font-bold text-gray-900 tracking-tight\">\r\n              Help Center\r\n            </h1>\r\n            <p className=\"mt-3 text-base sm:text-lg text-gray-600\">\r\n              Find answers to common questions and get support\r\n            </p>\r\n          </div>\r\n\r\n        <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6 lg:gap-8\">\r\n          {/* Main Content - Knowledge Base */}\r\n          <main className=\"lg:col-span-2 space-y-6\">\r\n            {/* Help Categories */}\r\n            <section className=\"bg-white rounded-2xl p-6 sm:p-8\">\r\n              <h2 className=\"text-2xl font-bold text-gray-900 mb-6\">Browse by Category</h2>\r\n              <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-6\">\r\n                {HELP_CATEGORIES.map((category, idx) => {\r\n                  const Icon = category.icon;\r\n                  return (\r\n                    <div key={idx} className=\"transition-all duration-200\">\r\n                      <div className=\"flex items-center gap-3 mb-4\">\r\n                        <div className=\"p-2 bg-[#02665e]/10 rounded-lg\">\r\n                          <Icon className=\"h-5 w-5 text-[#02665e]\" />\r\n                        </div>\r\n                        <h3 className=\"font-semibold text-gray-900\">{category.title}</h3>\r\n                      </div>\r\n                      <div className=\"space-y-0.5\">\r\n                        {category.links.map((link, linkIdx) => (\r\n                          <Link\r\n                            key={linkIdx}\r\n                            href={link.href}\r\n                            className=\"text-sm text-gray-600 hover:text-[#02665e] flex items-center justify-between group transition-all duration-200 no-underline py-2\"\r\n                            style={{ textDecoration: 'none' }}\r\n                          >\r\n                            <span className=\"group-hover:font-medium transition-all duration-200\">{link.label}</span>\r\n                            <ChevronRight className=\"h-3.5 w-3.5 text-gray-400 opacity-0 group-hover:opacity-100 group-hover:text-[#02665e] transition-all duration-200 flex-shrink-0\" />\r\n                          </Link>\r\n                        ))}\r\n                      </div>\r\n                    </div>\r\n                  );\r\n                })}\r\n              </div>\r\n            </section>\r\n\r\n            {/* FAQs Section */}\r\n            <section className=\"bg-white rounded-2xl p-6 sm:p-8\">\r\n              <h2 className=\"text-2xl font-bold text-gray-900 mb-6\">Frequently Asked Questions</h2>\r\n              \r\n              {/* Clean Category Filter */}\r\n              <div className=\"flex flex-wrap gap-2 mb-8 pb-6 border-b border-gray-100\">\r\n                {categories.map((cat) => (\r\n                  <button\r\n                    key={cat}\r\n                    onClick={() => {\r\n                      setSelectedCategory(cat);\r\n                      setShowAllFAQs(false);\r\n                      setOpenFaq(null);\r\n                    }}\r\n                    className={`px-4 py-1.5 rounded-full text-sm font-medium transition-all duration-200 ${\r\n                      selectedCategory === cat\r\n                        ? 'bg-[#02665e] text-white'\r\n                        : 'text-gray-500 hover:text-[#02665e]'\r\n                    }`}\r\n                  >\r\n                    {cat}\r\n                  </button>\r\n                ))}\r\n              </div>\r\n\r\n              {/* Clean FAQ Items */}\r\n              <div className=\"space-y-0\">\r\n                {displayedFAQs.map((f, idx) => {\r\n                  const isOpen = openFaq === idx;\r\n                  return (\r\n                    <div\r\n                      key={idx}\r\n                      className=\"py-4 border-b border-gray-50 last:border-b-0\"\r\n                    >\r\n                      <button\r\n                        onClick={() => setOpenFaq(isOpen ? null : idx)}\r\n                        className=\"w-full flex items-center justify-between text-left transition-all duration-200 group\"\r\n                      >\r\n                        <span className={`text-base pr-4 transition-colors ${\r\n                          isOpen ? 'text-[#02665e] font-semibold' : 'text-gray-900 font-medium group-hover:text-[#02665e]'\r\n                        }`}>\r\n                          {f.question}\r\n                        </span>\r\n                        <ChevronDown\r\n                          className={`h-4 w-4 flex-shrink-0 transition-all duration-200 ${\r\n                            isOpen ? 'rotate-180 text-[#02665e]' : 'text-gray-400 group-hover:text-gray-600'\r\n                          }`}\r\n                        />\r\n                      </button>\r\n                      {isOpen && (\r\n                        <div className=\"mt-3 text-gray-600 leading-relaxed text-sm\">\r\n                          {f.answer}\r\n                        </div>\r\n                      )}\r\n                    </div>\r\n                  );\r\n                })}\r\n              </div>\r\n              \r\n              {/* Show More/Less Button */}\r\n              {hasMoreFAQs && (\r\n                <div className=\"mt-8 pt-6 border-t border-gray-100 text-center\">\r\n                  <button\r\n                    onClick={() => {\r\n                      setShowAllFAQs(!showAllFAQs);\r\n                      setOpenFaq(null);\r\n                    }}\r\n                    className=\"inline-flex items-center gap-2 px-6 py-2.5 bg-[#02665e] text-white rounded-full font-medium hover:bg-[#024d47] transition-all duration-200 hover:shadow-lg active:scale-95\"\r\n                  >\r\n                    <span>{showAllFAQs ? 'Show Less' : 'Show More'}</span>\r\n                    <span className=\"text-xs opacity-90 font-normal\">\r\n                      ({showAllFAQs ? `${filteredFAQs.length - 10} hidden` : `${filteredFAQs.length - 10} more`})\r\n                    </span>\r\n                  </button>\r\n                </div>\r\n              )}\r\n            </section>\r\n          </main>\r\n\r\n          {/* Sidebar - Contact Form */}\r\n          <aside className=\"space-y-6\">\r\n            <div className=\"bg-white rounded-xl border border-gray-100 p-6 shadow-sm sticky top-4\">\r\n              <div className=\"flex items-center gap-3 mb-4\">\r\n                <div className=\"p-2 bg-[#02665e]/10 rounded-lg\">\r\n                  <MessageCircle className=\"h-5 w-5 text-[#02665e]\" />\r\n                </div>\r\n                <h3 className=\"font-semibold text-gray-900\">Still need help?</h3>\r\n              </div>\r\n              <p className=\"text-sm text-gray-600 mb-4\">\r\n                Can't find what you're looking for? Contact our support team.\r\n              </p>\r\n\r\n              <form onSubmit={submitContact} className=\"space-y-4\">\r\n                <div>\r\n                  <label htmlFor=\"contact-name\" className=\"block text-sm font-medium text-gray-700 mb-1.5\">\r\n                    Name (optional)\r\n                  </label>\r\n                  <input\r\n                    id=\"contact-name\"\r\n                    type=\"text\"\r\n                    value={contactName}\r\n                    onChange={(e) => setContactName(e.target.value)}\r\n                    className=\"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#02665e] focus:border-[#02665e] outline-none transition-all\"\r\n                    placeholder=\"Your name\"\r\n                  />\r\n                </div>\r\n                <div>\r\n                  <label htmlFor=\"contact-email\" className=\"block text-sm font-medium text-gray-700 mb-1.5\">\r\n                    Email <span className=\"text-red-500\">*</span>\r\n                  </label>\r\n                  <input\r\n                    id=\"contact-email\"\r\n                    type=\"email\"\r\n                    required\r\n                    value={contactEmail}\r\n                    onChange={(e) => setContactEmail(e.target.value)}\r\n                    className=\"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#02665e] focus:border-[#02665e] outline-none transition-all\"\r\n                    placeholder=\"your@email.com\"\r\n                  />\r\n                </div>\r\n                <div>\r\n                  <label htmlFor=\"contact-message\" className=\"block text-sm font-medium text-gray-700 mb-1.5\">\r\n                    Message <span className=\"text-red-500\">*</span>\r\n                  </label>\r\n                  <textarea\r\n                    id=\"contact-message\"\r\n                    required\r\n                    value={contactMessage}\r\n                    onChange={(e) => setContactMessage(e.target.value)}\r\n                    rows={4}\r\n                    className=\"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#02665e] focus:border-[#02665e] outline-none transition-all resize-none\"\r\n                    placeholder=\"How can we help you?\"\r\n                  />\r\n                </div>\r\n                <button\r\n                  type=\"submit\"\r\n                  disabled={sending}\r\n                  className=\"w-full px-4 py-2.5 bg-[#02665e] text-white rounded-lg font-semibold hover:bg-[#024d47] transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed shadow-sm hover:shadow-md\"\r\n                >\r\n                  {sending ? 'Sending...' : 'Send Message'}\r\n                </button>\r\n              </form>\r\n\r\n              {sent && (\r\n                <div className=\"mt-4 p-3 bg-emerald-50 border border-emerald-200 rounded-lg text-sm text-emerald-700\">\r\n                  {sent}\r\n                </div>\r\n              )}\r\n              {error && (\r\n                <div className=\"mt-4 p-3 bg-red-50 border border-red-200 rounded-lg text-sm text-red-700\">\r\n                  {error}\r\n                </div>\r\n              )}\r\n\r\n              <div className=\"mt-6 pt-6 border-t border-gray-200\">\r\n                <div className=\"flex items-center gap-2 text-sm text-gray-600 mb-2\">\r\n                  <Mail className=\"h-4 w-4\" />\r\n                  <span className=\"font-medium\">Email us directly:</span>\r\n                </div>\r\n                <a\r\n                  href=\"mailto:info@nolsaf.com\"\r\n                  className=\"text-[#02665e] hover:text-[#024d47] text-sm font-medium transition-colors\"\r\n                >\r\n                  info@nolsaf.com\r\n                </a>\r\n              </div>\r\n            </div>\r\n          </aside>\r\n        </div>\r\n        </div>\r\n      </div>\r\n      <PublicFooter withRail={false} />\r\n    </>\r\n  );\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\login\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\privacy\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'isAdmin' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":110,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":110,"endColumn":16}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport Terms from \"@/components/Terms\";\nimport { PRIVACY_LAST_UPDATED, PRIVACY_SECTIONS } from \"@/components/privacyContent\";\nimport PublicHeader from \"@/components/PublicHeader\";\nimport PublicFooter from \"@/components/PublicFooter\";\nimport SiteHeader from \"@/components/SiteHeader\";\nimport OwnerSiteHeader from \"@/components/OwnerSiteHeader\";\nimport DriverSiteHeader from \"@/components/DriverSiteHeader\";\nimport SiteFooter from \"@/components/SiteFooter\";\nimport LayoutFrame from \"@/components/LayoutFrame\";\nimport { Shield } from \"lucide-react\";\nimport { useEffect, useState } from \"react\";\nimport { usePathname } from \"next/navigation\";\n\nfunction getCookie(name: string): string | null {\n  if (typeof document === 'undefined') return null;\n  const value = `; ${document.cookie}`;\n  const parts = value.split(`; ${name}=`);\n  if (parts.length === 2) return parts.pop()?.split(';').shift() || null;\n  return null;\n}\n\nexport default function PrivacyPage() {\n  const pathname = usePathname();\n  const [userRole, setUserRole] = useState<\"ADMIN\" | \"OWNER\" | \"DRIVER\" | null>(null);\n  const [isLoading, setIsLoading] = useState(true);\n  const [isPublicContext, setIsPublicContext] = useState<boolean | null>(null);\n\n  useEffect(() => {\n    // PRIORITY 1: Check sessionStorage for navigation context (set by headers/footers)\n    // This is the most reliable indicator of where the user came from\n    let navigationContext: 'public' | 'owner' | 'driver' | 'admin' | null = null;\n    if (typeof window !== 'undefined') {\n      navigationContext = sessionStorage.getItem('navigationContext') as 'public' | 'owner' | 'driver' | 'admin' | null;\n    }\n\n    // If we have navigation context from sessionStorage, use it (this takes priority)\n    if (navigationContext) {\n      if (navigationContext === 'public') {\n        setIsPublicContext(true);\n        setUserRole(null);\n        setIsLoading(false);\n        return;\n      } else {\n        setIsPublicContext(false);\n        setUserRole(navigationContext.toUpperCase() as \"ADMIN\" | \"OWNER\" | \"DRIVER\");\n        setIsLoading(false);\n        return;\n      }\n    }\n\n    // PRIORITY 2: Check referrer to determine context\n    // If coming from a public route, use public layout regardless of cookie\n    let isFromPublicRoute = false;\n    if (typeof document !== 'undefined') {\n      const referrer = document.referrer;\n      const origin = window.location.origin;\n      isFromPublicRoute = !!referrer && (\n        referrer.includes('/public') || \n        referrer === origin || \n        referrer === origin + '/' ||\n        (!referrer.includes('/owner') && !referrer.includes('/driver') && !referrer.includes('/admin') && referrer.startsWith(origin))\n      );\n    }\n\n    // If coming from a public route, treat as public (even if they have a role cookie)\n    if (isFromPublicRoute) {\n      setIsPublicContext(true);\n      setUserRole(null);\n      setIsLoading(false);\n      return;\n    }\n\n    // PRIORITY 3: Check if user is authenticated via cookie\n    // Only use this if we don't have public context from above\n    const role = getCookie('role') as \"ADMIN\" | \"OWNER\" | \"DRIVER\" | null;\n    if (role) {\n      setIsPublicContext(false);\n      setUserRole(role);\n      setIsLoading(false);\n      return;\n    }\n    \n    // PRIORITY 4: Check pathname as final fallback to determine context\n    if (pathname?.includes('/driver')) {\n      setIsPublicContext(false);\n      setUserRole('DRIVER');\n    } else if (pathname?.includes('/owner')) {\n      setIsPublicContext(false);\n      setUserRole('OWNER');\n    } else if (pathname?.includes('/admin')) {\n      setIsPublicContext(false);\n      setUserRole('ADMIN');\n    } else {\n      // Default to public context if no indicators\n      setIsPublicContext(true);\n      setUserRole(null);\n    }\n    \n    setIsLoading(false);\n  }, [pathname]);\n\n  // Determine which header and footer to use\n  // Prioritize public context if detected, otherwise use authentication status\n  const shouldUsePublicLayout = isPublicContext === true || (isPublicContext === null && userRole === null);\n  const isAuthenticated = !shouldUsePublicLayout && userRole !== null;\n  const isDriver = userRole === \"DRIVER\";\n  const isOwner = userRole === \"OWNER\";\n  const isAdmin = userRole === \"ADMIN\";\n\n  // Show loading state briefly to avoid flash\n  if (isLoading || isPublicContext === null) {\n    return (\n      <>\n        <PublicHeader />\n        <main className=\"min-h-screen bg-white text-slate-900\">\n          <div className=\"public-container py-10\">\n            <div className=\"text-center\">Loading...</div>\n          </div>\n        </main>\n        <PublicFooter withRail={false} />\n      </>\n    );\n  }\n\n  return (\n    <>\n      {shouldUsePublicLayout ? (\n        <PublicHeader />\n      ) : isAuthenticated ? (\n        isDriver ? (\n          <DriverSiteHeader />\n        ) : isOwner ? (\n          <OwnerSiteHeader />\n        ) : (\n          <SiteHeader role=\"ADMIN\" />\n        )\n      ) : (\n        <PublicHeader />\n      )}\n      \n      <main className=\"min-h-screen bg-white text-slate-900\">\n        {/* Layout edge markers (left/right) to indicate content boundaries */}\n        <LayoutFrame heightVariant=\"sm\" topVariant=\"sm\" colorVariant=\"muted\" variant=\"solid\" />\n        \n        {/* Hero Image Section */}\n        <section className=\"relative h-48 md:h-64 lg:h-80 overflow-hidden\">\n          <div className=\"public-container h-full relative\">\n            <div className=\"absolute inset-0 bg-[url('/assets/nolsaf%20picture%201.jpg')] bg-cover bg-center rounded-lg\" />\n            <div className=\"absolute inset-0 bg-gradient-to-b from-black/40 via-black/20 to-transparent rounded-lg\" />\n            <div className=\"relative h-full flex flex-col items-center justify-center\">\n              <Shield size={64} className=\"text-white mb-4 drop-shadow-lg\" strokeWidth={1.5} />\n              <h1 className=\"text-3xl md:text-4xl lg:text-5xl font-bold text-white text-center px-4 drop-shadow-lg\">\n                Privacy Policy\n              </h1>\n          </div>\n        </div>\n        </section>\n        \n        <section className=\"relative bg-[#f7f9fb] pt-6 sm:pt-8 md:pt-10 pb-4 sm:pb-6 md:pb-10 overflow-x-hidden\">\n          <div className=\"public-container\">\n            <div className=\"w-full bg-white rounded-lg shadow-sm border border-gray-100 p-4 sm:p-6 md:p-10 lg:p-12 box-border overflow-x-hidden\">\n              <Terms headline=\"\" lastUpdated={PRIVACY_LAST_UPDATED} sections={PRIVACY_SECTIONS} />\n          </div>\n        </div>\n        </section>\n      </main>\n      \n      {shouldUsePublicLayout ? (\n        <PublicFooter withRail={false} />\n      ) : isAuthenticated ? (\n        <SiteFooter withRail={false} topSeparator={true} />\n      ) : (\n        <PublicFooter withRail={false} />\n      )}\n    </>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\property-owner-disbursement-policy\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'isAdmin' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":102,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":102,"endColumn":16}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport Terms from \"@/components/Terms\";\r\nimport { PROPERTY_OWNER_DISBURSEMENT_POLICY_LAST_UPDATED, PROPERTY_OWNER_DISBURSEMENT_POLICY_SECTIONS } from \"@/components/propertyOwnerDisbursementPolicyContent\";\r\nimport PublicHeader from \"@/components/PublicHeader\";\r\nimport PublicFooter from \"@/components/PublicFooter\";\r\nimport SiteHeader from \"@/components/SiteHeader\";\r\nimport OwnerSiteHeader from \"@/components/OwnerSiteHeader\";\r\nimport DriverSiteHeader from \"@/components/DriverSiteHeader\";\r\nimport SiteFooter from \"@/components/SiteFooter\";\r\nimport LayoutFrame from \"@/components/LayoutFrame\";\r\nimport { DollarSign } from \"lucide-react\";\r\nimport { useEffect, useState } from \"react\";\r\nimport { usePathname } from \"next/navigation\";\r\n\r\nfunction getCookie(name: string): string | null {\r\n  if (typeof document === 'undefined') return null;\r\n  const value = `; ${document.cookie}`;\r\n  const parts = value.split(`; ${name}=`);\r\n  if (parts.length === 2) return parts.pop()?.split(';').shift() || null;\r\n  return null;\r\n}\r\n\r\nexport default function PropertyOwnerDisbursementPolicyPage() {\r\n  const pathname = usePathname();\r\n  const [userRole, setUserRole] = useState<\"ADMIN\" | \"OWNER\" | \"DRIVER\" | null>(null);\r\n  const [isLoading, setIsLoading] = useState(true);\r\n  const [isPublicContext, setIsPublicContext] = useState<boolean | null>(null);\r\n\r\n  useEffect(() => {\r\n    // PRIORITY 1: Check sessionStorage for navigation context (set by headers/footers)\r\n    let navigationContext: 'public' | 'owner' | 'driver' | 'admin' | null = null;\r\n    if (typeof window !== 'undefined') {\r\n      navigationContext = sessionStorage.getItem('navigationContext') as 'public' | 'owner' | 'driver' | 'admin' | null;\r\n    }\r\n\r\n    if (navigationContext) {\r\n      if (navigationContext === 'public') {\r\n        setIsPublicContext(true);\r\n        setUserRole(null);\r\n        setIsLoading(false);\r\n        return;\r\n      } else {\r\n        setIsPublicContext(false);\r\n        setUserRole(navigationContext.toUpperCase() as \"ADMIN\" | \"OWNER\" | \"DRIVER\");\r\n        setIsLoading(false);\r\n        return;\r\n      }\r\n    }\r\n\r\n    // PRIORITY 2: Check referrer\r\n    let isFromPublicRoute = false;\r\n    if (typeof document !== 'undefined') {\r\n      const referrer = document.referrer;\r\n      const origin = window.location.origin;\r\n      isFromPublicRoute = !!referrer && (\r\n        referrer.includes('/public') || \r\n        referrer === origin || \r\n        referrer === origin + '/' ||\r\n        (!referrer.includes('/owner') && !referrer.includes('/driver') && !referrer.includes('/admin') && referrer.startsWith(origin))\r\n      );\r\n    }\r\n\r\n    if (isFromPublicRoute) {\r\n      setIsPublicContext(true);\r\n      setUserRole(null);\r\n      setIsLoading(false);\r\n      return;\r\n    }\r\n\r\n    // PRIORITY 3: Check if user is authenticated via cookie\r\n    const role = getCookie('role') as \"ADMIN\" | \"OWNER\" | \"DRIVER\" | null;\r\n    if (role) {\r\n      setIsPublicContext(false);\r\n      setUserRole(role);\r\n      setIsLoading(false);\r\n      return;\r\n    }\r\n    \r\n    // PRIORITY 4: Check pathname as final fallback\r\n    if (pathname?.includes('/driver')) {\r\n      setIsPublicContext(false);\r\n      setUserRole('DRIVER');\r\n    } else if (pathname?.includes('/owner')) {\r\n      setIsPublicContext(false);\r\n      setUserRole('OWNER');\r\n    } else if (pathname?.includes('/admin')) {\r\n      setIsPublicContext(false);\r\n      setUserRole('ADMIN');\r\n    } else {\r\n      setIsPublicContext(true);\r\n      setUserRole(null);\r\n    }\r\n    \r\n    setIsLoading(false);\r\n  }, [pathname]);\r\n\r\n  const shouldUsePublicLayout = isPublicContext === true || (isPublicContext === null && userRole === null);\r\n  const isAuthenticated = !shouldUsePublicLayout && userRole !== null;\r\n  const isDriver = userRole === \"DRIVER\";\r\n  const isOwner = userRole === \"OWNER\";\r\n  const isAdmin = userRole === \"ADMIN\";\r\n\r\n  if (isLoading || isPublicContext === null) {\r\n    return (\r\n      <>\r\n        <PublicHeader />\r\n        <main className=\"min-h-screen bg-white text-slate-900\">\r\n          <div className=\"public-container py-10\">\r\n            <div className=\"text-center\">Loading...</div>\r\n          </div>\r\n        </main>\r\n        <PublicFooter withRail={false} />\r\n      </>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <>\r\n      {shouldUsePublicLayout ? (\r\n        <PublicHeader />\r\n      ) : isAuthenticated ? (\r\n        isDriver ? (\r\n          <DriverSiteHeader />\r\n        ) : isOwner ? (\r\n          <OwnerSiteHeader />\r\n        ) : (\r\n          <SiteHeader role=\"ADMIN\" />\r\n        )\r\n      ) : (\r\n        <PublicHeader />\r\n      )}\r\n      \r\n      <main className=\"min-h-screen bg-white text-slate-900\">\r\n        <LayoutFrame heightVariant=\"sm\" topVariant=\"sm\" colorVariant=\"muted\" variant=\"solid\" />\r\n        \r\n        <section className=\"relative h-48 md:h-64 lg:h-80 overflow-hidden\">\r\n          <div className=\"public-container h-full relative\">\r\n            <div className=\"absolute inset-0 bg-[url('/assets/nolsaf%20picture%201.jpg')] bg-cover bg-center rounded-lg\" />\r\n            <div className=\"absolute inset-0 bg-gradient-to-b from-black/40 via-black/20 to-transparent rounded-lg\" />\r\n            <div className=\"relative h-full flex flex-col items-center justify-center\">\r\n              <DollarSign size={64} className=\"text-white mb-4 drop-shadow-lg\" strokeWidth={1.5} />\r\n              <h1 className=\"text-3xl md:text-4xl lg:text-5xl font-bold text-white text-center px-4 drop-shadow-lg\">\r\n                Property Owner Disbursement Policy\r\n              </h1>\r\n              <p className=\"text-white text-center px-4 mt-2 text-lg drop-shadow-lg\">\r\n                For Property Owners\r\n              </p>\r\n            </div>\r\n          </div>\r\n        </section>\r\n        \r\n        <section className=\"relative bg-[#f7f9fb] pt-6 sm:pt-8 md:pt-10 pb-4 sm:pb-6 md:pb-10 overflow-x-hidden\">\r\n          <div className=\"public-container\">\r\n            <div className=\"w-full bg-white rounded-lg shadow-sm border border-gray-100 p-4 sm:p-6 md:p-10 lg:p-12 box-border overflow-x-hidden\">\r\n              <Terms headline=\"\" lastUpdated={PROPERTY_OWNER_DISBURSEMENT_POLICY_LAST_UPDATED} sections={PROPERTY_OWNER_DISBURSEMENT_POLICY_SECTIONS} />\r\n            </div>\r\n          </div>\r\n        </section>\r\n      </main>\r\n      \r\n      {shouldUsePublicLayout ? (\r\n        <PublicFooter withRail={false} />\r\n      ) : isAuthenticated ? (\r\n        <SiteFooter withRail={false} topSeparator={true} />\r\n      ) : (\r\n        <PublicFooter withRail={false} />\r\n      )}\r\n    </>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\public\\account\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\public\\booking\\[id]\\confirm\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\public\\booking\\confirm\\[id]\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\public\\booking\\confirm\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\public\\booking\\payment\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'X' is defined but never used. Allowed unused vars must match /^_/u.","line":14,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":14,"endColumn":4,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"X"},"fix":{"range":[300,306],"text":""},"desc":"Remove unused variable \"X\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Info' is defined but never used. Allowed unused vars must match /^_/u.","line":15,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":15,"endColumn":7,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Info"},"fix":{"range":[306,315],"text":""},"desc":"Remove unused variable \"Info\"."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchInvoice'. Either include it or remove the dependency array.","line":114,"column":6,"nodeType":"ArrayExpression","endLine":114,"endColumn":20,"suggestions":[{"desc":"Update the dependencies array to be: [fetchInvoice, searchParams]","fix":{"range":[2885,2899],"text":"[fetchInvoice, searchParams]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useEffect, useRef } from \"react\";\r\nimport { useRouter, useSearchParams } from \"next/navigation\";\r\nimport Image from \"next/image\";\r\nimport Link from \"next/link\";\r\nimport {\r\n  ChevronLeft,\r\n  CheckCircle2,\r\n  AlertCircle,\r\n  ShieldCheck,\r\n  CreditCard,\r\n  Smartphone,\r\n  X,\r\n  Info,\r\n} from \"lucide-react\";\r\nimport LogoSpinner from \"@/components/LogoSpinner\";\r\n\r\ntype PaymentMethod = {\r\n  id: \"Airtel\" | \"Tigo\" | \"M-Pesa\" | \"Halopesa\";\r\n  name: string;\r\n  icon: string;\r\n  description: string;\r\n};\r\n\r\nconst PAYMENT_METHODS: PaymentMethod[] = [\r\n  {\r\n    id: \"Airtel\",\r\n    name: \"Airtel Money\",\r\n    icon: \"/assets/airtel_money.png\",\r\n    description: \"Pay with Airtel Money\",\r\n  },\r\n  {\r\n    id: \"M-Pesa\",\r\n    name: \"M-Pesa\",\r\n    icon: \"/assets/M-pesa.png\",\r\n    description: \"Pay with M-Pesa\",\r\n  },\r\n  {\r\n    id: \"Tigo\",\r\n    name: \"Tigo Pesa\",\r\n    icon: \"/assets/mix%20by%20yas.png\",\r\n    description: \"Pay with Tigo Pesa\",\r\n  },\r\n  {\r\n    id: \"Halopesa\",\r\n    name: \"HaloPesa\",\r\n    icon: \"/assets/halopesa.png\",\r\n    description: \"Pay with HaloPesa\",\r\n  },\r\n];\r\n\r\ntype InvoiceData = {\r\n  id: number;\r\n  invoiceNumber: string;\r\n  paymentRef: string;\r\n  status: string;\r\n  totalAmount: number;\r\n  currency: string;\r\n  booking: {\r\n    id: number;\r\n    bookingCode: string;\r\n    checkIn: string;\r\n    checkOut: string;\r\n    nights: number;\r\n    guestName: string | null;\r\n    guestPhone: string | null;\r\n    roomCode: string | null;\r\n    roomsQty?: number;\r\n    includeTransport?: boolean;\r\n    totalAmount: number;\r\n  };\r\n  property: {\r\n    id: number;\r\n    title: string;\r\n    type: string;\r\n    primaryImage: string | null;\r\n    basePrice: number;\r\n  };\r\n  priceBreakdown: {\r\n    accommodationSubtotal: number;\r\n    taxPercent: number;\r\n    taxAmount: number;\r\n    discount: number;\r\n    transportFare: number;\r\n    commission: number;\r\n    subtotal: number;\r\n    total: number;\r\n  };\r\n};\r\n\r\nexport default function PaymentPage() {\r\n  const router = useRouter();\r\n  const searchParams = useSearchParams();\r\n  const [loading, setLoading] = useState(true);\r\n  const [submitting, setSubmitting] = useState(false);\r\n  const [processing, setProcessing] = useState(false);\r\n  const [error, setError] = useState<string | null>(null);\r\n  const [invoice, setInvoice] = useState<InvoiceData | null>(null);\r\n  const [selectedMethod, setSelectedMethod] = useState<PaymentMethod | null>(null);\r\n  const [phoneNumber, setPhoneNumber] = useState(\"\");\r\n  const [paymentStatus, setPaymentStatus] = useState<\"idle\" | \"pending\" | \"success\" | \"failed\">(\"idle\");\r\n  const pollingIntervalRef = useRef<NodeJS.Timeout | null>(null);\r\n\r\n  useEffect(() => {\r\n    const invoiceId = searchParams?.get(\"invoiceId\");\r\n    if (!invoiceId) {\r\n      setError(\"Missing invoice ID\");\r\n      setLoading(false);\r\n      return;\r\n    }\r\n\r\n    fetchInvoice(Number(invoiceId));\r\n  }, [searchParams]);\r\n\r\n  // Cleanup polling on unmount\r\n  useEffect(() => {\r\n    return () => {\r\n      if (pollingIntervalRef.current) {\r\n        clearInterval(pollingIntervalRef.current);\r\n      }\r\n    };\r\n  }, []);\r\n\r\n  async function fetchInvoice(invoiceId: number) {\r\n    try {\r\n      const API = (process.env.NEXT_PUBLIC_API_URL || \"http://localhost:4000\").replace(/\\/$/, \"\");\r\n      const response = await fetch(`${API}/api/public/invoices/${invoiceId}`);\r\n      \r\n      if (!response.ok) {\r\n        throw new Error(\"Failed to fetch invoice\");\r\n      }\r\n\r\n      const data = await response.json();\r\n      \r\n      // Validate that we have required data\r\n      if (!data || !data.property || !data.property.id) {\r\n        throw new Error(\"Invoice data is incomplete. Property information is missing.\");\r\n      }\r\n      \r\n      setInvoice(data);\r\n      \r\n      // If already paid, redirect to receipt\r\n      if (data.status === \"PAID\") {\r\n        router.push(`/public/booking/receipt?invoiceId=${invoiceId}`);\r\n        return;\r\n      }\r\n    } catch (err: any) {\r\n      setError(err?.message || \"Failed to load invoice\");\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  }\r\n\r\n  async function handlePayment() {\r\n    if (!selectedMethod || !phoneNumber.trim() || !invoice) {\r\n      setError(\"Please select a payment method and enter your phone number\");\r\n      return;\r\n    }\r\n\r\n    // Validate phone number format\r\n    const phoneRegex = /^(\\+255|255|0)?[0-9]{9}$/;\r\n    const cleanedPhone = phoneNumber.replace(/\\s+/g, \"\");\r\n    if (!phoneRegex.test(cleanedPhone)) {\r\n      setError(\"Please enter a valid phone number (e.g., +255 XXX XXX XXX)\");\r\n      return;\r\n    }\r\n\r\n    setError(null);\r\n    setSubmitting(true);\r\n    setProcessing(true);\r\n    setPaymentStatus(\"pending\");\r\n\r\n    try {\r\n      const API = (process.env.NEXT_PUBLIC_API_URL || \"http://localhost:4000\").replace(/\\/$/, \"\");\r\n      \r\n      // Initiate payment\r\n      const response = await fetch(`${API}/api/payments/azampay/initiate`, {\r\n        method: \"POST\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify({\r\n          invoiceId: invoice.id,\r\n          phoneNumber: cleanedPhone,\r\n          provider: selectedMethod.id,\r\n        }),\r\n      });\r\n\r\n      const result = await response.json();\r\n\r\n      if (!response.ok) {\r\n        throw new Error(result.error || \"Failed to initiate payment\");\r\n      }\r\n\r\n      // Start polling for payment status\r\n      startPolling(result.paymentRef);\r\n    } catch (err: any) {\r\n      setError(err?.message || \"Failed to initiate payment. Please try again.\");\r\n      setSubmitting(false);\r\n      setProcessing(false);\r\n      setPaymentStatus(\"failed\");\r\n    }\r\n  }\r\n\r\n  function startPolling(paymentRef: string) {\r\n    // Poll every 2 seconds for up to 60 seconds (30 attempts)\r\n    let attempts = 0;\r\n    const maxAttempts = 30;\r\n\r\n    pollingIntervalRef.current = setInterval(async () => {\r\n      attempts++;\r\n\r\n      try {\r\n        const API = (process.env.NEXT_PUBLIC_API_URL || \"http://localhost:4000\").replace(/\\/$/, \"\");\r\n        const response = await fetch(`${API}/api/payments/azampay/status/${paymentRef}`);\r\n        const data = await response.json();\r\n\r\n        if (data.invoiceStatus === \"PAID\") {\r\n          // Payment successful!\r\n          if (pollingIntervalRef.current) {\r\n            clearInterval(pollingIntervalRef.current);\r\n          }\r\n          setPaymentStatus(\"success\");\r\n          setProcessing(false);\r\n          \r\n          // Redirect to receipt after 2 seconds\r\n          setTimeout(() => {\r\n            router.push(`/public/booking/receipt?invoiceId=${invoice?.id}`);\r\n          }, 2000);\r\n        } else if (data.paymentStatus === \"FAILED\") {\r\n          // Payment failed\r\n          if (pollingIntervalRef.current) {\r\n            clearInterval(pollingIntervalRef.current);\r\n          }\r\n          setPaymentStatus(\"failed\");\r\n          setProcessing(false);\r\n          setSubmitting(false);\r\n          setError(\"Payment failed. Please try again.\");\r\n        } else if (attempts >= maxAttempts) {\r\n          // Timeout\r\n          if (pollingIntervalRef.current) {\r\n            clearInterval(pollingIntervalRef.current);\r\n          }\r\n          setProcessing(false);\r\n          setSubmitting(false);\r\n          setError(\"Payment is taking longer than expected. Please check your phone or try again.\");\r\n        }\r\n      } catch (err) {\r\n        console.error(\"Polling error:\", err);\r\n        // Continue polling on error\r\n      }\r\n    }, 2000);\r\n  }\r\n\r\n  if (loading) {\r\n    return (\r\n      <div className=\"min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-50 via-blue-50/30 to-slate-50\">\r\n        <div className=\"text-center animate-in fade-in duration-300\">\r\n          <div className=\"relative\">\r\n            <div className=\"mx-auto mb-4 inline-flex\">\r\n              <LogoSpinner size=\"lg\" ariaLabel=\"Loading\" />\r\n            </div>\r\n          </div>\r\n          <p className=\"text-slate-700 font-medium text-lg\">Loading payment details...</p>\r\n          <p className=\"text-slate-500 text-sm mt-2\">Please wait</p>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  if (error && !invoice) {\r\n    return (\r\n      <div className=\"min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-50 via-blue-50/30 to-slate-50 p-6\">\r\n        <div className=\"max-w-md w-full bg-white/80 backdrop-blur-sm rounded-2xl shadow-xl border-2 border-red-200/60 p-8 text-center animate-in fade-in slide-in-from-bottom-4 duration-300\">\r\n          <div className=\"w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4\">\r\n            <AlertCircle className=\"w-8 h-8 text-red-500\" />\r\n          </div>\r\n          <h2 className=\"text-2xl font-bold text-slate-900 mb-3\">Error</h2>\r\n          <p className=\"text-slate-600 mb-6 leading-relaxed\">{error}</p>\r\n          <Link\r\n            href=\"/public/properties\"\r\n            className=\"inline-flex items-center justify-center px-6 py-3 rounded-xl bg-gradient-to-r from-[#02665e] to-[#014e47] text-white font-semibold hover:from-[#014e47] hover:to-[#02665e] transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105 active:scale-95\"\r\n          >\r\n            Browse Properties\r\n          </Link>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-gradient-to-br from-slate-50 via-blue-50/30 to-slate-50\">\r\n      {/* Header */}\r\n      <div className=\"bg-white/80 backdrop-blur-sm border-b border-slate-200/60 shadow-sm sticky top-0 z-10\">\r\n        <div className=\"public-container py-4\">\r\n          <button\r\n            onClick={() => router.back()}\r\n            className=\"inline-flex items-center justify-center w-10 h-10 rounded-full bg-slate-100 hover:bg-[#02665e] text-slate-600 hover:text-white transition-all duration-200 group shadow-sm hover:shadow-md\"\r\n            aria-label=\"Go back\"\r\n          >\r\n            <ChevronLeft className=\"w-5 h-5 group-hover:-translate-x-0.5 transition-transform duration-200\" />\r\n          </button>\r\n        </div>\r\n      </div>\r\n\r\n      <div className=\"public-container py-8 lg:py-12\">\r\n        <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6 lg:gap-8\">\r\n          {/* Main Content - Payment Methods */}\r\n          <div className=\"lg:col-span-2 space-y-6\">\r\n            {/* Payment Status */}\r\n            {paymentStatus === \"success\" && (\r\n              <div className=\"bg-gradient-to-br from-green-50 to-emerald-50/50 border-2 border-green-200 rounded-2xl p-8 text-center shadow-lg animate-in fade-in slide-in-from-top-4\">\r\n                <div className=\"w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4\">\r\n                  <CheckCircle2 className=\"w-10 h-10 text-green-500\" />\r\n                </div>\r\n                <h2 className=\"text-2xl lg:text-3xl font-bold text-green-900 mb-3\">\r\n                  Payment Successful!\r\n                </h2>\r\n                <p className=\"text-green-700 font-medium\">\r\n                  Redirecting to your receipt...\r\n                </p>\r\n              </div>\r\n            )}\r\n\r\n            {paymentStatus === \"pending\" && processing && (\r\n              <div className=\"bg-gradient-to-br from-blue-50 to-cyan-50/50 border-2 border-blue-200 rounded-2xl p-8 text-center shadow-lg animate-in fade-in slide-in-from-top-4\">\r\n                <div className=\"w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4\">\r\n                  <LogoSpinner size=\"md\" ariaLabel=\"Processing\" />\r\n                </div>\r\n                <h2 className=\"text-2xl lg:text-3xl font-bold text-blue-900 mb-3\">\r\n                  Processing Payment...\r\n                </h2>\r\n                <p className=\"text-blue-700 font-medium\">\r\n                  Please complete the payment on your phone. We'll update you when it's confirmed.\r\n                </p>\r\n              </div>\r\n            )}\r\n\r\n            {/* Payment Method Selection */}\r\n            {paymentStatus === \"idle\" && (\r\n              <>\r\n                <div className=\"bg-white/80 backdrop-blur-sm rounded-2xl shadow-lg border border-slate-200/60 p-5 lg:p-6 transition-all duration-300 hover:shadow-xl\">\r\n                  <h2 className=\"text-xl lg:text-2xl font-bold text-slate-900 mb-4 lg:mb-5\">\r\n                    Select Payment Method\r\n                  </h2>\r\n\r\n                  <div className=\"grid grid-cols-2 gap-3 lg:gap-4\">\r\n                    {PAYMENT_METHODS.map((method) => (\r\n                      <button\r\n                        key={method.id}\r\n                        type=\"button\"\r\n                        onClick={() => setSelectedMethod(method)}\r\n                        className={`group relative p-3.5 lg:p-4 rounded-lg border-2 transition-all duration-300 ${\r\n                          selectedMethod?.id === method.id\r\n                            ? \"border-[#02665e] bg-gradient-to-br from-[#02665e]/10 to-blue-50/50 shadow-md ring-2 ring-[#02665e]/20\"\r\n                            : \"border-slate-200 hover:border-[#02665e]/50 hover:shadow-md bg-white\"\r\n                        }`}\r\n                      >\r\n                        <div className=\"flex flex-col items-center text-center gap-2\">\r\n                          <div className=\"relative w-12 h-12 lg:w-14 lg:h-14 rounded-lg overflow-hidden flex-shrink-0 bg-white shadow-sm ring-1 ring-slate-100\">\r\n                            <Image\r\n                              src={method.icon}\r\n                              alt={method.name}\r\n                              fill\r\n                              sizes=\"(max-width: 768px) 48px, 56px\"\r\n                              className=\"object-contain p-1.5\"\r\n                            />\r\n                          </div>\r\n                          <div className=\"w-full\">\r\n                            <div className={`font-bold text-sm lg:text-base mb-0.5 ${\r\n                              selectedMethod?.id === method.id\r\n                                ? \"text-[#02665e]\"\r\n                                : \"text-slate-900\"\r\n                            }`}>\r\n                              {method.name}\r\n                            </div>\r\n                            <div className=\"text-xs text-slate-600\">\r\n                              {method.description}\r\n                            </div>\r\n                          </div>\r\n                          {selectedMethod?.id === method.id && (\r\n                            <div className=\"absolute top-1.5 right-1.5\">\r\n                              <div className=\"w-5 h-5 rounded-full bg-[#02665e] flex items-center justify-center shadow-md\">\r\n                                <CheckCircle2 className=\"w-3 h-3 text-white\" />\r\n                              </div>\r\n                            </div>\r\n                          )}\r\n                        </div>\r\n                      </button>\r\n                    ))}\r\n                  </div>\r\n                </div>\r\n\r\n                {/* Phone Number Input */}\r\n                {selectedMethod && (\r\n                  <div className=\"bg-white/80 backdrop-blur-sm rounded-2xl shadow-lg border border-slate-200/60 p-5 lg:p-6 transition-all duration-300 hover:shadow-xl overflow-hidden\">\r\n                    <h2 className=\"text-xl lg:text-2xl font-bold text-slate-900 mb-5\">\r\n                      Enter Phone Number\r\n                    </h2>\r\n\r\n                    <div className=\"space-y-4\">\r\n                      <div className=\"min-w-0\">\r\n                        <label className=\"flex w-full text-sm font-semibold text-slate-700 mb-3 items-center gap-2\">\r\n                          <Smartphone className=\"w-4 h-4 text-[#02665e] flex-shrink-0\" />\r\n                          <span>Phone Number <span className=\"text-red-500\">*</span></span>\r\n                        </label>\r\n                        <input\r\n                          type=\"tel\"\r\n                          value={phoneNumber}\r\n                          onChange={(e) => setPhoneNumber(e.target.value)}\r\n                          placeholder=\"+255 XXX XXX XXX\"\r\n                          className=\"w-full min-w-0 px-4 py-3.5 border-2 border-slate-300 rounded-xl focus:ring-2 focus:ring-[#02665e]/20 focus:border-[#02665e] transition-all duration-200 text-slate-900 font-medium bg-white shadow-sm hover:shadow-md box-border\"\r\n                        />\r\n                        <p className=\"text-xs text-slate-500 mt-2 ml-1\">\r\n                          Enter the phone number linked to your {selectedMethod.name} account\r\n                        </p>\r\n                      </div>\r\n\r\n                      {error && (\r\n                        <div className=\"bg-red-50/80 border-2 border-red-200 rounded-xl p-4 flex items-start gap-3 animate-in fade-in slide-in-from-top-2\">\r\n                          <AlertCircle className=\"w-5 h-5 text-red-500 flex-shrink-0 mt-0.5\" />\r\n                          <p className=\"text-sm font-medium text-red-700\">{error}</p>\r\n                        </div>\r\n                      )}\r\n\r\n                      <button\r\n                        type=\"button\"\r\n                        onClick={handlePayment}\r\n                        disabled={submitting || !phoneNumber.trim()}\r\n                        className=\"w-full py-4 px-6 rounded-xl bg-gradient-to-r from-[#02665e] to-[#014e47] text-white font-semibold hover:from-[#014e47] hover:to-[#02665e] transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-3 shadow-lg hover:shadow-xl transform hover:scale-[1.02] active:scale-[0.98]\"\r\n                      >\r\n                        {submitting ? (\r\n                          <>\r\n                            <LogoSpinner size=\"sm\" ariaLabel=\"Loading\" className=\"text-white/90\" />\r\n                            <span>Initiating payment...</span>\r\n                          </>\r\n                        ) : (\r\n                          <>\r\n                            <CreditCard className=\"w-5 h-5\" />\r\n                            <span>Pay {invoice?.totalAmount.toLocaleString()} {invoice?.currency}</span>\r\n                          </>\r\n                        )}\r\n                      </button>\r\n                    </div>\r\n                  </div>\r\n                )}\r\n              </>\r\n            )}\r\n          </div>\r\n\r\n          {/* Sidebar - Booking Summary */}\r\n          <div className=\"lg:col-span-1\">\r\n            <div className=\"bg-white/80 backdrop-blur-sm rounded-2xl shadow-lg border border-slate-200/60 p-6 lg:p-8 sticky top-8 transition-all duration-300 hover:shadow-xl\">\r\n              <h2 className=\"text-xl lg:text-2xl font-bold text-slate-900 mb-6 lg:mb-8\">\r\n                Booking Summary\r\n              </h2>\r\n\r\n              {invoice && (\r\n                <div className=\"space-y-5\">\r\n                  {invoice.property.primaryImage && (\r\n                    <div className=\"relative w-full h-40 lg:h-48 rounded-xl overflow-hidden shadow-md ring-2 ring-slate-100\">\r\n                      <Image\r\n                        src={invoice.property.primaryImage}\r\n                        alt={invoice.property.title}\r\n                        fill\r\n                        sizes=\"(max-width: 1024px) 100vw, 384px\"\r\n                        className=\"object-cover\"\r\n                      />\r\n                    </div>\r\n                  )}\r\n\r\n                  {/* Property */}\r\n                  <div className=\"pb-4 border-b border-slate-200/60\">\r\n                    <div className=\"text-xs font-semibold text-slate-500 uppercase tracking-wide mb-2\">Property</div>\r\n                    <div className=\"text-lg font-bold text-slate-900 leading-tight\">\r\n                      {invoice.property.title}\r\n                    </div>\r\n                    {invoice.property.type && (\r\n                      <div className=\"text-sm text-slate-600 mt-1\">\r\n                        {invoice.property.type}\r\n                      </div>\r\n                    )}\r\n                  </div>\r\n\r\n                  {/* Guest Information */}\r\n                  {(invoice.booking.guestName || invoice.booking.guestPhone) && (\r\n                    <div className=\"pb-4 border-b border-slate-200/60\">\r\n                      <div className=\"text-xs font-semibold text-slate-500 uppercase tracking-wide mb-3\">Guest Information</div>\r\n                      {invoice.booking.guestName && (\r\n                        <div className=\"mb-2\">\r\n                          <div className=\"text-xs text-slate-500 mb-1\">Name</div>\r\n                          <div className=\"text-sm font-semibold text-slate-900\">\r\n                            {invoice.booking.guestName}\r\n                          </div>\r\n                        </div>\r\n                      )}\r\n                      {invoice.booking.guestPhone && (\r\n                        <div>\r\n                          <div className=\"text-xs text-slate-500 mb-1\">Phone</div>\r\n                          <div className=\"text-sm font-semibold text-slate-900\">\r\n                            {invoice.booking.guestPhone}\r\n                          </div>\r\n                        </div>\r\n                      )}\r\n                    </div>\r\n                  )}\r\n\r\n                  {/* Check-in & Check-out */}\r\n                  <div className=\"pb-4 border-b border-slate-200/60\">\r\n                    <div className=\"text-xs font-semibold text-slate-500 uppercase tracking-wide mb-3\">Dates</div>\r\n                    <div className=\"grid grid-cols-2 gap-4\">\r\n                      <div>\r\n                        <div className=\"text-xs text-slate-500 mb-1\">Check-in</div>\r\n                        <div className=\"text-sm font-semibold text-slate-900\">\r\n                          {new Date(invoice.booking.checkIn).toLocaleDateString(\"en-US\", {\r\n                            weekday: \"short\",\r\n                            month: \"short\",\r\n                            day: \"numeric\",\r\n                            year: \"numeric\",\r\n                          })}\r\n                        </div>\r\n                      </div>\r\n                      <div>\r\n                        <div className=\"text-xs text-slate-500 mb-1\">Check-out</div>\r\n                        <div className=\"text-sm font-semibold text-slate-900\">\r\n                          {new Date(invoice.booking.checkOut).toLocaleDateString(\"en-US\", {\r\n                            weekday: \"short\",\r\n                            month: \"short\",\r\n                            day: \"numeric\",\r\n                            year: \"numeric\",\r\n                          })}\r\n                        </div>\r\n                      </div>\r\n                    </div>\r\n                    <div className=\"mt-3 pt-3 border-t border-slate-200/60\">\r\n                      <div className=\"text-xs text-slate-500 mb-1\">Duration</div>\r\n                      <div className=\"text-sm font-semibold text-slate-900\">\r\n                        {invoice.booking.nights} night{invoice.booking.nights !== 1 ? \"s\" : \"\"}\r\n                      </div>\r\n                    </div>\r\n                  </div>\r\n\r\n                  {/* Room Type */}\r\n                  {invoice.booking.roomCode && (\r\n                    <div className=\"pb-4 border-b border-slate-200/60\">\r\n                      <div className=\"text-xs font-semibold text-slate-500 uppercase tracking-wide mb-2\">Room</div>\r\n                      <div className=\"text-sm font-semibold text-slate-900\">\r\n                        {invoice.booking.roomCode}\r\n                      </div>\r\n                    </div>\r\n                  )}\r\n\r\n                  {/* Price Breakdown */}\r\n                  <div className=\"pb-4 border-b border-slate-200/60\">\r\n                    <div className=\"text-xs font-semibold text-slate-500 uppercase tracking-wide mb-3\">Price Breakdown</div>\r\n                    <div className=\"space-y-2.5\">\r\n                      {/* Accommodation */}\r\n                      <div className=\"flex justify-between text-sm\">\r\n                        <span className=\"text-slate-600\">\r\n                          Accommodation ({invoice.booking.nights} night{invoice.booking.nights !== 1 ? \"s\" : \"\"}\r\n                          {invoice.booking.roomsQty && invoice.booking.roomsQty > 1 ? ` × ${invoice.booking.roomsQty} rooms` : \"\"})\r\n                        </span>\r\n                        <span className=\"font-semibold text-slate-900\">\r\n                          {invoice.priceBreakdown?.accommodationSubtotal.toLocaleString() || (invoice.property.basePrice * invoice.booking.nights).toLocaleString()} {invoice.currency}\r\n                        </span>\r\n                      </div>\r\n                      \r\n                      {/* Tax - Always shown */}\r\n                      <div className=\"flex justify-between text-sm\">\r\n                        <span className=\"text-slate-600\">\r\n                          Tax {invoice.priceBreakdown?.taxPercent && invoice.priceBreakdown.taxPercent > 0 ? `(${invoice.priceBreakdown.taxPercent}%)` : \"\"}\r\n                        </span>\r\n                        <span className={`font-semibold ${invoice.priceBreakdown?.taxAmount && invoice.priceBreakdown.taxAmount > 0 ? \"text-slate-900\" : \"text-slate-400\"}`}>\r\n                          {invoice.priceBreakdown?.taxAmount ? invoice.priceBreakdown.taxAmount.toLocaleString() : \"0\"} {invoice.currency}\r\n                        </span>\r\n                      </div>\r\n                      \r\n                      {/* Service fee intentionally not shown here. */}\r\n                      \r\n                      {/* Transportation - Always shown */}\r\n                      <div className=\"flex justify-between text-sm\">\r\n                        <span className=\"text-slate-600\">Transportation</span>\r\n                        <span className={`font-semibold ${invoice.priceBreakdown?.transportFare && invoice.priceBreakdown.transportFare > 0 ? \"text-slate-900\" : \"text-slate-400\"}`}>\r\n                          {invoice.priceBreakdown?.transportFare ? invoice.priceBreakdown.transportFare.toLocaleString() : \"0\"} {invoice.currency}\r\n                        </span>\r\n                      </div>\r\n                      \r\n                      {/* Subtotal - Always shown if breakdown exists */}\r\n                      {invoice.priceBreakdown?.subtotal !== undefined && (\r\n                        <div className=\"flex justify-between text-sm pt-2 border-t border-slate-200/60\">\r\n                          <span className=\"font-medium text-slate-700\">Subtotal</span>\r\n                          <span className=\"font-semibold text-slate-900\">\r\n                            {invoice.priceBreakdown.subtotal.toLocaleString()} {invoice.currency}\r\n                          </span>\r\n                        </div>\r\n                      )}\r\n                      \r\n                      {/* Discount - Always shown */}\r\n                      <div className=\"flex justify-between text-sm\">\r\n                        <span className={`font-medium ${invoice.priceBreakdown?.discount && invoice.priceBreakdown.discount > 0 ? \"text-green-600\" : \"text-slate-400\"}`}>\r\n                          Discount\r\n                        </span>\r\n                        <span className={`font-semibold ${invoice.priceBreakdown?.discount && invoice.priceBreakdown.discount > 0 ? \"text-green-600\" : \"text-slate-400\"}`}>\r\n                          {invoice.priceBreakdown?.discount && invoice.priceBreakdown.discount > 0 ? \"-\" : \"\"}{invoice.priceBreakdown?.discount ? invoice.priceBreakdown.discount.toLocaleString() : \"0\"} {invoice.currency}\r\n                        </span>\r\n                      </div>\r\n                    </div>\r\n                  </div>\r\n\r\n                  {/* Total */}\r\n                  <div className=\"pt-2 pb-4 border-b border-slate-200/60\">\r\n                    <div className=\"flex justify-between items-center\">\r\n                      <span className=\"text-lg font-bold text-slate-900\">Total</span>\r\n                      <span className=\"text-2xl font-bold text-[#02665e]\">\r\n                        {invoice.totalAmount.toLocaleString()} {invoice.currency}\r\n                      </span>\r\n                    </div>\r\n                  </div>\r\n\r\n                  {/* Secure Payment */}\r\n                  <div className=\"pt-4\">\r\n                    <div className=\"flex items-start gap-3 p-4 bg-gradient-to-br from-slate-50 to-blue-50/50 rounded-xl border border-slate-200/60\">\r\n                      <ShieldCheck className=\"w-5 h-5 text-[#02665e] flex-shrink-0 mt-0.5\" />\r\n                      <div>\r\n                        <div className=\"font-semibold text-slate-900 mb-1 text-sm\">\r\n                          Secure Payment\r\n                        </div>\r\n                        <div className=\"text-xs text-slate-600 leading-relaxed\">\r\n                          Your payment is processed securely through our payment partners.\r\n                        </div>\r\n                      </div>\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n              )}\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\public\\booking\\receipt\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\public\\booking\\view\\[code]\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'MapPin' is defined but never used. Allowed unused vars must match /^_/u.","line":4,"column":32,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":38,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"MapPin"},"fix":{"range":[136,144],"text":""},"desc":"Remove unused variable \"MapPin\"."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadBooking'. Either include it or remove the dependency array.","line":47,"column":6,"nodeType":"ArrayExpression","endLine":47,"endColumn":12,"suggestions":[{"desc":"Update the dependencies array to be: [code, loadBooking]","fix":{"range":[1214,1220],"text":"[code, loadBooking]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\nimport { useEffect, useState } from \"react\";\r\nimport { useParams } from \"next/navigation\";\r\nimport { FileCheck2, Calendar, MapPin, User, CreditCard, CheckCircle } from \"lucide-react\";\r\n\r\ntype BookingData = {\r\n  booking: {\r\n    id: number;\r\n    bookingCode: string;\r\n    guestName: string;\r\n    guestPhone?: string;\r\n    nationality?: string;\r\n    property: {\r\n      title: string;\r\n      type: string;\r\n      regionName?: string;\r\n      district?: string;\r\n      city?: string;\r\n      country?: string;\r\n    };\r\n    checkIn: string;\r\n    checkOut: string;\r\n    nights: number;\r\n    roomType?: string;\r\n    rooms?: number;\r\n    totalAmount: number;\r\n    status: string;\r\n    services?: any;\r\n    invoice?: {\r\n      invoiceNumber?: string;\r\n      receiptNumber?: string;\r\n      paidAt?: string;\r\n    };\r\n  };\r\n};\r\n\r\nexport default function PublicBookingViewPage() {\r\n  const params = useParams();\r\n  const code = String((params as any)?.code ?? \"\");\r\n  const [booking, setBooking] = useState<BookingData | null>(null);\r\n  const [loading, setLoading] = useState(true);\r\n  const [error, setError] = useState<string | null>(null);\r\n\r\n  useEffect(() => {\r\n    if (!code) return;\r\n    loadBooking();\r\n  }, [code]);\r\n\r\n  const loadBooking = async () => {\r\n    try {\r\n      setLoading(true);\r\n      const response = await fetch(`/api/public/booking/${code}`);\r\n      if (!response.ok) {\r\n        const error = await response.json();\r\n        throw new Error(error.error || \"Booking not found\");\r\n      }\r\n      const data = await response.json();\r\n      setBooking(data);\r\n    } catch (err: any) {\r\n      setError(err.message || \"Failed to load booking\");\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  const formatDate = (dateString: string) => {\r\n    return new Date(dateString).toLocaleDateString(\"en-US\", {\r\n      year: \"numeric\",\r\n      month: \"long\",\r\n      day: \"numeric\",\r\n    });\r\n  };\r\n\r\n  if (loading) {\r\n    return (\r\n      <div className=\"min-h-screen flex items-center justify-center bg-gray-50\">\r\n        <div className=\"text-center\">\r\n          <div className=\"inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-emerald-600\"></div>\r\n          <p className=\"mt-4 text-slate-600\">Loading booking details...</p>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  if (error || !booking) {\r\n    return (\r\n      <div className=\"min-h-screen flex items-center justify-center bg-gray-50 px-4\">\r\n        <div className=\"max-w-md w-full bg-white rounded-lg border border-red-200 p-6 text-center\">\r\n          <FileCheck2 className=\"w-12 h-12 text-red-500 mx-auto mb-4\" />\r\n          <h1 className=\"text-xl font-semibold text-slate-900 mb-2\">Booking Not Found</h1>\r\n          <p className=\"text-slate-600\">{error || \"The booking code you scanned is not valid or has expired.\"}</p>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  const b = booking.booking;\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-gray-50 py-8 px-4\">\r\n      <div className=\"max-w-2xl mx-auto\">\r\n        <div className=\"bg-white rounded-lg border border-slate-200 shadow-sm p-6 mb-6\">\r\n          <div className=\"flex items-center justify-center mb-4\">\r\n            <div className=\"p-3 bg-emerald-100 rounded-full\">\r\n              <FileCheck2 className=\"w-8 h-8 text-emerald-600\" />\r\n            </div>\r\n          </div>\r\n          <h1 className=\"text-2xl font-bold text-center text-slate-900 mb-2\">Booking Confirmation</h1>\r\n          <div className=\"text-center mb-6\">\r\n            <div className=\"inline-block px-4 py-2 bg-emerald-50 border border-emerald-200 rounded-lg\">\r\n              <span className=\"text-sm text-slate-600\">Booking Code:</span>\r\n              <span className=\"ml-2 font-mono font-bold text-emerald-600 text-lg\">{b.bookingCode}</span>\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"space-y-4\">\r\n            {/* Personal Information */}\r\n            <div className=\"border border-slate-200 rounded-lg overflow-hidden\">\r\n              <div className=\"bg-emerald-600 text-white px-4 py-2 font-semibold flex items-center gap-2\">\r\n                <User className=\"w-5 h-5\" />\r\n                Personal Information\r\n              </div>\r\n              <div className=\"p-4 space-y-2\">\r\n                <div className=\"flex justify-between\">\r\n                  <span className=\"text-slate-600\">Name:</span>\r\n                  <span className=\"font-medium\">{b.guestName}</span>\r\n                </div>\r\n                {b.guestPhone && (\r\n                  <div className=\"flex justify-between\">\r\n                    <span className=\"text-slate-600\">Phone:</span>\r\n                    <span className=\"font-medium\">{b.guestPhone}</span>\r\n                  </div>\r\n                )}\r\n                {b.nationality && (\r\n                  <div className=\"flex justify-between\">\r\n                    <span className=\"text-slate-600\">Nationality:</span>\r\n                    <span className=\"font-medium\">{b.nationality}</span>\r\n                  </div>\r\n                )}\r\n              </div>\r\n            </div>\r\n\r\n            {/* Booking Details */}\r\n            <div className=\"border border-slate-200 rounded-lg overflow-hidden\">\r\n              <div className=\"bg-emerald-600 text-white px-4 py-2 font-semibold flex items-center gap-2\">\r\n                <Calendar className=\"w-5 h-5\" />\r\n                Booking Details\r\n              </div>\r\n              <div className=\"p-4 space-y-2\">\r\n                <div className=\"flex justify-between\">\r\n                  <span className=\"text-slate-600\">Property:</span>\r\n                  <span className=\"font-medium\">{b.property.title}</span>\r\n                </div>\r\n                <div className=\"flex justify-between\">\r\n                  <span className=\"text-slate-600\">Type:</span>\r\n                  <span className=\"font-medium\">{b.property.type}</span>\r\n                </div>\r\n                {b.property.regionName && (\r\n                  <div className=\"flex justify-between\">\r\n                    <span className=\"text-slate-600\">Location:</span>\r\n                    <span className=\"font-medium text-right\">\r\n                      {[b.property.regionName, b.property.district, b.property.city]\r\n                        .filter(Boolean)\r\n                        .join(\", \")}\r\n                    </span>\r\n                  </div>\r\n                )}\r\n                {b.roomType && (\r\n                  <div className=\"flex justify-between\">\r\n                    <span className=\"text-slate-600\">Room Type:</span>\r\n                    <span className=\"font-medium\">{b.roomType}</span>\r\n                  </div>\r\n                )}\r\n                {b.rooms && (\r\n                  <div className=\"flex justify-between\">\r\n                    <span className=\"text-slate-600\">Rooms:</span>\r\n                    <span className=\"font-medium\">{b.rooms}</span>\r\n                  </div>\r\n                )}\r\n                <div className=\"flex justify-between\">\r\n                  <span className=\"text-slate-600\">Check-in:</span>\r\n                  <span className=\"font-medium\">{formatDate(b.checkIn)}</span>\r\n                </div>\r\n                <div className=\"flex justify-between\">\r\n                  <span className=\"text-slate-600\">Check-out:</span>\r\n                  <span className=\"font-medium\">{formatDate(b.checkOut)}</span>\r\n                </div>\r\n                <div className=\"flex justify-between\">\r\n                  <span className=\"text-slate-600\">Nights:</span>\r\n                  <span className=\"font-medium\">{b.nights}</span>\r\n                </div>\r\n                <div className=\"flex justify-between pt-2 border-t border-slate-200\">\r\n                  <span className=\"text-slate-600 font-semibold\">Total Amount:</span>\r\n                  <span className=\"font-bold text-lg text-emerald-600\">\r\n                    {Number(b.totalAmount).toLocaleString(\"en-US\")} TZS\r\n                  </span>\r\n                </div>\r\n              </div>\r\n            </div>\r\n\r\n            {/* Payment Information */}\r\n            {b.invoice && (\r\n              <div className=\"border border-slate-200 rounded-lg overflow-hidden\">\r\n                <div className=\"bg-emerald-600 text-white px-4 py-2 font-semibold flex items-center gap-2\">\r\n                  <CreditCard className=\"w-5 h-5\" />\r\n                  Payment Information\r\n                </div>\r\n                <div className=\"p-4 space-y-2\">\r\n                  {b.invoice.receiptNumber && (\r\n                    <div className=\"flex justify-between\">\r\n                      <span className=\"text-slate-600\">Receipt Number:</span>\r\n                      <span className=\"font-medium\">{b.invoice.receiptNumber}</span>\r\n                    </div>\r\n                  )}\r\n                  {b.invoice.invoiceNumber && (\r\n                    <div className=\"flex justify-between\">\r\n                      <span className=\"text-slate-600\">Invoice Number:</span>\r\n                      <span className=\"font-medium\">{b.invoice.invoiceNumber}</span>\r\n                    </div>\r\n                  )}\r\n                  {b.invoice.paidAt && (\r\n                    <div className=\"flex justify-between\">\r\n                      <span className=\"text-slate-600\">Paid On:</span>\r\n                      <span className=\"font-medium\">{formatDate(b.invoice.paidAt)}</span>\r\n                    </div>\r\n                  )}\r\n                  <div className=\"flex items-center gap-2 pt-2 border-t border-slate-200\">\r\n                    <CheckCircle className=\"w-5 h-5 text-emerald-600\" />\r\n                    <span className=\"font-medium text-emerald-600\">Payment Confirmed</span>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            )}\r\n\r\n            {/* Services */}\r\n            {b.services && (\r\n              <div className=\"border border-slate-200 rounded-lg overflow-hidden\">\r\n                <div className=\"bg-emerald-600 text-white px-4 py-2 font-semibold\">\r\n                  Inclusive Services\r\n                </div>\r\n                <div className=\"p-4\">\r\n                  <p className=\"text-slate-700\">\r\n                    {typeof b.services === \"string\"\r\n                      ? b.services\r\n                      : JSON.stringify(b.services, null, 2)}\r\n                  </p>\r\n                </div>\r\n              </div>\r\n            )}\r\n          </div>\r\n\r\n          <div className=\"mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg\">\r\n            <p className=\"text-sm text-blue-800\">\r\n              <strong>Note:</strong> This booking information was accessed via QR code scan. \r\n              Present your booking code at the property during check-in.\r\n            </p>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\public\\countries\\[country]\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\public\\group-stays\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\public\\layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\public\\no4p-ai\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\public\\page.tsx","messages":[],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'PROPERTY_TYPE_CARDS'. Either include it or remove the dependency array.","line":526,"column":6,"nodeType":"ArrayExpression","endLine":526,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [PROPERTY_TYPE_CARDS]","fix":{"range":[19827,19829],"text":"[PROPERTY_TYPE_CARDS]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\public\\plan-with-us\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\public\\properties\\[slug]\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\public\\properties\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\register\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\security\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\terms\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'isAdmin' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":110,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":110,"endColumn":16}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport Terms from \"@/components/Terms\";\nimport { TERMS_LAST_UPDATED, TERMS_SECTIONS } from \"@/components/termsContent\";\nimport PublicHeader from \"@/components/PublicHeader\";\nimport PublicFooter from \"@/components/PublicFooter\";\nimport SiteHeader from \"@/components/SiteHeader\";\nimport OwnerSiteHeader from \"@/components/OwnerSiteHeader\";\nimport DriverSiteHeader from \"@/components/DriverSiteHeader\";\nimport SiteFooter from \"@/components/SiteFooter\";\nimport LayoutFrame from \"@/components/LayoutFrame\";\nimport { FileText } from \"lucide-react\";\nimport { useEffect, useState } from \"react\";\nimport { usePathname } from \"next/navigation\";\n\nfunction getCookie(name: string): string | null {\n  if (typeof document === 'undefined') return null;\n  const value = `; ${document.cookie}`;\n  const parts = value.split(`; ${name}=`);\n  if (parts.length === 2) return parts.pop()?.split(';').shift() || null;\n  return null;\n}\n\nexport default function TermsPage() {\n  const pathname = usePathname();\n  const [userRole, setUserRole] = useState<\"ADMIN\" | \"OWNER\" | \"DRIVER\" | null>(null);\n  const [isLoading, setIsLoading] = useState(true);\n  const [isPublicContext, setIsPublicContext] = useState<boolean | null>(null);\n\n  useEffect(() => {\n    // PRIORITY 1: Check sessionStorage for navigation context (set by headers/footers)\n    // This is the most reliable indicator of where the user came from\n    let navigationContext: 'public' | 'owner' | 'driver' | 'admin' | null = null;\n    if (typeof window !== 'undefined') {\n      navigationContext = sessionStorage.getItem('navigationContext') as 'public' | 'owner' | 'driver' | 'admin' | null;\n    }\n\n    // If we have navigation context from sessionStorage, use it (this takes priority)\n    if (navigationContext) {\n      if (navigationContext === 'public') {\n        setIsPublicContext(true);\n        setUserRole(null);\n        setIsLoading(false);\n        return;\n      } else {\n        setIsPublicContext(false);\n        setUserRole(navigationContext.toUpperCase() as \"ADMIN\" | \"OWNER\" | \"DRIVER\");\n        setIsLoading(false);\n        return;\n      }\n    }\n\n    // PRIORITY 2: Check referrer to determine context\n    // If coming from a public route, use public layout regardless of cookie\n    let isFromPublicRoute = false;\n    if (typeof document !== 'undefined') {\n      const referrer = document.referrer;\n      const origin = window.location.origin;\n      isFromPublicRoute = !!referrer && (\n        referrer.includes('/public') || \n        referrer === origin || \n        referrer === origin + '/' ||\n        (!referrer.includes('/owner') && !referrer.includes('/driver') && !referrer.includes('/admin') && referrer.startsWith(origin))\n      );\n    }\n\n    // If coming from a public route, treat as public (even if they have a role cookie)\n    if (isFromPublicRoute) {\n      setIsPublicContext(true);\n      setUserRole(null);\n      setIsLoading(false);\n      return;\n    }\n\n    // PRIORITY 3: Check if user is authenticated via cookie\n    // Only use this if we don't have public context from above\n    const role = getCookie('role') as \"ADMIN\" | \"OWNER\" | \"DRIVER\" | null;\n    if (role) {\n      setIsPublicContext(false);\n      setUserRole(role);\n      setIsLoading(false);\n      return;\n    }\n    \n    // PRIORITY 4: Check pathname as final fallback to determine context\n      if (pathname?.includes('/driver')) {\n      setIsPublicContext(false);\n        setUserRole('DRIVER');\n      } else if (pathname?.includes('/owner')) {\n      setIsPublicContext(false);\n        setUserRole('OWNER');\n      } else if (pathname?.includes('/admin')) {\n      setIsPublicContext(false);\n        setUserRole('ADMIN');\n      } else {\n      // Default to public context if no indicators\n      setIsPublicContext(true);\n        setUserRole(null);\n    }\n    \n    setIsLoading(false);\n  }, [pathname]);\n\n  // Determine which header and footer to use\n  // Prioritize public context if detected, otherwise use authentication status\n  const shouldUsePublicLayout = isPublicContext === true || (isPublicContext === null && userRole === null);\n  const isAuthenticated = !shouldUsePublicLayout && userRole !== null;\n  const isDriver = userRole === \"DRIVER\";\n  const isOwner = userRole === \"OWNER\";\n  const isAdmin = userRole === \"ADMIN\";\n\n  // Show loading state briefly to avoid flash\n  if (isLoading || isPublicContext === null) {\n    return (\n      <>\n        <PublicHeader />\n        <main className=\"min-h-screen bg-white text-slate-900\">\n          <div className=\"public-container py-10\">\n            <div className=\"text-center\">Loading...</div>\n          </div>\n        </main>\n        <PublicFooter withRail={false} />\n      </>\n    );\n  }\n\n  return (\n    <>\n      {shouldUsePublicLayout ? (\n        <PublicHeader />\n      ) : isAuthenticated ? (\n        isDriver ? (\n          <DriverSiteHeader />\n        ) : isOwner ? (\n          <OwnerSiteHeader />\n        ) : (\n          <SiteHeader role=\"ADMIN\" />\n        )\n      ) : (\n        <PublicHeader />\n      )}\n      \n      <main className=\"min-h-screen bg-white text-slate-900\">\n        {/* Layout edge markers (left/right) to indicate content boundaries */}\n        <LayoutFrame heightVariant=\"sm\" topVariant=\"sm\" colorVariant=\"muted\" variant=\"solid\" />\n        \n        {/* Hero Image Section */}\n        <section className=\"relative h-48 md:h-64 lg:h-80 overflow-hidden\">\n          <div className=\"public-container h-full relative\">\n            <div className=\"absolute inset-0 bg-[url('/assets/nolsaf%20picture%201.jpg')] bg-cover bg-center rounded-lg\" />\n            <div className=\"absolute inset-0 bg-gradient-to-b from-black/40 via-black/20 to-transparent rounded-lg\" />\n            <div className=\"relative h-full flex flex-col items-center justify-center\">\n              <FileText size={64} className=\"text-white mb-4 drop-shadow-lg\" strokeWidth={1.5} />\n              <h1 className=\"text-3xl md:text-4xl lg:text-5xl font-bold text-white text-center px-4 drop-shadow-lg\">\n                Terms and Conditions\n              </h1>\n            </div>\n          </div>\n        </section>\n        \n        <section className=\"relative bg-[#f7f9fb] pt-6 sm:pt-8 md:pt-10 pb-4 sm:pb-6 md:pb-10 overflow-x-hidden\">\n          <div className=\"public-container\">\n            <div className=\"w-full bg-white rounded-lg shadow-sm border border-gray-100 p-4 sm:p-6 md:p-10 lg:p-12 box-border overflow-x-hidden\">\n              <Terms headline=\"\" lastUpdated={TERMS_LAST_UPDATED} sections={TERMS_SECTIONS} />\n            </div>\n          </div>\n        </section>\n      </main>\n      \n      {shouldUsePublicLayout ? (\n        <PublicFooter withRail={false} />\n      ) : isAuthenticated ? (\n        <SiteFooter withRail={false} topSeparator={true} />\n      ) : (\n        <PublicFooter withRail={false} />\n      )}\n    </>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\updates\\challenges\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\updates\\page.tsx","messages":[],"suppressedMessages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":153,"column":29,"nodeType":"JSXOpeningElement","endLine":168,"endColumn":31,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":179,"column":33,"nodeType":"JSXOpeningElement","endLine":185,"endColumn":35,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\updates\\success-stories\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\updates\\youtube\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\app\\verification-policy\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'VerifiedIcon' is defined but never used. Allowed unused vars must match /^_/u.","line":12,"column":8,"nodeType":"Identifier","messageId":"unusedVar","endLine":12,"endColumn":20,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"VerifiedIcon"},"fix":{"range":[549,602],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'isAdmin' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":111,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":111,"endColumn":16}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport Terms from \"@/components/Terms\";\r\nimport { VERIFICATION_LAST_UPDATED, VERIFICATION_SECTIONS } from \"@/components/verificationContent\";\r\nimport PublicHeader from \"@/components/PublicHeader\";\r\nimport PublicFooter from \"@/components/PublicFooter\";\r\nimport SiteHeader from \"@/components/SiteHeader\";\r\nimport OwnerSiteHeader from \"@/components/OwnerSiteHeader\";\r\nimport DriverSiteHeader from \"@/components/DriverSiteHeader\";\r\nimport SiteFooter from \"@/components/SiteFooter\";\r\nimport LayoutFrame from \"@/components/LayoutFrame\";\r\nimport VerifiedIcon from \"@/components/VerifiedIcon\";\r\nimport { CheckCircle } from \"lucide-react\";\r\nimport { useEffect, useState } from \"react\";\r\nimport { usePathname } from \"next/navigation\";\r\n\r\nfunction getCookie(name: string): string | null {\r\n  if (typeof document === 'undefined') return null;\r\n  const value = `; ${document.cookie}`;\r\n  const parts = value.split(`; ${name}=`);\r\n  if (parts.length === 2) return parts.pop()?.split(';').shift() || null;\r\n  return null;\r\n}\r\n\r\nexport default function VerificationPolicyPage() {\r\n  const pathname = usePathname();\r\n  const [userRole, setUserRole] = useState<\"ADMIN\" | \"OWNER\" | \"DRIVER\" | null>(null);\r\n  const [isLoading, setIsLoading] = useState(true);\r\n  const [isPublicContext, setIsPublicContext] = useState<boolean | null>(null);\r\n\r\n  useEffect(() => {\r\n    // PRIORITY 1: Check sessionStorage for navigation context (set by headers/footers)\r\n    // This is the most reliable indicator of where the user came from\r\n    let navigationContext: 'public' | 'owner' | 'driver' | 'admin' | null = null;\r\n    if (typeof window !== 'undefined') {\r\n      navigationContext = sessionStorage.getItem('navigationContext') as 'public' | 'owner' | 'driver' | 'admin' | null;\r\n    }\r\n\r\n    // If we have navigation context from sessionStorage, use it (this takes priority)\r\n    if (navigationContext) {\r\n      if (navigationContext === 'public') {\r\n        setIsPublicContext(true);\r\n        setUserRole(null);\r\n        setIsLoading(false);\r\n        return;\r\n      } else {\r\n        setIsPublicContext(false);\r\n        setUserRole(navigationContext.toUpperCase() as \"ADMIN\" | \"OWNER\" | \"DRIVER\");\r\n        setIsLoading(false);\r\n        return;\r\n      }\r\n    }\r\n\r\n    // PRIORITY 2: Check referrer to determine context\r\n    // If coming from a public route, use public layout regardless of cookie\r\n    let isFromPublicRoute = false;\r\n    if (typeof document !== 'undefined') {\r\n      const referrer = document.referrer;\r\n      const origin = window.location.origin;\r\n      isFromPublicRoute = !!referrer && (\r\n        referrer.includes('/public') || \r\n        referrer === origin || \r\n        referrer === origin + '/' ||\r\n        (!referrer.includes('/owner') && !referrer.includes('/driver') && !referrer.includes('/admin') && referrer.startsWith(origin))\r\n      );\r\n    }\r\n\r\n    // If coming from a public route, treat as public (even if they have a role cookie)\r\n    if (isFromPublicRoute) {\r\n      setIsPublicContext(true);\r\n      setUserRole(null);\r\n      setIsLoading(false);\r\n      return;\r\n    }\r\n\r\n    // PRIORITY 3: Check if user is authenticated via cookie\r\n    // Only use this if we don't have public context from above\r\n    const role = getCookie('role') as \"ADMIN\" | \"OWNER\" | \"DRIVER\" | null;\r\n    if (role) {\r\n      setIsPublicContext(false);\r\n      setUserRole(role);\r\n      setIsLoading(false);\r\n      return;\r\n    }\r\n    \r\n    // PRIORITY 4: Check pathname as final fallback to determine context\r\n    if (pathname?.includes('/driver')) {\r\n      setIsPublicContext(false);\r\n      setUserRole('DRIVER');\r\n    } else if (pathname?.includes('/owner')) {\r\n      setIsPublicContext(false);\r\n      setUserRole('OWNER');\r\n    } else if (pathname?.includes('/admin')) {\r\n      setIsPublicContext(false);\r\n      setUserRole('ADMIN');\r\n    } else {\r\n      // Default to public context if no indicators\r\n      setIsPublicContext(true);\r\n      setUserRole(null);\r\n    }\r\n    \r\n    setIsLoading(false);\r\n  }, [pathname]);\r\n\r\n  // Determine which header and footer to use\r\n  // Prioritize public context if detected, otherwise use authentication status\r\n  const shouldUsePublicLayout = isPublicContext === true || (isPublicContext === null && userRole === null);\r\n  const isAuthenticated = !shouldUsePublicLayout && userRole !== null;\r\n  const isDriver = userRole === \"DRIVER\";\r\n  const isOwner = userRole === \"OWNER\";\r\n  const isAdmin = userRole === \"ADMIN\";\r\n\r\n  // Show loading state briefly to avoid flash\r\n  if (isLoading || isPublicContext === null) {\r\n    return (\r\n      <>\r\n        <PublicHeader />\r\n        <main className=\"min-h-screen bg-white text-slate-900\">\r\n          <div className=\"public-container py-10\">\r\n            <div className=\"text-center\">Loading...</div>\r\n          </div>\r\n        </main>\r\n        <PublicFooter withRail={false} />\r\n      </>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <>\r\n      {shouldUsePublicLayout ? (\r\n        <PublicHeader />\r\n      ) : isAuthenticated ? (\r\n        isDriver ? (\r\n          <DriverSiteHeader />\r\n        ) : isOwner ? (\r\n          <OwnerSiteHeader />\r\n        ) : (\r\n          <SiteHeader role=\"ADMIN\" />\r\n        )\r\n      ) : (\r\n        <PublicHeader />\r\n      )}\r\n      \r\n      <main className=\"min-h-screen bg-white text-slate-900\">\r\n        {/* Layout edge markers (left/right) to indicate content boundaries */}\r\n        <LayoutFrame heightVariant=\"sm\" topVariant=\"sm\" colorVariant=\"muted\" variant=\"solid\" />\r\n        \r\n        {/* Hero Image Section */}\r\n        <section className=\"relative h-48 md:h-64 lg:h-80 overflow-hidden\">\r\n          <div className=\"public-container h-full relative\">\r\n            <div className=\"absolute inset-0 bg-[url('/assets/nolsaf%20picture%201.jpg')] bg-cover bg-center rounded-lg\" />\r\n            <div className=\"absolute inset-0 bg-gradient-to-b from-black/40 via-black/20 to-transparent rounded-lg\" />\r\n            <div className=\"relative h-full flex flex-col items-center justify-center\">\r\n              <div className=\"mb-4\">\r\n                <span className=\"rounded-full w-20 h-20 md:w-24 md:h-24 flex items-center justify-center shadow-lg ring-4 ring-white/60 bg-white/20 backdrop-blur-md backdrop-saturate-150\">\r\n                  <CheckCircle className=\"w-12 h-12 md:w-14 md:h-14 text-green-700\" strokeWidth={2} />\r\n                </span>\r\n              </div>\r\n              <h1 className=\"text-3xl md:text-4xl lg:text-5xl font-bold text-white text-center px-4 drop-shadow-lg\">\r\n                Verification Policy\r\n              </h1>\r\n            </div>\r\n          </div>\r\n        </section>\r\n        \r\n        <section className=\"relative bg-[#f7f9fb] pt-6 sm:pt-8 md:pt-10 pb-4 sm:pb-6 md:pb-10 overflow-x-hidden\">\r\n          <div className=\"public-container\">\r\n            <div className=\"w-full bg-white rounded-lg shadow-sm border border-gray-100 p-4 sm:p-6 md:p-10 lg:p-12 box-border overflow-x-hidden\">\r\n              <Terms headline=\"\" lastUpdated={VERIFICATION_LAST_UPDATED} sections={VERIFICATION_SECTIONS} />\r\n            </div>\r\n          </div>\r\n        </section>\r\n      </main>\r\n      \r\n      {shouldUsePublicLayout ? (\r\n        <PublicFooter withRail={false} />\r\n      ) : isAuthenticated ? (\r\n        <SiteFooter withRail={false} topSeparator={true} />\r\n      ) : (\r\n        <PublicFooter withRail={false} />\r\n      )}\r\n    </>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\AdminAnalyticsClient.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\AdminFooter.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\AdminIntro.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\AdminMiniFooter.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\AdminNav.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\AdminPageHeader.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\AdminSidebar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\AgentContractContent.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\AgentFooter.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\AgentPortalHeader.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\Articles.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\AttentionBlink.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\AuthPageFlip.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\AzamPayButton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\BackIcon.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\BookingFlowCard.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'stepMeta'. Either include it or remove the dependency array.","line":233,"column":6,"nodeType":"ArrayExpression","endLine":233,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [stepMeta]","fix":{"range":[8592,8594],"text":"[stepMeta]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport React, { useState, useEffect, useRef, useCallback } from 'react';\r\nimport Link from 'next/link';\r\nimport Image from 'next/image';\r\nimport { ArrowRight, BadgeCheck, CheckCircle2, Home, KeyRound, MapPinned, PlayCircle, ShieldCheck, User } from 'lucide-react';\r\nimport VoiceRecorder from './VoiceRecorder';\r\n\r\nexport default function BookingFlowCard() {\r\n  const [busy, setBusy] = useState(false);\r\n  const [activeStep, setActiveStep] = useState<number>(1);\r\n  const [imgError, setImgError] = useState(false);\r\n  const [selectedPayment, setSelectedPayment] = useState<string | null>(null);\r\n  // voice recorder handled by reusable component\r\n  const containerRef = useRef<HTMLElement | null>(null);\r\n  const timerRef = useRef<number | undefined>(undefined);\r\n  const isInteractingRef = useRef(false);\r\n  const [isInteracting, setIsInteracting] = useState(false);\r\n  // Animation state for transitions\r\n  const [isTransitioning, setIsTransitioning] = useState(false);\r\n  const highlightRef = useRef<HTMLSpanElement>(null);\r\n\r\n  const ROTATE_MS = 5000; // auto-rotate interval when idle\r\n  const STEPS_COUNT = 5;\r\n\r\n  useEffect(() => {\r\n    // reset image error when changing steps so we try to load new image\r\n    setImgError(false);\r\n  }, [activeStep]);\r\n\r\n  // Handle step transitions with animation\r\n  const handleStepChange = useCallback((newStep: number) => {\r\n    if (newStep === activeStep || isTransitioning) return;\r\n    \r\n    setIsTransitioning(true);\r\n    \r\n    // Update highlight bar position using CSS variables for animation\r\n    if (highlightRef.current) {\r\n      const stepWidth = 100 / STEPS_COUNT;\r\n      const prevOffset = ((activeStep - 1) * stepWidth);\r\n      const currentOffset = ((newStep - 1) * stepWidth);\r\n      \r\n      highlightRef.current.style.setProperty('--prev-offset', `${prevOffset}%`);\r\n      highlightRef.current.style.setProperty('--current-offset', `${currentOffset}%`);\r\n      highlightRef.current.classList.add('step-highlight-animate');\r\n    }\r\n    \r\n    // Trigger exit animation, then enter\r\n    setTimeout(() => {\r\n      setActiveStep(newStep);\r\n      // Remove animation class after animation completes to allow re-triggering\r\n      setTimeout(() => {\r\n        setIsTransitioning(false);\r\n        if (highlightRef.current) {\r\n          highlightRef.current.classList.remove('step-highlight-animate');\r\n        }\r\n      }, 600);\r\n    }, 200);\r\n  }, [activeStep, isTransitioning]);\r\n\r\n  const clearIdleTimer = useCallback(() => {\r\n    if (timerRef.current) {\r\n      window.clearTimeout(timerRef.current);\r\n      timerRef.current = undefined;\r\n    }\r\n  }, []);\r\n\r\n  const scheduleIdleAdvance = useCallback((ms = ROTATE_MS) => {\r\n    clearIdleTimer();\r\n    // don't schedule while user is interacting or transitioning\r\n    if (isInteractingRef.current || isTransitioning) return;\r\n    timerRef.current = window.setTimeout(() => {\r\n      const current = activeStep ?? 1;\r\n      const next = (current % STEPS_COUNT) + 1;\r\n      handleStepChange(next);\r\n      // schedule next advance after another idle interval\r\n      scheduleIdleAdvance(ROTATE_MS);\r\n    }, ms) as unknown as number;\r\n  }, [clearIdleTimer, activeStep, isTransitioning, handleStepChange]);\r\n\r\n  useEffect(() => {\r\n    // start the idle rotation schedule on mount\r\n    scheduleIdleAdvance();\r\n\r\n    const el = containerRef.current;\r\n    if (!el) return () => clearIdleTimer();\r\n\r\n    const onInteractionStart = () => {\r\n      isInteractingRef.current = true;\r\n      setIsInteracting(true);\r\n      clearIdleTimer();\r\n    };\r\n\r\n    const onInteractionEnd = () => {\r\n      isInteractingRef.current = false;\r\n      setIsInteracting(false);\r\n      // schedule next advance after user stops interacting\r\n      scheduleIdleAdvance(ROTATE_MS);\r\n    };\r\n\r\n    // listen for common interaction start/end events within the card\r\n    el.addEventListener('pointerdown', onInteractionStart);\r\n    el.addEventListener('pointermove', onInteractionStart);\r\n    el.addEventListener('touchstart', onInteractionStart);\r\n    el.addEventListener('mouseenter', onInteractionStart);\r\n    el.addEventListener('focusin', onInteractionStart);\r\n    el.addEventListener('keydown', onInteractionStart);\r\n\r\n    el.addEventListener('pointerup', onInteractionEnd);\r\n    el.addEventListener('touchend', onInteractionEnd);\r\n    el.addEventListener('mouseleave', onInteractionEnd);\r\n    el.addEventListener('focusout', onInteractionEnd);\r\n\r\n    return () => {\r\n      clearIdleTimer();\r\n      el.removeEventListener('pointerdown', onInteractionStart);\r\n      el.removeEventListener('pointermove', onInteractionStart);\r\n      el.removeEventListener('touchstart', onInteractionStart);\r\n      el.removeEventListener('mouseenter', onInteractionStart);\r\n      el.removeEventListener('focusin', onInteractionStart);\r\n      el.removeEventListener('keydown', onInteractionStart);\r\n\r\n      el.removeEventListener('pointerup', onInteractionEnd);\r\n      el.removeEventListener('touchend', onInteractionEnd);\r\n      el.removeEventListener('mouseleave', onInteractionEnd);\r\n      el.removeEventListener('focusout', onInteractionEnd);\r\n    };\r\n  }, [clearIdleTimer, scheduleIdleAdvance]);\r\n\r\n  \r\n\r\n\r\n  // handle voice submission client-side: accept recorded Blob and optional transcript\r\n  const extractFiltersFromText = (text: string) => {\r\n    const t = (text || '').toLowerCase();\r\n    const params: Record<string, string> = {};\r\n    if (t.includes('quiet') || t.includes('safe') || t.includes('away from road') || t.includes('far from road')) {\r\n      params.filter = 'safe_quiet';\r\n    }\r\n    const bedMatch = t.match(/(\\b(\\d+)\\s*(bedroom|bedrooms|br)\\b)/i);\r\n    if (bedMatch) params.bedrooms = bedMatch[2];\r\n    const underMatch = t.match(/under\\s*(\\d+[kK]?)/);\r\n    if (underMatch) {\r\n      let v = underMatch[1];\r\n      if (v.toLowerCase().endsWith('k')) v = String(parseInt(v.slice(0, -1), 10) * 1000);\r\n      params.max_price = v;\r\n    } else {\r\n      const numMatch = t.match(/(\\d{3,6})/);\r\n      if (numMatch) params.max_price = numMatch[1];\r\n    }\r\n    return params;\r\n  };\r\n\r\n  const toQueryString = (params: Record<string, string>) => new URLSearchParams(params).toString();\r\n\r\n  const handleVoiceSubmit = async (file: Blob, transcript?: string) => {\r\n    setBusy(true);\r\n    try {\r\n      // If transcript provided, use it to extract filters client-side.\r\n      const text = transcript || '';\r\n      const filters = extractFiltersFromText(text);\r\n      const query = toQueryString(filters);\r\n      if (query) {\r\n        window.location.href = `/public/properties?${query}`;\r\n      } else {\r\n        // Fallback: if no filters detected, open properties page so user can refine\r\n        window.location.href = '/public/properties';\r\n      }\r\n    } catch (err) {\r\n      console.error(err);\r\n      alert('Failed to process voice locally.');\r\n    } finally {\r\n      setBusy(false);\r\n    }\r\n  };\r\n\r\n  // progress step derived from booking state (kept for future use)\r\n\r\n  const steps = [\r\n    { label: 'Book', color: 'text-amber-500' },\r\n    { label: 'Pay', color: 'text-emerald-600' },\r\n    { label: 'Receive code', color: 'text-emerald-600' },\r\n    { label: 'Driver confirm', color: 'text-teal-500' },\r\n    { label: 'Arrive', color: 'text-blue-600' },\r\n  ];\r\n\r\n  const stepHighlightWidth = 100 / steps.length;\r\n  const highlightOffset = ((activeStep ?? 1) - 1) * stepHighlightWidth;\r\n\r\n  const stepMeta = [\r\n    {\r\n      title: 'Book',\r\n      kicker: 'Search smarter with filters or voice.',\r\n      image: '/assets/book_step_1.jpg',\r\n    },\r\n    {\r\n      title: 'Pay',\r\n      kicker: 'Easy payments with local providers.',\r\n      // Use exact filename case (important for Linux deployments)\r\n      image: '/assets/Pay_step_2.jpg',\r\n    },\r\n    {\r\n      title: 'Receive code',\r\n      kicker: 'Get a unique code after payment.',\r\n      image: '/assets/Booking_code_step_3.jpg',\r\n    },\r\n    {\r\n      title: 'Driver confirm',\r\n      kicker: 'Quick safety checks before you go.',\r\n      image: '/assets/nolsaf_driver.jpg',\r\n    },\r\n    {\r\n      title: 'Arrive',\r\n      kicker: 'You’re all set for check‑in.',\r\n      image: '/assets/Arrive_step_5.jpg',\r\n    },\r\n  ] as const;\r\n\r\n  const activeMeta = stepMeta[(activeStep ?? 1) - 1] ?? stepMeta[0];\r\n\r\n  // Preload step images so you don't see \"faint/blank\" while switching steps.\r\n  useEffect(() => {\r\n    if (typeof window === 'undefined') return;\r\n    const imgs = stepMeta.map((s) => {\r\n      const img = new window.Image();\r\n      img.src = s.image;\r\n      return img;\r\n    });\r\n    return () => {\r\n      // allow GC\r\n      imgs.length = 0;\r\n    };\r\n  }, []);\r\n\r\n  return (\r\n    <>\r\n      <section className=\"mt-6\" aria-label=\"Booking flow\">\r\n        <div className=\"public-container\">\r\n          <article\r\n            ref={containerRef}\r\n            className=\"relative overflow-hidden rounded-3xl p-[1px] ring-1 ring-slate-200/70 shadow-[0_22px_70px_rgba(2,6,23,0.10)] bg-gradient-to-br from-white/85 via-slate-200/45 to-emerald-200/35\"\r\n          >\r\n            <div className=\"relative overflow-hidden rounded-[22px] border border-white/70 bg-white/70 backdrop-blur-xl\">\r\n              <div\r\n                className=\"pointer-events-none absolute inset-0 opacity-55 bg-[radial-gradient(circle_at_18%_14%,rgba(2,180,245,0.14),transparent_52%),radial-gradient(circle_at_90%_86%,rgba(2,102,94,0.12),transparent_56%)]\"\r\n                aria-hidden\r\n              />\r\n              <div\r\n                className=\"pointer-events-none absolute inset-x-0 top-0 h-24 opacity-55 bg-[linear-gradient(90deg,transparent_0%,rgba(255,255,255,0.78)_48%,rgba(255,255,255,0.30)_52%,transparent_100%)]\"\r\n                aria-hidden\r\n              />\r\n\r\n              <div className=\"relative p-4 sm:p-6\">\r\n                {/* Stepper */}\r\n                <nav aria-label=\"Booking steps\" className=\"mt-0\">\r\n                  <div\r\n                    className=\"relative flex items-center gap-2 sm:gap-3 text-xs rounded-full px-3 py-2 overflow-x-auto scrollbar-hide ring-1 ring-slate-200/70 border border-white/70 bg-gradient-to-r from-amber-50/70 via-emerald-50/60 to-sky-50/70 shadow-[inset_0_1px_0_rgba(255,255,255,0.75)]\"\r\n                  >\r\n                    <span\r\n                      ref={highlightRef}\r\n                      aria-hidden\r\n                      className=\"absolute inset-y-1 rounded-full bg-white/85 ring-1 ring-white/70 shadow-[0_10px_28px_rgba(2,6,23,0.10)]\"\r\n                      style={{\r\n                        width: `${stepHighlightWidth}%`,\r\n                        transform: `translateX(${highlightOffset}%)`,\r\n                      }}\r\n                    />\r\n                    <ol\r\n                      role=\"list\"\r\n                      className=\"flex items-center gap-2 sm:gap-3 w-full list-none m-0 p-0\"\r\n                    >\r\n                  {steps.map((s, i) => {\r\n                    const stepNum = i + 1;\r\n                    const iconClass = s.color;\r\n\r\n                    return (\r\n                      <li key={s.label} className=\"relative z-10 flex-1 min-w-[8.5rem] sm:min-w-0 list-none\">\r\n                        <button\r\n                          type=\"button\"\r\n                          onClick={() => handleStepChange(stepNum)}\r\n                          aria-pressed={activeStep === stepNum}\r\n                          aria-label={s.label}\r\n                          disabled={isTransitioning}\r\n                          className={[\r\n                            \"w-full flex items-center justify-center gap-2 bg-transparent border-0 rounded-full px-2 py-1.5\",\r\n                            \"focus:outline-none focus-visible:ring-2 focus-visible:ring-[#02b4f5]/25 transform transition-all duration-300 ease-out\",\r\n                            activeStep === stepNum ? \"scale-[1.02]\" : \"hover:scale-[1.02]\",\r\n                            isTransitioning ? \"opacity-60 cursor-wait\" : \"\",\r\n                          ].join(\" \")}\r\n                        >\r\n                          <span className={[\"text-[11px] tabular-nums\", activeStep === stepNum ? \"text-slate-900\" : \"text-slate-500\"].join(\" \")}>{stepNum}.</span>\r\n                          <svg className={`w-5 h-5 sm:w-6 sm:h-6 ${iconClass} transition-colors`} viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" aria-hidden>\r\n                            {i === 0 && (\r\n                              <>\r\n                                <rect x=\"3\" y=\"4\" width=\"18\" height=\"6\" rx=\"1\" />\r\n                                <path d=\"M7 10v8\" stroke=\"currentColor\" strokeWidth=\"1.5\" strokeLinecap=\"round\" />\r\n                              </>\r\n                            )}\r\n                            {i === 1 && (\r\n                              <>\r\n                                <rect x=\"2\" y=\"7\" width=\"20\" height=\"10\" rx=\"2\" />\r\n                                <path d=\"M6 11h.01\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" />\r\n                              </>\r\n                            )}\r\n                            {i === 2 && (\r\n                              <>\r\n                                <rect x=\"3\" y=\"4\" width=\"18\" height=\"14\" rx=\"2\" />\r\n                                <path d=\"M7 8h10\" stroke=\"currentColor\" strokeWidth=\"1.5\" strokeLinecap=\"round\" />\r\n                              </>\r\n                            )}\r\n                            {i === 3 && (\r\n                              <>\r\n                                <circle cx=\"12\" cy=\"12\" r=\"8\" stroke=\"currentColor\" strokeWidth=\"1.5\" />\r\n                                <path d=\"M12 8v4l2 2\" stroke=\"currentColor\" strokeWidth=\"1.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\" />\r\n                              </>\r\n                            )}\r\n                            {i === 4 && (\r\n                              <>\r\n                                <path d=\"M12 2c3.866 0 7 3.134 7 7 0 5-7 13-7 13s-7-8-7-13c0-3.866 3.134-7 7-7z\" stroke=\"currentColor\" strokeWidth=\"1.2\" />\r\n                                <circle cx=\"12\" cy=\"9\" r=\"2\" fill=\"currentColor\" />\r\n                              </>\r\n                            )}\r\n                          </svg>\r\n                          <span className={[\"text-sm whitespace-nowrap\", activeStep === stepNum ? \"text-slate-900\" : \"text-slate-700\"].join(\" \")}>{s.label}</span>\r\n                        </button>\r\n                      </li>\r\n                    );\r\n                  })}\r\n                </ol>\r\n              </div>\r\n            </nav>\r\n\r\n            {/* Content */}\r\n            <div className=\"mt-6 grid grid-cols-1 md:grid-cols-12 gap-6 items-start\">\r\n              {/* Image */}\r\n              <div className=\"md:col-span-6 order-1 md:order-2\">\r\n                <div\r\n                  key={`img-${activeStep}-${activeMeta.image}`}\r\n                  className={[\r\n                    \"relative overflow-hidden rounded-3xl border border-white/70 bg-slate-100 ring-1 ring-slate-200/70\",\r\n                    // Slightly smaller/tighter image height across breakpoints\r\n                    \"aspect-[16/10]\",\r\n                    \"shadow-[0_18px_55px_rgba(2,6,23,0.14)] step-enter\",\r\n                  ].join(\" \")}\r\n                >\r\n                  {!imgError ? (\r\n                    <Image\r\n                      src={activeMeta.image}\r\n                      alt={`Step ${activeStep}: ${activeMeta.title}`}\r\n                      fill\r\n                      className={[\r\n                        \"object-cover\",\r\n                        \"transition-transform duration-300\",\r\n                        // Step 4 image is naturally dark; boost slightly so it doesn't look \"faint\"\r\n                        activeStep === 4 ? \"brightness-110 contrast-105 saturate-105\" : \"\",\r\n                        isInteracting ? \"scale-[0.99]\" : \"scale-100\",\r\n                      ].join(\" \")}\r\n                      onError={() => setImgError(true)}\r\n                      priority={false}\r\n                      sizes=\"(min-width: 768px) 60vw, 100vw\"\r\n                    />\r\n                  ) : null}\r\n\r\n                  {/* Overlay for readability */}\r\n                  <div className=\"absolute inset-0 bg-gradient-to-t from-black/45 via-black/10 to-transparent\" />\r\n\r\n                  <div className=\"absolute left-4 right-4 bottom-4 text-white\">\r\n                    <div className=\"text-sm font-semibold tracking-wide opacity-90\">Step {activeStep} of {STEPS_COUNT}</div>\r\n                    <div className=\"mt-1 text-xl sm:text-2xl font-bold leading-tight\">{activeMeta.title}</div>\r\n                    <div className=\"mt-1 text-sm text-white/90\">{activeMeta.kicker}</div>\r\n                  </div>\r\n\r\n                  {/* Small decorative for the final step */}\r\n                  {activeStep === 5 ? (\r\n                    <div className=\"absolute right-4 top-4\">\r\n                      <div className=\"w-12 h-12 rounded-full bg-white/85 backdrop-blur flex items-center justify-center shadow-md ring-2 ring-emerald-400/30\">\r\n                        <svg width=\"22\" height=\"22\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\" aria-hidden>\r\n                          <path d=\"M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z\" stroke=\"#0f172a\" strokeWidth=\"1.4\" />\r\n                          <circle cx=\"12\" cy=\"9\" r=\"2.5\" fill=\"#059669\" />\r\n                        </svg>\r\n                      </div>\r\n                    </div>\r\n                  ) : null}\r\n                </div>\r\n              </div>\r\n\r\n              {/* Text / actions */}\r\n              <div className=\"md:col-span-6 order-2 md:order-1\">\r\n                <div className=\"rounded-3xl border border-white/70 bg-white/70 backdrop-blur-xl ring-1 ring-slate-200/70 p-4 sm:p-5 shadow-[0_18px_55px_rgba(2,6,23,0.10)]\">\r\n                  <div className=\"text-base font-semibold text-slate-900 tracking-tight\">{activeMeta.title}</div>\r\n                  <div className=\"mt-1 text-sm text-slate-600 leading-relaxed\">{activeMeta.kicker}</div>\r\n\r\n                  {activeStep === 1 ? (\r\n                    <>\r\n                      <div className=\"mt-4\">\r\n                        <div className=\"text-xs font-semibold text-slate-700 uppercase tracking-wide\">Quick filters</div>\r\n                        <div className=\"mt-2 flex flex-wrap gap-2\">\r\n                          {[\r\n                            { label: 'Region', href: '/public/properties?filter=region' },\r\n                            { label: 'District', href: '/public/properties?filter=district' },\r\n                            { label: 'Ward', href: '/public/properties?filter=ward' },\r\n                            { label: 'Price', href: '/public/properties?filter=price' },\r\n                            { label: 'Property', href: '/public/properties?filter=property_type' },\r\n                            { label: 'Nearby', href: '/public/properties?filter=nearby' },\r\n                            { label: 'Amenities', href: '/public/properties?filter=amenities' },\r\n                            { label: 'Quiet', href: '/public/properties?filter=safe_quiet' },\r\n                          ].map((p) => (\r\n                            <Link\r\n                              key={p.label}\r\n                              href={p.href}\r\n                              className=\"inline-flex items-center justify-center px-3 py-1 rounded-full text-xs font-medium no-underline bg-slate-100 text-slate-700 hover:bg-[#02665e] hover:text-white transition-colors\"\r\n                            >\r\n                              {p.label}\r\n                            </Link>\r\n                          ))}\r\n                        </div>\r\n                      </div>\r\n                      <div className=\"mt-4\">\r\n                        <div className=\"text-xs font-semibold text-slate-700 uppercase tracking-wide\">Or speak it</div>\r\n                        <div className=\"mt-2\">\r\n                          <VoiceRecorder onSubmit={handleVoiceSubmit} />\r\n                        </div>\r\n                      </div>\r\n                    </>\r\n                  ) : null}\r\n\r\n                  {activeStep === 2 ? (\r\n                    <div className=\"mt-4\">\r\n                      <div className=\"flex items-center justify-between gap-3\">\r\n                        <div className=\"text-xs font-semibold text-slate-700 uppercase tracking-wide\">Supported payments</div>\r\n                        <div className=\"text-[11px] text-slate-500\">Tap a logo</div>\r\n                      </div>\r\n\r\n                      <div className=\"mt-2 rounded-2xl border border-slate-200/70 p-3 nols-pay-strip shadow-sm\">\r\n                        <div className=\"flex flex-wrap items-center gap-2\">\r\n                        {[\r\n                          { key: 'airtel', alt: 'Airtel Money', src: '/assets/airtel_money.png' },\r\n                          { key: 'halopesa', alt: 'Halopesa', src: '/assets/halopesa.png' },\r\n                          { key: 'mixx', alt: 'Mixx by Yas', src: '/assets/mix%20by%20yas.png' },\r\n                          { key: 'tkash', alt: 'T-Kash', src: '/assets/T_kash_logo.png' },\r\n                          { key: 'mtn', alt: 'MTN', src: '/assets/MTN%20LOGO.png' },\r\n                          { key: 'mpesa', alt: 'M-Pesa', src: '/assets/M-pesa.png' },\r\n                          { key: 'visa', alt: 'Visa', src: '/assets/visa_card.png' },\r\n                        ].map((p) => {\r\n                          const selected = selectedPayment === p.key;\r\n                          return (\r\n                            <button\r\n                              key={p.key}\r\n                              type=\"button\"\r\n                              onClick={() => setSelectedPayment(p.key)}\r\n                              aria-label={`Select ${p.alt}`}\r\n                              aria-pressed={selected}\r\n                              className={[\r\n                                \"nols-pay-tile group w-11 h-11 sm:w-12 sm:h-12 flex items-center justify-center\",\r\n                                \"bg-white/90 backdrop-blur rounded-xl border shadow-sm\",\r\n                                \"transition-all duration-300 ease-out\",\r\n                                \"hover:bg-white hover:shadow-md hover:-translate-y-0.5\",\r\n                                // touch / click feedback\r\n                                \"active:translate-y-0 active:scale-[0.97]\",\r\n                                \"focus:outline-none focus-visible:ring-2 focus-visible:ring-emerald-300/60 focus-visible:ring-offset-2 focus-visible:ring-offset-white/60\",\r\n                                selected\r\n                                  ? \"border-emerald-500 ring-2 ring-emerald-200/70 shadow-[0_10px_25px_rgba(2,102,94,0.18)]\"\r\n                                  : \"border-slate-200/80\",\r\n                              ].join(\" \")}\r\n                            >\r\n                              <Image\r\n                                src={p.src}\r\n                                alt={p.alt}\r\n                                width={30}\r\n                                height={30}\r\n                                className=\"w-7 h-7 object-contain transition-transform duration-300 ease-out group-hover:scale-110\"\r\n                              />\r\n                            </button>\r\n                          );\r\n                        })}\r\n                        </div>\r\n                      </div>\r\n                      <div className=\"mt-3 text-sm text-slate-600\">\r\n                        Pay securely, then receive your booking code instantly.\r\n                      </div>\r\n                    </div>\r\n                  ) : null}\r\n\r\n                  {activeStep === 3 ? (\r\n                    <div className=\"mt-4 text-sm text-slate-600\">\r\n                      After payment you’ll receive a unique booking code. Share it at pickup/check‑in to confirm your reservation.\r\n                      <div className=\"mt-3 rounded-2xl bg-white/65 backdrop-blur border border-slate-200/70 p-3 shadow-[inset_0_1px_0_rgba(255,255,255,0.75)]\">\r\n                        <div className=\"text-xs font-semibold text-slate-700 uppercase tracking-wide\">Example</div>\r\n                        <div className=\"mt-1 font-mono text-slate-800\">Thank You for Booking with NoLSAF! Your booking code is: BK-7Q2KX9 Please present this code at check-in. Thank you!</div>\r\n                      </div>\r\n                    </div>\r\n                  ) : null}\r\n\r\n                  {activeStep === 4 ? (\r\n                    <div className=\"mt-4\">\r\n                      <div className=\"text-xs font-semibold text-slate-700 uppercase tracking-wide\">Before you start</div>\r\n                      <ul className=\"mt-2 space-y-2 text-sm text-slate-600\">\r\n                        {[\r\n                          { text: 'Quick safety checks', Icon: ShieldCheck },\r\n                          { text: 'Driver ID & vehicle match', Icon: BadgeCheck },\r\n                          { text: 'Route looks correct', Icon: MapPinned },\r\n                          { text: 'If yes, start your trip.', Icon: PlayCircle },\r\n                        ].map(({ text, Icon }) => (\r\n                          <li key={text} className=\"flex items-start gap-2.5\">\r\n                            <span className=\"mt-0.5 flex-shrink-0 w-6 h-6 rounded-md bg-emerald-50 border border-emerald-100 flex items-center justify-center\">\r\n                              <Icon className=\"w-4 h-4 text-emerald-600\" aria-hidden />\r\n                            </span>\r\n                            <span className=\"leading-6\">{text}</span>\r\n                          </li>\r\n                        ))}\r\n                      </ul>\r\n                    </div>\r\n                  ) : null}\r\n\r\n                  {activeStep === 5 ? (\r\n                    <div className=\"mt-4\">\r\n                      <div className=\"flex items-start gap-3\">\r\n                        <span className=\"mt-0.5 flex-shrink-0 w-9 h-9 rounded-lg bg-emerald-50 border border-emerald-100 flex items-center justify-center\">\r\n                          <CheckCircle2 className=\"w-5 h-5 text-emerald-600\" aria-hidden />\r\n                        </span>\r\n                        <div>\r\n                          <div className=\"text-sm font-semibold text-slate-900\">Arrive & check‑in</div>\r\n                          <div className=\"mt-0.5 text-sm text-slate-600\">\r\n                            You’re all set for check‑in. Here’s what to do when you arrive.\r\n                          </div>\r\n                        </div>\r\n                      </div>\r\n\r\n                      <ul className=\"mt-4 space-y-2 text-sm text-slate-600\">\r\n                        {[\r\n                          { text: 'Keep your booking code ready.', Icon: KeyRound },\r\n                          { text: 'Follow the property check‑in instructions.', Icon: Home },\r\n                          { text: 'Once confirmed, you’re good to go.', Icon: CheckCircle2 },\r\n                        ].map(({ text, Icon }) => (\r\n                          <li key={text} className=\"flex items-start gap-2.5\">\r\n                            <span className=\"mt-0.5 flex-shrink-0 w-6 h-6 rounded-md bg-slate-50 border border-slate-200 flex items-center justify-center\">\r\n                              <Icon className=\"w-4 h-4 text-slate-700\" aria-hidden />\r\n                            </span>\r\n                            <span className=\"leading-6\">{text}</span>\r\n                          </li>\r\n                        ))}\r\n                      </ul>\r\n                    </div>\r\n                  ) : null}\r\n\r\n                  <div className=\"mt-5\">\r\n                    <Link\r\n                      href=\"/public/properties\"\r\n                      aria-disabled={busy ? \"true\" : \"false\"}\r\n                      className={[\r\n                        \"group inline-flex items-center justify-center gap-2\",\r\n                        \"w-full max-w-[360px] mx-auto min-[420px]:w-auto min-[420px]:max-w-none\",\r\n                        \"px-5 py-2.5 rounded-2xl no-underline font-semibold\",\r\n                        \"text-white shadow-sm\",\r\n                        \"bg-gradient-to-r from-[#02665e] via-[#02665e] to-emerald-600\",\r\n                        \"hover:shadow-[0_16px_40px_rgba(2,102,94,0.22)] hover:-translate-y-0.5 active:translate-y-0 active:scale-[0.99]\",\r\n                        \"transition-all duration-200\",\r\n                        \"focus:outline-none focus:ring-2 focus:ring-emerald-200 focus:ring-offset-2 focus:ring-offset-white\",\r\n                        busy ? \"opacity-70 pointer-events-none\" : \"\",\r\n                      ].join(\" \")}\r\n                    >\r\n                      <span>Browse stays</span>\r\n                      <ArrowRight className=\"w-4 h-4 transition-transform duration-200 group-hover:translate-x-0.5\" aria-hidden />\r\n                    </Link>\r\n                    <div className=\"mt-2 text-xs text-slate-500 text-center\">\r\n                      Tip: Tap the steps above to preview the full flow.\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            </div>\r\n              </div>\r\n            </div>\r\n          </article>\r\n        </div>\r\n      </section>\r\n\r\n      <div className=\"w-full my-8\">\r\n        <div className=\"max-w-6xl mx-auto px-4 flex justify-center\">\r\n          <div className=\"w-16 h-16 rounded-full overflow-hidden border border-slate-200 bg-white shadow-sm flex items-center justify-center\" role=\"img\" aria-label=\"Founder\">\r\n            <User className=\"w-8 h-8 text-emerald-600\" aria-hidden=\"false\" />\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      \r\n    </>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\Chart.tsx","messages":[],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'data', 'options', and 'plugins'. Either include them or remove the dependency array.","line":133,"column":6,"nodeType":"ArrayExpression","endLine":133,"endColumn":12,"suggestions":[{"desc":"Update the dependencies array to be: [data, options, plugins, type]","fix":{"range":[4283,4289],"text":"[data, options, plugins, type]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\ChatWidget.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\CitiesMap.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\ClientErrorBoundary.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\ConnectionStatusIndicator.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\CountryCard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\CountryFiltersRow.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\CountryTourismSiteList.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\CurrencyPicker.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\CustomerSidebar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\DatePickerField.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'isoToDate' is defined but never used. Allowed unused vars must match /^_/u.","line":18,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":18,"endColumn":19},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'dateToIso' is defined but never used. Allowed unused vars must match /^_/u.","line":24,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":24,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { Fragment, useCallback, useEffect, useRef, useState } from \"react\";\r\nimport { createPortal } from \"react-dom\";\r\nimport { Popover, Transition } from \"@headlessui/react\";\r\nimport DatePicker from \"@/components/ui/DatePicker\";\r\nimport { Calendar } from \"lucide-react\";\r\n\r\ntype Props = {\r\n  label: string;\r\n  value: string;\r\n  onChangeAction: (nextIso: string) => void;\r\n  min?: string;\r\n  max?: string;\r\n  widthClassName?: string;\r\n};\r\n\r\nfunction isoToDate(iso?: string) {\r\n  if (!iso) return undefined;\r\n  const d = new Date(iso);\r\n  return Number.isNaN(d.getTime()) ? undefined : d;\r\n}\r\n\r\nfunction dateToIso(d?: Date) {\r\n  if (!d) return \"\";\r\n  const y = d.getFullYear();\r\n  const m = String(d.getMonth() + 1).padStart(2, \"0\");\r\n  const day = String(d.getDate()).padStart(2, \"0\");\r\n  return `${y}-${m}-${day}`;\r\n}\r\n\r\nfunction formatDisplay(iso?: string) {\r\n  if (!iso) return \"\";\r\n  const parts = String(iso).split(\"-\");\r\n  if (parts.length !== 3) return String(iso);\r\n  const [y, m, d] = parts;\r\n  if (!y || !m || !d) return String(iso);\r\n\r\n  const monthIndex = Number(m);\r\n  const months = [\r\n    \"Jan\",\r\n    \"Feb\",\r\n    \"Mar\",\r\n    \"Apr\",\r\n    \"May\",\r\n    \"Jun\",\r\n    \"Jul\",\r\n    \"Aug\",\r\n    \"Sep\",\r\n    \"Oct\",\r\n    \"Nov\",\r\n    \"Dec\",\r\n  ];\r\n  const monthLabel = Number.isFinite(monthIndex) && monthIndex >= 1 && monthIndex <= 12 ? months[monthIndex - 1] : m;\r\n  const day2 = String(d).padStart(2, \"0\");\r\n  return `${day2} ${monthLabel} ${y}`;\r\n}\r\n\r\nfunction PopoverPositioner({\r\n  open,\r\n  computePos,\r\n}: {\r\n  open: boolean;\r\n  computePos: () => void;\r\n}) {\r\n  // Keep the popup anchored while open.\r\n  // Use capture on scroll so it updates even inside scroll containers.\r\n  useEffect(() => {\r\n    if (!open) return;\r\n    if (typeof window === \"undefined\") return;\r\n\r\n    computePos();\r\n    window.addEventListener(\"resize\", computePos);\r\n    window.addEventListener(\"scroll\", computePos, true);\r\n    return () => {\r\n      window.removeEventListener(\"resize\", computePos);\r\n      window.removeEventListener(\"scroll\", computePos, true);\r\n    };\r\n  }, [open, computePos]);\r\n\r\n  return null;\r\n}\r\n\r\nexport default function DatePickerField({\r\n  label,\r\n  value,\r\n  onChangeAction,\r\n  min,\r\n  max,\r\n  widthClassName = \"sm:w-[220px]\",\r\n}: Props) {\r\n  const buttonRef = useRef<HTMLButtonElement | null>(null);\r\n  const [mounted, setMounted] = useState(false);\r\n  const [panelPos, setPanelPos] = useState<{ top: number; left: number; width: number } | null>(null);\r\n\r\n  const [twoMonths, setTwoMonths] = useState(false);\r\n\r\n  const computePos = useCallback(() => {\r\n    const el = buttonRef.current;\r\n    if (!el) return;\r\n    if (typeof window === \"undefined\") return;\r\n\r\n    const rect = el.getBoundingClientRect();\r\n    const width = Math.min(720, Math.max(320, window.innerWidth - 32));\r\n    const rawLeft = rect.left;\r\n    const left = Math.max(16, Math.min(rawLeft, window.innerWidth - 16 - width));\r\n    const top = rect.bottom + 8;\r\n    setPanelPos({ top, left, width });\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    setMounted(true);\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    const update = () => setTwoMonths(window.innerWidth >= 768);\r\n    update();\r\n    window.addEventListener(\"resize\", update);\r\n    return () => window.removeEventListener(\"resize\", update);\r\n  }, []);\r\n\r\n  const pretty = formatDisplay(value);\r\n\r\n  return (\r\n    <Popover className=\"relative\">\r\n      {({ open, close }) => {\r\n        return (\r\n        <>\r\n          <PopoverPositioner open={open} computePos={computePos} />\r\n\r\n          <Popover.Button\r\n            ref={buttonRef}\r\n            type=\"button\"\r\n            className={\r\n              \"h-12 w-full \" +\r\n              widthClassName +\r\n              \" rounded-xl border border-gray-200 bg-white text-sm text-gray-900 shadow-sm px-4 pl-11 text-left focus:outline-none focus:ring-2 focus:ring-brand/25 focus:border-brand hover:bg-brand/5 transition\"\r\n            }\r\n            aria-label={label}\r\n            title={label}\r\n            onClick={() => {\r\n              // Ensures correct position even on first open.\r\n              // (Popover will toggle open after this event.)\r\n              if (typeof window !== \"undefined\") {\r\n                // Queue so layout is final.\r\n                setTimeout(() => {\r\n                  try {\r\n                    computePos();\r\n                  } catch {\r\n                    // ignore\r\n                  }\r\n                }, 0);\r\n              }\r\n            }}\r\n          >\r\n            <Calendar className=\"absolute left-4 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-500\" aria-hidden />\r\n            <span className={pretty ? \"font-semibold\" : \"text-gray-400\"}>\r\n              {pretty || \"DD Mon YYYY\"}\r\n            </span>\r\n          </Popover.Button>\r\n\r\n          {mounted\r\n            ? createPortal(\r\n                <Transition\r\n                  as={Fragment}\r\n                  show={open}\r\n                  enter=\"transition ease-out duration-150\"\r\n                  enterFrom=\"opacity-0 translate-y-1\"\r\n                  enterTo=\"opacity-100 translate-y-0\"\r\n                  leave=\"transition ease-in duration-120\"\r\n                  leaveFrom=\"opacity-100 translate-y-0\"\r\n                  leaveTo=\"opacity-0 translate-y-1\"\r\n                >\r\n                  <Popover.Panel\r\n                    static\r\n                    className=\"fixed z-[10000] rounded-xl border border-gray-200 bg-white shadow-2xl p-3 nolsaf-date-popper\"\r\n                    style={\r\n                      panelPos\r\n                        ? { top: panelPos.top, left: panelPos.left, width: panelPos.width }\r\n                        : { top: 0, left: 0, width: Math.min(720, Math.max(320, window.innerWidth - 32)) }\r\n                    }\r\n                  >\r\n                    <div className=\"flex items-center justify-between gap-2\">\r\n                      <div className=\"min-w-0\">\r\n                        <div className=\"text-xs text-gray-500\">{label}</div>\r\n                        <div className=\"text-sm font-semibold text-gray-900 truncate\">{pretty || \"Select a date\"}</div>\r\n                      </div>\r\n                    </div>\r\n\r\n                    <div className=\"mt-2\">\r\n                      <DatePicker\r\n                        selected={value || undefined}\r\n                        allowRange={false}\r\n                        allowPast={true}\r\n                        minDate={min}\r\n                        maxDate={max}\r\n                        twoMonths={twoMonths}\r\n                        initialViewDate={value || min || max}\r\n                        onSelectAction={(s) => {\r\n                          const iso = Array.isArray(s) ? s[0] : s;\r\n                          if (!iso) return;\r\n                          onChangeAction(String(iso));\r\n                        }}\r\n                        onCloseAction={() => close()}\r\n                      />\r\n                    </div>\r\n                  </Popover.Panel>\r\n                </Transition>,\r\n                document.body\r\n              )\r\n            : null}\r\n        </>\r\n        );\r\n      }}\r\n    </Popover>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\DeleteButton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\DriverAvailabilitySwitch.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\DriverDashboard.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'StatCard' is defined but never used. Allowed unused vars must match /^_/u.","line":49,"column":8,"nodeType":"Identifier","messageId":"unusedVar","endLine":49,"endColumn":16,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"StatCard"},"fix":{"range":[1306,1340],"text":""},"desc":"Remove unused import declaration."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\nimport React, { useEffect, useState, useRef } from \"react\";\r\nimport Link from \"next/link\";\r\nimport axios from \"axios\";\r\nimport { io, Socket } from \"socket.io-client\";\r\n\r\n// Add custom animations\r\nif (typeof document !== 'undefined') {\r\n  const style = document.createElement('style');\r\n  style.textContent = `\r\n    @keyframes fade-in-up {\r\n      from {\r\n        opacity: 0;\r\n        transform: translateY(20px);\r\n      }\r\n      to {\r\n        opacity: 1;\r\n        transform: translateY(0);\r\n      }\r\n    }\r\n    .animate-fade-in-up {\r\n      animation: fade-in-up 0.6s ease-out forwards;\r\n      opacity: 0;\r\n    }\r\n    .delay-100 { animation-delay: 0.1s; }\r\n    .delay-200 { animation-delay: 0.2s; }\r\n    .delay-300 { animation-delay: 0.3s; }\r\n    .delay-400 { animation-delay: 0.4s; }\r\n    .delay-500 { animation-delay: 0.5s; }\r\n    .delay-600 { animation-delay: 0.6s; }\r\n  `;\r\n  style.setAttribute('data-dashboard-animations', 'true');\r\n  if (!document.head.querySelector('style[data-dashboard-animations]')) {\r\n    document.head.appendChild(style);\r\n  }\r\n}\r\nimport {\r\n  TrendingUp,\r\n  AlertCircle,\r\n  ArrowRight,\r\n  FileText,\r\n  ShieldCheck,\r\n  Clock3,\r\n  Star,\r\n  CheckCircle2,\r\n  Eye,\r\n} from 'lucide-react';\r\nimport DriverAvailabilitySwitch from \"@/components/DriverAvailabilitySwitch\";\r\nimport StatCard from \"./StatCard\";\r\nimport {\r\n  LineChart,\r\n  Line,\r\n  XAxis,\r\n  YAxis,\r\n  Tooltip,\r\n  ResponsiveContainer,\r\n  CartesianGrid,\r\n  Cell,\r\n  BarChart,\r\n  Bar,\r\n} from \"recharts\";\r\n\r\n// Use same-origin calls + secure httpOnly cookie session.\r\nconst api = axios.create({ baseURL: \"\", withCredentials: true });\r\n\r\ntype DashboardStats = {\r\n  todayGoal: number;\r\n  todayEarnings: number;\r\n  goalProgress: number; // percentage\r\n  todaysRides: number;\r\n  acceptanceRate: number;\r\n  earningsBreakdown: {\r\n    base: number;\r\n    tips: number;\r\n    bonus: number;\r\n  };\r\n  rating: number;\r\n  totalReviews: number;\r\n  onlineHours: number;\r\n  peakHours: {\r\n    active: boolean;\r\n    start: string;\r\n    end: string;\r\n    multiplier: number;\r\n    timeLeft: string;\r\n  } | null;\r\n  earningsChart: Array<{ day: string; amount: number }>;\r\n  tripsChart: Array<{ hour: string; trips: number }>;\r\n  demandZones: Array<{ name: string; level: 'high' | 'medium' | 'low' }>;\r\n  recentTrips: Array<{\r\n    id: string;\r\n    time: string;\r\n    from: string;\r\n    to: string;\r\n    distance: string;\r\n    amount: number;\r\n  }>;\r\n  reminders: Array<{\r\n    id: string;\r\n    type: 'warning' | 'info';\r\n    message: string;\r\n    action?: string;\r\n    actionLink?: string;\r\n  }>;\r\n};\r\n\r\nexport default function DriverDashboard({ className }: { className?: string }) {\r\n  const [me, setMe] = useState<any | null | undefined>(undefined);\r\n  const [stats, setStats] = useState<DashboardStats | null>(null);\r\n  const [loading, setLoading] = useState(true);\r\n  const [reminders, setReminders] = useState<Array<DashboardStats['reminders'][number]>>([]);\r\n  const socketRef = useRef<Socket | null>(null);\r\n  const [available, setAvailable] = useState<boolean>(() => {\r\n    try {\r\n      const raw = localStorage.getItem('driver_available');\r\n      return raw === '1' || raw === 'true';\r\n    } catch (e) {\r\n      return false;\r\n    }\r\n  });\r\n\r\n  // mapVisible state removed (was unused)\r\n\r\n  \r\n\r\n  const progressPct = stats ? Math.min(stats.goalProgress, 100) : 0;\r\n\r\n  // Local goals stored in localStorage (optional override of server goal)\r\n  const [goals, setGoals] = useState<{ trips?: number; money?: number; moneyUrgent?: boolean } | null>(null);\r\n  const [showGoalsModal, setShowGoalsModal] = useState(false);\r\n\r\n  // Form state for modal\r\n  const [formTrips, setFormTrips] = useState<number | ''>('');\r\n  const [formMoney, setFormMoney] = useState<number | ''>('');\r\n  const [formMoneyUrgent, setFormMoneyUrgent] = useState(false);\r\n\r\n  useEffect(() => {\r\n    if (showGoalsModal) {\r\n      setFormTrips(goals?.trips ?? '');\r\n      setFormMoney(goals?.money ?? '');\r\n      setFormMoneyUrgent(!!goals?.moneyUrgent);\r\n    }\r\n  }, [showGoalsModal, goals]);\r\n\r\n  useEffect(() => {\r\n    try {\r\n      const raw = localStorage.getItem('driver_goals');\r\n      if (raw) setGoals(JSON.parse(raw));\r\n    } catch (e) {\r\n      // ignore\r\n    }\r\n  }, []);\r\n\r\n  // Setup Socket.IO for real-time reminder updates\r\n  useEffect(() => {\r\n    // Get authentication token\r\n    const token = typeof window !== 'undefined' ? (\r\n      window.localStorage.getItem(\"token\") ||\r\n      window.localStorage.getItem(\"nolsaf_token\") ||\r\n      window.localStorage.getItem(\"__Host-nolsaf_token\") ||\r\n      (() => {\r\n        const m = String(document.cookie || \"\").match(/(?:^|;\\s*)(?:nolsaf_token|__Host-nolsaf_token|token)=([^;]+)/);\r\n        return m?.[1] ? decodeURIComponent(m[1]) : null;\r\n      })()\r\n    ) : null;\r\n    \r\n    const socket = io(process.env.NEXT_PUBLIC_API_URL || \"http://localhost:4000\", {\r\n      transports: [\"websocket\"],\r\n      withCredentials: true, // Send cookies automatically\r\n      ...(token ? {\r\n        transportOptions: {\r\n          polling: {\r\n            extraHeaders: {\r\n              Authorization: `Bearer ${token}`\r\n            }\r\n          }\r\n        }\r\n      } : {}),\r\n    });\r\n\r\n    socket.on(\"connect\", async () => {\r\n      console.log(\"Socket connected for reminders\");\r\n      try {\r\n        const r = await fetch(\"/api/account/me\", { credentials: \"include\" });\r\n        if (!r.ok) return;\r\n        const me = await r.json();\r\n        if (me?.id) socket.emit(\"join-driver-room\", { driverId: me.id });\r\n      } catch {\r\n        // ignore\r\n      }\r\n    });\r\n\r\n      // Listen for new reminders\r\n      socket.on(\"new-reminder\", (data: any) => {\r\n        console.log(\"New reminder received:\", data);\r\n        setReminders((prev) => {\r\n          // Check if reminder already exists\r\n          const exists = prev.some((r: any) => String(r.id) === String(data.id));\r\n          if (exists) return prev;\r\n          // Add new reminder at the beginning\r\n          return [data, ...prev];\r\n        });\r\n      });\r\n\r\n    socketRef.current = socket;\r\n\r\n    return () => {\r\n      try {\r\n        socket.emit(\"leave-driver-room\", { driverId: undefined });\r\n      } catch {}\r\n      socket.disconnect();\r\n    };\r\n  }, []);\r\n\r\n  const saveGoals = (g: { trips?: number; money?: number; moneyUrgent?: boolean } | null) => {\r\n    try {\r\n      if (g) {\r\n        localStorage.setItem('driver_goals', JSON.stringify(g));\r\n        setGoals(g);\r\n      } else {\r\n        localStorage.removeItem('driver_goals');\r\n        setGoals(null);\r\n      }\r\n    } catch (e) {}\r\n  };\r\n\r\n    const handleSaveGoals = () => {\r\n      const g: any = {};\r\n      if (formTrips !== '' && formTrips != null) g.trips = Number(formTrips);\r\n      if (formMoney !== '' && formMoney != null) g.money = Number(formMoney);\r\n      if (formMoneyUrgent) g.moneyUrgent = true;\r\n      // if nothing set, treat as clearing goals\r\n      if (Object.keys(g).length === 0) {\r\n        saveGoals(null);\r\n      } else {\r\n        saveGoals(g);\r\n      }\r\n      setShowGoalsModal(false);\r\n    };\r\n\r\n    const handleClearGoals = () => {\r\n      saveGoals(null);\r\n      setShowGoalsModal(false);\r\n    };\r\n\r\n  // Fetch user profile\r\n  useEffect(() => {\r\n    try {\r\n      api\r\n        .get(\"/api/account/me\")\r\n        .then((r) => setMe(r.data))\r\n        .catch(() => setMe(null));\r\n    } catch (err) {\r\n      setMe(null);\r\n    }\r\n  }, []);\r\n\r\n  // Fetch dashboard stats\r\n  useEffect(() => {\r\n    const loadStats = async () => {\r\n      const startTime = Date.now();\r\n      setLoading(true);\r\n      try {\r\n        const res = await api.get(\"/api/driver/dashboard\");\r\n        setStats(res.data);\r\n        // attempt to load persisted reminders separately (prefer dedicated endpoint)\r\n        try {\r\n          const rr = await api.get('/api/driver/reminders');\r\n          if (Array.isArray(rr.data)) {\r\n            // merge server reminders with dashboard computed reminders (dedupe by id)\r\n            const computed = Array.isArray(res.data?.reminders) ? res.data.reminders : [];\r\n            const mergedMap: Record<string, any> = {};\r\n            [...rr.data, ...computed].forEach((r: any) => {\r\n              if (r && r.id) mergedMap[String(r.id)] = r;\r\n            });\r\n            const merged = Object.values(mergedMap);\r\n            setReminders(merged as any);\r\n          } else {\r\n            // fallback to dashboard reminders\r\n            setReminders(Array.isArray(res.data?.reminders) ? res.data.reminders : []);\r\n          }\r\n        } catch (e) {\r\n          // endpoint may not exist; fallback to dashboard reminders\r\n          setReminders(Array.isArray(res.data?.reminders) ? res.data.reminders : []);\r\n        }\r\n\r\n        // Attempt to derive today's earnings from payout records so the\r\n        // Earnings stat reflects real payout amounts when available.\r\n        try {\r\n          const pr = await api.get('/api/driver/payouts');\r\n          const pdata = pr.data;\r\n          const items = Array.isArray(pdata) ? pdata : Array.isArray(pdata.items) ? pdata.items : [];\r\n          if (items && items.length) {\r\n            // Aggregate month-to-date payouts (same year and month)\r\n            const today = new Date();\r\n            const isSameMonth = (iso: any) => {\r\n              if (!iso) return false;\r\n              try {\r\n                const d = new Date(iso);\r\n                return d.getFullYear() === today.getFullYear() && d.getMonth() === today.getMonth();\r\n              } catch {\r\n                return false;\r\n              }\r\n            };\r\n\r\n            const total = items.reduce((acc: number, p: any) => {\r\n              if (!isSameMonth(p.paidAt || p.date || p.createdAt || p.settledAt)) return acc;\r\n              const val = Number(p.netPaid ?? p.net ?? p.amountNet ?? p.amount ?? 0) || 0;\r\n              return acc + val;\r\n            }, 0);\r\n\r\n            if (total > 0) {\r\n              // update the Earnings stat to reflect month-to-date payouts\r\n              setStats((s: any) => ({ ...(s || {}), todayEarnings: total }));\r\n            }\r\n          }\r\n        } catch (e) {\r\n          // ignore payout aggregation errors and keep original dashboard stats\r\n          console.debug('DriverDashboard: payout aggregation failed', e);\r\n        }\r\n      } catch (error) {\r\n        console.error(\"Failed to load dashboard stats:\", error);\r\n        // Set default stats (all zero/empty) if API fails — avoid showing sample numbers\r\n        setStats({\r\n          todayGoal: 0,\r\n          todayEarnings: 0,\r\n          goalProgress: 0,\r\n          todaysRides: 0,\r\n          acceptanceRate: 0,\r\n          earningsBreakdown: { base: 0, tips: 0, bonus: 0 },\r\n          rating: 0,\r\n          totalReviews: 0,\r\n          onlineHours: 0,\r\n          peakHours: null,\r\n          earningsChart: [],\r\n          tripsChart: [],\r\n          demandZones: [],\r\n          recentTrips: [],\r\n          reminders: [],\r\n        });\r\n      } finally {\r\n        const elapsed = Date.now() - startTime;\r\n        const remaining = Math.max(0, 1000 - elapsed);\r\n        setTimeout(() => setLoading(false), remaining);\r\n      }\r\n    };\r\n\r\n    loadStats();\r\n  }, []);\r\n\r\n  // Listen to availability changes\r\n  useEffect(() => {\r\n    const handler = (ev: Event) => {\r\n      try {\r\n        const detail = (ev as CustomEvent).detail || {};\r\n        if (typeof detail.available === 'boolean') {\r\n          setAvailable(detail.available);\r\n        }\r\n      } catch (e) {}\r\n    };\r\n\r\n    const storageHandler = (e: StorageEvent) => {\r\n      if (e.key === 'driver_available') {\r\n        const val = e.newValue;\r\n        const avail = val === '1' || val === 'true';\r\n        setAvailable(avail);\r\n      }\r\n    };\r\n\r\n    window.addEventListener('nols:availability:changed', handler as EventListener);\r\n    window.addEventListener('storage', storageHandler as any);\r\n    return () => {\r\n      window.removeEventListener('nols:availability:changed', handler as EventListener);\r\n      window.removeEventListener('storage', storageHandler as any);\r\n    };\r\n  }, []);\r\n\r\n  // Map initialization is centralized in DriverLiveMap to avoid duplicate instances.\r\n\r\n  const name = me && (me.fullName || me.email) ? (me.fullName || me.email) : \"Driver\";\r\n  const greeting = () => {\r\n    const hour = new Date().getHours();\r\n    if (hour < 12) return \"Good morning\";\r\n    if (hour < 18) return \"Good afternoon\";\r\n    return \"Good evening\";\r\n  };\r\n\r\n  const fmtMoney = (n: number | null | undefined) => {\r\n    const val = Number.isFinite(Number(n)) ? Number(n) : 0;\r\n    return val.toLocaleString();\r\n  };\r\n\r\n  const acceptRate = stats?.acceptanceRate ?? 0;\r\n  const rating = stats?.rating ?? 0;\r\n  const onlineHours = Math.round(stats?.onlineHours ?? 0);\r\n  const rides = stats?.todaysRides ?? 0;\r\n  const earningsToday = stats?.todayEarnings ?? 0;\r\n  const earningsExtra = (stats?.earningsBreakdown?.tips ?? 0) + (stats?.earningsBreakdown?.bonus ?? 0);\r\n\r\n  \r\n\r\n  if (loading) {\r\n    return (\r\n      <div className={`space-y-6 ${className || \"\"}`}>\r\n        <div className=\"animate-pulse space-y-6\">\r\n          <div className=\"h-16 bg-gray-200 rounded-lg\" />\r\n          <div className=\"h-12 bg-gray-200 rounded-lg\" />\r\n          <div className=\"grid grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4\">\r\n            {[...Array(4)].map((_, i) => (\r\n              <div key={i} className=\"h-20 sm:h-24 bg-gray-200 rounded-lg\" />\r\n            ))}\r\n          </div>\r\n          <div className=\"h-64 bg-gray-200 rounded-lg\" />\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  if (!stats) return null;\r\n\r\n  // Prepare trips chart data: prefer `name` (property) when available, otherwise fall back to `hour`.\r\n  const rawTripsChart = stats.tripsChart || [];\r\n  const tripsChartData = Array.isArray(rawTripsChart)\r\n    ? rawTripsChart.map((entry: any) => ({\r\n        name: entry?.name ?? entry?.hour ?? String(entry?.label ?? ''),\r\n        trips: Number(entry?.trips ?? entry?.value ?? 0),\r\n      }))\r\n    : [];\r\n\r\n  // Map known time buckets to property types and aggregate into property buckets\r\n  const hourToProperty: Record<string, string> = {\r\n    '6AM': 'Hotel',\r\n    '9AM': 'Lodge',\r\n    '12PM': 'Condo',\r\n    '3PM': 'Villa',\r\n    '6PM': 'Apartment',\r\n    '9PM': 'Guest Houses',\r\n  };\r\n\r\n  // Known property types include common categories and some region-specific names\r\n  const knownProperties = new Set([\r\n    'Hotel',\r\n    'Lodge',\r\n    'Condo',\r\n    'Villa',\r\n    'Apartment',\r\n    'Guest Houses',\r\n    'House Town',\r\n    'Resort',\r\n    'Cottage',\r\n  ]);\r\n\r\n  const propMap: Record<string, number> = {};\r\n  tripsChartData.forEach((e: any) => {\r\n    const key = String(e.name).trim();\r\n    const mapped = hourToProperty[key];\r\n    const prop = mapped ?? (knownProperties.has(key) ? key : 'Others');\r\n    propMap[prop] = (propMap[prop] || 0) + (Number(e.trips) || 0);\r\n  });\r\n\r\n  // create array sorted descending by trips\r\n  const sorted = Object.keys(propMap).map((k) => ({ name: k, trips: propMap[k] })).sort((a, b) => (b.trips || 0) - (a.trips || 0));\r\n\r\n  // center the largest item in the middle, alternate placing next items to right then left\r\n  const centerArrange = (items: Array<any>) => {\r\n    const n = items.length;\r\n    if (n === 0) return items;\r\n    const res = new Array(n).fill(null);\r\n    const center = Math.floor((n - 1) / 2);\r\n    let left = center - 1;\r\n    let right = center + 1;\r\n    let i = 0;\r\n    res[center] = items[i++];\r\n    while (i < items.length) {\r\n      if (right < n) {\r\n        res[right] = items[i++];\r\n        right++;\r\n      }\r\n      if (i < items.length && left >= 0) {\r\n        res[left] = items[i++];\r\n        left--;\r\n      }\r\n    }\r\n    return res.filter(Boolean);\r\n  };\r\n\r\n  const tripsByProperty = centerArrange(sorted);\r\n\r\n  const chartHeight = Math.max(150, tripsByProperty.length * 40);\r\n\r\n  // Custom tick renderer to display multi-line labels (split on spaces or '/').\r\n  const MultiLineTick = ({ x, y, payload }: any) => {\r\n    const raw = String(payload?.value ?? '');\r\n    // split on spaces or slashes to create multiple lines\r\n    const parts = raw.split(/\\s+|\\//).filter(Boolean);\r\n    const lineHeight = 12;\r\n    return (\r\n      <g transform={`translate(${x},${y + 10})`}>\r\n        <text x={0} y={0} textAnchor=\"end\" fontSize={12} fill=\"#374151\">\r\n          {parts.map((line: string, i: number) => (\r\n            <tspan key={i} x={0} dy={i === 0 ? 0 : lineHeight}>{line}</tspan>\r\n          ))}\r\n        </text>\r\n      </g>\r\n    );\r\n  };\r\n\r\n  // Mark reminder as read (optimistic)\r\n  const markAsRead = async (id: string) => {\r\n    try {\r\n      await api.post(`/api/driver/reminders/${encodeURIComponent(id)}/read`);\r\n    } catch (e) {\r\n      // ignore errors, continue to remove locally\r\n    }\r\n    setReminders((r) => r.filter((x) => String(x.id) !== String(id)));\r\n  };\r\n\r\n  return (\r\n    <div className={`w-full max-w-full space-y-6 ${className || \"\"}`}>\r\n      {/* Hero */}\r\n      <div className=\"bg-gradient-to-r from-slate-900 via-slate-800 to-blue-700 text-white rounded-2xl p-6 shadow-lg border border-slate-800\">\r\n        <div className=\"flex flex-col gap-4 md:flex-row md:items-center md:justify-between\">\r\n          <div className=\"space-y-2\">\r\n            <p className=\"text-sm text-slate-200\">{greeting()}, {name}</p>\r\n            <h1 className=\"text-2xl md:text-3xl font-semibold leading-tight\">You&apos;re online and ready for rides</h1>\r\n            <div className=\"flex items-center gap-2\">\r\n              <span className=\"inline-flex items-center gap-2 rounded-full bg-white/10 px-3 py-1 text-sm font-medium text-white ring-1 ring-white/20\">\r\n                <span className={`h-2 w-2 rounded-full ${available ? \"bg-emerald-400\" : \"bg-red-400\"} animate-pulse`} />\r\n                {available ? \"Online\" : \"Offline\"}\r\n              </span>\r\n              <span className=\"text-slate-200 text-sm flex items-center gap-1\">\r\n                <ShieldCheck className=\"h-4 w-4\" /> Safe driving mode active\r\n              </span>\r\n            </div>\r\n          </div>\r\n          <div className=\"flex items-center gap-4\">\r\n            <div className=\"text-right mr-1\">\r\n              <div className=\"text-sm text-slate-200\">Status</div>\r\n              <div className=\"text-lg font-semibold flex items-center gap-2\">\r\n                <span className={`h-2.5 w-2.5 rounded-full ${available ? \"bg-emerald-400\" : \"bg-red-400\"}`} />\r\n                {available ? \"Online\" : \"Offline\"}\r\n              </div>\r\n            </div>\r\n            <DriverAvailabilitySwitch />\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Goal + rating row */}\r\n      <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-3 sm:gap-4\">\r\n        <div className=\"col-span-1 lg:col-span-2 bg-white rounded-xl border border-slate-200 shadow-sm p-4 sm:p-5 transition-all duration-300 hover:shadow-md hover:scale-[1.01] animate-fade-in-up delay-100\">\r\n          <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3\">\r\n            <div className=\"flex items-center gap-2 min-w-0 flex-1\">\r\n              <TrendingUp className=\"h-4 w-4 sm:h-5 sm:w-5 text-blue-600 flex-shrink-0 transition-all duration-300 hover:scale-110 hover:rotate-12\" />\r\n              <div className=\"min-w-0 flex-1\">\r\n                <p className=\"text-xs sm:text-sm text-slate-500 transition-colors duration-300\">Week Goal</p>\r\n                <p className=\"text-lg sm:text-xl lg:text-2xl font-semibold text-slate-900 truncate transition-all duration-300\">\r\n                  {fmtMoney(earningsToday)} / {fmtMoney(goals?.money ?? stats?.todayGoal ?? 0)} TZS\r\n                </p>\r\n              </div>\r\n              {goals?.moneyUrgent && (\r\n                <span className=\"ml-2 inline-block text-xs px-2 py-0.5 rounded bg-red-100 text-red-700 font-medium flex-shrink-0 transition-all duration-300 hover:scale-110 animate-pulse\">URGENT</span>\r\n              )}\r\n            </div>\r\n            <div className=\"flex items-center gap-2 sm:gap-3 flex-shrink-0\">\r\n              <span className=\"text-xs sm:text-sm text-slate-500 transition-all duration-300\">{Math.round(goals && goals.money ? Math.min((earningsToday / (goals.money || 1)) * 100, 100) : progressPct)}%</span>\r\n              <button onClick={() => setShowGoalsModal(true)} className=\"text-xs sm:text-sm px-2 sm:px-3 py-1 rounded-lg border bg-white hover:bg-gray-50 whitespace-nowrap transition-all duration-300 hover:scale-105 active:scale-95 hover:shadow-sm\">Set Goals</button>\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"mt-4 h-3 w-full rounded-full bg-slate-100 overflow-hidden\">\r\n            <div\r\n              className=\"h-full bg-gradient-to-r from-blue-500 to-emerald-500 transition-all\"\r\n              style={{ width: `${goals && goals.money ? Math.min((earningsToday / (goals.money || 1)) * 100, 100) : progressPct}%` }}\r\n            />\r\n          </div>\r\n\r\n          {goals && goals.trips ? (\r\n            <div className=\"mt-3\">\r\n              <div className=\"flex items-center justify-between text-xs text-gray-600 mb-1\">\r\n                <div>Trips: {rides}/{goals.trips}</div>\r\n                <div>{Math.round(Math.min((rides / goals.trips) * 100, 100))}%</div>\r\n              </div>\r\n              <div className=\"w-full bg-gray-200 rounded-full h-2 overflow-hidden\">\r\n                <div\r\n                  className=\"bg-emerald-500 h-2 rounded-full transition-all\"\r\n                  style={{ width: `${Math.round(Math.min((rides / goals.trips) * 100, 100))}%` }}\r\n                />\r\n              </div>\r\n            </div>\r\n          ) : null}\r\n        </div>\r\n\r\n        <div className=\"bg-white rounded-xl border border-slate-200 shadow-sm p-4 sm:p-5 space-y-3 sm:space-y-4 transition-all duration-300 hover:shadow-md hover:scale-[1.02] animate-fade-in-up delay-200\">\r\n          <div className=\"flex items-center justify-between gap-3\">\r\n            <div className=\"min-w-0 flex-1\">\r\n              <p className=\"text-xs sm:text-sm text-slate-500 transition-colors duration-300\">Rating</p>\r\n              <p className=\"text-xl sm:text-2xl font-semibold text-slate-900 flex items-center gap-1 transition-all duration-300\">\r\n                {rating.toFixed(1)} <Star className=\"h-4 w-4 sm:h-5 sm:w-5 text-amber-400 flex-shrink-0 transition-all duration-300 hover:scale-110 hover:rotate-12\" />\r\n              </p>\r\n              <p className=\"text-xs text-slate-500 truncate transition-colors duration-300\">{stats?.totalReviews ?? 0} reviews</p>\r\n            </div>\r\n            <div className=\"rounded-full bg-slate-50 p-2 sm:p-3 border border-slate-100 flex-shrink-0 transition-all duration-300 hover:bg-amber-50 hover:border-amber-200 hover:scale-110\">\r\n              <Star className=\"h-5 w-5 sm:h-6 sm:w-6 text-amber-400 transition-all duration-300 hover:rotate-12\" />\r\n            </div>\r\n          </div>\r\n          <div className=\"border-t border-slate-100 pt-3 transition-all duration-300\">\r\n            <p className=\"text-xs sm:text-sm text-slate-500 flex items-center gap-2 transition-colors duration-300\">\r\n              <Clock3 className=\"h-3 w-3 sm:h-4 sm:w-4 flex-shrink-0 transition-all duration-300 hover:scale-110 hover:rotate-12\" /> <span className=\"truncate\">Online hours</span>\r\n            </p>\r\n            <p className=\"text-base sm:text-lg font-semibold text-slate-900 transition-all duration-300\">{onlineHours} hrs</p>\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      {/* KPI bar */}\r\n      <div className=\"grid grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4\">\r\n        <div className=\"bg-white rounded-lg border border-slate-200 p-3 sm:p-4 shadow-sm flex items-center gap-2 sm:gap-3 transition-all duration-300 hover:shadow-md hover:scale-105 hover:border-blue-300 animate-fade-in-up delay-300 relative overflow-hidden group\">\r\n          <div className=\"rounded-full bg-blue-50 p-2 sm:p-3 flex-shrink-0 transition-all duration-300 hover:bg-blue-100 hover:scale-110\">\r\n            <TrendingUp className=\"h-4 w-4 sm:h-5 sm:w-5 text-blue-600 transition-all duration-300 hover:rotate-12\" />\r\n          </div>\r\n          <div className=\"min-w-0 flex-1\">\r\n            <p className=\"text-xs text-slate-500 transition-colors duration-300\">Rides</p>\r\n            <p className=\"text-base sm:text-lg font-semibold text-slate-900 truncate transition-all duration-300\">{rides}</p>\r\n            <p className=\"text-xs text-slate-500 truncate transition-colors duration-300\">Accept: {acceptRate}%</p>\r\n          </div>\r\n          <div className=\"absolute bottom-0 left-0 right-0 h-0.5 bg-blue-200 opacity-0 group-hover:opacity-100 transition-opacity duration-300\"></div>\r\n        </div>\r\n        <div className=\"bg-white rounded-lg border border-slate-200 p-3 sm:p-4 shadow-sm flex items-center gap-2 sm:gap-3 transition-all duration-300 hover:shadow-md hover:scale-105 hover:border-emerald-300 animate-fade-in-up delay-400 relative overflow-hidden group\">\r\n          <div className=\"rounded-full bg-emerald-50 p-2 sm:p-3 flex-shrink-0 transition-all duration-300 hover:bg-emerald-100 hover:scale-110\">\r\n            <FileText className=\"h-4 w-4 sm:h-5 sm:w-5 text-emerald-600 transition-all duration-300 hover:scale-110\" />\r\n          </div>\r\n          <div className=\"min-w-0 flex-1\">\r\n            <p className=\"text-xs text-slate-500 transition-colors duration-300\">Earnings</p>\r\n            <p className=\"text-base sm:text-lg font-semibold text-slate-900 truncate transition-all duration-300\">{fmtMoney(earningsToday)}</p>\r\n            <p className=\"text-xs text-slate-500 truncate transition-colors duration-300\">+{fmtMoney(earningsExtra)}</p>\r\n          </div>\r\n          <div className=\"absolute bottom-0 left-0 right-0 h-0.5 bg-emerald-200 opacity-0 group-hover:opacity-100 transition-opacity duration-300\"></div>\r\n        </div>\r\n        <div className=\"bg-white rounded-lg border border-slate-200 p-3 sm:p-4 shadow-sm flex items-center gap-2 sm:gap-3 transition-all duration-300 hover:shadow-md hover:scale-105 hover:border-indigo-300 animate-fade-in-up delay-500 relative overflow-hidden group\">\r\n          <div className=\"rounded-full bg-indigo-50 p-2 sm:p-3 flex-shrink-0 transition-all duration-300 hover:bg-indigo-100 hover:scale-110\">\r\n            <CheckCircle2 className=\"h-4 w-4 sm:h-5 sm:w-5 text-indigo-600 transition-all duration-300 hover:scale-110 hover:rotate-12\" />\r\n          </div>\r\n          <div className=\"min-w-0 flex-1\">\r\n            <p className=\"text-xs text-slate-500 transition-colors duration-300\">Completed</p>\r\n            <p className=\"text-base sm:text-lg font-semibold text-slate-900 truncate transition-all duration-300\">{rides}</p>\r\n            <p className=\"text-xs text-slate-500 truncate transition-colors duration-300\">Total trips</p>\r\n          </div>\r\n          <div className=\"absolute bottom-0 left-0 right-0 h-0.5 bg-indigo-200 opacity-0 group-hover:opacity-100 transition-opacity duration-300\"></div>\r\n        </div>\r\n        <div className=\"bg-white rounded-lg border border-slate-200 p-3 sm:p-4 shadow-sm flex items-center gap-2 sm:gap-3 transition-all duration-300 hover:shadow-md hover:scale-105 hover:border-emerald-300 animate-fade-in-up delay-600 relative overflow-hidden group\">\r\n          <div className=\"rounded-full bg-emerald-50 p-2 sm:p-3 flex-shrink-0 transition-all duration-300 hover:bg-emerald-100 hover:scale-110\">\r\n            <CheckCircle2 className=\"h-4 w-4 sm:h-5 sm:w-5 text-emerald-600 transition-all duration-300 hover:scale-110 hover:rotate-12\" />\r\n          </div>\r\n          <div className=\"min-w-0 flex-1\">\r\n            <p className=\"text-xs text-slate-500 transition-colors duration-300\">Goal progress</p>\r\n            <p className=\"text-base sm:text-lg font-semibold text-slate-900 truncate transition-all duration-300\">\r\n              {Math.round(goals && goals.money ? Math.min((earningsToday / (goals.money || 1)) * 100, 100) : progressPct)}%\r\n            </p>\r\n            <p className=\"text-xs text-slate-500 truncate transition-colors duration-300\">Week target</p>\r\n          </div>\r\n          <div className=\"absolute bottom-0 left-0 right-0 h-0.5 bg-emerald-200 opacity-0 group-hover:opacity-100 transition-opacity duration-300\"></div>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Goals Modal */}\r\n      {showGoalsModal && (\r\n        <div className=\"fixed inset-0 z-50 flex items-center justify-center px-4 py-6\">\r\n          <div className=\"absolute inset-0 bg-black/40\" onClick={() => setShowGoalsModal(false)} />\r\n          <div className=\"relative bg-white rounded-xl shadow-2xl w-full max-w-md p-6 z-10 border border-slate-100 overflow-hidden\">\r\n            <div className=\"flex items-start justify-between gap-3 mb-3\">\r\n              <div>\r\n                <h3 className=\"text-lg font-semibold text-slate-900\">Set Your Goals</h3>\r\n                <p className=\"text-sm text-slate-500\">Track weekly trips and earnings to stay on target.</p>\r\n              </div>\r\n              <button\r\n                type=\"button\"\r\n                onClick={() => setShowGoalsModal(false)}\r\n                className=\"text-slate-500 hover:text-slate-700\"\r\n                aria-label=\"Close\"\r\n              >\r\n                ✕\r\n              </button>\r\n            </div>\r\n\r\n            <div className=\"space-y-4 max-w-sm\">\r\n              <div className=\"space-y-1\">\r\n                <label htmlFor=\"formTrips\" className=\"block text-sm font-medium text-slate-800\">\r\n                  Weekly trips target\r\n                </label>\r\n                <input\r\n                  id=\"formTrips\"\r\n                  type=\"number\"\r\n                  min={0}\r\n                  placeholder=\"e.g. 20\"\r\n                  title=\"Number of trips goal\"\r\n                  value={formTrips as any}\r\n                  onChange={(e) => setFormTrips(e.target.value === '' ? '' : Number(e.target.value))}\r\n                  className=\"w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500\"\r\n                />\r\n                <p className=\"text-xs text-slate-500\">How many rides you want to finish this week.</p>\r\n              </div>\r\n\r\n              <div className=\"space-y-1\">\r\n                <label htmlFor=\"formMoney\" className=\"block text-sm font-medium text-slate-800\">\r\n                  Weekly earnings target (TZS)\r\n                </label>\r\n                <input\r\n                  id=\"formMoney\"\r\n                  type=\"number\"\r\n                  min={0}\r\n                  placeholder=\"e.g. 100000\"\r\n                  title=\"Money goal in TZS\"\r\n                  value={formMoney as any}\r\n                  onChange={(e) => setFormMoney(e.target.value === '' ? '' : Number(e.target.value))}\r\n                  className=\"w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500\"\r\n                />\r\n                <p className=\"text-xs text-slate-500\">Total cash target for this week.</p>\r\n              </div>\r\n\r\n              <label className=\"inline-flex items-center gap-2 text-sm text-slate-700\">\r\n                <input\r\n                  type=\"checkbox\"\r\n                  checked={formMoneyUrgent}\r\n                  onChange={(e) => setFormMoneyUrgent(e.target.checked)}\r\n                  className=\"h-4 w-4 rounded border-slate-300 bg-blue-50 text-blue-600 focus:ring-2 focus:ring-blue-500 focus:ring-offset-1\"\r\n                />\r\n                Mark this earnings goal as urgent\r\n              </label>\r\n            </div>\r\n\r\n            <div className=\"mt-6 flex items-center justify-between gap-3\">\r\n              <button\r\n                onClick={handleClearGoals}\r\n                className=\"text-sm text-red-600 hover:text-red-700\"\r\n              >\r\n                Clear goals\r\n              </button>\r\n              <div className=\"flex items-center gap-2\">\r\n                <button\r\n                  onClick={() => setShowGoalsModal(false)}\r\n                  className=\"px-3 py-2 rounded-lg border border-slate-200 text-sm text-slate-700 hover:bg-slate-50\"\r\n                >\r\n                  Cancel\r\n                </button>\r\n                <button\r\n                  onClick={handleSaveGoals}\r\n                  className=\"px-4 py-2 rounded-lg bg-[#02665e] text-white text-sm font-semibold shadow-sm hover:bg-[#015149]\"\r\n                >\r\n                  Save goals\r\n                </button>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      {/* Analytics Charts */}\r\n      <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-4\">\r\n        {/* Earnings Chart */}\r\n        <div className=\"bg-white rounded-lg p-4 shadow-sm\">\r\n          <div className=\"font-medium text-gray-800 mb-3\">Earnings (7 days)</div>\r\n          <ResponsiveContainer width=\"100%\" height={150}>\r\n            <LineChart data={stats.earningsChart}>\r\n              <CartesianGrid strokeDasharray=\"3 3\" stroke=\"#f0f0f0\" />\r\n              <XAxis dataKey=\"day\" tick={{ fontSize: 12 }} />\r\n              <YAxis tick={{ fontSize: 12 }} />\r\n              <Tooltip formatter={(value: any) => `${fmtMoney(value)} TZS`} />\r\n              <Line \r\n                type=\"monotone\" \r\n                dataKey=\"amount\" \r\n                stroke=\"#2563eb\" \r\n                strokeWidth={2}\r\n                dot={{ fill: '#2563eb', r: 4 }}\r\n              />\r\n            </LineChart>\r\n          </ResponsiveContainer>\r\n        </div>\r\n\r\n        {/* Trips by Properties */}\r\n        <div className=\"bg-white rounded-lg p-4 shadow-sm\">\r\n          <div className=\"font-medium text-gray-800 mb-3\">Trips by Properties</div>\r\n          <ResponsiveContainer width=\"100%\" height={Math.max(240, Math.min(420, chartHeight))}>\r\n            <BarChart\r\n              data={tripsByProperty}\r\n              margin={{ top: 10, right: 20, left: 20, bottom: 60 }}\r\n            >\r\n              <CartesianGrid strokeDasharray=\"3 3\" stroke=\"#f0f0f0\" />\r\n              <XAxis dataKey=\"name\" type=\"category\" tick={<MultiLineTick />} interval={0} />\r\n              <YAxis type=\"number\" tick={{ fontSize: 12 }} />\r\n              <Tooltip\r\n                content={({ active, payload }: any) => {\r\n                  if (!active || !payload || !payload.length) return null;\r\n                  const p = payload[0];\r\n                  const name = p?.payload?.name ?? p?.name ?? '';\r\n                  const value = p?.value ?? 0;\r\n                  return (\r\n                    <div className=\"bg-white text-sm rounded shadow-md p-2\">\r\n                      <div className=\"font-medium text-gray-800\">{name}</div>\r\n                      <div className=\"text-xs text-gray-600\">{value} trips</div>\r\n                    </div>\r\n                  );\r\n                }}\r\n              />\r\n              <Bar dataKey=\"trips\" barSize={24}>\r\n                {tripsByProperty.map((entry: any, index: number) => (\r\n                  <Cell key={`cell-${index}`} fill={[\"#7c3aed\", \"#059669\", \"#2563eb\", \"#e11d48\", \"#10b981\", \"#f97316\"][index % 6]} />\r\n                ))}\r\n              </Bar>\r\n            </BarChart>\r\n          </ResponsiveContainer>\r\n        </div>\r\n      </div>\r\n\r\n      {/* High Demand Zones moved to Live Map page */}\r\n\r\n      {/* Recent Trips */}\r\n      <div className=\"bg-white rounded-lg p-5 shadow-sm\">\r\n        <div className=\"flex items-center justify-between mb-4\">\r\n          <div className=\"font-semibold text-gray-800\">RECENT TRIPS</div>\r\n          <Link \r\n            href=\"/driver/history\" \r\n            className=\"text-sm text-blue-600 hover:text-blue-700 flex items-center gap-1 no-underline transition-all duration-200 hover:scale-110\"\r\n            title=\"View All History\"\r\n          >\r\n            <Eye className=\"h-5 w-5\" />\r\n          </Link>\r\n        </div>\r\n        <div className=\"space-y-3\">\r\n          {stats.recentTrips && stats.recentTrips.length > 0 ? (\r\n            stats.recentTrips.map((trip) => (\r\n              <div \r\n                key={trip.id}\r\n                className=\"flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors\"\r\n              >\r\n                <div className=\"flex items-center gap-3 flex-1\">\r\n                  <div className=\"text-sm text-gray-600 w-16\">{trip.time}</div>\r\n                  <ArrowRight className=\"h-4 w-4 text-gray-400\" />\r\n                  <div className=\"flex-1\">\r\n                    <div className=\"text-sm font-medium text-gray-900\">\r\n                      {trip.from} → {trip.to}\r\n                    </div>\r\n                    <div className=\"text-xs text-gray-500\">{trip.distance}</div>\r\n                  </div>\r\n                </div>\r\n                <div className=\"text-sm font-semibold text-gray-900\">\r\n                  {fmtMoney(trip.amount)} TZS\r\n                </div>\r\n              </div>\r\n            ))\r\n          ) : (\r\n            <div className=\"text-sm text-gray-600 py-4 text-center\">\r\n              No recent trips yet. Your completed trips will appear here.\r\n            </div>\r\n          )}\r\n        </div>\r\n      </div>\r\n\r\n      {/* Reminders */}\r\n      <div className=\"bg-white rounded-lg p-5 shadow-sm\">\r\n        <div className=\"flex items-center justify-between mb-4\">\r\n          <div className=\"flex items-center gap-2\">\r\n            <AlertCircle className=\"h-5 w-5 text-amber-600\" />\r\n            <div className=\"font-semibold text-gray-800\">REMINDERS</div>\r\n            {reminders.filter((r: any) => !r.isRead).length > 0 && (\r\n              <span className=\"px-2 py-0.5 bg-red-500 text-white text-xs rounded-full\">\r\n                {reminders.filter((r: any) => !r.isRead).length} New\r\n              </span>\r\n            )}\r\n          </div>\r\n          <Link \r\n            href=\"/driver/reminders\" \r\n            className=\"text-sm text-emerald-600 hover:text-emerald-700 flex items-center gap-1 no-underline transition-all\"\r\n          >\r\n            View All\r\n            <ArrowRight className=\"h-4 w-4\" />\r\n          </Link>\r\n        </div>\r\n        <div className=\"space-y-3\">\r\n          {reminders.length === 0 ? (\r\n            <div className=\"text-sm text-gray-600\">You have no reminders right now.</div>\r\n          ) : (\r\n            reminders.slice(0, 5).map((reminder) => {\r\n              const containerCls = reminder.type === 'warning' ? 'bg-amber-50 border border-amber-200' : 'bg-blue-50 border border-blue-200';\r\n              return (\r\n                <div key={reminder.id} className={`flex items-center justify-between p-3 rounded-lg ${containerCls}`}>\r\n                  <div className=\"flex items-center gap-3 flex-1\">\r\n                    {reminder.type === 'warning' ? (\r\n                      <AlertCircle className=\"h-5 w-5 text-amber-600 flex-shrink-0\" />\r\n                    ) : (\r\n                      <FileText className=\"h-5 w-5 text-blue-600 flex-shrink-0\" />\r\n                    )}\r\n                    <span className=\"text-sm text-gray-700\">{reminder.message}</span>\r\n                  </div>\r\n                  <div className=\"flex items-center gap-2 ml-3\">\r\n                    {reminder.action && reminder.actionLink ? (\r\n                      <Link href={reminder.actionLink} className=\"text-sm font-medium text-blue-600 hover:text-blue-700 no-underline whitespace-nowrap\">\r\n                        {reminder.action}\r\n                      </Link>\r\n                    ) : null}\r\n                    <button onClick={() => markAsRead(String(reminder.id))} className=\"text-sm text-gray-600 hover:text-gray-800\">Dismiss</button>\r\n                  </div>\r\n                </div>\r\n              );\r\n            })\r\n          )}\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\DriverFooter.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\DriverLiveMap.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\DriverLiveMapBottomSheet.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\DriverLiveMapCanvas.tsx","messages":[],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'smoothedDriverPos'. Either include it or remove the dependency array.","line":256,"column":6,"nodeType":"ArrayExpression","endLine":256,"endColumn":17,"suggestions":[{"desc":"Update the dependencies array to be: [driverPos, smoothedDriverPos]","fix":{"range":[9094,9105],"text":"[driverPos, smoothedDriverPos]"}}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'assignmentFeatures', 'driverPos.lat', 'driverPos.lng', and 'liveOnly'. Either include them or remove the dependency array.","line":776,"column":6,"nodeType":"ArrayExpression","endLine":776,"endColumn":42,"suggestions":[{"desc":"Update the dependencies array to be: [data, mapboxToken, desiredStyleUrl, driverPos.lng, driverPos.lat, liveOnly, assignmentFeatures]","fix":{"range":[27865,27901],"text":"[data, mapboxToken, desiredStyleUrl, driverPos.lng, driverPos.lat, liveOnly, assignmentFeatures]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\DriverLiveMapFloatingActions.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\DriverLiveMapTopControls.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\DriverMatchingInfo.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\DriverPageHeader.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\DriverRegistration.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\DriverSidebar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\DriverSiteHeader.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\DriverSwitchOffline.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\DriverSwitchOnline.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\DriverWelcome.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'setMapError' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":37,"column":20,"nodeType":"Identifier","messageId":"unusedVar","endLine":37,"endColumn":31}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\nimport React, { useEffect, useState } from \"react\";\r\nimport Link from \"next/link\";\r\nimport axios from \"axios\";\r\nimport RefreshButton from \"@/components/RefreshButton\";\r\nimport { Calendar, DollarSign, Star } from 'lucide-react';\r\nimport DriverAvailabilitySwitch from \"@/components/DriverAvailabilitySwitch\";\r\n\r\n// Use same-origin calls + secure httpOnly cookie session.\r\nconst api = axios.create({ baseURL: \"\", withCredentials: true });\r\n\r\nexport default function DriverWelcome({ className }: { className?: string }) {\r\n  // me === undefined -> loading; null -> not authenticated / fallback; object -> user\r\n  const [me, setMe] = useState<any | null | undefined>(undefined);\r\n\r\n  useEffect(() => {\r\n    api\r\n      .get(\"/api/account/me\")\r\n      .then((r) => setMe(r.data))\r\n      .catch(() => setMe(null));\r\n  }, []);\r\n\r\n  const name = me && (me.fullName || me.email) ? (me.fullName || me.email) : \"Driver\";\r\n  const isoDate = (new Date()).toISOString().slice(0,10);\r\n  \r\n  const [available, setAvailable] = useState<boolean>(() => {\r\n    try {\r\n      const raw = localStorage.getItem('driver_available');\r\n      return raw === '1' || raw === 'true';\r\n    } catch (e) {\r\n      return false;\r\n    }\r\n  });\r\n\r\n  // minimal placeholder state for the welcome card's map area (map is mounted on the Live Map page)\r\n  const [mapVisible, setMapVisible] = useState<boolean>(false);\r\n  const [mapError, setMapError] = useState<string | null>(null);\r\n\r\n  useEffect(() => {\r\n    const handler = (ev: Event) => {\r\n      try {\r\n        const detail = (ev as CustomEvent).detail || {};\r\n        if (typeof detail.available === 'boolean') {\r\n          setAvailable(detail.available);\r\n          try { setMapVisible(detail.available); } catch (e) {}\r\n        }\r\n      } catch (e) {\r\n        // ignore\r\n      }\r\n    };\r\n    const storageHandler = (e: StorageEvent) => {\r\n      if (e.key === 'driver_available') {\r\n        const val = e.newValue;\r\n        const avail = val === '1' || val === 'true';\r\n        setAvailable(avail);\r\n        try { setMapVisible(avail); } catch (e) {}\r\n      }\r\n    };\r\n    window.addEventListener('nols:availability:changed', handler as EventListener);\r\n    window.addEventListener('storage', storageHandler as any);\r\n    return () => {\r\n      window.removeEventListener('nols:availability:changed', handler as EventListener);\r\n      window.removeEventListener('storage', storageHandler as any);\r\n    };\r\n  }, []);\r\n  \r\n\r\n  // Map is provided by the Live Map page; welcome card shows a placeholder.\r\n  // quick-link stats: default to zeros; we'll attempt to fetch driver stats if an API is available\r\n  const [stats, setStats] = useState<{ todaysRides: number; earnings: number; rating: number }>({\r\n    todaysRides: 0,\r\n    earnings: 0,\r\n    rating: 0,\r\n  });\r\n  // no-op: map initialization moved to DriverLiveMap component\r\n\r\n  // try to fetch lightweight driver stats (non-blocking). If API is absent, we silently keep zeros.\r\n  useEffect(() => {\r\n    let cancelled = false;\r\n    (async () => {\r\n      try {\r\n        // Request stats for today (some APIs accept a date param). Use ISO date (YYYY-MM-DD).\r\n        const today = new Date();\r\n        const isoDate = today.toISOString().slice(0, 10);\r\n        // best-effort endpoint; if it doesn't exist the request will fail and we'll keep defaults\r\n        const res = await api.get(`/api/driver/stats?date=${isoDate}`);\r\n        if (cancelled) return;\r\n        const data = res.data || {};\r\n        setStats({\r\n          todaysRides: typeof data.todaysRides === \"number\" ? data.todaysRides : 0,\r\n          earnings: typeof data.earnings === \"number\" ? data.earnings : 0,\r\n          rating: typeof data.rating === \"number\" ? data.rating : 0,\r\n        });\r\n      } catch (e) {\r\n        // ignore — keep zeros\r\n      }\r\n    })();\r\n    return () => {\r\n      cancelled = true;\r\n    };\r\n  }, []);\r\n\r\n  return (\r\n    <section className={`bg-white rounded-lg p-6 border text-center ${className || \"\"}`}>\r\n      {me === undefined ? (\r\n        <div className=\"animate-pulse\">\r\n          <div className=\"h-8 bg-gray-200 rounded w-48 mx-auto\" />\r\n          <div className=\"mt-2 h-4 bg-gray-200 rounded w-72 mx-auto\" />\r\n        </div>\r\n      ) : (\r\n        <>\r\n          <div className=\"flex items-center justify-center gap-4\">\r\n            <h1 className=\"text-2xl sm:text-3xl font-semibold\">Welcome, {name}</h1>\r\n            {/* availability switch inline with the welcome title */}\r\n            <div className=\"ml-2\">\r\n              <DriverAvailabilitySwitch />\r\n            </div>\r\n          </div>\r\n          <p className=\"mt-2 text-gray-600 text-center\">\r\n            {available ? \"Now you're online.\" : \"Now you can manage rides, view your schedule, handle payments, and update your account.\"}\r\n          </p>\r\n          <div className=\"mt-4 flex justify-center\">\r\n            <RefreshButton />\r\n          </div>\r\n          {/* Quick action links near the welcome area (moved from the sidebar) - show only when offline */}\r\n          {!available ? (\r\n            <div className=\"mt-4 flex justify-center\">\r\n              <div className=\"flex gap-3 flex-wrap justify-center\">\r\n\r\n                <Link href={`/driver/trips?date=${isoDate}`} aria-label=\"Today's Rides\" className=\"no-underline flex items-center gap-3 bg-white border border-blue-50 shadow-sm hover:shadow-md px-3 py-2 rounded-lg min-w-[140px] transition-transform hover:-translate-y-0.5\">\r\n                  <div className=\"h-9 w-9 rounded-full bg-blue-50 flex items-center justify-center\">\r\n                    <Calendar className=\"h-5 w-5 text-blue-600\" />\r\n                  </div>\r\n                  <div className=\"flex-1 text-left\">\r\n                    <div className=\"text-sm font-medium text-gray-800\">Today&apos;s Rides</div>\r\n                  </div>\r\n                  <div className=\"text-sm text-gray-600 font-medium\">{stats.todaysRides}</div>\r\n                </Link>\r\n\r\n                <Link href={`/driver/invoices?date=${isoDate}`} aria-label=\"Earnings (Invoices & Payouts)\" className=\"no-underline flex items-center gap-3 bg-white border border-green-50 shadow-sm hover:shadow-md px-3 py-2 rounded-lg min-w-[140px] transition-transform hover:-translate-y-0.5\">\r\n                  <div className=\"h-9 w-9 rounded-full bg-green-50 flex items-center justify-center\">\r\n                    <DollarSign className=\"h-5 w-5 text-green-600\" />\r\n                  </div>\r\n                  <div className=\"flex-1 text-left\">\r\n                    <div className=\"text-sm font-medium text-gray-800\">Earnings</div>\r\n                  </div>\r\n                  <div className=\"text-sm text-gray-600 font-medium\">{stats.earnings ? stats.earnings.toLocaleString() + ' TZS' : '0 TZS'}</div>\r\n                </Link>\r\n\r\n                <div role=\"img\" aria-label={`Rating ${stats.rating}`} className=\"no-underline flex items-center gap-3 bg-white border border-amber-50 px-3 py-2 rounded-lg min-w-[140px]\">\r\n                  <div className=\"h-9 w-9 rounded-full bg-amber-50 flex items-center justify-center\">\r\n                    <Star className=\"h-5 w-5 text-amber-600\" />\r\n                  </div>\r\n                  <div className=\"flex-1 text-left\">\r\n                    <div className=\"text-sm font-medium text-gray-800\">Rating</div>\r\n                  </div>\r\n                  <div className=\"text-sm text-gray-600 font-medium\">{stats.rating}</div>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          ) : null}\r\n          {/* Map placeholder: an element with id=\"driver-map\" where Google Maps will mount a responsive map.\r\n              Heights are responsive: mobile ~16rem, small screens ~20rem, medium+ ~24rem. */}\r\n          {/* Map container always in DOM to allow CSS transitions; visibility toggled via mapVisible */}\r\n          <div className=\"mt-6\">\r\n            <div\r\n              id=\"driver-map\"\r\n              className={`w-full rounded-lg overflow-hidden border-2 border-blue-200 bg-gray-50 h-64 sm:h-80 md:h-96 transition-all duration-300 ease-out ${mapVisible ? 'opacity-100 translate-y-0' : 'opacity-0 -translate-y-2 pointer-events-none'}`}\r\n            >\r\n              {!available ? (\r\n                // Offline skeleton for the map area\r\n                <div className=\"h-full w-full flex items-center justify-center\">\r\n                  <div className=\"w-11/12\">\r\n                    <div className=\"animate-pulse\">\r\n                      <div className=\"h-36 bg-gray-200 rounded-md\" />\r\n                      <div className=\"mt-3 h-3 bg-gray-200 rounded w-3/4\" />\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n              ) : mapError ? (\r\n                <div className=\"flex items-center justify-center h-full text-red-500\">Map failed to load: {mapError}</div>\r\n              ) : (\r\n                <div className=\"flex items-center justify-center h-full text-gray-400\">Map placeholder — Google Maps coming soon</div>\r\n              )}\r\n            </div>\r\n          </div>\r\n        </>\r\n      )}\r\n    </section>\r\n  );\r\n}\r\n// Map provider: Google Maps\r\nexport function initDriverMap() {\r\n  // noop placeholder to allow tests/imports\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\FloatingChatWidget.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\FounderStory.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\GeneralReports.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\GlobalPicker.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'ChevronDown' is defined but never used. Allowed unused vars must match /^_/u.","line":4,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":28,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"ChevronDown"},"fix":{"range":[85,98],"text":""},"desc":"Remove unused variable \"ChevronDown\"."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useEffect, useState, useRef } from \"react\";\r\nimport { Globe, ChevronDown } from 'lucide-react';\r\n\r\nconst KEY_LOCALE = 'nolsaf_locale';\r\nconst KEY_CURRENCY = 'nolsaf_currency';\r\n\r\nconst LANGUAGES = [\r\n  { code: 'en', label: 'English' },\r\n  { code: 'fr', label: 'Français' },\r\n  { code: 'sw', label: 'Kiswahili' },\r\n  { code: 'ar', label: 'العربية' },\r\n];\r\n\r\nconst CURRENCIES = [\r\n  { code: 'TZS', label: 'TSh' },\r\n  { code: 'USD', label: '$' },\r\n  { code: 'EUR', label: '€' },\r\n  { code: 'KES', label: 'KSh' },\r\n];\r\n\r\nexport default function GlobalPicker({ variant = \"dark\" }:{ variant?: \"light\" | \"dark\" }) {\r\n  const [open, setOpen] = useState(false);\r\n  const [locale, setLocale] = useState<string>('en');\r\n  const [currency, setCurrency] = useState<string>('TZS');\r\n\r\n  useEffect(() => {\r\n    try { const stored = localStorage.getItem(KEY_LOCALE); if (stored) setLocale(stored); } catch (e) {}\r\n    try { const storedC = localStorage.getItem(KEY_CURRENCY); if (storedC) setCurrency(storedC); } catch (e) {}\r\n  }, []);\r\n  const ref = useRef<HTMLDivElement | null>(null);\r\n\r\n  useEffect(() => {\r\n    try { localStorage.setItem(KEY_LOCALE, locale); } catch (e) {}\r\n    try { document.documentElement.lang = locale === 'sw' ? 'sw' : locale; document.documentElement.dir = locale === 'ar' ? 'rtl' : 'ltr'; } catch (e) {}\r\n  }, [locale]);\r\n\r\n  useEffect(() => {\r\n    try { localStorage.setItem(KEY_CURRENCY, currency); } catch (e) {}\r\n  }, [currency]);\r\n\r\n  useEffect(() => {\r\n    const onDoc = (e: MouseEvent) => {\r\n      if (!ref.current) return;\r\n      if (!ref.current.contains(e.target as Node)) setOpen(false);\r\n    };\r\n    document.addEventListener('click', onDoc);\r\n    return () => document.removeEventListener('click', onDoc);\r\n  }, []);\r\n\r\n  const currentLanguage = LANGUAGES.find(l => l.code === locale);\r\n  const currentCurrency = CURRENCIES.find(c => c.code === currency);\r\n\r\n  return (\r\n    <div ref={ref} className=\"relative\">\r\n      <button\r\n        onClick={() => setOpen(v => !v)}\r\n        className={[\r\n          \"inline-flex items-center justify-center h-9 w-9 rounded-full bg-transparent transition-all duration-300 hover:scale-110 active:scale-95 group relative border-0 outline-none focus:outline-none focus:ring-0\",\r\n          variant === \"light\" ? \"text-[#02665e] hover:bg-[#02665e]/10\" : \"text-white hover:bg-white/10\",\r\n        ].join(\" \")}\r\n        aria-haspopup=\"true\"\r\n        aria-expanded={open}\r\n        title={`${currentLanguage?.label || locale.toUpperCase()} • ${currentCurrency?.label || currency}`}\r\n      >\r\n        <Globe className=\"h-5 w-5 transition-transform duration-300 group-hover:rotate-12\" aria-hidden />\r\n      </button>\r\n\r\n      {open && (\r\n        <div\r\n          className=\"absolute right-0 mt-2 w-64 max-w-none bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden z-50 animate-in fade-in slide-in-from-top-2 duration-200\"\r\n          style={{ maxWidth: \"none\" }}\r\n        >\r\n          <div className=\"p-3\">\r\n            {/* Language Section */}\r\n            <div className=\"mb-3\">\r\n              <div className=\"px-2 py-1 text-[10px] font-semibold text-gray-400 uppercase tracking-wider mb-1.5\">Language</div>\r\n              <div className=\"grid grid-cols-2 gap-1\">\r\n                {LANGUAGES.map(l => (\r\n                  <button \r\n                    key={l.code} \r\n                    onClick={() => { setLocale(l.code); setOpen(false); }} \r\n                    className={`w-full text-left px-2.5 py-1.5 text-xs rounded-md transition-all duration-150 ${\r\n                      locale === l.code \r\n                        ? 'bg-[#02665e] text-white font-medium' \r\n                        : 'text-gray-600 hover:bg-gray-50'\r\n                    }`}\r\n                  >\r\n                    <div className=\"flex items-center justify-between\">\r\n                      <span className=\"truncate\">{l.label}</span>\r\n                      <span className={`text-[10px] ml-1.5 flex-shrink-0 ${locale === l.code ? 'text-white/70' : 'text-gray-400'}`}>\r\n                        {l.code.toUpperCase()}\r\n                      </span>\r\n                    </div>\r\n                  </button>\r\n                ))}\r\n              </div>\r\n            </div>\r\n\r\n            {/* Divider */}\r\n            <div className=\"h-px bg-gray-100 my-2.5\"></div>\r\n\r\n            {/* Currency Section */}\r\n            <div>\r\n              <div className=\"px-2 py-1 text-[10px] font-semibold text-gray-400 uppercase tracking-wider mb-1.5\">Currency</div>\r\n              <div className=\"grid grid-cols-2 gap-1\">\r\n                {CURRENCIES.map(c => (\r\n                  <button \r\n                    key={c.code} \r\n                    onClick={() => { setCurrency(c.code); setOpen(false); }} \r\n                    className={`w-full text-left px-2.5 py-1.5 text-xs rounded-md transition-all duration-150 ${\r\n                      currency === c.code \r\n                        ? 'bg-[#02665e] text-white font-medium' \r\n                        : 'text-gray-600 hover:bg-gray-50'\r\n                    }`}\r\n                  >\r\n                    <div className=\"flex items-center justify-between\">\r\n                      <span className=\"font-medium truncate\">{c.label}</span>\r\n                      <span className={`text-[10px] ml-1.5 flex-shrink-0 ${currency === c.code ? 'text-white/70' : 'text-gray-400'}`}>\r\n                        {c.code}\r\n                      </span>\r\n                    </div>\r\n                  </button>\r\n                ))}\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\GroupStaysCard.tsx","messages":[],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'calculatedHeadcount'. Either include it or remove the dependency array.","line":134,"column":6,"nodeType":"ArrayExpression","endLine":134,"endColumn":42,"suggestions":[{"desc":"Update the dependencies array to be: [maleCount, femaleCount, otherCount, calculatedHeadcount]","fix":{"range":[6000,6036],"text":"[maleCount, femaleCount, otherCount, calculatedHeadcount]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\Hero3D.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\HeroRingsBackground.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\IncomingRequestCard.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-expressions","severity":1,"message":"Expected an assignment or function call and instead saw an expression.","line":245,"column":23,"nodeType":"ExpressionStatement","messageId":"unusedExpression","endLine":245,"endColumn":84},{"ruleId":"@typescript-eslint/no-unused-expressions","severity":1,"message":"Expected an assignment or function call and instead saw an expression.","line":248,"column":23,"nodeType":"ExpressionStatement","messageId":"unusedExpression","endLine":248,"endColumn":84}],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'request.ttl'. Either include it or remove the dependency array. If 'setSecondsLeft' needs the current value of 'request.ttl', you can also switch to useReducer instead of useState and read 'request.ttl' in the reducer.","line":70,"column":6,"nodeType":"ArrayExpression","endLine":70,"endColumn":10,"suggestions":[{"desc":"Update the dependencies array to be: [id, request.ttl]","fix":{"range":[2637,2641],"text":"[id, request.ttl]"}}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'dropoff', 'fare', 'id', and 'pickup'. Either include them or remove the dependency array.","line":98,"column":6,"nodeType":"ArrayExpression","endLine":98,"endColumn":19,"suggestions":[{"desc":"Update the dependencies array to be: [dropoff, fare, id, pickup, secondsLeft]","fix":{"range":[3939,3952],"text":"[dropoff, fare, id, pickup, secondsLeft]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\nimport React, { useState, useEffect, useRef } from \"react\";\r\nimport { ArrowLeft, ArrowRight } from 'lucide-react';\r\nimport IncomingRequestsButton from \"./IncomingRequestsButton\";\r\n\r\nexport default function IncomingRequestCard({ request }: { request?: any }) {\r\n  const [actioning, setActioning] = useState<string | null>(null);\r\n  const [localRequest, setLocalRequest] = useState<any | null>(null);\r\n  const [secondsLeft, setSecondsLeft] = useState<number>(() => typeof request?.ttl === 'number' ? request.ttl : 20);\r\n  const timerRef = useRef<number | null>(null);\r\n  \r\n\r\n  const readQueue = () => {\r\n    try {\r\n      const raw = localStorage.getItem('driver_incoming_queue');\r\n      if (!raw) return [];\r\n      return JSON.parse(raw);\r\n    } catch (e) { return []; }\r\n  };\r\n  // writeQueue not required here; manipulation is done inline where needed\r\n\r\n  // If a `request` prop isn't provided, read the first queued incoming request from localStorage\r\n  useEffect(() => {\r\n    if (request) {\r\n      setLocalRequest(request);\r\n      setSecondsLeft(typeof request.ttl === 'number' ? request.ttl : 20);\r\n      return;\r\n    }\r\n    const q = readQueue();\r\n    const first = q && q.length > 0 ? q[0] : null;\r\n    setLocalRequest(first);\r\n    setSecondsLeft(first && typeof first.ttl === 'number' ? first.ttl : 20);\r\n\r\n    const storageHandler = (e: StorageEvent) => {\r\n      if (e.key === 'driver_incoming_queue') {\r\n        const q2 = readQueue();\r\n        const f2 = q2 && q2.length > 0 ? q2[0] : null;\r\n        setLocalRequest(f2);\r\n        setSecondsLeft(f2 && typeof f2.ttl === 'number' ? f2.ttl : 20);\r\n      }\r\n    };\r\n    window.addEventListener('storage', storageHandler as any);\r\n    return () => window.removeEventListener('storage', storageHandler as any);\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [request]);\r\n\r\n  const cur = request ?? localRequest;\r\n  const id = cur?.id ?? 'req-1';\r\n  const pickup = cur?.pickup ?? 'Kariakoo';\r\n  const dropoff = cur?.dropoff ?? 'Mbezi';\r\n  const fare = cur?.fare ?? '3,500 TZS';\r\n\r\n  useEffect(() => {\r\n    // start countdown\r\n    if (timerRef.current) {\r\n      window.clearInterval(timerRef.current as any);\r\n      timerRef.current = null;\r\n    }\r\n    setSecondsLeft(typeof request?.ttl === 'number' ? request.ttl : 20);\r\n    timerRef.current = window.setInterval(() => {\r\n      setSecondsLeft((s) => s - 1);\r\n    }, 1000);\r\n    return () => {\r\n      if (timerRef.current) {\r\n        window.clearInterval(timerRef.current as any);\r\n        timerRef.current = null;\r\n      }\r\n    };\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [id]);\r\n\r\n  useEffect(() => {\r\n    if (secondsLeft <= 0) {\r\n      // auto-decline\r\n      try {\r\n        window.dispatchEvent(new CustomEvent('nols:driver:decline', { detail: { id, pickup, dropoff, fare } }));\r\n        window.dispatchEvent(new CustomEvent('nols:toast', { detail: { type: 'info', title: 'Auto-declined', message: 'The request expired and was declined automatically.', duration: 4000 } }));\r\n      } catch (e) {}\r\n      if (timerRef.current) {\r\n        window.clearInterval(timerRef.current as any);\r\n        timerRef.current = null;\r\n      }\r\n      setActioning(null);\r\n      // remove from local queue and add to recent\r\n      try {\r\n        const raw = localStorage.getItem('driver_incoming_queue');\r\n        if (raw) {\r\n          const q = JSON.parse(raw).filter((r: any) => r.id !== id);\r\n          localStorage.setItem('driver_incoming_queue', JSON.stringify(q));\r\n        }\r\n        const recRaw = localStorage.getItem('driver_recent_requests');\r\n        const rec = recRaw ? JSON.parse(recRaw) : [];\r\n        rec.unshift({ id, pickup, dropoff, fare, action: 'auto-declined', at: Date.now() });\r\n        localStorage.setItem('driver_recent_requests', JSON.stringify(rec.slice(0,50)));\r\n      } catch (e) {}\r\n    }\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [secondsLeft]);\r\n\r\n  const accept = async () => {\r\n    if (actioning) return;\r\n    setActioning('accept');\r\n    try {\r\n      // notify other parts of the app (server integration can listen for this)\r\n      window.dispatchEvent(new CustomEvent('nols:driver:accept', { detail: { id, pickup, dropoff, fare } }));\r\n      window.dispatchEvent(new CustomEvent('nols:toast', { detail: { type: 'success', title: 'Accepted', message: 'You accepted the incoming request.', duration: 4000 } }));\r\n      // brief delay to simulate network\r\n      await new Promise((r) => setTimeout(r, 800));\r\n    } catch (e) {\r\n      window.dispatchEvent(new CustomEvent('nols:toast', { detail: { type: 'error', title: 'Error', message: 'Failed to accept. Try again.', duration: 5000 } }));\r\n    } finally {\r\n      setActioning(null);\r\n      if (timerRef.current) {\r\n        window.clearInterval(timerRef.current as any);\r\n        timerRef.current = null;\r\n      }\r\n      // remove from local queue if present\r\n      try {\r\n        const raw = localStorage.getItem('driver_incoming_queue');\r\n        if (raw) {\r\n          const q = JSON.parse(raw).filter((r: any) => r.id !== id);\r\n          localStorage.setItem('driver_incoming_queue', JSON.stringify(q));\r\n        }\r\n      } catch (e) {}\r\n    }\r\n  };\r\n\r\n  const decline = async () => {\r\n    if (actioning) return;\r\n    setActioning('decline');\r\n    try {\r\n      window.dispatchEvent(new CustomEvent('nols:driver:decline', { detail: { id, pickup, dropoff, fare } }));\r\n      window.dispatchEvent(new CustomEvent('nols:toast', { detail: { type: 'info', title: 'Declined', message: 'You declined the incoming request.', duration: 4000 } }));\r\n      await new Promise((r) => setTimeout(r, 600));\r\n    } catch (e) {\r\n      window.dispatchEvent(new CustomEvent('nols:toast', { detail: { type: 'error', title: 'Error', message: 'Failed to decline. Try again.', duration: 5000 } }));\r\n    } finally {\r\n      setActioning(null);\r\n      if (timerRef.current) {\r\n        window.clearInterval(timerRef.current as any);\r\n        timerRef.current = null;\r\n      }\r\n      // remove from local queue if present and add to recent\r\n      try {\r\n        const raw = localStorage.getItem('driver_incoming_queue');\r\n        if (raw) {\r\n          const q = JSON.parse(raw).filter((r: any) => r.id !== id);\r\n          localStorage.setItem('driver_incoming_queue', JSON.stringify(q));\r\n          // add to recent\r\n          const recRaw = localStorage.getItem('driver_recent_requests');\r\n          const rec = recRaw ? JSON.parse(recRaw) : [];\r\n          rec.unshift({ id, pickup, dropoff, fare, action: 'declined', at: Date.now() });\r\n          localStorage.setItem('driver_recent_requests', JSON.stringify(rec.slice(0,50)));\r\n        }\r\n      } catch (e) {}\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div className=\"mx-auto max-w-3xl bg-white rounded-lg p-4 border shadow-sm\">\r\n      <div className=\"flex flex-col md:flex-row md:items-center md:justify-between gap-3\">\r\n        {/* Left: incoming button (moved from details area) */}\r\n        <div className=\"flex-shrink-0 md:w-28 flex items-center justify-center\">\r\n          <IncomingRequestsButton />\r\n        </div>\r\n\r\n        {/* Right: controls and countdown */}\r\n        <div className=\"flex-1 flex items-center justify-end gap-3\">\r\n          {secondsLeft > 0 && (\r\n            <div className=\"text-xs text-gray-600 mr-2\">{`${secondsLeft}s to accept`}</div>\r\n          )}\r\n\r\n          {/* Slide-to-act control: drag knob right to accept (green), left to decline (red) */}\r\n          <div className=\"relative w-72 h-12\">\r\n            {/* Left decline area */}\r\n            <div className=\"absolute left-0 top-0 bottom-0 w-1/4 flex items-center justify-start pl-3\">\r\n              <div className=\"flex items-center gap-2\">\r\n                  <div className=\"w-8 h-8 rounded-full bg-red-100 flex items-center justify-center\">\r\n                  <ArrowLeft className=\"w-4 h-4 text-red-600 animate-pulse\" />\r\n                </div>\r\n              </div>\r\n            </div>\r\n\r\n            {/* Right accept area */}\r\n            <div className=\"absolute right-0 top-0 bottom-0 w-1/4 flex items-center justify-end pr-3\">\r\n              <div className=\"flex items-center gap-2\">\r\n                <div className=\"w-8 h-8 rounded-full bg-green-100 flex items-center justify-center\">\r\n                  <ArrowRight className=\"w-4 h-4 text-green-600 animate-pulse\" />\r\n                </div>\r\n              </div>\r\n            </div>\r\n\r\n            {/* Track with three visual zones: decline (left/red), neutral (center/blue), accept (right/green) */}\r\n            <div className=\"absolute left-0 right-0 top-0 bottom-0 rounded-full border overflow-hidden\">\r\n              {/* Left (decline) */}\r\n              <div className=\"absolute left-0 top-0 bottom-0 w-1/4 bg-red-100 pointer-events-none\" />\r\n              {/* Center (neutral) */}\r\n              <div className=\"absolute left-1/4 top-0 bottom-0 right-1/4 bg-blue-100 pointer-events-none\" />\r\n              {/* Right (accept) */}\r\n              <div className=\"absolute right-0 top-0 bottom-0 w-1/4 bg-green-100 pointer-events-none\" />\r\n\r\n              {/* Draggable knob (arrow inside). Knob color changes based on drag direction: center=blue, right=green, left=red */}\r\n              <div\r\n                aria-label=\"Slide to accept or decline\"\r\n                tabIndex={0}\r\n                onKeyDown={(e) => {\r\n                  if (e.key === 'ArrowRight') accept();\r\n                  if (e.key === 'ArrowLeft') decline();\r\n                }}\r\n                onPointerDown={(e) => {\r\n                  const knob = e.currentTarget as HTMLElement;\r\n                  try { (knob as Element).setPointerCapture(e.pointerId); } catch (err) {}\r\n                  (knob as any)._dragStartX = e.clientX;\r\n                  (knob as any)._dragging = true;\r\n                  // reset vibrate flag: 0 = none, 1 = accept vibrated, -1 = decline vibrated\r\n                  (knob as any)._vibrated = 0;\r\n                  // ensure center color when starting\r\n                  knob.classList.remove('bg-white','bg-red-500','bg-green-500');\r\n                  knob.classList.add('bg-sky-600','text-white');\r\n                }}\r\n                onPointerMove={(e) => {\r\n                  const knob = e.currentTarget as HTMLElement;\r\n                  if (!(knob as any)._dragging) return;\r\n                  const startX = (knob as any)._dragStartX as number;\r\n                  const dx = e.clientX - startX;\r\n                  const max = 96; // px threshold cap for movement\r\n                  const limited = Math.max(Math.min(dx, max), -max);\r\n                  // move knob by manipulating style.transform directly\r\n                  knob.style.transform = `translateX(${limited}px)`;\r\n                  // update knob color depending on distance\r\n                  if (limited >= 30) {\r\n                    knob.classList.remove('bg-sky-600','bg-red-500');\r\n                    knob.classList.add('bg-green-500','text-white');\r\n                  } else if (limited <= -30) {\r\n                    knob.classList.remove('bg-sky-600','bg-green-500');\r\n                    knob.classList.add('bg-red-500','text-white');\r\n                  } else {\r\n                    knob.classList.remove('bg-red-500','bg-green-500');\r\n                    knob.classList.add('bg-sky-600','text-white');\r\n                  }\r\n                  // haptic: vibrate once when crossing trigger threshold (72px)\r\n                  const vibThreshold = 72;\r\n                  try {\r\n                    if (limited >= vibThreshold && (knob as any)._vibrated !== 1) {\r\n                      (navigator as any).vibrate && (navigator as any).vibrate(40);\r\n                      (knob as any)._vibrated = 1;\r\n                    } else if (limited <= -vibThreshold && (knob as any)._vibrated !== -1) {\r\n                      (navigator as any).vibrate && (navigator as any).vibrate(40);\r\n                      (knob as any)._vibrated = -1;\r\n                    } else if (limited > -vibThreshold && limited < vibThreshold) {\r\n                      // reset vibrate flag when back to center\r\n                      (knob as any)._vibrated = 0;\r\n                    }\r\n                  } catch (err) {}\r\n                }}\r\n                onPointerUp={(e) => {\r\n                  const knob = e.currentTarget as HTMLElement;\r\n                  try { (knob as Element).releasePointerCapture(e.pointerId); } catch (err) {}\r\n                  const startX = (knob as any)._dragStartX as number;\r\n                  const dx = e.clientX - startX;\r\n                  const threshold = 72; // px\r\n                  if (dx >= threshold) {\r\n                    accept();\r\n                  } else if (dx <= -threshold) {\r\n                    decline();\r\n                  }\r\n                  // reset visual position and color to center\r\n                  knob.style.transition = 'transform 180ms ease';\r\n                  knob.style.transform = 'translateX(0px)';\r\n                  knob.classList.remove('bg-red-500','bg-green-500');\r\n                  knob.classList.add('bg-sky-600','text-white');\r\n                  setTimeout(() => { knob.style.transition = ''; }, 200);\r\n                  (knob as any)._dragging = false;\r\n                  (knob as any)._vibrated = 0;\r\n                }}\r\n                className={`absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-14 h-10 bg-sky-600 rounded-full shadow flex items-center justify-center cursor-grab select-none touch-action-none`}\r\n              >\r\n                {/* constant arrow icon inside knob */}\r\n                <ArrowRight className=\"w-4 h-4 text-white\" />\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          {/* Hidden fallback buttons for accessibility (screen readers/keyboard) */}\r\n          <div className=\"sr-only\">\r\n            <button onClick={accept}>Accept</button>\r\n            <button onClick={decline}>Decline</button>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\IncomingRequestsButton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\LanguagePicker.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\LatestUpdate.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'ImageIcon' is defined but never used. Allowed unused vars must match /^_/u.","line":5,"column":54,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":63,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"ImageIcon"},"fix":{"range":[143,163],"text":""},"desc":"Remove unused variable \"ImageIcon\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'isYouTubeEmbedUrl' is defined but never used. Allowed unused vars must match /^_/u.","line":33,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":33,"endColumn":27}],"suppressedMessages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":189,"column":29,"nodeType":"JSXOpeningElement","endLine":204,"endColumn":31,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":215,"column":33,"nodeType":"JSXOpeningElement","endLine":221,"endColumn":35,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport React, { useEffect, useState } from 'react';\r\nimport Link from 'next/link';\r\nimport { ExternalLink, Megaphone, Calendar, Image as ImageIcon, Video, Play } from 'lucide-react';\r\nimport axios from 'axios';\r\nimport LogoSpinner from \"@/components/LogoSpinner\";\r\n\r\ninterface Update {\r\n  id: string;\r\n  title: string;\r\n  content: string;\r\n  images?: string[];\r\n  videos?: string[];\r\n  createdAt: string;\r\n  updatedAt: string;\r\n}\r\n\r\nfunction isSafeMediaUrl(url: string): boolean {\r\n  const trimmed = url.trim();\r\n  if (!trimmed) return false;\r\n  if (trimmed.startsWith('/')) return true;\r\n  // Allow data URLs used by current in-memory updates implementation.\r\n  if (trimmed.startsWith('data:image/')) return true;\r\n  try {\r\n    const parsed = new URL(trimmed);\r\n    return parsed.protocol === 'http:' || parsed.protocol === 'https:';\r\n  } catch {\r\n    return false;\r\n  }\r\n}\r\n\r\nfunction isYouTubeEmbedUrl(url: string): boolean {\r\n  const trimmed = url.trim();\r\n  if (!trimmed) return false;\r\n  // Admin updates UI stores YouTube embed URLs.\r\n  return (\r\n    trimmed.startsWith('https://www.youtube.com/embed/') ||\r\n    trimmed.startsWith('https://www.youtube-nocookie.com/embed/')\r\n  );\r\n}\r\n\r\nfunction getYouTubeId(url: string): string | null {\r\n  const trimmed = url.trim();\r\n  if (!trimmed) return null;\r\n  try {\r\n    const parsed = new URL(trimmed);\r\n    const host = parsed.hostname.replace(/^www\\./, '');\r\n\r\n    // https://youtu.be/<id>\r\n    if (host === 'youtu.be') {\r\n      const id = parsed.pathname.split('/').filter(Boolean)[0];\r\n      return id || null;\r\n    }\r\n\r\n    // https://youtube.com/embed/<id> or /shorts/<id>\r\n    if (host === 'youtube.com' || host === 'm.youtube.com' || host === 'youtube-nocookie.com') {\r\n      const parts = parsed.pathname.split('/').filter(Boolean);\r\n      const head = parts[0];\r\n      const maybeId = parts[1];\r\n\r\n      if (head === 'embed' && maybeId) return maybeId;\r\n      if (head === 'shorts' && maybeId) return maybeId;\r\n\r\n      // https://youtube.com/watch?v=<id>\r\n      const v = parsed.searchParams.get('v');\r\n      if (v) return v;\r\n    }\r\n\r\n    return null;\r\n  } catch {\r\n    // Some updates might store a non-URL string; ignore.\r\n    return null;\r\n  }\r\n}\r\n\r\nfunction getYouTubeThumbnailUrl(videoId: string): string {\r\n  return `https://i.ytimg.com/vi/${videoId}/hqdefault.jpg`;\r\n}\r\n\r\nexport default function LatestUpdate({ hideTitle = false }: { hideTitle?: boolean }) {\r\n  const [updates, setUpdates] = useState<Update[]>([]);\r\n  const [loading, setLoading] = useState(true);\r\n\r\n  useEffect(() => {\r\n    async function loadUpdates() {\r\n      try {\r\n        const api = axios.create({ baseURL: \"\" });\r\n        const res = await api.get<{ items: Update[] }>(\"/api/public/updates\");\r\n        setUpdates(res.data?.items || []);\r\n      } catch (err) {\r\n        console.error(\"Failed to load updates:\", err);\r\n      } finally {\r\n        setLoading(false);\r\n      }\r\n    }\r\n    loadUpdates();\r\n  }, []);\r\n\r\n  const formatDate = (dateString: string) => {\r\n    return new Date(dateString).toLocaleDateString(\"en-US\", {\r\n      year: \"numeric\",\r\n      month: \"short\",\r\n      day: \"numeric\",\r\n    });\r\n  };\r\n\r\n  if (loading) {\r\n    return (\r\n      <aside className=\"mt-6\">\r\n        <div className=\"public-container\">\r\n          <div className=\"flex items-center justify-center py-12\">\r\n            <LogoSpinner size=\"sm\" ariaLabel=\"Loading updates\" />\r\n          </div>\r\n        </div>\r\n      </aside>\r\n    );\r\n  }\r\n\r\n  if (updates.length === 0) {\r\n    return (\r\n      <aside className=\"mt-6\">\r\n        <div className=\"public-container\">\r\n          {hideTitle ? null : (\r\n            <div className=\"mb-4 flex items-center gap-2\">\r\n              <Megaphone className=\"w-5 h-5 text-emerald-700\" />\r\n              <h2 className=\"text-xl font-bold text-slate-900\">Latest Updates</h2>\r\n            </div>\r\n          )}\r\n          <div className=\"rounded-lg border border-slate-200 bg-white p-5 shadow-sm\">\r\n            <p className=\"text-sm text-slate-700 font-medium\">No updates yet.</p>\r\n            <p className=\"text-xs text-slate-500 mt-1\">\r\n              Check back soon — we’ll post announcements here.\r\n            </p>\r\n          </div>\r\n        </div>\r\n      </aside>\r\n    );\r\n  }\r\n\r\n  // Display latest 3 updates\r\n  const latestUpdates = updates.slice(0, 3);\r\n\r\n  return (\r\n    <aside className=\"mt-6\">\r\n      <div className=\"public-container\">\r\n        {hideTitle ? null : (\r\n          <div className=\"mb-4 flex items-center gap-2\">\r\n            <Megaphone className=\"w-5 h-5 text-emerald-700\" />\r\n            <h2 className=\"text-xl font-bold text-slate-900\">Latest Updates</h2>\r\n          </div>\r\n        )}\r\n        <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4\">\r\n          {latestUpdates.map((update) => {\r\n            const safeImages = (update.images || []).filter((img) => typeof img === 'string' && isSafeMediaUrl(img));\r\n            const youTubeUrl = (update.videos || []).find((v) => typeof v === 'string' && getYouTubeId(v) !== null);\r\n            const youTubeId = youTubeUrl ? getYouTubeId(youTubeUrl) : null;\r\n            const youTubeThumb = youTubeId ? getYouTubeThumbnailUrl(youTubeId) : null;\r\n            const hasAnyVideo = (update.videos || []).length > 0;\r\n\r\n            const mediaType: 'youtube' | 'image' | 'video' | 'none' =\r\n              youTubeThumb ? 'youtube' : safeImages.length ? 'image' : hasAnyVideo ? 'video' : 'none';\r\n\r\n            const mediaSrc = mediaType === 'youtube' ? youTubeThumb : mediaType === 'image' ? safeImages[0] : null;\r\n            const overlayLogoSrc = mediaType === 'youtube' && safeImages.length ? safeImages[0] : null;\r\n            const extraMediaCount =\r\n              mediaType === 'youtube'\r\n                ? Math.max(0, (update.videos?.length || 0) - 1)\r\n                : mediaType === 'image'\r\n                  ? Math.max(0, safeImages.length - 1)\r\n                  : 0;\r\n\r\n            return (\r\n            <Link\r\n              key={update.id}\r\n              href=\"/updates\"\r\n              className=\"group block no-underline focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-emerald-200\"\r\n            >\r\n              <div className=\"relative overflow-hidden rounded-3xl bg-gradient-to-br from-slate-200/70 via-white/60 to-emerald-200/40 p-[1px] shadow-sm will-change-transform motion-safe:transition-all motion-safe:duration-300 group-hover:-translate-y-0.5 group-hover:shadow-md\">\r\n                <div className=\"rounded-3xl border border-white/50 bg-white/70 p-3 backdrop-blur-xl\">\r\n                  <div className=\"flex gap-3\">\r\n                    {mediaType !== 'none' ? (\r\n                      <div className=\"relative shrink-0\">\r\n                        <div className=\"relative h-20 w-32 overflow-hidden rounded-2xl border border-white/50 bg-slate-50\">\r\n                          {mediaSrc ? (\r\n                            // Using <img> intentionally because update media can be data URLs\r\n                            // and may include remote URLs without prior Next image config.\r\n                            // eslint-disable-next-line @next/next/no-img-element\r\n                            <img\r\n                              src={mediaSrc}\r\n                              alt={\r\n                                mediaType === 'youtube'\r\n                                  ? `${update.title} video thumbnail`\r\n                                  : `${update.title} image`\r\n                              }\r\n                              className={\r\n                                mediaType === 'youtube'\r\n                                  ? 'h-full w-full object-cover'\r\n                                  : 'h-full w-full object-contain bg-white'\r\n                              }\r\n                              loading=\"lazy\"\r\n                              decoding=\"async\"\r\n                              referrerPolicy={mediaType === 'youtube' ? 'no-referrer' : undefined}\r\n                            />\r\n                          ) : (\r\n                            <div className=\"flex h-full w-full items-center justify-center text-slate-500\">\r\n                              <Video className=\"h-5 w-5\" />\r\n                            </div>\r\n                          )}\r\n\r\n                          {overlayLogoSrc ? (\r\n                            <div className=\"absolute left-2 top-2\">\r\n                              <span className=\"inline-flex items-center rounded-xl border border-white/70 bg-white/80 p-1 shadow-sm\">\r\n                                {/* eslint-disable-next-line @next/next/no-img-element */}\r\n                                <img\r\n                                  src={overlayLogoSrc}\r\n                                  alt={`${update.title} logo`}\r\n                                  className=\"h-6 w-6 object-contain\"\r\n                                  loading=\"lazy\"\r\n                                  decoding=\"async\"\r\n                                />\r\n                              </span>\r\n                            </div>\r\n                          ) : null}\r\n\r\n                          {hasAnyVideo ? (\r\n                            <div className=\"absolute inset-0 grid place-items-center\">\r\n                              <span className=\"inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-200 bg-white/90 shadow-sm\">\r\n                                <Play className=\"h-4 w-4 text-emerald-700\" />\r\n                              </span>\r\n                            </div>\r\n                          ) : null}\r\n\r\n                          {extraMediaCount > 0 ? (\r\n                            <div className=\"absolute right-2 top-2\">\r\n                              <span className=\"inline-flex items-center rounded-full border border-white/60 bg-white/80 px-2 py-0.5 text-[11px] font-semibold text-slate-700 shadow-sm\">\r\n                                +{extraMediaCount}\r\n                              </span>\r\n                            </div>\r\n                          ) : null}\r\n                        </div>\r\n                      </div>\r\n                    ) : null}\r\n\r\n                    <div className=\"min-w-0 flex-1\">\r\n                      <div className=\"flex items-center gap-2 text-[11px] font-medium text-slate-500\">\r\n                        <Calendar className=\"h-3 w-3\" />\r\n                        <span>{formatDate(update.createdAt)}</span>\r\n                        {hasAnyVideo ? (\r\n                          <span className=\"ml-auto inline-flex items-center gap-1 rounded-full border border-white/60 bg-white/70 px-2 py-0.5 text-[11px] font-semibold text-slate-700\">\r\n                            <Video className=\"h-3 w-3\" />\r\n                            <span>Video</span>\r\n                          </span>\r\n                        ) : null}\r\n                      </div>\r\n\r\n                      <h4 className=\"mt-2 text-[15px] font-bold leading-snug text-slate-900 line-clamp-2\">\r\n                        {update.title}\r\n                      </h4>\r\n\r\n                      <p className=\"mt-1 text-sm leading-relaxed text-slate-600 line-clamp-2\">\r\n                        {update.content}\r\n                      </p>\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            </Link>\r\n          );\r\n          })}\r\n        </div>\r\n        \r\n        {updates.length > 0 && (\r\n          <div className=\"mt-4 text-center\">\r\n            <Link\r\n              href=\"/updates\"\r\n              className=\"inline-flex items-center text-sm font-medium text-emerald-700 no-underline group hover:underline\"\r\n            >\r\n              <span>View all updates</span>\r\n              <ExternalLink className=\"w-4 h-4 ml-1 motion-safe:transition-transform motion-safe:duration-300 group-hover:translate-x-0.5\" />\r\n            </Link>\r\n          </div>\r\n        )}\r\n      </div>\r\n    </aside>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\LayoutFrame.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\LegalModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\LiveMap.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\LoadingSpinner.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\LogoSpinner.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\MarkReadButton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\MiniAnalyticsNav.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\NearbyServices.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Icon' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":88,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":88,"endColumn":21}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState } from \"react\";\r\nimport {\r\n  MapPin,\r\n  Hospital,\r\n  Fuel,\r\n  Plane,\r\n  Bus,\r\n  Route,\r\n  Shield,\r\n  Link as LinkIcon,\r\n  ChevronDown,\r\n  ChevronUp,\r\n  Car,\r\n  Bike,\r\n  FootprintsIcon,\r\n} from \"lucide-react\";\r\nimport type { ComponentType } from \"react\";\r\n\r\n// Transport method to icon mapping\r\nfunction getTransportIcon(mode: string): ComponentType<{ className?: string }> | null {\r\n  const modeLower = mode.toLowerCase();\r\n  if (modeLower.includes('walk') || modeLower === 'walking') return FootprintsIcon;\r\n  if (modeLower.includes('car') || modeLower.includes('taxi')) return Car;\r\n  if (modeLower.includes('boda') || modeLower.includes('motorcycle') || modeLower.includes('bike')) return Bike;\r\n  if (modeLower.includes('public') || modeLower.includes('bus') || modeLower.includes('transport')) return Bus;\r\n  return null;\r\n}\r\n\r\n// Get facility icon based on type\r\nfunction getFacilityIcon(type: string) {\r\n  const t = (type || \"\").toLowerCase();\r\n  if (t.includes(\"hospital\") || t.includes(\"clinic\") || t.includes(\"pharmacy\") || t.includes(\"polyclinic\")) {\r\n    return { Icon: Hospital, color: \"text-rose-600\" };\r\n  }\r\n  if (t.includes(\"petrol\") || t.includes(\"fuel\") || t.includes(\"gas\")) {\r\n    return { Icon: Fuel, color: \"text-orange-600\" };\r\n  }\r\n  if (t.includes(\"airport\")) {\r\n    return { Icon: Plane, color: \"text-blue-600\" };\r\n  }\r\n  if (t.includes(\"bus\") || t.includes(\"station\")) {\r\n    return { Icon: Bus, color: \"text-amber-700\" };\r\n  }\r\n  if (t.includes(\"road\") || t.includes(\"main road\")) {\r\n    return { Icon: Route, color: \"text-slate-700\" };\r\n  }\r\n  if (t.includes(\"police\")) {\r\n    return { Icon: Shield, color: \"text-indigo-600\" };\r\n  }\r\n  return { Icon: MapPin, color: \"text-[#02665e]\" };\r\n}\r\n\r\ntype NearbyServicesProps = {\r\n  facilities: any[];\r\n  defaultExpanded?: boolean;\r\n  showExpandButton?: boolean;\r\n  maxInitialDisplay?: number;\r\n};\r\n\r\nexport default function NearbyServices({\r\n  facilities,\r\n  defaultExpanded = false,\r\n  showExpandButton = true,\r\n  maxInitialDisplay = 2,\r\n}: NearbyServicesProps) {\r\n  const [expanded, setExpanded] = useState(defaultExpanded);\r\n\r\n  if (!facilities || facilities.length === 0) {\r\n    return null;\r\n  }\r\n\r\n  const displayedFacilities = expanded ? facilities : facilities.slice(0, maxInitialDisplay);\r\n  const hasMore = facilities.length > maxInitialDisplay;\r\n\r\n  return (\r\n    <div className=\"rounded-2xl border border-slate-200 bg-white p-5 sm:p-6\">\r\n      <div className=\"flex items-center gap-2 mb-4 sm:mb-6\">\r\n        <span className=\"inline-flex h-9 w-9 items-center justify-center rounded-xl bg-[#02665e]/10 text-[#02665e]\">\r\n          <MapPin className=\"w-5 h-5\" aria-hidden />\r\n        </span>\r\n        <h2 className=\"text-lg sm:text-xl font-semibold text-slate-900\">Nearby Services</h2>\r\n      </div>\r\n      <div className=\"grid grid-cols-1 md:grid-cols-2 gap-2.5 sm:gap-3\">\r\n        {displayedFacilities.map((facility: any, idx: number) => {\r\n          const facilityIcon = getFacilityIcon(facility.type || \"\");\r\n          const Icon = facilityIcon.Icon;\r\n\r\n          return (\r\n            <div\r\n              key={idx}\r\n              className=\"group relative rounded-lg sm:rounded-xl border border-slate-200 bg-gradient-to-br from-white to-slate-50/30 p-3 sm:p-4 hover:border-[#02665e]/40 hover:shadow-md motion-safe:transition-all motion-safe:duration-200\"\r\n            >\r\n              {/* Facility Name and Type */}\r\n              <div className=\"flex items-start justify-between gap-2 sm:gap-3 mb-2 sm:mb-3\">\r\n                <div className=\"flex-1 min-w-0 pr-1\">\r\n                  {facility.name && (\r\n                    <h3 className=\"text-sm sm:text-base font-semibold text-slate-900 mb-1 sm:mb-1.5 leading-tight line-clamp-2 sm:line-clamp-1\">\r\n                      {facility.name}\r\n                    </h3>\r\n                  )}\r\n                  <div className=\"flex items-center gap-1.5 sm:gap-2 flex-wrap\">\r\n                    {facility.type && (\r\n                      <span className=\"inline-flex items-center px-1.5 sm:px-2 py-0.5 rounded text-[9px] sm:text-[10px] font-medium bg-[#02665e]/10 text-[#02665e] border border-[#02665e]/20\">\r\n                        {facility.type}\r\n                      </span>\r\n                    )}\r\n                    {facility.ownership && (\r\n                      <span className=\"inline-flex items-center px-1.5 sm:px-2 py-0.5 rounded text-[9px] sm:text-[10px] font-medium bg-slate-100 text-slate-600 border border-slate-200\">\r\n                        {facility.ownership}\r\n                      </span>\r\n                    )}\r\n                  </div>\r\n                </div>\r\n                {facility.url && (\r\n                  <a\r\n                    href={facility.url}\r\n                    target=\"_blank\"\r\n                    rel=\"noopener noreferrer\"\r\n                    className=\"flex-shrink-0 inline-flex items-center justify-center w-7 h-7 sm:w-8 sm:h-8 rounded-lg text-[#02665e] bg-[#02665e]/5 hover:bg-[#02665e]/10 border border-[#02665e]/20 motion-safe:transition-colors\"\r\n                    title=\"Visit website\"\r\n                  >\r\n                    <LinkIcon className=\"h-3.5 w-3.5 sm:h-4 sm:w-4\" />\r\n                  </a>\r\n                )}\r\n              </div>\r\n\r\n              {/* Distance and Transport - Single Row */}\r\n              <div className=\"flex items-center justify-between gap-2 sm:gap-3 pt-2 sm:pt-3 border-t border-slate-100\">\r\n                {typeof facility.distanceKm === 'number' && (\r\n                  <div className=\"flex items-center gap-1 sm:gap-1.5 text-xs sm:text-sm font-medium text-rose-600\">\r\n                    <MapPin className=\"h-3.5 w-3.5 sm:h-4 sm:w-4 flex-shrink-0\" />\r\n                    <span className=\"whitespace-nowrap\">{facility.distanceKm} km</span>\r\n                  </div>\r\n                )}\r\n                {Array.isArray(facility.reachableBy) && facility.reachableBy.length > 0 && (\r\n                  <div className=\"flex items-center gap-1 sm:gap-1.5 flex-wrap ml-auto\">\r\n                    {facility.reachableBy.map((mode: string, mIdx: number) => {\r\n                      const TransportIcon = getTransportIcon(mode);\r\n\r\n                      // All transport methods show as icons (including Public Transport)\r\n                      return (\r\n                        <span\r\n                          key={mIdx}\r\n                          className=\"inline-flex items-center justify-center w-5 h-5 sm:w-6 sm:h-6 rounded-md bg-emerald-50 text-emerald-700 border border-emerald-200/60 hover:bg-emerald-100 motion-safe:transition-colors flex-shrink-0\"\r\n                          title={mode}\r\n                          aria-label={mode}\r\n                        >\r\n                          {TransportIcon ? (\r\n                            <TransportIcon className=\"h-3 w-3 sm:h-3.5 sm:w-3.5\" />\r\n                          ) : (\r\n                            <span className=\"text-[8px] sm:text-[9px] font-medium\">{mode.charAt(0)}</span>\r\n                          )}\r\n                        </span>\r\n                      );\r\n                    })}\r\n                  </div>\r\n                )}\r\n              </div>\r\n            </div>\r\n          );\r\n        })}\r\n      </div>\r\n      {hasMore && showExpandButton && (\r\n        <div className=\"mt-2.5 sm:mt-3 flex justify-center\">\r\n          <button\r\n            type=\"button\"\r\n            onClick={() => setExpanded(!expanded)}\r\n            className=\"inline-flex items-center gap-1 px-2.5 py-1 text-[10px] sm:text-xs font-medium text-[#02665e] bg-transparent hover:bg-[#02665e]/5 border-0 rounded-md motion-safe:transition-colors\"\r\n          >\r\n            {expanded ? (\r\n              <>\r\n                <span>Show less</span>\r\n                <ChevronUp className=\"h-3 w-3\" />\r\n              </>\r\n            ) : (\r\n              <>\r\n                <span className=\"whitespace-nowrap\">Show more ({facilities.length - maxInitialDisplay})</span>\r\n                <ChevronDown className=\"h-3 w-3\" />\r\n              </>\r\n            )}\r\n          </button>\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\NeighborhoodGuide.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\Notifications.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\OwnerFooter.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\OwnerPageHeader.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\OwnerSidebar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\OwnerSiteHeader.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\PDFViewer.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\PaymentMethodModal.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'CreditCard' is defined but never used. Allowed unused vars must match /^_/u.","line":3,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":23,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"CreditCard"},"fix":{"range":[71,83],"text":""},"desc":"Remove unused variable \"CreditCard\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'invoiceId' is defined but never used. Allowed unused args must match /^_|^(e|err)$/u.","line":65,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":65,"endColumn":12},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'setLoading' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":73,"column":19,"nodeType":"Identifier","messageId":"unusedVar","endLine":73,"endColumn":29}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\nimport { useState, useEffect } from \"react\";\r\nimport { X, CreditCard, Smartphone, Wallet, Check } from \"lucide-react\";\r\nimport axios from \"axios\";\r\n\r\nconst api = axios.create({ baseURL: \"\", withCredentials: true });\r\n\r\ninterface PaymentMethodModalProps {\r\n  isOpen: boolean;\r\n  onClose: () => void;\r\n  onSelect: (method: {\r\n    provider: string;\r\n    phoneNumber: string;\r\n    providerName: string;\r\n  }) => void;\r\n  invoiceId?: number;\r\n  amount: number;\r\n  currency?: string;\r\n  defaultPhone?: string;\r\n}\r\n\r\ntype PaymentProvider = {\r\n  id: string;\r\n  name: string;\r\n  icon: any;\r\n  description: string;\r\n  supported: boolean;\r\n};\r\n\r\nconst PAYMENT_PROVIDERS: PaymentProvider[] = [\r\n  {\r\n    id: \"Airtel\",\r\n    name: \"Airtel Money\",\r\n    icon: Smartphone,\r\n    description: \"Pay using your Airtel Money account\",\r\n    supported: true,\r\n  },\r\n  {\r\n    id: \"Tigo\",\r\n    name: \"Tigo Pesa\",\r\n    icon: Wallet,\r\n    description: \"Pay using your Tigo Pesa account\",\r\n    supported: true,\r\n  },\r\n  {\r\n    id: \"M-Pesa\",\r\n    name: \"M-Pesa\",\r\n    icon: Smartphone,\r\n    description: \"Pay using your M-Pesa account\",\r\n    supported: true,\r\n  },\r\n  {\r\n    id: \"Halopesa\",\r\n    name: \"HaloPesa\",\r\n    icon: Wallet,\r\n    description: \"Pay using your HaloPesa account\",\r\n    supported: true,\r\n  },\r\n];\r\n\r\nexport default function PaymentMethodModal({\r\n  isOpen,\r\n  onClose,\r\n  onSelect,\r\n  invoiceId,\r\n  amount,\r\n  currency = \"TZS\",\r\n  defaultPhone,\r\n}: PaymentMethodModalProps) {\r\n  const [selectedProvider, setSelectedProvider] = useState<string>(\"\");\r\n  const [phoneNumber, setPhoneNumber] = useState<string>(defaultPhone || \"\");\r\n  const [savedPhones, setSavedPhones] = useState<string[]>([]);\r\n  const [loading, setLoading] = useState(false);\r\n  const [error, setError] = useState<string | null>(null);\r\n\r\n  async function loadSavedPhones() {\r\n    try {\r\n      const response = await api.get(\"/api/account/payment-methods\");\r\n\r\n      // Extract unique phone numbers from payment history\r\n      const phones = new Set<string>();\r\n      if (response.data?.methods) {\r\n        response.data.methods.forEach((method: any) => {\r\n          if (method.ref && /^\\+?255\\d{9}$/.test(method.ref.replace(/\\D/g, \"\"))) {\r\n            phones.add(method.ref);\r\n          }\r\n        });\r\n      }\r\n\r\n      // Also check user's profile phone\r\n      if (response.data?.payout?.mobileMoneyNumber) {\r\n        phones.add(response.data.payout.mobileMoneyNumber);\r\n      }\r\n\r\n      setSavedPhones(Array.from(phones));\r\n    } catch (err) {\r\n      // Silently fail - saved phones are optional\r\n      console.debug(\"Could not load saved phone numbers\", err);\r\n    }\r\n  }\r\n\r\n  useEffect(() => {\r\n    if (isOpen && defaultPhone) {\r\n      setPhoneNumber(defaultPhone);\r\n    }\r\n  }, [isOpen, defaultPhone]);\r\n\r\n  // Load saved phone numbers from user's payment history\r\n  useEffect(() => {\r\n    if (isOpen) {\r\n      loadSavedPhones();\r\n    }\r\n  }, [isOpen]);\r\n\r\n  const normalizePhone = (phone: string): string => {\r\n    // Remove all non-digit characters except +\r\n    let cleaned = phone.replace(/[^\\d+]/g, \"\");\r\n    \r\n    // Ensure it starts with country code\r\n    if (!cleaned.startsWith(\"+\")) {\r\n      if (cleaned.startsWith(\"255\")) {\r\n        cleaned = \"+\" + cleaned;\r\n      } else if (cleaned.startsWith(\"0\")) {\r\n        cleaned = \"+255\" + cleaned.substring(1);\r\n      } else {\r\n        cleaned = \"+255\" + cleaned;\r\n      }\r\n    }\r\n    \r\n    return cleaned;\r\n  };\r\n\r\n  const validatePhone = (phone: string): boolean => {\r\n    const normalized = normalizePhone(phone);\r\n    // Tanzania phone format: +255XXXXXXXXX (12 digits after +)\r\n    return /^\\+255\\d{9}$/.test(normalized);\r\n  };\r\n\r\n  const handleSubmit = (e: React.FormEvent) => {\r\n    e.preventDefault();\r\n    setError(null);\r\n\r\n    if (!selectedProvider) {\r\n      setError(\"Please select a payment provider\");\r\n      return;\r\n    }\r\n\r\n    if (!phoneNumber.trim()) {\r\n      setError(\"Please enter your phone number\");\r\n      return;\r\n    }\r\n\r\n    const normalized = normalizePhone(phoneNumber.trim());\r\n    if (!validatePhone(normalized)) {\r\n      setError(\"Please enter a valid Tanzania phone number (e.g., +255712345678 or 0712345678)\");\r\n      return;\r\n    }\r\n\r\n    const provider = PAYMENT_PROVIDERS.find((p) => p.id === selectedProvider);\r\n    if (!provider) {\r\n      setError(\"Invalid payment provider selected\");\r\n      return;\r\n    }\r\n\r\n    // Call onSelect callback with selected method\r\n    onSelect({\r\n      provider: selectedProvider,\r\n      phoneNumber: normalized,\r\n      providerName: provider.name,\r\n    });\r\n  };\r\n\r\n  if (!isOpen) return null;\r\n\r\n  return (\r\n    <div className=\"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50\">\r\n      <div className=\"bg-white rounded-xl shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto\">\r\n        {/* Header */}\r\n        <div className=\"flex items-center justify-between p-6 border-b border-slate-200\">\r\n          <div>\r\n            <h2 className=\"text-xl font-semibold text-slate-900\">Select Payment Method</h2>\r\n            <p className=\"text-sm text-slate-600 mt-1\">\r\n              Choose how you want to pay {amount.toLocaleString(\"en-US\")} {currency}\r\n            </p>\r\n          </div>\r\n          <button\r\n            onClick={onClose}\r\n            className=\"p-2 hover:bg-slate-100 rounded-lg transition-colors\"\r\n            aria-label=\"Close\"\r\n          >\r\n            <X className=\"w-5 h-5 text-slate-600\" />\r\n          </button>\r\n        </div>\r\n\r\n        {/* Content */}\r\n        <form onSubmit={handleSubmit} className=\"p-6 space-y-6\">\r\n          {/* Payment Providers */}\r\n          <div>\r\n            <label className=\"block text-sm font-medium text-slate-900 mb-3\">\r\n              Select Payment Provider\r\n            </label>\r\n            <div className=\"grid grid-cols-2 gap-3\">\r\n              {PAYMENT_PROVIDERS.map((provider) => {\r\n                const Icon = provider.icon;\r\n                const isSelected = selectedProvider === provider.id;\r\n                return (\r\n                  <button\r\n                    key={provider.id}\r\n                    type=\"button\"\r\n                    onClick={() => setSelectedProvider(provider.id)}\r\n                    className={`p-4 border-2 rounded-lg transition-all ${\r\n                      isSelected\r\n                        ? \"border-emerald-600 bg-emerald-50\"\r\n                        : \"border-slate-200 hover:border-slate-300 bg-white\"\r\n                    } ${!provider.supported ? \"opacity-50 cursor-not-allowed\" : \"cursor-pointer\"}`}\r\n                    disabled={!provider.supported}\r\n                  >\r\n                    <div className=\"flex items-center justify-between mb-2\">\r\n                      <Icon className={`w-5 h-5 ${isSelected ? \"text-emerald-600\" : \"text-slate-600\"}`} />\r\n                      {isSelected && <Check className=\"w-5 h-5 text-emerald-600\" />}\r\n                    </div>\r\n                    <div className=\"text-left\">\r\n                      <div className={`font-medium text-sm ${isSelected ? \"text-emerald-900\" : \"text-slate-900\"}`}>\r\n                        {provider.name}\r\n                      </div>\r\n                      <div className=\"text-xs text-slate-500 mt-1\">{provider.description}</div>\r\n                    </div>\r\n                  </button>\r\n                );\r\n              })}\r\n            </div>\r\n          </div>\r\n\r\n          {/* Phone Number Input */}\r\n          <div>\r\n            <label className=\"block text-sm font-medium text-slate-900 mb-2\">\r\n              Phone Number\r\n            </label>\r\n            <input\r\n              type=\"tel\"\r\n              value={phoneNumber}\r\n              onChange={(e) => setPhoneNumber(e.target.value)}\r\n              placeholder=\"+255712345678 or 0712345678\"\r\n              className=\"w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none transition-colors\"\r\n              required\r\n            />\r\n            <p className=\"text-xs text-slate-500 mt-1\">\r\n              Enter the phone number linked to your {selectedProvider ? PAYMENT_PROVIDERS.find(p => p.id === selectedProvider)?.name : \"mobile money\"} account\r\n            </p>\r\n\r\n            {/* Saved Phone Numbers */}\r\n            {savedPhones.length > 0 && (\r\n              <div className=\"mt-3\">\r\n                <p className=\"text-xs text-slate-600 mb-2\">Previously used:</p>\r\n                <div className=\"flex flex-wrap gap-2\">\r\n                  {savedPhones.slice(0, 3).map((phone, idx) => (\r\n                    <button\r\n                      key={idx}\r\n                      type=\"button\"\r\n                      onClick={() => setPhoneNumber(phone)}\r\n                      className=\"px-3 py-1.5 text-xs bg-slate-100 hover:bg-slate-200 rounded-lg transition-colors\"\r\n                    >\r\n                      {phone}\r\n                    </button>\r\n                  ))}\r\n                </div>\r\n              </div>\r\n            )}\r\n          </div>\r\n\r\n          {/* Error Message */}\r\n          {error && (\r\n            <div className=\"p-3 bg-red-50 border border-red-200 rounded-lg text-sm text-red-700\">\r\n              {error}\r\n            </div>\r\n          )}\r\n\r\n          {/* Info Note */}\r\n          <div className=\"p-4 bg-blue-50 border border-blue-200 rounded-lg\">\r\n            <p className=\"text-sm text-blue-800\">\r\n              <strong>Note:</strong> You can use different phone numbers for different bookings. \r\n              Each booking is processed independently with the payment method you select here.\r\n            </p>\r\n          </div>\r\n\r\n          {/* Actions */}\r\n          <div className=\"flex gap-3 pt-4 border-t border-slate-200\">\r\n            <button\r\n              type=\"button\"\r\n              onClick={onClose}\r\n              className=\"flex-1 px-4 py-3 border border-slate-300 rounded-lg text-slate-700 hover:bg-slate-50 transition-colors font-medium\"\r\n            >\r\n              Cancel\r\n            </button>\r\n            <button\r\n              type=\"submit\"\r\n              disabled={loading || !selectedProvider || !phoneNumber.trim()}\r\n              className=\"flex-1 px-4 py-3 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors font-medium\"\r\n            >\r\n              {loading ? \"Processing...\" : \"Continue to Payment\"}\r\n            </button>\r\n          </div>\r\n        </form>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\PicturesUploader.tsx","messages":[],"suppressedMessages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":68,"column":8,"nodeType":"JSXOpeningElement","endLine":68,"endColumn":88,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\PlanRequestForm.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook React.useCallback has a missing dependency: 'collectFormAsObject'. Either include it or remove the dependency array.","line":788,"column":6,"nodeType":"ArrayExpression","endLine":788,"endColumn":215,"suggestions":[{"desc":"Update the dependencies array to be: [selectedRole, collectFormAsObject, transportRequired, budgetCurrency, budgetCurrencyOther, budgetAmount, touristMustHaves, touristInterests, groupSizeState, passengerCount, step, tripTypeValue, routeStops, routeSaved, storageKey]","fix":{"range":[28832,29041],"text":"[selectedRole, collectFormAsObject, transportRequired, budgetCurrency, budgetCurrencyOther, budgetAmount, touristMustHaves, touristInterests, groupSizeState, passengerCount, step, tripTypeValue, routeStops, routeSaved, storageKey]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook React.useEffect has a missing dependency: 'destinationsText'. Either include it or remove the dependency array.","line":1059,"column":6,"nodeType":"ArrayExpression","endLine":1059,"endColumn":65,"suggestions":[{"desc":"Update the dependencies array to be: [selectedRole, hasRestored, saveFormData, step, storageKey, destinationsText]","fix":{"range":[40571,40630],"text":"[selectedRole, hasRestored, saveFormData, step, storageKey, destinationsText]"}}]}],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook React.useEffect has a missing dependency: 'restoreFormData'. Either include it or remove the dependency array.","line":917,"column":6,"nodeType":"ArrayExpression","endLine":917,"endColumn":20,"suggestions":[{"desc":"Update the dependencies array to be: [restoreFormData, selectedRole]","fix":{"range":[34890,34904],"text":"[restoreFormData, selectedRole]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport React from \"react\";\r\nimport { ChevronDown, CheckCircle, ArrowRight, Plus, Trash2, ArrowUp, ArrowDown, MapPin, Calendar } from 'lucide-react';\r\nimport Link from 'next/link';\r\nimport { useRouter } from 'next/navigation';\r\nimport DatePicker from \"@/components/ui/DatePicker\";\r\n\r\ntype Props = {\r\n  selectedRole: string | null;\r\n};\r\n\r\nexport default function PlanRequestForm({ selectedRole }: Props) {\r\n  const router = useRouter();\r\n  const [submitting, setSubmitting] = React.useState(false);\r\n  const [submitted, setSubmitted] = React.useState(false);\r\n  const [willRedirectToAccount, setWillRedirectToAccount] = React.useState(false);\r\n  const redirectTimerRef = React.useRef<number | null>(null);\r\n  const prefillKeyRef = React.useRef<string | null>(null);\r\n\r\n  React.useEffect(() => {\r\n    return () => {\r\n      if (redirectTimerRef.current) {\r\n        window.clearTimeout(redirectTimerRef.current);\r\n        redirectTimerRef.current = null;\r\n      }\r\n    };\r\n  }, []);\r\n\r\n  const [transportRequired, setTransportRequired] = React.useState<string>('');\r\n  const [dateFrom, setDateFrom] = React.useState<string>('');\r\n  const [dateTo, setDateTo] = React.useState<string>('');\r\n  const [datePickerOpen, setDatePickerOpen] = React.useState<boolean>(false);\r\n\r\n  const [budgetCurrency, setBudgetCurrency] = React.useState<string>('USD');\r\n  const [budgetCurrencyOther, setBudgetCurrencyOther] = React.useState<string>('');\r\n  const [budgetAmount, setBudgetAmount] = React.useState<string>('');\r\n  const [touristMustHaves, setTouristMustHaves] = React.useState<string[]>([]);\r\n  const [touristInterests, setTouristInterests] = React.useState<string[]>([]);\r\n\r\n  const formatDateDisplay = React.useCallback((iso: string) => {\r\n    try {\r\n      const d = new Date(`${iso}T00:00:00`);\r\n      if (Number.isNaN(d.getTime())) return iso;\r\n      return new Intl.DateTimeFormat('en-GB', { day: '2-digit', month: 'short', year: 'numeric' }).format(d);\r\n    } catch {\r\n      return iso;\r\n    }\r\n  }, []);\r\n\r\n  const budgetCurrencyOptions = React.useMemo(\r\n    () => [\r\n      'USD',\r\n      'EUR',\r\n      'GBP',\r\n      'TZS',\r\n      'KES',\r\n      'UGX',\r\n      'RWF',\r\n      'ZAR',\r\n      'AED',\r\n      'SAR',\r\n      'INR',\r\n      'CNY',\r\n      'CAD',\r\n      'AUD',\r\n      'OTHER',\r\n    ],\r\n    []\r\n  );\r\n\r\n  const touristMustHaveOptions = React.useMemo(\r\n    () => ['Big 5 safari', 'Zanzibar', 'Hot air balloon', 'Ngorongoro Crater', 'Kilimanjaro', 'Local markets'],\r\n    []\r\n  );\r\n\r\n  const touristInterestOptions = React.useMemo(\r\n    () => [\r\n      'Wildlife / Safari',\r\n      'Beach / Islands',\r\n      'Culture / Heritage',\r\n      'Adventure / Hiking',\r\n      'Food & markets',\r\n      'Photography',\r\n      'Family-friendly',\r\n      'Luxury / honeymoon',\r\n      'Wellness / relaxation',\r\n    ],\r\n    []\r\n  );\r\n\r\n  const toggleSelection = React.useCallback((list: string[], value: string) => {\r\n    const exists = list.includes(value);\r\n    if (exists) return list.filter((v) => v !== value);\r\n    return [...list, value];\r\n  }, []);\r\n\r\n  const budgetCurrencyEffective = React.useMemo(() => {\r\n    if (budgetCurrency === 'OTHER') return (budgetCurrencyOther || '').trim().toUpperCase();\r\n    return budgetCurrency;\r\n  }, [budgetCurrency, budgetCurrencyOther]);\r\n\r\n  const budgetValue = React.useMemo(() => {\r\n    const amt = (budgetAmount || '').trim();\r\n    const cur = (budgetCurrencyEffective || '').trim();\r\n    if (!amt) return '';\r\n    if (!cur) return amt;\r\n    return `${cur} ${amt}`;\r\n  }, [budgetAmount, budgetCurrencyEffective]);\r\n\r\n  // Keep group size and passenger count in state so we can auto-fill passengers\r\n  const [groupSizeState, setGroupSizeState] = React.useState<string>('');\r\n  const [passengerCount, setPassengerCount] = React.useState<string>('');\r\n\r\n  // Minimal form state (expand as needed)\r\n  const formRef = React.useRef<HTMLFormElement | null>(null);\r\n\r\n  // Wizard state\r\n  const [step, setStep] = React.useState<number>(1);\r\n  const totalSteps = 4;\r\n  const [reviewData, setReviewData] = React.useState<Record<string, string>>({});\r\n\r\n  type RouteStop = {\r\n    id: string;\r\n    place: string;\r\n    nights: string;\r\n  };\r\n\r\n  const [tripTypeValue, setTripTypeValue] = React.useState<string>('');\r\n  const [routeStops, setRouteStops] = React.useState<RouteStop[]>([]);\r\n  const [routeSaved, setRouteSaved] = React.useState<boolean>(false);\r\n  const [routeSaveAttempted, setRouteSaveAttempted] = React.useState<boolean>(false);\r\n  const [routeTouchedById, setRouteTouchedById] = React.useState<Record<string, { place?: boolean; nights?: boolean }>>({});\r\n  const [pendingFocusStopId, setPendingFocusStopId] = React.useState<string | null>(null);\r\n\r\n  const tripTypeOptions = React.useMemo(() => {\r\n    switch (selectedRole) {\r\n      case 'Tourist':\r\n        return [\r\n          'Safari',\r\n          'Beach / Islands',\r\n          'Mountain Trekking',\r\n          'Cultural / Heritage',\r\n          'Study / Campus visit',\r\n          'Multi-destination tour',\r\n          'Other',\r\n        ];\r\n      case 'Event planner':\r\n        return [\r\n          'Conference / Workshop',\r\n          'Wedding / Ceremony',\r\n          'Corporate retreat',\r\n          'Festival / Concert',\r\n          'Team building',\r\n          'Other',\r\n        ];\r\n      case 'School / Teacher':\r\n        return [\r\n          'Educational tour',\r\n          'Field trip',\r\n          'Cultural exchange',\r\n          'Sports tour',\r\n          'Service learning',\r\n          'Other',\r\n        ];\r\n      case 'University':\r\n        return [\r\n          'Research / Fieldwork',\r\n          'Study abroad program',\r\n          'Academic conference',\r\n          'Internship / Placement',\r\n          'Campus visits',\r\n          'Other',\r\n        ];\r\n      case 'Community group':\r\n        return [\r\n          'Retreat',\r\n          'Volunteer / Outreach',\r\n          'Cultural visit',\r\n          'Pilgrimage',\r\n          'Group tour',\r\n          'Other',\r\n        ];\r\n      case 'Other':\r\n      default:\r\n        return ['Local tourism', 'Safari', 'Cultural', 'Adventure / Hiking', 'Other'];\r\n    }\r\n  }, [selectedRole]);\r\n\r\n  // Set a reasonable default trip type per role (without breaking restored state)\r\n  React.useEffect(() => {\r\n    if (!selectedRole) return;\r\n    setTripTypeValue((prev) => prev || tripTypeOptions[0] || '');\r\n  }, [selectedRole, tripTypeOptions]);\r\n\r\n  const isTourist = selectedRole === 'Tourist';\r\n  const isMultiDestination = isTourist && tripTypeValue === 'Multi-destination tour';\r\n\r\n  const [destinationsText, setDestinationsText] = React.useState<string>('');\r\n\r\n  React.useEffect(() => {\r\n    if (!isMultiDestination) setRouteSaved(false);\r\n  }, [isMultiDestination]);\r\n\r\n  const serializeRouteStops = React.useCallback((stops: RouteStop[]) => {\r\n    const cleaned = (stops || []).filter((s) => (s.place || '').trim());\r\n    if (cleaned.length === 0) return '';\r\n    return cleaned\r\n      .map((s, idx) => {\r\n        const nights = (s.nights || '').trim();\r\n        const nightsPart = nights ? ` — ${nights} night${Number(nights) === 1 ? '' : 's'}` : '';\r\n        return `${idx + 1}) ${s.place.trim()}${nightsPart}`;\r\n      })\r\n      .join('\\n');\r\n  }, []);\r\n\r\n  const destinationsValue = React.useMemo(() => {\r\n    if (!isMultiDestination) return '';\r\n    return serializeRouteStops(routeStops);\r\n  }, [isMultiDestination, routeStops, serializeRouteStops]);\r\n\r\n  const parseDestinationList = React.useCallback((raw: string) => {\r\n    return String(raw || '')\r\n      .split(/\\n|,|→|->|\\/|\\||&/g)\r\n      .map((s) => s.trim())\r\n      .filter(Boolean);\r\n  }, []);\r\n\r\n  type EastAfricaDestination = {\r\n    id: string;\r\n    label: string;\r\n    countryLabel: string;\r\n    match: string[];\r\n    activities: string[];\r\n  };\r\n\r\n  const eastAfricaDestinations: EastAfricaDestination[] = React.useMemo(\r\n    () => [\r\n      {\r\n        id: 'serengeti',\r\n        label: 'Serengeti',\r\n        countryLabel: 'Tanzania',\r\n        match: ['serengeti'],\r\n        activities: ['Big 5 safari', 'Great Migration (seasonal)', 'Hot air balloon', 'Game drives', 'Sundowner'],\r\n      },\r\n      {\r\n        id: 'ngorongoro',\r\n        label: 'Ngorongoro',\r\n        countryLabel: 'Tanzania',\r\n        match: ['ngorongoro', 'crater'],\r\n        activities: ['Crater game drive', 'Maasai boma visit', 'Olduvai Gorge', 'Photography viewpoints'],\r\n      },\r\n      {\r\n        id: 'tarangire',\r\n        label: 'Tarangire',\r\n        countryLabel: 'Tanzania',\r\n        match: ['tarangire'],\r\n        activities: ['Elephants & baobabs', 'Game drives', 'Birdwatching'],\r\n      },\r\n      {\r\n        id: 'manyara',\r\n        label: 'Lake Manyara',\r\n        countryLabel: 'Tanzania',\r\n        match: ['manyara', 'lake manyara'],\r\n        activities: ['Tree-climbing lions (seasonal)', 'Birdwatching', 'Canoeing (when available)'],\r\n      },\r\n      {\r\n        id: 'nyerere-selous',\r\n        label: 'Nyerere / Selous',\r\n        countryLabel: 'Tanzania',\r\n        match: ['nyerere', 'selous', 'selous game reserve', 'nyerere national park'],\r\n        activities: ['Boat safari (Rufiji)', 'Walking safari', 'Game drives', 'Fly-in safari'],\r\n      },\r\n      {\r\n        id: 'ruaha',\r\n        label: 'Ruaha',\r\n        countryLabel: 'Tanzania',\r\n        match: ['ruaha'],\r\n        activities: ['Remote game drives', 'Big cats', 'Walking safari (when available)'],\r\n      },\r\n      {\r\n        id: 'mikumi',\r\n        label: 'Mikumi',\r\n        countryLabel: 'Tanzania',\r\n        match: ['mikumi'],\r\n        activities: ['Game drives', 'Quick safari from Dar (time permitting)'],\r\n      },\r\n      {\r\n        id: 'kilimanjaro',\r\n        label: 'Mount Kilimanjaro',\r\n        countryLabel: 'Tanzania',\r\n        match: ['kilimanjaro', 'kili', 'moshi'],\r\n        activities: ['Kilimanjaro trek', 'Day hike (Mandara / Marangu)', 'Waterfalls & coffee tour', 'Acclimatization hike'],\r\n      },\r\n      {\r\n        id: 'lake-natron',\r\n        label: 'Lake Natron',\r\n        countryLabel: 'Tanzania',\r\n        match: ['natron', 'lake natron'],\r\n        activities: ['Waterfall hike', 'Flamingos (seasonal)', 'Ol Doinyo Lengai viewpoints'],\r\n      },\r\n      {\r\n        id: 'lake-eyasi',\r\n        label: 'Lake Eyasi',\r\n        countryLabel: 'Tanzania',\r\n        match: ['eyasi', 'lake eyasi'],\r\n        activities: ['Cultural experience (Hadzabe)', 'Lake views', 'Local community visit'],\r\n      },\r\n      {\r\n        id: 'arusha',\r\n        label: 'Arusha',\r\n        countryLabel: 'Tanzania',\r\n        match: ['arusha', 'arusha city'],\r\n        activities: ['City tour', 'Coffee experience', 'Cultural heritage centre', 'Arusha National Park (day trip)'],\r\n      },\r\n      {\r\n        id: 'zanzibar',\r\n        label: 'Zanzibar',\r\n        countryLabel: 'Tanzania',\r\n        match: ['zanzibar', 'stone town', 'nungwi', 'kendwa', 'paje', 'jambiani'],\r\n        activities: ['Stone Town tour', 'Spice tour', 'Snorkeling / diving', 'Dhow sunset cruise', 'Beach days'],\r\n      },\r\n      {\r\n        id: 'mafia',\r\n        label: 'Mafia Island',\r\n        countryLabel: 'Tanzania',\r\n        match: ['mafia island', 'mafia'],\r\n        activities: ['Diving', 'Snorkeling', 'Marine park', 'Whale sharks (seasonal)'],\r\n      },\r\n      {\r\n        id: 'dar',\r\n        label: 'Dar es Salaam',\r\n        countryLabel: 'Tanzania',\r\n        match: ['dar es salaam', 'dar', 'dsm'],\r\n        activities: ['City & markets', 'Coco Beach', 'Island day trip (when available)'],\r\n      },\r\n\r\n      {\r\n        id: 'maasai-mara',\r\n        label: 'Masai Mara',\r\n        countryLabel: 'Kenya',\r\n        match: ['masai mara', 'maasai mara', 'mara'],\r\n        activities: ['Big 5 safari', 'Hot air balloon', 'Game drives', 'Cultural village visit'],\r\n      },\r\n      {\r\n        id: 'amboseli',\r\n        label: 'Amboseli',\r\n        countryLabel: 'Kenya',\r\n        match: ['amboseli'],\r\n        activities: ['Elephants with Kilimanjaro views', 'Game drives', 'Photography'],\r\n      },\r\n      {\r\n        id: 'lake-naivasha',\r\n        label: 'Lake Naivasha',\r\n        countryLabel: 'Kenya',\r\n        match: ['naivasha', 'lake naivasha'],\r\n        activities: ['Boat ride', 'Crescent Island walk', 'Relaxed lakeside day'],\r\n      },\r\n      {\r\n        id: 'nakuru',\r\n        label: 'Lake Nakuru',\r\n        countryLabel: 'Kenya',\r\n        match: ['nakuru', 'lake nakuru'],\r\n        activities: ['Rhino sanctuary', 'Birdwatching', 'Game drives'],\r\n      },\r\n      {\r\n        id: 'samburu',\r\n        label: 'Samburu',\r\n        countryLabel: 'Kenya',\r\n        match: ['samburu'],\r\n        activities: ['Unique wildlife', 'Game drives', 'Cultural experiences'],\r\n      },\r\n      {\r\n        id: 'tsavo',\r\n        label: 'Tsavo',\r\n        countryLabel: 'Kenya',\r\n        match: ['tsavo', 'tsavo east', 'tsavo west'],\r\n        activities: ['Game drives', 'Red elephants (seasonal)', 'Scenic landscapes'],\r\n      },\r\n      {\r\n        id: 'diani',\r\n        label: 'Diani',\r\n        countryLabel: 'Kenya',\r\n        match: ['diani', 'diani beach'],\r\n        activities: ['Beach days', 'Snorkeling / diving', 'Kite-surfing (seasonal)'],\r\n      },\r\n      {\r\n        id: 'nairobi',\r\n        label: 'Nairobi',\r\n        countryLabel: 'Kenya',\r\n        match: ['nairobi'],\r\n        activities: ['City tour', 'Giraffe Centre', 'National Museum', 'Nairobi National Park'],\r\n      },\r\n\r\n      {\r\n        id: 'bwindi',\r\n        label: 'Bwindi',\r\n        countryLabel: 'Uganda',\r\n        match: ['bwindi'],\r\n        activities: ['Gorilla trekking', 'Community walk', 'Forest hikes'],\r\n      },\r\n      {\r\n        id: 'queen-elizabeth',\r\n        label: 'Queen Elizabeth NP',\r\n        countryLabel: 'Uganda',\r\n        match: ['queen elizabeth', 'queen elizabeth np', 'qenp', 'kazinga'],\r\n        activities: ['Kazinga Channel boat cruise', 'Game drives', 'Tree-climbing lions (Ishasha)'],\r\n      },\r\n      {\r\n        id: 'kibale',\r\n        label: 'Kibale',\r\n        countryLabel: 'Uganda',\r\n        match: ['kibale'],\r\n        activities: ['Chimpanzee tracking', 'Forest walks', 'Crater lakes (nearby)'],\r\n      },\r\n      {\r\n        id: 'jinja',\r\n        label: 'Jinja',\r\n        countryLabel: 'Uganda',\r\n        match: ['jinja'],\r\n        activities: ['White-water rafting (seasonal)', 'Nile cruise', 'Adventure day'],\r\n      },\r\n      {\r\n        id: 'murchison',\r\n        label: 'Murchison Falls',\r\n        countryLabel: 'Uganda',\r\n        match: ['murchison'],\r\n        activities: ['Boat cruise', 'Falls hike', 'Game drives'],\r\n      },\r\n      {\r\n        id: 'kigali',\r\n        label: 'Kigali',\r\n        countryLabel: 'Rwanda',\r\n        match: ['kigali'],\r\n        activities: ['City tour', 'Local markets', 'Cultural experiences'],\r\n      },\r\n      {\r\n        id: 'volcanoes',\r\n        label: 'Volcanoes National Park',\r\n        countryLabel: 'Rwanda',\r\n        match: ['volcanoes', 'musanze', 'ruhengeri'],\r\n        activities: ['Gorilla trekking', 'Golden monkey trekking', 'Hikes & viewpoints'],\r\n      },\r\n      {\r\n        id: 'lake-kivu',\r\n        label: 'Lake Kivu',\r\n        countryLabel: 'Rwanda',\r\n        match: ['kivu', 'lake kivu', 'gisenyi', 'karongi', 'kibuye'],\r\n        activities: ['Lakeside relaxation', 'Boat ride', 'Coffee & local experiences'],\r\n      },\r\n    ],\r\n    []\r\n  );\r\n\r\n  const matchEastAfricaDestinations = React.useCallback(\r\n    (inputs: string[]) => {\r\n      const matchedIds = new Set<string>();\r\n      const matchedByInput: Record<string, string[]> = {};\r\n      const unmatched: string[] = [];\r\n\r\n      for (const raw of inputs) {\r\n        const normalized = raw.toLowerCase();\r\n        const matches = eastAfricaDestinations\r\n          .filter((d) => d.match.some((m) => normalized.includes(m)))\r\n          .map((d) => d.id);\r\n        if (matches.length === 0) {\r\n          unmatched.push(raw);\r\n        } else {\r\n          matchedByInput[raw] = matches;\r\n          matches.forEach((id) => matchedIds.add(id));\r\n        }\r\n      }\r\n\r\n      const matched = eastAfricaDestinations.filter((d) => matchedIds.has(d.id));\r\n      return { matched, matchedByInput, unmatched };\r\n    },\r\n    [eastAfricaDestinations]\r\n  );\r\n\r\n  const cleanedRouteStops = React.useMemo(() => {\r\n    if (!isMultiDestination) return [] as RouteStop[];\r\n    return (routeStops || []).filter((s) => (s.place || '').trim());\r\n  }, [isMultiDestination, routeStops]);\r\n\r\n  const selectedDestinationInputs = React.useMemo(() => {\r\n    if (isMultiDestination) {\r\n      return (cleanedRouteStops || []).map((s) => (s.place || '').trim()).filter(Boolean);\r\n    }\r\n    return parseDestinationList(destinationsText);\r\n  }, [isMultiDestination, cleanedRouteStops, destinationsText, parseDestinationList]);\r\n\r\n  const destinationActivityContext = React.useMemo(() => {\r\n    return matchEastAfricaDestinations(selectedDestinationInputs);\r\n  }, [matchEastAfricaDestinations, selectedDestinationInputs]);\r\n\r\n  const suggestedActivitiesSet = React.useMemo(() => {\r\n    const set = new Set<string>();\r\n    for (const d of destinationActivityContext.matched) {\r\n      for (const a of d.activities) set.add(a);\r\n    }\r\n    return set;\r\n  }, [destinationActivityContext.matched]);\r\n\r\n  const popularMustHavesFiltered = React.useMemo(() => {\r\n    return touristMustHaveOptions.filter((a) => !suggestedActivitiesSet.has(a));\r\n  }, [touristMustHaveOptions, suggestedActivitiesSet]);\r\n\r\n  type DestinationAccent = {\r\n    chipActive: string;\r\n    chipInactive: string;\r\n    iconActive: string;\r\n    headerIconWrap: string;\r\n    headerIcon: string;\r\n    destinationPill: string;\r\n    destinationPillSubtle: string;\r\n    reviewSectionBorder: string;\r\n    reviewSectionFrom: string;\r\n    reviewSectionBar: string;\r\n    reviewLabel: string;\r\n  };\r\n\r\n  const destinationAccentPalette = React.useMemo<DestinationAccent[]>(\r\n    () => [\r\n      {\r\n        chipActive:\r\n          ' bg-emerald-100 text-emerald-950 border-emerald-400 ring-1 ring-emerald-300/40 hover:bg-emerald-100 hover:border-emerald-500',\r\n        chipInactive: ' bg-white text-slate-900 border-slate-200 hover:bg-emerald-50 hover:border-emerald-200',\r\n        iconActive: 'text-emerald-700',\r\n        headerIconWrap: 'bg-emerald-50 border-emerald-200',\r\n        headerIcon: 'text-emerald-700',\r\n        destinationPill: 'bg-emerald-50 text-emerald-950 border-emerald-200',\r\n        destinationPillSubtle: 'text-emerald-700/80',\r\n        reviewSectionBorder: 'border-emerald-200/70',\r\n        reviewSectionFrom: 'from-emerald-50/70',\r\n        reviewSectionBar:\r\n          \"before:bg-gradient-to-r before:from-emerald-500 before:via-emerald-400 before:to-emerald-200\",\r\n        reviewLabel: 'text-emerald-700/80',\r\n      },\r\n      {\r\n        chipActive:\r\n          ' bg-sky-100 text-sky-950 border-sky-400 ring-1 ring-sky-300/40 hover:bg-sky-100 hover:border-sky-500',\r\n        chipInactive: ' bg-white text-slate-900 border-slate-200 hover:bg-sky-50 hover:border-sky-200',\r\n        iconActive: 'text-sky-700',\r\n        headerIconWrap: 'bg-sky-50 border-sky-200',\r\n        headerIcon: 'text-sky-700',\r\n        destinationPill: 'bg-sky-50 text-sky-950 border-sky-200',\r\n        destinationPillSubtle: 'text-sky-700/80',\r\n        reviewSectionBorder: 'border-sky-200/70',\r\n        reviewSectionFrom: 'from-sky-50/70',\r\n        reviewSectionBar: \"before:bg-gradient-to-r before:from-sky-500 before:via-sky-400 before:to-sky-200\",\r\n        reviewLabel: 'text-sky-700/80',\r\n      },\r\n      {\r\n        chipActive:\r\n          ' bg-violet-100 text-violet-950 border-violet-400 ring-1 ring-violet-300/40 hover:bg-violet-100 hover:border-violet-500',\r\n        chipInactive: ' bg-white text-slate-900 border-slate-200 hover:bg-violet-50 hover:border-violet-200',\r\n        iconActive: 'text-violet-700',\r\n        headerIconWrap: 'bg-violet-50 border-violet-200',\r\n        headerIcon: 'text-violet-700',\r\n        destinationPill: 'bg-violet-50 text-violet-950 border-violet-200',\r\n        destinationPillSubtle: 'text-violet-700/80',\r\n        reviewSectionBorder: 'border-violet-200/70',\r\n        reviewSectionFrom: 'from-violet-50/70',\r\n        reviewSectionBar:\r\n          \"before:bg-gradient-to-r before:from-violet-500 before:via-violet-400 before:to-violet-200\",\r\n        reviewLabel: 'text-violet-700/80',\r\n      },\r\n      {\r\n        chipActive:\r\n          ' bg-rose-100 text-rose-950 border-rose-400 ring-1 ring-rose-300/40 hover:bg-rose-100 hover:border-rose-500',\r\n        chipInactive: ' bg-white text-slate-900 border-slate-200 hover:bg-rose-50 hover:border-rose-200',\r\n        iconActive: 'text-rose-700',\r\n        headerIconWrap: 'bg-rose-50 border-rose-200',\r\n        headerIcon: 'text-rose-700',\r\n        destinationPill: 'bg-rose-50 text-rose-950 border-rose-200',\r\n        destinationPillSubtle: 'text-rose-700/80',\r\n        reviewSectionBorder: 'border-rose-200/70',\r\n        reviewSectionFrom: 'from-rose-50/70',\r\n        reviewSectionBar: \"before:bg-gradient-to-r before:from-rose-500 before:via-rose-400 before:to-rose-200\",\r\n        reviewLabel: 'text-rose-700/80',\r\n      },\r\n      {\r\n        chipActive:\r\n          ' bg-amber-100 text-amber-950 border-amber-400 ring-1 ring-amber-300/40 hover:bg-amber-100 hover:border-amber-500',\r\n        chipInactive: ' bg-white text-slate-900 border-slate-200 hover:bg-amber-50 hover:border-amber-200',\r\n        iconActive: 'text-amber-700',\r\n        headerIconWrap: 'bg-amber-50 border-amber-200',\r\n        headerIcon: 'text-amber-700',\r\n        destinationPill: 'bg-amber-50 text-amber-950 border-amber-200',\r\n        destinationPillSubtle: 'text-amber-700/80',\r\n        reviewSectionBorder: 'border-amber-200/70',\r\n        reviewSectionFrom: 'from-amber-50/70',\r\n        reviewSectionBar:\r\n          \"before:bg-gradient-to-r before:from-amber-500 before:via-amber-400 before:to-amber-200\",\r\n        reviewLabel: 'text-amber-700/80',\r\n      },\r\n    ],\r\n    []\r\n  );\r\n\r\n  const destinationAccentById = React.useMemo(() => {\r\n    const map: Record<string, DestinationAccent> = {};\r\n    destinationActivityContext.matched.forEach((d, idx) => {\r\n      map[d.id] = destinationAccentPalette[idx % destinationAccentPalette.length];\r\n    });\r\n    return map;\r\n  }, [destinationActivityContext.matched, destinationAccentPalette]);\r\n\r\n  const getDestinationAccent = React.useCallback(\r\n    (id: string) => destinationAccentById[id] ?? destinationAccentPalette[0],\r\n    [destinationAccentById, destinationAccentPalette]\r\n  );\r\n\r\n  const touristPrimaryAccent = React.useMemo(() => {\r\n    const id = destinationActivityContext.matched[0]?.id;\r\n    if (id) return getDestinationAccent(id);\r\n    return destinationAccentPalette[0];\r\n  }, [destinationActivityContext.matched, getDestinationAccent, destinationAccentPalette]);\r\n\r\n  const activityChipBaseClass =\r\n    'inline-flex items-center gap-2 rounded-xl px-3.5 py-2 text-xs font-semibold border select-none bg-white shadow-sm transition-all duration-150 ease-out hover:-translate-y-px hover:shadow-md focus:outline-none focus-visible:ring-2 focus-visible:ring-slate-300 focus-visible:ring-offset-2 focus-visible:ring-offset-white active:translate-y-0 active:shadow-sm active:scale-[0.99]';\r\n\r\n  const totalRouteNights = React.useMemo(() => {\r\n    return cleanedRouteStops.reduce((sum, s) => {\r\n      const n = Number(s.nights);\r\n      return sum + (Number.isFinite(n) ? Math.max(0, n) : 0);\r\n    }, 0);\r\n  }, [cleanedRouteStops]);\r\n\r\n  const addRouteStop = React.useCallback(() => {\r\n    const id = `${Date.now()}_${Math.random().toString(16).slice(2)}`;\r\n    setRouteStops((prev) => [...prev, { id, place: '', nights: '' }]);\r\n    setPendingFocusStopId(id);\r\n    setRouteSaved(false);\r\n  }, []);\r\n\r\n  React.useEffect(() => {\r\n    if (!pendingFocusStopId) return;\r\n    if (!isMultiDestination || routeSaved) return;\r\n\r\n    const id = pendingFocusStopId;\r\n    const focus = () => {\r\n      const el = document.querySelector(`[data-route-stop-place=\"${id}\"]`) as HTMLInputElement | null;\r\n      if (el) {\r\n        el.focus();\r\n        el.select();\r\n      }\r\n      setPendingFocusStopId(null);\r\n    };\r\n\r\n    // Let the input mount first.\r\n    requestAnimationFrame(focus);\r\n  }, [pendingFocusStopId, isMultiDestination, routeSaved, routeStops.length]);\r\n\r\n  const routeValidation = React.useMemo(() => {\r\n    if (!isMultiDestination) {\r\n      return {\r\n        byId: {} as Record<string, { placeOk: boolean; nightsOk: boolean; duplicate: boolean; normalized: string }>,\r\n        duplicates: [] as string[],\r\n        canSave: false,\r\n        hasAtLeastOne: false,\r\n        routePath: '',\r\n      };\r\n    }\r\n\r\n    const normalizedPlaces = (routeStops || []).map((s) => (s.place || '').trim().toLowerCase());\r\n    const counts = new Map<string, number>();\r\n    for (const p of normalizedPlaces) {\r\n      if (!p) continue;\r\n      counts.set(p, (counts.get(p) || 0) + 1);\r\n    }\r\n\r\n    const duplicates = Array.from(counts.entries())\r\n      .filter(([, c]) => c > 1)\r\n      .map(([p]) => p);\r\n\r\n    const byId: Record<string, { placeOk: boolean; nightsOk: boolean; duplicate: boolean; normalized: string }> = {};\r\n    let hasAtLeastOne = false;\r\n\r\n    for (const s of routeStops || []) {\r\n      const normalized = (s.place || '').trim().toLowerCase();\r\n      const placeOk = !!normalized;\r\n      const nightsOk = Number(s.nights) >= 1;\r\n      const duplicate = !!normalized && (counts.get(normalized) || 0) > 1;\r\n      if (placeOk) hasAtLeastOne = true;\r\n      byId[s.id] = { placeOk, nightsOk, duplicate, normalized };\r\n    }\r\n\r\n    const canSave =\r\n      hasAtLeastOne &&\r\n      (routeStops || []).length > 0 &&\r\n      (routeStops || []).every((s) => {\r\n        const v = byId[s.id];\r\n        return v?.placeOk && v?.nightsOk && !v?.duplicate;\r\n      });\r\n\r\n    const routePath = (routeStops || [])\r\n      .filter((s) => (s.place || '').trim())\r\n      .map((s) => (s.place || '').trim())\r\n      .join(' → ');\r\n\r\n    return { byId, duplicates, canSave, hasAtLeastOne, routePath };\r\n  }, [isMultiDestination, routeStops]);\r\n\r\n  const removeRouteStop = React.useCallback((id: string) => {\r\n    setRouteStops((prev) => prev.filter((s) => s.id !== id));\r\n    setRouteSaved(false);\r\n  }, []);\r\n\r\n  const moveRouteStop = React.useCallback((id: string, dir: -1 | 1) => {\r\n    setRouteStops((prev) => {\r\n      const idx = prev.findIndex((s) => s.id === id);\r\n      if (idx < 0) return prev;\r\n      const nextIdx = idx + dir;\r\n      if (nextIdx < 0 || nextIdx >= prev.length) return prev;\r\n      const copy = [...prev];\r\n      const tmp = copy[idx];\r\n      copy[idx] = copy[nextIdx];\r\n      copy[nextIdx] = tmp;\r\n      return copy;\r\n    });\r\n    setRouteSaved(false);\r\n  }, []);\r\n  \r\n  // Storage key for autosave - based on role to separate different form sessions\r\n  const storageKey = React.useMemo(() => `planRequestForm_${selectedRole || 'default'}`, [selectedRole]);\r\n  const [hasRestored, setHasRestored] = React.useState(false);\r\n\r\n  const collectFormAsObject = () => {\r\n    if (!formRef.current) return {} as Record<string, string>;\r\n    const fm = new FormData(formRef.current);\r\n    const obj: Record<string, string> = {};\r\n    fm.forEach((value, key) => {\r\n      obj[key] = typeof value === 'string' ? value : String(value);\r\n    });\r\n    // ensure role is included\r\n    obj.role = selectedRole ?? '';\r\n    \r\n    // Also try to get saved data from sessionStorage to include fields from other steps\r\n    try {\r\n      const saved = sessionStorage.getItem(storageKey);\r\n      if (saved) {\r\n        const data = JSON.parse(saved);\r\n        if (data.formData) {\r\n          // Merge saved data with current form data (current form data takes precedence)\r\n          Object.keys(data.formData).forEach((key) => {\r\n            // Deprecated/removed fields\r\n            if (key === 'touristGoal' || key === 'touristPace' || key === 'attachments') return;\r\n            // Tourist: pickup/dropoff is planned after destination confirmation\r\n            if (selectedRole === 'Tourist' && (key === 'pickupLocation' || key === 'dropoffLocation')) return;\r\n            if (obj[key] === '' || obj[key] === undefined) {\r\n              obj[key] = data.formData[key] || '';\r\n            }\r\n          });\r\n        }\r\n      }\r\n    } catch (e) {\r\n      // Ignore errors when reading saved data\r\n    }\r\n    \r\n    return obj;\r\n  };\r\n\r\n  // Save form data to sessionStorage\r\n  const saveFormData = React.useCallback(() => {\r\n    if (!formRef.current || !selectedRole) return;\r\n    try {\r\n      const formData = collectFormAsObject();\r\n      const dataToSave = {\r\n        formData,\r\n        transportRequired,\r\n        budgetCurrency,\r\n        budgetCurrencyOther,\r\n        budgetAmount,\r\n        touristMustHaves,\r\n        touristInterests,\r\n        groupSizeState,\r\n        passengerCount,\r\n        step,\r\n        tripTypeValue,\r\n        routeStops,\r\n        routeSaved,\r\n      };\r\n      sessionStorage.setItem(storageKey, JSON.stringify(dataToSave));\r\n    } catch (e) {\r\n      console.error('Failed to save form data:', e);\r\n    }\r\n  }, [selectedRole, storageKey, transportRequired, budgetCurrency, budgetCurrencyOther, budgetAmount, touristMustHaves, touristInterests, groupSizeState, passengerCount, step, tripTypeValue, routeStops, routeSaved]);\r\n\r\n  // Restore form data from sessionStorage\r\n  const restoreFormData = React.useCallback(() => {\r\n    if (!formRef.current || !selectedRole || hasRestored) return;\r\n    try {\r\n      const saved = sessionStorage.getItem(storageKey);\r\n      if (!saved) {\r\n        setHasRestored(true);\r\n        return;\r\n      }\r\n      \r\n      const data = JSON.parse(saved);\r\n      if (data.formData && formRef.current) {\r\n        // Restore form fields - use setTimeout to ensure DOM is ready\r\n        setTimeout(() => {\r\n          if (!formRef.current) return;\r\n          \r\n          Object.keys(data.formData).forEach((key) => {\r\n            if (key === 'role') return; // Skip role, it's set by the component\r\n            \r\n            const input = formRef.current?.querySelector(`[name=\"${key}\"]`) as HTMLInputElement | HTMLSelectElement | HTMLTextAreaElement | null;\r\n            if (input) {\r\n              const value = data.formData[key] || '';\r\n              if (input.tagName === 'INPUT') {\r\n                const inputEl = input as HTMLInputElement;\r\n                if (inputEl.type === 'checkbox') {\r\n                  inputEl.checked = value === 'on' || value === 'true' || value === true;\r\n                } else if (inputEl.type === 'radio') {\r\n                  const radio = formRef.current?.querySelector(`[name=\"${key}\"][value=\"${value}\"]`) as HTMLInputElement;\r\n                  if (radio) radio.checked = true;\r\n                } else {\r\n                  inputEl.value = value;\r\n                }\r\n              } else if (input.tagName === 'SELECT' || input.tagName === 'TEXTAREA') {\r\n                input.value = value;\r\n              }\r\n            }\r\n          });\r\n          \r\n          // Trigger change events to ensure React state updates\r\n          formRef.current.querySelectorAll('input, select, textarea').forEach((el) => {\r\n            const event = new Event('change', { bubbles: true });\r\n            el.dispatchEvent(event);\r\n          });\r\n        }, 100);\r\n        \r\n        // Restore state\r\n        if (data.transportRequired !== undefined) setTransportRequired(data.transportRequired);\r\n        if (data.groupSizeState !== undefined) setGroupSizeState(data.groupSizeState);\r\n        if (data.passengerCount !== undefined) setPassengerCount(data.passengerCount);\r\n        if (data.step) setStep(data.step);\r\n        if (data.tripTypeValue !== undefined) setTripTypeValue(data.tripTypeValue);\r\n        else if (data.formData?.tripType) setTripTypeValue(data.formData.tripType);\r\n        if (Array.isArray(data.routeStops)) {\r\n          setRouteStops(\r\n            data.routeStops\r\n              .map((s: any) => ({\r\n                id: String(s?.id ?? `${Date.now()}_${Math.random().toString(16).slice(2)}`),\r\n                place: String(s?.place ?? ''),\r\n                nights: String(s?.nights ?? ''),\r\n              }))\r\n              .slice(0, 20)\r\n          );\r\n        }\r\n        if (typeof data.routeSaved === 'boolean') setRouteSaved(data.routeSaved);\r\n\r\n        if (data.formData?.dateFrom !== undefined) setDateFrom(String(data.formData.dateFrom || ''));\r\n        if (data.formData?.dateTo !== undefined) setDateTo(String(data.formData.dateTo || ''));\r\n        if (data.formData?.destinations !== undefined) setDestinationsText(String(data.formData.destinations || ''));\r\n\r\n        if (data.budgetCurrency !== undefined) setBudgetCurrency(String(data.budgetCurrency || 'USD'));\r\n        if (data.budgetCurrencyOther !== undefined) setBudgetCurrencyOther(String(data.budgetCurrencyOther || ''));\r\n        if (data.budgetAmount !== undefined) setBudgetAmount(String(data.budgetAmount || ''));\r\n        if (Array.isArray(data.touristMustHaves)) setTouristMustHaves(data.touristMustHaves.filter(Boolean));\r\n        if (data.touristMustHaves === undefined && typeof data.formData?.touristMustHaves === 'string') {\r\n          const parts = String(data.formData.touristMustHaves || '')\r\n            .split(',')\r\n            .map((s: string) => s.trim())\r\n            .filter(Boolean);\r\n          setTouristMustHaves(parts);\r\n        }\r\n\r\n        if (Array.isArray(data.touristInterests)) setTouristInterests(data.touristInterests.filter(Boolean));\r\n        if (data.touristInterests === undefined && typeof data.formData?.touristInterests === 'string') {\r\n          const parts = String(data.formData.touristInterests || '')\r\n            .split(',')\r\n            .map((s: string) => s.trim())\r\n            .filter(Boolean);\r\n          setTouristInterests(parts);\r\n        }\r\n\r\n        // Back-compat: budget was previously a single string; split into currency + amount when possible.\r\n        const rawBudget = String(data.formData?.budget ?? '').trim();\r\n        if (rawBudget && data.budgetAmount === undefined) {\r\n          const m = rawBudget.match(/^([A-Za-z]{3,6})\\s+(.+)$/);\r\n          if (m) {\r\n            const code = m[1].toUpperCase();\r\n            const amountPart = (m[2] || '').trim();\r\n            if (budgetCurrencyOptions.includes(code)) {\r\n              setBudgetCurrency(code);\r\n              setBudgetCurrencyOther('');\r\n            } else {\r\n              setBudgetCurrency('OTHER');\r\n              setBudgetCurrencyOther(code);\r\n            }\r\n            setBudgetAmount(amountPart);\r\n          } else {\r\n            setBudgetAmount(rawBudget);\r\n          }\r\n        }\r\n        \r\n        setHasRestored(true);\r\n      } else {\r\n        setHasRestored(true);\r\n      }\r\n    } catch (e) {\r\n      console.error('Failed to restore form data:', e);\r\n      setHasRestored(true);\r\n    }\r\n  }, [selectedRole, storageKey, hasRestored, budgetCurrencyOptions]);\r\n\r\n  // Restore on mount and when selectedRole changes\r\n  React.useEffect(() => {\r\n    if (selectedRole) {\r\n      setHasRestored(false);\r\n      restoreFormData();\r\n    }\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [selectedRole]); // Only depend on selectedRole to avoid infinite loops\r\n\r\n  // Autofill contact details for logged-in users (only if blank).\r\n  // This prevents mismatches (email/phone formatting) and makes requests reliably show under \"My Plan Requests\".\r\n  React.useEffect(() => {\r\n    if (!selectedRole || !hasRestored) return;\r\n    if (prefillKeyRef.current === storageKey) return;\r\n    prefillKeyRef.current = storageKey;\r\n\r\n    let cancelled = false;\r\n\r\n    const setIfEmpty = (name: string, value: string) => {\r\n      const v = String(value || '').trim();\r\n      if (!v) return;\r\n      const el = formRef.current?.querySelector(`[name=\"${name}\"]`) as\r\n        | HTMLInputElement\r\n        | HTMLSelectElement\r\n        | HTMLTextAreaElement\r\n        | null;\r\n      if (!el) return;\r\n      const current = String((el as any).value || '').trim();\r\n      if (current) return;\r\n      (el as any).value = v;\r\n      el.dispatchEvent(new Event('input', { bubbles: true }));\r\n      el.dispatchEvent(new Event('change', { bubbles: true }));\r\n    };\r\n\r\n    (async () => {\r\n      try {\r\n        const meRes = await fetch('/api/account/me', { credentials: 'include' });\r\n        if (!meRes.ok) return;\r\n        const me = await meRes.json().catch(() => null);\r\n        if (!me || typeof me !== 'object') return;\r\n\r\n        const fullName = String((me as any).fullName || (me as any).name || '').trim();\r\n        const email = String((me as any).email || '').trim();\r\n        const phone = String((me as any).phone || '').trim();\r\n\r\n        if (cancelled) return;\r\n\r\n        // Persist into sessionStorage so it will restore even if the contact step isn't mounted yet.\r\n        try {\r\n          const savedRaw = sessionStorage.getItem(storageKey);\r\n          const saved = savedRaw ? JSON.parse(savedRaw) : {};\r\n          const formData = (saved && typeof saved === 'object' && saved.formData && typeof saved.formData === 'object')\r\n            ? { ...saved.formData }\r\n            : {};\r\n\r\n          if (!String(formData.fullName || '').trim() && fullName) formData.fullName = fullName;\r\n          if (!String(formData.email || '').trim() && email) formData.email = email;\r\n          if (!String(formData.phone || '').trim() && phone) formData.phone = phone;\r\n          formData.role = selectedRole ?? '';\r\n\r\n          sessionStorage.setItem(storageKey, JSON.stringify({\r\n            ...(saved && typeof saved === 'object' ? saved : {}),\r\n            formData,\r\n          }));\r\n        } catch {\r\n          // non-blocking\r\n        }\r\n\r\n        // If the inputs are currently mounted, populate them too.\r\n        setIfEmpty('fullName', fullName);\r\n        setIfEmpty('email', email);\r\n        setIfEmpty('phone', phone);\r\n      } catch {\r\n        // non-blocking\r\n      }\r\n    })();\r\n\r\n    return () => {\r\n      cancelled = true;\r\n    };\r\n  }, [selectedRole, hasRestored, storageKey]);\r\n\r\n  // Save form data whenever it changes (debounced)\r\n  React.useEffect(() => {\r\n    if (!selectedRole || !hasRestored) return;\r\n    const timeoutId = setTimeout(() => {\r\n      saveFormData();\r\n    }, 500); // Debounce saves by 500ms\r\n    \r\n    return () => clearTimeout(timeoutId);\r\n  }, [transportRequired, dateFrom, dateTo, budgetCurrency, budgetCurrencyOther, budgetAmount, touristMustHaves, groupSizeState, passengerCount, step, selectedRole, hasRestored, saveFormData]);\r\n\r\n  // Save form data when inputs change (including when navigating between steps)\r\n  React.useEffect(() => {\r\n    if (!selectedRole || !hasRestored || !formRef.current) return;\r\n    \r\n    const form = formRef.current;\r\n    const handleChange = () => {\r\n      saveFormData();\r\n    };\r\n    \r\n    // Also restore when step changes (to restore conditionally rendered fields)\r\n    const handleStepChange = () => {\r\n      // Small delay to ensure DOM is updated with new step's fields\r\n      setTimeout(() => {\r\n        if (!formRef.current) return;\r\n        const saved = sessionStorage.getItem(storageKey);\r\n        if (saved) {\r\n          try {\r\n            const data = JSON.parse(saved);\r\n            if (data.formData) {\r\n              Object.keys(data.formData).forEach((key) => {\r\n                if (key === 'role') return;\r\n                const input = formRef.current?.querySelector(`[name=\"${key}\"]`) as HTMLInputElement | HTMLSelectElement | HTMLTextAreaElement | null;\r\n                if (input && !input.value) {\r\n                  const value = data.formData[key] || '';\r\n                  if (key === 'destinations' && !destinationsText) {\r\n                    setDestinationsText(String(value || ''));\r\n                  }\r\n                  if (input.tagName === 'INPUT') {\r\n                    const inputEl = input as HTMLInputElement;\r\n                    if (inputEl.type === 'checkbox') {\r\n                      inputEl.checked = value === 'on' || value === 'true' || value === true;\r\n                    } else if (inputEl.type !== 'radio') {\r\n                      inputEl.value = value;\r\n                    }\r\n                  } else if (input.tagName === 'SELECT' || input.tagName === 'TEXTAREA') {\r\n                    input.value = value;\r\n                  }\r\n                }\r\n              });\r\n            }\r\n          } catch (e) {\r\n            console.error('Failed to restore on step change:', e);\r\n          }\r\n        }\r\n      }, 50);\r\n    };\r\n    \r\n    form.addEventListener('change', handleChange);\r\n    form.addEventListener('input', handleChange);\r\n    \r\n    // Restore form fields when step changes\r\n    handleStepChange();\r\n    \r\n    return () => {\r\n      form.removeEventListener('change', handleChange);\r\n      form.removeEventListener('input', handleChange);\r\n    };\r\n  }, [selectedRole, hasRestored, saveFormData, step, storageKey]);\r\n\r\n  // Friendly labels and preferred order for the review step\r\n  const reviewLabels: Record<string, string> = {\r\n    role: 'Role',\r\n    tripType: 'Trip type',\r\n    destinations: 'Destination(s)',\r\n    dateFrom: 'From',\r\n    dateTo: 'To',\r\n    groupSize: 'Group size',\r\n    budget: 'Budget',\r\n    notes: 'Notes',\r\n    // Event planner\r\n    eventType: 'Event type',\r\n    expectedAttendees: 'Expected attendees',\r\n    eventStartDate: 'Event start',\r\n    eventEndDate: 'Event end',\r\n    venuePreferences: 'Venue preferences',\r\n    accommodationNeeded: 'Accommodation needed',\r\n    cateringRequired: 'Catering required',\r\n    avRequirements: 'AV / internet',\r\n    budgetPerPerson: 'Budget / person',\r\n    // School\r\n    studentsCount: 'Students',\r\n    chaperones: 'Chaperones',\r\n    ageRange: 'Student age range',\r\n    learningObjectives: 'Learning objectives',\r\n    riskAssessment: 'Risk assessment needed',\r\n    specialNeedsSupport: 'Special needs support',\r\n    // University\r\n    researchPurpose: 'Research purpose',\r\n    staffCount: 'Staff / supervisors',\r\n    studentsCountUniv: 'Students (university)',\r\n    ethicsApproval: 'Ethics ref',\r\n    sampleCollection: 'Collect samples?',\r\n    permitsNeeded: 'Permits likely?',\r\n    // Community\r\n    communityObjectives: 'Community objectives',\r\n    beneficiaries: 'Estimated beneficiaries',\r\n    projectDuration: 'Project duration',\r\n    localPartners: 'Local partners',\r\n    // Other / Tourist\r\n    otherDetails: 'Details',\r\n    // Contact & transport\r\n    fullName: 'Contact name',\r\n    email: 'Email',\r\n    phone: 'Phone',\r\n    transportRequired: 'Transport required?',\r\n    vehicleType: 'Preferred vehicle',\r\n    pickupLocation: 'Pickup',\r\n    dropoffLocation: 'Dropoff',\r\n    vehiclesNeeded: 'Vehicles needed',\r\n    passengerCount: 'Estimated passengers',\r\n    vehicleRequirements: 'Vehicle requirements',\r\n    touristMustHaves: 'Must-have activities',\r\n    touristInterests: 'Interests',\r\n  };\r\n\r\n  const reviewOrder = [\r\n    'role', 'tripType', 'destinations', 'dateFrom', 'dateTo', 'groupSize', 'passengerCount', 'budget', 'notes',\r\n    'fullName', 'email', 'phone', 'transportRequired', 'vehicleType', 'pickupLocation', 'dropoffLocation', 'vehiclesNeeded', 'vehicleRequirements',\r\n  ];\r\n\r\n  const getOrderedReviewKeys = (data: Record<string, string>) => {\r\n    const keys = Object.keys(data);\r\n    const ordered: string[] = [];\r\n    reviewOrder.forEach((k) => { if (keys.includes(k)) ordered.push(k); });\r\n    keys.forEach((k) => { if (!ordered.includes(k)) ordered.push(k); });\r\n    return ordered;\r\n  };\r\n\r\n  const formatLabel = (key: string) => reviewLabels[key] ?? key.replace(/([A-Z])/g, ' $1').replace(/^./, s => s.toUpperCase());\r\n  const formatValue = (v: string | undefined) => {\r\n    if (v == null || v === '') return '-';\r\n    const lower = String(v).toLowerCase();\r\n    if (lower === 'yes' || lower === 'no') return lower === 'yes' ? 'Yes' : 'No';\r\n    return v;\r\n  };\r\n\r\n  const splitCommaList = React.useCallback((raw: string | undefined) => {\r\n    return String(raw || '')\r\n      .split(',')\r\n      .map((s) => s.trim())\r\n      .filter(Boolean);\r\n  }, []);\r\n\r\n  const parseSerializedRouteStopsForReview = React.useCallback((raw: string | undefined) => {\r\n    const text = String(raw || '').trim();\r\n    if (!text) return [] as Array<{ idx: number; place: string; nights?: number }>;\r\n\r\n    // Supports both newline-separated and space-separated formats like:\r\n    // \"1) Serengeti — 6 nights\\n2) Zanzibar — 6 nights\" or\r\n    // \"1) Serengeti — 6 nights 2) Zanzibar — 6 nights\"\r\n    const normalized = text.replace(/\\r\\n/g, '\\n');\r\n    const parts = normalized\r\n      .split(/(?=\\b\\d+\\)\\s)/g)\r\n      .map((s) => s.trim())\r\n      .filter(Boolean);\r\n\r\n    const stops = parts\r\n      .map((part) => {\r\n        const idxMatch = part.match(/^(\\d+)\\)\\s*/);\r\n        const idx = idxMatch ? Number(idxMatch[1]) : NaN;\r\n        const rest = part.replace(/^(\\d+)\\)\\s*/, '').trim();\r\n\r\n        const nightsMatch = rest.match(/—\\s*(\\d+)\\s*night/i) || rest.match(/-\\s*(\\d+)\\s*night/i);\r\n        const nights = nightsMatch ? Number(nightsMatch[1]) : undefined;\r\n\r\n        const place = rest\r\n          .replace(/—\\s*\\d+\\s*nights?/i, '')\r\n          .replace(/-\\s*\\d+\\s*nights?/i, '')\r\n          .trim();\r\n\r\n        if (!place) return null;\r\n        return {\r\n          idx: Number.isFinite(idx) ? idx : 0,\r\n          place,\r\n          nights: Number.isFinite(nights as number) ? nights : undefined,\r\n        };\r\n      })\r\n      .filter(Boolean) as Array<{ idx: number; place: string; nights?: number }>;\r\n\r\n    return stops;\r\n  }, []);\r\n\r\n  const goNext = () => {\r\n    // Save current step data before moving forward\r\n    saveFormData();\r\n    const next = Math.min(totalSteps, step + 1);\r\n    if (next === totalSteps) {\r\n      // Collect all form data for review, including all fields from all steps\r\n      const allFormData = collectFormAsObject();\r\n      setReviewData(allFormData);\r\n    }\r\n    setStep(next);\r\n  };\r\n\r\n  const goBack = () => {\r\n    // Save current step data before moving back\r\n    saveFormData();\r\n    setStep(Math.max(1, step - 1));\r\n  };\r\n\r\n  const goToStep = React.useCallback(\r\n    (target: number) => {\r\n      saveFormData();\r\n      setStep(Math.max(1, Math.min(totalSteps, target)));\r\n    },\r\n    [saveFormData, totalSteps]\r\n  );\r\n\r\n  const handleSubmit = async (e: React.FormEvent) => {\r\n    e.preventDefault();\r\n    if (!formRef.current) return;\r\n    setSubmitting(true);\r\n    \r\n    // Collect all form data - first try from saved sessionStorage (most complete)\r\n    // This ensures we get all fields even if they're on different steps\r\n    let allFormData: Record<string, string> = {};\r\n    try {\r\n      const saved = sessionStorage.getItem(storageKey);\r\n      if (saved) {\r\n        const data = JSON.parse(saved);\r\n        if (data.formData) {\r\n          allFormData = data.formData;\r\n        }\r\n      }\r\n    } catch (e) {\r\n      console.error('Failed to load saved form data:', e);\r\n    }\r\n    \r\n    // Fallback to collecting from current form if saved data is incomplete\r\n    const currentFormData = collectFormAsObject();\r\n    allFormData = { ...allFormData, ...currentFormData };\r\n    \r\n    // Ensure role is set\r\n    allFormData.role = selectedRole ?? '';\r\n    \r\n    // Build FormData from collected data\r\n    const form = new FormData();\r\n    Object.keys(allFormData).forEach((key) => {\r\n      const value = allFormData[key];\r\n      if (value !== null && value !== undefined && value !== '') {\r\n        form.append(key, String(value));\r\n      }\r\n    });\r\n    \r\n    // Debug: Log what's being sent\r\n    console.log('Submitting form data:', {\r\n      role: selectedRole,\r\n      fullName: allFormData.fullName,\r\n      email: allFormData.email,\r\n      phone: allFormData.phone,\r\n      allKeys: Array.from(form.keys()),\r\n      allFormDataKeys: Object.keys(allFormData),\r\n    });\r\n\r\n    try {\r\n      const response = await fetch('/api/plan-request', {\r\n        method: 'POST',\r\n        body: form,\r\n      });\r\n      \r\n      const data = await response.json().catch(() => ({}));\r\n      \r\n      if (!response.ok) {\r\n        console.error('Request failed:', response.status, data);\r\n        throw new Error(data.error || data.message || 'Failed to submit request');\r\n      }\r\n      \r\n      // Reset/clear state BEFORE flipping to the success view.\r\n      // Once submitted=true, the form unmounts and the ref becomes null.\r\n      formRef.current?.reset();\r\n      // clear controlled sync state after successful reset\r\n      setGroupSizeState('');\r\n      setPassengerCount('');\r\n      setTransportRequired('');\r\n      setTripTypeValue('');\r\n      setRouteStops([]);\r\n      setRouteSaved(false);\r\n      setStep(1);\r\n      // Clear saved form data\r\n      try {\r\n        sessionStorage.removeItem(storageKey);\r\n      } catch (e) {\r\n        console.error('Failed to clear saved form data:', e);\r\n      }\r\n      setHasRestored(false);\r\n\r\n      // If the user is logged in, redirect them to their account progress page.\r\n      // This avoids the \"nothing is appearing\" confusion after submit.\r\n      try {\r\n        const meRes = await fetch('/api/account/me', { credentials: 'include' });\r\n        if (meRes.ok) {\r\n          const me = await meRes.json().catch(() => null);\r\n          if (me && typeof me.id === 'number') {\r\n            // Best-effort: attach this newly created request to the logged-in account.\r\n            // This makes the experience more flexible (like Group Stays) even if the initial create\r\n            // couldn't reliably resolve userId due to email/phone formatting.\r\n            try {\r\n              if (data && typeof data.id === 'number') {\r\n                await fetch(`/api/customer/plan-requests/${data.id}/claim`, {\r\n                  method: 'POST',\r\n                  credentials: 'include',\r\n                  headers: { 'Content-Type': 'application/json' },\r\n                  body: JSON.stringify({}),\r\n                });\r\n              }\r\n            } catch {\r\n              // non-blocking\r\n            }\r\n\r\n            setWillRedirectToAccount(true);\r\n            redirectTimerRef.current = window.setTimeout(() => {\r\n              router.push('/account/event-plans');\r\n            }, 1500);\r\n          }\r\n        }\r\n      } catch {\r\n        // non-blocking\r\n      }\r\n\r\n      // Show success message and hide form\r\n      setSubmitted(true);\r\n    } catch (err: any) {\r\n      console.error('Submit error:', err);\r\n      alert(err.message || 'Failed to submit request. Please try again later.');\r\n    } finally {\r\n      setSubmitting(false);\r\n    }\r\n  };\r\n\r\n  // Show confirmation message after successful submission\r\n  if (submitted) {\r\n    return (\r\n      <>\r\n        <style dangerouslySetInnerHTML={{ __html: `\r\n          @keyframes fadeIn {\r\n            from { opacity: 0; }\r\n            to { opacity: 1; }\r\n          }\r\n          @keyframes scaleIn {\r\n            from { opacity: 0; transform: scale(0.8); }\r\n            to { opacity: 1; transform: scale(1); }\r\n          }\r\n          @keyframes slideUp {\r\n            from { opacity: 0; transform: translateY(20px); }\r\n            to { opacity: 1; transform: translateY(0); }\r\n          }\r\n          .success-fade-in { animation: fadeIn 0.5s ease-out; }\r\n          .success-scale-in { animation: scaleIn 0.6s ease-out; }\r\n          .success-slide-up { animation: slideUp 0.6s ease-out 0.2s both; }\r\n          .success-slide-up-delayed { animation: slideUp 0.6s ease-out 0.4s both; }\r\n          .success-fade-in-delayed { animation: fadeIn 0.5s ease-out 0.6s both; }\r\n        `}} />\r\n        <div className=\"bg-white rounded-2xl border border-slate-200 p-8 sm:p-12 shadow-sm success-fade-in\">\r\n          <div className=\"max-w-2xl mx-auto text-center space-y-6\">\r\n            {/* Animated success icon */}\r\n            <div className=\"flex justify-center\">\r\n              <div className=\"h-16 w-16 rounded-full bg-gradient-to-br from-emerald-500 to-emerald-600 flex items-center justify-center shadow-lg success-scale-in\">\r\n                <CheckCircle className=\"h-10 w-10 text-white transition-all duration-300\" strokeWidth={2.5} />\r\n              </div>\r\n            </div>\r\n            \r\n            {/* Heading and description with slide-up animation */}\r\n            <div className=\"space-y-3 success-slide-up\">\r\n              <h2 className=\"text-2xl sm:text-3xl font-bold text-slate-900 tracking-tight\">\r\n                Thank you for planning with NoLSAF!\r\n              </h2>\r\n              <p className=\"text-base sm:text-lg text-slate-600 leading-relaxed\">\r\n                We&apos;ve received your request and our team is currently reviewing it. \r\n                We&apos;ll get back to you within 48 hours with a personalized plan tailored to your needs.\r\n              </p>\r\n            </div>\r\n\r\n            {/* Button with hover and transition effects */}\r\n            <div className=\"pt-4 success-slide-up-delayed\">\r\n              <Link\r\n                href=\"/account/event-plans\"\r\n                className=\"inline-flex items-center justify-center gap-2 bg-emerald-600 hover:bg-emerald-700 text-white font-semibold px-6 py-3 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 active:scale-[0.98] no-underline group\"\r\n              >\r\n                <span>View My Plan Requests</span>\r\n                <ArrowRight className=\"h-5 w-5 transition-transform duration-300 group-hover:translate-x-1\" />\r\n              </Link>\r\n            </div>\r\n\r\n            {/* Footer note */}\r\n            <p className=\"text-sm text-slate-500 pt-2 success-fade-in-delayed\">\r\n              {willRedirectToAccount\r\n                ? \"Redirecting you to your plan requests…\"\r\n                : \"You can track your request status in your account.\"}\r\n            </p>\r\n          </div>\r\n        </div>\r\n      </>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <form ref={formRef} onSubmit={handleSubmit} className=\"space-y-6 bg-white border rounded-lg p-6 shadow-sm\" aria-labelledby={selectedRole ? 'request-form' : undefined}>\r\n      <input type=\"hidden\" name=\"role\" value={selectedRole ?? ''} />\r\n      {selectedRole && (\r\n        <>\r\n          <h2 id=\"request-form\" className=\"text-xl font-semibold\">Your plan details</h2>\r\n          <p className=\"mt-1 text-sm text-slate-600\">Showing questions for <strong className=\"text-slate-800\">{selectedRole}</strong></p>\r\n        </>\r\n      )}\r\n\r\n      {/* Two-column wrapper: show stepper + content only after a role is selected */}\r\n      <div className=\"mt-4 flex items-start gap-6\">\r\n        {selectedRole ? (\r\n          <>\r\n            <div className=\"w-28 pr-4 border-r border-slate-200\">\r\n              <div className=\"flex flex-col items-center gap-4\">\r\n                {['Details', 'Role', 'Transport', 'Review'].map((label, i) => (\r\n                  <div key={label} className=\"flex flex-col items-center\">\r\n                    <div className={`w-10 h-10 rounded-full flex items-center justify-center text-sm font-semibold ${step === i+1 ? 'bg-emerald-600 text-white' : 'bg-gray-100 text-slate-700'}`}>{i+1}</div>\r\n                    <div className=\"mt-2 text-slate-700 text-xs text-center\">{label}</div>\r\n                    {i < 3 && <div className=\"w-px h-6 bg-slate-200 mt-2\"></div>}\r\n                  </div>\r\n                ))}\r\n              </div>\r\n            </div>\r\n\r\n            <div className=\"flex-1\">\r\n\r\n          {step === 1 && (\r\n        <div className=\"rounded-2xl border border-slate-200 bg-gradient-to-b from-white to-slate-50/40 p-5 mb-4 groupstays-section shadow-sm\">\r\n          <div className=\"flex items-center justify-between mb-2\">\r\n            <div className=\"flex items-center gap-2\">\r\n              <div className=\"w-1.5 h-6 bg-emerald-500 rounded-sm\" aria-hidden />\r\n              <div>\r\n                <div className=\"text-sm font-semibold text-slate-900\">Trip details</div>\r\n                <div className=\"text-xs text-slate-500\">Tell us the basics so we can plan</div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"mt-3 grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n            <div>\r\n              <label htmlFor=\"trip-type\" className=\"block text-sm font-medium text-slate-700\">Trip type</label>\r\n              <div className=\"mt-2 relative\">\r\n                <select\r\n                  id=\"trip-type\"\r\n                  name=\"tripType\"\r\n                  value={tripTypeValue}\r\n                  onChange={(e) => setTripTypeValue(e.target.value)}\r\n                  className=\"groupstays-select w-full h-12 rounded-xl px-4 pr-10 border border-slate-200 bg-white text-sm font-medium text-slate-900 shadow-sm focus:outline-none focus:ring-2 focus:ring-emerald-200 focus:border-emerald-300 appearance-none transition\"\r\n                >\r\n                  {tripTypeOptions.map((t) => (\r\n                    <option key={t} value={t}>{t}</option>\r\n                  ))}\r\n                </select>\r\n                <ChevronDown className=\"groupstays-chevron pointer-events-none absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400\" aria-hidden />\r\n              </div>\r\n            </div>\r\n\r\n            <div>\r\n              <label htmlFor=\"destinations\" className=\"block text-sm font-medium text-slate-700\">Destination(s)</label>\r\n              {isMultiDestination ? (\r\n                <div className=\"mt-2 rounded-xl border border-slate-200 bg-white p-4 shadow-sm\">\r\n                  <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3\">\r\n                    <div>\r\n                      <div className=\"flex items-center gap-2\">\r\n                        <span className=\"inline-flex h-8 w-8 items-center justify-center rounded-lg bg-emerald-50 text-emerald-700 border border-emerald-100\">\r\n                          <MapPin className=\"w-4 h-4\" />\r\n                        </span>\r\n                        <div>\r\n                          <div className=\"text-sm font-semibold text-slate-900\">Route builder</div>\r\n                          <div className=\"text-xs text-slate-600\">Add destinations in travel order (Serengeti → Zanzibar). Nights are required per stop.</div>\r\n                        </div>\r\n                      </div>\r\n                    </div>\r\n\r\n                    <div className=\"flex items-center gap-2 justify-end\">\r\n                      {routeSaved ? (\r\n                        <>\r\n                          <button\r\n                            type=\"button\"\r\n                            onClick={() => {\r\n                              setRouteStops([]);\r\n                              setRouteSaved(false);\r\n                            }}\r\n                            className=\"inline-flex items-center gap-2 h-9 px-3 rounded-lg bg-white border border-slate-200 text-slate-700 text-xs font-semibold hover:border-red-200 hover:bg-red-50 hover:text-red-700 transition\"\r\n                            title=\"Clear route\"\r\n                          >\r\n                            <Trash2 className=\"w-4 h-4\" />\r\n                            Clear\r\n                          </button>\r\n\r\n                          <button\r\n                            type=\"button\"\r\n                            onClick={() => {\r\n                              setRouteSaved(false);\r\n                              if (routeStops.length === 0) addRouteStop();\r\n                            }}\r\n                            className=\"inline-flex items-center gap-2 h-9 px-3 rounded-lg bg-emerald-600 text-white text-xs font-semibold hover:bg-emerald-700 transition shadow-sm\"\r\n                          >\r\n                            Edit route\r\n                          </button>\r\n                        </>\r\n                      ) : (\r\n                        <>\r\n                          <button\r\n                            type=\"button\"\r\n                            onClick={() => {\r\n                              setRouteSaveAttempted(true);\r\n                              if (!routeValidation.canSave) return;\r\n                              setRouteSaved(true);\r\n                              setRouteSaveAttempted(false);\r\n                            }}\r\n                            disabled={!routeValidation.canSave}\r\n                            className=\"inline-flex items-center gap-2 h-9 px-3 rounded-lg bg-emerald-600 text-white text-xs font-semibold hover:bg-emerald-700 disabled:opacity-50 disabled:cursor-not-allowed transition shadow-sm\"\r\n                            title=\"Save route and collapse\"\r\n                          >\r\n                            <CheckCircle className=\"w-4 h-4\" />\r\n                            Save route\r\n                          </button>\r\n\r\n                          <button\r\n                            type=\"button\"\r\n                            onClick={() => {\r\n                              setRouteSaved(false);\r\n                              addRouteStop();\r\n                            }}\r\n                            className=\"inline-flex items-center gap-2 h-9 px-3 rounded-lg bg-white border border-slate-200 text-slate-800 text-xs font-semibold hover:bg-slate-50 transition\"\r\n                          >\r\n                            <Plus className=\"w-4 h-4 text-emerald-600\" />\r\n                            Add stop\r\n                          </button>\r\n                        </>\r\n                      )}\r\n                    </div>\r\n                  </div>\r\n\r\n                  {!routeSaved && (routeSaveAttempted || routeValidation.duplicates.length > 0) ? (\r\n                    <div className=\"mt-3\">\r\n                      {routeValidation.duplicates.length > 0 ? (\r\n                        <div className=\"rounded-xl border border-amber-200 bg-amber-50 px-3 py-2 text-xs text-amber-800\">\r\n                          <span className=\"font-semibold\">Duplicate destinations:</span>{' '}\r\n                          {routeValidation.duplicates.slice(0, 3).join(', ')}\r\n                          {routeValidation.duplicates.length > 3 ? '…' : ''}. Please make each stop unique.\r\n                        </div>\r\n                      ) : null}\r\n\r\n                      {routeSaveAttempted && !routeValidation.canSave ? (\r\n                        <div className=\"mt-2 rounded-xl border border-red-200 bg-red-50 px-3 py-2 text-xs text-red-800\">\r\n                          Fill in a destination and nights (minimum 1) for every stop.\r\n                        </div>\r\n                      ) : null}\r\n                    </div>\r\n                  ) : null}\r\n\r\n                  {/* Persist into existing field name for backend compatibility */}\r\n                  <input type=\"hidden\" id=\"destinations\" name=\"destinations\" value={destinationsValue} />\r\n\r\n                  {routeSaved ? (\r\n                    <div className=\"mt-3\">\r\n                      <div className=\"rounded-2xl border border-slate-200 bg-white p-4 shadow-sm\">\r\n                        <div className=\"flex items-start justify-between gap-3\">\r\n                          <div>\r\n                            <div className=\"flex items-center gap-2\">\r\n                              <div className=\"text-sm font-semibold text-slate-900\">Route summary</div>\r\n                              <span className=\"inline-flex items-center rounded-full bg-emerald-50 text-emerald-700 text-xs font-semibold px-2 py-0.5 border border-emerald-100\">\r\n                                Saved\r\n                              </span>\r\n                            </div>\r\n                            {routeValidation.routePath ? (\r\n                              <div className=\"mt-1 text-xs font-semibold text-slate-700\">{routeValidation.routePath}</div>\r\n                            ) : null}\r\n                            <div className=\"mt-1 text-xs text-slate-600\">\r\n                              {cleanedRouteStops.length} stop{cleanedRouteStops.length === 1 ? '' : 's'} • {totalRouteNights} night{totalRouteNights === 1 ? '' : 's'}\r\n                            </div>\r\n                          </div>\r\n                        </div>\r\n\r\n                        <div className=\"mt-4\">\r\n                          <ol className=\"m-0 list-none space-y-3 p-0\">\r\n                            {cleanedRouteStops.map((s, idx) => (\r\n                              <li key={s.id} className=\"relative pl-9 sm:pl-10\">\r\n                                {idx < cleanedRouteStops.length - 1 && (\r\n                                  <span className=\"absolute left-2.5 sm:left-3 top-8 bottom-0 w-px bg-slate-200\" aria-hidden />\r\n                                )}\r\n                                <span\r\n                                  className={\r\n                                    \"absolute left-0 top-0 inline-flex h-7 w-7 sm:h-6 sm:w-6 items-center justify-center rounded-full text-white text-xs font-semibold ring-2 ring-white \" +\r\n                                    (idx % 2 === 0 ? \"bg-emerald-600\" : \"bg-indigo-600\")\r\n                                  }\r\n                                >\r\n                                  {idx + 1}\r\n                                </span>\r\n\r\n                                <div className=\"rounded-xl border border-slate-200 bg-slate-50/60 px-3 sm:px-4 py-3\">\r\n                                  <div className=\"flex flex-col gap-2 sm:flex-row sm:items-start sm:justify-between sm:gap-3\">\r\n                                    <div className=\"min-w-0\">\r\n                                      <div className=\"text-[11px] font-semibold text-slate-600\">Destination</div>\r\n                                      <div className=\"mt-0.5 text-sm font-semibold text-slate-900 break-words\">\r\n                                        {(s.place || '').trim()}\r\n                                      </div>\r\n                                    </div>\r\n\r\n                                    <div className=\"flex items-center justify-between sm:block sm:shrink-0 sm:text-right\">\r\n                                      <div className=\"text-[11px] font-semibold text-slate-600\">Nights</div>\r\n                                      <div className=\"mt-0.5 inline-flex items-center rounded-full bg-emerald-50 text-emerald-700 text-xs font-semibold px-2 py-1 border border-emerald-100\">\r\n                                        {s.nights}\r\n                                      </div>\r\n                                    </div>\r\n                                  </div>\r\n                                </div>\r\n                              </li>\r\n                            ))}\r\n                          </ol>\r\n                        </div>\r\n\r\n                        <div className=\"mt-4 border-t border-slate-100 pt-3 text-xs text-slate-500\">Use Edit route to make changes.</div>\r\n                      </div>\r\n                    </div>\r\n                  ) : (\r\n                    <>\r\n                      {routeStops.length === 0 ? (\r\n                        <div className=\"mt-3 text-xs text-slate-500\">\r\n                          No stops added yet. Click <span className=\"font-semibold\">Add stop</span> to begin.\r\n                        </div>\r\n                      ) : (\r\n                        <div className=\"mt-3 grid grid-cols-1 md:grid-cols-2 gap-3\">\r\n                          {routeStops.map((stop, index) => (\r\n                            <div key={stop.id} className=\"rounded-xl bg-white border border-slate-200 p-4 shadow-sm hover:shadow-md transition-shadow\">\r\n                              <div className=\"flex items-center justify-between gap-2\">\r\n                                <div className=\"flex items-center gap-2\">\r\n                                  <span className=\"inline-flex h-7 w-7 items-center justify-center rounded-full bg-emerald-50 text-emerald-700 border border-emerald-100 text-xs font-bold\">\r\n                                    {index + 1}\r\n                                  </span>\r\n                                  <div className=\"text-xs font-semibold text-slate-700\">Stop</div>\r\n                                </div>\r\n                                <div className=\"flex items-center gap-1\">\r\n                                  <button\r\n                                    type=\"button\"\r\n                                    onClick={() => moveRouteStop(stop.id, -1)}\r\n                                    disabled={index === 0}\r\n                                    className=\"h-9 w-9 inline-flex items-center justify-center rounded-full border-0 bg-transparent text-slate-700 transition-colors active:bg-slate-100 hover:bg-slate-100 disabled:opacity-50 focus:outline-none focus-visible:ring-2 focus-visible:ring-slate-300 focus-visible:ring-offset-2 focus-visible:ring-offset-white\"\r\n                                    title=\"Move up\"\r\n                                  >\r\n                                    <ArrowUp className=\"w-4 h-4 text-slate-500\" />\r\n                                  </button>\r\n                                  <button\r\n                                    type=\"button\"\r\n                                    onClick={() => moveRouteStop(stop.id, 1)}\r\n                                    disabled={index === routeStops.length - 1}\r\n                                    className=\"h-9 w-9 inline-flex items-center justify-center rounded-full border-0 bg-transparent text-slate-700 transition-colors active:bg-slate-100 hover:bg-slate-100 disabled:opacity-50 focus:outline-none focus-visible:ring-2 focus-visible:ring-slate-300 focus-visible:ring-offset-2 focus-visible:ring-offset-white\"\r\n                                    title=\"Move down\"\r\n                                  >\r\n                                    <ArrowDown className=\"w-4 h-4 text-slate-500\" />\r\n                                  </button>\r\n                                  <button\r\n                                    type=\"button\"\r\n                                    onClick={() => removeRouteStop(stop.id)}\r\n                                    className=\"h-9 w-9 inline-flex items-center justify-center rounded-full border-0 bg-transparent text-red-700 transition-colors active:bg-red-50 hover:bg-red-50 focus:outline-none focus-visible:ring-2 focus-visible:ring-red-200 focus-visible:ring-offset-2 focus-visible:ring-offset-white\"\r\n                                    title=\"Remove stop\"\r\n                                  >\r\n                                    <Trash2 className=\"w-4 h-4 text-red-600\" />\r\n                                  </button>\r\n                                </div>\r\n                              </div>\r\n\r\n                              <div className=\"mt-3 grid grid-cols-1 gap-3\">\r\n                                <div>\r\n                                  <label className=\"block text-[11px] font-medium text-slate-600\">Destination / place</label>\r\n                                  <input\r\n                                    value={stop.place}\r\n                                    onChange={(e) => {\r\n                                      const v = e.target.value;\r\n                                      setRouteStops((prev) => prev.map((s) => (s.id === stop.id ? { ...s, place: v } : s)));\r\n                                      setRouteSaved(false);\r\n                                    }}\r\n                                    onBlur={() => {\r\n                                      setRouteTouchedById((prev) => ({ ...prev, [stop.id]: { ...(prev[stop.id] || {}), place: true } }));\r\n                                      setRouteStops((prev) =>\r\n                                        prev.map((s) => (s.id === stop.id ? { ...s, place: (s.place || '').trim() } : s))\r\n                                      );\r\n                                    }}\r\n                                    data-route-stop-place={stop.id}\r\n                                    className={\r\n                                      \"groupstays-select mt-1 w-full rounded-lg px-3 py-2 border bg-white text-sm focus:outline-none focus:ring-2 \" +\r\n                                      (routeSaveAttempted || routeTouchedById[stop.id]?.place\r\n                                        ? !routeValidation.byId[stop.id]?.placeOk\r\n                                          ? \"border-red-300 focus:ring-red-200\"\r\n                                          : routeValidation.byId[stop.id]?.duplicate\r\n                                            ? \"border-amber-300 focus:ring-amber-200\"\r\n                                            : \"border-slate-200 focus:ring-emerald-200\"\r\n                                        : \"border-slate-200 focus:ring-emerald-200\")\r\n                                    }\r\n                                    placeholder=\"e.g. Serengeti National Park\"\r\n                                  />\r\n                                  {(routeSaveAttempted || routeTouchedById[stop.id]?.place) && !routeValidation.byId[stop.id]?.placeOk ? (\r\n                                    <div className=\"mt-1 text-[11px] font-medium text-red-600\">Destination is required.</div>\r\n                                  ) : null}\r\n                                  {(routeSaveAttempted || routeTouchedById[stop.id]?.place) && routeValidation.byId[stop.id]?.duplicate ? (\r\n                                    <div className=\"mt-1 text-[11px] font-medium text-amber-700\">Duplicate destination. Please make it unique.</div>\r\n                                  ) : null}\r\n                                </div>\r\n\r\n                                <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-2\">\r\n                                  <div className=\"sm:col-span-2\">\r\n                                    <label className=\"block text-[11px] font-medium text-slate-600\">Nights <span className=\"text-red-600\">*</span></label>\r\n                                    <input\r\n                                      value={stop.nights}\r\n                                      onChange={(e) => {\r\n                                        const v = e.target.value;\r\n                                        setRouteStops((prev) => prev.map((s) => (s.id === stop.id ? { ...s, nights: v } : s)));\r\n                                        setRouteSaved(false);\r\n                                      }}\r\n                                      onBlur={() => {\r\n                                        setRouteTouchedById((prev) => ({ ...prev, [stop.id]: { ...(prev[stop.id] || {}), nights: true } }));\r\n                                        setRouteStops((prev) =>\r\n                                          prev.map((s) => {\r\n                                            if (s.id !== stop.id) return s;\r\n                                            const n = parseInt((s.nights || '').trim(), 10);\r\n                                            if (!Number.isFinite(n) || n < 1) return { ...s, nights: '' };\r\n                                            return { ...s, nights: String(n) };\r\n                                          })\r\n                                        );\r\n                                      }}\r\n                                      type=\"number\"\r\n                                      min={1}\r\n                                      required\r\n                                      className={\r\n                                        \"groupstays-select mt-1 w-full rounded-lg px-3 py-2 border bg-white text-sm focus:outline-none focus:ring-2 \" +\r\n                                        (routeSaveAttempted || routeTouchedById[stop.id]?.nights\r\n                                          ? !routeValidation.byId[stop.id]?.nightsOk\r\n                                            ? \"border-red-300 focus:ring-red-200\"\r\n                                            : \"border-slate-200 focus:ring-emerald-200\"\r\n                                          : \"border-slate-200 focus:ring-emerald-200\")\r\n                                      }\r\n                                      placeholder=\"e.g. 3\"\r\n                                    />\r\n                                    {(routeSaveAttempted || routeTouchedById[stop.id]?.nights) && !routeValidation.byId[stop.id]?.nightsOk ? (\r\n                                      <div className=\"mt-1 text-[11px] font-medium text-red-600\">Nights must be at least 1.</div>\r\n                                    ) : null}\r\n                                  </div>\r\n                                </div>\r\n                              </div>\r\n                            </div>\r\n                          ))}\r\n                        </div>\r\n                      )}\r\n\r\n                      {destinationsValue ? (\r\n                        <div className=\"mt-3\">\r\n                          <details className=\"rounded-xl border border-slate-200 bg-slate-50 px-3 py-2\">\r\n                            <summary className=\"cursor-pointer text-xs font-semibold text-slate-700\">Generated format (what will be submitted)</summary>\r\n                            <pre className=\"mt-2 whitespace-pre-wrap text-xs text-slate-700\">{destinationsValue}</pre>\r\n                          </details>\r\n                        </div>\r\n                      ) : null}\r\n                    </>\r\n                  )}\r\n                </div>\r\n              ) : (\r\n                <input\r\n                  id=\"destinations\"\r\n                  name=\"destinations\"\r\n                  value={destinationsText}\r\n                  onChange={(e) => setDestinationsText(e.target.value)}\r\n                  onBlur={() => setDestinationsText((v) => v.trim())}\r\n                  className=\"groupstays-select mt-2 w-full h-12 rounded-xl px-4 border border-slate-200 bg-white text-sm text-slate-900 shadow-sm focus:outline-none focus:ring-2 focus:ring-emerald-200 focus:border-emerald-300 transition\"\r\n                  placeholder=\"City, national park, region, or 'Any'\"\r\n                />\r\n              )}\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"mt-3 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4\">\r\n            <div>\r\n              <label htmlFor=\"date-from\" className=\"block text-sm font-medium text-slate-700\">From</label>\r\n              <input type=\"hidden\" id=\"date-from\" name=\"dateFrom\" value={dateFrom} />\r\n              <button\r\n                type=\"button\"\r\n                onClick={() => setDatePickerOpen(true)}\r\n                className=\"relative mt-2 w-full h-12 rounded-xl border border-slate-200 bg-white text-sm text-slate-900 shadow-sm px-4 pl-11 text-left focus:outline-none focus:ring-2 focus:ring-emerald-200 focus:border-emerald-300 hover:bg-emerald-50/30 transition\"\r\n                aria-label=\"Select start date\"\r\n                title=\"Select start date\"\r\n              >\r\n                <Calendar className=\"absolute left-4 top-1/2 -translate-y-1/2 h-4 w-4 text-slate-500\" aria-hidden />\r\n                <span className={dateFrom ? \"text-slate-900\" : \"text-slate-400\"}>\r\n                  {dateFrom ? formatDateDisplay(dateFrom) : \"dd / mm / yyyy\"}\r\n                </span>\r\n              </button>\r\n            </div>\r\n            <div>\r\n              <label htmlFor=\"date-to\" className=\"block text-sm font-medium text-slate-700\">To</label>\r\n              <input type=\"hidden\" id=\"date-to\" name=\"dateTo\" value={dateTo} />\r\n              <button\r\n                type=\"button\"\r\n                onClick={() => setDatePickerOpen(true)}\r\n                className=\"relative mt-2 w-full h-12 rounded-xl border border-slate-200 bg-white text-sm text-slate-900 shadow-sm px-4 pl-11 text-left focus:outline-none focus:ring-2 focus:ring-emerald-200 focus:border-emerald-300 hover:bg-emerald-50/30 transition\"\r\n                aria-label=\"Select end date\"\r\n                title=\"Select end date\"\r\n              >\r\n                <Calendar className=\"absolute left-4 top-1/2 -translate-y-1/2 h-4 w-4 text-slate-500\" aria-hidden />\r\n                <span className={dateTo ? \"text-slate-900\" : \"text-slate-400\"}>\r\n                  {dateTo ? formatDateDisplay(dateTo) : \"dd / mm / yyyy\"}\r\n                </span>\r\n              </button>\r\n            </div>\r\n            <div>\r\n              <label htmlFor=\"group-size\" className=\"block text-sm font-medium text-slate-700\">Group size</label>\r\n              <input id=\"group-size\" name=\"groupSize\" value={groupSizeState} onChange={(e) => { const v = e.target.value; setGroupSizeState(v); setPassengerCount(v); }} className=\"groupstays-select mt-2 w-full h-12 rounded-xl px-4 border border-slate-200 bg-white text-sm text-slate-900 shadow-sm focus:outline-none focus:ring-2 focus:ring-emerald-200 focus:border-emerald-300 transition\" placeholder=\"Number of people\" type=\"number\" min={1} inputMode=\"numeric\" />\r\n            </div>\r\n            <div>\r\n              <label htmlFor=\"budget\" className=\"block text-sm font-medium text-slate-700\">Budget (approx.)</label>\r\n              <input id=\"budget\" name=\"budget\" type=\"hidden\" value={budgetValue} />\r\n\r\n              <div className=\"mt-2\">\r\n                <div className=\"h-12 w-full rounded-xl border border-slate-200 bg-white shadow-sm flex items-stretch overflow-hidden focus-within:ring-2 focus-within:ring-emerald-200 focus-within:border-emerald-300 transition\">\r\n                  <div className=\"relative w-[96px] shrink-0\">\r\n                    <select\r\n                      id=\"budget-currency\"\r\n                      value={budgetCurrency}\r\n                      onChange={(e) => {\r\n                        setBudgetCurrency(e.target.value);\r\n                        if (e.target.value !== 'OTHER') setBudgetCurrencyOther('');\r\n                      }}\r\n                      className=\"groupstays-select h-full w-full bg-transparent border-0 px-3 pr-7 text-sm font-semibold text-slate-900 text-center focus:outline-none appearance-none\"\r\n                      aria-label=\"Budget currency\"\r\n                      title=\"Budget currency\"\r\n                    >\r\n                      {budgetCurrencyOptions.map((c) => (\r\n                        <option key={c} value={c}>\r\n                          {c === 'OTHER' ? 'Other' : c}\r\n                        </option>\r\n                      ))}\r\n                    </select>\r\n                    <ChevronDown className=\"pointer-events-none absolute right-2 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400\" aria-hidden />\r\n                  </div>\r\n\r\n                  <div className=\"w-px bg-slate-200 my-2\" aria-hidden />\r\n\r\n                  <input\r\n                    id=\"budget-amount\"\r\n                    value={budgetAmount}\r\n                    onChange={(e) => setBudgetAmount(e.target.value)}\r\n                    onBlur={() => setBudgetAmount((v) => v.trim())}\r\n                    inputMode=\"decimal\"\r\n                    className=\"h-full flex-1 min-w-0 bg-transparent border-0 px-4 text-sm text-slate-900 placeholder:text-slate-400 focus:outline-none\"\r\n                    placeholder=\"Amount (e.g. 1,500 or 500-800)\"\r\n                    aria-label=\"Budget amount\"\r\n                  />\r\n                </div>\r\n\r\n                {budgetCurrency === 'OTHER' ? (\r\n                  <div className=\"mt-2\">\r\n                    <input\r\n                      id=\"budget-currency-other\"\r\n                      value={budgetCurrencyOther}\r\n                      onChange={(e) => setBudgetCurrencyOther(e.target.value.toUpperCase())}\r\n                      onBlur={() => setBudgetCurrencyOther((v) => v.trim().toUpperCase())}\r\n                      className=\"groupstays-select w-full h-11 rounded-xl px-4 border border-slate-200 bg-white text-sm text-slate-900 shadow-sm focus:outline-none focus:ring-2 focus:ring-emerald-200 focus:border-emerald-300 transition\"\r\n                      placeholder=\"Currency code (e.g. NGN)\"\r\n                      aria-label=\"Other currency\"\r\n                    />\r\n                  </div>\r\n                ) : null}\r\n              </div>\r\n\r\n              <div className=\"mt-1 text-[11px] text-slate-500\">\r\n                Example: {budgetCurrencyEffective || 'USD'} 1500\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          {datePickerOpen && (\r\n            <>\r\n              <div className=\"fixed inset-0 z-40 bg-black/30 backdrop-blur-sm\" onClick={() => setDatePickerOpen(false)} />\r\n              <div className=\"fixed z-50 top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2\">\r\n                <DatePicker\r\n                  selected={dateFrom && dateTo ? [dateFrom, dateTo] : dateFrom ? [dateFrom] : undefined}\r\n                  onSelectAction={(s) => {\r\n                    if (Array.isArray(s) && s.length === 2) {\r\n                      setDateFrom(s[0]);\r\n                      setDateTo(s[1]);\r\n                      setDatePickerOpen(false);\r\n                      return;\r\n                    }\r\n                    const d = Array.isArray(s) ? s[0] : s;\r\n                    if (d) {\r\n                      setDateFrom(d);\r\n                      setDateTo(d);\r\n                      // keep open until user selects end date\r\n                    }\r\n                  }}\r\n                  onCloseAction={() => setDatePickerOpen(false)}\r\n                  allowRange={true}\r\n                />\r\n              </div>\r\n            </>\r\n          )}\r\n\r\n          <div className=\"mt-3\">\r\n            <label htmlFor=\"notes\" className=\"block text-sm font-medium text-slate-700\">Special requirements / notes</label>\r\n            <textarea id=\"notes\" name=\"notes\" className=\"groupstays-select mt-2 w-full rounded-md px-3 py-2 pr-9 border border-slate-200 bg-white text-sm focus:outline-none focus:ring-2 focus:ring-emerald-200\" rows={4} placeholder=\"Dietary requirements, accessibility needs, permits, transport or vehicle requests, etc.\"></textarea>\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      {/* Role-specific sections (expanded) - step 2 */}\r\n      {step === 2 && selectedRole === 'Event planner' && (\r\n        <div className=\"rounded border p-3 mb-4 groupstays-section border-slate-100\" aria-labelledby=\"event-planner-section\">\r\n          <div className=\"flex items-center justify-between mb-2\">\r\n            <div className=\"flex items-center gap-2\">\r\n              <div className=\"w-1.5 h-6 bg-emerald-500 rounded-sm\" aria-hidden />\r\n              <div>\r\n                <div id=\"event-planner-section\" className=\"text-sm font-medium\">For Event Planners</div>\r\n                <div className=\"text-xs text-slate-500\">Provide details about the event so we can suggest suitable venues, services and cost estimates.</div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"mt-3 grid grid-cols-1 md:grid-cols-2 gap-3\">\r\n            <div>\r\n              <label htmlFor=\"event-type\" className=\"block text-xs text-slate-600\">Event type</label>\r\n              <input id=\"event-type\" name=\"eventType\" placeholder=\"Conference, wedding, workshop etc.\" className=\"groupstays-select mt-1 w-full rounded-md px-3 py-2 pr-9 border border-slate-200 bg-white text-sm focus:outline-none focus:ring-2 focus:ring-emerald-200\" />\r\n            </div>\r\n\r\n            <div>\r\n              <label htmlFor=\"expected-attendees\" className=\"block text-xs text-slate-600\">Expected attendees</label>\r\n              <input id=\"expected-attendees\" name=\"expectedAttendees\" placeholder=\"Number of attendees\" type=\"number\" min={1} className=\"groupstays-select mt-1 w-full rounded-md px-3 py-2 pr-9 border border-slate-200 bg-white text-sm focus:outline-none focus:ring-2 focus:ring-emerald-200\" />\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"mt-3 grid grid-cols-1 md:grid-cols-2 gap-3\">\r\n            <div>\r\n              <label htmlFor=\"event-start-date\" className=\"block text-sm font-medium text-slate-700\">Start date</label>\r\n              <input id=\"event-start-date\" name=\"eventStartDate\" type=\"date\" className=\"groupstays-select mt-1 w-full rounded-md px-3 py-2 pr-9 border border-slate-200 bg-white text-sm focus:outline-none focus:ring-2 focus:ring-emerald-200\" />\r\n            </div>\r\n            <div>\r\n              <label htmlFor=\"event-end-date\" className=\"block text-sm font-medium text-slate-700\">End date</label>\r\n              <input id=\"event-end-date\" name=\"eventEndDate\" type=\"date\" className=\"groupstays-select mt-1 w-full rounded-md px-3 py-2 pr-9 border border-slate-200 bg-white text-sm focus:outline-none focus:ring-2 focus:ring-emerald-200\" />\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"mt-3\">\r\n            <label htmlFor=\"venue-preferences\" className=\"block text-xs text-slate-600\">Venue preferences</label>\r\n            <input id=\"venue-preferences\" name=\"venuePreferences\" placeholder=\"Capacity, accessibility, indoor/outdoor, facilities\" className=\"groupstays-select mt-1 w-full rounded-md px-3 py-2 pr-9 border border-slate-200 bg-white text-sm focus:outline-none focus:ring-2 focus:ring-emerald-200\" />\r\n          </div>\r\n\r\n          <div className=\"mt-3 grid grid-cols-1 md:grid-cols-2 gap-3\">\r\n            <div>\r\n              <label htmlFor=\"accommodation-needed\" className=\"block text-sm font-medium text-slate-700\">Accommodation needed?</label>\r\n              <div className=\"relative mt-1\">\r\n                <select id=\"accommodation-needed\" name=\"accommodationNeeded\" className=\"groupstays-select w-full rounded-md px-3 py-2 pr-9 border border-slate-200 bg-white text-sm focus:outline-none focus:ring-2 focus:ring-emerald-200\">\r\n                  <option value=\"\">Select an option</option>\r\n                  <option value=\"yes\">Yes</option>\r\n                  <option value=\"no\">No</option>\r\n                </select>\r\n                <ChevronDown className=\"groupstays-chevron pointer-events-none absolute right-2 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400\" aria-hidden />\r\n              </div>\r\n            </div>\r\n\r\n            <div>\r\n              <label htmlFor=\"catering-required\" className=\"block text-sm font-medium text-slate-700\">Catering required?</label>\r\n              <div className=\"relative mt-1\">\r\n                <select id=\"catering-required\" name=\"cateringRequired\" className=\"groupstays-select w-full rounded-md px-3 py-2 pr-9 border border-slate-200 bg-white text-sm focus:outline-none focus:ring-2 focus:ring-emerald-200\">\r\n                  <option value=\"\">Select an option</option>\r\n                  <option value=\"yes\">Yes</option>\r\n                  <option value=\"no\">No</option>\r\n                </select>\r\n                <ChevronDown className=\"groupstays-chevron pointer-events-none absolute right-2 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400\" aria-hidden />\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"mt-3 grid grid-cols-1 md:grid-cols-2 gap-3\">\r\n            <div>\r\n              <label htmlFor=\"av-requirements\" className=\"block text-xs text-slate-600\">AV / power / internet requirements</label>\r\n              <input id=\"av-requirements\" name=\"avRequirements\" placeholder=\"Microphones, projectors, power, connectivity\" className=\"groupstays-select mt-1 w-full rounded-md px-3 py-2 pr-9 border border-slate-200 bg-white text-sm focus:outline-none focus:ring-2 focus:ring-emerald-200\" />\r\n            </div>\r\n            <div>\r\n              <label htmlFor=\"budget-per-person\" className=\"block text-xs text-slate-600\">Target budget per person</label>\r\n              <input id=\"budget-per-person\" name=\"budgetPerPerson\" placeholder=\"USD or local currency\" className=\"groupstays-select mt-1 w-full rounded-md px-3 py-2 pr-9 border border-slate-200 bg-white text-sm focus:outline-none focus:ring-2 focus:ring-emerald-200\" />\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      {step === 2 && selectedRole === 'School / Teacher' && (\r\n        <div className=\"rounded border p-3 mb-4 groupstays-section border-slate-100\" aria-labelledby=\"school-section\">\r\n          <div className=\"flex items-center justify-between mb-2\">\r\n            <div className=\"flex items-center gap-2\">\r\n              <div className=\"w-1.5 h-6 bg-emerald-500 rounded-sm\" aria-hidden />\r\n              <div>\r\n                <div className=\"text-sm font-medium\">For Schools / Teachers</div>\r\n                <div className=\"text-xs text-slate-500\">Tell us about group numbers, learning goals and any special requirements for school trips.</div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"mt-3 grid grid-cols-1 md:grid-cols-2 gap-3\">\r\n            <div>\r\n              <label htmlFor=\"studentsCount\" className=\"block text-xs text-slate-600\">Number of students</label>\r\n              <input id=\"studentsCount\" name=\"studentsCount\" type=\"number\" className=\"groupstays-select mt-1 w-full rounded-md px-3 py-2 pr-9 border border-slate-200 bg-white text-sm focus:outline-none focus:ring-2 focus:ring-emerald-200\" />\r\n            </div>\r\n            <div>\r\n              <label htmlFor=\"chaperones\" className=\"block text-xs text-slate-600\">Number of chaperones</label>\r\n              <input id=\"chaperones\" name=\"chaperones\" type=\"number\" className=\"groupstays-select mt-1 w-full rounded-md px-3 py-2 pr-9 border border-slate-200 bg-white text-sm focus:outline-none focus:ring-2 focus:ring-emerald-200\" />\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"mt-3 grid grid-cols-1 md:grid-cols-2 gap-3\">\r\n            <div>\r\n              <label htmlFor=\"ageRange\" className=\"block text-xs text-slate-600\">Student age range</label>\r\n              <input id=\"ageRange\" name=\"ageRange\" placeholder=\"e.g. 12-15\" className=\"groupstays-select mt-1 w-full rounded-md px-3 py-2 pr-9 border border-slate-200 bg-white text-sm focus:outline-none focus:ring-2 focus:ring-emerald-200\" />\r\n            </div>\r\n            <div>\r\n              <label htmlFor=\"learningObjectives\" className=\"block text-xs text-slate-600\">Learning objectives / curriculum links</label>\r\n              <input id=\"learningObjectives\" name=\"learningObjectives\" placeholder=\"Curriculum links or goals\" className=\"groupstays-select mt-1 w-full rounded-md px-3 py-2 pr-9 border border-slate-200 bg-white text-sm focus:outline-none focus:ring-2 focus:ring-emerald-200\" />\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"mt-3 grid grid-cols-1 md:grid-cols-2 gap-3\">\r\n            <div>\r\n              <label htmlFor=\"risk-assessment\" className=\"block text-xs text-slate-600\">Risk assessment needed?</label>\r\n              <div className=\"relative mt-1\">\r\n                <select id=\"risk-assessment\" name=\"riskAssessment\" className=\"groupstays-select w-full rounded-md px-3 py-2 pr-9 border border-slate-200 bg-white text-sm focus:outline-none focus:ring-2 focus:ring-emerald-200\">\r\n                  <option value=\"\">Select an option</option>\r\n                  <option value=\"yes\">Yes</option>\r\n                  <option value=\"no\">No</option>\r\n                </select>\r\n                <ChevronDown className=\"groupstays-chevron pointer-events-none absolute right-2 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400\" aria-hidden />\r\n              </div>\r\n            </div>\r\n            <div>\r\n              <label htmlFor=\"special-needs-support\" className=\"block text-xs text-slate-600\">Special needs support required?</label>\r\n              <div className=\"relative mt-1\">\r\n                <select id=\"special-needs-support\" name=\"specialNeedsSupport\" className=\"groupstays-select w-full rounded-md px-3 py-2 pr-9 border border-slate-200 bg-white text-sm focus:outline-none focus:ring-2 focus:ring-emerald-200\">\r\n                  <option value=\"\">Select an option</option>\r\n                  <option value=\"yes\">Yes</option>\r\n                  <option value=\"no\">No</option>\r\n                </select>\r\n                <ChevronDown className=\"groupstays-chevron pointer-events-none absolute right-2 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400\" aria-hidden />\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      {step === 2 && selectedRole === 'University' && (\r\n        <div className=\"rounded border p-3 mb-4 groupstays-section border-slate-100\" aria-labelledby=\"university-section\">\r\n          <div className=\"flex items-center justify-between mb-2\">\r\n            <div className=\"flex items-center gap-2\">\r\n              <div className=\"w-1.5 h-6 bg-emerald-500 rounded-sm\" aria-hidden />\r\n              <div>\r\n                <div id=\"university-section\" className=\"text-sm font-medium\">For Universities</div>\r\n                <div className=\"text-xs text-slate-500\">For research or fieldwork visits: share project aims, permits and staff involved.</div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"mt-3\">\r\n            <label htmlFor=\"research-purpose\" className=\"block text-xs text-slate-600\">Research purpose / project description</label>\r\n            <input id=\"research-purpose\" name=\"researchPurpose\" placeholder=\"Brief project summary, aims and methods\" className=\"groupstays-select mt-1 w-full rounded-md px-3 py-2 pr-9 border border-slate-200 bg-white text-sm focus:outline-none focus:ring-2 focus:ring-emerald-200\" />\r\n          </div>\r\n\r\n          <div className=\"mt-3 grid grid-cols-1 md:grid-cols-2 gap-3\">\r\n            <div>\r\n              <label htmlFor=\"staff-count\" className=\"block text-xs text-slate-600\">Staff / supervisors count</label>\r\n              <input id=\"staff-count\" name=\"staffCount\" placeholder=\"Number of staff\" type=\"number\" min={0} className=\"groupstays-select mt-1 w-full rounded-md px-3 py-2 pr-9 border border-slate-200 bg-white text-sm focus:outline-none focus:ring-2 focus:ring-emerald-200\" />\r\n            </div>\r\n            <div>\r\n              <label htmlFor=\"students-count-univ\" className=\"block text-xs text-slate-600\">Number of students involved</label>\r\n              <input id=\"students-count-univ\" name=\"studentsCountUniv\" placeholder=\"Number of students\" type=\"number\" min={0} className=\"groupstays-select mt-1 w-full rounded-md px-3 py-2 pr-9 border border-slate-200 bg-white text-sm focus:outline-none focus:ring-2 focus:ring-emerald-200\" />\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"mt-3\">\r\n            <label htmlFor=\"ethics-approval\" className=\"block text-xs text-slate-600\">Ethics approval reference (if any)</label>\r\n            <input id=\"ethics-approval\" name=\"ethicsApproval\" placeholder=\"Reference or N/A\" className=\"groupstays-select mt-1 w-full rounded-md px-3 py-2 pr-9 border border-slate-200 bg-white text-sm focus:outline-none focus:ring-2 focus:ring-emerald-200\" />\r\n          </div>\r\n\r\n          <div className=\"mt-3 grid grid-cols-1 md:grid-cols-2 gap-3\">\r\n            <div>\r\n              <label htmlFor=\"sample-collection\" className=\"block text-sm font-medium text-slate-700\">Collect samples?</label>\r\n              <div className=\"relative mt-1\">\r\n                <select id=\"sample-collection\" name=\"sampleCollection\" className=\"groupstays-select w-full rounded-md px-3 py-2 pr-9 border border-slate-200 bg-white text-sm focus:outline-none focus:ring-2 focus:ring-emerald-200\">\r\n                  <option value=\"\">Select an option</option>\r\n                  <option value=\"yes\">Yes</option>\r\n                  <option value=\"no\">No</option>\r\n                </select>\r\n                <ChevronDown className=\"groupstays-chevron pointer-events-none absolute right-2 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400\" aria-hidden />\r\n              </div>\r\n            </div>\r\n\r\n            <div>\r\n              <label htmlFor=\"permits-needed\" className=\"block text-sm font-medium text-slate-700\">Permits likely needed?</label>\r\n              <div className=\"relative mt-1\">\r\n                <select id=\"permits-needed\" name=\"permitsNeeded\" className=\"groupstays-select w-full rounded-md px-3 py-2 pr-9 border border-slate-200 bg-white text-sm focus:outline-none focus:ring-2 focus:ring-emerald-200\">\r\n                  <option value=\"\">Select an option</option>\r\n                  <option value=\"yes\">Yes</option>\r\n                  <option value=\"no\">No</option>\r\n                </select>\r\n                <ChevronDown className=\"groupstays-chevron pointer-events-none absolute right-2 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400\" aria-hidden />\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      {step === 2 && selectedRole === 'Community group' && (\r\n        <div className=\"rounded border p-3 mb-4 groupstays-section border-slate-100\" aria-labelledby=\"community-section\">\r\n          <div className=\"flex items-center justify-between mb-2\">\r\n            <div className=\"flex items-center gap-2\">\r\n              <div className=\"w-1.5 h-6 bg-emerald-500 rounded-sm\" aria-hidden />\r\n              <div>\r\n                <div id=\"community-section\" className=\"text-sm font-medium\">For Community Groups</div>\r\n                <div className=\"text-xs text-slate-500\">Share objectives, beneficiaries and local partnerships to help us recommend sustainable options.</div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"mt-3\">\r\n            <label htmlFor=\"community-objectives\" className=\"block text-xs text-slate-600\">Community objectives / program description</label>\r\n            <input id=\"community-objectives\" name=\"communityObjectives\" placeholder=\"Brief description of objectives\" className=\"groupstays-select mt-1 w-full rounded-md px-3 py-2 pr-9 border border-slate-200 bg-white text-sm focus:outline-none focus:ring-2 focus:ring-emerald-200\" />\r\n          </div>\r\n\r\n          <div className=\"mt-3 grid grid-cols-1 md:grid-cols-2 gap-3\">\r\n            <div>\r\n              <label htmlFor=\"beneficiaries\" className=\"block text-xs text-slate-600\">Estimated beneficiaries</label>\r\n              <input id=\"beneficiaries\" name=\"beneficiaries\" placeholder=\"Number of beneficiaries\" type=\"number\" min={0} className=\"groupstays-select mt-1 w-full rounded-md px-3 py-2 pr-9 border border-slate-200 bg-white text-sm focus:outline-none focus:ring-2 focus:ring-emerald-200\" />\r\n            </div>\r\n            <div>\r\n              <label htmlFor=\"project-duration\" className=\"block text-xs text-slate-600\">Project duration</label>\r\n              <input id=\"project-duration\" name=\"projectDuration\" placeholder=\"Days / weeks\" className=\"groupstays-select mt-1 w-full rounded-md px-3 py-2 pr-9 border border-slate-200 bg-white text-sm focus:outline-none focus:ring-2 focus:ring-emerald-200\" />\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"mt-3\">\r\n            <label htmlFor=\"local-partners\" className=\"block text-xs text-slate-600\">Local partners or contacts</label>\r\n            <input id=\"local-partners\" name=\"localPartners\" placeholder=\"Local organisations or contact people\" className=\"groupstays-select mt-1 w-full rounded-md px-3 py-2 pr-9 border border-slate-200 bg-white text-sm focus:outline-none focus:ring-2 focus:ring-emerald-200\" />\r\n          </div>\r\n\r\n          {/* Funding status removed per product decision */}\r\n        </div>\r\n      )}\r\n\r\n      {step === 2 && selectedRole === 'Other' && (\r\n        <div className=\"rounded border p-3 mb-4 groupstays-section border-slate-100\" aria-labelledby=\"other-section\">\r\n          <div className=\"flex items-center justify-between mb-2\">\r\n            <div className=\"flex items-center gap-2\">\r\n              <div className=\"w-1.5 h-6 bg-emerald-500 rounded-sm\" aria-hidden />\r\n              <div>\r\n                <div id=\"other-section\" className=\"text-sm font-medium\">Other details</div>\r\n                <div className=\"text-xs text-slate-500\">If your request does not match the categories, describe your needs so we can route it correctly.</div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"mt-3\">\r\n            <label htmlFor=\"other-details\" className=\"block text-xs text-slate-600\">Describe your request</label>\r\n            <textarea id=\"other-details\" name=\"otherDetails\" placeholder=\"Tell us more about your request\" rows={4} className=\"groupstays-select mt-1 w-full rounded-md px-3 py-2 pr-9 border border-slate-200 bg-white text-sm focus:outline-none focus:ring-2 focus:ring-emerald-200\" />\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      {step === 2 && selectedRole === 'Tourist' && (\r\n        <div className=\"rounded-2xl border border-slate-200 bg-gradient-to-b from-white to-slate-50/40 p-5 mb-4 groupstays-section shadow-sm\" aria-labelledby=\"tourist-section\">\r\n          <div className=\"flex items-center justify-between mb-2\">\r\n            <div className=\"flex items-center gap-2\">\r\n              <div className=\"w-1.5 h-6 bg-emerald-500 rounded-sm\" aria-hidden />\r\n              <div>\r\n                <div id=\"tourist-section\" className=\"text-sm font-semibold text-slate-900\">For Tourists</div>\r\n                <div className=\"text-xs text-slate-500\">Pick a few options (fast) and we’ll tailor the itinerary around your preferences.</div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          <input type=\"hidden\" name=\"touristMustHaves\" value={touristMustHaves.join(', ')} />\r\n          <input type=\"hidden\" name=\"touristInterests\" value={touristInterests.join(', ')} />\r\n\r\n          <div className=\"mt-4 rounded-2xl border border-slate-200 bg-white/70 backdrop-blur p-5 shadow-sm\">\r\n            <div className=\"flex items-start justify-between gap-3\">\r\n              <div className=\"flex items-start gap-3\">\r\n                <div className=\"mt-0.5 w-1.5 h-10 bg-amber-400 rounded-sm\" aria-hidden />\r\n                <div>\r\n                  <div className=\"text-sm font-semibold text-slate-900\">Must-have activities</div>\r\n                  <div className=\"mt-0.5 text-xs text-slate-500\">\r\n                    We suggest experiences based on your destination(s) in East Africa.\r\n                  </div>\r\n                </div>\r\n              </div>\r\n              {touristMustHaves.length > 0 ? (\r\n                <button\r\n                  type=\"button\"\r\n                  onClick={() => setTouristMustHaves([])}\r\n                  className=\"inline-flex items-center gap-2 h-9 px-4 rounded-full border border-slate-200 bg-white text-xs font-semibold text-slate-700 shadow-sm hover:bg-slate-50 hover:border-slate-300 hover:shadow-md transition focus:outline-none focus-visible:ring-2 focus-visible:ring-slate-300 focus-visible:ring-offset-2 focus-visible:ring-offset-white\"\r\n                >\r\n                  <Trash2 className=\"w-4 h-4 text-slate-500\" aria-hidden />\r\n                  Clear\r\n                </button>\r\n              ) : null}\r\n            </div>\r\n\r\n            <div className=\"mt-4 rounded-2xl border border-slate-200 bg-gradient-to-b from-white to-slate-50/70 p-4\">\r\n              <div className=\"flex items-center justify-between gap-2\">\r\n                <div className=\"text-[11px] font-semibold text-slate-700\">Selected ({touristMustHaves.length})</div>\r\n                <div className=\"text-[11px] font-semibold text-slate-500\">Tap again to remove</div>\r\n              </div>\r\n              {touristMustHaves.length > 0 ? (\r\n                <div className=\"mt-3 flex flex-wrap gap-2\">\r\n                  {touristMustHaves.map((opt) => (\r\n                    <button\r\n                      key={opt}\r\n                      type=\"button\"\r\n                      onClick={() => setTouristMustHaves((prev) => toggleSelection(prev, opt))}\r\n                      className={\r\n                        activityChipBaseClass +\r\n                        ' bg-amber-100 text-amber-950 border-amber-400 ring-1 ring-amber-300/40 hover:bg-amber-100 hover:border-amber-500'\r\n                      }\r\n                      title=\"Remove\"\r\n                    >\r\n                      <CheckCircle className=\"w-4 h-4 text-amber-700\" aria-hidden />\r\n                      {opt}\r\n                    </button>\r\n                  ))}\r\n                </div>\r\n              ) : (\r\n                <div className=\"mt-3 rounded-xl border border-dashed border-slate-200 bg-white/70 px-4 py-3 text-xs text-slate-600\">\r\n                  No selections yet — choose a few suggestions below.\r\n                </div>\r\n              )}\r\n            </div>\r\n\r\n            {selectedDestinationInputs.length > 0 ? (\r\n              <div className=\"mt-4\">\r\n                <div className=\"flex items-center justify-between gap-3\">\r\n                  <div className=\"text-[11px] font-semibold text-slate-600\">Destinations detected</div>\r\n                  {destinationActivityContext.unmatched.length > 0 ? (\r\n                    <div className=\"text-[11px] font-semibold text-slate-500\">Some places may show generic ideas</div>\r\n                  ) : null}\r\n                </div>\r\n                <div className=\"mt-2 rounded-2xl border border-slate-200 bg-white p-3 shadow-sm\">\r\n                  <div className=\"flex gap-2 overflow-x-auto whitespace-nowrap [-webkit-overflow-scrolling:touch]\">\r\n                    {destinationActivityContext.matched.map((d) => {\r\n                      const accent = getDestinationAccent(d.id);\r\n                      return (\r\n                      <span\r\n                        key={d.id}\r\n                        className={\r\n                          \"inline-flex shrink-0 items-center gap-2 rounded-full border px-3 py-1.5 text-xs font-semibold \" +\r\n                          accent.destinationPill\r\n                        }\r\n                      >\r\n                        <MapPin className={\"w-3.5 h-3.5 \" + accent.headerIcon} aria-hidden />\r\n                        <span className=\"tracking-tight\">{d.label}</span>\r\n                        <span className={\"text-[11px] font-semibold \" + accent.destinationPillSubtle}>{d.countryLabel}</span>\r\n                      </span>\r\n                      );\r\n                    })}\r\n                    {destinationActivityContext.unmatched.slice(0, 3).map((u) => (\r\n                      <span\r\n                        key={u}\r\n                        className=\"inline-flex shrink-0 items-center gap-2 rounded-full bg-slate-50 text-slate-700 border border-slate-200 px-3 py-1.5 text-xs font-semibold\"\r\n                        title=\"We’ll still plan for this, but suggestions may be generic.\"\r\n                      >\r\n                        <MapPin className=\"w-3.5 h-3.5 text-slate-400\" aria-hidden />\r\n                        {u}\r\n                      </span>\r\n                    ))}\r\n                    {destinationActivityContext.unmatched.length > 3 ? (\r\n                      <span className=\"inline-flex shrink-0 items-center rounded-full bg-white text-slate-600 border border-slate-200 px-3 py-1.5 text-xs font-semibold\">\r\n                        +{destinationActivityContext.unmatched.length - 3} more\r\n                      </span>\r\n                    ) : null}\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            ) : (\r\n              <div className=\"mt-4 rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-xs text-slate-600\">\r\n                Add your destination(s) above to see activity suggestions.\r\n              </div>\r\n            )}\r\n\r\n            <div className=\"mt-5 space-y-5\">\r\n              {destinationActivityContext.matched.length > 0 ? (\r\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-3\">\r\n                  {destinationActivityContext.matched.map((d) => {\r\n                    const accent = getDestinationAccent(d.id);\r\n                    return (\r\n                    <div\r\n                      key={d.id}\r\n                      className=\"rounded-2xl border border-slate-200 bg-white p-4 shadow-sm hover:shadow-md transition\"\r\n                    >\r\n                      <div className=\"flex items-center justify-between gap-3\">\r\n                        <div className=\"flex items-center gap-2 min-w-0\">\r\n                          <div className={\"inline-flex h-8 w-8 items-center justify-center rounded-xl border \" + accent.headerIconWrap}>\r\n                            <MapPin className={\"w-4 h-4 \" + accent.headerIcon} aria-hidden />\r\n                          </div>\r\n                          <div className=\"min-w-0\">\r\n                            <div className=\"text-sm font-semibold text-slate-900 truncate\">{d.label}</div>\r\n                            <div className=\"text-[11px] font-semibold text-slate-500\">{d.countryLabel}</div>\r\n                          </div>\r\n                        </div>\r\n                        <div className=\"text-[11px] font-semibold text-slate-500\">Top picks</div>\r\n                      </div>\r\n                      <div className=\"mt-3 flex flex-wrap gap-2\">\r\n                        {d.activities.map((opt) => {\r\n                          const active = touristMustHaves.includes(opt);\r\n                          return (\r\n                            <button\r\n                              key={opt}\r\n                              type=\"button\"\r\n                              onClick={() => setTouristMustHaves((prev) => toggleSelection(prev, opt))}\r\n                              className={\r\n                                activityChipBaseClass +\r\n                                (active\r\n                                  ? accent.chipActive\r\n                                  : accent.chipInactive)\r\n                              }\r\n                            >\r\n                              {active ? <CheckCircle className={\"w-4 h-4 \" + accent.iconActive} aria-hidden /> : null}\r\n                              {opt}\r\n                            </button>\r\n                          );\r\n                        })}\r\n                      </div>\r\n                    </div>\r\n                    );\r\n                  })}\r\n                </div>\r\n              ) : null}\r\n\r\n              {popularMustHavesFiltered.length > 0 ? (\r\n                <details className=\"rounded-2xl border border-slate-200 bg-white p-4 shadow-sm\">\r\n                  <summary className=\"cursor-pointer list-none select-none\">\r\n                    <div className=\"flex items-center justify-between gap-3\">\r\n                      <div>\r\n                        <div className=\"text-sm font-semibold text-slate-900\">More ideas</div>\r\n                        <div className=\"mt-0.5 text-[11px] text-slate-500\">Popular in East Africa</div>\r\n                      </div>\r\n                      <div className=\"text-[11px] font-semibold text-slate-600\">{popularMustHavesFiltered.length} options</div>\r\n                    </div>\r\n                  </summary>\r\n                  <div className=\"mt-3 flex flex-wrap gap-2\">\r\n                    {popularMustHavesFiltered.map((opt) => {\r\n                      const active = touristMustHaves.includes(opt);\r\n                      return (\r\n                        <button\r\n                          key={opt}\r\n                          type=\"button\"\r\n                          onClick={() => setTouristMustHaves((prev) => toggleSelection(prev, opt))}\r\n                          className={\r\n                            activityChipBaseClass +\r\n                            (active\r\n                              ? ' bg-amber-100 text-amber-950 border-amber-400 ring-1 ring-amber-300/40 hover:bg-amber-100 hover:border-amber-500'\r\n                              : ' bg-white text-slate-900 border-slate-200 hover:bg-slate-50 hover:border-slate-300')\r\n                          }\r\n                        >\r\n                          {active ? <CheckCircle className=\"w-4 h-4 text-amber-700\" aria-hidden /> : null}\r\n                          {opt}\r\n                        </button>\r\n                      );\r\n                    })}\r\n                  </div>\r\n                </details>\r\n              ) : null}\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"mt-4 rounded-2xl border border-slate-200 bg-white/70 backdrop-blur p-5 shadow-sm\">\r\n            <div className=\"flex items-start justify-between gap-3\">\r\n              <div className=\"flex items-start gap-3\">\r\n                <div className=\"mt-0.5 w-1.5 h-10 bg-sky-400 rounded-sm\" aria-hidden />\r\n                <div>\r\n                  <div className=\"text-sm font-semibold text-slate-900\">Interests</div>\r\n                  <div className=\"mt-0.5 text-xs text-slate-500\">Choose a few themes so we match the vibe.</div>\r\n                </div>\r\n              </div>\r\n              {touristInterests.length > 0 ? (\r\n                <button\r\n                  type=\"button\"\r\n                  onClick={() => setTouristInterests([])}\r\n                  className=\"inline-flex items-center gap-2 h-9 px-4 rounded-full border border-slate-200 bg-white text-xs font-semibold text-slate-700 shadow-sm hover:bg-slate-50 hover:border-slate-300 hover:shadow-md transition focus:outline-none focus-visible:ring-2 focus-visible:ring-slate-300 focus-visible:ring-offset-2 focus-visible:ring-offset-white\"\r\n                >\r\n                  <Trash2 className=\"w-4 h-4 text-slate-500\" aria-hidden />\r\n                  Clear\r\n                </button>\r\n              ) : null}\r\n            </div>\r\n\r\n            <div className=\"mt-4 rounded-2xl border border-slate-200 bg-gradient-to-b from-white to-slate-50/70 p-4\">\r\n              <div className=\"flex items-center justify-between gap-2\">\r\n                <div className=\"text-[11px] font-semibold text-slate-700\">Selected ({touristInterests.length})</div>\r\n                <div className=\"text-[11px] font-semibold text-slate-500\">Tap again to remove</div>\r\n              </div>\r\n              {touristInterests.length > 0 ? (\r\n                <div className=\"mt-3 flex flex-wrap gap-2\">\r\n                  {touristInterests.map((opt) => (\r\n                    <button\r\n                      key={opt}\r\n                      type=\"button\"\r\n                      onClick={() => setTouristInterests((prev) => toggleSelection(prev, opt))}\r\n                      className={\r\n                        activityChipBaseClass +\r\n                        touristPrimaryAccent.chipActive\r\n                      }\r\n                      title=\"Remove\"\r\n                    >\r\n                      <CheckCircle className={\"w-4 h-4 \" + touristPrimaryAccent.iconActive} aria-hidden />\r\n                      {opt}\r\n                    </button>\r\n                  ))}\r\n                </div>\r\n              ) : (\r\n                <div className=\"mt-3 rounded-xl border border-dashed border-slate-200 bg-white/70 px-4 py-3 text-xs text-slate-600\">\r\n                  No interests selected yet — pick a couple below.\r\n                </div>\r\n              )}\r\n            </div>\r\n\r\n            <div className=\"mt-4 flex flex-wrap gap-2\">\r\n              {touristInterestOptions.map((opt) => {\r\n                const active = touristInterests.includes(opt);\r\n                return (\r\n                  <button\r\n                    key={opt}\r\n                    type=\"button\"\r\n                    onClick={() => setTouristInterests((prev) => toggleSelection(prev, opt))}\r\n                    className={\r\n                      activityChipBaseClass +\r\n                      (active\r\n                        ? touristPrimaryAccent.chipActive\r\n                        : touristPrimaryAccent.chipInactive)\r\n                    }\r\n                  >\r\n                    {active ? <CheckCircle className={\"w-4 h-4 \" + touristPrimaryAccent.iconActive} aria-hidden /> : null}\r\n                    {opt}\r\n                  </button>\r\n                );\r\n              })}\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"mt-4 rounded-2xl border border-slate-200 bg-white p-4 shadow-sm\">\r\n            <div className=\"flex items-start justify-between gap-3\">\r\n              <div>\r\n                <div className=\"text-sm font-semibold text-slate-900\">Quick summary</div>\r\n                <div className=\"mt-0.5 text-xs text-slate-500\">Your selected must-haves (tap to remove).</div>\r\n              </div>\r\n              <div className=\"flex items-center gap-2\">\r\n                <span className=\"inline-flex items-center rounded-full border border-slate-200 bg-slate-50 px-3 py-1 text-[11px] font-semibold text-slate-700\">\r\n                  {touristMustHaves.length} selected\r\n                </span>\r\n                {touristMustHaves.length > 0 ? (\r\n                  <button\r\n                    type=\"button\"\r\n                    onClick={() => setTouristMustHaves([])}\r\n                    className=\"inline-flex items-center gap-2 h-8 px-3 rounded-full border border-slate-200 bg-white text-[11px] font-semibold text-slate-700 shadow-sm hover:bg-slate-50 hover:border-slate-300 transition focus:outline-none focus-visible:ring-2 focus-visible:ring-slate-300 focus-visible:ring-offset-2 focus-visible:ring-offset-white\"\r\n                  >\r\n                    <Trash2 className=\"w-4 h-4 text-slate-500\" aria-hidden />\r\n                    Clear\r\n                  </button>\r\n                ) : null}\r\n              </div>\r\n            </div>\r\n\r\n            {touristMustHaves.length > 0 ? (\r\n              <div className=\"mt-3 flex flex-wrap gap-2\">\r\n                {touristMustHaves.map((opt) => (\r\n                  <button\r\n                    key={opt}\r\n                    type=\"button\"\r\n                    onClick={() => setTouristMustHaves((prev) => toggleSelection(prev, opt))}\r\n                    className={\r\n                      activityChipBaseClass +\r\n                      ' bg-slate-50 text-slate-900 border-slate-200 hover:bg-slate-100 hover:border-slate-300'\r\n                    }\r\n                    title=\"Remove\"\r\n                  >\r\n                    <CheckCircle className=\"w-4 h-4 text-slate-500\" aria-hidden />\r\n                    {opt}\r\n                  </button>\r\n                ))}\r\n              </div>\r\n            ) : (\r\n              <div className=\"mt-3 rounded-xl border border-dashed border-slate-200 bg-slate-50 px-4 py-3 text-xs text-slate-600\">\r\n                No must-haves selected yet.\r\n              </div>\r\n            )}\r\n          </div>\r\n\r\n          <div className=\"mt-3\">\r\n            <details className=\"rounded-xl border border-slate-200 bg-white p-4 shadow-sm\">\r\n              <summary className=\"cursor-pointer text-xs font-semibold text-slate-800\">Add extra notes (optional)</summary>\r\n              <div className=\"mt-3\">\r\n                <label htmlFor=\"tourist-details\" className=\"block text-xs text-slate-600\">Anything else we should know?</label>\r\n                <textarea\r\n                  id=\"tourist-details\"\r\n                  name=\"otherDetails\"\r\n                  placeholder=\"Optional: dietary needs, accessibility, hotel preferences, any constraints, or study details.\"\r\n                  rows={3}\r\n                  className=\"groupstays-select mt-2 w-full rounded-xl px-4 py-3 border border-slate-200 bg-white text-sm text-slate-900 shadow-sm focus:outline-none focus:ring-2 focus:ring-emerald-200 focus:border-emerald-300 transition\"\r\n                />\r\n              </div>\r\n            </details>\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      {step === 3 && (\r\n        <div className=\"rounded-2xl border border-slate-200 bg-gradient-to-b from-white to-slate-50/40 p-5 mb-4 groupstays-section shadow-sm\" aria-labelledby=\"contact-transport-heading\">\r\n          <div className=\"flex items-center justify-between mb-2\">\r\n            <div className=\"flex items-center gap-2\">\r\n              <div className=\"w-1.5 h-6 bg-emerald-500 rounded-sm\" aria-hidden />\r\n              <div>\r\n                <div id=\"contact-transport-heading\" className=\"text-sm font-semibold text-slate-900\">Contact & Transport</div>\r\n                <div className=\"text-xs text-slate-500\">A few details so we can tailor the logistics.</div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"mt-4 grid grid-cols-1 lg:grid-cols-2 gap-4\">\r\n            <div className=\"rounded-2xl border border-slate-200 bg-white p-5 shadow-sm\">\r\n              <div className=\"text-sm font-semibold text-slate-900\">Contact details</div>\r\n              <div className=\"mt-0.5 text-xs text-slate-500\">Where should we send the plan and follow-ups?</div>\r\n\r\n              <div className=\"mt-4 grid grid-cols-1 md:grid-cols-3 gap-3\">\r\n                <div className=\"md:col-span-1\">\r\n                  <label htmlFor=\"full-name\" className=\"block text-xs font-semibold text-slate-700\">Your name</label>\r\n                  <input\r\n                    id=\"full-name\"\r\n                    name=\"fullName\"\r\n                    placeholder=\"Full name\"\r\n                    autoComplete=\"name\"\r\n                    className=\"groupstays-select mt-2 w-full rounded-xl px-4 py-3 border border-slate-200 bg-white text-sm text-slate-900 shadow-sm focus:outline-none focus:ring-2 focus:ring-emerald-200 focus:border-emerald-300 transition\"\r\n                  />\r\n                </div>\r\n                <div className=\"md:col-span-1\">\r\n                  <label htmlFor=\"email\" className=\"block text-xs font-semibold text-slate-700\">Email</label>\r\n                  <input\r\n                    id=\"email\"\r\n                    name=\"email\"\r\n                    type=\"email\"\r\n                    placeholder=\"you@email.com\"\r\n                    autoComplete=\"email\"\r\n                    className=\"groupstays-select mt-2 w-full rounded-xl px-4 py-3 border border-slate-200 bg-white text-sm text-slate-900 shadow-sm focus:outline-none focus:ring-2 focus:ring-emerald-200 focus:border-emerald-300 transition\"\r\n                  />\r\n                </div>\r\n                <div className=\"md:col-span-1\">\r\n                  <label htmlFor=\"phone\" className=\"block text-xs font-semibold text-slate-700\">Phone</label>\r\n                  <input\r\n                    id=\"phone\"\r\n                    name=\"phone\"\r\n                    placeholder=\"+255...\"\r\n                    autoComplete=\"tel\"\r\n                    className=\"groupstays-select mt-2 w-full rounded-xl px-4 py-3 border border-slate-200 bg-white text-sm text-slate-900 shadow-sm focus:outline-none focus:ring-2 focus:ring-emerald-200 focus:border-emerald-300 transition\"\r\n                  />\r\n                </div>\r\n              </div>\r\n            </div>\r\n\r\n            <div className=\"rounded-2xl border border-slate-200 bg-white p-5 shadow-sm\">\r\n              <div className=\"flex items-start justify-between gap-3\">\r\n                <div>\r\n                  <div className=\"text-sm font-semibold text-slate-900\">Transport & transfers</div>\r\n                  <div className=\"mt-0.5 text-xs text-slate-500\">\r\n                    {selectedRole === 'Tourist'\r\n                      ? 'Vehicle preferences (optional). Pickup/dropoff is planned after your itinerary is confirmed.'\r\n                      : 'Pickup/dropoff and vehicle preferences (optional).'}\r\n                  </div>\r\n                </div>\r\n              </div>\r\n\r\n              <div className=\"mt-4\">\r\n                <label htmlFor=\"transport-required\" className=\"block text-xs font-semibold text-slate-700\">Do you need transport?</label>\r\n                <div className=\"relative mt-2\">\r\n                  <select\r\n                    id=\"transport-required\"\r\n                    name=\"transportRequired\"\r\n                    value={transportRequired}\r\n                    onChange={(e) => setTransportRequired(e.target.value)}\r\n                    className=\"groupstays-select w-full rounded-xl px-4 py-3 pr-10 border border-slate-200 bg-white text-sm text-slate-900 shadow-sm focus:outline-none focus:ring-2 focus:ring-emerald-200 focus:border-emerald-300 transition\"\r\n                  >\r\n                    <option value=\"\">Select</option>\r\n                    <option value=\"yes\">Yes</option>\r\n                    <option value=\"no\">No</option>\r\n                  </select>\r\n                  <ChevronDown className=\"pointer-events-none absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400\" aria-hidden />\r\n                </div>\r\n\r\n                {transportRequired === 'no' ? (\r\n                  <div className=\"mt-3 rounded-xl border border-slate-200 bg-slate-50 px-4 py-3 text-xs text-slate-600\">\r\n                    No transport needed — we’ll focus on the itinerary.\r\n                  </div>\r\n                ) : null}\r\n              </div>\r\n\r\n              {transportRequired === 'yes' && (\r\n                <div className=\"mt-4 space-y-3\">\r\n                  <div className=\"grid grid-cols-1 md:grid-cols-2 gap-3\">\r\n                    <div>\r\n                      <label htmlFor=\"vehicle-type\" className=\"block text-xs font-semibold text-slate-700\">Preferred vehicle type</label>\r\n                      <div className=\"relative mt-2\">\r\n                        <select\r\n                          id=\"vehicle-type\"\r\n                          name=\"vehicleType\"\r\n                          className=\"groupstays-select w-full rounded-xl px-4 py-3 pr-10 border border-slate-200 bg-white text-sm text-slate-900 shadow-sm focus:outline-none focus:ring-2 focus:ring-emerald-200 focus:border-emerald-300 transition\"\r\n                        >\r\n                          <option value=\"\">Select</option>\r\n                          <option value=\"bus\">Bus / Coach</option>\r\n                          <option value=\"minibus\">Minibus</option>\r\n                          <option value=\"4x4\">4x4 / SUV</option>\r\n                          <option value=\"safari-land-cruiser\">Safari Land Cruiser / Jeep (4x4)</option>\r\n                          <option value=\"safari-van\">Safari Van (pop-up roof)</option>\r\n                          <option value=\"van\">Van</option>\r\n                          <option value=\"boat\">Boat</option>\r\n                          <option value=\"other\">Other</option>\r\n                        </select>\r\n                        <ChevronDown className=\"pointer-events-none absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400\" aria-hidden />\r\n                      </div>\r\n                    </div>\r\n\r\n                    <div>\r\n                      <label htmlFor=\"vehicles-needed\" className=\"block text-xs font-semibold text-slate-700\">Vehicles / units</label>\r\n                      <input\r\n                        id=\"vehicles-needed\"\r\n                        name=\"vehiclesNeeded\"\r\n                        type=\"number\"\r\n                        min={0}\r\n                        placeholder=\"e.g. 1, 2\"\r\n                        className=\"groupstays-select mt-2 w-full rounded-xl px-4 py-3 border border-slate-200 bg-white text-sm text-slate-900 shadow-sm focus:outline-none focus:ring-2 focus:ring-emerald-200 focus:border-emerald-300 transition\"\r\n                      />\r\n                    </div>\r\n                  </div>\r\n\r\n                  {selectedRole !== 'Tourist' ? (\r\n                    <div className=\"grid grid-cols-1 md:grid-cols-2 gap-3\">\r\n                      <div>\r\n                        <label htmlFor=\"pickup-location\" className=\"block text-xs font-semibold text-slate-700\">Pickup location</label>\r\n                        <input\r\n                          id=\"pickup-location\"\r\n                          name=\"pickupLocation\"\r\n                          placeholder=\"City, hotel, or coordinates\"\r\n                          className=\"groupstays-select mt-2 w-full rounded-xl px-4 py-3 border border-slate-200 bg-white text-sm text-slate-900 shadow-sm focus:outline-none focus:ring-2 focus:ring-emerald-200 focus:border-emerald-300 transition\"\r\n                        />\r\n                      </div>\r\n                      <div>\r\n                        <label htmlFor=\"dropoff-location\" className=\"block text-xs font-semibold text-slate-700\">Dropoff location</label>\r\n                        <input\r\n                          id=\"dropoff-location\"\r\n                          name=\"dropoffLocation\"\r\n                          placeholder=\"City, park, or coordinates\"\r\n                          className=\"groupstays-select mt-2 w-full rounded-xl px-4 py-3 border border-slate-200 bg-white text-sm text-slate-900 shadow-sm focus:outline-none focus:ring-2 focus:ring-emerald-200 focus:border-emerald-300 transition\"\r\n                        />\r\n                      </div>\r\n                    </div>\r\n                  ) : (\r\n                    <div className=\"rounded-xl border border-slate-200 bg-slate-50 px-4 py-3 text-xs text-slate-600\">\r\n                      Pickup and dropoff details are confirmed after you choose your destination and itinerary.\r\n                    </div>\r\n                  )}\r\n\r\n                  <div className=\"grid grid-cols-1 md:grid-cols-2 gap-3\">\r\n                    <div>\r\n                      <label htmlFor=\"passenger-count\" className=\"block text-xs font-semibold text-slate-700\">Estimated passengers</label>\r\n                      <input\r\n                        id=\"passenger-count\"\r\n                        name=\"passengerCount\"\r\n                        value={passengerCount}\r\n                        onChange={(e) => {\r\n                          if (!groupSizeState) setPassengerCount(e.target.value);\r\n                        }}\r\n                        type=\"number\"\r\n                        min={0}\r\n                        placeholder=\"Number of passengers\"\r\n                        disabled={!!groupSizeState}\r\n                        className=\"groupstays-select mt-2 w-full rounded-xl px-4 py-3 border border-slate-200 bg-white text-sm text-slate-900 shadow-sm focus:outline-none focus:ring-2 focus:ring-emerald-200 focus:border-emerald-300 transition disabled:bg-slate-50 disabled:text-slate-500\"\r\n                      />\r\n                      {groupSizeState ? (\r\n                        <div className=\"mt-1 text-[11px] text-slate-500\">Auto-filled from group size.</div>\r\n                      ) : null}\r\n                    </div>\r\n                    <div>\r\n                      <label htmlFor=\"vehicle-requirements\" className=\"block text-xs font-semibold text-slate-700\">Special requirements</label>\r\n                      <input\r\n                        id=\"vehicle-requirements\"\r\n                        name=\"vehicleRequirements\"\r\n                        placeholder=\"e.g. wheelchair access, refrigeration, trailer\"\r\n                        className=\"groupstays-select mt-2 w-full rounded-xl px-4 py-3 border border-slate-200 bg-white text-sm text-slate-900 shadow-sm focus:outline-none focus:ring-2 focus:ring-emerald-200 focus:border-emerald-300 transition\"\r\n                      />\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n              )}\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      {/* Review step (4) */}\r\n      {step === 4 && (() => {\r\n        // Always collect fresh form data for review to ensure we show everything\r\n        const currentReviewData = Object.keys(reviewData).length > 0 ? reviewData : collectFormAsObject();\r\n        const orderedKeys = getOrderedReviewKeys(currentReviewData);\r\n\r\n        const reviewDestinationContext = matchEastAfricaDestinations(\r\n          parseDestinationList(currentReviewData.destinations || '')\r\n        );\r\n        const reviewPrimaryDestinationId = reviewDestinationContext.matched[0]?.id;\r\n        const tripReviewAccent = reviewPrimaryDestinationId\r\n          ? getDestinationAccent(reviewPrimaryDestinationId)\r\n          : destinationAccentPalette[0];\r\n\r\n        const reviewChecklist = [\r\n          {\r\n            label: 'Destinations',\r\n            ok: Boolean(String(currentReviewData.destinations || '').trim()),\r\n          },\r\n          {\r\n            label: 'Dates',\r\n            ok: Boolean(String(currentReviewData.dateFrom || '').trim()) && Boolean(String(currentReviewData.dateTo || '').trim()),\r\n          },\r\n          {\r\n            label: 'Group size',\r\n            ok: Boolean(String(currentReviewData.groupSize || '').trim()) || Boolean(String(currentReviewData.passengerCount || '').trim()),\r\n          },\r\n          {\r\n            label: 'Contact info',\r\n            ok: Boolean(String(currentReviewData.fullName || '').trim()) && Boolean(String(currentReviewData.email || '').trim()),\r\n          },\r\n        ];\r\n        \r\n        // Group fields by category for better organization\r\n        const tripDetails = ['role', 'tripType', 'destinations', 'dateFrom', 'dateTo', 'groupSize', 'passengerCount', 'budget', 'notes'];\r\n        const contactDetails = ['fullName', 'email', 'phone'];\r\n        const transportDetails =\r\n          selectedRole === 'Tourist'\r\n            ? ['transportRequired', 'vehicleType', 'vehiclesNeeded', 'vehicleRequirements']\r\n            : ['transportRequired', 'vehicleType', 'pickupLocation', 'dropoffLocation', 'vehiclesNeeded', 'vehicleRequirements'];\r\n        \r\n        // Role-specific fields based on role\r\n        const roleSpecificKeys: string[] = [];\r\n        if (selectedRole === 'Event planner') {\r\n          roleSpecificKeys.push('eventType', 'expectedAttendees', 'eventStartDate', 'eventEndDate', 'venuePreferences', 'accommodationNeeded', 'cateringRequired', 'avRequirements', 'budgetPerPerson');\r\n        } else if (selectedRole === 'School / Teacher') {\r\n          roleSpecificKeys.push('studentsCount', 'chaperones', 'ageRange', 'learningObjectives', 'riskAssessment', 'specialNeedsSupport');\r\n        } else if (selectedRole === 'University') {\r\n          roleSpecificKeys.push('researchPurpose', 'staffCount', 'studentsCountUniv', 'ethicsApproval', 'sampleCollection', 'permitsNeeded');\r\n        } else if (selectedRole === 'Community group') {\r\n          roleSpecificKeys.push('communityObjectives', 'beneficiaries', 'projectDuration', 'localPartners');\r\n        } else if (selectedRole === 'Other' || selectedRole === 'Tourist') {\r\n          roleSpecificKeys.push('otherDetails');\r\n        }\r\n        \r\n        // Filter keys by category and get remaining keys\r\n        const tripKeys = orderedKeys.filter(k => tripDetails.includes(k));\r\n        const contactKeys = orderedKeys.filter(k => contactDetails.includes(k));\r\n        const transportKeys = orderedKeys.filter(k => transportDetails.includes(k));\r\n        const roleKeys = orderedKeys.filter(k => roleSpecificKeys.includes(k));\r\n        const otherKeys = orderedKeys.filter(k => !tripDetails.includes(k) && !contactDetails.includes(k) && !transportDetails.includes(k) && !roleSpecificKeys.includes(k));\r\n        \r\n        return (\r\n          <section aria-labelledby=\"review-heading\" className=\"space-y-4\">\r\n            <div className=\"rounded-3xl border border-slate-200 bg-gradient-to-b from-white to-slate-50 p-6 shadow-sm\">\r\n              <h3 id=\"review-heading\" className=\"text-xl font-semibold text-slate-900\">Review your request</h3>\r\n              <p className=\"text-sm text-slate-600 mt-1\">Review all information below before sending. Use Back to edit any section.</p>\r\n            </div>\r\n\r\n            <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-4\">\r\n              <div className=\"rounded-3xl border border-slate-200 bg-white/80 p-5 shadow-sm backdrop-blur\">\r\n                <div className=\"flex items-start justify-between gap-3\">\r\n                  <div>\r\n                    <div className=\"text-sm font-semibold text-slate-900\">Before you send</div>\r\n                    <div className=\"mt-1 text-xs text-slate-600\">Quick checklist to avoid surprises.</div>\r\n                  </div>\r\n                </div>\r\n                <div className=\"mt-4 grid grid-cols-1 sm:grid-cols-2 gap-2\">\r\n                  {reviewChecklist.map((item) => (\r\n                    <div key={item.label} className=\"flex items-center gap-2 rounded-2xl border border-slate-100 bg-white px-3 py-2 shadow-sm\">\r\n                      <CheckCircle className={item.ok ? 'w-4 h-4 text-emerald-600' : 'w-4 h-4 text-slate-300'} aria-hidden />\r\n                      <div className={item.ok ? 'text-xs font-semibold text-slate-800' : 'text-xs font-semibold text-slate-500'}>\r\n                        {item.label}\r\n                      </div>\r\n                    </div>\r\n                  ))}\r\n                </div>\r\n                <div className=\"mt-3 text-[11px] text-slate-500\">\r\n                  Your contact details are only used to respond to this request.\r\n                </div>\r\n              </div>\r\n\r\n              <div className=\"rounded-3xl border border-slate-200 bg-gradient-to-b from-white to-slate-50 p-5 shadow-sm\">\r\n                <div className=\"text-sm font-semibold text-slate-900\">What happens next</div>\r\n                <div className=\"mt-1 text-xs text-slate-600\">Here’s what to expect after you send.</div>\r\n                <ol className=\"mt-4 space-y-2\">\r\n                  <li className=\"flex items-start gap-3 rounded-2xl border border-slate-100 bg-white px-3 py-2 shadow-sm\">\r\n                    <span className=\"mt-0.5 inline-flex h-6 w-6 items-center justify-center rounded-full bg-slate-900 text-white text-[11px] font-semibold\">1</span>\r\n                    <div className=\"text-xs text-slate-700\"><span className=\"font-semibold text-slate-900\">We review</span> your details and confirm availability.</div>\r\n                  </li>\r\n                  <li className=\"flex items-start gap-3 rounded-2xl border border-slate-100 bg-white px-3 py-2 shadow-sm\">\r\n                    <span className=\"mt-0.5 inline-flex h-6 w-6 items-center justify-center rounded-full bg-slate-900 text-white text-[11px] font-semibold\">2</span>\r\n                    <div className=\"text-xs text-slate-700\"><span className=\"font-semibold text-slate-900\">We tailor</span> the itinerary around your preferences.</div>\r\n                  </li>\r\n                  <li className=\"flex items-start gap-3 rounded-2xl border border-slate-100 bg-white px-3 py-2 shadow-sm\">\r\n                    <span className=\"mt-0.5 inline-flex h-6 w-6 items-center justify-center rounded-full bg-slate-900 text-white text-[11px] font-semibold\">3</span>\r\n                    <div className=\"text-xs text-slate-700\"><span className=\"font-semibold text-slate-900\">We reply</span> with next steps and a quote.</div>\r\n                  </li>\r\n                </ol>\r\n              </div>\r\n            </div>\r\n            \r\n            {orderedKeys.length === 0 ? (\r\n              <div className=\"rounded-2xl border border-slate-200 bg-white p-6 text-center shadow-sm\">\r\n                <p className=\"text-sm text-slate-500\">No details to show. Please fill out the form.</p>\r\n              </div>\r\n            ) : (\r\n              <div className=\"space-y-4\">\r\n                {/* Trip Details Section */}\r\n                {tripKeys.length > 0 && (\r\n                  <div\r\n                    className={\r\n                      \"group relative overflow-hidden rounded-3xl border bg-gradient-to-b to-white p-5 shadow-sm backdrop-blur transition-all duration-200 ease-out hover:-translate-y-px hover:shadow-md \" +\r\n                      tripReviewAccent.reviewSectionBorder +\r\n                      \" \" +\r\n                      tripReviewAccent.reviewSectionFrom +\r\n                      \" before:content-[''] before:absolute before:inset-x-0 before:top-0 before:h-1 \" +\r\n                      tripReviewAccent.reviewSectionBar\r\n                    }\r\n                  >\r\n                    <div className=\"flex items-start justify-between gap-3 pb-3 border-b border-slate-200\">\r\n                      <h4 className=\"text-sm font-semibold text-slate-900\">Trip Details</h4>\r\n                      <button\r\n                        type=\"button\"\r\n                        onClick={() => goToStep(1)}\r\n                        className=\"inline-flex items-center gap-2 rounded-xl border border-slate-200 bg-white px-3 py-2 text-xs font-semibold text-slate-800 shadow-sm transition hover:bg-slate-50\"\r\n                      >\r\n                        Edit\r\n                        <ArrowRight className=\"w-4 h-4 text-slate-500\" aria-hidden />\r\n                      </button>\r\n                    </div>\r\n                    <div className=\"mt-4 grid grid-cols-1 md:grid-cols-2 gap-3\">\r\n                      {tripKeys.map((k) => (\r\n                        <div\r\n                          key={k}\r\n                          className=\"rounded-2xl border border-slate-100 bg-white px-4 py-3 shadow-sm transition-all duration-200 ease-out hover:-translate-y-px hover:shadow-md group-hover:border-slate-200\"\r\n                        >\r\n                          <div\r\n                            className={\r\n                              'text-[11px] font-semibold uppercase tracking-wide ' +\r\n                              (k === 'destinations' || k === 'tripType' ? tripReviewAccent.reviewLabel : 'text-slate-500')\r\n                            }\r\n                          >\r\n                            {formatLabel(k)}\r\n                          </div>\r\n                          {k === 'destinations' ? (\r\n                            (() => {\r\n                              const raw = currentReviewData[k];\r\n                              const stops = parseSerializedRouteStopsForReview(raw);\r\n                              if (stops.length > 0) {\r\n                                return (\r\n                                  <div className=\"mt-2 space-y-2\">\r\n                                    {stops.map((s, index) => (\r\n                                      <div\r\n                                        key={`${s.idx || index}_${s.place}`}\r\n                                        className=\"flex items-start gap-3 rounded-2xl border border-slate-200 bg-slate-50/60 px-3 py-2\"\r\n                                      >\r\n                                        <span\r\n                                          className={\r\n                                            'mt-0.5 inline-flex h-7 w-7 items-center justify-center rounded-full text-xs font-semibold ring-2 ring-white ' +\r\n                                            tripReviewAccent.destinationPill.replace('bg-', 'bg-')\r\n                                          }\r\n                                        >\r\n                                          {s.idx || index + 1}\r\n                                        </span>\r\n                                        <div className=\"min-w-0 flex-1\">\r\n                                          <div className=\"text-sm font-semibold text-slate-900 break-words\">{s.place}</div>\r\n                                          {typeof s.nights === 'number' ? (\r\n                                            <div className=\"mt-1\">\r\n                                              <span className=\"inline-flex items-center rounded-full border border-slate-200 bg-white px-2 py-0.5 text-[11px] font-semibold text-slate-700 shadow-sm\">\r\n                                                {s.nights} night{s.nights === 1 ? '' : 's'}\r\n                                              </span>\r\n                                            </div>\r\n                                          ) : null}\r\n                                        </div>\r\n                                      </div>\r\n                                    ))}\r\n                                  </div>\r\n                                );\r\n                              }\r\n\r\n                              const formatted = formatValue(raw);\r\n                              return <div className=\"mt-1 text-sm text-slate-900 break-words whitespace-pre-wrap\">{formatted}</div>;\r\n                            })()\r\n                          ) : (\r\n                            <div className=\"mt-1 text-sm text-slate-900 break-words\">{formatValue(currentReviewData[k])}</div>\r\n                          )}\r\n                        </div>\r\n                      ))}\r\n                    </div>\r\n                  </div>\r\n                )}\r\n                \r\n                {/* Role-Specific Details Section */}\r\n                {roleKeys.length > 0 && (\r\n                  <div className=\"group rounded-3xl border border-slate-200 bg-white/80 p-5 shadow-sm backdrop-blur transition-shadow hover:shadow-md\">\r\n                    <div className=\"flex items-start justify-between gap-3 pb-3 border-b border-slate-200\">\r\n                      <h4 className=\"text-sm font-semibold text-slate-900\">{selectedRole} Details</h4>\r\n                      <button\r\n                        type=\"button\"\r\n                        onClick={() => goToStep(2)}\r\n                        className=\"inline-flex items-center gap-2 rounded-xl border border-slate-200 bg-white px-3 py-2 text-xs font-semibold text-slate-800 shadow-sm transition hover:bg-slate-50\"\r\n                      >\r\n                        Edit\r\n                        <ArrowRight className=\"w-4 h-4 text-slate-500\" aria-hidden />\r\n                      </button>\r\n                    </div>\r\n                    <div className=\"mt-4 grid grid-cols-1 md:grid-cols-2 gap-3\">\r\n                      {roleKeys.map((k) => (\r\n                        <div\r\n                          key={k}\r\n                          className=\"rounded-2xl border border-slate-100 bg-white px-4 py-3 shadow-sm transition-all duration-200 ease-out hover:-translate-y-px hover:shadow-md group-hover:border-slate-200\"\r\n                        >\r\n                          <div className=\"text-[11px] font-semibold uppercase tracking-wide text-slate-500\">{formatLabel(k)}</div>\r\n                          <div className=\"mt-1 text-sm text-slate-900 break-words\">{formatValue(currentReviewData[k])}</div>\r\n                        </div>\r\n                      ))}\r\n                    </div>\r\n                  </div>\r\n                )}\r\n                \r\n                {/* Contact Details Section */}\r\n                {contactKeys.length > 0 && (\r\n                  <div className=\"group rounded-3xl border border-slate-200 bg-white/80 p-5 shadow-sm backdrop-blur transition-shadow hover:shadow-md\">\r\n                    <div className=\"flex items-start justify-between gap-3 pb-3 border-b border-slate-200\">\r\n                      <h4 className=\"text-sm font-semibold text-slate-900\">Contact Information</h4>\r\n                      <button\r\n                        type=\"button\"\r\n                        onClick={() => goToStep(3)}\r\n                        className=\"inline-flex items-center gap-2 rounded-xl border border-slate-200 bg-white px-3 py-2 text-xs font-semibold text-slate-800 shadow-sm transition hover:bg-slate-50\"\r\n                      >\r\n                        Edit\r\n                        <ArrowRight className=\"w-4 h-4 text-slate-500\" aria-hidden />\r\n                      </button>\r\n                    </div>\r\n                    <div className=\"mt-4 grid grid-cols-1 md:grid-cols-2 gap-3\">\r\n                      {contactKeys.map((k) => (\r\n                        <div\r\n                          key={k}\r\n                          className=\"rounded-2xl border border-slate-100 bg-white px-4 py-3 shadow-sm transition-all duration-200 ease-out hover:-translate-y-px hover:shadow-md group-hover:border-slate-200\"\r\n                        >\r\n                          <div className=\"text-[11px] font-semibold uppercase tracking-wide text-slate-500\">{formatLabel(k)}</div>\r\n                          <div className=\"mt-1 text-sm text-slate-900 break-words\">{formatValue(currentReviewData[k])}</div>\r\n                        </div>\r\n                      ))}\r\n                    </div>\r\n                  </div>\r\n                )}\r\n                \r\n                {/* Transport Details Section */}\r\n                {transportKeys.length > 0 && (\r\n                  <div className=\"group rounded-3xl border border-slate-200 bg-white/80 p-5 shadow-sm backdrop-blur transition-shadow hover:shadow-md\">\r\n                    <div className=\"flex items-start justify-between gap-3 pb-3 border-b border-slate-200\">\r\n                      <h4 className=\"text-sm font-semibold text-slate-900\">Transport & Vehicle Details</h4>\r\n                      <button\r\n                        type=\"button\"\r\n                        onClick={() => goToStep(3)}\r\n                        className=\"inline-flex items-center gap-2 rounded-xl border border-slate-200 bg-white px-3 py-2 text-xs font-semibold text-slate-800 shadow-sm transition hover:bg-slate-50\"\r\n                      >\r\n                        Edit\r\n                        <ArrowRight className=\"w-4 h-4 text-slate-500\" aria-hidden />\r\n                      </button>\r\n                    </div>\r\n                    <div className=\"mt-4 grid grid-cols-1 md:grid-cols-2 gap-3\">\r\n                      {transportKeys.map((k) => (\r\n                        <div\r\n                          key={k}\r\n                          className=\"rounded-2xl border border-slate-100 bg-white px-4 py-3 shadow-sm transition-all duration-200 ease-out hover:-translate-y-px hover:shadow-md group-hover:border-slate-200\"\r\n                        >\r\n                          <div className=\"text-[11px] font-semibold uppercase tracking-wide text-slate-500\">{formatLabel(k)}</div>\r\n                          <div className=\"mt-1 text-sm text-slate-900 break-words\">{formatValue(currentReviewData[k])}</div>\r\n                        </div>\r\n                      ))}\r\n                    </div>\r\n                  </div>\r\n                )}\r\n                \r\n                {/* Other Details Section */}\r\n                {otherKeys.length > 0 && (\r\n                  <div className=\"group rounded-3xl border border-slate-200 bg-white/80 p-5 shadow-sm backdrop-blur transition-shadow hover:shadow-md\">\r\n                    <div className=\"flex items-start justify-between gap-3 pb-3 border-b border-slate-200\">\r\n                      <div>\r\n                        <h4 className=\"text-sm font-semibold text-slate-900\">\r\n                          {selectedRole === 'Tourist' && (otherKeys.includes('touristMustHaves') || otherKeys.includes('touristInterests'))\r\n                            ? 'For Tourists'\r\n                            : 'Additional Details'}\r\n                        </h4>\r\n                        {selectedRole === 'Tourist' && (otherKeys.includes('touristMustHaves') || otherKeys.includes('touristInterests')) ? (\r\n                          <div className=\"mt-1 text-xs text-slate-600\">Pick a few options (fast) and we’ll tailor the itinerary around your preferences.</div>\r\n                        ) : null}\r\n                      </div>\r\n                      <button\r\n                        type=\"button\"\r\n                        onClick={() => goToStep(2)}\r\n                        className=\"inline-flex items-center gap-2 rounded-xl border border-slate-200 bg-white px-3 py-2 text-xs font-semibold text-slate-800 shadow-sm transition hover:bg-slate-50\"\r\n                      >\r\n                        Edit\r\n                        <ArrowRight className=\"w-4 h-4 text-slate-500\" aria-hidden />\r\n                      </button>\r\n                    </div>\r\n                    <div className=\"mt-4 grid grid-cols-1 md:grid-cols-2 gap-3\">\r\n                      {otherKeys.map((k) => (\r\n                        <div\r\n                          key={k}\r\n                          className=\"rounded-2xl border border-slate-100 bg-white px-4 py-3 shadow-sm transition-all duration-200 ease-out hover:-translate-y-px hover:shadow-md group-hover:border-slate-200\"\r\n                        >\r\n                          <div className=\"text-[11px] font-semibold uppercase tracking-wide text-slate-500\">{formatLabel(k)}</div>\r\n                          {k === 'touristMustHaves' || k === 'touristInterests' ? (\r\n                            (() => {\r\n                              const items = splitCommaList(currentReviewData[k]);\r\n                              return items.length > 0 ? (\r\n                                <div className=\"mt-2 flex flex-wrap gap-2\">\r\n                                  {items.map((item) => (\r\n                                    <span\r\n                                      key={item}\r\n                                      className={\r\n                                        'inline-flex items-center rounded-xl px-3 py-1.5 text-xs font-semibold border shadow-sm select-none ' +\r\n                                        tripReviewAccent.chipActive\r\n                                      }\r\n                                    >\r\n                                      {item}\r\n                                    </span>\r\n                                  ))}\r\n                                </div>\r\n                              ) : (\r\n                                <div className=\"mt-1 text-sm text-slate-900 break-words\">-</div>\r\n                              );\r\n                            })()\r\n                          ) : (\r\n                            <div className=\"mt-1 text-sm text-slate-900 break-words\">{formatValue(currentReviewData[k])}</div>\r\n                          )}\r\n                        </div>\r\n                      ))}\r\n                    </div>\r\n                  </div>\r\n                )}\r\n              </div>\r\n            )}\r\n          </section>\r\n        );\r\n      })()}\r\n\r\n      </div></>) : null}</div>\r\n\r\n      {selectedRole && (\r\n        <div className=\"pt-3 flex gap-3\">\r\n          {step > 1 && (\r\n            <button type=\"button\" onClick={goBack} className=\"inline-flex items-center justify-center gap-2 border border-slate-200 text-slate-700 bg-white px-4 py-2 rounded-lg\">Back</button>\r\n          )}\r\n\r\n          {step < totalSteps && (\r\n            <button type=\"button\" onClick={goNext} className=\"ml-auto inline-flex items-center justify-center gap-2 bg-emerald-600 text-white font-semibold px-4 py-2 rounded-lg\">Next</button>\r\n          )}\r\n\r\n          {step === totalSteps && (\r\n            <button type=\"submit\" disabled={submitting} className=\"ml-auto inline-flex items-center justify-center gap-2 bg-emerald-600 text-white font-semibold px-4 py-2 rounded-lg\">\r\n              {submitting ? 'Sending…' : 'Send request'}\r\n            </button>\r\n          )}\r\n        </div>\r\n      )}\r\n    </form>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\PolicyLink.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\PropertyCard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\PropertyEditModal.tsx","messages":[],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'initializeData'. Either include it or remove the dependency array.","line":41,"column":6,"nodeType":"ArrayExpression","endLine":41,"endColumn":24,"suggestions":[{"desc":"Update the dependencies array to be: [initializeData, isOpen, property]","fix":{"range":[1573,1591],"text":"[initializeData, isOpen, property]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\PropertyPreview.tsx","messages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":135,"column":5,"nodeType":"JSXOpeningElement","endLine":140,"endColumn":7}],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadProperty'. Either include it or remove the dependency array.","line":361,"column":6,"nodeType":"ArrayExpression","endLine":361,"endColumn":18,"suggestions":[{"desc":"Update the dependencies array to be: [loadProperty, propertyId]","fix":{"range":[12129,12141],"text":"[loadProperty, propertyId]"}}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'loadAuditHistory' and 'loadReviews'. Either include them or remove the dependency array.","line":371,"column":6,"nodeType":"ArrayExpression","endLine":371,"endColumn":22,"suggestions":[{"desc":"Update the dependencies array to be: [property, mode, loadReviews, loadAuditHistory]","fix":{"range":[12392,12408],"text":"[property, mode, loadReviews, loadAuditHistory]"}}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useMemo has a missing dependency: 'property'. Either include it or remove the dependency array.","line":634,"column":6,"nodeType":"ArrayExpression","endLine":634,"endColumn":60,"suggestions":[{"desc":"Update the dependencies array to be: [displayPhotos, property]","fix":{"range":[20734,20788],"text":"[displayPhotos, property]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useState, useEffect, useMemo } from \"react\";\nimport Image from \"next/image\";\nimport Link from \"next/link\";\nimport { \n  MapPin, \n  Star, \n  Wifi, \n  Car, \n  UtensilsCrossed, \n  Dumbbell, \n  Waves, \n  AirVent,\n  CheckCircle2,\n  XCircle,\n  Edit,\n  Save,\n  X,\n  ChevronLeft,\n  ChevronRight,\n  BedDouble,\n  Bath,\n  Users,\n  Phone,\n  Mail,\n  Beer,\n  Thermometer,\n  Package,\n  Shield,\n  Bandage,\n  FireExtinguisher,\n  ShoppingBag,\n  Store,\n  PartyPopper,\n  Gamepad,\n  WashingMachine,\n  Share2,\n  Lock,\n  BadgeCheck,\n  Clock,\n  XCircle as XCircleIcon,\n  Ban,\n  CigaretteOff,\n  FileText,\n  Map,\n  ImageIcon,\n  Eye,\n  DoorClosed,\n  Tags,\n  Building2,\n  Calendar,\n} from \"lucide-react\";\nimport LogoSpinner from \"@/components/LogoSpinner\";\nimport axios from \"axios\";\nimport { motion } from \"framer-motion\";\nimport NeighborhoodGuide from \"./NeighborhoodGuide\";\nimport TableRow from \"./TableRow\";\nimport PropertyEditModal from \"./PropertyEditModal\";\nimport NearbyServices from \"./NearbyServices\";\nimport ServicesAndFacilities from \"./ServicesAndFacilities\";\nimport { PropertyVisualizationPreview } from \"../app/(owner)/owner/properties/add/_components/PropertyVisualizationPreview\";\nimport { \n  getPropertyCommission, \n  calculatePriceWithCommission,\n} from \"../lib/priceUtils\";\nimport { BATHROOM_ICONS, OTHER_AMENITIES_ICONS } from \"../lib/amenityIcons\";\nimport {\n  fmtMoney,\n  capWords,\n  getBedDimensions,\n  formatTimeRange,\n  normalizeRoomsSpec,\n} from \"../lib/propertyUtils\";\nimport type {\n  PropertyPreviewProps,\n  Property,\n  ReviewsData,\n  AuditHistoryItem,\n  RoomSpec,\n  Review,\n} from \"../lib/types/property\";\n\n// Use same-origin calls + secure httpOnly cookie session.\nconst api = axios.create({ baseURL: \"\", withCredentials: true });\n\nfunction canUseNextImageForSrc(src: string): boolean {\n  if (!src) return false;\n  if (src.startsWith(\"/\")) return true;\n  if (!src.startsWith(\"http://\") && !src.startsWith(\"https://\")) return false;\n  try {\n    const url = new URL(src);\n    const host = url.hostname;\n    if (host === \"localhost\" || host === \"127.0.0.1\") return true;\n    if (host === \"res.cloudinary.com\") return true;\n    if (host === \"img.youtube.com\") return true;\n    if (host === \"api.mapbox.com\") return true;\n    if (host.endsWith(\".mapbox.com\")) return true;\n    return false;\n  } catch {\n    return false;\n  }\n}\n\nfunction FillImage({\n  src,\n  alt,\n  className,\n  sizes,\n  priority,\n  unoptimized,\n}: {\n  src: string;\n  alt: string;\n  className?: string;\n  sizes?: string;\n  priority?: boolean;\n  unoptimized?: boolean;\n}) {\n  if (canUseNextImageForSrc(src)) {\n    return (\n      <Image\n        src={src}\n        alt={alt}\n        fill\n        className={className}\n        sizes={sizes}\n        priority={priority}\n        unoptimized={unoptimized}\n      />\n    );\n  }\n\n  return (\n    <img\n      src={src}\n      alt={alt}\n      className={className}\n      style={{ position: \"absolute\", inset: 0, width: \"100%\", height: \"100%\" }}\n    />\n  );\n}\n\n// Utility functions and types are now imported from lib/propertyUtils and lib/types/property\n\n// Icon mappings matching the owner's add page exactly\n// Icon mappings are imported from shared source to ensure consistency with owner submissions\n// DO NOT define custom icon mappings here - use the shared BATHROOM_ICONS and OTHER_AMENITIES_ICONS\n\n// Icon mappings are imported from shared source to ensure consistency with owner submissions\n\n// RoomAmenityChip component matching public view - icon-only with hover tooltip\nfunction RoomAmenityChip({ label }: { label: string }) {\n  // Use exact match from the owner's icon mappings first\n  const Icon = BATHROOM_ICONS[label] || OTHER_AMENITIES_ICONS[label] || Tags;\n  \n  // Determine colors based on icon type (matching public view logic)\n  const meta = (() => {\n    // Check if it's a bathroom item - use same colors as other amenities\n    if (BATHROOM_ICONS[label]) {\n      return { Icon, bg: \"bg-slate-50\", border: \"border-slate-200\", icon: \"text-slate-700\" };\n    }\n    // Check if it's an other amenity\n    if (OTHER_AMENITIES_ICONS[label]) {\n      // Special colors for specific amenities\n      if (label === \"Free Wi-Fi\") {\n        return { Icon, bg: \"bg-emerald-50\", border: \"border-emerald-200\", icon: \"text-emerald-700\" };\n      }\n      if (label === \"TV\" || label === \"Flat Screen TV\") {\n        return { Icon, bg: \"bg-indigo-50\", border: \"border-indigo-200\", icon: \"text-indigo-700\" };\n      }\n      if (label === \"PS Station\") {\n        return { Icon, bg: \"bg-purple-50\", border: \"border-purple-200\", icon: \"text-purple-700\" };\n      }\n      if (label === \"Air Conditioning\") {\n        return { Icon, bg: \"bg-cyan-50\", border: \"border-cyan-200\", icon: \"text-cyan-700\" };\n      }\n      if (label === \"Mini Fridge\") {\n        return { Icon, bg: \"bg-blue-50\", border: \"border-blue-200\", icon: \"text-blue-700\" };\n      }\n      if (label === \"Heating\") {\n        return { Icon, bg: \"bg-orange-50\", border: \"border-orange-200\", icon: \"text-orange-700\" };\n      }\n      if (label === \"Couches\") {\n        return { Icon, bg: \"bg-purple-50\", border: \"border-purple-200\", icon: \"text-purple-700\" };\n      }\n      if (label === \"Chair\") {\n        return { Icon, bg: \"bg-amber-50\", border: \"border-amber-200\", icon: \"text-amber-700\" };\n      }\n      // Default for other amenities\n      return { Icon, bg: \"bg-slate-50\", border: \"border-slate-200\", icon: \"text-slate-700\" };\n    }\n    // Fallback for unknown amenities\n    return { Icon: Tags, bg: \"bg-slate-50\", border: \"border-slate-200\", icon: \"text-slate-700\" };\n  })();\n\n  return (\n    <button\n      type=\"button\"\n      className={[\n        \"group relative inline-flex items-center justify-center rounded-full border\",\n        meta.bg,\n        meta.border,\n        \"h-9 w-9\",\n        \"shadow-sm shadow-transparent\",\n        \"motion-safe:transition-all motion-safe:duration-200 motion-safe:ease-out\",\n        \"hover:bg-white hover:border-slate-300 motion-safe:hover:-translate-y-0.5 motion-safe:hover:shadow-sm\",\n        \"active:scale-[0.98]\",\n        \"focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[#02665e]/30 focus-visible:ring-offset-2 focus-visible:ring-offset-white\",\n      ].join(\" \")}\n      aria-label={label}\n      title={label}\n    >\n      <Icon className={[\"w-5 h-5 transition-colors\", meta.icon, \"group-hover:text-[#02665e]\"].join(\" \")} aria-hidden />\n    </button>\n  );\n}\n\n// PropertyPreviewProps is now imported from lib/types/property\n\nexport default function PropertyPreview({ \n  propertyId, \n  mode = \"public\",\n  onApproved,\n  onRejected,\n  onUpdated,\n  onClose\n}: PropertyPreviewProps) {\n  const [property, setProperty] = useState<Property | null>(null);\n  const [loading, setLoading] = useState(true);\n  const [error, setError] = useState<string | null>(null);\n  const [adminNotice, setAdminNotice] = useState<null | { kind: \"success\" | \"error\" | \"info\"; title: string; body?: string }>(null);\n  const [isEditing, setIsEditing] = useState(false);\n  const [editData, setEditData] = useState<Partial<Property> | null>(null);\n  const [saving, setSaving] = useState(false);\n  const [selectedImageIndex, setSelectedImageIndex] = useState(0);\n  const [showLightbox, setShowLightbox] = useState(false);\n  const [rejectReasons, setRejectReasons] = useState(\"\");\n  const [showRejectDialog, setShowRejectDialog] = useState(false);\n  const [suspendReason, setSuspendReason] = useState(\"\");\n  const [showSuspendDialog, setShowSuspendDialog] = useState(false);\n  const [notifyOwnerOnSuspend, setNotifyOwnerOnSuspend] = useState(true);\n  const [unsuspendReason, setUnsuspendReason] = useState(\"\");\n  const [showUnsuspendDialog, setShowUnsuspendDialog] = useState(false);\n  const [displayPhotos, setDisplayPhotos] = useState<string[]>([]);\n  const [showShareMenu, setShowShareMenu] = useState<boolean>(false);\n  const [reviews, setReviews] = useState<ReviewsData | null>(null);\n  const [aboutExpanded, setAboutExpanded] = useState(false);\n  const [showEditModal, setShowEditModal] = useState(false);\n  const [systemCommission, setSystemCommission] = useState<number>(0);\n  const [auditHistory, setAuditHistory] = useState<AuditHistoryItem[]>([]);\n  const [auditLoading, setAuditLoading] = useState(false);\n\n  // Parse houseRules - can be a JSON string or object\n  const houseRules = useMemo(() => {\n    // Prefer `property.houseRules` if present, otherwise fall back to `services.houseRules`\n    const direct = (property as any)?.houseRules;\n    if (direct) {\n      if (typeof direct === 'string') {\n        try {\n          const parsed = JSON.parse(direct);\n          return typeof parsed === 'object' && parsed !== null && !Array.isArray(parsed) ? parsed : null;\n        } catch (e) {\n          return null;\n        }\n      }\n      if (typeof direct === 'object' && direct !== null && !Array.isArray(direct)) {\n        return direct;\n      }\n    }\n\n    // Fallback: `services.houseRules` (we persist house rules under services for now)\n    const servicesRaw = (property as any)?.services;\n    let servicesObj: any = null;\n    try {\n      if (typeof servicesRaw === \"string\" && servicesRaw.trim()) {\n        servicesObj = JSON.parse(servicesRaw);\n      } else if (servicesRaw && typeof servicesRaw === \"object\") {\n        servicesObj = servicesRaw;\n      }\n    } catch {\n      servicesObj = null;\n    }\n    const viaServices = servicesObj?.houseRules;\n    if (!viaServices) return null;\n    if (typeof viaServices === \"string\") {\n      try {\n        const parsed = JSON.parse(viaServices);\n        return typeof parsed === \"object\" && parsed !== null && !Array.isArray(parsed) ? parsed : null;\n      } catch (e) {\n        return null;\n      }\n    }\n    if (typeof viaServices === \"object\" && viaServices !== null && !Array.isArray(viaServices)) {\n      return viaServices;\n    }\n    return null;\n  }, [property]);\n\n  // formatTimeRange is now imported from lib/propertyUtils\n\n  // Professional auto-fill template for suspension reason\n  const SUSPENSION_REASON_TEMPLATE = `This property has been temporarily suspended due to a violation of our platform policies and terms of service. The suspension is effective immediately and the property has been removed from public search and booking availability. The property owner will be notified and provided with guidance on the steps required for reinstatement. The property will remain visible to administrators only until the issues have been resolved and the suspension is lifted.`;\n\n  // Load system commission settings\n  useEffect(() => {\n    let mounted = true;\n    const load = async () => {\n      try {\n        const response = await api.get(\"/admin/settings\");\n        if (mounted && response.data?.commissionPercent !== undefined) {\n          const commission = Number(response.data.commissionPercent);\n          setSystemCommission(isNaN(commission) ? 0 : commission);\n        }\n      } catch (e) {\n        // Silently fail - will use 0 as default\n      }\n    };\n    if (mode === \"admin\" || mode === \"owner\") {\n      load();\n    }\n    return () => {\n      mounted = false;\n    };\n  }, [mode]);\n\n  async function loadProperty() {\n    try {\n      setLoading(true);\n      const endpoint = mode === \"admin\" \n        ? `/api/admin/properties/${propertyId}`\n        : mode === \"owner\"\n        ? `/owner/properties/${propertyId}`\n        : `/public/properties/${propertyId}`;\n      \n      // Add cache-busting parameter to ensure fresh data\n      const response = await api.get(endpoint, {\n        params: { _t: Date.now() }\n      });\n      const data = mode === \"admin\" || mode === \"owner\" \n        ? response.data \n        : response.data?.item || response.data;\n      \n      setProperty(data);\n      setEditData(data);\n      // Initialize display photos array\n      if (data.photos && Array.isArray(data.photos)) {\n        setDisplayPhotos(data.photos);\n      }\n    } catch (err: any) {\n      setError(err?.response?.data?.error || \"Failed to load property\");\n      console.error(\"Load property error:\", err);\n    } finally {\n      setLoading(false);\n    }\n  }\n\n  useEffect(() => {\n    loadProperty();\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [propertyId]);\n\n  useEffect(() => {\n    if (property && (mode === \"public\" || mode === \"owner\")) {\n      loadReviews();\n    }\n    if (property && mode === \"admin\") {\n      loadAuditHistory();\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [property, mode]);\n\n\n\n  async function loadReviews() {\n    try {\n      const response = await api.get(`/api/property-reviews/${propertyId}`);\n      setReviews(response.data);\n    } catch (err: any) {\n      console.error(\"Load reviews error:\", err);\n      // Don't show error - reviews are optional\n    }\n  }\n\n  async function loadAuditHistory() {\n    try {\n      setAuditLoading(true);\n      const response = await api.get(`/api/admin/properties/${propertyId}/audit-history`);\n      setAuditHistory(response.data || []);\n    } catch (err: any) {\n      console.error(\"Load audit history error:\", err);\n      setAuditHistory([]);\n    } finally {\n      setAuditLoading(false);\n    }\n  }\n\n  // Close share menu when clicking outside\n  useEffect(() => {\n    if (showShareMenu) {\n      const handleClickOutside = (e: MouseEvent) => {\n        const target = e.target as HTMLElement;\n        if (!target.closest('.share-menu-container')) {\n          setShowShareMenu(false);\n        }\n      };\n      document.addEventListener('mousedown', handleClickOutside);\n      return () => document.removeEventListener('mousedown', handleClickOutside);\n    }\n  }, [showShareMenu]);\n\n\n  async function handleApprove() {\n    if (!confirm(\"Are you sure you want to approve this property?\")) return;\n    try {\n      setSaving(true);\n      await api.post(`/api/admin/properties/${propertyId}/approve`, { note: \"\" });\n      await loadProperty();\n      await loadAuditHistory();\n      onApproved?.();\n      setAdminNotice({\n        kind: \"success\",\n        title: \"Approved successfully\",\n        body: \"This property is now visible to guests. You can still edit details or suspend it later if needed.\",\n      });\n    } catch (err: any) {\n      const msg = err?.response?.data?.error || \"Failed to approve property\";\n      setAdminNotice({\n        kind: \"error\",\n        title: \"Approval failed\",\n        body: typeof msg === \"string\" ? msg : undefined,\n      });\n    } finally {\n      setSaving(false);\n    }\n  }\n\n  async function handleReject() {\n    if (!rejectReasons.trim()) {\n      alert(\"Please provide rejection reasons\");\n      return;\n    }\n    try {\n      setSaving(true);\n      // Split by comma and validate each reason is at least 2 characters (matching backend validation)\n      const reasons = rejectReasons.split(\",\").map((s) => s.trim()).filter(Boolean);\n      \n      // Validate reasons meet backend requirements\n      const invalidReasons = reasons.filter(r => r.length < 2 || r.length > 200);\n      if (invalidReasons.length > 0) {\n        alert(`Each reason must be between 2 and 200 characters. Invalid: ${invalidReasons.join(\", \")}`);\n        setSaving(false);\n        return;\n      }\n      \n      if (reasons.length === 0) {\n        alert(\"Please provide at least one valid rejection reason\");\n        setSaving(false);\n        return;\n      }\n      \n      await api.post(`/api/admin/properties/${propertyId}/reject`, { reasons, note: \"\" });\n      await loadProperty();\n      await loadAuditHistory();\n      setShowRejectDialog(false);\n      setRejectReasons(\"\");\n      onRejected?.();\n      alert(\"Property rejected successfully\");\n    } catch (err: any) {\n      const errorMessage = err?.response?.data?.error || err?.message || \"Failed to reject property\";\n      alert(typeof errorMessage === 'string' ? errorMessage : \"Failed to reject property. Please check that each reason is at least 2 characters long.\");\n      console.error(\"Reject property error:\", err);\n    } finally {\n      setSaving(false);\n    }\n  }\n\n  async function handleSaveEdit() {\n    try {\n      setSaving(true);\n      await api.patch(`/api/admin/properties/${propertyId}`, {\n        title: editData?.title,\n        description: editData?.description,\n        basePrice: editData?.basePrice,\n        currency: editData?.currency,\n      });\n      await loadProperty();\n      await loadAuditHistory();\n      setIsEditing(false);\n      onUpdated?.();\n      alert(\"Property updated successfully!\");\n    } catch (err: any) {\n      alert(err?.response?.data?.error || \"Failed to update property\");\n    } finally {\n      setSaving(false);\n    }\n  }\n\n  async function handleSuspend() {\n    if (!suspendReason.trim()) {\n      setAdminNotice({\n        kind: \"error\",\n        title: \"Suspension needs a reason\",\n        body: \"Please provide a reason for suspending this property.\",\n      });\n      return;\n    }\n    try {\n      setSaving(true);\n      await api.post(`/api/admin/properties/${propertyId}/suspend`, { \n        reason: suspendReason.trim(),\n        notifyOwner: notifyOwnerOnSuspend\n      });\n      await loadProperty();\n      await loadAuditHistory();\n      setShowSuspendDialog(false);\n      setSuspendReason(\"\");\n      setNotifyOwnerOnSuspend(true);\n      onUpdated?.();\n      setAdminNotice({\n        kind: \"success\",\n        title: \"Property suspended successfully\",\n        body: \"The property has been removed from public view.\",\n      });\n    } catch (err: any) {\n      const msg = err?.response?.data?.error || err?.message || \"Failed to suspend property\";\n      setAdminNotice({\n        kind: \"error\",\n        title: \"Failed to suspend property\",\n        body: typeof msg === \"string\" ? msg : undefined,\n      });\n    } finally {\n      setSaving(false);\n    }\n  }\n\n  async function handleUnsuspend() {\n    if (!unsuspendReason.trim()) {\n      setAdminNotice({\n        kind: \"error\",\n        title: \"Unsuspension needs a reason\",\n        body: \"Please provide a reason for unsuspending this property.\",\n      });\n      return;\n    }\n    try {\n      setSaving(true);\n      await api.post(`/api/admin/properties/${propertyId}/unsuspend`, { \n        reason: unsuspendReason.trim()\n      });\n      await loadProperty();\n      await loadAuditHistory();\n      setShowUnsuspendDialog(false);\n      setUnsuspendReason(\"\");\n      onUpdated?.();\n      setAdminNotice({\n        kind: \"success\",\n        title: \"Property unsuspended successfully\",\n        body: \"The property is now visible to the public again.\",\n      });\n    } catch (err: any) {\n      const msg = err?.response?.data?.error || err?.message || \"Failed to unsuspend property\";\n      setAdminNotice({\n        kind: \"error\",\n        title: \"Failed to unsuspend property\",\n        body: typeof msg === \"string\" ? msg : undefined,\n      });\n    } finally {\n      setSaving(false);\n    }\n  }\n\n\n  // Collect all images: property photos + room photos\n  // Must be called before early returns to maintain consistent hook order\n  const allImages = useMemo(() => {\n    if (!property) return [];\n\n    const isSafeNextImageSrc = (value: unknown): value is string => {\n      if (typeof value !== \"string\") return false;\n      const v = value.trim();\n      if (!v) return false;\n      if (v.startsWith(\"/\")) return true;\n      if (v.startsWith(\"http://\") || v.startsWith(\"https://\")) return true;\n      return false;\n    };\n\n    const normalizePhotoList = (value: unknown): string[] => {\n      if (Array.isArray(value)) {\n        return value.filter(isSafeNextImageSrc);\n      }\n\n      if (typeof value === \"string\") {\n        const raw = value.trim();\n        if (!raw) return [];\n\n        // Some APIs/DBs store arrays as JSON strings.\n        if (raw.startsWith(\"[\")) {\n          try {\n            const parsed = JSON.parse(raw);\n            if (Array.isArray(parsed)) {\n              return parsed.filter(isSafeNextImageSrc);\n            }\n          } catch {\n            // ignore\n          }\n        }\n\n        return isSafeNextImageSrc(raw) ? [raw] : [];\n      }\n\n      return [];\n    };\n\n    const propertyPhotosRaw = displayPhotos.length > 0 ? displayPhotos : (property as any).photos;\n    const propertyPhotos = normalizePhotoList(propertyPhotosRaw);\n    const roomPhotos: string[] = [];\n    \n    // Collect photos from all rooms\n    if (Array.isArray(property.roomsSpec)) {\n      property.roomsSpec.forEach((room: RoomSpec) => {\n        if (room?.photos && Array.isArray(room.photos)) {\n          roomPhotos.push(...room.photos.filter(isSafeNextImageSrc));\n        }\n        if (room?.roomImages && Array.isArray(room.roomImages)) {\n          roomPhotos.push(...room.roomImages.filter(isSafeNextImageSrc));\n        }\n      });\n    }\n    \n    // Combine property photos first, then room photos\n    return [...propertyPhotos, ...roomPhotos];\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [displayPhotos, property?.photos, property?.roomsSpec]);\n\n  // About this place - description handling\n  // Must be called before early returns to maintain consistent hook order\n  const about = useMemo(() => {\n    const fallback = \"No description provided yet.\";\n    const raw = String(property?.description || \"\").trim();\n    const text = raw ? raw : fallback;\n    const limit = 320;\n    const hasMore = raw.length > limit;\n    const collapsed = hasMore ? raw.slice(0, limit).trimEnd() + \"…\" : text;\n    return { raw, text, hasMore, collapsed };\n  }, [property?.description]);\n\n  // Derive building info even when DB fields are missing (older properties)\n  // Must be declared BEFORE early returns to maintain consistent hook order.\n  const derivedBuilding = useMemo(() => {\n    if (!property) return { type: \"\", floors: 1 };\n\n    const roomsSpec: any[] = Array.isArray((property as any)?.roomsSpec) ? (property as any).roomsSpec : [];\n    const layoutRaw = (property as any)?.layout;\n    let layout: any = layoutRaw;\n    if (typeof layoutRaw === \"string\" && layoutRaw.trim()) {\n      try { layout = JSON.parse(layoutRaw); } catch { layout = null; }\n    }\n\n    // Prefer explicit totalFloors if present\n    const explicitFloors = typeof (property as any)?.totalFloors === \"number\" && (property as any).totalFloors > 0\n      ? (property as any).totalFloors\n      : null;\n\n    let floors: number | null = explicitFloors;\n\n    // Try layout.floors length\n    if (!floors && layout && Array.isArray(layout.floors) && layout.floors.length > 0) {\n      floors = layout.floors.length;\n    }\n\n    // Try roomsSpec floorDistribution max key\n    if (!floors && roomsSpec.length > 0) {\n      let maxFloor = 0;\n      for (const r of roomsSpec) {\n        const fd = (r as any)?.floorDistribution;\n        let obj: any = null;\n        if (typeof fd === \"string\" && fd.trim()) {\n          try { obj = JSON.parse(fd); } catch { obj = null; }\n        } else if (fd && typeof fd === \"object\" && !Array.isArray(fd)) {\n          obj = fd;\n        }\n        if (obj && typeof obj === \"object\") {\n          for (const k of Object.keys(obj)) {\n            const n = Number(k);\n            if (Number.isFinite(n) && n > maxFloor) maxFloor = n;\n          }\n        }\n      }\n      if (maxFloor > 0) floors = maxFloor;\n    }\n\n    if (!floors) floors = 1;\n\n    const explicitType = String((property as any)?.buildingType || \"\").trim();\n    const type = explicitType ? explicitType : (floors > 1 ? \"multi_storey\" : \"single_storey\");\n\n    return { type, floors };\n  }, [property]);\n\n  const effectiveBuildingType = String((property as any)?.buildingType || \"\").trim() || derivedBuilding.type;\n  const effectiveTotalFloors =\n    (typeof (property as any)?.totalFloors === \"number\" && (property as any).totalFloors > 0)\n      ? (property as any).totalFloors\n      : derivedBuilding.floors;\n\n  if (loading) {\n    return (\n      <div className=\"flex items-center justify-center min-h-[400px]\">\n        <div className=\"text-center\">\n          <LogoSpinner size=\"md\" className=\"mx-auto mb-4\" ariaLabel=\"Loading property\" />\n          <p className=\"text-gray-600\">Loading property...</p>\n        </div>\n      </div>\n    );\n  }\n\n  if (error || !property) {\n    return (\n      <div className=\"flex items-center justify-center min-h-[400px]\">\n        <div className=\"text-center\">\n          <XCircle className=\"h-12 w-12 text-red-500 mx-auto mb-4\" />\n          <p className=\"text-gray-600\">{error || \"Property not found\"}</p>\n        </div>\n      </div>\n    );\n  }\n\n  const photos = allImages;\n  const rooms: RoomSpec[] = property.roomsSpec || [];\n  const servicesRaw = property.services;\n  const location = property.location || {};\n  const status = property.status;\n  const totalBedrooms = property.totalBedrooms;\n  const totalBathrooms = property.totalBathrooms;\n  const maxGuests = property.maxGuests;\n\n  // Parse services - can be JSON string, array of strings, or object\n  // Database stores services as JSON, which Prisma may return as string or already parsed object\n  let parsedServices: any = servicesRaw;\n  if (typeof servicesRaw === 'string' && servicesRaw.trim()) {\n    try {\n      parsedServices = JSON.parse(servicesRaw);\n    } catch {\n      // If parsing fails, treat as empty\n      parsedServices = null;\n    }\n  }\n  \n  // Handle null/undefined\n  if (!parsedServices) {\n    parsedServices = {};\n  }\n  \n  const servicesArray = Array.isArray(parsedServices) ? parsedServices : [];\n  const servicesObj = typeof parsedServices === 'object' && parsedServices !== null && !Array.isArray(parsedServices) ? parsedServices : {};\n  \n  // Debug logging for admin mode\n  if (mode === \"admin\") {\n    console.log('[PropertyPreview] Services Debug:', {\n      raw: servicesRaw,\n      parsed: parsedServices,\n      isArray: Array.isArray(parsedServices),\n      isObject: typeof parsedServices === 'object' && !Array.isArray(parsedServices),\n      servicesObjKeys: Object.keys(servicesObj),\n      servicesObj,\n      servicesArrayLength: servicesArray.length,\n    });\n  }\n  \n  // Normalize boolean values - handle both true/false and \"true\"/\"false\" strings\n  // Also handle undefined values (when service wasn't selected, it won't be in the object)\n  const normalizeBoolean = (value: any): boolean => {\n    if (value === undefined || value === null) return false;\n    if (typeof value === 'boolean') return value;\n    if (typeof value === 'string') return value.toLowerCase() === 'true';\n    return false;\n  };\n  \n  // Create normalized services object with proper boolean values\n  // Check for both direct properties and properties that might be nested\n  const normalizedServicesObj = {\n    // Preserve all original properties\n    ...servicesObj,\n    // Normalize boolean services - if property doesn't exist, default to false\n    breakfastIncluded: normalizeBoolean(servicesObj.breakfastIncluded),\n    breakfastAvailable: normalizeBoolean(servicesObj.breakfastAvailable),\n    restaurant: normalizeBoolean(servicesObj.restaurant),\n    bar: normalizeBoolean(servicesObj.bar),\n    pool: normalizeBoolean(servicesObj.pool),\n    sauna: normalizeBoolean(servicesObj.sauna),\n    laundry: normalizeBoolean(servicesObj.laundry),\n    roomService: normalizeBoolean(servicesObj.roomService),\n    security24: normalizeBoolean(servicesObj.security24),\n    firstAid: normalizeBoolean(servicesObj.firstAid),\n    fireExtinguisher: normalizeBoolean(servicesObj.fireExtinguisher),\n    onSiteShop: normalizeBoolean(servicesObj.onSiteShop),\n    nearbyMall: normalizeBoolean(servicesObj.nearbyMall),\n    socialHall: normalizeBoolean(servicesObj.socialHall),\n    sportsGames: normalizeBoolean(servicesObj.sportsGames),\n    gym: normalizeBoolean(servicesObj.gym),\n    parking: servicesObj.parking || 'no',\n    parkingPrice: servicesObj.parkingPrice || '',\n    // Preserve tags and nearbyFacilities\n    tags: servicesObj.tags || [],\n    nearbyFacilities: servicesObj.nearbyFacilities || [],\n  };\n  \n  // If services is an object with tags, use the tags array for amenities\n  const effectiveServicesArray = normalizedServicesObj.tags && Array.isArray(normalizedServicesObj.tags) \n    ? normalizedServicesObj.tags \n    : servicesArray;\n  \n  // Always parse tags to ensure we have the latest values, even if some properties exist\n  // This ensures we don't miss any services that might be in tags but not in individual properties\n  if (effectiveServicesArray.length > 0) {\n    // Parse tags to extract individual service properties\n    const tags = effectiveServicesArray.map((t: string) => String(t).toLowerCase());\n    \n    // Parking - only set if not already set or if tags have more specific info\n    if (!normalizedServicesObj.parking || normalizedServicesObj.parking === 'no') {\n      if (tags.some((t: string) => t.includes('free parking'))) {\n        normalizedServicesObj.parking = 'free';\n      } else if (tags.some((t: string) => t.includes('paid parking'))) {\n        normalizedServicesObj.parking = 'paid';\n        // Try to extract parking price from tag\n        const paidParkingTag = effectiveServicesArray.find((t: string) => t.toLowerCase().includes('paid parking'));\n        if (paidParkingTag) {\n          const priceMatch = paidParkingTag.match(/\\(([^)]+)\\)/);\n          if (priceMatch) {\n            normalizedServicesObj.parkingPrice = priceMatch[1].replace(/TZS/i, '').trim();\n          }\n        }\n      }\n    }\n    \n    // Other services - set to true if found in tags (even if already false, tags are source of truth)\n    if (tags.some((t: string) => t.includes('breakfast included'))) normalizedServicesObj.breakfastIncluded = true;\n    if (tags.some((t: string) => t.includes('breakfast available'))) normalizedServicesObj.breakfastAvailable = true;\n    if (tags.some((t: string) => t.includes('restaurant'))) normalizedServicesObj.restaurant = true;\n    if (tags.some((t: string) => t.includes('bar'))) normalizedServicesObj.bar = true;\n    if (tags.some((t: string) => t.includes('pool'))) normalizedServicesObj.pool = true;\n    if (tags.some((t: string) => t.includes('sauna'))) normalizedServicesObj.sauna = true;\n    if (tags.some((t: string) => t.includes('laundry'))) normalizedServicesObj.laundry = true;\n    if (tags.some((t: string) => t.includes('room service'))) normalizedServicesObj.roomService = true;\n    if (tags.some((t: string) => t.includes('24h security') || t.includes('24-hour security'))) normalizedServicesObj.security24 = true;\n    if (tags.some((t: string) => t.includes('first aid'))) normalizedServicesObj.firstAid = true;\n    if (tags.some((t: string) => t.includes('fire extinguisher'))) normalizedServicesObj.fireExtinguisher = true;\n    if (tags.some((t: string) => t.includes('on-site shop'))) normalizedServicesObj.onSiteShop = true;\n    if (tags.some((t: string) => t.includes('nearby mall'))) normalizedServicesObj.nearbyMall = true;\n    if (tags.some((t: string) => t.includes('social hall'))) normalizedServicesObj.socialHall = true;\n    if (tags.some((t: string) => t.includes('sports') || t.includes('games'))) normalizedServicesObj.sportsGames = true;\n    if (tags.some((t: string) => t.includes('gym'))) normalizedServicesObj.gym = true;\n    \n    // Debug logging\n    if (mode === \"admin\") {\n      console.log('[PropertyPreview] Parsed services from tags:', {\n        tagsCount: tags.length,\n        parking: normalizedServicesObj.parking,\n        breakfastIncluded: normalizedServicesObj.breakfastIncluded,\n        restaurant: normalizedServicesObj.restaurant,\n        bar: normalizedServicesObj.bar,\n        pool: normalizedServicesObj.pool,\n        sauna: normalizedServicesObj.sauna,\n        laundry: normalizedServicesObj.laundry,\n        roomService: normalizedServicesObj.roomService,\n        security24: normalizedServicesObj.security24,\n        firstAid: normalizedServicesObj.firstAid,\n        fireExtinguisher: normalizedServicesObj.fireExtinguisher,\n        onSiteShop: normalizedServicesObj.onSiteShop,\n        nearbyMall: normalizedServicesObj.nearbyMall,\n        socialHall: normalizedServicesObj.socialHall,\n        sportsGames: normalizedServicesObj.sportsGames,\n        gym: normalizedServicesObj.gym,\n      });\n    }\n  }\n  \n  // Extract nearby facilities - check both services array (as JSON string) and services object\n  // Use normalizedServicesObj which includes nearbyFacilities\n  let nearbyFacilities: any[] = [];\n  try {\n    // First check normalized object (which preserves nearbyFacilities)\n    if (normalizedServicesObj.nearbyFacilities && Array.isArray(normalizedServicesObj.nearbyFacilities)) {\n      nearbyFacilities = normalizedServicesObj.nearbyFacilities;\n    }\n    // Fallback: Try to find nearbyFacilities in original services object\n    else if (servicesObj.nearbyFacilities && Array.isArray(servicesObj.nearbyFacilities)) {\n      nearbyFacilities = servicesObj.nearbyFacilities;\n    }\n    // Also check if it's stored as a JSON string in the services array\n    const facilitiesStr = effectiveServicesArray.find((s: string) => s.includes('nearbyFacilities') || s.startsWith('['));\n    if (facilitiesStr && nearbyFacilities.length === 0) {\n      try {\n        const parsed = JSON.parse(facilitiesStr);\n        if (Array.isArray(parsed)) nearbyFacilities = parsed;\n      } catch {}\n    }\n  } catch {}\n\n  // Build comprehensive amenities list from services array/object\n  const parseServiceLabel = (s: string) => {\n    if (s.includes(\"Free parking\")) return { key: \"parking\", label: \"Free Parking\", icon: Car, value: true };\n    if (s.includes(\"Paid parking\")) return { key: \"parking\", label: s, icon: Car, value: true };\n    if (s.includes(\"Restaurant\")) return { key: \"restaurant\", label: \"Restaurant\", icon: UtensilsCrossed, value: true };\n    if (s.includes(\"Bar\")) return { key: \"bar\", label: \"Bar\", icon: Beer, value: true };\n    if (s.includes(\"Pool\")) return { key: \"pool\", label: \"Swimming Pool\", icon: Waves, value: true };\n    if (s.includes(\"Sauna\")) return { key: \"sauna\", label: \"Sauna\", icon: Thermometer, value: true };\n    if (s.includes(\"Laundry\")) return { key: \"laundry\", label: \"Laundry\", icon: WashingMachine, value: true };\n    if (s.includes(\"Room service\")) return { key: \"roomService\", label: \"Room Service\", icon: Package, value: true };\n    if (s.includes(\"24h security\") || s.includes(\"24-hour security\")) return { key: \"security\", label: \"24/7 Security\", icon: Shield, value: true };\n    if (s.includes(\"First aid\")) return { key: \"firstAid\", label: \"First Aid\", icon: Bandage, value: true };\n    if (s.includes(\"Fire extinguisher\")) return { key: \"fireExtinguisher\", label: \"Fire Extinguisher\", icon: FireExtinguisher, value: true };\n    if (s.includes(\"On-site shop\")) return { key: \"onSiteShop\", label: \"On-site Shop\", icon: ShoppingBag, value: true };\n    if (s.includes(\"Nearby mall\")) return { key: \"nearbyMall\", label: \"Nearby Mall\", icon: Store, value: true };\n    if (s.includes(\"Social hall\")) return { key: \"socialHall\", label: \"Social Hall\", icon: PartyPopper, value: true };\n    if (s.includes(\"Sports\") || s.includes(\"Sports & games\")) return { key: \"sports\", label: \"Sports & Games\", icon: Gamepad, value: true };\n    if (s.includes(\"Gym\")) return { key: \"gym\", label: \"Gym / Fitness Center\", icon: Dumbbell, value: true };\n    return null;\n  };\n\n  const amenities = effectiveServicesArray.map(parseServiceLabel).filter(Boolean) as Array<{ key: string; label: string; icon: any; value: boolean }>;\n  \n  // Add common amenities that might be in services object\n  if (servicesObj.wifi || effectiveServicesArray.some((s: string) => s.toLowerCase().includes(\"wifi\"))) {\n    amenities.push({ key: \"wifi\", label: \"Free WiFi\", icon: Wifi, value: true });\n  }\n  if (servicesObj.ac || effectiveServicesArray.some((s: string) => s.toLowerCase().includes(\"air conditioning\"))) {\n    amenities.push({ key: \"ac\", label: \"Air Conditioning\", icon: AirVent, value: true });\n  }\n\n  return (\n    <div className=\"w-full bg-white\">\n      {/* Header with Status and Actions */}\n      {mode === \"admin\" && (\n        <div className=\"bg-white border-b border-gray-200 shadow-sm mb-6\">\n          <div className=\"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4\">\n            <div className=\"flex items-center justify-between\">\n              <div className=\"flex items-center gap-3\">\n                {onClose && (\n                  <button\n                    onClick={onClose}\n                    className=\"group flex items-center justify-center w-9 h-9 rounded-full hover:bg-slate-100 transition-colors\"\n                    aria-label=\"Back\"\n                  >\n                    <ChevronLeft className=\"w-5 h-5 text-slate-600 group-hover:text-slate-900\" />\n                  </button>\n                )}\n                <span className={`px-3 py-1 rounded-full text-sm font-medium ${\n                  status === \"PENDING\" ? \"bg-amber-100 text-amber-800\" :\n                  status === \"APPROVED\" ? \"bg-emerald-100 text-emerald-800\" :\n                  status === \"REJECTED\" ? \"bg-red-100 text-red-800\" :\n                  status === \"SUSPENDED\" ? \"bg-orange-100 text-orange-800\" :\n                  \"bg-gray-100 text-gray-800\"\n                }`}>\n                  {status}\n                </span>\n                {property.owner && (\n                  <div className=\"text-sm text-gray-600\">\n                    Owner: <span className=\"font-medium\">{property.owner.name || property.owner.email}</span>\n                  </div>\n                )}\n              </div>\n              <div className=\"flex items-center gap-2\">\n                {!isEditing ? (\n                  <>\n                    <button\n                      onClick={() => setShowEditModal(true)}\n                      className=\"flex items-center gap-2 px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors\"\n                    >\n                      <Edit className=\"h-4 w-4\" />\n                      Edit\n                    </button>\n                    {status === \"APPROVED\" && (\n                      <button\n                        onClick={() => setShowSuspendDialog(true)}\n                        disabled={saving}\n                        className=\"flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-orange-600 rounded-lg hover:bg-orange-700 transition-colors disabled:opacity-50\"\n                      >\n                        <Ban className=\"h-4 w-4\" />\n                        Suspend\n                      </button>\n                    )}\n                    {status === \"SUSPENDED\" && (\n                      <button\n                        onClick={() => setShowUnsuspendDialog(true)}\n                        disabled={saving}\n                        className=\"flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50\"\n                      >\n                        <CheckCircle2 className=\"h-4 w-4\" />\n                        Unsuspend\n                      </button>\n                    )}\n                    {status === \"PENDING\" && (\n                      <>\n                        <button\n                          onClick={handleApprove}\n                          disabled={saving}\n                          className=\"flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-emerald-600 rounded-lg hover:bg-emerald-700 transition-colors disabled:opacity-50\"\n                        >\n                          <CheckCircle2 className=\"h-4 w-4\" />\n                          Approve\n                        </button>\n                        <button\n                          onClick={() => setShowRejectDialog(true)}\n                          disabled={saving}\n                          className=\"flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700 transition-colors disabled:opacity-50\"\n                        >\n                          <XCircle className=\"h-4 w-4\" />\n                          Reject\n                        </button>\n                      </>\n                    )}\n                  </>\n                ) : (\n                  <>\n                    <button\n                      onClick={() => {\n                        setIsEditing(false);\n                        setEditData(property);\n                      }}\n                      className=\"flex items-center gap-2 px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors\"\n                    >\n                      <X className=\"h-4 w-4\" />\n                      Cancel\n                    </button>\n                    <button\n                      onClick={handleSaveEdit}\n                      disabled={saving}\n                      className=\"flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-emerald-600 rounded-lg hover:bg-emerald-700 transition-colors disabled:opacity-50\"\n                    >\n                      <Save className=\"h-4 w-4\" />\n                      {saving ? \"Saving...\" : \"Save\"}\n                    </button>\n                  </>\n                )}\n              </div>\n            </div>\n\n            {/* Admin action banner (approval success/failure, etc.) */}\n            {adminNotice ? (\n              <div\n                role=\"status\"\n                aria-live=\"polite\"\n                className={[\n                  \"mt-4 rounded-xl border px-4 py-3 flex items-start justify-between gap-3\",\n                  adminNotice.kind === \"success\"\n                    ? \"border-emerald-200 bg-emerald-50 text-emerald-900\"\n                    : adminNotice.kind === \"error\"\n                      ? \"border-red-200 bg-red-50 text-red-900\"\n                      : \"border-slate-200 bg-slate-50 text-slate-900\",\n                ].join(\" \")}\n              >\n                <div className=\"min-w-0\">\n                  <div className=\"text-sm font-semibold\">{adminNotice.title}</div>\n                  {adminNotice.body ? (\n                    <div className=\"text-sm opacity-90 mt-0.5\">{adminNotice.body}</div>\n                  ) : null}\n                </div>\n                <button\n                  type=\"button\"\n                  onClick={() => setAdminNotice(null)}\n                  className=\"shrink-0 inline-flex items-center justify-center rounded-lg border border-transparent hover:border-black/10 hover:bg-white/40 px-2 py-1 text-sm\"\n                  aria-label=\"Dismiss message\"\n                  title=\"Dismiss\"\n                >\n                  <X className=\"h-4 w-4\" />\n                </button>\n              </div>\n            ) : null}\n          </div>\n        </div>\n      )}\n\n      {/* Main Content Container */}\n      <div className=\"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8\">\n        {/* Title and Location - Match Public View */}\n        <div className=\"mt-5\">\n          <h1 className=\"mt-2 text-2xl sm:text-3xl font-bold tracking-tight\">\n            {isEditing ? (\n              <input\n                type=\"text\"\n                value={editData?.title || \"\"}\n                onChange={(e) => setEditData({ ...editData, title: e.target.value })}\n                className=\"w-full px-3 py-2 border border-gray-300 rounded-lg text-2xl sm:text-3xl font-bold\"\n                aria-label=\"Property title\"\n                title=\"Property title\"\n              />\n            ) : (\n              property.title\n            )}\n          </h1>\n          <div className=\"mt-2 flex items-center gap-2 text-sm text-slate-600\">\n            <MapPin className=\"w-4 h-4\" />\n            <span className=\"truncate\">\n              {location.street && `${location.street}${location.apartment ? `, ${location.apartment}` : ''}, `}\n              {location.ward && `${location.ward}, `}\n              {location.district && `${location.district}, `}\n              {location.regionName && location.regionName}\n              {location.city && `, ${location.city}`}\n              {!location.street && !location.ward && !location.district && !location.regionName && !location.city && \"—\"}\n                    </span>\n              </div>\n            </div>\n\n        {/* Gallery */}\n        <div className=\"mt-6\">\n        {photos.length > 0 ? (\n          <div className=\"grid grid-cols-1 md:grid-cols-3 gap-3 rounded-2xl overflow-hidden border border-slate-200\">\n                  <button\n              type=\"button\"\n              className={[\n                \"relative md:col-span-2 aspect-[16/10] bg-slate-100 cursor-pointer rounded-2xl overflow-hidden\",\n                \"motion-safe:transition-transform motion-safe:duration-200 motion-safe:ease-out\",\n                \"motion-safe:hover:scale-[1.01] motion-safe:active:scale-[0.98]\",\n                \"focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[#02665e]/30 focus-visible:ring-offset-2 focus-visible:ring-offset-white\",\n              ].join(\" \")}\n                    onClick={() => {\n                      setSelectedImageIndex(0);\n                  setShowLightbox(true);\n                    }}\n              aria-label=\"Open photo gallery\"\n                  >\n                    <FillImage\n                      src={photos[0]}\n                      alt=\"\"\n                      className=\"object-cover\"\n                      sizes=\"(min-width: 768px) 66vw, 100vw\"\n                      priority\n                    />\n              <div className=\"absolute inset-0 bg-gradient-to-t from-black/55 via-black/0 to-black/0\" />\n              <div className=\"absolute left-4 bottom-4 inline-flex items-center gap-2 rounded-full bg-white/90 border border-white/70 px-3 py-1 text-xs font-semibold text-slate-900\">\n                Approved photos • {photos.length}\n              </div>\n                  </button>\n            <div className=\"grid grid-cols-2 md:grid-cols-1 gap-3 bg-white p-3\">\n              {/* Photo 2 */}\n              {photos[1] ? (\n                  <button\n                  type=\"button\"\n                  className={[\n                    \"relative aspect-[16/10] bg-slate-100 rounded-xl overflow-hidden cursor-pointer\",\n                    \"motion-safe:transition-transform motion-safe:duration-200 motion-safe:ease-out\",\n                    \"motion-safe:hover:scale-[1.01] motion-safe:active:scale-[0.98]\",\n                    \"focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[#02665e]/30 focus-visible:ring-offset-2 focus-visible:ring-offset-white\",\n                  ].join(\" \")}\n                    onClick={() => {\n                    setSelectedImageIndex(1);\n                      setShowLightbox(true);\n                    }}\n                  aria-label=\"Open photo 2\"\n                    >\n                      <FillImage\n                        src={photos[1]}\n                        alt=\"\"\n                        className=\"object-cover\"\n                        sizes=\"(min-width: 768px) 22vw, 50vw\"\n                      />\n                  </button>\n              ) : (\n                <div className=\"relative aspect-[16/10] bg-slate-100 rounded-xl overflow-hidden\">\n                  <div className=\"absolute inset-0 bg-[radial-gradient(circle_at_25%_25%,rgba(2,102,94,0.10),transparent_55%),linear-gradient(135deg,#f8fafc,#e2e8f0)]\" />\n                  <div className=\"absolute inset-0 shadow-[inset_0_0_0_1px_rgba(15,23,42,0.06)]\" />\n                  <div className=\"absolute inset-0 flex items-center justify-center\">\n                    <ImageIcon className=\"w-6 h-6 text-slate-400\" aria-hidden />\n          </div>\n      </div>\n              )}\n\n              {/* Photo 3 (or View all photos tile) */}\n              {photos[2] ? (\n              <button\n                  type=\"button\"\n                  className={[\n                    \"relative aspect-[16/10] bg-slate-100 rounded-xl overflow-hidden cursor-pointer\",\n                    \"motion-safe:transition-transform motion-safe:duration-200 motion-safe:ease-out\",\n                    \"motion-safe:hover:scale-[1.01] motion-safe:active:scale-[0.98]\",\n                    \"focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[#02665e]/30 focus-visible:ring-offset-2 focus-visible:ring-offset-white\",\n                  ].join(\" \")}\n                onClick={() => {\n                    const hasMorePhotos = photos.length > 3;\n                    if (hasMorePhotos) {\n                      setSelectedImageIndex(0);\n                      setShowLightbox(true);\n                    } else {\n                      setSelectedImageIndex(2);\n                      setShowLightbox(true);\n                    }\n                    }}\n                  aria-label={photos.length > 3 ? \"View all photos\" : \"Open photo 3\"}\n                  >\n                    <FillImage\n                      src={photos[2]}\n                      alt=\"\"\n                      className=\"object-cover\"\n                      sizes=\"(min-width: 768px) 22vw, 50vw\"\n                    />\n                  {photos.length > 3 && (\n                    <div className=\"absolute left-3 right-3 bottom-3 flex items-center justify-start\">\n                      <div\n                        className=\"nls-blink inline-flex items-center gap-2 rounded-full bg-white/95 text-[#02665e] px-4 py-2 text-xs font-semibold shadow-sm ring-1 ring-black/5 whitespace-nowrap leading-none [animation-duration:1.8s]\"\n                  >\n                        <Eye className=\"w-4 h-4 flex-shrink-0 text-[#02665e]\" aria-hidden />\n                        <span className=\"leading-none\">View all photos</span>\n            </div>\n          </div>\n            )}\n                </button>\n        ) : (\n                <div className=\"relative aspect-[16/10] bg-slate-100 rounded-xl overflow-hidden\">\n                  <div className=\"absolute inset-0 bg-[radial-gradient(circle_at_25%_25%,rgba(2,102,94,0.10),transparent_55%),linear-gradient(135deg,#f8fafc,#e2e8f0)]\" />\n                  <div className=\"absolute inset-0 shadow-[inset_0_0_0_1px_rgba(15,23,42,0.06)]\" />\n                  <div className=\"absolute inset-0 flex items-center justify-center\">\n                    <ImageIcon className=\"w-6 h-6 text-slate-400\" aria-hidden />\n                              </div>\n                          </div>\n              )}\n                        </div>\n              </div>\n        ) : (\n          <div>\n            {/* Photo layout preview (until Cloudinary / approved photos are available) */}\n            <div className=\"grid grid-cols-1 md:grid-cols-3 gap-3 rounded-2xl overflow-hidden border border-slate-200\">\n                        <button\n                type=\"button\"\n                          onClick={() => {\n                  setSelectedImageIndex(0);\n                  setShowLightbox(true);\n                }}\n                className={[\n                  \"relative md:col-span-2 aspect-[16/10] bg-slate-100 rounded-2xl overflow-hidden cursor-pointer\",\n                  \"motion-safe:transition-transform motion-safe:duration-200 motion-safe:ease-out\",\n                  \"motion-safe:hover:scale-[1.01] motion-safe:active:scale-[0.98]\",\n                  \"focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[#02665e]/30 focus-visible:ring-offset-2 focus-visible:ring-offset-white\",\n                ].join(\" \")}\n                aria-label=\"View all photos\"\n              >\n                <div className=\"absolute inset-0 bg-[radial-gradient(circle_at_30%_20%,rgba(2,102,94,0.14),transparent_55%),radial-gradient(circle_at_75%_85%,rgba(2,132,199,0.10),transparent_55%),linear-gradient(135deg,#f8fafc,#e2e8f0)]\" />\n                <div className=\"absolute inset-0 bg-gradient-to-t from-black/10 via-black/0 to-white/35\" />\n                <div className=\"absolute inset-0 shadow-[inset_0_0_0_1px_rgba(15,23,42,0.06)]\" />\n                <div className=\"absolute inset-0 flex flex-col items-center justify-center text-slate-700\">\n                  <div className=\"h-14 w-14 rounded-2xl bg-white/85 border border-slate-200 shadow-sm flex items-center justify-center\">\n                    <ImageIcon className=\"w-7 h-7 text-slate-500\" aria-hidden />\n                      </div>\n                  <div className=\"mt-3 text-sm font-semibold\">Photo preview</div>\n                  <div className=\"text-xs text-slate-500\">Hero image will appear here</div>\n                    </div>\n                <div className=\"absolute left-4 bottom-4 inline-flex items-center gap-2 rounded-full bg-white/90 border border-white/70 px-3 py-1 text-xs font-semibold text-slate-900\">\n                  Approved photos • 0\n              </div>\n                          </button>\n              <div className=\"grid grid-cols-2 md:grid-cols-1 gap-3 bg-white p-3\">\n                {Array.from({ length: 2 }).map((_, i) => (\n                              <button\n                    key={i}\n                    type=\"button\"\n                                onClick={() => {\n                      setSelectedImageIndex(0);\n                      setShowLightbox(true);\n                    }}\n                    className={[\n                      \"relative aspect-[16/10] bg-slate-100 rounded-xl overflow-hidden cursor-pointer\",\n                      \"motion-safe:transition-transform motion-safe:duration-200 motion-safe:ease-out\",\n                      \"motion-safe:hover:scale-[1.01] motion-safe:active:scale-[0.98]\",\n                      \"focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[#02665e]/30 focus-visible:ring-offset-2 focus-visible:ring-offset-white\",\n                    ].join(\" \")}\n                    aria-label=\"View all photos\"\n                  >\n                    <div className=\"absolute inset-0 bg-[radial-gradient(circle_at_25%_25%,rgba(2,102,94,0.10),transparent_55%),linear-gradient(135deg,#f8fafc,#e2e8f0)]\" />\n                    <div className=\"absolute inset-0 shadow-[inset_0_0_0_1px_rgba(15,23,42,0.06)]\" />\n                    <div className=\"absolute inset-0 flex items-center justify-center\">\n                      <ImageIcon className=\"w-6 h-6 text-slate-400\" aria-hidden />\n                            </div>\n                    {i === 1 && (\n                      <div className=\"absolute left-3 right-3 bottom-3 flex items-center justify-start\">\n                        <div\n                          className=\"nls-blink inline-flex items-center gap-2 rounded-full bg-white/95 text-[#02665e] px-4 py-2 text-xs font-semibold shadow-sm ring-1 ring-black/5 whitespace-nowrap leading-none [animation-duration:1.8s]\"\n                        >\n                          <Eye className=\"w-4 h-4 flex-shrink-0 text-[#02665e]\" aria-hidden />\n                          <span className=\"leading-none\">View all photos</span>\n                      </div>\n                        </div>\n                      )}\n                          </button>\n                ))}\n                        </div>\n                        </div>\n                        </div>\n                      )}\n                    </div>\n                  \n        {/* Facts - Match Public View */}\n                  {(totalBedrooms || totalBathrooms || maxGuests) && (\n          <div className=\"mt-6 rounded-2xl border border-slate-200 bg-white p-5\">\n            <div className=\"grid grid-cols-2 sm:grid-cols-4 gap-3 text-sm\">\n              {maxGuests && (\n                <div className=\"rounded-xl bg-slate-50 border border-slate-200 p-3\">\n                  <div className=\"flex items-center gap-2 text-slate-700\">\n                    <span className=\"text-slate-600\"><Users className=\"w-4 h-4\" /></span>\n                    <span className=\"text-xs font-semibold\">Guests</span>\n                        </div>\n                  <div className=\"mt-2 text-sm font-bold text-slate-900\">{maxGuests}</div>\n                        </div>\n                      )}\n                      {totalBedrooms && (\n                <div className=\"rounded-xl bg-slate-50 border border-slate-200 p-3\">\n                  <div className=\"flex items-center gap-2 text-slate-700\">\n                    <span className=\"text-slate-600\"><BedDouble className=\"w-4 h-4\" /></span>\n                    <span className=\"text-xs font-semibold\">Bedrooms</span>\n                        </div>\n                  <div className=\"mt-2 text-sm font-bold text-slate-900\">{totalBedrooms}</div>\n                        </div>\n                      )}\n                      {totalBathrooms && (\n                <div className=\"rounded-xl bg-slate-50 border border-slate-200 p-3\">\n                  <div className=\"flex items-center gap-2 text-slate-700\">\n                    <span className=\"text-slate-600\"><Bath className=\"w-4 h-4\" /></span>\n                    <span className=\"text-xs font-semibold\">Bathrooms</span>\n                        </div>\n                  <div className=\"mt-2 text-sm font-bold text-slate-900\">{totalBathrooms}</div>\n                        </div>\n                      )}\n              {property.status === \"APPROVED\" && (\n                <div className=\"rounded-xl bg-slate-50 border border-slate-200 p-3\">\n                  <div className=\"flex items-center gap-2 text-slate-700\">\n                    <span className=\"text-slate-600\"><BadgeCheck className=\"w-4 h-4\" /></span>\n                    <span className=\"text-xs font-semibold\">Status</span>\n                  </div>\n                  <div className=\"mt-2 text-sm font-bold text-slate-900\">Verified</div>\n                    </div>\n                  )}\n                </div>\n                    </div>\n                  )}\n\n      {/* Main Content */}\n      <div className=\"mt-6\">\n        <div className=\"space-y-6\">\n\n            {/* Amenities - Match Public View */}\n            {/* About this place */}\n            <section className=\"border-b border-gray-200 pb-6\">\n              <div className=\"rounded-2xl border border-slate-200 bg-white overflow-hidden\">\n                <div className=\"p-5 sm:p-6\">\n                  <div className=\"flex items-start justify-between gap-3\">\n                    <div className=\"min-w-0\">\n                        <div className=\"flex items-center gap-2\">\n                        <span className=\"inline-flex h-9 w-9 items-center justify-center rounded-xl bg-[#02665e]/10 text-[#02665e]\">\n                          <FileText className=\"w-5 h-5\" aria-hidden />\n                        </span>\n                        <div>\n                          <h2 className=\"text-lg font-semibold text-slate-900\">About this place</h2>\n                          <div className=\"text-xs text-slate-500\">What the host says about the property</div>\n                    </div>\n                </div>\n              </div>\n                    {about.hasMore ? (\n                      <button\n                        type=\"button\"\n                        onClick={() => setAboutExpanded((v) => !v)}\n                        className=\"inline-flex items-center justify-center rounded-full border border-slate-200 bg-white px-3 py-1.5 text-xs font-semibold text-slate-700 hover:bg-slate-50\"\n                      >\n                        {aboutExpanded ? \"Show less\" : \"Read more\"}\n                      </button>\n                    ) : null}\n            </div>\n\n                  <div className=\"mt-4 relative\">\n                    <p className=\"text-[15px] sm:text-sm text-slate-700 leading-relaxed whitespace-pre-wrap italic\">\n                      {aboutExpanded ? about.text : about.collapsed}\n                    </p>\n                    {!aboutExpanded && about.hasMore ? (\n                      <div className=\"pointer-events-none absolute inset-x-0 bottom-0 h-10 bg-gradient-to-t from-white to-white/0\" />\n                    ) : null}\n                        </div>\n                        </div>\n                </div>\n              </section>\n\n\n            {/* Services & Facilities - Simple List */}\n            {(() => {\n              // Check if there are any services to display using normalized values\n              const hasServices = \n                (normalizedServicesObj.parking && normalizedServicesObj.parking !== 'no') ||\n                normalizedServicesObj.breakfastIncluded ||\n                normalizedServicesObj.breakfastAvailable ||\n                normalizedServicesObj.restaurant ||\n                normalizedServicesObj.bar ||\n                normalizedServicesObj.pool ||\n                normalizedServicesObj.sauna ||\n                normalizedServicesObj.laundry ||\n                normalizedServicesObj.roomService ||\n                normalizedServicesObj.security24 ||\n                normalizedServicesObj.firstAid ||\n                normalizedServicesObj.fireExtinguisher ||\n                normalizedServicesObj.onSiteShop ||\n                normalizedServicesObj.nearbyMall ||\n                normalizedServicesObj.socialHall ||\n                normalizedServicesObj.sportsGames ||\n                normalizedServicesObj.gym ||\n                (Array.isArray(normalizedServicesObj.nearbyFacilities) && normalizedServicesObj.nearbyFacilities.length > 0) ||\n                nearbyFacilities.length > 0 ||\n                servicesArray.length > 0 ||\n                (Array.isArray(normalizedServicesObj.tags) && normalizedServicesObj.tags.length > 0);\n              \n              // Debug logging\n              if (mode === \"admin\") {\n                console.log('[PropertyPreview] hasServices check:', {\n                  hasServices,\n                  parking: normalizedServicesObj.parking,\n                  breakfastIncluded: normalizedServicesObj.breakfastIncluded,\n                  breakfastAvailable: normalizedServicesObj.breakfastAvailable,\n                  restaurant: normalizedServicesObj.restaurant,\n                  bar: normalizedServicesObj.bar,\n                  pool: normalizedServicesObj.pool,\n                  sauna: normalizedServicesObj.sauna,\n                  laundry: normalizedServicesObj.laundry,\n                  roomService: normalizedServicesObj.roomService,\n                  security24: normalizedServicesObj.security24,\n                  firstAid: normalizedServicesObj.firstAid,\n                  fireExtinguisher: normalizedServicesObj.fireExtinguisher,\n                  onSiteShop: normalizedServicesObj.onSiteShop,\n                  nearbyMall: normalizedServicesObj.nearbyMall,\n                  socialHall: normalizedServicesObj.socialHall,\n                  sportsGames: normalizedServicesObj.sportsGames,\n                  gym: normalizedServicesObj.gym,\n                  nearbyFacilitiesCount: nearbyFacilities.length,\n                  servicesArrayLength: servicesArray.length,\n                  tagsLength: Array.isArray(normalizedServicesObj.tags) ? normalizedServicesObj.tags.length : 0,\n                });\n              }\n              \n              return hasServices || nearbyFacilities.length > 0;\n            })() && (\n              <section className=\"border-b border-gray-200 pb-6\">\n                <ServicesAndFacilities\n                  normalizedServicesObj={normalizedServicesObj}\n                  effectiveServicesArray={effectiveServicesArray}\n                  servicesArray={servicesArray}\n                />\n\n                {/* Nearby Services - Separate Section with Proper Spacing */}\n                {nearbyFacilities.length > 0 && (\n                  <div className=\"mt-8 pt-8 border-t border-slate-200\">\n                    <NearbyServices\n                      facilities={nearbyFacilities}\n                      defaultExpanded={false}\n                      showExpandButton={nearbyFacilities.length > 2}\n                      maxInitialDisplay={2}\n                    />\n                  </div>\n                )}\n              </section>\n            )}\n\n            {/* Policies & Payments (derived from services tags) - Admin/Owner Only */}\n            {(mode === \"admin\" || mode === \"owner\") && (() => {\n              const tags: string[] = Array.isArray((normalizedServicesObj as any)?.tags)\n                ? (normalizedServicesObj as any).tags.filter((t: any) => typeof t === \"string\")\n                : [];\n              const freeCancellation = tags.some((t) => t.toLowerCase() === \"free cancellation\");\n              const groupStay = tags.some((t) => t.toLowerCase() === \"group stay\");\n              const paymentModes = tags\n                .filter((t) => /^payment:/i.test(t))\n                .map((t) => t.replace(/^payment:\\s*/i, \"\").trim())\n                .filter(Boolean);\n\n              if (!freeCancellation && !groupStay && paymentModes.length === 0) return null;\n\n              return (\n                <section className=\"border-b border-gray-200 pb-6\">\n                  <div className=\"rounded-2xl border border-slate-200 bg-white p-5 sm:p-6 shadow-sm\">\n                    <div className=\"flex items-center gap-2 mb-4\">\n                      <span className=\"inline-flex h-9 w-9 items-center justify-center rounded-xl bg-[#02665e]/10 text-[#02665e]\">\n                        <Shield className=\"w-5 h-5\" aria-hidden />\n                      </span>\n                      <h2 className=\"text-lg font-semibold text-slate-900\">Policies & Payments</h2>\n                    </div>\n\n                    <div className=\"flex flex-wrap gap-2\">\n                      {freeCancellation && (\n                        <span className=\"inline-flex items-center rounded-full bg-emerald-50 text-emerald-800 border border-emerald-200 px-3 py-1 text-xs font-semibold\">\n                          Free cancellation\n                        </span>\n                      )}\n                      {groupStay && (\n                        <span className=\"inline-flex items-center rounded-full bg-indigo-50 text-indigo-800 border border-indigo-200 px-3 py-1 text-xs font-semibold\">\n                          Group stay accepted\n                        </span>\n                      )}\n                      {paymentModes.map((m) => (\n                        <span\n                          key={m}\n                          className=\"inline-flex items-center rounded-full bg-slate-50 text-slate-800 border border-slate-200 px-3 py-1 text-xs font-semibold\"\n                        >\n                          Payment: {m}\n                        </span>\n                      ))}\n                    </div>\n                  </div>\n                </section>\n              );\n            })()}\n\n            {/* Building Structure Information - Admin/Owner Only */}\n            {(mode === \"admin\" || mode === \"owner\") && (effectiveBuildingType || effectiveTotalFloors) && (\n              <section className=\"border-b border-gray-200 pb-6\">\n                <div className=\"rounded-2xl border border-slate-200 bg-gradient-to-br from-slate-50 via-white to-emerald-50/40 p-5 sm:p-6 shadow-sm\">\n                  <div className=\"flex items-center gap-2 mb-4\">\n                    <span className=\"inline-flex h-9 w-9 items-center justify-center rounded-xl bg-[#02665e]/10 text-[#02665e]\">\n                      <Building2 className=\"w-5 h-5\" aria-hidden />\n                    </span>\n                    <h2 className=\"text-lg font-semibold text-slate-900\">Building Structure</h2>\n                  </div>\n                  <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4\">\n                    {effectiveBuildingType && (\n                      <div className=\"rounded-lg border border-slate-200 bg-gradient-to-br from-slate-50 to-white p-3\">\n                        <div className=\"text-xs font-semibold text-slate-500 uppercase tracking-wide mb-1\">Building Type</div>\n                        <div className=\"text-sm font-medium text-slate-900\">\n                          {effectiveBuildingType === \"single_storey\" ? \"Single Storey\" : \n                           effectiveBuildingType === \"multi_storey\" ? \"Multi-Storey\" : \n                           effectiveBuildingType === \"separate_units\" ? \"Separate Units\" : \n                           effectiveBuildingType}\n                        </div>\n                      </div>\n                    )}\n                    {typeof effectiveTotalFloors === \"number\" && effectiveTotalFloors > 0 && (\n                      <div className=\"rounded-lg border border-slate-200 bg-gradient-to-br from-slate-50 to-white p-3\">\n                        <div className=\"text-xs font-semibold text-slate-500 uppercase tracking-wide mb-1\">Total Floors</div>\n                        <div className=\"text-sm font-medium text-slate-900\">{effectiveTotalFloors} {effectiveTotalFloors === 1 ? \"Floor\" : \"Floors\"}</div>\n                      </div>\n                    )}\n                  </div>\n                </div>\n              </section>\n            )}\n\n            {/* Property Visualization - Floor Plan Preview - Admin/Owner Only */}\n            {(mode === \"admin\" || mode === \"owner\") && rooms.length > 0 && effectiveBuildingType && (\n              <section className=\"border-b border-gray-200 pb-6\">\n                <PropertyVisualizationPreview\n                  title={property.title || \"Property\"}\n                  buildingType={effectiveBuildingType}\n                  totalFloors={effectiveTotalFloors || \"\"}\n                  showHeader={false}\n                  rooms={rooms.map((room) => {\n                    // Parse floorDistribution if it's a JSON string\n                    let floorDist: Record<number, number> | undefined = undefined;\n                    if (room.floorDistribution) {\n                      if (typeof room.floorDistribution === \"string\") {\n                        try {\n                          const parsed = JSON.parse(room.floorDistribution);\n                          if (typeof parsed === \"object\" && parsed !== null && !Array.isArray(parsed)) {\n                            floorDist = parsed;\n                          }\n                        } catch {\n                          // Invalid JSON, ignore\n                        }\n                      } else if (typeof room.floorDistribution === \"object\" && room.floorDistribution !== null && !Array.isArray(room.floorDistribution)) {\n                        floorDist = room.floorDistribution as Record<number, number>;\n                      }\n                    }\n                    \n                    return {\n                      roomType: room.roomType || room.name || room.label || \"Room\",\n                      roomsCount: room.roomsCount || room.count || room.quantity || 0,\n                      floorDistribution: floorDist,\n                    };\n                  })}\n                />\n              </section>\n            )}\n\n            {/* Rooms Section - Match Public View with Table */}\n            {rooms.length > 0 && (\n              <section className=\"border-b border-gray-200 pb-10\">\n                <div className=\"rounded-2xl border border-slate-200 bg-white p-5\">\n                            <div className=\"flex items-center gap-2\">\n                    <span className=\"inline-flex h-9 w-9 items-center justify-center rounded-xl bg-[#02665e]/10 text-[#02665e]\">\n                      <DoorClosed className=\"w-5 h-5\" aria-hidden />\n                    </span>\n                    <h2 className=\"text-lg font-semibold text-slate-900\">Rooms & Pricing</h2>\n                            </div>\n                  {(() => {\n                    const rows = normalizeRoomsSpec(rooms, property.currency ?? null, property.basePrice ?? null);\n                    if (!rows.length) return <p className=\"mt-2 text-sm text-slate-600\">Room details coming soon.</p>;\n\n                    return (\n                      <div className=\"mt-4\">\n                        {/* Mobile: stacked rows */}\n                        <div className=\"space-y-3 md:hidden\">\n                          {rows.map((r, idx) => (\n                            <div key={`${r.roomType}-${idx}`} className=\"rounded-xl border border-slate-200 bg-white p-4\">\n                              <div className=\"flex items-start justify-between gap-3\">\n                                <div className=\"min-w-0\">\n                                  <div className=\"text-sm font-semibold text-slate-900 truncate\">\n                                    <span className=\"inline-flex items-center gap-2\">\n                                      <DoorClosed className=\"w-4 h-4 text-slate-500\" aria-hidden />\n                                      <span className=\"truncate\">{r.roomType}</span>\n                                </span>\n                                    {typeof r.roomsCount === \"number\" && r.roomsCount > 0 ? (\n                                      <span className=\"ml-2 inline-flex items-center rounded-full bg-slate-50 border border-slate-200 px-2 py-0.5 text-[11px] font-semibold text-slate-700\">\n                                        x{r.roomsCount}\n                                      </span>\n                                    ) : null}\n                              </div>\n                                  <div className=\"mt-1\">\n                                    <div className=\"inline-flex items-center gap-1.5 text-xs text-slate-600\">\n                                      <BedDouble className=\"w-3.5 h-3.5 text-slate-500\" aria-hidden />\n                                      <span className=\"truncate\">{r.bedsSummary}</span>\n                                    </div>\n                                    {getBedDimensions(r.bedsSummary) && (\n                                      <div className=\"mt-1 text-[10px] text-slate-500 leading-tight\">\n                                        {getBedDimensions(r.bedsSummary)}\n                                      </div>\n                                    )}\n                              </div>\n                              </div>\n                                <div className=\"text-right flex-shrink-0\">\n                                  <div className=\"text-sm font-bold text-slate-900\">{fmtMoney(r.pricePerNight, property.currency)}</div>\n                                  <div className=\"text-[11px] text-slate-500\">per night</div>\n                                  {r.discountLabel ? (\n                                    <div className=\"mt-1 text-[11px] font-semibold text-emerald-700\">{r.discountLabel}</div>\n                                  ) : null}\n                                </div>\n                          </div>\n                          \n                              {r.description ? (\n                                <div className=\"mt-3 p-3 bg-gradient-to-br from-slate-50 to-slate-100/50 rounded-lg border border-slate-200/60\">\n                                  <p className=\"text-sm text-slate-800 leading-relaxed font-normal\">\n                                    {capWords(r.description, 180)}\n                                  </p>\n                                </div>\n                              ) : null}\n\n                              {r.amenities.length ? (\n                                <div className=\"mt-2 flex flex-wrap gap-2\">\n                                  {r.amenities.slice(0, 6).map((a) => (\n                                    <RoomAmenityChip key={a} label={a} />\n                                ))}\n                              </div>\n                              ) : null}\n\n                              {r.bathItems && r.bathItems.length > 0 ? (\n                                <div className=\"mt-3\">\n                                  <div className=\"text-sm font-semibold text-slate-700 mb-2 flex items-center gap-2 flex-wrap\">\n                                    <div className=\"flex items-center gap-2\">\n                                      <Bath className=\"w-4 h-4 text-slate-600\" />\n                                      <span>Bathroom</span>\n                                    </div>\n                                    {r.bathPrivate && (r.bathPrivate === \"yes\" || r.bathPrivate === \"no\") && (\n                                      <div className={`inline-flex items-center gap-1.5 px-2.5 py-1 rounded-md text-xs font-semibold shrink-0 ${\n                                        r.bathPrivate === \"yes\" \n                                          ? \"bg-emerald-50 text-emerald-700 border border-emerald-200\" \n                                          : \"bg-blue-50 text-blue-700 border border-blue-200\"\n                                      }`}>\n                                        {r.bathPrivate === \"yes\" ? (\n                                          <>\n                                            <Lock className=\"w-3.5 h-3.5 flex-shrink-0\" />\n                                            <span>Private</span>\n                                          </>\n                                        ) : (\n                                          <>\n                                            <Share2 className=\"w-3.5 h-3.5 flex-shrink-0\" />\n                                            <span>Shared</span>\n                                          </>\n                                        )}\n                                      </div>\n                                    )}\n                                  </div>\n                                  <div className=\"flex flex-wrap gap-2\">\n                                    {r.bathItems.map((item) => (\n                                      <RoomAmenityChip key={item} label={item} />\n                                    ))}\n                                  </div>\n                                </div>\n                              ) : r.bathPrivate && (r.bathPrivate === \"yes\" || r.bathPrivate === \"no\") ? (\n                                <div className=\"mt-3\">\n                                  <div className=\"text-sm font-semibold text-slate-700 mb-2 flex items-center gap-2 flex-wrap\">\n                                    <div className=\"flex items-center gap-2\">\n                                      <Bath className=\"w-4 h-4 text-slate-600\" />\n                                      <span>Bathroom</span>\n                                    </div>\n                                    <div className={`inline-flex items-center gap-1.5 px-2.5 py-1 rounded-md text-xs font-semibold shrink-0 ${\n                                      r.bathPrivate === \"yes\" \n                                        ? \"bg-emerald-50 text-emerald-700 border border-emerald-200\" \n                                        : \"bg-blue-50 text-blue-700 border border-blue-200\"\n                                    }`}>\n                                      {r.bathPrivate === \"yes\" ? (\n                                        <>\n                                          <Lock className=\"w-3.5 h-3.5 flex-shrink-0\" />\n                                          <span>Private</span>\n                                        </>\n                                      ) : (\n                                        <>\n                                          <Share2 className=\"w-3.5 h-3.5 flex-shrink-0\" />\n                                          <span>Shared</span>\n                                        </>\n                                      )}\n                                    </div>\n                                  </div>\n                                </div>\n                              ) : null}\n\n                              <div className=\"mt-3\">\n                                <div className=\"text-[11px] font-semibold text-slate-700\">Policies</div>\n                                <ul className=\"mt-1 space-y-1 text-[12px] text-slate-700\">\n                                  {r.policies.slice(0, 4).map((p, i) => (\n                                    <li key={i} className=\"break-words flex items-start gap-1.5\">\n                                      {p.Icon && (\n                                        <p.Icon className={`w-3.5 h-3.5 flex-shrink-0 mt-0.5 ${p.iconColor || \"text-slate-600\"}`} aria-hidden />\n                                      )}\n                                      <span className=\"break-words\">{p.text}</span>\n                                    </li>\n                                  ))}\n                                </ul>\n                            </div>\n                            </div>\n                                ))}\n                              </div>\n\n                        {/* Desktop: full-width table */}\n                        <div className=\"hidden md:block\">\n                          <div className=\"rounded-xl border border-slate-200 overflow-hidden\">\n                            <table className=\"w-full table-fixed border-collapse\">\n                              <thead className=\"bg-slate-50 text-slate-700\">\n                                <tr>\n                                  <th className=\"text-left text-sm font-semibold px-3 py-3 border-b border-r border-slate-200 w-[13%]\">\n                                    Room type\n                                  </th>\n                                  <th className=\"text-left text-sm font-semibold px-3 py-3 border-b border-r border-slate-200 w-[11%]\">\n                                    Bed Type &amp; Size\n                                  </th>\n                                  <th className=\"text-left text-sm font-semibold px-3 py-3 border-b border-r border-slate-200 w-[28%]\">\n                                    Description &amp; Amenities\n                                  </th>\n                                  <th className=\"text-left text-sm font-semibold px-3 py-3 border-b border-r border-slate-200 w-[14%]\">\n                                    Price &amp; Discounts\n                                  </th>\n                                  <th className=\"text-left text-sm font-semibold px-3 py-3 border-b border-r border-slate-200 w-[11%]\">Pay Now</th>\n                                  <th className=\"text-left text-sm font-semibold px-3 py-3 border-b border-slate-200 w-[23%] min-w-[160px]\">\n                                    Policies\n                                  </th>\n                                </tr>\n                              </thead>\n                              <tbody className=\"bg-white\">\n                                {rows.map((r, idx) => (\n                                  <TableRow\n                                    key={`${r.roomType}-${idx}`}\n                                    className={[\n                                      idx % 2 === 0 ? \"bg-white\" : \"bg-slate-50/40\",\n                                      \"hover:bg-emerald-50/30 hover:shadow-none\",\n                                      \"motion-safe:transition-colors motion-safe:duration-200\",\n                                    ].join(\" \")}\n                                  >\n                                    <td className=\"align-top px-3 py-4 border-t border-slate-200\">\n                                      <div className=\"inline-flex items-start gap-2 text-base font-semibold text-slate-900 break-words\">\n                                        <DoorClosed className=\"w-4 h-4 text-slate-500 mt-0.5 flex-shrink-0\" aria-hidden />\n                                        <span>{r.roomType}</span>\n                            </div>\n                                      {typeof r.roomsCount === \"number\" && r.roomsCount > 0 ? (\n                                        <div className=\"mt-1 inline-flex items-center rounded-full bg-slate-50 border border-slate-200 px-2 py-0.5 text-xs font-semibold text-slate-700\">\n                                          {r.roomsCount} rooms\n                        </div>\n                                      ) : null}\n                                    </td>\n                                    <td className=\"align-top px-3 py-4 border-t border-slate-200\">\n                                      <div>\n                                        <div className=\"inline-flex items-start gap-2 text-base text-slate-800 break-words\">\n                                          <BedDouble className=\"w-4 h-4 text-slate-500 mt-0.5 flex-shrink-0\" aria-hidden />\n                                          <span>{r.bedsSummary}</span>\n                                        </div>\n                                        {getBedDimensions(r.bedsSummary) && (\n                                          <div className=\"mt-1.5 text-xs text-slate-500 leading-tight\">\n                                            {getBedDimensions(r.bedsSummary)}\n                                          </div>\n                                        )}\n                                      </div>\n                                    </td>\n                                    <td className=\"align-top px-3 py-4 border-t border-slate-200\">\n                                      {r.description ? (\n                                        <div className=\"p-3 bg-gradient-to-br from-slate-50 to-slate-100/50 rounded-lg border border-slate-200/60\">\n                                          <p className=\"text-sm text-slate-800 leading-relaxed font-normal break-words\">\n                                            {capWords(r.description, 220)}\n                                          </p>\n                          </div>\n                                      ) : (\n                                        <div className=\"text-base text-slate-500\">—</div>\n                        )}\n                                      {r.amenities.length ? (\n                                        <div className=\"mt-2 flex flex-wrap gap-2\">\n                                          {r.amenities.slice(0, 6).map((a) => (\n                                            <RoomAmenityChip key={a} label={a} />\n                                ))}\n                      </div>\n                                      ) : null}\n                                      {r.bathItems && r.bathItems.length > 0 ? (\n                                        <div className=\"mt-3 pt-3 border-t border-slate-100\">\n                                          <div className=\"text-sm font-semibold text-slate-700 mb-2 flex items-center gap-2 flex-wrap\">\n                                            <div className=\"flex items-center gap-2\">\n                                              <Bath className=\"w-4 h-4 text-slate-600\" />\n                                              <span>Bathroom</span>\n                                            </div>\n                                            {r.bathPrivate && (r.bathPrivate === \"yes\" || r.bathPrivate === \"no\") && (\n                                              <div className={`inline-flex items-center gap-1.5 px-2.5 py-1 rounded-md text-xs font-semibold shrink-0 ${\n                                                r.bathPrivate === \"yes\" \n                                                  ? \"bg-emerald-50 text-emerald-700 border border-emerald-200\" \n                                                  : \"bg-blue-50 text-blue-700 border border-blue-200\"\n                                              }`}>\n                                                {r.bathPrivate === \"yes\" ? (\n                                                  <>\n                                                    <Lock className=\"w-3.5 h-3.5 flex-shrink-0\" />\n                                                    <span>Private</span>\n                                                  </>\n                                                ) : (\n                                                  <>\n                                                    <Share2 className=\"w-3.5 h-3.5 flex-shrink-0\" />\n                                                    <span>Shared</span>\n                                                  </>\n                                                )}\n                                              </div>\n                                            )}\n                                          </div>\n                                          <div className=\"flex flex-wrap gap-2\">\n                                            {r.bathItems.map((item) => (\n                                              <RoomAmenityChip key={item} label={item} />\n                                            ))}\n                                          </div>\n                                        </div>\n                                      ) : r.bathPrivate && (r.bathPrivate === \"yes\" || r.bathPrivate === \"no\") ? (\n                                        <div className=\"mt-3 pt-3 border-t border-slate-100\">\n                                          <div className=\"text-sm font-semibold text-slate-700 mb-2 flex items-center gap-2 flex-wrap\">\n                                            <div className=\"flex items-center gap-2\">\n                                              <Bath className=\"w-4 h-4 text-slate-600\" />\n                                              <span>Bathroom</span>\n                                            </div>\n                                            <div className={`inline-flex items-center gap-1.5 px-2.5 py-1 rounded-md text-xs font-semibold shrink-0 ${\n                                              r.bathPrivate === \"yes\" \n                                                ? \"bg-emerald-50 text-emerald-700 border border-emerald-200\" \n                                                : \"bg-blue-50 text-blue-700 border border-blue-200\"\n                                            }`}>\n                                              {r.bathPrivate === \"yes\" ? (\n                                                <>\n                                                  <Lock className=\"w-3.5 h-3.5 flex-shrink-0\" />\n                                                  <span>Private</span>\n                                                </>\n                                              ) : (\n                                                <>\n                                                  <Share2 className=\"w-3.5 h-3.5 flex-shrink-0\" />\n                                                  <span>Shared</span>\n                                                </>\n                                              )}\n                                            </div>\n                                          </div>\n                                        </div>\n                                      ) : null}\n                                    </td>\n                                    <td className=\"align-top px-3 py-4 border-t border-slate-200\">\n                                      <div>\n                                        <div className=\"text-base font-bold text-[#02665e]\">{fmtMoney(r.pricePerNight, property.currency)}</div>\n                                        <div className=\"text-xs text-slate-500\">per night</div>\n                            </div>\n                                      {r.discountLabel ? (\n                                        <div className=\"mt-1 inline-flex items-center rounded-full bg-emerald-50 border border-emerald-200 px-2 py-0.5 text-xs font-semibold text-emerald-800\">\n                                          {r.discountLabel}\n                                        </div>\n                                      ) : (\n                                        <div className=\"mt-1 text-xs text-slate-500\">No discounts</div>\n                                      )}\n                                    </td>\n                                    <td className=\"align-top px-3 py-4 border-t border-slate-200\">\n                            <button\n                                        type=\"button\"\n                                        onClick={() => alert(\"Pay Now / Booking flow is coming next (Phase 2).\")}\n                                        className={[\n                                          \"w-full rounded-md bg-[#02665e] text-white px-2.5 py-1.5 text-sm font-medium\",\n                                          \"hover:bg-[#014e47]\",\n                                          \"motion-safe:transition-all motion-safe:duration-200\",\n                                          \"shadow-sm hover:shadow\",\n                                          \"active:scale-[0.98]\",\n                                        ].join(\" \")}\n                                      >\n                                        Pay now\n                            </button>\n                                      <div className=\"mt-2 text-xs text-slate-500\">Secure checkout (coming soon)</div>\n                                    </td>\n                                    <td className=\"align-top px-3 py-4 border-t border-slate-200\">\n                                      <ul className=\"space-y-1.5 text-sm text-slate-800\">\n                                        {r.policies.slice(0, 6).map((p, i) => (\n                                          <li key={i} className=\"leading-relaxed break-words flex items-start gap-1.5\">\n                                            {p.Icon && (\n                                              <p.Icon className={`w-4 h-4 flex-shrink-0 mt-0.5 ${p.iconColor || \"text-slate-600\"}`} aria-hidden />\n                                            )}\n                                            <span className=\"break-words min-w-0\">{p.text}</span>\n                                          </li>\n                                        ))}\n                                      </ul>\n                                    </td>\n                                  </TableRow>\n                                ))}\n                              </tbody>\n                            </table>\n                        </div>\n                    </div>\n                      </div>\n                    );\n                  })()}\n                </div>\n              </section>\n            )}\n\n            {/* Admin/Owner Info Card - Moved here for full-width rooms table */}\n            {(mode === \"admin\" || mode === \"owner\") && (\n              <section className=\"border-b border-gray-200 pb-6\">\n                <div className=\"rounded-2xl border border-slate-200 bg-white p-5 sm:p-6 shadow-sm space-y-6 motion-safe:transition-all motion-safe:duration-300 hover:shadow-md\">\n                  {/* Owner Quick Actions */}\n                  {mode === \"owner\" && (\n                    <div className=\"pb-6 border-b border-slate-200/60\">\n                      <div className=\"text-sm sm:text-base font-semibold text-slate-900 mb-4\">Quick Actions</div>\n                      <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-3\">\n                        <Link\n                          href={`/owner/properties/${propertyId}/availability/manage`}\n                          className=\"group flex items-center gap-3 p-4 rounded-xl bg-gradient-to-br from-emerald-50 to-emerald-100/50 border-2 border-emerald-200 hover:border-emerald-300 hover:shadow-md transition-all duration-200\"\n                        >\n                          <div className=\"w-10 h-10 rounded-lg bg-emerald-600 flex items-center justify-center group-hover:scale-110 transition-transform\">\n                            <Calendar className=\"w-5 h-5 text-white\" />\n                          </div>\n                          <div className=\"flex-1 min-w-0\">\n                            <div className=\"text-sm font-semibold text-emerald-900\">Manage Availability</div>\n                            <div className=\"text-xs text-emerald-700 opacity-80\">Update room availability calendar</div>\n                          </div>\n                          <ChevronRight className=\"w-5 h-5 text-emerald-600 group-hover:translate-x-1 transition-transform\" />\n                        </Link>\n                        <Link\n                          href={`/owner/bookings`}\n                          className=\"group flex items-center gap-3 p-4 rounded-xl bg-gradient-to-br from-blue-50 to-blue-100/50 border-2 border-blue-200 hover:border-blue-300 hover:shadow-md transition-all duration-200\"\n                        >\n                          <div className=\"w-10 h-10 rounded-lg bg-blue-600 flex items-center justify-center group-hover:scale-110 transition-transform\">\n                            <BedDouble className=\"w-5 h-5 text-white\" />\n                          </div>\n                          <div className=\"flex-1 min-w-0\">\n                            <div className=\"text-sm font-semibold text-blue-900\">View Bookings</div>\n                            <div className=\"text-xs text-blue-700 opacity-80\">Manage all bookings</div>\n                          </div>\n                          <ChevronRight className=\"w-5 h-5 text-blue-600 group-hover:translate-x-1 transition-transform\" />\n                        </Link>\n                      </div>\n                    </div>\n                  )}\n                  {(property.basePrice !== null && property.basePrice !== undefined && property.basePrice > 0) && (\n                    <div className=\"motion-safe:animate-in motion-safe:fade-in motion-safe:slide-in-from-top-2 motion-safe:duration-500\">\n                      <div className=\"text-sm sm:text-base text-slate-600 mb-2 font-medium\">Base Price</div>\n                      <div className=\"text-2xl sm:text-3xl lg:text-4xl font-bold text-[#02665e] motion-safe:transition-transform motion-safe:duration-200 hover:scale-[1.02]\">\n                              {(() => {\n                                const basePrice = Number(property?.basePrice);\n                                if (!basePrice || basePrice <= 0) return \"—\";\n                                const commission = getPropertyCommission(property, systemCommission);\n                                const finalPrice = calculatePriceWithCommission(basePrice, commission);\n                                return new Intl.NumberFormat(undefined, {\n                                  style: \"currency\",\n                                  currency: property.currency || \"TZS\",\n                                  maximumFractionDigits: 0,\n                                }).format(finalPrice);\n                              })()}\n                            </div>\n                  </div>\n                )}\n                  \n                  {property.owner && (\n                    <div className=\"pt-6 border-t border-slate-200/60 motion-safe:animate-in motion-safe:fade-in motion-safe:slide-in-from-bottom-2 motion-safe:duration-500 motion-safe:delay-100\">\n                      <div className=\"text-sm sm:text-base font-semibold text-slate-900 mb-4\">Owner Information</div>\n                      \n                      {/* Owner Profile Card */}\n                      <div className=\"rounded-xl border border-slate-200 bg-slate-50 p-4 sm:p-5 motion-safe:transition-all motion-safe:duration-300 hover:bg-white hover:border-[#02665e]/20 hover:shadow-md cursor-default\">\n                        <div className=\"flex items-center gap-3 sm:gap-4 mb-4\">\n                          <div className=\"w-12 h-12 sm:w-14 sm:h-14 rounded-full bg-[#02665e]/10 flex items-center justify-center flex-shrink-0 motion-safe:transition-all motion-safe:duration-300 hover:bg-[#02665e]/20 hover:scale-110\">\n                            <Users className=\"h-6 w-6 sm:h-7 sm:w-7 text-[#02665e] motion-safe:transition-transform motion-safe:duration-300\" />\n                      </div>\n                          <div className=\"flex-1 min-w-0\">\n                            {property.owner.name && (\n                              <div className=\"font-semibold text-sm sm:text-base text-slate-900 truncate mb-1.5\">{property.owner.name}</div>\n                            )}\n                            <div className=\"flex items-center gap-1.5 motion-safe:transition-all motion-safe:duration-200\">\n                              <BadgeCheck className=\"h-3.5 w-3.5 sm:h-4 sm:w-4 text-[#02665e] flex-shrink-0\" />\n                              <span className=\"text-xs sm:text-sm text-[#02665e] font-medium\">Verified Host</span>\n                            </div>\n                              </div>\n                        </div>\n                        <div className=\"flex items-center gap-2 text-xs sm:text-sm text-slate-600 pt-3 border-t border-slate-200/50\">\n                          <Clock className=\"h-3.5 w-3.5 sm:h-4 sm:w-4 flex-shrink-0 text-slate-500\" />\n                          <span>Response time: Usually within 2 hours</span>\n                        </div>\n                      </div>\n\n                      {/* Contact Information */}\n                      <div className=\"mt-4 space-y-2\">\n                        {property.owner.email && (\n                          <a\n                            href={`mailto:${property.owner.email}`}\n                            className=\"group flex items-center gap-3 text-sm sm:text-base p-3 rounded-lg bg-white border border-slate-200 motion-safe:transition-all motion-safe:duration-200 hover:bg-slate-50 hover:border-[#02665e]/30 hover:shadow-sm no-underline\"\n                          >\n                            <Mail className=\"h-4 w-4 sm:h-5 sm:w-5 text-slate-400 flex-shrink-0 motion-safe:transition-all motion-safe:duration-200 group-hover:text-[#02665e]\" />\n                            <span className=\"text-[#02665e] group-hover:text-[#014e47] truncate motion-safe:transition-colors motion-safe:duration-200 font-medium no-underline\">\n                              {property.owner.email}\n                            </span>\n                          </a>\n                        )}\n                        {property.owner.phone && (\n                          <a\n                            href={`tel:${property.owner.phone}`}\n                            className=\"group flex items-center gap-3 text-sm sm:text-base p-3 rounded-lg bg-white border border-slate-200 motion-safe:transition-all motion-safe:duration-200 hover:bg-slate-50 hover:border-[#02665e]/30 hover:shadow-sm no-underline\"\n                          >\n                            <Phone className=\"h-4 w-4 sm:h-5 sm:w-5 text-slate-400 flex-shrink-0 motion-safe:transition-all motion-safe:duration-200 group-hover:text-[#02665e]\" />\n                            <span className=\"text-[#02665e] group-hover:text-[#014e47] motion-safe:transition-colors motion-safe:duration-200 font-medium no-underline\">\n                              {property.owner.phone}\n                            </span>\n                          </a>\n                      )}\n                    </div>\n                </div>\n            )}\n\n                  {property.lastSubmittedAt && (\n                    <div className=\"pt-5 border-t border-slate-200 motion-safe:animate-in motion-safe:fade-in motion-safe:slide-in-from-bottom-2 motion-safe:duration-500 motion-safe:delay-200\">\n                      <div className=\"text-sm sm:text-base text-slate-600 mb-1.5 font-medium\">Last Submitted</div>\n                      <div className=\"text-sm sm:text-base font-medium text-slate-900\">\n                        {new Date(property.lastSubmittedAt).toLocaleString()}\n                      </div>\n                  </div>\n                )}\n                </div>\n              </section>\n            )}\n\n            {/* House Rules Section */}\n            {houseRules && (\n              <section className=\"border-b border-gray-200 pb-10\">\n                <h2 className=\"text-2xl font-bold text-gray-900 mb-6\">House Rules</h2>\n                <div className=\"grid grid-cols-1 md:grid-cols-3 gap-6\">\n                  {/* Column 1: Check-in & Check-out */}\n                  <div className=\"space-y-4\">\n                    <div className=\"flex items-center gap-2 mb-3\">\n                      <Clock className=\"w-5 h-5 text-[#02665e]\" />\n                      <h3 className=\"text-sm font-semibold text-slate-900\">Check-in & Check-out</h3>\n                    </div>\n                    <div className=\"space-y-3\">\n                      {(() => {\n                        const checkInStr = formatTimeRange(houseRules.checkInFrom, houseRules.checkInTo);\n                        return checkInStr ? (\n                          <div className=\"rounded-lg border border-slate-200 bg-gradient-to-br from-slate-50 to-white p-3 transition-all duration-200 hover:shadow-sm\">\n                            <div className=\"text-xs font-semibold text-slate-500 uppercase tracking-wide mb-1\">Check-in</div>\n                            <div className=\"text-sm font-medium text-slate-900\">{checkInStr}</div>\n                          </div>\n                        ) : (\n                          <div className=\"rounded-lg border border-slate-200 bg-gradient-to-br from-slate-50 to-white p-3 opacity-60\">\n                            <div className=\"text-xs font-semibold text-slate-500 uppercase tracking-wide mb-1\">Check-in</div>\n                            <div className=\"text-sm text-slate-400\">Not specified</div>\n                          </div>\n                        );\n                      })()}\n                      {(() => {\n                        const checkOutStr = formatTimeRange(houseRules.checkOutFrom, houseRules.checkOutTo);\n                        return checkOutStr ? (\n                          <div className=\"rounded-lg border border-slate-200 bg-gradient-to-br from-slate-50 to-white p-3 transition-all duration-200 hover:shadow-sm\">\n                            <div className=\"text-xs font-semibold text-slate-500 uppercase tracking-wide mb-1\">Check-out</div>\n                            <div className=\"text-sm font-medium text-slate-900\">{checkOutStr}</div>\n                          </div>\n                        ) : (\n                          <div className=\"rounded-lg border border-slate-200 bg-gradient-to-br from-slate-50 to-white p-3 opacity-60\">\n                            <div className=\"text-xs font-semibold text-slate-500 uppercase tracking-wide mb-1\">Check-out</div>\n                            <div className=\"text-sm text-slate-400\">Not specified</div>\n                          </div>\n                        );\n                      })()}\n                    </div>\n                  </div>\n\n                  {/* Column 2: Pets & Smoking */}\n                  <div className=\"space-y-4\">\n                    <div className=\"flex items-center gap-2 mb-3\">\n                      <Users className=\"w-5 h-5 text-[#02665e]\" />\n                      <h3 className=\"text-sm font-semibold text-slate-900\">Pets & Smoking</h3>\n                    </div>\n                    <div className=\"space-y-3\">\n                      {houseRules.petsAllowed !== undefined ? (\n                        <div className={`rounded-lg border p-3 transition-all duration-200 hover:shadow-sm ${\n                          houseRules.petsAllowed \n                            ? \"border-emerald-200 bg-gradient-to-br from-emerald-50 to-white\" \n                            : \"border-rose-200 bg-gradient-to-br from-rose-50 to-white\"\n                        }`}>\n                          <div className=\"flex items-center gap-2 mb-2\">\n                            {houseRules.petsAllowed ? (\n                              <CheckCircle2 className=\"w-4 h-4 text-emerald-600\" />\n                            ) : (\n                              <XCircleIcon className=\"w-4 h-4 text-rose-600\" />\n                            )}\n                            <div className=\"text-xs font-semibold text-slate-500 uppercase tracking-wide\">\n                              {houseRules.petsAllowed ? \"Allowed\" : \"Not Allowed\"}\n                            </div>\n                          </div>\n                          {houseRules.petsNote && (\n                            <div className=\"text-sm text-slate-700 mt-2\">{houseRules.petsNote}</div>\n                          )}\n                        </div>\n                      ) : (\n                        <div className=\"rounded-lg border border-slate-200 bg-gradient-to-br from-slate-50 to-white p-3 opacity-60\">\n                          <div className=\"text-xs font-semibold text-slate-500 uppercase tracking-wide mb-1\">Pets</div>\n                          <div className=\"text-sm text-slate-400\">Not specified</div>\n                        </div>\n                      )}\n                      {houseRules.smokingNotAllowed !== undefined && (\n                        <div className={`rounded-lg border p-3 transition-all duration-200 hover:shadow-sm ${\n                          !houseRules.smokingNotAllowed \n                            ? \"border-emerald-200 bg-gradient-to-br from-emerald-50 to-white\" \n                            : \"border-rose-200 bg-gradient-to-br from-rose-50 to-white\"\n                        }`}>\n                          <div className=\"flex items-center gap-2 mb-2\">\n                            {houseRules.smokingNotAllowed ? (\n                              <CigaretteOff className=\"w-4 h-4 text-rose-600\" />\n                            ) : (\n                              <CheckCircle2 className=\"w-4 h-4 text-emerald-600\" />\n                            )}\n                            <div className=\"text-xs font-semibold text-slate-500 uppercase tracking-wide\">\n                              Smoking {houseRules.smokingNotAllowed ? \"Not Allowed\" : \"Allowed\"}\n                            </div>\n                          </div>\n                        </div>\n                      )}\n                    </div>\n                  </div>\n\n                  {/* Column 3: Other Rules */}\n                  <div className=\"space-y-4\">\n                    <div className=\"flex items-center gap-2 mb-3\">\n                      <Shield className=\"w-5 h-5 text-[#02665e]\" />\n                      <h3 className=\"text-sm font-semibold text-slate-900\">Other Rules</h3>\n                    </div>\n                    <div className=\"space-y-2\">\n                      {[\n                        \"Keep the property clean and well-maintained\",\n                        \"Return all keys and access cards upon checkout\",\n                        \"Report any incidents or damages immediately\",\n                        \"Respect quiet hours and neighbors\",\n                        \"Follow all posted safety guidelines\"\n                      ].map((measure, idx) => (\n                        <div \n                          key={idx}\n                          className=\"flex items-start gap-2 rounded-lg border border-slate-200 bg-gradient-to-br from-slate-50 to-white p-3 transition-all duration-200 hover:shadow-sm hover:border-[#02665e]/30\"\n                        >\n                          <CheckCircle2 className=\"w-4 h-4 text-[#02665e] flex-shrink-0 mt-0.5\" />\n                          <span className=\"text-sm text-slate-700 leading-relaxed\">{measure}</span>\n                        </div>\n                      ))}\n                      {houseRules.other && houseRules.other.trim() && (\n                        <div className=\"rounded-lg border border-[#02665e]/20 bg-gradient-to-br from-[#02665e]/5 to-white p-3 transition-all duration-200 hover:shadow-sm hover:border-[#02665e]/40\">\n                          <div className=\"text-xs font-semibold text-slate-500 uppercase tracking-wide mb-2\">Additional Rules</div>\n                          <div className=\"text-sm text-slate-700 leading-relaxed\">{houseRules.other}</div>\n                        </div>\n                      )}\n                    </div>\n                  </div>\n                </div>\n              </section>\n            )}\n\n            {/* Reviews Section */}\n            {(mode === \"public\" || mode === \"owner\") && reviews && (\n              <motion.section\n                initial={{ opacity: 0, y: 20 }}\n                animate={{ opacity: 1, y: 0 }}\n                transition={{ duration: 0.5 }}\n                className=\"border-b border-gray-200 pb-6\"\n              >\n                <div className=\"flex items-center justify-between mb-6\">\n                  <h2 className=\"text-2xl font-bold text-gray-900\">Guest Reviews</h2>\n                  {reviews.stats && (\n                    <div className=\"flex items-center gap-2\">\n                      <div className=\"flex items-center gap-1\">\n                        <Star className=\"h-5 w-5 fill-amber-400 text-amber-400\" />\n                        <span className=\"text-xl font-bold text-gray-900\">\n                          {reviews.stats.averageRating.toFixed(1)}\n                        </span>\n                      </div>\n                      <span className=\"text-gray-600\">\n                        ({reviews.stats.totalReviews} {reviews.stats.totalReviews === 1 ? \"review\" : \"reviews\"})\n                      </span>\n                    </div>\n                  )}\n                </div>\n\n                {reviews.stats && (\n                  <div className=\"mb-6 grid grid-cols-2 md:grid-cols-5 gap-4\">\n                    {[5, 4, 3, 2, 1].map((rating) => (\n                      <div key={rating} className=\"flex items-center gap-2\">\n                        <span className=\"text-sm font-medium text-gray-700\">{rating}</span>\n                        <Star className=\"h-4 w-4 fill-amber-400 text-amber-400\" />\n                        <div className=\"flex-1 h-2 bg-gray-200 rounded-full overflow-hidden\">\n                          <motion.div\n                            initial={{ width: 0 }}\n                            animate={{ width: `${(reviews.stats.ratingDistribution[rating] / reviews.stats.totalReviews) * 100}%` }}\n                            transition={{ duration: 0.5, delay: rating * 0.1 }}\n                            className=\"h-full bg-amber-400\"\n                          />\n                        </div>\n                        <span className=\"text-xs text-gray-600 w-8 text-right\">\n                          {reviews.stats.ratingDistribution[rating]}\n                        </span>\n                      </div>\n                    ))}\n                  </div>\n                )}\n\n                <div className=\"space-y-6\">\n                  {reviews.reviews.slice(0, 5).map((review: Review, idx: number) => (\n                    <motion.div\n                      key={review.id}\n                      initial={{ opacity: 0, x: -20 }}\n                      animate={{ opacity: 1, x: 0 }}\n                      transition={{ duration: 0.4, delay: idx * 0.1 }}\n                      className=\"border-b border-gray-100 pb-6 last:border-0\"\n                    >\n                      <div className=\"flex items-start justify-between mb-3\">\n                        <div className=\"flex items-center gap-3\">\n                          <div className=\"w-10 h-10 rounded-full bg-emerald-100 flex items-center justify-center\">\n                            <span className=\"text-emerald-600 font-semibold\">\n                              {review.user?.name?.charAt(0) || \"G\"}\n                            </span>\n                          </div>\n                          <div>\n                            <div className=\"font-semibold text-gray-900\">\n                              {review.user?.name || \"Anonymous Guest\"}\n                            </div>\n                            <div className=\"flex items-center gap-2 text-sm text-gray-600\">\n                              <div className=\"flex items-center\">\n                                {Array.from({ length: 5 }).map((_, i) => (\n                                  <Star\n                                    key={i}\n                                    className={`h-4 w-4 ${\n                                      i < review.rating\n                                        ? \"fill-amber-400 text-amber-400\"\n                                        : \"text-gray-300\"\n                                    }`}\n                                  />\n                                ))}\n                              </div>\n                              {review.isVerified && (\n                                <span className=\"px-2 py-0.5 bg-emerald-50 text-emerald-700 rounded text-xs font-medium\">\n                                  Verified Stay\n                                </span>\n                              )}\n                              <span className=\"text-gray-500\">\n                                {review.createdAt ? new Date(review.createdAt).toLocaleDateString() : 'N/A'}\n                              </span>\n                            </div>\n                          </div>\n                        </div>\n                      </div>\n                      {review.title && (\n                        <h4 className=\"font-semibold text-gray-900 mb-2\">{review.title}</h4>\n                      )}\n                      {review.comment && (\n                        <p className=\"text-gray-700 leading-relaxed mb-3\">{review.comment}</p>\n                      )}\n                      {review.ownerResponse && (\n                        <div className=\"mt-4 p-4 bg-gray-50 rounded-lg border-l-4 border-emerald-500\">\n                          <div className=\"font-semibold text-gray-900 mb-1\">Owner Response</div>\n                          <p className=\"text-gray-700 text-sm\">{review.ownerResponse}</p>\n                          {review.ownerResponseAt && (\n                            <div className=\"text-xs text-gray-500 mt-2\">\n                              {new Date(review.ownerResponseAt).toLocaleDateString()}\n                            </div>\n                          )}\n                        </div>\n                      )}\n                    </motion.div>\n                  ))}\n                </div>\n              </motion.section>\n            )}\n\n            {/* Neighborhood Guide */}\n            {mode === \"public\" && location.regionName && (\n              <NeighborhoodGuide location={location} />\n            )}\n\n            {/* Location Details - Modern Style */}\n            <section className=\"border-b border-gray-200 pb-6\">\n              <div className=\"rounded-2xl border border-slate-200 bg-white p-5 sm:p-6 shadow-sm\">\n                <div className=\"flex items-center gap-2 mb-6\">\n                  <span className=\"inline-flex h-9 w-9 items-center justify-center rounded-xl bg-[#02665e]/10 text-[#02665e]\">\n                    <MapPin className=\"w-5 h-5\" aria-hidden />\n                  </span>\n                  <h2 className=\"text-lg sm:text-xl font-semibold text-slate-900\">Where you&apos;ll be</h2>\n                </div>\n                <div className=\"grid grid-cols-2 gap-3 sm:gap-4\">\n                {location.street && (\n                    <div className=\"flex flex-col p-3 rounded-lg bg-slate-50 border border-slate-200 motion-safe:transition-all motion-safe:duration-200 hover:bg-white hover:border-[#02665e]/20 hover:shadow-sm\">\n                      <span className=\"text-xs font-semibold text-slate-500 uppercase tracking-wide mb-1\">Street Address</span>\n                      <span className=\"text-sm sm:text-base font-medium text-slate-900\">{location.street}</span>\n                  </div>\n                )}\n                {location.apartment && (\n                    <div className=\"flex flex-col p-3 rounded-lg bg-slate-50 border border-slate-200 motion-safe:transition-all motion-safe:duration-200 hover:bg-white hover:border-[#02665e]/20 hover:shadow-sm\">\n                      <span className=\"text-xs font-semibold text-slate-500 uppercase tracking-wide mb-1\">Apartment/Building</span>\n                      <span className=\"text-sm sm:text-base font-medium text-slate-900\">{location.apartment}</span>\n                  </div>\n                )}\n                {location.ward && (\n                    <div className=\"flex flex-col p-3 rounded-lg bg-slate-50 border border-slate-200 motion-safe:transition-all motion-safe:duration-200 hover:bg-white hover:border-[#02665e]/20 hover:shadow-sm\">\n                      <span className=\"text-xs font-semibold text-slate-500 uppercase tracking-wide mb-1\">Ward</span>\n                      <span className=\"text-sm sm:text-base font-medium text-slate-900\">{location.ward}</span>\n                  </div>\n                )}\n                {location.district && (\n                    <div className=\"flex flex-col p-3 rounded-lg bg-slate-50 border border-slate-200 motion-safe:transition-all motion-safe:duration-200 hover:bg-white hover:border-[#02665e]/20 hover:shadow-sm\">\n                      <span className=\"text-xs font-semibold text-slate-500 uppercase tracking-wide mb-1\">District</span>\n                      <span className=\"text-sm sm:text-base font-medium text-slate-900\">{location.district}</span>\n                  </div>\n                )}\n                {location.regionName && (\n                    <div className=\"flex flex-col p-3 rounded-lg bg-slate-50 border border-slate-200 motion-safe:transition-all motion-safe:duration-200 hover:bg-white hover:border-[#02665e]/20 hover:shadow-sm\">\n                      <span className=\"text-xs font-semibold text-slate-500 uppercase tracking-wide mb-1\">Region</span>\n                      <span className=\"text-sm sm:text-base font-medium text-slate-900\">{location.regionName}</span>\n                  </div>\n                )}\n                {location.city && (\n                    <div className=\"flex flex-col p-3 rounded-lg bg-slate-50 border border-slate-200 motion-safe:transition-all motion-safe:duration-200 hover:bg-white hover:border-[#02665e]/20 hover:shadow-sm\">\n                      <span className=\"text-xs font-semibold text-slate-500 uppercase tracking-wide mb-1\">City</span>\n                      <span className=\"text-sm sm:text-base font-medium text-slate-900\">{location.city}</span>\n                  </div>\n                )}\n                {location.zip && (\n                    <div className=\"flex flex-col p-3 rounded-lg bg-slate-50 border border-slate-200 motion-safe:transition-all motion-safe:duration-200 hover:bg-white hover:border-[#02665e]/20 hover:shadow-sm\">\n                      <span className=\"text-xs font-semibold text-slate-500 uppercase tracking-wide mb-1\">Zip Code</span>\n                      <span className=\"text-sm sm:text-base font-medium text-slate-900\">{location.zip}</span>\n                  </div>\n                )}\n                {location.country && (\n                    <div className=\"flex flex-col p-3 rounded-lg bg-slate-50 border border-slate-200 motion-safe:transition-all motion-safe:duration-200 hover:bg-white hover:border-[#02665e]/20 hover:shadow-sm\">\n                      <span className=\"text-xs font-semibold text-slate-500 uppercase tracking-wide mb-1\">Country</span>\n                      <span className=\"text-sm sm:text-base font-medium text-slate-900\">{location.country}</span>\n                  </div>\n                )}\n                </div>\n\n                {/* Map Card - Mapbox */}\n                  <div className=\"mt-6\">\n                  <div className=\"mb-3\">\n                    <h3 className=\"text-sm font-semibold text-slate-700\">Property Location</h3>\n                    <p className=\"text-xs text-slate-500 mt-0.5\">Exact location on map</p>\n                  </div>\n                  {((property.latitude && property.longitude) || (location.lat && location.lng) || (location.latitude && location.longitude)) ? (\n                    <div className=\"rounded-xl border border-slate-200 bg-white overflow-hidden shadow-sm\">\n                      <div className=\"relative aspect-[16/9] bg-slate-100\">\n                        {(() => {\n                          const lat = property.latitude || location.lat || location.latitude;\n                          const lng = property.longitude || location.lng || location.longitude;\n                          const mapboxToken = process.env.NEXT_PUBLIC_MAPBOX_TOKEN || process.env.NEXT_PUBLIC_MAPBOX_ACCESS_TOKEN;\n                          return (\n                            <>\n                      {mapboxToken ? (\n                                              <Image\n                                                src={`https://api.mapbox.com/styles/v1/mapbox/streets-v12/static/pin-s+10b981(${lng},${lat})/${lng},${lat},15,0/900x420?access_token=${encodeURIComponent(mapboxToken)}`}\n                                                alt=\"Property location map\"\n                                                fill\n                                                className=\"absolute inset-0 w-full h-full object-cover\"\n                                                unoptimized\n                                              />\n                                            ) : (\n                                <div className=\"absolute inset-0 flex items-center justify-center bg-gradient-to-br from-slate-100 to-slate-200\">\n                          <div className=\"text-center\">\n                                    <Map className=\"h-8 w-8 text-slate-400 mx-auto mb-2\" />\n                                    <p className=\"text-sm text-slate-600 font-medium\">Map view</p>\n                                    <p className=\"text-xs text-slate-500 mt-1\">\n                                      {lat}, {lng}\n                            </p>\n                          </div>\n                        </div>\n                      )}\n                              <div className=\"absolute inset-0 bg-gradient-to-t from-black/10 to-transparent pointer-events-none\" />\n                            </>\n                          );\n                        })()}\n                    </div>\n                  </div>\n                  ) : (\n                    <div className=\"rounded-xl border border-slate-200 bg-slate-50 overflow-hidden\">\n                      <div className=\"relative aspect-[16/9] flex items-center justify-center\">\n                        <div className=\"text-center\">\n                          <MapPin className=\"h-10 w-10 text-slate-400 mx-auto mb-3\" />\n                          <p className=\"text-sm text-slate-600 font-medium\">Location coordinates not available</p>\n                          <p className=\"text-xs text-slate-500 mt-1\">Please add latitude and longitude to show the map</p>\n              </div>\n          </div>\n                </div>\n              )}\n                      </div>\n                    </div>\n            </section>\n\n            {/* Audit History Section - Admin Only */}\n            {mode === \"admin\" && (\n              <section className=\"border-b border-gray-200 pb-6\">\n                <div className=\"rounded-2xl border border-slate-200 bg-white p-5 sm:p-6 shadow-sm\">\n                  <div className=\"flex items-center gap-2 mb-6\">\n                    <span className=\"inline-flex h-9 w-9 items-center justify-center rounded-xl bg-[#02665e]/10 text-[#02665e]\">\n                      <FileText className=\"w-5 h-5\" aria-hidden />\n                    </span>\n                    <h2 className=\"text-lg sm:text-xl font-semibold text-slate-900\">Audit History</h2>\n                  </div>\n                  \n                  {auditLoading ? (\n                    <div className=\"flex items-center justify-center py-8\">\n                      <LogoSpinner size=\"sm\" ariaLabel=\"Loading audit history\" />\n                      <span className=\"ml-2 text-sm text-gray-600\">Loading audit history...</span>\n                    </div>\n                  ) : auditHistory.length === 0 ? (\n                    <div className=\"text-center py-8 text-gray-500\">\n                      <FileText className=\"h-12 w-12 mx-auto mb-3 opacity-50\" />\n                      <p className=\"text-sm\">No audit history available</p>\n                    </div>\n                  ) : (\n                    <div className=\"space-y-3\">\n                      {auditHistory.map((audit, index) => {\n                        const actionLabels: Record<string, string> = {\n                          PROPERTY_APPROVE: \"Approved\",\n                          PROPERTY_REJECT: \"Rejected\",\n                          PROPERTY_SUSPEND: \"Suspended\",\n                          PROPERTY_UNSUSPEND: \"Unsuspended\",\n                          PROPERTY_UPDATE: \"Updated\",\n                          PROPERTY_IMAGE_MODERATE: \"Image Moderated\",\n                        };\n                        \n                        const actionColors: Record<string, string> = {\n                          PROPERTY_APPROVE: \"bg-emerald-50 text-emerald-700 border-emerald-200\",\n                          PROPERTY_REJECT: \"bg-red-50 text-red-700 border-red-200\",\n                          PROPERTY_SUSPEND: \"bg-orange-50 text-orange-700 border-orange-200\",\n                          PROPERTY_UNSUSPEND: \"bg-blue-50 text-blue-700 border-blue-200\",\n                          PROPERTY_UPDATE: \"bg-gray-50 text-gray-700 border-gray-200\",\n                          PROPERTY_IMAGE_MODERATE: \"bg-purple-50 text-purple-700 border-purple-200\",\n                        };\n                        \n                        const actionLabel = actionLabels[audit.action] || audit.action.replace(/_/g, \" \");\n                        const actionColor = actionColors[audit.action] || \"bg-gray-50 text-gray-700 border-gray-200\";\n                        const actorName = audit.actor?.name || audit.actor?.email || `Admin #${audit.actorId}`;\n                        const auditDate = new Date(audit.createdAt).toLocaleString();\n\n                        const allowedStatuses = new Set([\n                          \"DRAFT\",\n                          \"PENDING\",\n                          \"APPROVED\",\n                          \"NEEDS_FIXES\",\n                          \"REJECTED\",\n                          \"SUSPENDED\",\n                        ]);\n\n                        const humanizeStatus = (s: string) => {\n                          const map: Record<string, string> = {\n                            DRAFT: \"Draft\",\n                            PENDING: \"Pending\",\n                            APPROVED: \"Approved\",\n                            NEEDS_FIXES: \"Needs fixes\",\n                            REJECTED: \"Rejected\",\n                            SUSPENDED: \"Suspended\",\n                          };\n                          return map[s] || s;\n                        };\n\n                        const beforeStatus =\n                          typeof audit.beforeJson?.status === \"string\" && allowedStatuses.has(audit.beforeJson.status)\n                            ? audit.beforeJson.status\n                            : null;\n                        const afterStatus =\n                          typeof audit.afterJson?.status === \"string\" && allowedStatuses.has(audit.afterJson.status)\n                            ? audit.afterJson.status\n                            : null;\n\n                        const changes: Array<{ field: string; from: any; to: any }> = Array.isArray((audit as any).changes)\n                          ? ((audit as any).changes as any[])\n                              .filter(Boolean)\n                              .filter((c) => typeof c.field === \"string\")\n                              .slice(0, 20)\n                          : [];\n\n                        const extraChanges = changes.filter((c) => c.field !== \"Status\");\n                        \n                        return (\n                          <div\n                            key={audit.id?.toString() || index}\n                            className=\"border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow\"\n                          >\n                            <div className=\"flex items-start justify-between gap-4\">\n                              <div className=\"flex-1 min-w-0\">\n                                <div className=\"flex items-center gap-2 mb-2\">\n                                  <span className={`px-2.5 py-1 rounded-md text-xs font-semibold border ${actionColor}`}>\n                                    {actionLabel}\n                                  </span>\n                                  <span className=\"text-xs text-gray-500\">{auditDate}</span>\n                                </div>\n                                <div className=\"text-sm text-gray-700\">\n                                  <span className=\"font-medium\">{actorName}</span>\n                                  {audit.actorRole && (\n                                    <span className=\"text-gray-500 ml-1\">({audit.actorRole})</span>\n                                  )}\n                                </div>\n                                {beforeStatus && afterStatus && beforeStatus !== afterStatus && (\n                                  <div className=\"mt-2 space-y-1\">\n                                    <div className=\"text-xs text-gray-600\">\n                                      Status changed from <strong>{humanizeStatus(beforeStatus)}</strong> to <strong>{humanizeStatus(afterStatus)}</strong>\n                                    </div>\n                                    {audit.afterJson?.reason && (\n                                      <div className=\"text-xs text-gray-700 bg-gray-50 rounded px-2 py-1.5 border border-gray-200\">\n                                        <span className=\"font-medium\">Reason:</span> {audit.afterJson.reason}\n                                      </div>\n                                    )}\n                                  </div>\n                                )}\n\n                                {audit.action === \"PROPERTY_UPDATE\" && extraChanges.length > 0 && (\n                                  <div className=\"mt-3 rounded-lg border border-slate-200 bg-white\">\n                                    <div className=\"px-3 py-2 border-b border-slate-200 bg-slate-50 text-xs font-semibold text-slate-700\">\n                                      Changes\n                                    </div>\n                                    <div className=\"divide-y divide-slate-100\">\n                                      {extraChanges.map((c, i) => (\n                                        <div key={`${audit.id}-chg-${i}`} className=\"px-3 py-2 text-xs\">\n                                          <div className=\"flex items-start justify-between gap-3\">\n                                            <div className=\"font-medium text-slate-700\">{c.field}</div>\n                                            <div className=\"min-w-0 flex-1 text-right\">\n                                              <div className=\"text-slate-500 truncate\">\n                                                <span className=\"font-medium\">From:</span> {c.from ?? \"—\"}\n                                              </div>\n                                              <div className=\"text-slate-700 truncate\">\n                                                <span className=\"font-medium\">To:</span> {c.to ?? \"—\"}\n                                              </div>\n                                            </div>\n                                          </div>\n                                        </div>\n                                      ))}\n                                    </div>\n                                  </div>\n                                )}\n                              </div>\n                            </div>\n                          </div>\n                        );\n                      })}\n                    </div>\n                  )}\n                </div>\n              </section>\n            )}\n                          </div>\n                        </div>\n                      </div>\n\n      {/* Lightbox - Match Public View */}\n      {showLightbox && photos.length > 0 ? (\n        <div\n          className=\"fixed inset-0 z-[200] bg-black/70 backdrop-blur-sm\"\n          role=\"dialog\"\n          aria-modal=\"true\"\n          aria-label=\"Photo gallery\"\n          onClick={(e) => {\n            if (e.target === e.currentTarget) setShowLightbox(false);\n          }}\n        >\n          <div className=\"absolute inset-0 flex items-center justify-center p-4\">\n            <div className=\"w-full max-w-4xl\">\n              <div className=\"flex items-center justify-between mb-3\">\n                <div className=\"text-white text-sm font-semibold truncate\">{property.title || \"Property\"}</div>\n            <button\n                  type=\"button\"\n                  className=\"h-10 w-10 rounded-full bg-white/10 hover:bg-white/20 text-white flex items-center justify-center\"\n              onClick={() => setShowLightbox(false)}\n              aria-label=\"Close\"\n            >\n                  <X className=\"w-5 h-5\" />\n            </button>\n              </div>\n\n              {/* Main image */}\n              <div className=\"mx-auto w-full max-w-[720px]\">\n                <div className=\"relative rounded-2xl overflow-hidden bg-black h-[62vh] max-h-[520px] min-h-[320px]\">\n              <FillImage\n                src={photos[selectedImageIndex]}\n                alt=\"\"\n                className=\"object-contain\"\n                sizes=\"(min-width: 1024px) 720px, 100vw\"\n                priority\n              />\n\n                <button\n                    type=\"button\"\n                    className=\"absolute left-3 top-1/2 -translate-y-1/2 h-10 w-10 rounded-full bg-white/10 hover:bg-white/20 text-white flex items-center justify-center\"\n                  onClick={(e) => {\n                    e.stopPropagation();\n                      setSelectedImageIndex((i) => (i <= 0 ? photos.length - 1 : i - 1));\n                  }}\n                    aria-label=\"Previous photo\"\n                >\n                    <ChevronLeft className=\"w-5 h-5\" />\n                </button>\n                <button\n                    type=\"button\"\n                    className=\"absolute right-3 top-1/2 -translate-y-1/2 h-10 w-10 rounded-full bg-white/10 hover:bg-white/20 text-white flex items-center justify-center\"\n                  onClick={(e) => {\n                    e.stopPropagation();\n                      setSelectedImageIndex((i) => (i >= photos.length - 1 ? 0 : i + 1));\n                  }}\n                    aria-label=\"Next photo\"\n                >\n                    <ChevronRight className=\"w-5 h-5\" />\n                </button>\n                </div>\n              </div>\n\n              {/* Counter under photo */}\n              <div className=\"mt-3 text-center text-white/90 text-sm font-semibold\">\n              {selectedImageIndex + 1} / {photos.length}\n            </div>\n\n              {/* Thumbnails strip */}\n              <div className=\"mt-4 mx-auto w-full max-w-[920px] flex gap-2 overflow-x-auto pb-2 justify-center\">\n                {photos.map((src, i) => (\n                  <button\n                    key={`${src}-${i}`}\n                    type=\"button\"\n                    className={[\n                      \"relative h-16 w-24 sm:h-20 sm:w-28 flex-shrink-0 rounded-xl overflow-hidden border\",\n                      i === selectedImageIndex ? \"border-white\" : \"border-white/20\",\n                      \"motion-safe:transition-transform motion-safe:duration-200 motion-safe:ease-out\",\n                      \"motion-safe:hover:scale-[1.03] motion-safe:active:scale-[0.97]\",\n                      \"focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-white/40 focus-visible:ring-offset-2 focus-visible:ring-offset-black\",\n                    ].join(\" \")}\n                    onClick={(e) => {\n                      e.stopPropagation();\n                      setSelectedImageIndex(i);\n                    }}\n                    aria-label={`View photo ${i + 1}`}\n                  >\n                    <FillImage src={src} alt=\"\" className=\"object-cover\" sizes=\"120px\" />\n                  </button>\n                ))}\n          </div>\n        </div>\n          </div>\n        </div>\n      ) : null}\n\n      {/* Reject Dialog */}\n      {showRejectDialog && (\n        <div className=\"fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4 overflow-y-auto\">\n          <div className=\"bg-white rounded-xl p-4 sm:p-6 max-w-md w-full shadow-xl my-auto max-h-[90vh] flex flex-col\">\n            <h3 className=\"text-lg sm:text-xl font-semibold text-gray-900 mb-3 sm:mb-4\">Reject Property</h3>\n            <p className=\"text-xs sm:text-sm text-gray-600 mb-3 sm:mb-4\">Please provide reasons for rejection (comma-separated):</p>\n            <textarea\n              value={rejectReasons}\n              onChange={(e) => setRejectReasons(e.target.value)}\n              className=\"w-full px-3 py-2 border border-gray-300 rounded-lg mb-4 min-h-[100px] max-h-[200px] resize-y overflow-y-auto text-sm\"\n              placeholder=\"e.g., Insufficient photos, Missing location details, Quality issues\"\n            />\n            <div className=\"flex flex-col sm:flex-row gap-2 justify-end mt-auto\">\n              <button\n                onClick={() => {\n                  setShowRejectDialog(false);\n                  setRejectReasons(\"\");\n                }}\n                className=\"px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors\"\n              >\n                Cancel\n              </button>\n              <button\n                onClick={handleReject}\n                disabled={saving || !rejectReasons.trim()}\n                className=\"px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors\"\n              >\n                {saving ? \"Rejecting...\" : \"Reject Property\"}\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Suspend Dialog */}\n      {showSuspendDialog && (\n        <div className=\"fixed inset-0 z-[100] bg-black/50 backdrop-blur-sm flex items-center justify-center p-3 sm:p-4 overflow-y-auto\">\n          <div className=\"bg-white rounded-xl p-4 sm:p-5 max-w-md w-full shadow-2xl my-auto max-h-[90vh] flex flex-col box-border overflow-hidden relative\">\n            {/* Header */}\n            <div className=\"flex items-center gap-2.5 mb-3 flex-shrink-0\">\n              <div className=\"inline-flex items-center justify-center h-9 w-9 sm:h-10 sm:w-10 rounded-full bg-orange-100 flex-shrink-0\">\n                <Ban className=\"h-4 w-4 sm:h-5 sm:w-5 text-orange-600\" />\n              </div>\n              <div className=\"min-w-0 flex-1\">\n                <h3 className=\"text-base sm:text-lg font-semibold text-gray-900 truncate\">Suspend Property</h3>\n                <p className=\"text-[10px] sm:text-xs text-gray-500 mt-0.5\">Temporary removal from public view</p>\n              </div>\n            </div>\n            \n            {/* Warning Box */}\n            <div className=\"bg-amber-50/80 border border-amber-200/60 rounded-lg p-2.5 sm:p-3 mb-3 flex-shrink-0\">\n              <p className=\"text-[11px] sm:text-xs text-amber-800 leading-relaxed\">\n                <strong className=\"font-semibold\">Important:</strong> Suspending this property will remove it from public search and booking. \n                This is a temporary action to resolve disputes. The property will remain visible to admins only.\n              </p>\n            </div>\n\n            {/* Content Area - Scrollable */}\n            <div className=\"flex-1 min-h-0 overflow-y-auto mb-3 space-y-3\">\n              {/* Reason Textarea */}\n              <div className=\"flex-shrink-0 min-w-0\">\n                <label className=\"block text-xs sm:text-sm font-medium text-gray-700 mb-1.5\">\n                  Suspension Reason <span className=\"text-red-500\">*</span>\n                </label>\n                <textarea\n                  value={suspendReason}\n                  onChange={(e) => setSuspendReason(e.target.value)}\n                  onFocus={(e) => {\n                    // Auto-fill with professional template if empty\n                    if (!suspendReason.trim()) {\n                      setSuspendReason(SUSPENSION_REASON_TEMPLATE);\n                      // Set cursor at the end after auto-fill\n                      setTimeout(() => {\n                        e.target.setSelectionRange(e.target.value.length, e.target.value.length);\n                      }, 0);\n                    }\n                  }}\n                  className=\"w-full max-w-full min-w-0 px-3 py-2 border border-gray-300 rounded-lg min-h-[100px] max-h-[150px] resize-y overflow-y-auto text-xs sm:text-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-all box-border\"\n                  placeholder=\"Provide a detailed reason for suspending this property...\"\n                />\n                <p className=\"text-[10px] sm:text-xs text-gray-500 mt-1.5\">This reason will be stored in audit history and sent to the owner.</p>\n              </div>\n\n              {/* Checkbox */}\n              <div className=\"flex-shrink-0\">\n                <label className=\"flex items-center gap-2 cursor-pointer min-w-0\">\n                  <input\n                    type=\"checkbox\"\n                    checked={notifyOwnerOnSuspend}\n                    onChange={(e) => setNotifyOwnerOnSuspend(e.target.checked)}\n                    className=\"rounded border-gray-300 text-orange-600 focus:ring-orange-500 flex-shrink-0 w-4 h-4\"\n                  />\n                  <span className=\"text-xs sm:text-sm text-gray-700\">Notify owner about this suspension</span>\n                </label>\n              </div>\n            </div>\n\n            {/* Action Buttons - Fixed at Bottom */}\n            <div className=\"flex flex-col sm:flex-row gap-2 justify-end flex-shrink-0 pt-3 border-t border-gray-200 mt-auto\">\n              <button\n                onClick={() => {\n                  setShowSuspendDialog(false);\n                  setSuspendReason(\"\");\n                  setNotifyOwnerOnSuspend(true);\n                }}\n                className=\"order-2 sm:order-1 px-3.5 sm:px-4 py-2 text-xs sm:text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors w-full sm:w-auto box-border\"\n              >\n                Cancel\n              </button>\n              <button\n                onClick={handleSuspend}\n                disabled={saving || !suspendReason.trim()}\n                className=\"order-1 sm:order-2 px-3.5 sm:px-4 py-2 text-xs sm:text-sm font-medium text-white bg-orange-600 rounded-lg hover:bg-orange-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors w-full sm:w-auto box-border\"\n              >\n                {saving ? \"Suspending...\" : \"Confirm Suspension\"}\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Unsuspend Dialog */}\n      {showUnsuspendDialog && (\n        <div className=\"fixed inset-0 z-[100] bg-black/50 backdrop-blur-sm flex items-center justify-center p-3 sm:p-4 overflow-y-auto\">\n          <div className=\"bg-white rounded-xl p-4 sm:p-5 max-w-md w-full shadow-2xl my-auto max-h-[90vh] flex flex-col box-border overflow-hidden relative\">\n            {/* Header */}\n            <div className=\"flex items-center gap-2.5 mb-3 flex-shrink-0\">\n              <div className=\"inline-flex items-center justify-center h-9 w-9 sm:h-10 sm:w-10 rounded-full bg-blue-100 flex-shrink-0\">\n                <CheckCircle2 className=\"h-4 w-4 sm:h-5 sm:w-5 text-blue-600\" />\n              </div>\n              <div className=\"min-w-0 flex-1\">\n                <h3 className=\"text-base sm:text-lg font-semibold text-gray-900 truncate\">Unsuspend Property</h3>\n                <p className=\"text-[10px] sm:text-xs text-gray-500 mt-0.5\">Restore property to public view</p>\n              </div>\n            </div>\n            \n            {/* Warning Box */}\n            <div className=\"bg-blue-50/80 border border-blue-200/60 rounded-lg p-2.5 sm:p-3 mb-3 flex-shrink-0\">\n              <p className=\"text-[11px] sm:text-xs text-blue-800 leading-relaxed\">\n                <strong className=\"font-semibold\">Note:</strong> Unsuspending this property will restore it to public search and booking. \n                The property will be visible to all users and ready for bookings.\n              </p>\n            </div>\n\n            {/* Content Area - Scrollable */}\n            <div className=\"flex-1 min-h-0 overflow-y-auto mb-3\">\n              <div className=\"flex-shrink-0 min-w-0\">\n                <label className=\"block text-xs sm:text-sm font-medium text-gray-700 mb-1.5\">\n                  Unsuspension Reason <span className=\"text-red-500\">*</span>\n                </label>\n                <textarea\n                  value={unsuspendReason}\n                  onChange={(e) => setUnsuspendReason(e.target.value)}\n                  className=\"w-full max-w-full min-w-0 px-3 py-2 border border-gray-300 rounded-lg min-h-[100px] max-h-[150px] resize-y overflow-y-auto text-xs sm:text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all box-border\"\n                  placeholder=\"Provide a detailed reason for unsuspending this property...\"\n                />\n                <p className=\"text-[10px] sm:text-xs text-gray-500 mt-1.5\">This reason will be stored in audit history.</p>\n              </div>\n            </div>\n\n            {/* Action Buttons - Fixed at Bottom */}\n            <div className=\"flex flex-col sm:flex-row gap-2 justify-end flex-shrink-0 pt-3 border-t border-gray-200 mt-auto\">\n              <button\n                onClick={() => {\n                  setShowUnsuspendDialog(false);\n                  setUnsuspendReason(\"\");\n                }}\n                className=\"order-2 sm:order-1 px-3.5 sm:px-4 py-2 text-xs sm:text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors w-full sm:w-auto box-border\"\n              >\n                Cancel\n              </button>\n              <button\n                onClick={handleUnsuspend}\n                disabled={saving || !unsuspendReason.trim()}\n                className=\"order-1 sm:order-2 px-3.5 sm:px-4 py-2 text-xs sm:text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors w-full sm:w-auto box-border\"\n              >\n                {saving ? \"Unsuspending...\" : \"Confirm Unsuspension\"}\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Property Edit Modal */}\n      {property && (\n        <PropertyEditModal\n          property={property}\n          isOpen={showEditModal}\n          onClose={() => setShowEditModal(false)}\n          onSave={async () => {\n            // Force a complete reload by resetting property state first\n            setProperty(null);\n            setLoading(true);\n            \n            // Reload property data to get updated commission, discount rules, and room prices\n            await loadProperty();\n            \n            // Also reload system commission in case it changed\n            try {\n              const response = await api.get(\"/admin/settings\");\n              if (response.data?.commissionPercent !== undefined) {\n                const commission = Number(response.data.commissionPercent);\n                setSystemCommission(isNaN(commission) ? 0 : commission);\n              }\n            } catch (e) {\n              // Silently fail\n            }\n            \n            // Trigger parent's onUpdated callback to refresh the list\n            onUpdated?.();\n          }}\n        />\n      )}\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\PropertyVisualization.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Wifi' is defined but never used. Allowed unused vars must match /^_/u.","line":4,"column":53,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":57,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Wifi"},"fix":{"range":[111,117],"text":""},"desc":"Remove unused variable \"Wifi\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Tv' is defined but never used. Allowed unused vars must match /^_/u.","line":4,"column":59,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":61,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Tv"},"fix":{"range":[117,121],"text":""},"desc":"Remove unused variable \"Tv\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Wind' is defined but never used. Allowed unused vars must match /^_/u.","line":4,"column":63,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":67,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Wind"},"fix":{"range":[121,127],"text":""},"desc":"Remove unused variable \"Wind\"."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useMemo } from \"react\";\r\nimport { MapPin, ChevronUp, ChevronDown, BedDouble, Wifi, Tv, Wind } from \"lucide-react\";\r\nimport { useRouter } from \"next/navigation\";\r\n\r\ninterface Room {\r\n  code: string;\r\n  floor: number;\r\n  floorName: string;\r\n  roomType: string;\r\n  pricePerNight: number | null;\r\n  amenities?: string[];\r\n}\r\n\r\ninterface PropertyVisualizationProps {\r\n  property: {\r\n    id: number;\r\n    title: string;\r\n    buildingType?: string | null;\r\n    roomsSpec?: any;\r\n    currency?: string | null;\r\n  };\r\n  onRoomSelect?: (roomCode: string, floor: number) => void;\r\n}\r\n\r\nfunction getOrdinal(n: number): string {\r\n  const s = ['th', 'st', 'nd', 'rd'];\r\n  const v = n % 100;\r\n  return s[(v - 20) % 10] || s[v] || s[0];\r\n}\r\n\r\nfunction formatPrice(price: number | null, currency: string = \"TZS\"): string {\r\n  if (!price) return \"—\";\r\n  return new Intl.NumberFormat('en-TZ', {\r\n    style: 'currency',\r\n    currency: currency,\r\n    maximumFractionDigits: 0,\r\n  }).format(price);\r\n}\r\n\r\nfunction extractRoomsWithFloors(roomsSpec: any): Room[] {\r\n  if (!roomsSpec) return [];\r\n  \r\n  let roomTypes: any[] = [];\r\n  if (Array.isArray(roomsSpec)) {\r\n    roomTypes = roomsSpec;\r\n  } else if (roomsSpec.rooms && Array.isArray(roomsSpec.rooms)) {\r\n    roomTypes = roomsSpec.rooms;\r\n  }\r\n  \r\n  // Determine floors from building type or room codes\r\n  const rooms: Room[] = roomTypes.map((rt: any, index: number) => {\r\n    // Try to extract floor from code (e.g., \"1-201\" = floor 1, \"G-101\" = floor 0)\r\n    let floor = 0;\r\n    let floorName = \"Ground\";\r\n    const code = rt.code || rt.roomCode || `G-${String(index + 1).padStart(3, '0')}`;\r\n    \r\n    // Parse floor from code\r\n    if (code.includes('-')) {\r\n      const floorPart = code.split('-')[0];\r\n      if (floorPart === 'G' || floorPart === 'g') {\r\n        floor = 0;\r\n        floorName = \"Ground\";\r\n      } else {\r\n        const floorNum = parseInt(floorPart);\r\n        if (!isNaN(floorNum)) {\r\n          floor = floorNum;\r\n          floorName = `${floorNum}${getOrdinal(floorNum)}`;\r\n        }\r\n      }\r\n    }\r\n    \r\n    return {\r\n      code,\r\n      floor,\r\n      floorName,\r\n      roomType: rt.roomType || rt.name || rt.label || \"Room\",\r\n      pricePerNight: rt.pricePerNight || rt.price || null,\r\n      amenities: rt.amenities || rt.otherAmenities || [],\r\n    };\r\n  });\r\n  \r\n  return rooms;\r\n}\r\n\r\nexport default function PropertyVisualization({ property, onRoomSelect }: PropertyVisualizationProps) {\r\n  const router = useRouter();\r\n  const [currentFloor, setCurrentFloor] = useState(0);\r\n  \r\n  const rooms = useMemo(() => extractRoomsWithFloors(property.roomsSpec), [property.roomsSpec]);\r\n  \r\n  // Group rooms by floor\r\n  const roomsByFloor = useMemo(() => {\r\n    return rooms.reduce((acc, room) => {\r\n      if (!acc[room.floor]) acc[room.floor] = [];\r\n      acc[room.floor].push(room);\r\n      return acc;\r\n    }, {} as Record<number, Room[]>);\r\n  }, [rooms]);\r\n  \r\n  const floors = useMemo(() => {\r\n    return Object.keys(roomsByFloor).map(Number).sort((a, b) => a - b);\r\n  }, [roomsByFloor]);\r\n  \r\n  const currentRooms = roomsByFloor[currentFloor] || [];\r\n  const currency = property.currency || \"TZS\";\r\n  \r\n  // Auto-set to first available floor\r\n  if (floors.length > 0 && currentFloor === 0 && !roomsByFloor[currentFloor]) {\r\n    setCurrentFloor(floors[0]);\r\n  }\r\n  \r\n  const handleRoomClick = (room: Room) => {\r\n    if (onRoomSelect) {\r\n      onRoomSelect(room.code, room.floor);\r\n    } else {\r\n      // Default: navigate to booking\r\n      router.push(`/public/booking/confirm?property=${property.id}&roomCode=${room.code}&floor=${room.floor}`);\r\n    }\r\n  };\r\n  \r\n  if (rooms.length === 0) {\r\n    return (\r\n      <div className=\"bg-white rounded-2xl shadow-xl border border-slate-200 p-8 text-center\">\r\n        <BedDouble className=\"w-12 h-12 text-slate-400 mx-auto mb-4\" />\r\n        <p className=\"text-slate-600\">Room information not available</p>\r\n      </div>\r\n    );\r\n  }\r\n  \r\n  return (\r\n    <div className=\"bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden\">\r\n      {/* Header */}\r\n      <div className=\"bg-gradient-to-r from-[#02665e] to-[#014e47] p-6 text-white\">\r\n        <div className=\"flex items-center justify-between\">\r\n          <div>\r\n            <h3 className=\"text-2xl font-bold mb-1\">{property.title}</h3>\r\n            <p className=\"text-sm text-white/80\">Interactive Floor Plan</p>\r\n          </div>\r\n          <div className=\"flex items-center gap-2 px-4 py-2 bg-white/20 backdrop-blur-sm rounded-xl\">\r\n            <MapPin className=\"w-5 h-5\" />\r\n            <span className=\"font-semibold\">\r\n              {floors.length} {floors.length === 1 ? 'Floor' : 'Floors'}\r\n            </span>\r\n          </div>\r\n        </div>\r\n      </div>\r\n      \r\n      {/* Floor Selector */}\r\n      {floors.length > 1 && (\r\n        <div className=\"px-6 pt-6 pb-4 bg-slate-50 border-b border-slate-200\">\r\n          <div className=\"flex items-center gap-2 overflow-x-auto pb-2 scrollbar-hide\">\r\n            {floors.map((floor) => (\r\n              <button\r\n                key={floor}\r\n                onClick={() => setCurrentFloor(floor)}\r\n                className={`px-4 py-2.5 rounded-xl font-semibold text-sm transition-all whitespace-nowrap flex-shrink-0 ${\r\n                  currentFloor === floor\r\n                    ? 'bg-[#02665e] text-white shadow-lg transform scale-105'\r\n                    : 'bg-white text-slate-700 hover:bg-slate-100 border border-slate-200'\r\n                }`}\r\n              >\r\n                {floor === 0 ? 'Ground' : `${floor}${getOrdinal(floor)}`} Floor\r\n              </button>\r\n            ))}\r\n          </div>\r\n        </div>\r\n      )}\r\n      \r\n      {/* Floor Plan */}\r\n      <div className=\"p-6\">\r\n        {/* Floor Title */}\r\n        <div className=\"text-center mb-6\">\r\n          <h4 className=\"text-xl font-bold text-slate-900 mb-1\">\r\n            {currentFloor === 0 ? 'Ground' : `${currentFloor}${getOrdinal(currentFloor)}`} Floor\r\n          </h4>\r\n          <p className=\"text-sm text-slate-600\">\r\n            {currentRooms.length} {currentRooms.length === 1 ? 'room' : 'rooms'} available\r\n          </p>\r\n        </div>\r\n        \r\n        {/* Room Grid */}\r\n        {currentRooms.length > 0 ? (\r\n          <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4\">\r\n            {currentRooms.map((room) => (\r\n              <button\r\n                key={room.code}\r\n                onClick={() => handleRoomClick(room)}\r\n                className=\"group relative bg-gradient-to-br from-white to-slate-50 rounded-xl border-2 border-slate-200 p-5 hover:border-[#02665e] hover:shadow-xl transition-all duration-300 text-left transform hover:scale-105\"\r\n              >\r\n                {/* Room Code Badge */}\r\n                <div className=\"absolute -top-2 -right-2 bg-gradient-to-r from-[#02665e] to-[#014e47] text-white text-xs font-bold px-3 py-1.5 rounded-lg shadow-lg z-10\">\r\n                  {room.code}\r\n                </div>\r\n                \r\n                {/* Room Icon */}\r\n                <div className=\"mb-3\">\r\n                  <div className=\"w-12 h-12 bg-[#02665e]/10 rounded-xl flex items-center justify-center group-hover:bg-[#02665e]/20 transition-colors\">\r\n                    <BedDouble className=\"w-6 h-6 text-[#02665e]\" />\r\n                  </div>\r\n                </div>\r\n                \r\n                {/* Room Type */}\r\n                <div className=\"text-base font-bold text-slate-900 mb-2\">\r\n                  {room.roomType}\r\n                </div>\r\n                \r\n                {/* Price */}\r\n                <div className=\"text-2xl font-extrabold text-[#02665e] mb-1\">\r\n                  {formatPrice(room.pricePerNight, currency)}\r\n                </div>\r\n                <div className=\"text-xs text-slate-500 mb-3\">per night</div>\r\n                \r\n                {/* Quick Amenities */}\r\n                {room.amenities && room.amenities.length > 0 && (\r\n                  <div className=\"flex items-center gap-2 flex-wrap mt-3 pt-3 border-t border-slate-200\">\r\n                    {room.amenities.slice(0, 3).map((amenity, idx) => (\r\n                      <span\r\n                        key={idx}\r\n                        className=\"text-xs px-2 py-1 bg-slate-100 text-slate-600 rounded-md\"\r\n                      >\r\n                        {amenity}\r\n                      </span>\r\n                    ))}\r\n                    {room.amenities.length > 3 && (\r\n                      <span className=\"text-xs text-slate-500\">+{room.amenities.length - 3} more</span>\r\n                    )}\r\n                  </div>\r\n                )}\r\n                \r\n                {/* Hover Overlay */}\r\n                <div className=\"absolute inset-0 bg-[#02665e]/5 rounded-xl opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none\" />\r\n                \r\n                {/* Click Indicator */}\r\n                <div className=\"absolute bottom-3 right-3 text-xs text-slate-400 group-hover:text-[#02665e] transition-colors font-medium\">\r\n                  Click to book →\r\n                </div>\r\n              </button>\r\n            ))}\r\n          </div>\r\n        ) : (\r\n          <div className=\"text-center py-12\">\r\n            <BedDouble className=\"w-16 h-16 text-slate-300 mx-auto mb-4\" />\r\n            <p className=\"text-slate-600 font-medium\">No rooms available on this floor</p>\r\n          </div>\r\n        )}\r\n        \r\n        {/* Navigation */}\r\n        {floors.length > 1 && (\r\n          <div className=\"flex items-center justify-between mt-8 pt-6 border-t border-slate-200\">\r\n            <button\r\n              onClick={() => {\r\n                const prevIndex = floors.indexOf(currentFloor);\r\n                if (prevIndex > 0) setCurrentFloor(floors[prevIndex - 1]);\r\n              }}\r\n              disabled={floors.indexOf(currentFloor) === 0}\r\n              className=\"flex items-center gap-2 px-5 py-2.5 rounded-xl bg-slate-100 text-slate-700 hover:bg-slate-200 disabled:opacity-50 disabled:cursor-not-allowed transition-all font-medium\"\r\n            >\r\n              <ChevronDown className=\"w-4 h-4\" />\r\n              Previous Floor\r\n            </button>\r\n            \r\n            <div className=\"text-sm text-slate-600 font-medium px-4 py-2 bg-slate-100 rounded-lg\">\r\n              Floor {floors.indexOf(currentFloor) + 1} of {floors.length}\r\n            </div>\r\n            \r\n            <button\r\n              onClick={() => {\r\n                const nextIndex = floors.indexOf(currentFloor);\r\n                if (nextIndex < floors.length - 1) setCurrentFloor(floors[nextIndex + 1]);\r\n              }}\r\n              disabled={floors.indexOf(currentFloor) === floors.length - 1}\r\n              className=\"flex items-center gap-2 px-5 py-2.5 rounded-xl bg-slate-100 text-slate-700 hover:bg-slate-200 disabled:opacity-50 disabled:cursor-not-allowed transition-all font-medium\"\r\n            >\r\n              Next Floor\r\n              <ChevronUp className=\"w-4 h-4\" />\r\n            </button>\r\n          </div>\r\n        )}\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\PublicApprovedPropertyCard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\PublicFooter.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'FooterPill' is defined but never used. Allowed unused vars must match /^_/u.","line":36,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":36,"endColumn":20}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport React, { useEffect, useRef, useState } from \"react\";\nimport Link from \"next/link\";\nimport Image from \"next/image\";\nimport { Linkedin, Instagram, Youtube, X, Facebook } from \"lucide-react\";\n\ntype FooterPillVariant = \"brand\" | \"neutral\";\n\nconst APP_VERSION = \"v0.1.0\";\n\nfunction FooterPolicyItem({\n  children,\n  href,\n}: {\n  children: React.ReactNode;\n  href: string;\n}) {\n  const className =\n    \"group relative inline-flex appearance-none items-center rounded-md border border-transparent bg-transparent px-2.5 py-1.5 text-sm font-semibold cursor-pointer \" +\n    \"text-slate-200 no-underline transition-all duration-300 ease-out \" +\n    \"hover:text-white hover:bg-white/10 \" +\n    \"focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[#02665e]/30 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-950 \" +\n    \"motion-reduce:transition-none\";\n\n  return (\n    <Link href={href} className={className}>\n      <span className=\"relative\">\n        {children}\n        <span className=\"pointer-events-none absolute -bottom-1 left-0 h-px w-0 bg-gradient-to-r from-[#02665e] to-sky-500 transition-all duration-300 group-hover:w-full\" />\n      </span>\n    </Link>\n  );\n}\n\nfunction FooterPill({\n  children,\n  href,\n  variant = \"brand\",\n}: {\n  children: React.ReactNode;\n  href: string;\n  variant?: FooterPillVariant;\n}) {\n  const base =\n    \"group relative inline-flex items-center rounded-full border bg-white/10 px-3 py-1.5 text-xs font-semibold no-underline overflow-hidden \" +\n    \"transition-[transform,background-color,border-color,color] duration-300 ease-out \" +\n    \"hover:-translate-y-[1px] active:translate-y-0 active:scale-[0.99] \" +\n    \"motion-reduce:transition-none motion-reduce:hover:transform-none motion-reduce:active:transform-none\";\n\n  const brand =\n    \"border-white/15 text-emerald-200 hover:bg-white/15 hover:border-white/25 focus-visible:ring-2 focus-visible:ring-[#02665e]/25\";\n  const neutral =\n    \"border-white/15 text-slate-200 hover:bg-white/10 hover:border-white/25 focus-visible:ring-2 focus-visible:ring-white/20\";\n\n  const overlayTint =\n    variant === \"brand\"\n      ? \"bg-gradient-to-b from-[#02665e]/20 to-[#02665e]/10\"\n      : \"bg-gradient-to-b from-white/10 to-white/0\";\n\n  const overlayShine = variant === \"brand\" ? \"via-white/70\" : \"via-slate-200/80\";\n\n  const className = `${base} ${variant === \"brand\" ? brand : neutral}`;\n\n  return (\n    <Link href={href} className={className}>\n      <span\n        aria-hidden\n        className={`pointer-events-none absolute inset-0 opacity-0 transition-opacity duration-300 ease-out group-hover:opacity-100 ${overlayTint}`}\n      />\n      <span\n        aria-hidden\n        className={`pointer-events-none absolute -inset-y-2 -left-1/3 w-1/3 rotate-12 bg-gradient-to-r from-transparent ${overlayShine} to-transparent opacity-0 blur-[1px] transition-all duration-500 ease-out group-hover:left-full group-hover:opacity-60 motion-reduce:hidden`}\n      />\n      <span className=\"relative z-10\">{children}</span>\n    </Link>\n  );\n}\n\nfunction IconLinkButton({\n  href,\n  label,\n  iconComponent,\n  iconSize = 20,\n  iconClassName = \"\",\n  iconActiveClass = \"\",\n  containerClassName = \"\",\n  onClick,\n  delay = 0,\n}: {\n  href: string;\n  label: string;\n  iconComponent?: React.ComponentType<any> | undefined;\n  iconSize?: number;\n  iconClassName?: string;\n  iconActiveClass?: string;\n  containerClassName?: string;\n  onClick?: (e: React.MouseEvent<HTMLAnchorElement>) => void;\n  delay?: number;\n}) {\n  const [touched, setTouched] = useState(false);\n  const timeoutRef = useRef<number | null>(null);\n\n  useEffect(() => {\n    return () => {\n      if (timeoutRef.current) window.clearTimeout(timeoutRef.current);\n    };\n  }, []);\n\n  const clearTouch = (delay = 600) => {\n    if (timeoutRef.current) window.clearTimeout(timeoutRef.current);\n    timeoutRef.current = window.setTimeout(() => setTouched(false), delay);\n  };\n\n  const onTouchStart = () => {\n    setTouched(true);\n    if (timeoutRef.current) window.clearTimeout(timeoutRef.current);\n  };\n\n  const onTouchEnd = () => {\n    clearTouch(700);\n  };\n\n  const onPointerDown = () => {\n    setTouched(true);\n  };\n\n  const onPointerUp = () => {\n    clearTouch(300);\n  };\n\n  let clonedIcon: React.ReactNode;\n  const IconComp = iconComponent;\n  if (IconComp) {\n    clonedIcon = React.createElement(IconComp, {\n      size: iconSize,\n      'aria-hidden': true,\n      className: `${iconClassName ?? \"\"} ${touched ? iconActiveClass : \"\"} stroke-current transition-all duration-300`.trim(),\n      strokeWidth: 1.5,\n    });\n  } else {\n    console.warn('PublicFooter: icon component is missing for', label);\n    clonedIcon = <span className=\"inline-block w-5 h-5 rounded-sm bg-gray-300\" aria-hidden=\"true\" />;\n  }\n\n  return (\n    <a\n      href={href}\n      target=\"_blank\"\n      rel=\"noopener noreferrer\"\n      onClick={onClick}\n      aria-label={label}\n      onTouchStart={onTouchStart}\n      onTouchEnd={onTouchEnd}\n      onPointerDown={onPointerDown}\n      onPointerUp={onPointerUp}\n      style={{ animationDelay: `${delay}ms` }}\n      className={`group relative inline-flex items-center justify-center rounded-full no-underline focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#02665e]/30 focus:ring-offset-slate-950 transition-all duration-300 ease-out transform hover:-translate-y-[1px] hover:shadow-md active:translate-y-0 active:shadow-sm ${touched ? \"-translate-y-[1px]\" : \"\"} ${containerClassName}`}\n    >\n      <span\n        aria-hidden\n        className=\"pointer-events-none absolute inset-0 rounded-full bg-gradient-to-br from-white/50 to-transparent opacity-0 transition-opacity duration-300 group-hover:opacity-100\"\n      />\n      {clonedIcon}\n      <span className=\"sr-only\">{label}</span>\n    </a>\n  );\n}\n\nexport default function PublicFooter({ withRail = true }: { withRail?: boolean }) {\n  const year = new Date().getFullYear();\n  const [newsletterEmail, setNewsletterEmail] = useState<string>('');\n  const [newsletterLoading, setNewsletterLoading] = useState(false);\n  const [newsletterStatus, setNewsletterStatus] = useState<null | { ok: boolean; message: string }>(null);\n\n  const subscribeNewsletter = async () => {\n    setNewsletterStatus(null);\n    const email = (newsletterEmail || '').trim();\n    if (!email || !/^\\S+@\\S+\\.\\S+$/.test(email)) {\n      setNewsletterStatus({ ok: false, message: 'Please enter a valid email address.' });\n      return;\n    }\n    setNewsletterLoading(true);\n    try {\n      // Best-effort: try application API endpoint\n      const res = await fetch('/api/newsletter', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({ email }),\n      });\n      if (res.ok) {\n        setNewsletterStatus({ ok: true, message: 'Subscribed — check your inbox.' });\n        setNewsletterEmail('');\n      } else {\n        // show server message if available\n        let text = 'Subscription failed';\n        try { const j = await res.json(); if (j?.message) text = String(j.message); } catch {}\n        setNewsletterStatus({ ok: false, message: text });\n      }\n    } catch {\n      // fallback: instruct user to email\n      setNewsletterStatus({ ok: false, message: 'Could not reach server. Please email info@nolsaf.com to subscribe.' });\n    } finally {\n      setNewsletterLoading(false);\n    }\n  };\n  // Set navigation context for policy pages\n  useEffect(() => {\n    if (typeof window !== 'undefined') {\n      sessionStorage.setItem('navigationContext', 'public');\n    }\n  }, []);\n\n  return (\n    <footer\n      aria-label=\"Footer\"\n      className=\"relative w-full mt-10 page-bottom-buffer overflow-hidden border-t border-gray-200/70 bg-gradient-to-b from-white via-slate-50 to-white\"\n    >\n      <h2 className=\"sr-only\">Footer</h2>\n\n      {withRail ? (\n        <div aria-hidden className=\"absolute inset-x-0 top-0 h-1 flex\">\n          <span className=\"footer-rail-seg footer-rail-green w-[34%]\" />\n          <span className=\"footer-rail-seg footer-rail-yellow w-[8%]\" />\n          <span className=\"footer-rail-seg footer-rail-black w-[8%]\" />\n          <span className=\"footer-rail-seg footer-rail-blue w-[50%]\" />\n        </div>\n      ) : null}\n\n      <div\n        aria-hidden\n        className=\"pointer-events-none absolute -top-24 left-1/2 h-72 w-[900px] -translate-x-1/2 rounded-full bg-[radial-gradient(closest-side,rgba(2,102,94,0.22),transparent_70%)] blur-2xl\"\n      />\n\n      <div className=\"public-container pt-10 pb-10 relative z-10\">\n        <div className=\"rounded-3xl border border-white/12 bg-gradient-to-b from-slate-950/85 via-slate-900/80 to-slate-950/85 backdrop-blur-xl shadow-[0_18px_70px_rgba(0,0,0,0.45)] text-slate-200\">\n          <div className=\"px-5 py-8 sm:px-8\">\n            <div className=\"grid grid-cols-1 lg:grid-cols-12 gap-8 items-start\">\n              <div className=\"lg:col-span-5 space-y-4\">\n                <div className=\"flex items-start gap-3\">\n                  <Image\n                    src=\"/assets/NoLS2025-04.png\"\n                    alt=\"NoLSAF\"\n                    width={120}\n                    height={32}\n                    className=\"object-contain brightness-0 invert\"\n                    style={{ width: \"auto\", height: \"auto\" }}\n                  />\n                  <span className=\"inline-flex items-center rounded-full border border-white/15 bg-white/10 px-2.5 py-1 text-[11px] font-semibold text-slate-200\">\n                    {APP_VERSION}\n                  </span>\n                </div>\n                <p className=\"text-sm text-slate-300 leading-relaxed max-w-sm\">\n                  NoLSAF connects travellers, owners and drivers with safe, local stays and services across East Africa.\n                </p>\n\n                <div className=\"flex items-center gap-3 pt-2 flex-wrap\">\n                  <IconLinkButton\n                    href=\"https://www.linkedin.com/company/nolsaf\"\n                    label=\"NoLSAF on LinkedIn\"\n                    iconComponent={Linkedin}\n                    iconSize={20}\n                    iconClassName=\"text-[#0A66C2] relative z-10\"\n                    iconActiveClass=\"text-[#084A9A]\"\n                    containerClassName=\"h-11 w-11 bg-white/10 backdrop-blur-sm border border-white/15 hover:bg-white/15 hover:border-white/25\"\n                    delay={0}\n                  />\n                  <IconLinkButton\n                    href=\"https://www.instagram.com/nolsaf\"\n                    label=\"NoLSAF on Instagram\"\n                    iconComponent={Instagram}\n                    iconSize={20}\n                    iconClassName=\"text-[#E4405F] relative z-10\"\n                    iconActiveClass=\"text-[#C32B4E]\"\n                    containerClassName=\"h-11 w-11 bg-white/10 backdrop-blur-sm border border-white/15 hover:bg-white/15 hover:border-white/25\"\n                    delay={100}\n                  />\n                  <IconLinkButton\n                    href=\"https://www.youtube.com/@nolsaf\"\n                    label=\"NoLSAF on YouTube\"\n                    iconComponent={Youtube}\n                    iconSize={20}\n                    iconClassName=\"text-[#FF0000] relative z-10\"\n                    iconActiveClass=\"text-[#CC0000]\"\n                    containerClassName=\"h-11 w-11 bg-white/10 backdrop-blur-sm border border-white/15 hover:bg-white/15 hover:border-white/25\"\n                    delay={200}\n                  />\n                  <IconLinkButton\n                    href=\"https://x.com/nolsaf\"\n                    label=\"NoLSAF on X\"\n                    iconComponent={X}\n                    iconSize={20}\n                    iconClassName=\"text-white relative z-10\"\n                    iconActiveClass=\"text-white\"\n                    containerClassName=\"h-11 w-11 bg-white/10 backdrop-blur-sm border border-white/15 hover:bg-white/15 hover:border-white/25\"\n                    delay={300}\n                  />\n                  <IconLinkButton\n                    href=\"https://www.facebook.com/nolsaf\"\n                    label=\"NoLSAF on Facebook\"\n                    iconComponent={Facebook}\n                    iconSize={20}\n                    iconClassName=\"text-[#1877F2] relative z-10\"\n                    iconActiveClass=\"text-[#165db8]\"\n                    containerClassName=\"h-11 w-11 bg-white/10 backdrop-blur-sm border border-white/15 hover:bg-white/15 hover:border-white/25\"\n                    delay={400}\n                  />\n                </div>\n              </div>\n\n              <div className=\"lg:col-span-7\">\n                <div className=\"rounded-2xl border border-white/12 bg-white/6 backdrop-blur-sm p-5 shadow-sm shadow-black/20\">\n                  <div className=\"flex flex-col gap-1\">\n                    <div className=\"inline-flex items-center gap-2 rounded-full border border-white/15 bg-white/10 px-3 py-1 text-xs font-semibold tracking-wide text-slate-100 w-fit\">\n                      <span className=\"inline-block h-1.5 w-1.5 rounded-full bg-emerald-300\" />\n                      Newsletter\n                    </div>\n                    <div className=\"text-sm text-slate-300\">\n                      Monthly updates on new stays, destinations, and platform improvements.\n                    </div>\n                  </div>\n\n                  <div className=\"mt-4 flex flex-col sm:flex-row gap-2\">\n                    <form\n                      className=\"flex flex-1 flex-col sm:flex-row gap-2\"\n                      onSubmit={(e) => {\n                        e.preventDefault();\n                        if (!newsletterLoading) void subscribeNewsletter();\n                      }}\n                    >\n                      <label htmlFor=\"newsletter-email-2\" className=\"sr-only\">\n                        Newsletter email\n                      </label>\n                      <input\n                        id=\"newsletter-email-2\"\n                        type=\"email\"\n                        value={newsletterEmail}\n                        onChange={(e) => setNewsletterEmail(e.target.value)}\n                        placeholder=\"Your email\"\n                        autoComplete=\"email\"\n                        className=\"flex-1 border border-white/12 rounded-xl px-4 py-2.5 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-[#02665e]/25 focus:border-[#02665e] transition-all duration-300 bg-white/10 text-slate-100 placeholder:text-slate-400 hover:border-white/20\"\n                        aria-label=\"Newsletter email\"\n                      />\n                      <button\n                        type=\"submit\"\n                        className={`px-5 py-2.5 rounded-xl border border-transparent bg-[#02665e] text-white text-sm font-semibold shadow-sm transition-all duration-300 hover:bg-[#024d47] active:scale-[0.99] ${newsletterLoading ? \"opacity-70 cursor-wait\" : \"\"}`}\n                        disabled={newsletterLoading}\n                      >\n                        {newsletterLoading ? (\n                          <span className=\"flex items-center gap-2\">\n                            <span className=\"w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin\" />\n                            <span className=\"hidden sm:inline\">Subscribing…</span>\n                          </span>\n                        ) : (\n                          \"Subscribe\"\n                        )}\n                      </button>\n                    </form>\n                  </div>\n\n                  {newsletterStatus ? (\n                    <div\n                      className={`mt-3 text-sm px-3 py-2 rounded-xl ${newsletterStatus.ok ? \"bg-emerald-500/10 text-emerald-200 border border-emerald-400/20\" : \"bg-red-500/10 text-red-200 border border-red-400/20\"}`}\n                      role=\"status\"\n                      aria-live=\"polite\"\n                    >\n                      {newsletterStatus.message}\n                    </div>\n                  ) : null}\n                </div>\n              </div>\n            </div>\n\n            <div className=\"mt-8 grid grid-cols-2 lg:grid-cols-3 gap-8\">\n              <div className=\"space-y-3\">\n                <h3 className=\"text-base font-semibold text-white\">About NoLSAF</h3>\n                <ul className=\"m-0 list-none p-0 space-y-1\">\n                  {[\n                    { href: \"/about/who\", label: \"Who are we\" },\n                    { href: \"/about/what\", label: \"What we do\" },\n                    { href: \"/about/why\", label: \"Why us\" },\n                    { href: \"/about/story\", label: \"Our Best Story\" },\n                  ].map((item) => (\n                    <li key={item.href}>\n                      <FooterPolicyItem href={item.href}>{item.label}</FooterPolicyItem>\n                    </li>\n                  ))}\n                </ul>\n              </div>\n\n              <div className=\"space-y-3\">\n                <h3 className=\"text-base font-semibold text-white\">Resources</h3>\n                <ul className=\"m-0 list-none p-0 space-y-1\">\n                  {[\n                    { href: \"/help\", label: \"Help Center\" },\n                    { href: \"/careers\", label: \"Careers\" },\n                  ].map((item) => (\n                    <li key={item.href}>\n                      <FooterPolicyItem href={item.href}>{item.label}</FooterPolicyItem>\n                    </li>\n                  ))}\n                  <li>\n                    <span className=\"inline-flex items-center px-2.5 py-1.5 text-sm font-semibold text-slate-200\">\n                      Version: <span className=\"ml-1 text-slate-400\">{APP_VERSION}</span>\n                    </span>\n                  </li>\n                </ul>\n              </div>\n\n              <div className=\"col-span-2 lg:col-span-1 space-y-3\">\n                <h3 className=\"text-base font-semibold text-white\">Portals</h3>\n                <ul className=\"m-0 list-none p-0 grid grid-cols-2 gap-x-6 gap-y-1\">\n                  {[\n                    { href: \"/account/register?mode=register&role=owner&next=%2Fowner\", label: \"Owner Portal\" },\n                    { href: \"/account/register?mode=register&role=driver&next=%2Fdriver\", label: \"Driver Portal\" },\n                  ].map((item) => (\n                    <li key={item.href}>\n                      <FooterPolicyItem href={item.href}>{item.label}</FooterPolicyItem>\n                    </li>\n                  ))}\n                </ul>\n              </div>\n            </div>\n\n            <div className=\"mt-8\">\n              <div className=\"h-px w-full bg-gradient-to-r from-transparent via-white/15 to-transparent\" />\n              <nav aria-label=\"Footer legal navigation\" className=\"mt-4\">\n                <ul className=\"m-0 flex list-none flex-wrap items-center justify-center gap-2.5 p-0\">\n                  {[\n                    { href: \"/terms\", label: \"Terms\" },\n                    { href: \"/privacy\", label: \"Privacy\" },\n                    { href: \"/cookies-policy\", label: \"Cookies\" },\n                    { href: \"/verification-policy\", label: \"Verification\" },\n                    { href: \"/cancellation-policy\", label: \"Cancellation\" },\n                  ].map((item, index) => (\n                    <li\n                      key={item.href}\n                      className={\n                        index === 0\n                          ? \"\"\n                          : \"lg:relative lg:pl-4 lg:before:content-[''] lg:before:absolute lg:before:left-1 lg:before:top-1/2 lg:before:-translate-y-1/2 lg:before:h-4 lg:before:w-px lg:before:bg-white/15\"\n                      }\n                    >\n                      <FooterPolicyItem href={item.href}>{item.label}</FooterPolicyItem>\n                    </li>\n                  ))}\n                </ul>\n              </nav>\n            </div>\n\n            <div className=\"mt-8\">\n              <div className=\"h-px w-full bg-gradient-to-r from-transparent via-white/15 to-transparent\" />\n              <div className=\"mt-5 flex flex-col items-center gap-2\">\n                <div className=\"text-xs sm:text-sm text-slate-300 text-center\">\n                  <span className=\"font-semibold text-slate-200\">© {year} </span>\n                  <span className=\"font-extrabold text-emerald-200 tracking-wide\">NoLSAF</span>\n                  <span className=\"text-slate-400\"> — All rights reserved</span>\n                </div>\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n    </footer>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\PublicHeader.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\PublicSearch.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\PublicSearchPanel.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\QRCode.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\RefreshButton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\ReplyIcon.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\ReportsFilter.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\RevenueFilter.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\SearchFilters.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\SectionSeparator.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\ServicesAndFacilities.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\SiteFooter.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\SiteHeader.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\Spinner.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\StatCard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\Support.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\TableRow.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\Terms.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\Testimonials.tsx","messages":[],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'start' and 'stop'. Either include them or remove the dependency array.","line":173,"column":6,"nodeType":"ArrayExpression","endLine":173,"endColumn":13,"suggestions":[{"desc":"Update the dependencies array to be: [start, stop, total]","fix":{"range":[5977,5984],"text":"[start, stop, total]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\ThemeToggle.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\Toast.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\ToastContainer.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\TransportChat.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'socket' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":42,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":42,"endColumn":16}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport React, { useEffect, useState, useRef } from \"react\";\r\nimport { io, Socket } from \"socket.io-client\";\r\nimport { Send, Phone, MessageCircle } from \"lucide-react\";\r\nimport axios from \"axios\";\r\nimport LogoSpinner from \"@/components/LogoSpinner\";\r\n\r\ninterface Message {\r\n  id: number;\r\n  message: string;\r\n  senderType: \"DRIVER\" | \"PASSENGER\" | \"ADMIN\";\r\n  senderId: number;\r\n  messageType: \"TEXT\" | \"IMAGE\" | \"LOCATION\" | \"SYSTEM\";\r\n  readAt: string | null;\r\n  createdAt: string;\r\n}\r\n\r\ninterface TransportChatProps {\r\n  bookingId: number;\r\n  currentUserId: number;\r\n  currentUserType: \"DRIVER\" | \"PASSENGER\" | \"ADMIN\";\r\n  otherUserName?: string;\r\n  otherUserPhone?: string;\r\n  className?: string;\r\n}\r\n\r\nconst api = axios.create({ baseURL: \"\", withCredentials: true });\r\n\r\nexport default function TransportChat({\r\n  bookingId,\r\n  currentUserId,\r\n  currentUserType,\r\n  otherUserName,\r\n  otherUserPhone,\r\n  className = \"\",\r\n}: TransportChatProps) {\r\n  const [messages, setMessages] = useState<Message[]>([]);\r\n  const [newMessage, setNewMessage] = useState(\"\");\r\n  const [loading, setLoading] = useState(true);\r\n  const [sending, setSending] = useState(false);\r\n  const [socket, setSocket] = useState<Socket | null>(null);\r\n  const messagesEndRef = useRef<HTMLDivElement>(null);\r\n  const messagesContainerRef = useRef<HTMLDivElement>(null);\r\n\r\n  // Scroll to bottom when messages change\r\n  useEffect(() => {\r\n    if (messagesEndRef.current) {\r\n      messagesEndRef.current.scrollIntoView({ behavior: \"smooth\" });\r\n    }\r\n  }, [messages]);\r\n\r\n  // Fetch messages on mount\r\n  useEffect(() => {\r\n    const fetchMessages = async () => {\r\n      try {\r\n        const response = await api.get(`/api/transport-bookings/${bookingId}/messages`);\r\n        setMessages(response.data.items || []);\r\n        \r\n        // Mark all as read\r\n        try {\r\n          await api.post(`/api/transport-bookings/${bookingId}/messages/read-all`);\r\n        } catch (e) {\r\n          // Ignore read-all errors\r\n        }\r\n      } catch (error) {\r\n        console.error(\"Failed to fetch messages:\", error);\r\n      } finally {\r\n        setLoading(false);\r\n      }\r\n    };\r\n\r\n    fetchMessages();\r\n  }, [bookingId]);\r\n\r\n  // Setup Socket.IO connection\r\n  useEffect(() => {\r\n    const apiUrl = process.env.NEXT_PUBLIC_API_URL || \"http://localhost:4000\";\r\n    const newSocket = io(apiUrl, {\r\n      transports: [\"websocket\"],\r\n      withCredentials: true,\r\n    });\r\n\r\n    newSocket.on(\"connect\", () => {\r\n      console.log(\"Socket connected for transport chat\");\r\n      // Join user room for receiving messages\r\n      if (currentUserType === \"DRIVER\") {\r\n        newSocket.emit(\"join-driver-room\", { driverId: currentUserId });\r\n      } else {\r\n        newSocket.emit(\"join-user-room\", { userId: currentUserId });\r\n      }\r\n    });\r\n\r\n    // Listen for new messages\r\n    newSocket.on(\"transport:message:new\", (data: { bookingId: number; message: Message }) => {\r\n      if (data.bookingId === bookingId) {\r\n        setMessages((prev) => {\r\n          // Check if message already exists\r\n          const exists = prev.some((m) => m.id === data.message.id);\r\n          if (exists) return prev;\r\n          return [...prev, data.message];\r\n        });\r\n        \r\n        // Mark as read if not sent by current user\r\n        if (data.message.senderId !== currentUserId) {\r\n          api.post(`/api/transport-bookings/${bookingId}/messages/${data.message.id}/read`).catch(() => {});\r\n        }\r\n      }\r\n    });\r\n\r\n    setSocket(newSocket);\r\n\r\n    return () => {\r\n      newSocket.disconnect();\r\n    };\r\n  }, [bookingId, currentUserId, currentUserType]);\r\n\r\n  const handleSend = async (e: React.FormEvent) => {\r\n    e.preventDefault();\r\n    if (!newMessage.trim() || sending) return;\r\n\r\n    const messageText = newMessage.trim();\r\n    setNewMessage(\"\");\r\n    setSending(true);\r\n\r\n    try {\r\n      const response = await api.post(`/api/transport-bookings/${bookingId}/messages`, {\r\n        message: messageText,\r\n        messageType: \"TEXT\",\r\n      });\r\n\r\n      // Add message optimistically\r\n      setMessages((prev) => [...prev, response.data]);\r\n    } catch (error: any) {\r\n      console.error(\"Failed to send message:\", error);\r\n      // Restore message on error\r\n      setNewMessage(messageText);\r\n      alert(\"Failed to send message. Please try again.\");\r\n    } finally {\r\n      setSending(false);\r\n    }\r\n  };\r\n\r\n  const handleCall = () => {\r\n    if (otherUserPhone) {\r\n      window.location.href = `tel:${otherUserPhone}`;\r\n    }\r\n  };\r\n\r\n  const formatTime = (dateString: string) => {\r\n    const date = new Date(dateString);\r\n    const now = new Date();\r\n    const diffMs = now.getTime() - date.getTime();\r\n    const diffMins = Math.floor(diffMs / 60000);\r\n\r\n    if (diffMins < 1) return \"Just now\";\r\n    if (diffMins < 60) return `${diffMins}m ago`;\r\n    if (diffMins < 1440) return `${Math.floor(diffMins / 60)}h ago`;\r\n    return date.toLocaleDateString(\"en-GB\", { day: \"2-digit\", month: \"short\", hour: \"2-digit\", minute: \"2-digit\" });\r\n  };\r\n\r\n  const isMyMessage = (message: Message) => {\r\n    return message.senderId === currentUserId;\r\n  };\r\n\r\n  if (loading) {\r\n    return (\r\n      <div className={`flex items-center justify-center p-8 ${className}`}>\r\n        <LogoSpinner size=\"sm\" ariaLabel=\"Loading messages\" />\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className={`flex flex-col h-full bg-white rounded-xl border border-slate-200 shadow-sm ${className}`}>\r\n      {/* Header */}\r\n      <div className=\"flex items-center justify-between p-4 border-b border-slate-200 bg-gradient-to-r from-slate-50 to-blue-50/50\">\r\n        <div className=\"flex items-center gap-3\">\r\n          <div className=\"w-10 h-10 rounded-full bg-[#02665e] flex items-center justify-center\">\r\n            <MessageCircle className=\"w-5 h-5 text-white\" />\r\n          </div>\r\n          <div>\r\n            <h3 className=\"font-semibold text-slate-900\">Chat</h3>\r\n            {otherUserName && (\r\n              <p className=\"text-xs text-slate-600\">{otherUserName}</p>\r\n            )}\r\n          </div>\r\n        </div>\r\n        {otherUserPhone && (\r\n          <button\r\n            onClick={handleCall}\r\n            className=\"p-2 rounded-lg bg-[#02665e] text-white hover:bg-[#014e47] transition-colors\"\r\n            title=\"Call\"\r\n          >\r\n            <Phone className=\"w-4 h-4\" />\r\n          </button>\r\n        )}\r\n      </div>\r\n\r\n      {/* Messages */}\r\n      <div\r\n        ref={messagesContainerRef}\r\n        className=\"flex-1 overflow-y-auto p-4 space-y-3 bg-gradient-to-b from-slate-50/50 to-white\"\r\n        style={{ maxHeight: \"400px\" }}\r\n      >\r\n        {messages.length === 0 ? (\r\n          <div className=\"text-center text-slate-500 py-8\">\r\n            <MessageCircle className=\"w-12 h-12 mx-auto mb-2 text-slate-300\" />\r\n            <p className=\"text-sm\">No messages yet. Start the conversation!</p>\r\n          </div>\r\n        ) : (\r\n          messages.map((message) => {\r\n            const isMine = isMyMessage(message);\r\n            return (\r\n              <div\r\n                key={message.id}\r\n                className={`flex ${isMine ? \"justify-end\" : \"justify-start\"}`}\r\n              >\r\n                <div\r\n                  className={`max-w-[75%] rounded-2xl px-4 py-2.5 shadow-sm ${\r\n                    isMine\r\n                      ? \"bg-gradient-to-r from-[#02665e] to-[#014e47] text-white\"\r\n                      : \"bg-white border border-slate-200 text-slate-900\"\r\n                  }`}\r\n                >\r\n                  {message.messageType === \"SYSTEM\" && (\r\n                    <p className=\"text-xs opacity-75 mb-1\">\r\n                      {message.senderType === \"ADMIN\" ? \"Admin\" : \"System\"}\r\n                    </p>\r\n                  )}\r\n                  <p className=\"text-sm whitespace-pre-wrap break-words\">{message.message}</p>\r\n                  <p\r\n                    className={`text-xs mt-1 ${\r\n                      isMine ? \"text-white/70\" : \"text-slate-500\"\r\n                    }`}\r\n                  >\r\n                    {formatTime(message.createdAt)}\r\n                  </p>\r\n                </div>\r\n              </div>\r\n            );\r\n          })\r\n        )}\r\n        <div ref={messagesEndRef} />\r\n      </div>\r\n\r\n      {/* Input */}\r\n      <form onSubmit={handleSend} className=\"p-4 border-t border-slate-200 bg-white\">\r\n        <div className=\"flex items-center gap-2\">\r\n          <input\r\n            type=\"text\"\r\n            value={newMessage}\r\n            onChange={(e) => setNewMessage(e.target.value)}\r\n            placeholder=\"Type a message...\"\r\n            className=\"flex-1 px-4 py-2.5 rounded-xl border border-slate-300 focus:outline-none focus:ring-2 focus:ring-[#02665e]/20 focus:border-[#02665e] text-sm\"\r\n            disabled={sending}\r\n          />\r\n          <button\r\n            type=\"submit\"\r\n            disabled={!newMessage.trim() || sending}\r\n            className=\"p-2.5 rounded-xl bg-[#02665e] text-white hover:bg-[#014e47] disabled:opacity-50 disabled:cursor-not-allowed transition-colors\"\r\n          >\r\n            {sending ? (\r\n              <LogoSpinner size=\"sm\" ariaLabel=\"Sending message\" />\r\n            ) : (\r\n              <Send className=\"w-5 h-5\" />\r\n            )}\r\n          </button>\r\n        </div>\r\n      </form>\r\n    </div>\r\n  );\r\n}\r\n\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\TripReviewModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\TripSteps.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\Trusted.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\TrustedBy.tsx","messages":[],"suppressedMessages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":73,"column":7,"nodeType":"JSXOpeningElement","endLine":87,"endColumn":9,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\TrustedBySection.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\UserMenu.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'UserCircle' is defined but never used. Allowed unused vars must match /^_/u.","line":11,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":11,"endColumn":13,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"UserCircle"},"fix":{"range":[201,217],"text":""},"desc":"Remove unused variable \"UserCircle\"."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useEffect, useRef, useState } from \"react\";\r\nimport Link from \"next/link\";\r\nimport { usePathname } from \"next/navigation\";\r\nimport { \r\n  User, \r\n  Calendar, \r\n  Car, \r\n  Users, \r\n  UserCircle, \r\n  Settings, \r\n  LogOut,\r\n  ChevronRight,\r\n  ClipboardList\r\n} from 'lucide-react';\r\n\r\nexport default function UserMenu({ variant = \"dark\" }: { variant?: \"light\" | \"dark\" }) {\r\n  const [open, setOpen] = useState(false);\r\n  const ref = useRef<HTMLDivElement | null>(null);\r\n  const pathname = usePathname();\r\n\r\n  const logoutRedirect = \"/account/login\";\r\n\r\n  useEffect(() => {\r\n    const onDoc = (e: MouseEvent) => {\r\n      if (!ref.current) return;\r\n      if (!ref.current.contains(e.target as Node)) setOpen(false);\r\n    };\r\n    if (open) {\r\n      document.addEventListener('click', onDoc);\r\n      return () => document.removeEventListener('click', onDoc);\r\n    }\r\n  }, [open]);\r\n\r\n  // Inject animation keyframes\r\n  useEffect(() => {\r\n    if (typeof document === 'undefined') return;\r\n    const styleId = 'user-menu-animations';\r\n    if (document.getElementById(styleId)) return;\r\n    \r\n    const style = document.createElement('style');\r\n    style.id = styleId;\r\n    style.textContent = `\r\n      @keyframes fadeInUp {\r\n        from {\r\n          opacity: 0;\r\n          transform: translateY(-8px) scale(0.96);\r\n        }\r\n        to {\r\n          opacity: 1;\r\n          transform: translateY(0) scale(1);\r\n        }\r\n      }\r\n    `;\r\n    document.head.appendChild(style);\r\n    return () => {\r\n      const existing = document.getElementById(styleId);\r\n      if (existing) existing.remove();\r\n    };\r\n  }, []);\r\n\r\n  const menuItems = [\r\n    { href: \"/account\", label: \"My account\", icon: User },\r\n    { href: \"/account/bookings\", label: \"My Bookings\", icon: Calendar },\r\n    { href: \"/account/rides\", label: \"My Rides\", icon: Car },\r\n    { href: \"/account/group-stays\", label: \"My Group Stay\", icon: Users },\r\n    { href: \"/account/event-plans\", label: \"My Event Plan\", icon: ClipboardList },\r\n  ];\r\n\r\n  const settingsItems = [\r\n    { href: \"/account/security\", label: \"Settings\", icon: Settings },\r\n  ];\r\n\r\n  const isActive = (href: string) => pathname === href || pathname?.startsWith(href + \"/\");\r\n\r\n  const buttonClass = variant === \"light\"\r\n    ? \"bg-[#02665e]/10 hover:bg-[#02665e]/15 text-[#02665e] border-[#02665e]/20\"\r\n    : \"bg-white/10 hover:bg-white/20 text-white border-white/20\";\r\n\r\n  const menuBgClass = variant === \"light\"\r\n    ? \"bg-white/95 backdrop-blur-xl border-[#02665e]/10\"\r\n    : \"bg-white/95 backdrop-blur-xl border-gray-200/50\";\r\n\r\n  const textClass = variant === \"light\"\r\n    ? \"text-gray-800\"\r\n    : \"text-gray-800\";\r\n\r\n  const hoverBgClass = variant === \"light\"\r\n    ? \"hover:bg-[#02665e]/8\"\r\n    : \"hover:bg-[#02665e]/8\";\r\n\r\n  const activeBgClass = variant === \"light\"\r\n    ? \"bg-[#02665e]/12\"\r\n    : \"bg-[#02665e]/12\";\r\n\r\n  return (\r\n    <div ref={ref} className=\"relative\">\r\n      <button\r\n        aria-haspopup=\"true\"\r\n        aria-expanded={open}\r\n        onClick={() => setOpen(v => !v)}\r\n        className={`inline-flex items-center justify-center h-9 w-9 rounded-full transition-all duration-300 hover:scale-110 active:scale-95 border ${buttonClass}`}\r\n        title=\"User menu\"\r\n        style={{\r\n          boxShadow: variant === \"light\" \r\n            ? \"0 2px 8px rgba(2, 102, 94, 0.12)\" \r\n            : \"0 2px 8px rgba(0, 0, 0, 0.15)\",\r\n        }}\r\n      >\r\n        <User className=\"h-5 w-5 transition-transform duration-300\" aria-hidden />\r\n      </button>\r\n\r\n      {open && (\r\n        <div \r\n          className={`absolute right-0 mt-3 w-56 max-w-none ${menuBgClass} rounded-2xl shadow-2xl ring-1 overflow-hidden z-50`}\r\n          style={{\r\n            animation: \"fadeInUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards\",\r\n            boxShadow: \"0 20px 40px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(0, 0, 0, 0.05)\",\r\n            maxWidth: \"none\",\r\n          }}\r\n        >\r\n          <div className=\"py-2\">\r\n            {/* Main Menu Items */}\r\n            {menuItems.map((item, idx) => {\r\n              const Icon = item.icon;\r\n              const active = isActive(item.href);\r\n              return (\r\n                <Link\r\n                  key={item.href}\r\n                  href={item.href}\r\n                  onClick={() => setOpen(false)}\r\n                  className={`group relative flex items-center gap-3 px-4 py-2.5 text-sm font-medium ${textClass} ${hoverBgClass} transition-all duration-200 active:scale-[0.98] no-underline ${\r\n                    active ? activeBgClass : \"\"\r\n                  }`}\r\n                  style={{\r\n                    animationDelay: `${idx * 30}ms`,\r\n                  }}\r\n                >\r\n                  <Icon \r\n                    className={`h-4 w-4 transition-all duration-200 ${\r\n                      active ? \"text-[#02665e]\" : \"text-gray-500 group-hover:text-[#02665e]\"\r\n                    }`}\r\n                    strokeWidth={active ? 2.5 : 2}\r\n                  />\r\n                  <span className=\"flex-1\">{item.label}</span>\r\n                  {active && (\r\n                    <div className=\"absolute right-3 w-1.5 h-1.5 rounded-full bg-[#02665e] animate-pulse\" />\r\n                  )}\r\n                  <ChevronRight \r\n                    className=\"h-3.5 w-3.5 text-gray-400 group-hover:text-[#02665e] transition-all duration-200 opacity-0 group-hover:opacity-100 transform translate-x-[-4px] group-hover:translate-x-0\" \r\n                  />\r\n                </Link>\r\n              );\r\n            })}\r\n\r\n            {/* Divider */}\r\n            <div className=\"my-1.5 mx-4 h-px bg-gradient-to-r from-transparent via-gray-200 to-transparent\" />\r\n\r\n            {/* Settings Items */}\r\n            {settingsItems.map((item, idx) => {\r\n              const Icon = item.icon;\r\n              const active = isActive(item.href);\r\n              return (\r\n                <Link\r\n                  key={item.href}\r\n                  href={item.href}\r\n                  onClick={() => setOpen(false)}\r\n                  className={`group relative flex items-center gap-3 px-4 py-2.5 text-sm font-medium ${textClass} ${hoverBgClass} transition-all duration-200 active:scale-[0.98] no-underline ${\r\n                    active ? activeBgClass : \"\"\r\n                  }`}\r\n                  style={{\r\n                    animationDelay: `${(menuItems.length + idx) * 30}ms`,\r\n                  }}\r\n                >\r\n                  <Icon \r\n                    className={`h-4 w-4 transition-all duration-200 ${\r\n                      active ? \"text-[#02665e]\" : \"text-gray-500 group-hover:text-[#02665e]\"\r\n                    }`}\r\n                    strokeWidth={active ? 2.5 : 2}\r\n                  />\r\n                  <span className=\"flex-1\">{item.label}</span>\r\n                  {active && (\r\n                    <div className=\"absolute right-3 w-1.5 h-1.5 rounded-full bg-[#02665e] animate-pulse\" />\r\n                  )}\r\n                  <ChevronRight \r\n                    className=\"h-3.5 w-3.5 text-gray-400 group-hover:text-[#02665e] transition-all duration-200 opacity-0 group-hover:opacity-100 transform translate-x-[-4px] group-hover:translate-x-0\" \r\n                  />\r\n                </Link>\r\n              );\r\n            })}\r\n\r\n            {/* Divider */}\r\n            <div className=\"my-1.5 mx-4 h-px bg-gradient-to-r from-transparent via-gray-200 to-transparent\" />\r\n\r\n            {/* Sign Out */}\r\n            <button\r\n              onClick={async (e) => {\r\n                e.preventDefault();\r\n                setOpen(false);\r\n                try {\r\n                  await fetch(\"/api/auth/logout\", { method: \"POST\", credentials: \"include\" });\r\n                } catch {}\r\n                window.location.href = logoutRedirect;\r\n              }}\r\n              className={`group relative flex items-center gap-3 w-full px-4 py-2.5 text-sm font-semibold text-rose-600 hover:text-rose-700 hover:bg-rose-50 transition-all duration-200 active:scale-[0.98] border-0 bg-transparent cursor-pointer`}\r\n              style={{\r\n                animationDelay: `${(menuItems.length + settingsItems.length) * 30}ms`,\r\n              }}\r\n            >\r\n              <LogOut \r\n                className=\"h-4 w-4 transition-all duration-200 text-rose-500 group-hover:text-rose-600 group-hover:rotate-[-5deg]\" \r\n                strokeWidth={2.5}\r\n              />\r\n              <span className=\"flex-1 text-left\">Sign out</span>\r\n              <ChevronRight \r\n                className=\"h-3.5 w-3.5 text-rose-400 transition-all duration-200 opacity-0 group-hover:opacity-100 transform translate-x-[-4px] group-hover:translate-x-0\" \r\n              />\r\n            </button>\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\VerifiedIcon.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\VoiceRecorder.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\admin\\CancellationTableRow.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\cancellationPolicyContent.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\cookiesContent.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\disbursementPolicyContent.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\driverDisbursementPolicyContent.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\no4p-ai\\No4PAIDemoCard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\privacyContent.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Link' is defined but never used. Allowed unused vars must match /^_/u.","line":3,"column":8,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":12,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"Link"},"fix":{"range":[17,60],"text":""},"desc":"Remove unused import declaration."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport Link from \"@/components/PolicyLink\";\r\nimport { TermsSection } from \"./Terms\";\r\n\r\nexport const PRIVACY_LAST_UPDATED = \"2025-12-20\";\r\n\r\nexport const PRIVACY_SECTIONS: TermsSection[] = [\r\n  {\r\n    title: \"Overview\",\r\n    content: (\r\n      <div className=\"space-y-4\">\r\n        <div className=\"bg-blue-50 border-l-4 border-blue-500 p-4 mb-6 rounded\">\r\n          <h3 className=\"text-lg font-semibold text-gray-900 mb-2\">Summary</h3>\r\n          <p className=\"text-sm text-gray-700 leading-relaxed\">\r\n            NoLSAF is committed to protecting your privacy and personal information. This Privacy Policy explains how we collect, use, store, and protect your data when you use our platform to book accommodations, list properties, or provide transportation services. We collect information necessary to provide our services, including account details, booking information, payment data, and location information. We use this data to facilitate bookings, process payments, verify identities, improve our services, and communicate with you. We implement strong security measures to protect your information and only share data with trusted service providers and as required by law. You have rights to access, update, or delete your personal information at any time. By using NoLSAF, you consent to the practices described in this policy.\r\n          </p>\r\n        </div>\r\n\r\n        <p>\r\n          <strong>1.0 Introduction</strong><br />\r\n          NoLSAF (\"we,\" \"us,\" or \"our\") respects your privacy and is committed to protecting your personal information. This Privacy Policy describes how we collect, use, disclose, store, and protect your personal data when you access or use our platform, website, mobile applications, and related services (collectively, the \"Services\"). This policy applies to all Users, property Owners, Drivers, and visitors to our platform.\r\n        </p>\r\n\r\n        <p>\r\n          <strong>1.1 Scope</strong><br />\r\n          This Privacy Policy applies to all personal information collected by NoLSAF through our Services, including but not limited to information provided during account registration, property listings, booking transactions, payment processing, customer support interactions, and use of our website and mobile applications.\r\n        </p>\r\n\r\n        <p>\r\n          <strong>1.2 Consent</strong><br />\r\n          By accessing or using our Services, you acknowledge that you have read, understood, and agree to be bound by this Privacy Policy. If you do not agree with any part of this policy, please do not use our Services. Your continued use of our Services after any changes to this policy constitutes your acceptance of those changes.\r\n        </p>\r\n\r\n        <p>\r\n          <strong>2.0 Information We Collect</strong><br />\r\n          We collect various types of information to provide, maintain, and improve our Services. The information we collect depends on how you interact with our platform and the role you assume (User, Owner, or Driver).\r\n        </p>\r\n\r\n        <p>\r\n          <strong>2.1 Information You Provide Directly</strong><br />\r\n          We collect information that you voluntarily provide when using our Services, including;<br />\r\n          <strong>2.1.1 Account Registration Information</strong><br />\r\n          When you create an account, we collect;<br />\r\n          a. Full name<br />\r\n          b. Email address<br />\r\n          c. Phone number (including country code)<br />\r\n          d. Password (stored securely using encryption)<br />\r\n          e. Role selection (User/Traveller, Owner, or Driver)<br />\r\n          f. Profile photo or avatar (optional)<br />\r\n          <em>Example: When you register as a property owner, we collect your name, email, and phone number to create your account and enable you to list properties and manage bookings.</em>\r\n        </p>\r\n\r\n        <p>\r\n          <strong>2.1.2 Property Owner Information</strong><br />\r\n          If you are a property Owner, we collect additional information including;<br />\r\n          a. Property details (address, description, amenities, photos)<br />\r\n          b. Property ownership documents (title deeds, rental agreements, business licenses)<br />\r\n          c. Operating permits and licenses for short-term rentals<br />\r\n          d. Tax compliance documentation<br />\r\n          e. Bank account details for payouts (account name, bank name, account number, branch)<br />\r\n          f. Mobile money provider and number for payouts (M-Pesa, Tigo Pesa, Airtel Money, etc.)<br />\r\n          g. Payout preferences<br />\r\n          <em>Example: To process your earnings from bookings, we need your bank account or mobile money details. This information is encrypted and only used for payment processing.</em>\r\n        </p>\r\n\r\n        <p>\r\n          <strong>2.1.3 Driver Information</strong><br />\r\n          If you are a Driver, we collect additional information including;<br />\r\n          a. Vehicle information (make, model, license plate number)<br />\r\n          b. Driver's license number and expiration date<br />\r\n          c. Vehicle registration documents<br />\r\n          d. Insurance information<br />\r\n          e. Bank account or mobile money details for earnings<br />\r\n          f. Location data (when providing transportation services)<br />\r\n          <em>Example: We collect your vehicle and license information to verify your eligibility to provide transportation services and ensure passenger safety.</em>\r\n        </p>\r\n\r\n        <p>\r\n          <strong>2.1.4 Booking Information</strong><br />\r\n          When you make a booking, we collect;<br />\r\n          a. Check-in and check-out dates<br />\r\n          b. Number of guests<br />\r\n          c. Special requests or preferences<br />\r\n          d. Payment information (processed securely through third-party payment processors)<br />\r\n          e. Communication preferences<br />\r\n          <em>Example: We store your booking dates and guest count to facilitate your stay and ensure the property can accommodate your needs.</em>\r\n        </p>\r\n\r\n        <p>\r\n          <strong>2.1.5 Communication Data</strong><br />\r\n          We collect information from your communications with us, including;<br />\r\n          a. Customer support inquiries and responses<br />\r\n          b. Feedback and reviews you submit<br />\r\n          c. Messages sent through our platform<br />\r\n          d. Newsletter subscription preferences<br />\r\n          <em>Example: If you contact our support team about a booking issue, we keep a record of that conversation to help resolve your concern and improve our services.</em>\r\n        </p>\r\n\r\n        <p>\r\n          <strong>2.2 Information Collected Automatically</strong><br />\r\n          When you use our Services, we automatically collect certain information about your device and usage patterns;<br />\r\n          <strong>2.2.1 Device Information</strong><br />\r\n          We collect information about the device you use to access our Services, including;<br />\r\n          a. Device type (mobile, tablet, computer)<br />\r\n          b. Operating system and version<br />\r\n          c. Browser type and version<br />\r\n          d. IP address<br />\r\n          e. Unique device identifiers<br />\r\n          <strong>2.2.2 Usage Information</strong><br />\r\n          We collect information about how you interact with our Services, including;<br />\r\n          a. Pages visited and time spent on pages<br />\r\n          b. Search queries and filters used<br />\r\n          c. Features accessed<br />\r\n          d. Click patterns and navigation paths<br />\r\n          e. Date and time of access<br />\r\n          <strong>2.2.3 Location Information</strong><br />\r\n          With your permission, we may collect location data, including;<br />\r\n          a. GPS coordinates (for Drivers providing transportation services)<br />\r\n          b. Approximate location based on IP address<br />\r\n          c. Location preferences for property searches<br />\r\n          <em>Example: If you're a driver using our app, we collect your real-time location to match you with nearby ride requests and help passengers track their rides.</em>\r\n        </p>\r\n\r\n        <p>\r\n          <strong>2.3 Cookies and Similar Technologies</strong><br />\r\n          We use cookies, local storage, and similar technologies to enhance your experience and collect information;<br />\r\n          <strong>2.3.1 Essential Cookies</strong><br />\r\n          These cookies are necessary for the platform to function, including;<br />\r\n          a. Authentication tokens (stored securely)<br />\r\n          b. Session management<br />\r\n          c. User preferences (theme, language)<br />\r\n          d. Shopping cart and booking information<br />\r\n          <strong>2.3.2 Analytics Cookies</strong><br />\r\n          We use analytics to understand how our Services are used and improve them;<br />\r\n          a. Page views and user interactions<br />\r\n          b. Performance metrics<br />\r\n          c. Error tracking<br />\r\n          <strong>2.3.3 Local Storage</strong><br />\r\n          We use browser local storage to;<br />\r\n          a. Remember your login status<br />\r\n          b. Store user preferences (accepted policies, widget settings)<br />\r\n          c. Cache data for faster loading<br />\r\n          <em>Example: We store your authentication token in a secure cookie so you don't have to log in every time you visit our platform. You can clear your cookies at any time through your browser settings.</em>\r\n        </p>\r\n\r\n        <p>\r\n          <strong>2.4 Information from Third Parties</strong><br />\r\n          We may receive information about you from third-party sources, including;<br />\r\n          a. Payment processors (Stripe, AzamPay, M-Pesa, etc.) - transaction status and payment method details<br />\r\n          b. Social media platforms (if you choose to register or log in using social media)<br />\r\n          c. Property verification services<br />\r\n          d. Background check providers (for Drivers)<br />\r\n          e. Government databases (for verification purposes)<br />\r\n          <em>Example: When you pay for a booking using M-Pesa, the payment processor sends us confirmation that your payment was successful, along with the transaction reference number.</em>\r\n        </p>\r\n\r\n        <p>\r\n          <strong>3.0 How We Use Your Information</strong><br />\r\n          We use the information we collect for various purposes to provide, maintain, and improve our Services;\r\n        </p>\r\n\r\n        <p>\r\n          <strong>3.1 Service Provision</strong><br />\r\n          We use your information to;<br />\r\n          a. Create and manage your account<br />\r\n          b. Process and facilitate bookings<br />\r\n          c. Verify your identity and eligibility (for Owners and Drivers)<br />\r\n          d. Process payments and payouts<br />\r\n          e. Communicate with you about bookings, services, and account matters<br />\r\n          f. Provide customer support<br />\r\n          g. Send booking confirmations, receipts, and updates<br />\r\n          <em>Example: When you book a property, we use your email and phone number to send you booking confirmation, check-in instructions, and important updates about your stay.</em>\r\n        </p>\r\n\r\n        <p>\r\n          <strong>3.2 Platform Operations</strong><br />\r\n          We use your information to;<br />\r\n          a. Verify property listings and ensure accuracy<br />\r\n          b. Match Drivers with transportation requests<br />\r\n          c. Facilitate communication between Users, Owners, and Drivers<br />\r\n          d. Process reviews and ratings<br />\r\n          e. Manage disputes and resolve issues<br />\r\n          f. Enforce our Terms of Service and policies<br />\r\n          <em>Example: We use property verification information to ensure that only legitimate, safe properties are listed on our platform, protecting both travelers and property owners.</em>\r\n        </p>\r\n\r\n        <p>\r\n          <strong>3.3 Payment Processing</strong><br />\r\n          We use payment information to;<br />\r\n          a. Process booking payments from Users<br />\r\n          b. Distribute payouts to Owners and Drivers<br />\r\n          c. Handle refunds and cancellations<br />\r\n          d. Prevent fraud and unauthorized transactions<br />\r\n          e. Comply with financial regulations<br />\r\n          <em>Example: When you pay for a booking, we securely transmit your payment details to our payment processor (like AzamPay or Stripe) to complete the transaction. We don't store your full credit card number.</em>\r\n        </p>\r\n\r\n        <p>\r\n          <strong>3.4 Communication and Marketing</strong><br />\r\n          With your consent, we may use your information to;<br />\r\n          a. Send newsletters and promotional materials<br />\r\n          b. Notify you about special offers and new features<br />\r\n          c. Request feedback and reviews<br />\r\n          d. Send important service updates and policy changes<br />\r\n          <em>Example: If you subscribe to our newsletter, we'll send you updates about new properties, travel tips, and special deals. You can unsubscribe at any time.</em>\r\n        </p>\r\n\r\n        <p>\r\n          <strong>3.5 Safety and Security</strong><br />\r\n          We use your information to;<br />\r\n          a. Verify identities and prevent fraud<br />\r\n          b. Detect and prevent unauthorized access<br />\r\n          c. Investigate suspicious activities<br />\r\n          d. Ensure compliance with laws and regulations<br />\r\n          e. Protect the safety of Users, Owners, and Drivers<br />\r\n          <em>Example: If we detect unusual activity on your account (like multiple failed login attempts), we may temporarily lock your account and notify you to prevent unauthorized access.</em>\r\n        </p>\r\n\r\n        <p>\r\n          <strong>3.6 Analytics and Improvement</strong><br />\r\n          We use aggregated and anonymized data to;<br />\r\n          a. Analyze usage patterns and trends<br />\r\n          b. Improve our Services and user experience<br />\r\n          c. Develop new features and functionality<br />\r\n          d. Conduct research and statistical analysis<br />\r\n          <em>Example: We analyze which property features are most searched for to help us improve our search functionality and help property owners understand what travelers are looking for.</em>\r\n        </p>\r\n\r\n        <p>\r\n          <strong>4.0 Information Sharing and Disclosure</strong><br />\r\n          We do not sell your personal information. We may share your information only in the following circumstances;\r\n        </p>\r\n\r\n        <p>\r\n          <strong>4.1 Service Providers</strong><br />\r\n          We share information with trusted third-party service providers who assist us in operating our platform, including;<br />\r\n          a. Payment processors (Stripe, AzamPay, M-Pesa, Tigo Pesa, Airtel Money, HaloPesa) - to process payments<br />\r\n          b. Cloud hosting providers - to store and manage data<br />\r\n          c. Email service providers - to send communications<br />\r\n          d. SMS service providers - to send text messages and OTP codes<br />\r\n          e. Analytics providers - to analyze usage patterns<br />\r\n          f. Customer support platforms - to manage support requests<br />\r\n          <em>Example: When you make a payment, we share necessary transaction details with AzamPay or your chosen payment provider to process the payment securely. These providers are contractually obligated to protect your information.</em>\r\n        </p>\r\n\r\n        <p>\r\n          <strong>4.2 Business Partners</strong><br />\r\n          We may share limited information with business partners, including;<br />\r\n          a. Property Owners - booking details, guest information, and communication history<br />\r\n          b. Drivers - ride request details, passenger information, and location data<br />\r\n          c. Verified service providers - to facilitate bookings and services<br />\r\n          <em>Example: When you book a property, we share your name, contact information, and booking details with the property owner so they can prepare for your arrival and communicate with you.</em>\r\n        </p>\r\n\r\n        <p>\r\n          <strong>4.3 Legal Requirements</strong><br />\r\n          We may disclose your information if required by law or in response to;<br />\r\n          a. Court orders, subpoenas, or legal processes<br />\r\n          b. Government requests or regulatory inquiries<br />\r\n          c. Law enforcement investigations<br />\r\n          d. Protection of rights, property, or safety<br />\r\n          e. Prevention of fraud or illegal activities<br />\r\n          <em>Example: If law enforcement requests information about a user as part of a criminal investigation, we may be legally required to provide that information.</em>\r\n        </p>\r\n\r\n        <p>\r\n          <strong>4.4 Business Transfers</strong><br />\r\n          In the event of a merger, acquisition, or sale of assets, your information may be transferred to the new entity. We will notify you of any such change and ensure the new entity continues to protect your information in accordance with this policy.\r\n        </p>\r\n\r\n        <p>\r\n          <strong>4.5 With Your Consent</strong><br />\r\n          We may share your information with third parties when you explicitly consent to such sharing, such as when you choose to connect your account with social media platforms or participate in promotional programs with partners.\r\n        </p>\r\n\r\n        <p>\r\n          <strong>5.0 Data Security</strong><br />\r\n          We implement comprehensive security measures to protect your personal information from unauthorized access, disclosure, alteration, or destruction;\r\n        </p>\r\n\r\n        <p>\r\n          <strong>5.1 Technical Safeguards</strong><br />\r\n          We employ a comprehensive multi-layered approach to technical security, implementing industry-standard measures to protect your personal information at every stage of its lifecycle. Our technical safeguards include the following components;\r\n        </p>\r\n\r\n        <p>\r\n          <strong>5.1.1 Data Encryption</strong><br />\r\n          Encryption is fundamental to our security architecture, protecting your data both when it's being transmitted and when it's stored;<br />\r\n          a. <strong>Encryption in Transit:</strong> All data transmitted between your device and our servers is encrypted using Transport Layer Security (TLS) protocols, specifically TLS 1.2 or higher. This ensures that any information you send or receive cannot be intercepted or read by unauthorized parties during transmission. This applies to all interactions, including account login, booking submissions, payment processing, and data retrieval.<br />\r\n          b. <strong>Encryption at Rest:</strong> Sensitive personal information stored in our databases is encrypted using advanced encryption algorithms. This means that even if someone gains unauthorized access to our storage systems, they cannot read your personal data without the encryption keys, which are stored separately and managed under strict access controls.<br />\r\n          <em>Example: When you log into your account, your username and password are encrypted before being sent to our servers. Similarly, when we store your phone number or email address in our database, it's encrypted so that even our system administrators cannot view it in plain text without proper authorization.</em>\r\n        </p>\r\n\r\n        <p>\r\n          <strong>5.1.2 Password Security</strong><br />\r\n          We implement robust password protection mechanisms to ensure your account credentials remain secure;<br />\r\n          a. <strong>Hashing and Salting:</strong> Your password is never stored in plain text. Instead, we use cryptographic hashing algorithms combined with unique salt values for each password. This means that even if two users have the same password, they will have different hash values stored in our system. The hashing process is one-way, meaning your original password cannot be recovered from the stored hash.<br />\r\n          b. <strong>Password Requirements:</strong> We enforce strong password policies requiring a combination of letters, numbers, and special characters to reduce the risk of password-based attacks.<br />\r\n          c. <strong>Password Reset Security:</strong> When you request a password reset, we use secure, time-limited tokens sent to your verified email or phone number, ensuring only you can reset your password.<br />\r\n          <em>Example: If your password is \"MySecure123!\", our system converts it into a complex hash like \"a3f8b9c2d1e4f5...\" using a unique salt. Even if someone gains access to our database and sees this hash, they cannot determine your original password. This is why we cannot tell you your password if you forget it - we can only help you reset it.</em>\r\n        </p>\r\n\r\n        <p>\r\n          <strong>5.1.3 Access Controls and Authentication</strong><br />\r\n          We implement strict access controls to ensure that only authorized individuals and systems can access your personal information;<br />\r\n          a. <strong>Multi-Factor Authentication (MFA):</strong> For sensitive operations and account access, we support multi-factor authentication, requiring additional verification beyond just a password. This may include one-time passwords (OTP) sent via SMS or email, or authenticator app codes.<br />\r\n          b. <strong>Role-Based Access Control (RBAC):</strong> Our system implements role-based access controls, ensuring that employees and systems can only access information necessary for their specific functions. For example, customer support staff can view booking information but cannot access payment card details.<br />\r\n          c. <strong>Session Management:</strong> We use secure session tokens that expire after periods of inactivity. You can view and manage your active sessions through your account settings, allowing you to revoke access from any device.<br />\r\n          d. <strong>API Security:</strong> All API endpoints are protected with authentication tokens and rate limiting to prevent unauthorized access and abuse.<br />\r\n          <em>Example: When you log in, our system creates a secure session token that identifies you for subsequent requests. This token expires if you're inactive for a certain period, requiring you to log in again. You can see all your active sessions in your account settings and sign out from any device remotely.</em>\r\n        </p>\r\n\r\n        <p>\r\n          <strong>5.1.4 Network and Infrastructure Security</strong><br />\r\n          Our infrastructure is protected by multiple layers of network security;<br />\r\n          a. <strong>Firewalls:</strong> We deploy advanced firewall systems that monitor and control incoming and outgoing network traffic based on predetermined security rules, blocking potentially malicious connections before they reach our servers.<br />\r\n          b. <strong>Intrusion Detection and Prevention Systems (IDPS):</strong> Our systems continuously monitor for suspicious activities, unauthorized access attempts, and potential security threats. When threats are detected, automated systems can block malicious traffic and alert our security team.<br />\r\n          c. <strong>Distributed Denial of Service (DDoS) Protection:</strong> We employ DDoS mitigation services to protect our platform from attacks that could disrupt service availability.<br />\r\n          d. <strong>Secure Hosting:</strong> Our servers are hosted in secure data centers with physical security measures, redundant power supplies, and environmental controls.<br />\r\n          <em>Example: If our system detects multiple failed login attempts from the same IP address, it automatically blocks further attempts from that source and may require additional verification. This protects your account from brute-force attacks where someone tries to guess your password.</em>\r\n        </p>\r\n\r\n        <p>\r\n          <strong>5.1.5 Security Monitoring and Auditing</strong><br />\r\n          We maintain continuous monitoring and regular assessments to identify and address security vulnerabilities;<br />\r\n          a. <strong>Security Audits:</strong> We conduct regular internal and external security audits to identify potential vulnerabilities in our systems, applications, and processes. These audits are performed by qualified security professionals.<br />\r\n          b. <strong>Vulnerability Assessments:</strong> We regularly scan our systems for known security vulnerabilities and apply patches and updates promptly to address any identified issues.<br />\r\n          c. <strong>Security Logging:</strong> We maintain comprehensive logs of system activities, access attempts, and security events. These logs are regularly reviewed to detect anomalies and potential security incidents.<br />\r\n          d. <strong>Penetration Testing:</strong> Periodically, we engage independent security experts to conduct penetration testing, attempting to identify security weaknesses that could be exploited by attackers.<br />\r\n          <em>Example: Our security team regularly reviews access logs to identify unusual patterns, such as login attempts from unfamiliar locations or access to sensitive data outside normal business hours. If suspicious activity is detected, we investigate immediately and may temporarily restrict access while we verify the legitimacy of the activity.</em>\r\n        </p>\r\n\r\n        <p>\r\n          <strong>5.1.6 Secure Development Practices</strong><br />\r\n          Security is integrated into every stage of our software development lifecycle;<br />\r\n          a. <strong>Secure Coding Standards:</strong> Our development team follows secure coding practices and guidelines to minimize the introduction of security vulnerabilities during software development.<br />\r\n          b. <strong>Code Reviews:</strong> All code changes undergo security-focused code reviews before being deployed to production systems.<br />\r\n          c. <strong>Dependency Management:</strong> We regularly update and patch third-party libraries and dependencies to address known security vulnerabilities.<br />\r\n          d. <strong>Environment Separation:</strong> We maintain separate development, testing, and production environments, with production data never used in non-production environments.<br />\r\n          <em>Example: Before any new feature is released, our security team reviews the code to ensure it doesn't introduce vulnerabilities. We also regularly update our software dependencies to patch any security issues discovered by the open-source community.</em>\r\n        </p>\r\n\r\n        <p>\r\n          <strong>5.2 Organizational Safeguards</strong><br />\r\n          We implement organizational measures to protect your data, including;<br />\r\n          a. Limited access to personal information on a need-to-know basis<br />\r\n          b. Employee training on data protection and privacy<br />\r\n          c. Confidentiality agreements with employees and contractors<br />\r\n          d. Regular review and update of security policies<br />\r\n          <em>Example: Only authorized employees who need to process your booking or provide customer support have access to your personal information. All employees are trained on data protection practices.</em>\r\n        </p>\r\n\r\n        <p>\r\n          <strong>5.3 Payment Security</strong><br />\r\n          We take extra precautions to protect payment information. Our platform is designed for one-time payments, which means you will be required to enter your payment details for each transaction;<br />\r\n          a. We do not store full credit card numbers or complete payment details on our servers<br />\r\n          b. Payment processing is handled by secure, certified payment processors<br />\r\n          c. All payment transactions are encrypted during transmission<br />\r\n          d. For local payment methods (M-Pesa, Tigo Pesa, Airtel Money, HaloPesa, AzamPay), payment details are entered through secure popup windows provided by the payment provider<br />\r\n          e. We only store transaction references and payment status information necessary for booking confirmation and record-keeping<br />\r\n          <em>Example: When you make a booking, you'll be prompted to enter your payment details through a secure popup window. For local mobile money payments, this popup is provided by your payment service (like M-Pesa or AzamPay). Your payment information is processed securely and we only store the transaction reference number to confirm your payment was successful. For each new booking, you'll enter your payment details again, ensuring maximum security.</em>\r\n        </p>\r\n\r\n        <p>\r\n          <strong>5.4 Data Breach Response</strong><br />\r\n          In the unlikely event of a data breach, we will;<br />\r\n          a. Immediately investigate and contain the breach<br />\r\n          b. Notify affected users as soon as possible<br />\r\n          c. Report to relevant authorities as required by law<br />\r\n          d. Take steps to prevent future breaches<br />\r\n          e. Provide guidance on protective measures users can take<br />\r\n        </p>\r\n\r\n        <p>\r\n          <strong>6.0 Data Retention</strong><br />\r\n          We retain your personal information for as long as necessary to fulfill the purposes outlined in this policy, unless a longer retention period is required or permitted by law;\r\n        </p>\r\n\r\n        <p>\r\n          <strong>6.1 Account Information</strong><br />\r\n          We retain your account information for as long as your account is active. If you delete your account, we may retain certain information for a limited period to comply with legal obligations, resolve disputes, and enforce our agreements.\r\n        </p>\r\n\r\n        <p>\r\n          <strong>6.2 Transaction Records</strong><br />\r\n          We retain booking and payment records for a minimum of seven (7) years to comply with tax and financial regulations, resolve disputes, and provide customer support.\r\n        </p>\r\n\r\n        <p>\r\n          <strong>6.3 Communication Records</strong><br />\r\n          We retain customer support communications and messages for up to three (3) years to improve our services and resolve disputes.\r\n        </p>\r\n\r\n        <p>\r\n          <strong>6.4 Marketing Data</strong><br />\r\n          If you unsubscribe from marketing communications, we will remove you from our marketing lists but may retain your email address on a suppression list to ensure we don't contact you again.\r\n        </p>\r\n\r\n        <p>\r\n          <strong>7.0 Your Rights and Choices</strong><br />\r\n          You have various rights regarding your personal information, which you can exercise at any time;\r\n        </p>\r\n\r\n        <p>\r\n          <strong>7.1 Access and Portability</strong><br />\r\n          You have the right to;<br />\r\n          a. Access your personal information<br />\r\n          b. Request a copy of your data in a portable format<br />\r\n          c. Review the information we hold about you<br />\r\n          <em>Example: You can view and download all your account information, booking history, and payment records through your account dashboard.</em>\r\n        </p>\r\n\r\n        <p>\r\n          <strong>7.2 Correction and Update</strong><br />\r\n          You have the right to;<br />\r\n          a. Correct inaccurate or incomplete information<br />\r\n          b. Update your profile and account details<br />\r\n          c. Modify your preferences and settings<br />\r\n          <em>Example: If you change your phone number or email address, you can update it in your account settings at any time.</em>\r\n        </p>\r\n\r\n        <p>\r\n          <strong>7.3 Deletion</strong><br />\r\n          You have the right to request deletion of your personal information, subject to certain legal and operational requirements. We may retain some information as necessary for legal compliance, dispute resolution, or service provision.\r\n        </p>\r\n\r\n        <p>\r\n          <strong>7.4 Opt-Out Rights</strong><br />\r\n          You can opt out of;<br />\r\n          a. Marketing communications (newsletters, promotional emails)<br />\r\n          b. Non-essential cookies and tracking<br />\r\n          c. Location tracking (for Drivers, this may affect service availability)<br />\r\n          <em>Example: You can unsubscribe from our newsletter by clicking the \"unsubscribe\" link at the bottom of any marketing email, or by updating your preferences in your account settings.</em>\r\n        </p>\r\n\r\n        <p>\r\n          <strong>7.5 Account Deactivation</strong><br />\r\n          You can deactivate or delete your account at any time through your account settings. Please note that some information may be retained as required by law or for legitimate business purposes.\r\n        </p>\r\n\r\n        <p>\r\n          <strong>7.6 Data Portability</strong><br />\r\n          You can request a copy of your data in a machine-readable format to transfer it to another service provider.\r\n        </p>\r\n\r\n        <p>\r\n          <strong>8.0 Children's Privacy</strong><br />\r\n          Our Services are not intended for individuals under the age of 18. We do not knowingly collect personal information from children. If we become aware that we have collected information from a child under 18, we will take steps to delete that information promptly. If you believe we have collected information from a child, please contact us immediately at <a href=\"mailto:privacy@nolsaf.com\" className=\"text-blue-600 hover:text-blue-800 underline\">privacy@nolsaf.com</a>.\r\n        </p>\r\n\r\n        <p>\r\n          <strong>9.0 International Data Transfers</strong><br />\r\n          Your information may be transferred to and processed in countries other than your country of residence. These countries may have different data protection laws. When we transfer your information internationally, we ensure appropriate safeguards are in place to protect your data in accordance with this Privacy Policy and applicable laws.\r\n        </p>\r\n\r\n        <p>\r\n          <strong>10.0 Third-Party Links and Services</strong><br />\r\n          Our Services may contain links to third-party websites, applications, or services that are not operated by us. We are not responsible for the privacy practices of these third parties. We encourage you to review the privacy policies of any third-party services you access through our platform.\r\n        </p>\r\n\r\n        <p>\r\n          <strong>11.0 Changes to This Privacy Policy</strong><br />\r\n          We may update this Privacy Policy from time to time to reflect changes in our practices, technology, legal requirements, or other factors. We will notify you of any material changes by;<br />\r\n          a. Posting the updated policy on our website with a new \"Last updated\" date<br />\r\n          b. Sending an email notification to registered users<br />\r\n          c. Displaying a prominent notice on our platform<br />\r\n          Your continued use of our Services after such changes constitutes your acceptance of the updated policy.\r\n        </p>\r\n\r\n        <p>\r\n          <strong>12.0 Contact Us</strong><br />\r\n          If you have questions, concerns, or requests regarding this Privacy Policy or our data practices, please contact us;<br />\r\n          <strong>Email:</strong> <a href=\"mailto:privacy@nolsaf.com\" className=\"text-blue-600 hover:text-blue-800 underline\">privacy@nolsaf.com</a><br />\r\n          <strong>Support Email:</strong> <a href=\"mailto:support@nolsaf.com\" className=\"text-blue-600 hover:text-blue-800 underline\">support@nolsaf.com</a><br />\r\n          <strong>Address:</strong> NoLSAF, East Africa<br />\r\n          We will respond to your inquiries within a reasonable timeframe and in accordance with applicable laws.\r\n        </p>\r\n\r\n        <p>\r\n          <strong>13.0 Your Consent</strong><br />\r\n          By using NoLSAF's Services, you acknowledge that you have read and understood this Privacy Policy and consent to the collection, use, and disclosure of your personal information as described herein. If you do not agree with any part of this policy, please discontinue use of our Services.\r\n        </p>\r\n      </div>\r\n    ),\r\n  },\r\n];\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\propertyOwnerDisbursementPolicyContent.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\security\\AccountSecurityPanel.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\security\\ActiveSessionsSection.tsx","messages":[],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'load'. Either include it or remove the dependency array.","line":51,"column":6,"nodeType":"ArrayExpression","endLine":51,"endColumn":15,"suggestions":[{"desc":"Update the dependencies array to be: [listUrl, load]","fix":{"range":[1375,1384],"text":"[listUrl, load]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\security\\LoginHistoryTable.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\security\\PasskeysManager.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\security\\PasswordChangeForm.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\security\\SecurityHub.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\security\\SecuritySettingsShell.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\security\\TotpSettingsSection.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\security\\TwoFactorSettings.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Link' is defined but never used. Allowed unused vars must match /^_/u.","line":4,"column":8,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":12,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"Link"},"fix":{"range":[76,104],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'ChevronLeft' is defined but never used. Allowed unused vars must match /^_/u.","line":5,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":21,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"ChevronLeft"},"fix":{"range":[115,127],"text":""},"desc":"Remove unused variable \"ChevronLeft\"."}]}],"suppressedMessages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":450,"column":25,"nodeType":"JSXOpeningElement","endLine":450,"endColumn":115,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport React, { useEffect, useRef, useState } from \"react\"\r\nimport Link from \"next/link\"\r\nimport { ChevronLeft, Lock, Smartphone, Shield, CheckCircle, XCircle } from \"lucide-react\"\r\nimport Spinner from \"@/components/Spinner\"\r\nimport SecuritySettingsShell from \"@/components/security/SecuritySettingsShell\"\r\n\r\ntype Status = { totpEnabled: boolean; smsEnabled: boolean; phone?: string | null }\r\n\r\nexport type TwoFactorSettingsProps = {\r\n  statusUrl: string\r\n  provisionTotpUrl: string\r\n  postUrl: string\r\n  smsSendUrl: string\r\n  smsVerifyUrl: string\r\n  smsDisableUrl: string\r\n  backHref: string\r\n  containerClassName?: string\r\n}\r\n\r\nexport default function TwoFactorSettings({\r\n  statusUrl,\r\n  provisionTotpUrl,\r\n  postUrl,\r\n  smsSendUrl,\r\n  smsVerifyUrl,\r\n  smsDisableUrl,\r\n  backHref,\r\n  containerClassName,\r\n}: TwoFactorSettingsProps) {\r\n  const [loading, setLoading] = useState(false)\r\n  const [error, setError] = useState<string | null>(null)\r\n  const [status, setStatus] = useState<Status | null>(null)\r\n\r\n  const [totpFlow, setTotpFlow] = useState<\"idle\" | \"provision\" | \"verifying\" | \"enabled\" | \"disabled\">(\"idle\")\r\n  const [smsFlow, setSmsFlow] = useState<\"idle\" | \"sent\" | \"verifying\" | \"enabled\" | \"disabled\">(\"idle\")\r\n  const [otp, setOtp] = useState(\"\")\r\n  const [disableCode, setDisableCode] = useState(\"\")\r\n  const [showDisableInput, setShowDisableInput] = useState(false)\r\n  const [smsDisableCode, setSmsDisableCode] = useState(\"\")\r\n  const [showSmsDisableInput, setShowSmsDisableInput] = useState(false)\r\n  const [sending, setSending] = useState(false)\r\n  const [provision, setProvision] = useState<{ qr?: string; secret?: string; otpauth?: string } | null>(null)\r\n  const totpVerifyingRef = useRef(false)\r\n  const smsVerifyingRef = useRef(false)\r\n\r\n  useEffect(() => {\r\n    let mounted = true\r\n    ;(async () => {\r\n      try {\r\n        const res = await fetch(statusUrl, { credentials: \"include\" })\r\n        if (!mounted) return\r\n        if (!res.ok) return\r\n        const body = await res.json().catch(() => null)\r\n        if (body) {\r\n          const isTotpEnabled = !!body.totpEnabled\r\n          const isSmsEnabled = !!body.smsEnabled\r\n          setStatus({ totpEnabled: isTotpEnabled, smsEnabled: isSmsEnabled, phone: body.phone ?? null })\r\n          setTotpFlow(isTotpEnabled ? \"enabled\" : \"idle\")\r\n          setSmsFlow(isSmsEnabled ? \"enabled\" : \"idle\")\r\n        }\r\n      } catch (e) {\r\n        // ignore\r\n      }\r\n    })()\r\n    return () => {\r\n      mounted = false\r\n    }\r\n  }, [statusUrl])\r\n\r\n  const dispatchToast = (t: any) => {\r\n    try {\r\n      window.dispatchEvent(new CustomEvent(\"nols:toast\", { detail: t }))\r\n    } catch (e) {}\r\n  }\r\n\r\n  const handleTotpEnableStart = async () => {\r\n    setError(null)\r\n    setOtp(\"\")\r\n    setProvision(null)\r\n    setTotpFlow(\"provision\")\r\n    try {\r\n      const res = await fetch(provisionTotpUrl, { credentials: \"include\" })\r\n      if (!res.ok) {\r\n        const b = await res.json().catch(() => null)\r\n        setError((b && b.error) || `Failed (status ${res.status})`)\r\n        setTotpFlow(\"idle\")\r\n        return\r\n      }\r\n      const body = await res.json().catch(() => null)\r\n      setProvision({ qr: body?.qr ?? null, secret: body?.secret ?? null, otpauth: body?.otpauth ?? null })\r\n    } catch (e: any) {\r\n      setError(String(e))\r\n      setTotpFlow(\"idle\")\r\n    }\r\n  }\r\n\r\n  const handleTotpVerify = async () => {\r\n    if (totpVerifyingRef.current) return\r\n    totpVerifyingRef.current = true\r\n    setError(null)\r\n    setLoading(true)\r\n    setTotpFlow(\"verifying\")\r\n    try {\r\n      const payload: any = { type: \"totp\", action: \"enable\", code: otp }\r\n      if (provision?.secret) payload.secret = provision.secret\r\n      const res = await fetch(postUrl, {\r\n        method: \"POST\",\r\n        credentials: \"include\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify(payload),\r\n      })\r\n      const body = await res.json().catch(() => null)\r\n      if (!res.ok) {\r\n        setError((body && (body.error || body.details)) || `Failed (status ${res.status})`)\r\n        setTotpFlow(\"provision\")\r\n        dispatchToast({ type: \"error\", title: \"2FA\", message: \"Failed to enable authenticator.\" })\r\n      } else {\r\n        setStatus((s) => (s ? { ...s, totpEnabled: true } : { totpEnabled: true, smsEnabled: false }))\r\n        setTotpFlow(\"enabled\")\r\n        dispatchToast({ type: \"success\", title: \"Two-factor enabled\", message: \"Authenticator/TOTP enabled.\" })\r\n      }\r\n    } catch (e: any) {\r\n      setError(String(e))\r\n      setTotpFlow(\"provision\")\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n    totpVerifyingRef.current = false\r\n  }\r\n\r\n  const handleDisableClick = () => {\r\n    setShowDisableInput(true)\r\n    setDisableCode(\"\")\r\n    setError(null)\r\n  }\r\n\r\n  const cancelDisable = () => {\r\n    setShowDisableInput(false)\r\n    setDisableCode(\"\")\r\n    setError(null)\r\n  }\r\n\r\n  const handleTotpDisable = async () => {\r\n    if (!disableCode || disableCode.trim().length === 0) {\r\n      setError(\"Please enter a TOTP code or backup code\")\r\n      dispatchToast({ type: \"error\", title: \"Error\", message: \"Please enter a TOTP code or backup code\" })\r\n      return\r\n    }\r\n    setError(null)\r\n    setLoading(true)\r\n    try {\r\n      const res = await fetch(postUrl, {\r\n        method: \"POST\",\r\n        credentials: \"include\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify({ type: \"totp\", action: \"disable\", code: disableCode.trim() }),\r\n      })\r\n      const body = await res.json().catch(() => null)\r\n      if (!res.ok) {\r\n        setError((body && body.error) || `Failed (status ${res.status})`)\r\n        dispatchToast({ type: \"error\", title: \"2FA\", message: \"Failed to disable authenticator.\" })\r\n      } else {\r\n        setStatus((s) => (s ? { ...s, totpEnabled: false } : { totpEnabled: false, smsEnabled: false }))\r\n        setTotpFlow(\"disabled\")\r\n        setShowDisableInput(false)\r\n        setDisableCode(\"\")\r\n        dispatchToast({ type: \"success\", title: \"Two-factor disabled\", message: \"Authenticator/TOTP disabled.\" })\r\n      }\r\n    } catch (e: any) {\r\n      setError(String(e))\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }\r\n\r\n  const handleSmsSend = async () => {\r\n    setError(null)\r\n    setSending(true)\r\n    try {\r\n      const res = await fetch(smsSendUrl, {\r\n        method: \"POST\",\r\n        credentials: \"include\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify({}),\r\n      })\r\n      const body = await res.json().catch(() => null)\r\n      if (!res.ok) {\r\n        setError((body && body.error) || `Failed (status ${res.status})`)\r\n        dispatchToast({ type: \"error\", title: \"Failed to send SMS\", message: (body && body.error) || \"Failed to send SMS code.\" })\r\n      } else {\r\n        setSmsFlow(\"sent\")\r\n        dispatchToast({ type: \"info\", title: \"SMS sent\", message: \"A verification code was sent to your phone.\" })\r\n      }\r\n    } catch (e: any) {\r\n      setError(String(e))\r\n      dispatchToast({ type: \"error\", title: \"Failed to send SMS\", message: String(e) })\r\n    } finally {\r\n      setSending(false)\r\n    }\r\n  }\r\n\r\n  const handleSmsVerify = async () => {\r\n    if (smsVerifyingRef.current) return\r\n    if (!otp || otp.length !== 6 || !/^\\d{6}$/.test(otp)) {\r\n      setError(\"Please enter a valid 6-digit verification code\")\r\n      dispatchToast({ type: \"error\", title: \"Error\", message: \"Please enter a valid 6-digit verification code\" })\r\n      return\r\n    }\r\n    smsVerifyingRef.current = true\r\n    setError(null)\r\n    setLoading(true)\r\n    setSmsFlow(\"verifying\")\r\n    try {\r\n      const codeToSend = String(otp).replace(/\\D/g, \"\").slice(0, 6)\r\n      const res = await fetch(smsVerifyUrl, {\r\n        method: \"POST\",\r\n        credentials: \"include\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify({ code: codeToSend }),\r\n      })\r\n      const body = await res.json().catch(() => null)\r\n      if (!res.ok) {\r\n        setError((body && body.error) || `Failed (status ${res.status})`)\r\n        setSmsFlow(\"sent\")\r\n        dispatchToast({ type: \"error\", title: \"2FA\", message: (body && body.error) || \"Failed to verify SMS code.\" })\r\n      } else {\r\n        const statusRes = await fetch(statusUrl, { credentials: \"include\" })\r\n        const statusBody = await statusRes.json().catch(() => null)\r\n        if (statusBody) {\r\n          const isTotpEnabled = !!statusBody.totpEnabled\r\n          const isSmsEnabled = !!statusBody.smsEnabled\r\n          setStatus({ totpEnabled: isTotpEnabled, smsEnabled: isSmsEnabled, phone: statusBody.phone ?? null })\r\n          setSmsFlow(isSmsEnabled ? \"enabled\" : \"idle\")\r\n        } else {\r\n          setStatus((s) => (s ? { ...s, smsEnabled: true } : { totpEnabled: false, smsEnabled: true }))\r\n          setSmsFlow(\"enabled\")\r\n        }\r\n        setOtp(\"\")\r\n        dispatchToast({ type: \"success\", title: \"Two-factor enabled\", message: \"SMS-based 2FA enabled.\" })\r\n      }\r\n    } catch (e: any) {\r\n      setError(String(e))\r\n      setSmsFlow(\"sent\")\r\n      dispatchToast({ type: \"error\", title: \"2FA\", message: \"Failed to verify SMS code.\" })\r\n    } finally {\r\n      setLoading(false)\r\n      smsVerifyingRef.current = false\r\n    }\r\n  }\r\n\r\n  const handleSmsDisableClick = async () => {\r\n    setError(null)\r\n    setSending(true)\r\n    try {\r\n      const res = await fetch(smsSendUrl, {\r\n        method: \"POST\",\r\n        credentials: \"include\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify({}),\r\n      })\r\n      const body = await res.json().catch(() => null)\r\n      if (!res.ok) {\r\n        setError((body && body.error) || `Failed (status ${res.status})`)\r\n        dispatchToast({ type: \"error\", title: \"Failed to send SMS\", message: (body && body.error) || \"Failed to send SMS code.\" })\r\n      } else {\r\n        setShowSmsDisableInput(true)\r\n        setSmsDisableCode(\"\")\r\n        dispatchToast({\r\n          type: \"info\",\r\n          title: \"SMS sent\",\r\n          message: \"A verification code was sent to your phone. Enter it to disable SMS 2FA.\",\r\n        })\r\n      }\r\n    } catch (e: any) {\r\n      setError(String(e))\r\n      dispatchToast({ type: \"error\", title: \"Failed to send SMS\", message: String(e) })\r\n    } finally {\r\n      setSending(false)\r\n    }\r\n  }\r\n\r\n  const cancelSmsDisable = () => {\r\n    setShowSmsDisableInput(false)\r\n    setSmsDisableCode(\"\")\r\n    setError(null)\r\n  }\r\n\r\n  const handleSmsDisable = async () => {\r\n    if (!smsDisableCode || smsDisableCode.length !== 6 || !/^\\d{6}$/.test(smsDisableCode)) {\r\n      setError(\"Please enter a valid 6-digit verification code\")\r\n      dispatchToast({ type: \"error\", title: \"Error\", message: \"Please enter a valid 6-digit verification code\" })\r\n      return\r\n    }\r\n    setError(null)\r\n    setLoading(true)\r\n    try {\r\n      const codeToSend = String(smsDisableCode).replace(/\\D/g, \"\").slice(0, 6)\r\n      const res = await fetch(smsDisableUrl, {\r\n        method: \"POST\",\r\n        credentials: \"include\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify({ code: codeToSend }),\r\n      })\r\n      const body = await res.json().catch(() => null)\r\n      if (!res.ok) {\r\n        setError((body && body.error) || `Failed (status ${res.status})`)\r\n        dispatchToast({ type: \"error\", title: \"2FA\", message: (body && body.error) || \"Failed to disable SMS-based 2FA.\" })\r\n      } else {\r\n        const statusRes = await fetch(statusUrl, { credentials: \"include\" })\r\n        const statusBody = await statusRes.json().catch(() => null)\r\n        if (statusBody) {\r\n          const isTotpEnabled = !!statusBody.totpEnabled\r\n          const isSmsEnabled = !!statusBody.smsEnabled\r\n          setStatus({ totpEnabled: isTotpEnabled, smsEnabled: isSmsEnabled, phone: statusBody.phone ?? null })\r\n          setSmsFlow(isSmsEnabled ? \"enabled\" : \"disabled\")\r\n        } else {\r\n          setStatus((s) => (s ? { ...s, smsEnabled: false } : { totpEnabled: false, smsEnabled: false }))\r\n          setSmsFlow(\"disabled\")\r\n        }\r\n        setSmsDisableCode(\"\")\r\n        setShowSmsDisableInput(false)\r\n        dispatchToast({ type: \"success\", title: \"Two-factor disabled\", message: \"SMS-based 2FA disabled.\" })\r\n      }\r\n    } catch (e: any) {\r\n      setError(String(e))\r\n      dispatchToast({ type: \"error\", title: \"2FA\", message: \"Failed to disable SMS-based 2FA.\" })\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }\r\n\r\n  return (\r\n    <SecuritySettingsShell\r\n      containerClassName={containerClassName}\r\n      title=\"Two-factor Authentication\"\r\n      description=\"Enable an additional layer of security for your account.\"\r\n      icon={Shield}\r\n      iconBgClassName=\"bg-emerald-50\"\r\n      iconClassName=\"text-emerald-700\"\r\n      backHref={backHref}\r\n      backLabel=\"Back to Security\"\r\n      backAriaLabel=\"Back to Security\"\r\n    >\r\n      <div className=\"rounded-3xl border border-slate-200/70 bg-white/75 backdrop-blur shadow-card ring-1 ring-slate-900/5 overflow-hidden\">\r\n        <div className=\"p-5 sm:p-6\">\r\n          <div className=\"space-y-4\">\r\n            <div className=\"p-5 border border-slate-200/70 rounded-2xl bg-white/80 hover:border-slate-300/70 hover:bg-white transition-colors\">\r\n              <div className=\"flex flex-col gap-4 sm:flex-row sm:items-start sm:justify-between\">\r\n                <div className=\"flex items-start gap-3 min-w-0\">\r\n                  <div className=\"mt-0.5 h-10 w-10 rounded-lg bg-blue-50 flex items-center justify-center shrink-0\">\r\n                    <Smartphone className=\"h-5 w-5 text-blue-600\" />\r\n                  </div>\r\n                  <div className=\"min-w-0\">\r\n                    <h3 className=\"text-base font-semibold text-slate-900\">Authenticator / TOTP</h3>\r\n                    <p className=\"text-sm text-slate-500 mt-0.5\">Use an authenticator app to generate 6-digit codes.</p>\r\n                  </div>\r\n                </div>\r\n\r\n                <div className=\"flex flex-col items-start sm:items-end gap-3\">\r\n                  <div>\r\n                    {status && status.totpEnabled ? (\r\n                      <span className=\"inline-flex items-center gap-1.5 px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-700\">\r\n                        <CheckCircle className=\"h-3 w-3\" />\r\n                        Enabled\r\n                      </span>\r\n                    ) : (\r\n                      <span className=\"inline-flex items-center gap-1.5 px-2.5 py-0.5 rounded-full text-xs font-medium bg-slate-100 text-slate-600\">\r\n                        <XCircle className=\"h-3 w-3\" />\r\n                        Disabled\r\n                      </span>\r\n                    )}\r\n                  </div>\r\n\r\n                  <div className=\"flex flex-wrap items-center gap-2\">\r\n                    {status && status.totpEnabled ? (\r\n                      !showDisableInput ? (\r\n                        <button\r\n                          onClick={handleDisableClick}\r\n                          disabled={loading}\r\n                          className=\"h-11 inline-flex items-center justify-center px-4 text-sm font-semibold text-red-700 hover:text-red-800 hover:bg-red-50 rounded-xl transition-colors border border-red-200 hover:border-red-300 shadow-sm disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                        >\r\n                          Disable\r\n                        </button>\r\n                      ) : null\r\n                    ) : (\r\n                      (() => {\r\n                        const disabled = loading\r\n                        return (\r\n                          <button\r\n                            onClick={handleTotpEnableStart}\r\n                            disabled={disabled}\r\n                            className={`h-11 inline-flex items-center justify-center gap-2 px-4 text-sm font-semibold rounded-xl transition-colors border shadow-sm ${\r\n                              disabled\r\n                                ? \"text-slate-400 bg-slate-50 border-slate-200 opacity-60 cursor-not-allowed\"\r\n                                : \"text-emerald-700 hover:text-emerald-800 hover:bg-emerald-50 border-emerald-200 hover:border-emerald-300\"\r\n                            }`}\r\n                          >\r\n                            {disabled ? <Lock className=\"h-4 w-4\" aria-hidden /> : null}\r\n                            <span>{disabled ? \"Please wait\" : \"Enable\"}</span>\r\n                          </button>\r\n                        )\r\n                      })()\r\n                    )}\r\n                  </div>\r\n                </div>\r\n              </div>\r\n\r\n              {status && status.totpEnabled && showDisableInput ? (\r\n                <div className=\"mt-4 rounded-xl border border-slate-200 bg-slate-50/70 p-4\">\r\n                  <div className=\"w-full\">\r\n                    <label className=\"block text-xs font-semibold text-slate-700 mb-1.5\">Enter TOTP code or backup code to disable</label>\r\n                    <input\r\n                      type=\"text\"\r\n                      value={disableCode}\r\n                      onChange={(e) => setDisableCode(e.target.value)}\r\n                      placeholder=\"Enter code\"\r\n                      className=\"h-11 block w-full rounded-xl border border-slate-200 bg-white px-4 text-sm font-mono shadow-sm focus:border-red-300 focus:outline-none focus:ring-2 focus:ring-red-200 transition\"\r\n                      autoFocus\r\n                    />\r\n                    <p className=\"mt-1.5 text-xs text-slate-500\">Enter a 6-digit TOTP code from your authenticator app or a backup code.</p>\r\n                  </div>\r\n                  <div className=\"mt-3 flex flex-wrap items-center gap-2\">\r\n                    <button\r\n                      onClick={handleTotpDisable}\r\n                      disabled={loading || !disableCode.trim()}\r\n                      className=\"h-11 inline-flex items-center justify-center px-4 text-sm font-semibold text-red-700 hover:text-red-800 hover:bg-red-50 rounded-xl transition-colors border border-red-200 hover:border-red-300 shadow-sm disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                    >\r\n                      {loading ? \"Disabling...\" : \"Disable\"}\r\n                    </button>\r\n                    <button\r\n                      onClick={cancelDisable}\r\n                      disabled={loading}\r\n                      className=\"h-11 inline-flex items-center justify-center px-4 text-sm font-semibold text-slate-700 hover:text-slate-900 hover:bg-slate-50 rounded-xl transition-colors border border-slate-200 hover:border-slate-300 shadow-sm disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                    >\r\n                      Cancel\r\n                    </button>\r\n                  </div>\r\n                </div>\r\n              ) : null}\r\n\r\n              {(totpFlow === \"provision\" || totpFlow === \"verifying\") && (\r\n                <div className=\"mt-4 rounded-xl border border-slate-200 bg-slate-50/70 p-4\">\r\n                  <p className=\"text-sm text-slate-600 mb-3\">Scan this QR code in your authenticator app or enter the secret manually.</p>\r\n                  <div className=\"flex items-start gap-4\">\r\n                    <div className=\"w-32 h-32 bg-white border border-slate-200 rounded-xl flex items-center justify-center flex-shrink-0 shadow-sm\">\r\n                      {provision?.qr ? (\r\n                        // eslint-disable-next-line @next/next/no-img-element\r\n                        <img src={provision.qr} alt=\"TOTP QR code\" className=\"w-full h-full object-contain p-2\" />\r\n                      ) : (\r\n                        <svg width=\"64\" height=\"64\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\r\n                          <rect x=\"2\" y=\"2\" width=\"8\" height=\"8\" stroke=\"#93c5fd\" strokeWidth=\"1.5\" fill=\"#fff\" />\r\n                          <rect x=\"14\" y=\"2\" width=\"8\" height=\"8\" stroke=\"#93c5fd\" strokeWidth=\"1.5\" fill=\"#fff\" />\r\n                          <rect x=\"2\" y=\"14\" width=\"8\" height=\"8\" stroke=\"#93c5fd\" strokeWidth=\"1.5\" fill=\"#fff\" />\r\n                          <rect x=\"10\" y=\"10\" width=\"4\" height=\"4\" fill=\"#0ea5e9\" />\r\n                        </svg>\r\n                      )}\r\n                    </div>\r\n                    <div className=\"flex-1 min-w-0\">\r\n                      <div className=\"text-xs font-mono bg-white p-2.5 rounded-xl border border-slate-200 break-all shadow-sm\">{provision?.secret ?? \"—\"}</div>\r\n                      <div className=\"mt-3 flex items-center gap-2 flex-wrap\">\r\n                        <input\r\n                          value={otp}\r\n                          onChange={(e) => setOtp(e.target.value)}\r\n                          placeholder=\"Enter 6-digit code\"\r\n                          className=\"h-11 w-44 px-4 border border-slate-200 rounded-xl bg-white text-sm font-mono tabular-nums shadow-sm focus:border-emerald-300 focus:outline-none focus:ring-2 focus:ring-emerald-200 transition\"\r\n                        />\r\n                        {(() => {\r\n                          const isVerifying = totpFlow === \"verifying\"\r\n                          const disabled = isVerifying || otp.length < 6\r\n                          return (\r\n                            <button\r\n                              onClick={handleTotpVerify}\r\n                              disabled={disabled}\r\n                              className={`h-11 inline-flex items-center justify-center gap-2 px-4 text-sm font-semibold rounded-xl transition-colors border shadow-sm ${\r\n                                disabled\r\n                                  ? \"text-slate-400 bg-white border-slate-200 opacity-60 cursor-not-allowed\"\r\n                                  : \"text-emerald-700 hover:text-emerald-800 hover:bg-emerald-50 border-emerald-200 hover:border-emerald-300\"\r\n                              }`}\r\n                            >\r\n                              {isVerifying ? (\r\n                                <Spinner size=\"sm\" ariaLabel=\"Verifying\" />\r\n                              ) : disabled ? (\r\n                                <Lock className=\"h-4 w-4\" aria-hidden />\r\n                              ) : null}\r\n                              <span>{isVerifying ? \"Verifying\" : \"Verify\"}</span>\r\n                            </button>\r\n                          )\r\n                        })()}\r\n                        <button\r\n                          onClick={() => {\r\n                            setTotpFlow(\"idle\")\r\n                            setProvision(null)\r\n                          }}\r\n                          className=\"h-11 inline-flex items-center justify-center px-4 text-sm font-semibold text-slate-700 hover:text-slate-900 hover:bg-slate-50 rounded-xl transition-colors border border-slate-200 hover:border-slate-300 shadow-sm\"\r\n                        >\r\n                          Cancel\r\n                        </button>\r\n                      </div>\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n              )}\r\n            </div>\r\n\r\n            <div className=\"p-5 border border-slate-200/70 rounded-2xl bg-white/80 hover:border-slate-300/70 hover:bg-white transition-colors\">\r\n              <div className=\"flex flex-col gap-4 sm:flex-row sm:items-start sm:justify-between\">\r\n                <div className=\"flex items-start gap-3 min-w-0\">\r\n                  <div className=\"mt-0.5 h-10 w-10 rounded-lg bg-purple-50 flex items-center justify-center shrink-0\">\r\n                    <Smartphone className=\"h-5 w-5 text-purple-600\" />\r\n                  </div>\r\n                  <div className=\"min-w-0\">\r\n                    <h3 className=\"text-base font-semibold text-slate-900\">SMS-based 2FA</h3>\r\n                    <p className=\"text-sm text-slate-500 mt-0.5\">Receive codes via SMS to your registered phone.</p>\r\n                  </div>\r\n                </div>\r\n\r\n                <div className=\"flex flex-col items-start sm:items-end gap-3\">\r\n                  <div>\r\n                    {status && status.smsEnabled ? (\r\n                      <span className=\"inline-flex items-center gap-1.5 px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-700\">\r\n                        <CheckCircle className=\"h-3 w-3\" />\r\n                        Enabled\r\n                      </span>\r\n                    ) : (\r\n                      <span className=\"inline-flex items-center gap-1.5 px-2.5 py-0.5 rounded-full text-xs font-medium bg-slate-100 text-slate-600\">\r\n                        <XCircle className=\"h-3 w-3\" />\r\n                        Disabled\r\n                      </span>\r\n                    )}\r\n                  </div>\r\n\r\n                  <div className=\"flex flex-wrap items-center gap-2\">\r\n                    {(status && status.smsEnabled) || smsFlow === \"enabled\" ? (\r\n                      !showSmsDisableInput ? (\r\n                        <button\r\n                          onClick={handleSmsDisableClick}\r\n                          disabled={loading || sending}\r\n                          className=\"h-11 inline-flex items-center justify-center px-4 text-sm font-semibold text-red-700 hover:text-red-800 hover:bg-red-50 rounded-xl transition-colors border border-red-200 hover:border-red-300 shadow-sm disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                        >\r\n                          {sending ? \"Sending code...\" : \"Disable\"}\r\n                        </button>\r\n                      ) : null\r\n                    ) : (\r\n                      <>\r\n                        {(() => {\r\n                          const disabled = sending\r\n                          return (\r\n                            <button\r\n                              onClick={handleSmsSend}\r\n                              disabled={disabled}\r\n                              className={`h-11 inline-flex items-center justify-center gap-2 px-4 text-sm font-semibold rounded-xl transition-colors border shadow-sm ${\r\n                                disabled\r\n                                  ? \"text-slate-400 bg-slate-50 border-slate-200 opacity-60 cursor-not-allowed\"\r\n                                  : \"text-emerald-700 hover:text-emerald-800 hover:bg-emerald-50 border-emerald-200 hover:border-emerald-300\"\r\n                              }`}\r\n                            >\r\n                              {disabled ? <Lock className=\"h-4 w-4\" aria-hidden /> : null}\r\n                              <span>{disabled ? \"Sending…\" : \"Send code\"}</span>\r\n                            </button>\r\n                          )\r\n                        })()}\r\n                        <button\r\n                          onClick={() => setSmsFlow(\"sent\")}\r\n                          className=\"h-11 inline-flex items-center justify-center px-4 text-sm font-semibold text-slate-700 hover:text-slate-900 hover:bg-slate-50 rounded-xl transition-colors border border-slate-200 hover:border-slate-300 shadow-sm\"\r\n                        >\r\n                          I have a code\r\n                        </button>\r\n                      </>\r\n                    )}\r\n                  </div>\r\n                </div>\r\n              </div>\r\n\r\n              {(status && status.smsEnabled) && showSmsDisableInput ? (\r\n                <div className=\"mt-4 rounded-xl border border-slate-200 bg-slate-50/70 p-4\">\r\n                  <div className=\"w-full\">\r\n                    <label className=\"block text-xs font-semibold text-slate-700 mb-1.5\">Enter SMS code to disable</label>\r\n                    <input\r\n                      type=\"text\"\r\n                      maxLength={6}\r\n                      value={smsDisableCode}\r\n                      onChange={(e) => setSmsDisableCode(e.target.value.replace(/\\D/g, \"\"))}\r\n                      placeholder=\"000000\"\r\n                      className=\"h-11 block w-full rounded-xl border border-slate-200 bg-white px-4 text-sm font-mono text-center shadow-sm focus:border-red-300 focus:outline-none focus:ring-2 focus:ring-red-200 transition\"\r\n                      autoFocus\r\n                    />\r\n                    <p className=\"mt-1.5 text-xs text-slate-500\">Enter the 6-digit code sent to your phone.</p>\r\n                  </div>\r\n                  <div className=\"mt-3 flex flex-wrap items-center gap-2\">\r\n                    <button\r\n                      onClick={handleSmsDisable}\r\n                      disabled={loading || smsDisableCode.length !== 6}\r\n                      className=\"h-11 inline-flex items-center justify-center px-4 text-sm font-semibold text-red-700 hover:text-red-800 hover:bg-red-50 rounded-xl transition-colors border border-red-200 hover:border-red-300 shadow-sm disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                    >\r\n                      {loading ? \"Disabling...\" : \"Disable SMS 2FA\"}\r\n                    </button>\r\n                    <button\r\n                      onClick={cancelSmsDisable}\r\n                      disabled={loading}\r\n                      className=\"h-11 inline-flex items-center justify-center px-4 text-sm font-semibold text-slate-700 hover:text-slate-900 hover:bg-slate-50 rounded-xl transition-colors border border-slate-200 hover:border-slate-300 shadow-sm disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                    >\r\n                      Cancel\r\n                    </button>\r\n                  </div>\r\n                </div>\r\n              ) : null}\r\n\r\n              {(smsFlow === \"sent\" || smsFlow === \"verifying\") && (\r\n                <div className=\"mt-4 rounded-xl border border-slate-200 bg-slate-50/70 p-4\">\r\n                  <p className=\"text-sm text-slate-600 mb-3\">\r\n                    A code was sent to <strong>{status?.phone ?? \"your phone\"}</strong>. Enter it below to verify.\r\n                  </p>\r\n                  <div className=\"flex items-center gap-2 flex-wrap\">\r\n                    <input\r\n                      value={otp}\r\n                      onChange={(e) => setOtp(e.target.value)}\r\n                      placeholder=\"Enter SMS code\"\r\n                      className=\"h-11 w-44 px-4 border border-slate-200 rounded-xl bg-white text-sm font-mono tabular-nums shadow-sm focus:border-emerald-300 focus:outline-none focus:ring-2 focus:ring-emerald-200 transition\"\r\n                    />\r\n                    {(() => {\r\n                      const isVerifying = smsFlow === \"verifying\"\r\n                      const disabled = isVerifying || otp.length < 6\r\n                      return (\r\n                        <button\r\n                          onClick={handleSmsVerify}\r\n                          disabled={disabled}\r\n                          className={`h-11 inline-flex items-center justify-center gap-2 px-4 text-sm font-semibold rounded-xl transition-colors border shadow-sm ${\r\n                            disabled\r\n                              ? \"text-slate-400 bg-white border-slate-200 opacity-60 cursor-not-allowed\"\r\n                              : \"text-emerald-700 hover:text-emerald-800 hover:bg-emerald-50 border-emerald-200 hover:border-emerald-300\"\r\n                          }`}\r\n                        >\r\n                          {isVerifying ? (\r\n                            <Spinner size=\"sm\" ariaLabel=\"Verifying\" />\r\n                          ) : disabled ? (\r\n                            <Lock className=\"h-4 w-4\" aria-hidden />\r\n                          ) : null}\r\n                          <span>{isVerifying ? \"Verifying\" : \"Verify\"}</span>\r\n                        </button>\r\n                      )\r\n                    })()}\r\n                    <button\r\n                      onClick={() => setSmsFlow(\"idle\")}\r\n                      className=\"h-11 inline-flex items-center justify-center px-4 text-sm font-semibold text-slate-700 hover:text-slate-900 hover:bg-slate-50 rounded-xl transition-colors border border-slate-200 hover:border-slate-300 shadow-sm\"\r\n                    >\r\n                      Cancel\r\n                    </button>\r\n                  </div>\r\n                </div>\r\n              )}\r\n            </div>\r\n          </div>\r\n\r\n          {error && (\r\n            <div className=\"mt-4 rounded-md bg-red-50 border-2 border-red-200 p-3\">\r\n              <div className=\"text-sm font-medium text-red-800\">{error}</div>\r\n            </div>\r\n          )}\r\n        </div>\r\n      </div>\r\n    </SecuritySettingsShell>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\termsContent.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\ui\\Button.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\ui\\CountdownClock.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\ui\\DatePicker.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'view2'. Either include it or remove the dependency array.","line":202,"column":6,"nodeType":"ArrayExpression","endLine":202,"endColumn":56,"suggestions":[{"desc":"Update the dependencies array to be: [view.year, view.month, view2.year, view2.month, view2]","fix":{"range":[7302,7352],"text":"[view.year, view.month, view2.year, view2.month, view2]"}}]}],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'onCloseAction', 'todayD', 'todayM', and 'todayY'. Either include them or remove the dependency array. If 'onCloseAction' changes too often, find the parent component that defines it and wrap that definition in useCallback.","line":174,"column":6,"nodeType":"ArrayExpression","endLine":174,"endColumn":40,"suggestions":[{"desc":"Update the dependencies array to be: [focusedIdx, allDays, lastClicked, onCloseAction, todayY, todayM, todayD]","fix":{"range":[5994,6028],"text":"[focusedIdx, allDays, lastClicked, onCloseAction, todayY, todayM, todayD]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useEffect, useRef, useState } from \"react\";\r\nimport axios from \"axios\";\r\n\r\nconst MONTHS = [\r\n  \"January\",\r\n  \"February\",\r\n  \"March\",\r\n  \"April\",\r\n  \"May\",\r\n  \"June\",\r\n  \"July\",\r\n  \"August\",\r\n  \"September\",\r\n  \"October\",\r\n  \"November\",\r\n  \"December\",\r\n];\r\nconst WEEKDAYS = [\"Su\", \"Mo\", \"Tu\", \"We\", \"Th\", \"Fr\", \"Sa\"];\r\n\r\nfunction pad(n: number) {\r\n  return n < 10 ? `0${n}` : `${n}`;\r\n}\r\n\r\ntype DayCell = { y: number; m: number; d: number; currentMonth: boolean };\r\n\r\nfunction buildDays(year: number, month: number): DayCell[] {\r\n  const first = new Date(year, month, 1).getDay();\r\n  const prevMonth = month === 0 ? 11 : month - 1;\r\n  const prevYear = month === 0 ? year - 1 : year;\r\n  const prevDaysCount = new Date(prevYear, prevMonth + 1, 0).getDate();\r\n  const dim = new Date(year, month + 1, 0).getDate();\r\n  const nextMonth = (month + 1) % 12;\r\n  const nextYear = month === 11 ? year + 1 : year;\r\n  const out: DayCell[] = [];\r\n  for (let i = prevDaysCount - first + 1; i <= prevDaysCount; i++) {\r\n    out.push({ y: prevYear, m: prevMonth, d: i, currentMonth: false });\r\n  }\r\n  for (let i = 1; i <= dim; i++) out.push({ y: year, m: month, d: i, currentMonth: true });\r\n  let n = 1;\r\n  while (out.length % 7 !== 0) {\r\n    out.push({ y: nextYear, m: nextMonth, d: n++, currentMonth: false });\r\n  }\r\n  return out;\r\n}\r\n\r\nexport default function DatePicker({\r\n  selected,\r\n  onSelectAction,\r\n  onCloseAction,\r\n  allowRange = true,\r\n  allowPast = false,\r\n  minDate,\r\n  maxDate,\r\n  twoMonths = false,\r\n  initialViewDate,\r\n  resetRangeAnchor = false,\r\n}: {\r\n  selected?: string | string[];\r\n  onSelectAction: (s: string | string[]) => void;\r\n  onCloseAction?: () => void;\r\n  allowRange?: boolean;\r\n  allowPast?: boolean; // if true, allow selecting dates before today (unless limited by minDate)\r\n  minDate?: string; // ISO date string (YYYY-MM-DD)\r\n  maxDate?: string; // ISO date string (YYYY-MM-DD)\r\n  twoMonths?: boolean; // show current month and next month side by side\r\n  initialViewDate?: string; // ISO date string (YYYY-MM-DD) to set the initial month/year when nothing selected\r\n  resetRangeAnchor?: boolean; // if true, first click is always treated as a new range start\r\n}) {\r\n  const rootRef = useRef<HTMLDivElement | null>(null);\r\n  const btnRefs = useRef<Array<HTMLButtonElement | null>>([]);\r\n  const [focusedIdx, setFocusedIdx] = useState<number | null>(null);\r\n  const [view, setView] = useState(() => {\r\n    const seed = (() => {\r\n      if (selected) {\r\n        const s = Array.isArray(selected) ? selected[0] : selected;\r\n        if (s) return s;\r\n      }\r\n      if (initialViewDate) return initialViewDate;\r\n      return null;\r\n    })();\r\n\r\n    if (seed) {\r\n      const d = new Date(seed + \"T00:00:00\");\r\n      if (!Number.isNaN(d.getTime())) {\r\n        return { year: d.getFullYear(), month: d.getMonth() };\r\n      }\r\n    }\r\n\r\n    const now = new Date();\r\n    return { year: now.getFullYear(), month: now.getMonth() };\r\n  });\r\n\r\n  useEffect(() => {\r\n    function onDoc(e: MouseEvent) {\r\n      if (!rootRef.current) return;\r\n      if (e.target && (e.target as Node) && !rootRef.current.contains(e.target as Node)) {\r\n        onCloseAction?.();\r\n      }\r\n    }\r\n    document.addEventListener(\"mousedown\", onDoc);\r\n    return () => document.removeEventListener(\"mousedown\", onDoc);\r\n  }, [onCloseAction]);\r\n\r\n  const view2 = twoMonths\r\n    ? { year: view.month === 11 ? view.year + 1 : view.year, month: (view.month + 1) % 12 }\r\n    : null;\r\n  const days = buildDays(view.year, view.month);\r\n  const days2 = view2 ? buildDays(view2.year, view2.month) : [];\r\n  const allDays = twoMonths ? [...days, ...days2] : days;\r\n\r\n  const selectedArray = (() => {\r\n    if (!selected) return [] as string[];\r\n    if (Array.isArray(selected)) return selected as string[];\r\n    return [selected as string];\r\n  })();\r\n\r\n  const isSelected = (y: number, m: number, d: number) => {\r\n    if (!selectedArray || selectedArray.length === 0) return false;\r\n    const iso = `${y}-${pad(m + 1)}-${pad(d)}`;\r\n    if (selectedArray.length === 1) return selectedArray[0] === iso;\r\n    const [a, b] = selectedArray.slice(0, 2).sort();\r\n    return iso >= a && iso <= b;\r\n  };\r\n\r\n  // remember last clicked date to enable Shift+click range selection\r\n  const [lastClicked, setLastClicked] = useState<string | null>(() => {\r\n    if (Array.isArray(selected) && selected.length > 0) return selected[0];\r\n    if (typeof selected === \"string\" && selected) return selected;\r\n    return null;\r\n  });\r\n\r\n  useEffect(() => {\r\n    if (resetRangeAnchor) setLastClicked(null);\r\n  }, [resetRangeAnchor]);\r\n\r\n  // handle keyboard navigation and escape\r\n  useEffect(() => {\r\n    function onKey(e: KeyboardEvent) {\r\n      if (!rootRef.current) return;\r\n      if (e.key === \"Escape\") {\r\n        onCloseAction?.();\r\n        return;\r\n      }\r\n      // arrow navigation\r\n      if ([\"ArrowLeft\", \"ArrowRight\", \"ArrowUp\", \"ArrowDown\"].includes(e.key)) {\r\n        e.preventDefault();\r\n        const total = allDays.length;\r\n        if (total === 0) return;\r\n        let idx = focusedIdx;\r\n        if (idx === null) {\r\n          idx = allDays.findIndex((c) => c.currentMonth && c.y === todayY && c.m === todayM && c.d === todayD);\r\n          if (idx === -1) idx = 0;\r\n        }\r\n        if (e.key === \"ArrowLeft\") idx = Math.max(0, idx - 1);\r\n        if (e.key === \"ArrowRight\") idx = Math.min(total - 1, idx + 1);\r\n        if (e.key === \"ArrowUp\") idx = Math.max(0, idx - 7);\r\n        if (e.key === \"ArrowDown\") idx = Math.min(total - 1, idx + 7);\r\n        setFocusedIdx(idx);\r\n        const btn = btnRefs.current[idx];\r\n        btn?.focus();\r\n      }\r\n      if (e.key === \"Enter\") {\r\n        if (focusedIdx !== null) {\r\n          const btn = btnRefs.current[focusedIdx];\r\n          btn?.click();\r\n        }\r\n      }\r\n    }\r\n    document.addEventListener(\"keydown\", onKey);\r\n    return () => document.removeEventListener(\"keydown\", onKey);\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [focusedIdx, allDays, lastClicked]);\r\n\r\n  const today = new Date();\r\n  const todayY = today.getFullYear();\r\n  const todayM = today.getMonth();\r\n  const todayD = today.getDate();\r\n  const [perDayCounts, setPerDayCounts] = useState<Record<string, { total: number; statuses: Record<string, number> }>>({});\r\n\r\n  // fetch aggregated counts for the visible month(s)\r\n  useEffect(() => {\r\n    const start = new Date(view.year, view.month, 1);\r\n    const end = view2\r\n      ? new Date(view2.year, view2.month + 1, 0)\r\n      : new Date(view.year, view.month + 1, 0);\r\n    const isoStart = `${start.getFullYear()}-${String(start.getMonth() + 1).padStart(2, \"0\")}-${String(start.getDate()).padStart(2, \"0\")}`;\r\n    const isoEnd = `${end.getFullYear()}-${String(end.getMonth() + 1).padStart(2, \"0\")}-${String(end.getDate()).padStart(2, \"0\")}`;\r\n    (async () => {\r\n      try {\r\n        const base = process.env.NEXT_PUBLIC_API_URL || \"\";\r\n        const r = await axios.get<Record<string, { total: number; statuses: Record<string, number> }>>(\r\n          `${base}/admin/bookings/counts`,\r\n          { params: { start: isoStart, end: isoEnd } }\r\n        );\r\n        if (r?.data) setPerDayCounts(r.data);\r\n      } catch (e) {\r\n        // ignore failures — calendar will still work without counts\r\n      }\r\n    })();\r\n  }, [view.year, view.month, view2?.year, view2?.month]);\r\n\r\n  const renderCell = (cell: DayCell, idx: number, refOffset: number) => {\r\n    const isoKey = `${cell.y}-${pad(cell.m + 1)}-${pad(cell.d)}`;\r\n    const sel = isSelected(cell.y, cell.m, cell.d);\r\n    const cellDateY = cell.y;\r\n    const cellDateM = cell.m;\r\n    const cellDateD = cell.d;\r\n    const isToday = cellDateY === todayY && cellDateM === todayM && cellDateD === todayD;\r\n    let isPast = false;\r\n    let isBeforeMin = false;\r\n    let isAfterMax = false;\r\n    if (minDate) {\r\n      const minDateObj = new Date(minDate + \"T00:00:00\");\r\n      const minY = minDateObj.getFullYear();\r\n      const minM = minDateObj.getMonth();\r\n      const minD = minDateObj.getDate();\r\n      if (cellDateY < minY) isBeforeMin = true;\r\n      else if (cellDateY === minY && cellDateM < minM) isBeforeMin = true;\r\n      else if (cellDateY === minY && cellDateM === minM && cellDateD < minD) isBeforeMin = true;\r\n    } else if (!allowPast) {\r\n      if (cellDateY < todayY) isPast = true;\r\n      else if (cellDateY === todayY && cellDateM < todayM) isPast = true;\r\n      else if (cellDateY === todayY && cellDateM === todayM && cellDateD < todayD) isPast = true;\r\n    }\r\n\r\n    if (maxDate) {\r\n      const maxDateObj = new Date(maxDate + \"T00:00:00\");\r\n      const maxY = maxDateObj.getFullYear();\r\n      const maxM = maxDateObj.getMonth();\r\n      const maxD = maxDateObj.getDate();\r\n      if (cellDateY > maxY) isAfterMax = true;\r\n      else if (cellDateY === maxY && cellDateM > maxM) isAfterMax = true;\r\n      else if (cellDateY === maxY && cellDateM === maxM && cellDateD > maxD) isAfterMax = true;\r\n    }\r\n\r\n    const isDisabled = isPast || isBeforeMin || isAfterMax;\r\n    const hasCount = perDayCounts[isoKey] && perDayCounts[isoKey].total > 0;\r\n    return (\r\n      <button\r\n        key={idx}\r\n        ref={(el) => { btnRefs.current[idx + refOffset] = el; }}\r\n        type=\"button\"\r\n        onClick={(e) => {\r\n          const iso = `${cell.y}-${pad(cell.m + 1)}-${pad(cell.d)}`;\r\n          // Shift+click: build full range and close\r\n          if (allowRange && e.shiftKey && lastClicked) {\r\n            const [a, b] = [lastClicked, iso].sort();\r\n            const selectedDays: string[] = [];\r\n            const sDate = new Date(a + \"T00:00:00\");\r\n            const eDate = new Date(b + \"T00:00:00\");\r\n            for (let dt = new Date(sDate); dt <= eDate; dt.setDate(dt.getDate() + 1)) {\r\n              selectedDays.push(`${dt.getFullYear()}-${pad(dt.getMonth() + 1)}-${pad(dt.getDate())}`);\r\n            }\r\n            setLastClicked(null);\r\n            onSelectAction(selectedDays);\r\n            onCloseAction?.();\r\n            return;\r\n          }\r\n          // Second click (no Shift): treat as end date, build [start, end] and close. Picker stays open after first click.\r\n          if (allowRange && lastClicked) {\r\n            const [a, b] = [lastClicked, iso].sort();\r\n            setLastClicked(null);\r\n            onSelectAction([a, b]);\r\n            onCloseAction?.();\r\n            return;\r\n          }\r\n          // First click: set start, do NOT close — picker stays open until end date is selected\r\n          if (!allowRange) {\r\n            setLastClicked(null);\r\n            onSelectAction(iso);\r\n            onCloseAction?.();\r\n            return;\r\n          }\r\n\r\n          setLastClicked(iso);\r\n          onSelectAction(iso);\r\n        }}\r\n        onFocus={() => setFocusedIdx(idx + refOffset)}\r\n        className={`\r\n          relative aspect-square flex items-center justify-center rounded-lg text-sm font-medium\r\n          transition-all duration-150 outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-1\r\n          ${!cell.currentMonth ? \"text-gray-300\" : \"\"}\r\n          ${sel ? \"bg-emerald-600 text-white shadow-md scale-105\" : isToday ? \"bg-emerald-50 text-emerald-700 border-2 border-emerald-500 font-semibold\" : isDisabled ? \"text-gray-400 cursor-not-allowed\" : \"text-gray-700 hover:bg-gray-100 active:scale-95\"}\r\n          ${hasCount && !sel ? \"font-semibold\" : \"\"}\r\n        `}\r\n        title={perDayCounts[isoKey] ? Object.entries(perDayCounts[isoKey].statuses).map(([k, v]) => `${k}: ${v}`).join(\", \") : undefined}\r\n        disabled={isDisabled && !sel}\r\n      >\r\n        <span className=\"relative z-10\">{cell.d}</span>\r\n        {hasCount && !sel && <span className=\"absolute bottom-1 left-1/2 -translate-x-1/2 w-1 h-1 rounded-full bg-emerald-500\" />}\r\n      </button>\r\n    );\r\n  };\r\n\r\n  return (\r\n    <div ref={rootRef} className={`bg-white border border-gray-200 rounded-xl shadow-2xl p-4 backdrop-blur-sm ${twoMonths ? \"w-max\" : \"w-72 sm:w-80\"}`}>\r\n      {/* Header with month/year navigation */}\r\n      <div className=\"flex items-center justify-between mb-4 pb-3 border-b border-gray-100\">\r\n        <button\r\n          type=\"button\"\r\n          onClick={() => setView((v) => ({ year: v.month === 0 ? v.year - 1 : v.year, month: (v.month + 11) % 12 }))}\r\n          className=\"p-1.5 rounded-lg hover:bg-gray-100 transition-colors text-gray-600 hover:text-gray-900\"\r\n          aria-label=\"Previous month\"\r\n        >\r\n          <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n            <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 19l-7-7 7-7\" />\r\n          </svg>\r\n        </button>\r\n        <div className=\"text-base font-semibold text-gray-900\">\r\n          {twoMonths && view2 ? `${MONTHS[view.month]} ${view.year} – ${MONTHS[view2.month]} ${view2.year}` : `${MONTHS[view.month]} ${view.year}`}\r\n        </div>\r\n        <button\r\n          type=\"button\"\r\n          onClick={() => setView((v) => ({ year: v.month === 11 ? v.year + 1 : v.year, month: (v.month + 1) % 12 }))}\r\n          className=\"p-1.5 rounded-lg hover:bg-gray-100 transition-colors text-gray-600 hover:text-gray-900\"\r\n          aria-label=\"Next month\"\r\n        >\r\n          <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n            <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 5l7 7-7 7\" />\r\n          </svg>\r\n        </button>\r\n      </div>\r\n\r\n      {twoMonths && view2 ? (\r\n        /* Two-column: current month and next month */\r\n        <div className=\"flex flex-row gap-6\">\r\n          <div className=\"w-72\">\r\n            <div className=\"text-sm font-semibold text-gray-700 mb-2\">{MONTHS[view.month]} {view.year}</div>\r\n            <div className=\"grid grid-cols-7 gap-1 mb-2\">\r\n              {WEEKDAYS.map((w) => (\r\n                <div key={w} className=\"text-center text-xs font-semibold text-gray-500 py-2\">{w}</div>\r\n              ))}\r\n            </div>\r\n            <div className=\"grid grid-cols-7 gap-1\">{days.map((cell, idx) => renderCell(cell, idx, 0))}</div>\r\n          </div>\r\n          <div className=\"w-72\">\r\n            <div className=\"text-sm font-semibold text-gray-700 mb-2\">{MONTHS[view2.month]} {view2.year}</div>\r\n            <div className=\"grid grid-cols-7 gap-1 mb-2\">\r\n              {WEEKDAYS.map((w) => (\r\n                <div key={w} className=\"text-center text-xs font-semibold text-gray-500 py-2\">{w}</div>\r\n              ))}\r\n            </div>\r\n            <div className=\"grid grid-cols-7 gap-1\">{days2.map((cell, idx) => renderCell(cell, idx, days.length))}</div>\r\n          </div>\r\n        </div>\r\n      ) : (\r\n        <>\r\n          {/* Weekday headers */}\r\n          <div className=\"grid grid-cols-7 gap-1 mb-2\">\r\n            {WEEKDAYS.map((w) => (\r\n              <div key={w} className=\"text-center text-xs font-semibold text-gray-500 py-2\">{w}</div>\r\n            ))}\r\n          </div>\r\n          {/* Calendar grid */}\r\n          <div className=\"grid grid-cols-7 gap-1\">\r\n            {days.map((cell, idx) => renderCell(cell, idx, 0))}\r\n          </div>\r\n        </>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\ui\\PageHeader.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\ui\\StatusBadge.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\components\\verificationContent.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Link' is defined but never used. Allowed unused vars must match /^_/u.","line":3,"column":8,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":12,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"Link"},"fix":{"range":[17,60],"text":""},"desc":"Remove unused import declaration."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport Link from \"@/components/PolicyLink\";\r\nimport { TermsSection } from \"./Terms\";\r\n\r\nexport const VERIFICATION_LAST_UPDATED = \"2025-01-15\";\r\n\r\nexport const VERIFICATION_SECTIONS: TermsSection[] = [\r\n  {\r\n    title: \"Overview\",\r\n    content: (\r\n      <div className=\"space-y-4\">\r\n        <div className=\"bg-blue-50 border-l-4 border-blue-500 p-4 mb-6 rounded\">\r\n          <h3 className=\"text-lg font-semibold text-gray-900 mb-2\">Summary</h3>\r\n          <p className=\"text-sm text-gray-700 leading-relaxed\">\r\n            The NoLSAF Verification Policy ensures that all properties listed on our platform are authentic, safe, and accurately represented. When you see a \"Verified\" badge on a property, it means that property has undergone a comprehensive review process including: (1) an in-person inspection by our team, (2) verification of ownership documents and legal permits, (3) confirmation that the property meets safety and quality standards, and (4) validation that the property description and photos match reality. This verification process protects both travelers and property owners by creating a trustworthy marketplace where you can book with confidence, knowing that verified properties have been thoroughly checked and meet our high standards for safety, legality, and accuracy.\r\n          </p>\r\n        </div>\r\n\r\n        <p>\r\n          <strong>1.0 Purpose of Verification</strong><br />\r\n          The Verification Policy delineates the comprehensive and methodical protocols that NoLSAF implements to authenticate and validate properties submitted for listing on its platform. This policy is established to achieve not limited to;\r\n        </p>\r\n\r\n        <p>\r\n          <strong>1.1 Ensuring authenticity</strong><br />\r\n          By rigorously evaluating each property, NoLSAF affirms that all listings accurately reflect the actual conditions, features, and amenities of the properties, thereby safeguarding the integrity of the platform.\r\n        </p>\r\n\r\n        <p>\r\n          <strong>1.2 Enhancing user trust</strong><br />\r\n          Through a systematic verification process, NoLSAF aims to bolster User confidence in the reliability and safety of the listed properties. Verified properties are emblematic of NoLSAF's commitment to maintaining a high standard of quality and transparency, fostering a sense of security for Users during their booking experience.<br />\r\n          <em>Example: When you see a \"Verified\" badge on a property listing, it means our team has personally visited the property, checked that all amenities work (like Wi-Fi, air conditioning, and kitchen appliances), and confirmed that the photos accurately show what you'll find when you arrive.</em>\r\n        </p>\r\n\r\n        <p>\r\n          <strong>1.3 Protecting against fraud</strong><br />\r\n          The Verification Policy is designed to mitigate risks associated with fraudulent activities and misrepresentations, thereby protecting Users from potential scams and misleading information. By necessitating the submission of credible documents and the undertaking of physical inspections, NoLSAF endeavors to uphold a trustworthy marketplace.\r\n        </p>\r\n\r\n        <p>\r\n          <strong>1.4 Fostering a safe and reliable booking environment</strong><br />\r\n          By ensuring that only verified properties are available for booking on the platform, NoLSAF contributes to the establishment of a secure environment conducive to positive transactions. This, in turn, cultivates good faith between Users, property Owners, and other stakeholders, thereby facilitating a satisfactory experience for all parties involved.\r\n        </p>\r\n\r\n        <p>\r\n          <strong>1.5 Compliance with regulatory standards</strong><br />\r\n          The verification process also aligns with applicable laws, regulations, and industry best practices, ensuring that NoLSAF operates within the legal framework governing short-term rentals and related accommodations.\r\n        </p>\r\n\r\n        <p>\r\n          <strong>2.0 Verification Process</strong><br />\r\n          NoLSAF implements a rigorous and comprehensive verification process for each property listed on its platform, designed to ensure the authenticity and reliability of each listing. This process encompasses and not limited to the following key steps;\r\n        </p>\r\n\r\n        <p>\r\n          <strong>2.1 Physical site visitation</strong><br />\r\n          A designated and qualified representative from NoLSAF shall conduct an in-person visit to the property to evaluate its physical condition and verify the claims made by the property Owner. During this site visitation, the following key aspects shall be meticulously assessed;<br />\r\n          <strong>2.1.1 Overall condition and cleanliness</strong><br />\r\n          A thorough inspection of the property's interior and exterior to ascertain its maintenance, hygiene standards, and readiness for occupancy.<br />\r\n          <em>Example: Our inspector checks that rooms are clean, beds are properly made, bathrooms are sanitized, and there are no visible safety hazards like loose wires or broken fixtures.</em><br />\r\n          <strong>2.1.2 Functionality of Amenities</strong><br />\r\n          An evaluation of essential facilities, including but not limited to;<br />\r\n          a. Heating and cooling systems<br />\r\n          b. Plumbing fixtures<br />\r\n          c. Electrical systems<br />\r\n          d. Internet and telecommunications infrastructure<br />\r\n          <em>Example: We test that the air conditioning actually works, the Wi-Fi connects and has reasonable speed, all lights function properly, and the hot water system operates as expected.</em><br />\r\n          <strong>2.1.3 Neighborhood characterization</strong><br />\r\n          An analysis of the surrounding area to ensure it corresponds with the Owner's description, including assessments of local amenities, safety, and community reputation.<br />\r\n          <em>Example: If an owner claims the property is \"walking distance to the beach,\" we verify this is accurate. If they describe it as \"quiet residential area,\" we confirm this matches the actual neighborhood environment.</em>\r\n        </p>\r\n\r\n        <p>\r\n          <strong>2.2 Location validation</strong><br />\r\n          To affirm the accuracy of the property's listed address, NoLSAF employs advanced geographic information systems (GIS) and mapping technologies. This validation process includes,<br />\r\n          <strong>2.2.1 Proximity review</strong><br />\r\n          Assessing the property's closeness to vital local attractions, public transportation options, healthcare facilities, and essential services pertinent to a favorable stay.<br />\r\n          <strong>2.2.2 Community insights</strong><br />\r\n          Gathering and evaluating feedback from local sources and community members to confirm the area's status and reputation, ensuring it aligns with the descriptions provided by the Owner.\r\n        </p>\r\n\r\n        <p>\r\n          <strong>2.3 Documentation review</strong><br />\r\n          Property Owners are mandated to submit a comprehensive suite of documentation for review. This documentation includes, but is not limited to,<br />\r\n          <strong>2.3.1 Ownership Verification</strong><br />\r\n          Proof of ownership, which may comprise title deeds, rental agreements, or valid business licenses that affirm the Owner's rights to rent the property.<br />\r\n          <em>Example: We verify that the person listing the property actually owns it or has legal authority to rent it. This prevents fraudulent listings where someone tries to rent a property they don't own or have permission to rent.</em><br />\r\n          <strong>2.3.2 Operating permits</strong><br />\r\n          All necessary local permits that authorize the property to serve as a booking accommodation, ensuring compliance with municipal and state regulations governing short-term rentals.<br />\r\n          <em>Example: In areas where short-term rentals require special permits, we confirm the owner has obtained these permits. This ensures your stay is legal and the property won't be shut down during your visit.</em><br />\r\n          <strong>2.3.4 Tax compliance evidence</strong><br />\r\n          Documentation demonstrating that the Owner fulfills local tax obligations associated with operating a short-term rental, which may include proof of registration for transient occupancy taxes or applicable business licenses.<br />\r\n          <em>Example: We verify that the property owner is registered for any required tourism or accommodation taxes, ensuring they operate as a legitimate business entity.</em>\r\n        </p>\r\n\r\n        <p>\r\n          <strong>3.0 Criteria for verification</strong><br />\r\n          To attain verified status on the NoLSAF platform, properties must satisfy a comprehensive set of rigorous criteria designed to uphold the integrity and trustworthiness of the listings. These criteria include the following,<br />\r\n          <em>Example: A property receives \"Verified\" status only after passing all checks: legal compliance (proper permits and licenses), safety standards (working smoke detectors, secure locks), quality standards (clean, well-maintained, functional amenities), and accuracy (photos and descriptions match reality). A property missing any of these cannot be verified.</em>\r\n        </p>\r\n\r\n        <p>\r\n          <strong>3.1 Compliance with laws</strong><br />\r\n          Properties must be in full compliance with all applicable local, state, and federal laws and regulations, including but not limited to;<br />\r\n          <strong>3.1.1 Zoning regulations</strong><br />\r\n          The property must adhere to local zoning laws that dictate the permissible uses of the property, including restrictions related to short-term rentals.<br />\r\n          <strong>3.1.2 Safety codes</strong><br />\r\n          Properties must conform to safety standards established by applicable building codes, health regulations, and fire safety ordinances. Properties found to be non-compliant will be subject to immediate removal from the platform, and Owners may be held liable for any resulting damages or legal issues.\r\n        </p>\r\n\r\n        <p>\r\n          <strong>3.2 Quality standards</strong><br />\r\n          To ensure a consistent level of comfort and service across the NoLSAF platform, each property is required to meet specific quality benchmarks, which include, but are not limited to;<br />\r\n          <strong>3.2.1 Cleanliness and maintenance</strong><br />\r\n          The property must be maintained in a clean, sanitary, and presentable condition at all times, with routine maintenance conducted to ensure all aspects of the property are in optimal working order.<br />\r\n          <strong>3.2.2 Functional and well-maintained facilities</strong><br />\r\n          All amenities and facilities provided by the property such as kitchen appliances, rooms, bathrooms, heating and cooling systems, and recreational facilities must be fully operational and maintained to meet Users' expectations.<br />\r\n          <strong>3.2.3 Adequate security measures</strong><br />\r\n          Properties must incorporate appropriate security measures to ensure the safety of Users, which shall include but are not limited to;<br />\r\n          a. Secure locks on doors and windows<br />\r\n          b. Adequate exterior and interior lighting<br />\r\n          c. Operational security systems, such as alarms or surveillance cameras where legally permissible\r\n        </p>\r\n\r\n        <p>\r\n          <strong>3.4 Transparency</strong><br />\r\n          Property Owners are obligated to furnish accurate and comprehensive information regarding their listings to facilitate a clear understanding of what Users can expect. This requirement includes;<br />\r\n          <strong>3.4.1 Accurate capacity limits</strong><br />\r\n          Property descriptions must clearly state the maximum number of guests permissible, ensuring alignment with local occupancy laws and safety considerations.<br />\r\n          <strong>3.4.2 Detailed lists of amenities and services available</strong><br />\r\n          Property Owners are required to provide a comprehensive and truthful account of all features, amenities, and services available at their properties. This includes, but is not limited to, the following categories;<br />\r\n          a. <strong>Parking facilities</strong>, clearly indicate the availability of parking options, specifying whether they are free or paid, including details on the capacity and any reservation requirements.<br />\r\n          b. <strong>Internet access</strong>, state the availability of internet access, distinguishing between free and paid options. Provide information on the type of connection (Wi-Fi, wired) and any usage limitations or restrictions.<br />\r\n          c. <strong>Room facilities</strong>, detail the amenities available within each room, including but not limited to;<br />\r\n          i. Bed sizes and types (queen, king, twin)<br />\r\n          ii. Furnishings (dressers, nightstands)<br />\r\n          iii. Additional comforts (air conditioning, heating, bedside lamps).<br />\r\n          d. <strong>Bathroom facilities</strong>, provide a thorough description of the bathroom amenities, including;<br />\r\n          i. Number of bathrooms<br />\r\n          ii. Features such as bathtubs, showers, and toiletries provided not limited to (soap, shampoo, towels)<br />\r\n          e. <strong>Kitchen appliances and utensils</strong>, enumerate the appliances and utensils available for guest use, including;<br />\r\n          i. Major appliances (refrigerator, stove, microwave, dishwasher)<br />\r\n          ii. Cookware and tableware (pots, pans, dishes, cutlery)<br />\r\n          iii. Special features (coffee maker, toaster, blender)<br />\r\n          f. <strong>Recreational facilities</strong>, clearly outline any on-site recreational amenities provided, such as;<br />\r\n          i. Swimming pools, hot tubs, or saunas<br />\r\n          ii. Fitness centers or gyms<br />\r\n          iii. Game rooms, outdoor recreational areas, or other leisure facilities.<br />\r\n          <strong>3.4.3 Photographs that accurately represent the property</strong><br />\r\n          All photographs submitted by Owners must accurately depict the property as it exists, avoiding any misleading representations or alterations that may create a false impression of the property's conditions or features.<br />\r\n          <em>Example: If photos show a property with ocean views, we verify those views actually exist. If photos show modern furniture, we confirm the property has that furniture. We don't allow heavily edited photos that make rooms look larger or amenities appear better than they actually are.</em>\r\n        </p>\r\n\r\n        <p>\r\n          <strong>4.0 Benefits of verification</strong><br />\r\n          The verification of properties on the NoLSAF platform provides significant benefits not only to Users but also to property Owners. These benefits are outlined as follows;\r\n        </p>\r\n\r\n        <p>\r\n          <strong>4.1 Increased trust</strong><br />\r\n          The presence of verified listings instils a sense of confidence among Users, enabling them to make informed decisions when selecting accommodations. The verification process serves to;<br />\r\n          <strong>4.1.1 Reduce risk of fraud</strong><br />\r\n          By ensuring that all properties meet stringent quality and safety standards, Users can be assured that they are engaging with credible listings, significantly mitigating the risk of encountering fraudulent or misleading representations.<br />\r\n          <em>Example: Without verification, you might book a property that doesn't exist, is misrepresented, or is being rented illegally. With verification, you know the property is real, the owner has legal rights to rent it, and what you see in photos is what you'll get.</em><br />\r\n          <strong>4.1.2 Enhance overall User experience</strong><br />\r\n          Users are more likely to feel secure and satisfied with their booking choices, fostering a positive perception of the NoLSAF platform and encouraging repeat usage.<br />\r\n          <em>Example: When you book a verified property, you can arrive confident that the Wi-Fi will work (we tested it), the location is accurate (we verified it), and the amenities match the description (we inspected them). This reduces surprises and ensures a smoother travel experience.</em>\r\n        </p>\r\n\r\n        <p>\r\n          <strong>4.2 Enhanced security</strong><br />\r\n          Through rigorous validation of property listings, NoLSAF actively protects Users from potential scams and misleading information by;<br />\r\n          <strong>4.2.1 Implementing stringent verification measures</strong><br />\r\n          The meticulous assessment of properties including physical inspections, documentation reviews, and compliance checks ensures that Users are presented with reliable information, promoting a safer booking environment as explained in section 2.0, 2.1 & 2.2.<br />\r\n          <strong>4.2.2 Fostering transparency</strong><br />\r\n          Increased transparency about property features and conditions reduces the likelihood of disputes between Users and Owners, as accurate information is provided upfront, thus enhancing peace of mind for all parties involved.\r\n        </p>\r\n\r\n        <p>\r\n          <strong>5.0 Continuous monitoring</strong><br />\r\n          NoLSAF is steadfast in its commitment to ongoing verification and quality assurance of all properties listed on its platform. This commitment is realized through a multifaceted approach to continuous monitoring, which includes the following key components;\r\n        </p>\r\n\r\n        <p>\r\n          <strong>5.1 Periodic Re-evaluations</strong><br />\r\n          To uphold the integrity of verified properties, NoLSAF conducts regular re-evaluations, ensuring that properties consistently meet the established verification criteria. This process may involve;<br />\r\n          <strong>5.1.1 Randomized site visits</strong><br />\r\n          A selection of verified properties will be subjected to unannounced site visits to ensure that the conditions observed during the initial verification process remain consistent. These visits focus on assessing;<br />\r\n          a. The general condition and maintenance of the property<br />\r\n          b. The functionality of advertised amenities<br />\r\n          c. Compliance with safety and health standards<br />\r\n          <strong>5.1.2 Scheduled Reviews based on User feedback</strong><br />\r\n          Properties exhibiting significant fluctuations in User reviews or ratings will trigger a scheduled review. NoLSAF assesses the concerns raised in User feedback to determine if further investigation or re-evaluation is warranted.<br />\r\n          <em>Example: If a verified property that previously had 5-star reviews suddenly receives multiple complaints about cleanliness or broken amenities, we'll conduct a surprise inspection to verify if the property still meets our standards. If it doesn't, we may temporarily remove the verification badge until issues are resolved.</em>\r\n        </p>\r\n\r\n        <p>\r\n          <strong>5.2 User Feedback</strong><br />\r\n          User-generated content, including reviews and comments, is crucial for maintaining the efficacy of the verification process. Regular analysis of this feedback enables NoLSAF to;<br />\r\n          <strong>5.2.1 Identify discrepancies</strong><br />\r\n          Anomalies or inconsistencies between user experiences and property descriptions can be quickly flagged for further investigation. This vigilance helps ensure that Users are consistently receiving accurate and truthful representations.<br />\r\n          <strong>5.2.2 Address issues promptly</strong><br />\r\n          Should User feedback indicate any issues pertaining to property conditions or safety standards, NoLSAF will initiate immediate action to re-assess the property, potentially resulting in a temporary suspension of its listing until the issue is resolved.\r\n        </p>\r\n\r\n        <p>\r\n          <strong>5.3 Continuous improvement</strong><br />\r\n          NoLSAF strives for a dynamic verification process that evolves with industry standards and practices. This includes;<br />\r\n          <strong>5.3.1 Incorporating best practices</strong><br />\r\n          Regular updates to verification criteria and monitoring methods based on industry developments, regulatory changes, and advancements in technology ensure the highest standards are maintained.<br />\r\n          <strong>5.3.2 Engaging with stakeholders</strong><br />\r\n          NoLSAF invites constructive feedback from both Users and property Owners to refine and enhance the verification and monitoring processes, fostering a collaborative environment aimed at continual improvement.\r\n        </p>\r\n\r\n        <p>\r\n          <strong>6.0 Reporting Concerns</strong><br />\r\n          NoLSAF recognizes the importance of maintaining the integrity of its platform and encourages Users to proactively report any discrepancies or suspicious activities related to verified properties. The following channels are available for Users to report concerns:\r\n        </p>\r\n\r\n        <p>\r\n          <strong>6.1 NoLSAF Dedicated Reporting System</strong><br />\r\n          NoLSAF provides a user-friendly reporting tool integrated within the platform. This tool allows Users to flag potential issues directly by following these steps;<br />\r\n          <strong>6.1.1 Accessing the reporting tool</strong><br />\r\n          Users can easily navigate to the reporting feature through their account dashboard or property listing page.<br />\r\n          <strong>6.1.2 Submitting reports</strong><br />\r\n          Once within the reporting tool, Users can provide detailed descriptions of the discrepancies or issues observed, attaching any relevant documentation or evidence to support their claims.<br />\r\n          <strong>6.1.3 Anonymity option</strong><br />\r\n          Users may opt to submit reports anonymously to protect their privacy while still enabling NoLSAF to conduct a thorough investigation.\r\n        </p>\r\n\r\n        <p>\r\n          <strong>6.2 Customer Support</strong><br />\r\n          For additional assistance in reporting concerns or complaints, Users may also contact the NoLSAF customer support team via the following methods;<br />\r\n          <strong>6.2.1 Email support</strong><br />\r\n          Users can reach out to customer support through the designated email address (<a href=\"mailto:report@nolsaf.com\" className=\"text-blue-600 hover:text-blue-800 underline\">report@nolsaf.com</a>), providing a detailed account of their concerns.<br />\r\n          <strong>6.2.2 Live Chat Support</strong><br />\r\n          For immediate assistance, Users can utilize the live chat feature on the NoLSAF platform, enabling them to communicate directly with a customer support representative.\r\n        </p>\r\n\r\n        <p>\r\n          <strong>6.3 Investigation process</strong><br />\r\n          Upon receipt of any reports, NoLSAF commits to initiating a thorough investigation to uphold the integrity of its platform. The investigation process includes;<br />\r\n          <strong>6.3.1 Assessment of the report</strong><br />\r\n          A dedicated team will review the submitted report, gathering all necessary information to assess the validity of the claims made.<br />\r\n          <strong>6.3.2 Evaluation of evidence</strong><br />\r\n          Any supporting documentation provided by Users will be examined alongside existing property records and User reviews to cross-verify the information.<br />\r\n          <strong>6.3.3 Communication of findings</strong><br />\r\n          Where necessary, NoLSAF will communicate the findings of the investigation to both the reporting User and the property Owner. This communication will include;<br />\r\n          a. A summary of the investigation results<br />\r\n          b. Actions taken, if applicable<br />\r\n          c. Recommendations for any further steps that may be warranted\r\n        </p>\r\n\r\n        <p>\r\n          <strong>7.0 Amendments to Verification Policy</strong><br />\r\n          NoLSAF reserves the right to amend this Verification Policy at any time to adapt to changing industry standards or regulations. Significant changes will be communicated via email or through notifications on the platform at least 21 days prior to the changes taking effect, allowing Users to stay informed.\r\n        </p>\r\n\r\n        <p>\r\n          <strong>8.0 User Acceptance</strong><br />\r\n          By utilizing the NoLSAF platform and booking verified properties, Users consent to this Verification Policy. Users acknowledge the importance of the verification process in ensuring their safety and security while engaging with our services.\r\n        </p>\r\n      </div>\r\n    ),\r\n  },\r\n];\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\eslint.config.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\hooks\\useConnectionStatus.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\hooks\\useSocket.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\hooks\\useToast.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\lib\\amenityIcons.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\lib\\automatedResponses.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\lib\\driverMatching.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\lib\\driverNotifications.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\lib\\navigation.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'encodedOrigin' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":64,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":64,"endColumn":22},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'encodedDestination' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":65,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":65,"endColumn":27}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Navigation utilities for opening routes in external map applications\r\n */\r\n\r\nexport function openInMaps(\r\n  destinationLat: number,\r\n  destinationLng: number,\r\n  destinationName?: string\r\n) {\r\n  // Detect if iOS or Android\r\n  const userAgent = navigator.userAgent || navigator.vendor || (window as any).opera;\r\n  const isIOS = /iPad|iPhone|iPod/.test(userAgent) && !(window as any).MSStream;\r\n  const isAndroid = /android/i.test(userAgent);\r\n\r\n  const encodedName = destinationName ? encodeURIComponent(destinationName) : \"\";\r\n\r\n  if (isIOS) {\r\n    // iOS - try Apple Maps first, fallback to Google Maps\r\n    const appleMapsUrl = `maps://maps.apple.com/?daddr=${destinationLat},${destinationLng}${encodedName ? `&q=${encodedName}` : \"\"}`;\r\n    const googleMapsUrl = `comgooglemaps://?daddr=${destinationLat},${destinationLng}${encodedName ? `&q=${encodedName}` : \"\"}`;\r\n    const webGoogleMapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${destinationLat},${destinationLng}${encodedName ? `&destination_place_id=${encodedName}` : \"\"}`;\r\n\r\n    // Try Apple Maps first\r\n    window.location.href = appleMapsUrl;\r\n    \r\n    // Fallback to Google Maps if Apple Maps fails\r\n    setTimeout(() => {\r\n      window.location.href = googleMapsUrl;\r\n      // Final fallback to web Google Maps\r\n      setTimeout(() => {\r\n        window.open(webGoogleMapsUrl, \"_blank\");\r\n      }, 500);\r\n    }, 500);\r\n  } else if (isAndroid) {\r\n    // Android - try Google Maps app first\r\n    const googleMapsUrl = `google.navigation:q=${destinationLat},${destinationLng}`;\r\n    const webGoogleMapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${destinationLat},${destinationLng}${encodedName ? `&destination_place_id=${encodedName}` : \"\"}`;\r\n\r\n    window.location.href = googleMapsUrl;\r\n    \r\n    // Fallback to web Google Maps\r\n    setTimeout(() => {\r\n      window.open(webGoogleMapsUrl, \"_blank\");\r\n    }, 500);\r\n  } else {\r\n    // Desktop - open in web Google Maps\r\n    const webGoogleMapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${destinationLat},${destinationLng}${encodedName ? `&destination_place_id=${encodedName}` : \"\"}`;\r\n    window.open(webGoogleMapsUrl, \"_blank\");\r\n  }\r\n}\r\n\r\nexport function openRouteInMaps(\r\n  originLat: number,\r\n  originLng: number,\r\n  destinationLat: number,\r\n  destinationLng: number,\r\n  originName?: string,\r\n  destinationName?: string\r\n) {\r\n  const userAgent = navigator.userAgent || navigator.vendor || (window as any).opera;\r\n  const isIOS = /iPad|iPhone|iPod/.test(userAgent) && !(window as any).MSStream;\r\n  const isAndroid = /android/i.test(userAgent);\r\n\r\n  const encodedOrigin = originName ? encodeURIComponent(originName) : \"\";\r\n  const encodedDestination = destinationName ? encodeURIComponent(destinationName) : \"\";\r\n\r\n  if (isIOS) {\r\n    const appleMapsUrl = `maps://maps.apple.com/?saddr=${originLat},${originLng}&daddr=${destinationLat},${destinationLng}`;\r\n    const webGoogleMapsUrl = `https://www.google.com/maps/dir/${originLat},${originLng}/${destinationLat},${destinationLng}`;\r\n    \r\n    window.location.href = appleMapsUrl;\r\n    setTimeout(() => {\r\n      window.open(webGoogleMapsUrl, \"_blank\");\r\n    }, 500);\r\n  } else if (isAndroid) {\r\n    const googleMapsUrl = `google.navigation:q=${destinationLat},${destinationLng}`;\r\n    const webGoogleMapsUrl = `https://www.google.com/maps/dir/${originLat},${originLng}/${destinationLat},${destinationLng}`;\r\n    \r\n    window.location.href = googleMapsUrl;\r\n    setTimeout(() => {\r\n      window.open(webGoogleMapsUrl, \"_blank\");\r\n    }, 500);\r\n  } else {\r\n    const webGoogleMapsUrl = `https://www.google.com/maps/dir/${originLat},${originLng}/${destinationLat},${destinationLng}`;\r\n    window.open(webGoogleMapsUrl, \"_blank\");\r\n  }\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\lib\\priceUtils.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\lib\\propertyUtils.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\lib\\transportFareCalculator.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\lib\\types\\property.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\lib\\tzRegions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\lib\\tzRegionsFull.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\next.config.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\next.config.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\postcss.config.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\proxy.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\src\\utils\\historyParsers.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\tailwind.config.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\tailwind.config.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\types\\global.d.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\types\\page-flip.d.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\types\\papaparse.d.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\types\\qrcode.d.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\utils\\historyParsers.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\nolsapp2.1\\nolsaf\\apps\\web\\utils\\html.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]}]